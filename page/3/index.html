
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/3/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/275ba15/" title="Linux c 开发 - Memcached源码分析之基于Libevent的网络模型（1） -" itemprop="url">Linux c 开发 - Memcached源码分析之基于Libevent的网络模型（1） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5173;&#x4E8E;Memcached&#xFF1A;</p>
<p>memcached&#x662F;&#x4E00;&#x6B3E;&#x975E;&#x5E38;&#x666E;&#x53CA;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7F13;&#x5B58;&#x8F6F;&#x4EF6;&#xFF0C;memcached&#x4E3B;&#x8981;&#x662F;&#x57FA;&#x4E8E;Libevent&#x5E93;&#x8FDB;&#x884C;&#x5F00;&#x53D1;&#x7684;&#x3002;Memcached&#x5206;&#x6790;</p>
<p>1.&#xA0; &#x7F51;&#x7EDC;&#x6A21;&#x578B;&#x6D41;&#x7A0B;&#x5206;&#x6790;</p>
<p>Memcached&#x4E3B;&#x8981;&#x662F;&#x57FA;&#x4E8E;Libevent&#x7684;&#x4E8B;&#x4EF6;&#x5E93;&#x6765;&#x5B9E;&#x73B0;&#x7F51;&#x7EDC;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x5148;&#x9700;&#x8981;&#x4E0B;&#x8F7D;memcached&#x7684;&#x6E90;&#x7801;&#x5305;&#xFF0C;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x7ED9;&#x51FA;&#x4E86;&#x6E90;&#x7801;&#x5305;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#x3002;</p>
<p>Memcached&#x7684;&#x7F51;&#x7EDC;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x4E3B;&#x8981;&#x6D89;&#x53CA;&#x4E24;&#x4E2A;&#x4E3B;&#x8981;&#x6587;&#x4EF6;&#xFF1A;memcached.c &#x548C;thread.c&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x8FD9;&#x8FB9;&#x4E3B;&#x8981;&#x5206;&#x6790;tcp&#x7684;&#x6A21;&#x578B;&#x3002;memcached&#x4E5F;&#x652F;&#x6301;udp&#x3002;</p>
<p>&#x6D41;&#x7A0B; </p>
<ol>
<li><p>memcached&#x9996;&#x5148;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#x4F1A;&#x521B;&#x5EFA;main_base&#xFF0C;memcached&#x7684;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x76D1;&#x542C;&#x548C;&#x63A5;&#x6536;listen&#x548C;accpet&#x65B0;&#x8FDB;&#x5165;&#x7684;&#x8FDE;&#x63A5;&#x3002;</p>
</li>
<li><p>&#x5F53;memcached&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x521D;&#x59CB;&#x5316;N&#x4E2A;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;LIBEVENT_THREAD&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6765;&#x5B58;&#x50A8;&#x7EBF;&#x7A0B;&#x7684;&#x4FE1;&#x606F;&#xFF08;&#x7EBF;&#x7A0B;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3001;&#x7EBF;&#x7A0B;&#x961F;&#x5217;&#x3001;pipe&#x4FE1;&#x606F;&#xFF09;&#x3002;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x548C;main thread&#x4E3B;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x4E3B;&#x8981;&#x901A;&#x8FC7;pipe&#x6765;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x3002;</p>
</li>
<li><p>&#x5F53;&#x7528;&#x6237;&#x6709;&#x8FDE;&#x63A5;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;main thread&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x901A;&#x8FC7;&#x6C42;&#x4F59;&#x7684;&#x65B9;&#x5F0F;&#x9009;&#x62E9;&#x4E00;&#x4E2A;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;</p>
</li>
<li><p>main thread&#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x7528;&#x6237;&#x7684;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x653E;&#x5165;&#x4E00;&#x4E2A;CQ_ITEM&#xFF0C;&#x5E76;&#x4E14;&#x5C06;CQ_ITEM&#x653E;&#x5165;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;conn_queue&#x5904;&#x7406;&#x961F;&#x5217;&#xFF0C;&#x7136;&#x540E;&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x901A;&#x8FC7;&#x5199;&#x5165;pipe&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x901A;&#x77E5;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;</p>
</li>
<li><p>&#x5F53;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5F97;&#x5230;&#x4E3B;&#x7EBF;&#x7A0B;main thread&#x7684;&#x901A;&#x77E5;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x53BB;&#x81EA;&#x5DF1;&#x7684;conn_queue&#x961F;&#x5217;&#x4E2D;&#x53D6;&#x5F97;&#x4E00;&#x6761;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x521B;&#x5EFA;libevent&#x7684;socket&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#x3002;</p>
</li>
<li><p>&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4F1A;&#x76D1;&#x542C;&#x7528;&#x6237;&#x7684;socket&#xFF0C;&#x5982;&#x679C;&#x7528;&#x6237;&#x6709;&#x6D88;&#x606F;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#xFF0C;&#x5219;&#x4F1A;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x89E3;&#x6790;&#x548C;&#x5904;&#x7406;&#xFF0C;&#x8FD4;&#x56DE;&#x76F8;&#x5E94;&#x7684;&#x7ED3;&#x679C;&#x3002;</p>
</li>
</ol>
<p>&#x6D41;&#x7A0B;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/275a1ab.jpg" alt=""></p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;</p>
<ol>
<li>CQ_ITEM&#xFF1A;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x7528;&#x6237;socket&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</li>
</ol>
<p>&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x5C06;&#x7528;&#x6237;&#x7684;socket&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x5C01;&#x88C5;&#x6210;CQ_ITEM&#xFF0C;&#x5E76;&#x653E;&#x5165;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x5904;&#x7406;&#x961F;&#x5217;&#x4E2D;&#x3002;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5F97;&#x5230;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;pipe&#x901A;&#x77E5;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06;&#x961F;&#x5217;&#x4E2D;&#x7684;ITEM&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x521B;&#x5EFA;libevent&#x7684;socket&#x8BFB;&#x4E8B;&#x4EF6;&#x3002;</p>
<pre><code><span class="xml">/* An item in the connection queue. */  
typedef struct conn_queue_item CQ_ITEM;  
struct conn_queue_item </span><span class="expression">{  
    <span class="variable">int</span>               <span class="variable">sfd</span>;   /<span class="end-block">/socket</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">fd</span>  
    <span class="variable">enum</span> <span class="variable">conn</span>_<span class="variable">states</span>  <span class="variable">init</span>_<span class="variable">state</span>; //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;  
    <span class="variable">int</span>               <span class="variable">event</span>_<span class="variable">flags</span>; /<span class="end-block">/libevent</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">flags</span>  
    <span class="variable">int</span>               <span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>; //&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>7684;<span class="variable">buffer</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">size</span>  
    <span class="variable">enum</span> <span class="variable">network</span>_<span class="variable">transport</span>     <span class="variable">transport</span>;   
    <span class="variable">CQ</span>_<span class="variable">ITEM</span>          *<span class="variable">next</span>; //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;  
}</span><span class="xml">;</span>
</code></pre><ol>
<li><p>CQ&#xFF1A;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x5904;&#x7406;&#x961F;&#x5217;&#x7ED3;&#x6784;&#x3002;</p>
<p> /<em> A connection queue. </em>/<br> typedef struct conn_queue CQ;<br> struct conn_queue {  </p>
<pre><code>CQ_ITEM *head<span class="comment">;  </span>
CQ_ITEM *tail<span class="comment">;  </span>
pthread_mutex_t lock<span class="comment">;  </span>
</code></pre><p> };</p>
</li>
<li><p>LIBEVENT_THREAD&#xFF1A;&#x6BCF;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
</li>
</ol>
<p>&#x6BCF;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x90FD;&#x6709;&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x81EA;&#x5DF1;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x7EBF;&#x7A0B;&#x4FE1;&#x606F;&#x3001;&#x5904;&#x7406;&#x961F;&#x5217;&#x3001;pipe&#x4FE1;&#x606F;&#x7B49;&#x3002;</p>
<pre><code><span class="keyword">typedef</span> <span class="keyword">struct</span> {  
    <span class="keyword">pthread_t</span> thread_id;        <span class="comment">/* unique ID of this thread */</span>  
    <span class="keyword">struct</span> event_base *base;    <span class="comment">/* libevent handle this thread uses */</span>  
    <span class="keyword">struct</span> event notify_event;  <span class="comment">/* listen event for notify pipe */</span>  
    <span class="keyword">int</span> notify_receive_fd;      <span class="comment">/* receiving end of notify pipe */</span>  
    <span class="keyword">int</span> notify_send_fd;         <span class="comment">/* sending end of notify pipe */</span>  
    <span class="keyword">struct</span> thread_stats stats;  <span class="comment">/* Stats generated by this thread */</span>  
    <span class="keyword">struct</span> conn_queue *new_conn_queue; <span class="comment">/* queue of new connections to handle */</span>  
    <span class="keyword">cache_t</span> *suffix_cache;      <span class="comment">/* suffix cache */</span>  
    <span class="keyword">uint8_t</span> <span class="keyword">item_lock_t</span>ype;     <span class="comment">/* use fine-grained or global item lock */</span>  
} LIBEVENT_THREAD;
</code></pre><ol>
<li>main&#x542F;&#x52A8;&#x5165;&#x53E3;</li>
</ol>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x627E;&#x5230;memcached.c&#x4E2D;&#x7684;main()&#x65B9;&#x6CD5;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x53EA;&#x5217;&#x51FA;&#x4E86;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x91CD;&#x8981;&#x90E8;&#x5206;&#x3002;</p>
<pre><code>int main (int argc, char **argv) {  
    //...&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
    /* initialize main thread libevent instance */  
    //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;event_base  
    main_base = event_init();  
    /* initialize other stuff */  
    stats_init();  
    assoc_init(settings.hashpower_init);  
    conn_init();  
    slabs_init(settings.maxbytes, settings.factor, preallocate);  
    /* 
     * ignore <span class="class">SIGPIPE</span> signals; we can use errno == <span class="class">EPIPE</span> if we 
     * need that information 
     */  
    if (sigignore(<span class="class">SIGPIPE</span>) == -<span class="number">1</span>) {  
        perror(&amp;quot;failed to ignore <span class="class">SIGPIPE</span>; sigaction&amp;quot;);  
        exit(<span class="class">EX_OSERR</span>);  
    }  
    /* start up worker threads if <span class="class">MT</span> mode */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    thread_init(settings.num_threads, main_base);  
    if (start_assoc_maintenance_thread() == -<span class="number">1</span>) {  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    if (settings.slab_reassign &amp;amp;&amp;amp;  
        start_slab_maintenance_thread() == -<span class="number">1</span>) {  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    /* <span class="class">Run</span> regardless of initializing it later */  
    init_lru_crawler();  
    /* initialise clock event */  
    clock_handler(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);  
    /* create unix mode sockets after dropping privileges */  
    if (settings.socketpath != <span class="class">NULL</span>) {  
        errno = <span class="number">0</span>;  
        if (server_socket_unix(settings.socketpath,settings.access)) {  
            vperror(&amp;quot;failed to listen on <span class="class">UNIX</span> <span class="method">socket:</span> %s&amp;quot;, settings.socketpath);  
            exit(<span class="class">EX_OSERR</span>);  
        }  
    }  
    /* create the listening socket, bind it, and init */  
    if (settings.socketpath == <span class="class">NULL</span>) {  
        const char *portnumber_filename = getenv(&amp;quot;<span class="class">MEMCACHED_PORT_FILENAME</span>&amp;quot;);  
        char temp_portnumber_filename[<span class="class">PATH_MAX</span>];  
        <span class="class">FILE</span> *portnumber_file = <span class="class">NULL</span>;  
        if (portnumber_filename != <span class="class">NULL</span>) {  
            snprintf(temp_portnumber_filename,  
                     sizeof(temp_portnumber_filename),  
                     &amp;quot;%s.lck&amp;quot;, portnumber_filename);  
            portnumber_file = fopen(temp_portnumber_filename, &amp;quot;a&amp;quot;);  
            if (portnumber_file == <span class="class">NULL</span>) {  
                fprintf(stderr, &amp;quot;<span class="class">Failed</span> to open \&amp;quot;%s\&amp;quot;: %s\n&amp;quot;,  
                        temp_portnumber_filename, strerror(errno));  
            }  
        }  
        errno = <span class="number">0</span>;  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;server_sockets&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;socket&amp;<span class="symbol">#x7684</span>;bind&amp;<span class="symbol">#x3001</span>;listen&amp;<span class="symbol">#x3001</span>;accept&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
        //&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4EA4</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x3002</span>;  
        if (settings.port &amp;amp;&amp;amp; server_sockets(settings.port, tcp_transport,  
                                           portnumber_file)) {  
            vperror(&amp;quot;failed to listen on <span class="class">TCP</span> port %d&amp;quot;, settings.port);  
            exit(<span class="class">EX_OSERR</span>);  
        }  
    }  
    /* enter the event loop */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;  
    if (event_base_loop(main_base, <span class="number">0</span>) != <span class="number">0</span>) {  
        retval = <span class="class">EXIT_FAILURE</span>;  
    }  
 //...&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
}
</code></pre><p>&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;thread_init&#x65B9;&#x6CD5;&#x53BB;&#x521B;&#x5EFA;N&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF1A;</p>
<pre><code>thread_init<span class="list">(<span class="keyword">settings</span>.num_threads, main_base)</span><span class="comment">;</span>
</code></pre><p>&#x901A;&#x8FC7;server_sockets&#x65B9;&#x6CD5;&#x53BB;&#x521B;&#x5EFA;socket server&#xFF1A;</p>
<pre><code>errno = <span class="number">0</span>;  
if (settings.<span class="keyword">port</span> &amp;amp;&amp;amp; server_sockets(settings.<span class="keyword">port</span>, tcp_transport,  
                                   portnumber_file)) {  
    vperror(&amp;quot;failed <span class="keyword">to</span> listen <span class="keyword">on</span> TCP <span class="keyword">port</span> %d&amp;quot;, settings.<span class="keyword">port</span>);  
    exit(EX_OSERR);  
}
</code></pre><ol>
<li>worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x6E90;&#x7801;&#x5206;&#x6790;</li>
</ol>
<p>&#x6211;&#x4EEC;&#x5728;thread.c&#x6587;&#x4EF6;&#x4E2D;&#x627E;&#x5230;thread_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>void thread_init(int nthreads, struct event_base *main_base) {  
    //...&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;nthreads&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    //nthreads&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;  
    for (i = <span class="number">0</span>; i &amp;lt; nthreads; i++) {  
        int fds[<span class="number">2</span>];  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;pipe&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x4FE1</span>;  
        if (pipe(fds)) {  
            perror(&amp;quot;<span class="class">Can</span>&amp;apos;t create notify pipe&amp;quot;);  
            exit(<span class="number">1</span>);  
        }  
        //threads&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="class">LIBEVENT_THREAD</span>  
        //&amp;<span class="symbol">#x5C06</span>;pipe&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x4E2D</span>;  
        threads[i].notify_receive_fd = fds[<span class="number">0</span>]; //&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x7AEF</span>;  
        threads[i].notify_send_fd = fds[<span class="number">1</span>]; //&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7AEF</span>;  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;&amp;<span class="symbol">#x7684</span>;libevent&amp;<span class="symbol">#x7684</span>;event_base  
        setup_thread(&amp;amp;threads[i]);  
        /* <span class="class">Reserve</span> three fds for the libevent base, and two for the pipe */  
        stats.reserved_fds += <span class="number">5</span>;  
    }  
    /* <span class="class">Create</span> threads after we&amp;apos;ve done all the libevent setup. */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    //&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x662F</span>;worker_libevent  
    for (i = <span class="number">0</span>; i &amp;lt; nthreads; i++) {  
        create_worker(worker_libevent, &amp;amp;threads[i]);  
    }  
    /* <span class="class">Wait</span> for all the threads to set themselves up before returning. */  
    pthread_mutex_lock(&amp;amp;init_lock);  
    wait_for_thread_registration(nthreads);  
    pthread_mutex_unlock(&amp;amp;init_lock);  
}
</code></pre><p>setup_thread&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>/* 
 * <span class="class">Set</span> up a thread&amp;apos;s information. 
 */  
static void setup_thread(<span class="class">LIBEVENT_THREAD</span> *me) {  
    //&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;event_base  
    //&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;libevent&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x6863</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x7684</span>;event_base  
    me-&amp;gt;base = event_init();  
    if (! me-&amp;gt;base) {  
        fprintf(stderr, &amp;quot;<span class="class">Can</span>&amp;apos;t allocate event base\n&amp;quot;);  
        exit(<span class="number">1</span>);  
    }  
    /* <span class="class">Listen</span> for notifications from other threads */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;pipe&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;<span class="class">EV_READ</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;  
    //&amp;<span class="symbol">#x5F53</span>;pipe&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;libevent&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;thread_libevent_process&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    event_set(&amp;amp;me-&amp;gt;notify_event, me-&amp;gt;notify_receive_fd,  
              <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>, thread_libevent_process, me);  
    event_base_set(me-&amp;gt;base, &amp;amp;me-&amp;gt;notify_event);  
    //&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (event_add(&amp;amp;me-&amp;gt;notify_event, <span class="number">0</span>) == -<span class="number">1</span>) {  
        fprintf(stderr, &amp;quot;<span class="class">Can</span>&amp;apos;t monitor libevent notify pipe\n&amp;quot;);  
        exit(<span class="number">1</span>);  
    }  
    //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x961F</span>;&amp;<span class="symbol">#x5217</span>;  
    me-&amp;gt;new_conn_queue = malloc(sizeof(struct conn_queue));  
    if (me-&amp;gt;new_conn_queue == <span class="class">NULL</span>) {  
        perror(&amp;quot;<span class="class">Failed</span> to allocate memory for connection queue&amp;quot;);  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    cq_init(me-&amp;gt;new_conn_queue);  
    //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;  
    if (pthread_mutex_init(&amp;amp;me-&amp;gt;stats.mutex, <span class="class">NULL</span>) != <span class="number">0</span>) {  
        perror(&amp;quot;<span class="class">Failed</span> to initialize mutex&amp;quot;);  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    me-&amp;gt;suffix_cache = cache_create(&amp;quot;suffix&amp;quot;, <span class="class">SUFFIX_SIZE</span>, sizeof(char*),  
                                    <span class="class">NULL</span>, <span class="class">NULL</span>);  
    if (me-&amp;gt;suffix_cache == <span class="class">NULL</span>) {  
        fprintf(stderr, &amp;quot;<span class="class">Failed</span> to create suffix cache\n&amp;quot;);  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
}
</code></pre><p>create_worker&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>/* 
 * <span class="class">Creates</span> a worker thread. 
 */  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
static void create_worker(void *(*func)(void *), void *arg) {  
    pthread_t       thread;  
    pthread_attr_t  attr;  
    int             ret;  
    pthread_attr_init(&amp;amp;attr);  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    if ((ret = pthread_create(&amp;amp;thread, &amp;amp;attr, func, arg)) != <span class="number">0</span>) {  
        fprintf(stderr, &amp;quot;<span class="class">Can</span>&amp;apos;t create <span class="method">thread:</span> %s\n&amp;quot;,  
                strerror(ret));  
        exit(<span class="number">1</span>);  
    }  
}
</code></pre><p>worker_libevent&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code><span class="xml">/* 
 * Worker thread: main event loop 
 */  
static void *worker_libevent(void *arg) </span><span class="expression">{  
    <span class="variable">LIBEVENT</span>_<span class="variable">THREAD</span> *<span class="variable">me</span> = <span class="variable">arg</span>;  

    /* <span class="variable">Any</span> <span class="variable">per-thread</span> <span class="variable">setup</span> <span class="variable">can</span> <span class="variable">happen</span> <span class="variable">here</span>; <span class="variable">thread</span>_<span class="variable">init</span>() <span class="variable">will</span> <span class="variable">block</span> <span class="variable">until</span> 
     * <span class="variable">all</span> <span class="variable">threads</span> <span class="variable">have</span> <span class="variable">finished</span> <span class="variable">initializing.</span> 
     *<span class="end-block">/  </span>

    /* <span class="variable">set</span> <span class="variable">an</span> <span class="variable">indexable</span> <span class="variable">thread-specific</span> <span class="variable">memory</span> <span class="variable">item</span> <span class="variable">for</span> <span class="variable">the</span> <span class="variable">lock</span> <span class="variable">type.</span> 
     * <span class="variable">this</span> <span class="variable">could</span> <span class="variable">be</span> <span class="variable">unnecessary</span> <span class="variable"><span class="keyword">if</span></span> <span class="variable">we</span> <span class="variable">pass</span> <span class="variable">the</span> <span class="variable">conn</span> *<span class="variable">c</span> <span class="variable">struct</span> <span class="variable">through</span> 
     * <span class="variable">all</span> <span class="variable">item</span>_<span class="variable">lock</span> <span class="variable">calls...</span> 
     *<span class="end-block">/  </span>
    <span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">item</span>_<span class="variable">lock</span>_<span class="variable">type</span> = <span class="variable">ITEM</span>_<span class="variable">LOCK</span>_<span class="variable">GRANULAR</span>;  
    <span class="variable">pthread</span>_<span class="variable">setspecific</span>(<span class="variable">item</span>_<span class="variable">lock</span>_<span class="variable">type</span>_<span class="variable">key</span>, &amp;<span class="variable">amp</span>;<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">item</span>_<span class="variable">lock</span>_<span class="variable">type</span>);  

    <span class="variable">register</span>_<span class="variable">thread</span>_<span class="variable">initialized</span>();  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>00;&amp;<span class="begin-block">#x</span>542<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;  
    //&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>81<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>1;&amp;<span class="begin-block">#x</span>72<span class="variable">EC</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ACB</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">event</span>_<span class="variable">base</span>&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;&amp;<span class="begin-block">#x</span>673<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5236;  
    /<span class="end-block">/memcache</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>72<span class="variable">EC</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ACB</span>;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;&amp;<span class="begin-block">#x</span>81<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>1;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>7<span class="variable">BA</span>1;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;  
    <span class="variable">event</span>_<span class="variable">base</span>_<span class="variable">loop</span>(<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">base</span>, 0);  
    <span class="variable">return</span> <span class="variable">NULL</span>;  
}</span><span class="xml"></span>
</code></pre><p>thread_libevent_process&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code><span class="xml">static void thread_libevent_process(int fd, short which, void *arg) </span><span class="expression">{  
    <span class="variable">LIBEVENT</span>_<span class="variable">THREAD</span> *<span class="variable">me</span> = <span class="variable">arg</span>;  
    <span class="variable">CQ</span>_<span class="variable">ITEM</span> *<span class="variable">item</span>;  
    <span class="variable">char</span> <span class="variable">buf</span>[1];  
    //&amp;<span class="begin-block">#x</span>56<span class="variable">DE</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">C</span>03;&amp;<span class="begin-block">#x</span>51<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>56<span class="variable">DE</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">BB</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">FE</span>1;&amp;<span class="begin-block">#x</span>606<span class="variable">F</span>;  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5411;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5199;&amp;<span class="begin-block">#x</span>5165;1  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;1&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>4;&amp;<span class="begin-block">#x</span>660<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>63;&amp;<span class="begin-block">#x</span>786<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7684;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">read</span>(<span class="variable">fd</span>, <span class="variable">buf</span>, 1) != 1)  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.verbose</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0)  
            <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Can</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">read</span> <span class="variable">from</span> <span class="variable">libevent</span> <span class="variable">pipe</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
    <span class="variable">switch</span> (<span class="variable">buf</span>[0]) {  
    <span class="variable">case</span> &amp;<span class="variable">apos</span>;<span class="variable">c</span>&amp;<span class="variable">apos</span>;:  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>961<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">CQ</span>_<span class="variable">ITEM</span>&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">FE</span>1;&amp;<span class="begin-block">#x</span>606<span class="variable">F</span>;  
    <span class="variable">item</span> = <span class="variable">cq</span>_<span class="variable">pop</span>(<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">new</span>_<span class="variable">conn</span>_<span class="variable">queue</span>);  
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>8<span class="variable">FDB</span>;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>7<span class="variable">BA</span>1;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">NULL</span> != <span class="variable">item</span>) {  
        /<span class="end-block">/conn</span>_<span class="variable">new</span>&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>975<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>38;&amp;<span class="begin-block">#x</span>91<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EFA</span>;<span class="variable">socket</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>5199;&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>76<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>542<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>3002;  
        /<span class="end-block">/init</span>_<span class="variable">state</span> &amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5728;<span class="variable">drive</span>_<span class="variable">machine</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>72<span class="variable">B</span>6;&amp;<span class="begin-block">#x</span>6001;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;  
        <span class="variable">conn</span> *<span class="variable">c</span> = <span class="variable">conn</span>_<span class="variable">new</span>(<span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">init</span>_<span class="variable">state</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">event</span>_<span class="variable">flags</span>,  
                           <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>, <span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">base</span>);  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">c</span> == <span class="variable">NULL</span>) {  
            <span class="variable"><span class="keyword">if</span></span> (<span class="variable">IS</span>_<span class="variable">UDP</span>(<span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>)) {  
                <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Can</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">listen</span> <span class="variable">for</span> <span class="variable">events</span> <span class="variable">on</span> <span class="variable">UDP</span> <span class="variable">socket</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
                <span class="variable">exit</span>(1);  
            }</span><span class="xml"> else </span><span class="expression">{  
                <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.verbose</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0) {  
                    <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Can</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">listen</span> <span class="variable">for</span> <span class="variable">events</span> <span class="variable">on</span> <span class="variable">fd</span> %<span class="variable">d</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;,  
                        <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>);  
                }</span><span class="xml">  
                close(item-&amp;gt;sfd);  
            }  
        } else </span><span class="expression">{  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">thread</span> = <span class="variable">me</span>;  
        }</span><span class="xml">  
        cqi_free(item);  
    }  
        break;  
    /* we were told to flip the lock type and report in */  
    case &amp;apos;l&amp;apos;:  
    me-&amp;gt;item_lock_type = ITEM_LOCK_GRANULAR;  
    register_thread_initialized();  
        break;  
    case &amp;apos;g&amp;apos;:  
    me-&amp;gt;item_lock_type = ITEM_LOCK_GLOBAL;  
    register_thread_initialized();  
        break;  
    }  
}</span>
</code></pre><p>conn_new&#x65B9;&#x6CD5;&#xFF08;&#x4E3B;&#x8981;&#x770B;&#x4E24;&#x884C;&#xFF09;&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;event&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x9645</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#xFF1B</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;event_handler&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
event_set(&amp;amp;c-&amp;gt;event, sfd, event_flags, event_handler, (void *)c);  
event_base_set(base, &amp;amp;c-&amp;gt;event);   
c-&amp;gt;ev_flags = event_flags;  
//&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;libevent&amp;<span class="symbol">#x7684</span>;loop&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (event_add(&amp;amp;c-&amp;gt;event, <span class="number">0</span>) == -<span class="number">1</span>) {  
    perror(&amp;quot;event_add&amp;quot;);  
    return <span class="class">NULL</span>;  
}
</code></pre><p>event_handler&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>void event_handler(const int fd, const short which, void *arg) {  
    conn *c;  
    //&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x88C5</span>;conn&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    c = (conn *)arg;  
    assert(c != <span class="class">NULL</span>);  
    c-&amp;gt;which = which;  
    /* sanity */  
    if (fd != c-&amp;gt;sfd) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Catastrophic</span>: event fd doesn&amp;apos;t match conn fd!\n&amp;quot;);  
        conn_close(c);  
        return;  
    }  
    //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x7EC8</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x4EA4</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x4E86</span>;drive_machine&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    //memcache&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F51</span>;&amp;<span class="symbol">#x7EDC</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7531</span>;drive_machine&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;  
    //drive_machine&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;c-&amp;gt;state&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;     
    drive_machine(c);  
    /* wait for next event */  
    return;  
}
</code></pre><p>&#x7136;&#x540E;&#x7EE7;&#x7EED;&#x770B;&#x6700;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x4E5F;&#x662F;&#x6838;&#x5FC3;&#x7684;&#x5904;&#x7406;&#x4E8B;&#x4EF6;&#x7684;&#x65B9;&#x6CD5;drive_machine&#xFF08;&#x72B6;&#x6001;&#x673A;&#xFF09;&#xFF0C;&#x76D1;&#x542C;socket&#x8FDE;&#x63A5;&#x3001;&#x76D1;&#x542C;socket&#x7684;&#x8BFB;&#x5199;&#x3001;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x7B49;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x5728;drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x800C;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x901A;&#x8FC7;c-&gt;state&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x6765;&#x5224;&#x65AD;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#x3002;</p>
<pre><code><span class="keyword">static</span> void drive_machine(conn *<span class="built_in">c</span>) {  
     <span class="comment">//....................  </span>
    <span class="built_in">assert</span>(<span class="built_in">c</span> != <span class="type">NULL</span>);  
    <span class="keyword">while</span> (!stop) {  
        <span class="comment">//&amp;#x8FD9;&amp;#x8FB9;&amp;#x901A;&amp;#x8FC7;state&amp;#x6765;&amp;#x5904;&amp;#x7406;&amp;#x4E0D;&amp;#x540C;&amp;#x7C7B;&amp;#x578B;&amp;#x7684;&amp;#x4E8B;&amp;#x4EF6;  </span>
        <span class="keyword">switch</span>(<span class="built_in">c</span>-&amp;gt;state) {  
        <span class="comment">//&amp;#x8FD9;&amp;#x8FB9;&amp;#x4E3B;&amp;#x8981;&amp;#x5904;&amp;#x7406;tcp&amp;#x8FDE;&amp;#x63A5;,&amp;#x53EA;&amp;#x6709;&amp;#x5728;&amp;#x4E3B;&amp;#x7EBF;&amp;#x7A0B;&amp;#x7684;&amp;#x4E0B;&amp;#xFF0C;&amp;#x624D;&amp;#x4F1A;&amp;#x6267;&amp;#x884C;listening&amp;#x76D1;&amp;#x542C;&amp;#x64CD;&amp;#x4F5C;&amp;#x3002;  </span>
        <span class="keyword">case</span> conn_listening:  
            addrlen = <span class="built_in">sizeof</span>(addr);  
#ifdef <span class="type">HAVE_ACCEPT4</span>  
            <span class="keyword">if</span> (use_accept4) {  
                sfd = accept4(<span class="built_in">c</span>-&amp;gt;sfd, (<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">amp</span>;<span class="title">addr</span>, &amp;<span class="title">amp</span>;<span class="title">addrlen</span>, <span class="title">SOCK_NONBLOCK</span>);  
            } <span class="title">else</span> </span>{  
                sfd = accept(<span class="built_in">c</span>-&amp;gt;sfd, (<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">amp</span>;<span class="title">addr</span>, &amp;<span class="title">amp</span>;<span class="title">addrlen</span>);  
            }  
#<span class="title">else</span>  
            <span class="title">sfd</span> = <span class="title">accept</span>(<span class="title">c</span>-&amp;<span class="title">gt</span>;<span class="title">sfd</span>, (<span class="title">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">amp</span>;<span class="title">addr</span>, &amp;<span class="title">amp</span>;<span class="title">addrlen</span>);  
#<span class="title">endif</span>  
            //......................  
            <span class="title">if</span> (<span class="title">settings</span>.<span class="title">maxconns_fast</span> &amp;<span class="title">amp</span>;&amp;<span class="title">amp</span>;  
                <span class="title">stats</span>.<span class="title">curr_conns</span> + <span class="title">stats</span>.<span class="title">reserved_fds</span> &amp;<span class="title">gt</span>;= <span class="title">settings</span>.<span class="title">maxconns</span> - 1) </span>{  
                str = &amp;quot;<span class="type">ERROR</span> <span class="type">Too</span> many open connections\r\n&amp;quot;;  
                res = write(sfd, str, strlen(str));  
                close(sfd);  
                <span class="type">STATS_LOCK</span>();  
                stats.rejected_conns++;  
                <span class="type">STATS_UNLOCK</span>();  
            } <span class="keyword">else</span> {  
                dispatch_conn_new(sfd, conn_new_cmd, <span class="type">EV_READ</span> | <span class="type">EV_PERSIST</span>,  
                                     <span class="type">DATA_BUFFER_SIZE</span>, tcp_transport);  
            }  
            stop = <span class="literal">true</span>;  
            <span class="keyword">break</span>;  
        <span class="comment">//&amp;#x8FDE;&amp;#x63A5;&amp;#x7B49;&amp;#x5F85;  </span>
        <span class="keyword">case</span> conn_waiting:  
            <span class="comment">//.........  </span>
            <span class="keyword">break</span>;  
        <span class="comment">//&amp;#x8BFB;&amp;#x53D6;&amp;#x4E8B;&amp;#x4EF6;  </span>
        <span class="comment">//&amp;#x4F8B;&amp;#x5982;&amp;#x6709;&amp;#x7528;&amp;#x6237;&amp;#x63D0;&amp;#x4EA4;&amp;#x6570;&amp;#x636E;&amp;#x8FC7;&amp;#x6765;&amp;#x7684;&amp;#x65F6;&amp;#x5019;&amp;#xFF0C;&amp;#x5DE5;&amp;#x4F5C;&amp;#x7EBF;&amp;#x7A0B;&amp;#x76D1;&amp;#x542C;&amp;#x5230;&amp;#x4E8B;&amp;#x4EF6;&amp;#x540E;&amp;#xFF0C;&amp;#x6700;&amp;#x7EC8;&amp;#x4F1A;&amp;#x8C03;&amp;#x7528;&amp;#x8FD9;&amp;#x5757;&amp;#x4EE3;&amp;#x7801;  </span>
        <span class="keyword">case</span> conn_read:  
            res = <span class="type">IS_UDP</span>(<span class="built_in">c</span>-&amp;gt;transport) ? try_read_udp(<span class="built_in">c</span>) : try_read_network(<span class="built_in">c</span>);  
            <span class="keyword">switch</span> (res) {  
            <span class="keyword">case</span> <span class="type">READ_NO_DATA_RECEIVED</span>:  
                conn_set_state(<span class="built_in">c</span>, conn_waiting);  
                <span class="keyword">break</span>;  
            <span class="keyword">case</span> <span class="type">READ_DATA_RECEIVED</span>:  
                conn_set_state(<span class="built_in">c</span>, conn_parse_cmd);  
                <span class="keyword">break</span>;  
            <span class="keyword">case</span> <span class="type">READ_ERROR</span>:  
                conn_set_state(<span class="built_in">c</span>, conn_closing);  
                <span class="keyword">break</span>;  
            <span class="keyword">case</span> <span class="type">READ_MEMORY_ERROR</span>: <span class="comment">/* Failed to allocate more memory */</span>  
                <span class="comment">/* State already set by try_read_network */</span>  
                <span class="keyword">break</span>;  
            }  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_parse_cmd :  
            <span class="keyword">if</span> (try_read_command(<span class="built_in">c</span>) == <span class="number">0</span>) {  
                <span class="comment">/* wee need more data! */</span>  
                conn_set_state(<span class="built_in">c</span>, conn_waiting);  
            }  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_new_cmd:  
            <span class="comment">/* Only process nreqs at a time to avoid starving other 
               connections */</span>  
            --nreqs;  
            <span class="keyword">if</span> (nreqs &amp;gt;= <span class="number">0</span>) {  
                reset_cmd_handler(<span class="built_in">c</span>);  
            } <span class="keyword">else</span> {  
                pthread_mutex_lock(&amp;amp;<span class="built_in">c</span>-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="built_in">c</span>-&amp;gt;thread-&amp;gt;stats.conn_yields++;  
                pthread_mutex_unlock(&amp;amp;<span class="built_in">c</span>-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="keyword">if</span> (<span class="built_in">c</span>-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
                    <span class="comment">/* We have already read in data into the input buffer, 
                       so libevent will most likely not signal read events 
                       on the socket (unless more data is available. As a 
                       hack we should just put in a request to write data, 
                       because that should be possible ;-) 
                    */</span>  
                    <span class="keyword">if</span> (!update_event(<span class="built_in">c</span>, <span class="type">EV_WRITE</span> | <span class="type">EV_PERSIST</span>)) {  
                        <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">0</span>)  
                            fprintf(stderr, &amp;quot;<span class="type">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
                        conn_set_state(<span class="built_in">c</span>, conn_closing);  
                        <span class="keyword">break</span>;  
                    }  
                }  
                stop = <span class="literal">true</span>;  
            }  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_nread:  
           <span class="comment">//....................  </span>
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_swallow:  
          <span class="comment">//....................  </span>
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_write:  
           <span class="comment">//.................  </span>
            <span class="keyword">break</span>;  
        <span class="comment">//&amp;#x8FDE;&amp;#x63A5;&amp;#x5173;&amp;#x95ED;  </span>
        <span class="keyword">case</span> conn_closing:  
            <span class="keyword">if</span> (<span class="type">IS_UDP</span>(<span class="built_in">c</span>-&amp;gt;transport))  
                conn_cleanup(<span class="built_in">c</span>);  
            <span class="keyword">else</span>  
                conn_close(<span class="built_in">c</span>);  
            stop = <span class="literal">true</span>;  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_closed:  
            <span class="comment">/* This only happens if dormando is an idiot. */</span>  
            abort();  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_max_state:  
            <span class="built_in">assert</span>(<span class="literal">false</span>);  
            <span class="keyword">break</span>;  
        }  
    }  
    <span class="keyword">return</span>;  
}
</code></pre><ol>
<li>main thread&#x4E3B;&#x7EBF;&#x7A0B;&#x6E90;&#x7801;&#x5206;&#x6790;</li>
</ol>
<p>&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;socket server&#x4E3B;&#x8981;&#x901A;&#x8FC7;server_sockets&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x3002;&#x800C;server_sockets&#x4E2D;&#x4E3B;&#x8981;&#x8C03;&#x7528;&#x4E86;server_socket&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;server_socket&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code><span class="xml">/** 
 * Create a socket and bind it to a specific port number 
 * @param interface the interface to bind to 
 * @param port the port number to bind to 
 * @param transport the transport protocol (TCP / UDP) 
 * @param portnumber_file A filepointer to write the port numbers to 
 *        when they are successfully added to the list of ports we 
 *        listen on. 
 */  
static int server_socket(const char *interface,  
                         int port,  
                         enum network_transport transport,  
                         FILE *portnumber_file) </span><span class="expression">{  
            //&amp;<span class="begin-block">#x</span>521<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EFA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;  
            //&amp;<span class="begin-block">#x</span>6211;&amp;<span class="begin-block">#x</span>4<span class="variable">EEC</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>73<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9762;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">C</span>03;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>46;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>533<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>522<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>9<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;<span class="variable">state</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;<span class="variable">conn</span>_<span class="variable">listening</span>  
            //&amp;<span class="begin-block">#x</span>6<span class="variable">CE</span>8;&amp;<span class="begin-block">#x</span>610<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">conn</span>_<span class="variable">listening</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>9<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">C</span>03;&amp;<span class="begin-block">#x</span>7528;<span class="variable">drive</span>_<span class="variable">machine</span>&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">conn</span>_<span class="variable">listen</span>&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>3;&amp;<span class="begin-block">#x</span>7801;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>3002;  
            <span class="variable"><span class="keyword">if</span></span> (!(<span class="variable">listen</span>_<span class="variable">conn</span>_<span class="variable">add</span> = <span class="variable">conn</span>_<span class="variable">new</span>(<span class="variable">sfd</span>, <span class="variable">conn</span>_<span class="variable">listening</span>,  
                                             <span class="variable">EV</span>_<span class="variable">READ</span> | <span class="variable">EV</span>_<span class="variable">PERSIST</span>, 1,  
                                             <span class="variable">transport</span>, <span class="variable">main</span>_<span class="variable">base</span>))) {  
                <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">failed</span> <span class="variable">to</span> <span class="variable">create</span> <span class="variable">listening</span> <span class="variable">connection</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
                <span class="variable">exit</span>(<span class="variable">EXIT</span>_<span class="variable">FAILURE</span>);  
            }</span><span class="xml">  
            listen_conn_add-&amp;gt;next = listen_conn;  
            listen_conn = listen_conn_add;  
}</span>
</code></pre><p>conn_new&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;event&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x9645</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#xFF1B</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;event_handler&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
event_set(&amp;amp;c-&amp;gt;event, sfd, event_flags, event_handler, (void *)c);  
event_base_set(base, &amp;amp;c-&amp;gt;event);   
c-&amp;gt;ev_flags = event_flags;  
//&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;libevent&amp;<span class="symbol">#x7684</span>;loop&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (event_add(&amp;amp;c-&amp;gt;event, <span class="number">0</span>) == -<span class="number">1</span>) {  
    perror(&amp;quot;event_add&amp;quot;);  
    return <span class="class">NULL</span>;  
}
</code></pre><p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x8DDF;&#x8E2A;&#x8FDB;&#x5165;event_handler&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x8FDB;&#x5165;drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x8BF4;&#x8FC7;server_socket&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4F20;&#x9012;&#x7684;state&#x53C2;&#x6570;&#x4E3A;&#x9ED8;&#x8BA4;&#x5199;&#x6B7B;&#x7684;conn_listening&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8BE6;&#x7EC6;&#x770B;drive_machine&#x4E2D;&#x5173;&#x4E8E;conn_listening&#x8FD9;&#x5757;&#x903B;&#x8F91;&#x7684;&#x4EE3;&#x7801;&#x3002;&#xA0;</p>
<pre><code>case <span class="method">conn_listening:</span>  
            addrlen = sizeof(addr);  
<span class="symbol">#ifdef</span> <span class="class">HAVE_ACCEPT4</span>  
            //&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x662F</span>;accept&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53D7</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
            if (use_accept4) {  
                sfd = accept4(c-&amp;gt;sfd, (struct sockaddr *)&amp;amp;addr, &amp;amp;addrlen, <span class="class">SOCK_NONBLOCK</span>);  
            } else {  
                sfd = accept(c-&amp;gt;sfd, (struct sockaddr *)&amp;amp;addr, &amp;amp;addrlen);  
            }  
<span class="symbol">#else</span>  
            sfd = accept(c-&amp;gt;sfd, (struct sockaddr *)&amp;amp;addr, &amp;amp;addrlen);  
<span class="symbol">#endif</span>  
            if (sfd == -<span class="number">1</span>) {  
                if (use_accept4 &amp;amp;&amp;amp; errno == <span class="class">ENOSYS</span>) {  
                    use_accept4 = <span class="number">0</span>;  
                    continue;  
                }  
                perror(use_accept4 ? &amp;quot;accept4()&amp;quot; : &amp;quot;accept()&amp;quot;);  
                if (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>) {  
                    /* these are transient, so don&amp;apos;t log anything */  
                    stop = <span class="keyword">true</span>;  
                } else if (errno == <span class="class">EMFILE</span>) {  
                    if (settings.verbose &amp;gt; <span class="number">0</span>)  
                        fprintf(stderr, &amp;quot;<span class="class">Too</span> many open connections\n&amp;quot;);  
                    accept_new_conns(<span class="keyword">false</span>);  
                    stop = <span class="keyword">true</span>;  
                } else {  
                    perror(&amp;quot;accept()&amp;quot;);  
                    stop = <span class="keyword">true</span>;  
                }  
                break;  
            }  
            if (!use_accept4) {  
                if (fcntl(sfd, <span class="class">F_SETFL</span>, fcntl(sfd, <span class="class">F_GETFL</span>) | <span class="class">O_NONBLOCK</span>) &amp;lt; <span class="number">0</span>) {  
                    perror(&amp;quot;setting <span class="class">O_NONBLOCK</span>&amp;quot;);  
                    close(sfd);  
                    break;  
                }  
            }  
            if (settings.maxconns_fast &amp;amp;&amp;amp;  
                stats.curr_conns + stats.reserved_fds &amp;gt;= settings.maxconns - <span class="number">1</span>) {  
                str = &amp;quot;<span class="class">ERROR</span> <span class="class">Too</span> many open connections\r\n&amp;quot;;  
                res = write(sfd, str, strlen(str));  
                close(sfd);  
                <span class="class">STATS_LOCK</span>();  
                stats.rejected_conns++;  
                <span class="class">STATS_UNLOCK</span>();  
            } else {  
                //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7528</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x903B</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
                //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x67D0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
                dispatch_conn_new(sfd, conn_new_cmd, <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>,  
                                     <span class="class">DATA_BUFFER_SIZE</span>, tcp_transport);  
            }  
            stop = <span class="keyword">true</span>;  
            break;
</code></pre><p>dispatch_conn_new&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>/* 
 * <span class="class">Dispatches</span> a new connection to another thread. <span class="class">This</span> is only ever called 
 * from the main thread, either during initialization (for <span class="class">UDP</span>) or because 
 * of an incoming connection. 
 */  
void dispatch_conn_new(int sfd, enum conn_states init_state, int event_flags,  
                       int read_buffer_size, enum network_transport transport) {  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;<span class="class">CQ_ITEM</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;  
    <span class="class">CQ_ITEM</span> *item = cqi_new();  
    char buf[<span class="number">1</span>];  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;item&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
    if (item == <span class="class">NULL</span>) {  
        close(sfd);  
        /* given that malloc failed this may also fail, but let&amp;apos;s try */  
        fprintf(stderr, &amp;quot;<span class="class">Failed</span> to allocate memory for connection object\n&amp;quot;);  
        return ;  
    }  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;  
    //&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;last_thread&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x8BA9</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x8F6E</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x8861</span>;  
    int tid = (last_thread + <span class="number">1</span>) % settings.num_threads;  

    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    <span class="class">LIBEVENT_THREAD</span> *thread = threads + tid;  

    last_thread = tid;  

    item-&amp;gt;sfd = sfd;  
    item-&amp;gt;init_state = init_state;  
    item-&amp;gt;event_flags = event_flags;  
    item-&amp;gt;read_buffer_size = read_buffer_size;  
    item-&amp;gt;transport = transport;  
    //&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x961F</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x5165</span>;<span class="class">CQ_ITEM</span>  
    cq_push(thread-&amp;gt;new_conn_queue, item);  

    <span class="class">MEMCACHED_CONN_DISPATCH</span>(sfd, thread-&amp;gt;thread_id);  
    buf[<span class="number">0</span>] = &amp;apos;c&amp;apos;;  
    //&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;pipe&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;<span class="number">1</span>  
    //&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;&amp;<span class="symbol">#x5230</span>;pipe&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5411</span>;thread-&amp;gt;new_conn_queue&amp;<span class="symbol">#x961F</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x4E2D</span>;pop&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (write(thread-&amp;gt;notify_send_fd, buf, <span class="number">1</span>) != <span class="number">1</span>) {  
        perror(&amp;quot;<span class="class">Writing</span> to thread notify pipe&amp;quot;);  
    }  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Socket/">Socket</a><a href="/tags/libevent/">libevent</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/274a8a5/" title="Linux c 开发 - Memcached源码分析之消息回应（3） -" itemprop="url">Linux c 开发 - Memcached源码分析之消息回应（3） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B;&#xFF0C;&#x6211;&#x4EEC;&#x82B1;&#x4E86;&#x5F88;&#x5927;&#x7684;&#x529B;&#x6C14;&#x53BB;&#x8BB2;&#x89E3;Memcached&#x5982;&#x4F55;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;&#xFF0C;&#x5E76;&#x4E14;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#xFF0C;&#x7136;&#x540E;&#x5904;&#x7406;&#x547D;&#x4EE4;&#x5E76;&#x4E14;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x56DE;&#x5E94;&#x6D88;&#x606F;&#x3002;</p>
<p>&#x8FD9;&#x4E00;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x6765;&#x8BB2;&#x89E3;Memcached&#x56DE;&#x5E94;&#x6D88;&#x606F;&#x7684;&#x6280;&#x672F;&#x7EC6;&#x8282;&#x3002;</p>
<p>&#x672C;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x51E0;&#x4E2A;&#x77E5;&#x8BC6;&#x70B9;(msghdr&#x548C;iovc)&#x3002;</p>
<p>msghdr&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code><span class="keyword">struct</span> msghdr {  
    <span class="keyword">void</span> *msg_name;  
    <span class="keyword">socklen_t</span> msg_namelen;  
    <span class="keyword">struct</span> iovec *msg_iov;  
    <span class="keyword">size_t</span> msg_iovlen;  
    <span class="keyword">void</span> *msg_control;  
    <span class="keyword">size_t</span> msg_controllen;  
    <span class="keyword">int</span> msg_flags;  
};
</code></pre><p>iovc&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code><span class="preprocessor">#include &amp;lt;sys/uio.h&amp;gt;  </span>
<span class="comment">/* Structure for scatter/gather I/O. */</span>  
<span class="keyword">struct</span> iovec {  
    <span class="keyword">void</span> *iov_base; <span class="comment">/* Pointer to data. */</span>  
    <span class="keyword">size_t</span> iov_len; <span class="comment">/* Length of data. */</span>  
};
</code></pre><p>Memcached&#x662F;&#x901A;&#x8FC7;sendmsg&#x51FD;&#x6570;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6570;&#x636E;&#x7684;&#xFF0C;&#x5C31;&#x4F1A;&#x7528;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x4E0D;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x7684;&#xFF0C;&#x5EFA;&#x8BAE;&#x5148;&#x4E86;&#x89E3;&#x4E4B;&#x540E;&#x518D;&#x7EE7;&#x7EED;&#x5F80;&#x4E0B;&#x770B;&#x3002;</p>
<p>Memcached&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x6E90;&#x7801;&#x5206;&#x6790; </p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;&#x4E00;&#x4E0B;conn&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x3002;conn&#x7ED3;&#x6784;&#x6211;&#x4EEC;&#x4E0A;&#x4E00;&#x671F;&#x8BF4;&#x8FC7;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x5B58;&#x50A8;&#x5355;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x8BE6;&#x60C5;&#xFFFD;&#xFFFD;&#xFFFD;&#x606F;&#x3002;&#x6BCF;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x5230;Memcached&#x90FD;&#x4F1A;&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code><span class="xml">typedef struct conn conn;  
struct conn </span><span class="expression">{  
    /<span class="end-block">/....  </span>
    /* <span class="variable">data</span> <span class="variable">for</span> <span class="variable">the</span> <span class="variable">mwrite</span> <span class="variable">state</span> *<span class="end-block">/  </span>
    /<span class="end-block">/iov</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;<span class="variable">iov</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    /<span class="end-block">/iov</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5728;<span class="variable">conn</span>_<span class="variable">new</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">CFB</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EDF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;400&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">iovec</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>9<span class="variable">AD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>34;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>4<span class="variable">D</span>;600&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;  
    <span class="variable">struct</span> <span class="variable">iovec</span> *<span class="variable">iov</span>;  
    /<span class="end-block">/iov</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;  
    <span class="variable">int</span>    <span class="variable">iovsize</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">allocated</span> <span class="variable">in</span> <span class="variable">iov</span>[] *<span class="end-block">/  </span>
    /<span class="end-block">/iovused </span>&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;<span class="variable">iov</span>&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;&amp;<span class="begin-block">#x</span>591<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>11;  
    <span class="variable">int</span>    <span class="variable">iovused</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">used</span> <span class="variable">in</span> <span class="variable">iov</span>[] *<span class="end-block">/  </span>

    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;<span class="variable">msghdr</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;&amp;<span class="begin-block">#x</span>5728;<span class="variable">conn</span>_<span class="variable">new</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">CFB</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EDF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;10&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    <span class="variable">struct</span> <span class="variable">msghdr</span> *<span class="variable">msglist</span>;  
    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;10&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>9<span class="variable">AD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>34;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>4<span class="variable">D</span>;100&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>591<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;<span class="variable">realloc</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6269;&amp;<span class="begin-block">#x</span>5<span class="variable">BB</span>9;&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>6269;&amp;<span class="begin-block">#x</span>5<span class="variable">BB</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>500<span class="variable">D</span>;  
    <span class="variable">int</span>    <span class="variable">msgsize</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">allocated</span> <span class="variable">in</span> <span class="variable">msglist</span>[] *<span class="end-block">/  </span>
    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>2;&amp;<span class="begin-block">#x</span>7<span class="variable">ECF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;  
    <span class="variable">int</span>    <span class="variable">msgused</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">used</span> <span class="variable">in</span> <span class="variable">msglist</span>[] *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>2<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>9<span class="variable">B</span>;<span class="variable">msglist</span>&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>2;&amp;<span class="begin-block">#x</span>7<span class="variable">ECF</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>54<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>9<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CA</span>1;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>3002;  
    <span class="variable">int</span>    <span class="variable">msgcurr</span>;   /* <span class="variable">element</span> <span class="variable">in</span> <span class="variable">msglist</span>[] <span class="variable">being</span> <span class="variable">transmitted</span> <span class="variable">now</span> *<span class="end-block">/  </span>
    <span class="variable">int</span>    <span class="variable">msgbytes</span>;  /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">bytes</span> <span class="variable">in</span> <span class="variable">current</span> <span class="variable">msg</span> *<span class="end-block">/  </span>
}</span><span class="xml"></span>
</code></pre><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x4E00;&#x4E0B;conn_new&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5E94;&#x8BE5;&#x5728;&#x7B2C;&#x4E00;&#x7AE0;&#x8282;&#x7684;&#x65F6;&#x5019;&#x8BB2;&#x5230;&#x8FC7;&#x3002;&#x8FD9;&#x8FB9;&#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;iov&#x548C;msglist&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x521D;&#x59CB;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
<pre><code><span class="xml">conn *conn_new(const int sfd, enum conn_states init_state,  
      const int event_flags, const int read_buffer_size,  
      enum network_transport transport, struct event_base *base) </span><span class="expression">{  
/<span class="end-block">/...  </span>
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span> = <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wbuf</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixlist</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">hdrbuf</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rsize</span> = <span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wsize</span> = <span class="variable">DATA</span>_<span class="variable">BUFFER</span>_<span class="variable">SIZE</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">isize</span> = <span class="variable">ITEM</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixsize</span> = <span class="variable">SUFFIX</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iovsize</span> = <span class="variable">IOV</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>; //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;400  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgsize</span> = <span class="variable">MSG</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>; //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;10  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">hdrsize</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span> = (<span class="variable">char</span> *) <span class="variable">malloc</span>((<span class="variable">size</span>_<span class="variable">t</span>) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rsize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wbuf</span> = (<span class="variable">char</span> *) <span class="variable">malloc</span>((<span class="variable">size</span>_<span class="variable">t</span>) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wsize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span> = (<span class="variable">item</span> **) <span class="variable">malloc</span>(<span class="variable">sizeof</span>(<span class="variable">item</span> *) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">isize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixlist</span> = (<span class="variable">char</span> **) <span class="variable">malloc</span>(<span class="variable">sizeof</span>(<span class="variable">char</span> *) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixsize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span> = (<span class="variable">struct</span> <span class="variable">iovec</span> *) <span class="variable">malloc</span>(<span class="variable">sizeof</span>(<span class="variable">struct</span> <span class="variable">iovec</span>) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iovsize</span>); //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;<span class="variable">iov</span>  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span> = (<span class="variable">struct</span> <span class="variable">msghdr</span> *) <span class="variable">malloc</span>(  
            <span class="variable">sizeof</span>(<span class="variable">struct</span> <span class="variable">msghdr</span>) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgsize</span>); //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;<span class="variable">msglist</span>  
/<span class="end-block">/...  </span>
}</span><span class="xml"></span>
</code></pre><p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#x56FE;&#xFF08;iov&#x548C;msglist&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF09;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2748dca.jpg" alt=""></p>
<p>&#x4ECE;process_get_command&#x5F00;&#x59CB;</p>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x4ECE;process_get_command&#xFF0C;&#x83B7;&#x53D6;memcached&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5F00;&#x59CB;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x770B;add_iov&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;Memcached&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;add_iov&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x9700;&#x8981;&#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x88C5;&#x5230;iov&#x548C;msglist&#x7ED3;&#x6784;&#x4E2D;&#x53BB;&#x7684;&#x3002;</p>
<pre><code>/* ntokens is overwritten here... shrug.. */  
//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
static inline void process_get_command(conn *c, token_t *tokens, size_t ntokens,  
        bool return_cas) {  
    //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    char *key;  
    size_t nkey;  
    int i = <span class="number">0</span>;  
    item *it;  
    //&amp;amp;tokens[<span class="number">0</span>] &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    //&amp;amp;tokens[<span class="number">1</span>] &amp;<span class="symbol">#x4E3A</span>;key  
    //token_t &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E86</span>;value&amp;<span class="symbol">#x548C</span>;length  
    token_t *key_token = &amp;amp;tokens[<span class="class">KEY_TOKEN</span>];  
    char *suffix;  
    assert(c != <span class="class">NULL</span>);  
    do {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
        while (key_token-&amp;gt;length != <span class="number">0</span>) {  
            key = key_token-&amp;gt;value;  
            nkey = key_token-&amp;gt;length;  
            //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;memcache key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">250</span>  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;  
            if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
                //out_string &amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
                out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
                while (i-- &amp;gt; <span class="number">0</span>) {  
                    item_remove(*(c-&amp;gt;ilist + i));  
                }  
                return;  
            }  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5FEB</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            it = item_get(key, nkey);  
            if (settings.detail_enabled) {  
                //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
                stats_prefix_record_get(key, nkey, <span class="class">NULL</span> != it);  
            }  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            if (it) {  
                //c-&amp;gt;ilist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;buf  
                //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;ilist&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
                if (i &amp;gt;= c-&amp;gt;isize) {  
                    item **new_list = realloc(c-&amp;gt;ilist,  
                            sizeof(item *) * c-&amp;gt;isize * <span class="number">2</span>);  
                    if (new_list) {  
                        //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
                        c-&amp;gt;isize *= <span class="number">2</span>;  
                        //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x652F</span>;&amp;<span class="symbol">#x6301</span>;  
                        c-&amp;gt;ilist = new_list;  
                    } else {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        item_remove(it);  
                        break;  
                    }  
                }  
                /* 
                 * <span class="class">Construct</span> the response. <span class="class">Each</span> hit adds three elements to the 
                 * outgoing data <span class="method">list:</span> 
                 *   &amp;quot;<span class="class">VALUE</span> &amp;quot; 
                 *   key 
                 *   &amp;quot; &amp;quot; + flags + &amp;quot; &amp;quot; + data length + &amp;quot;\r\n&amp;quot; + data (with \r\n) 
                 */  
                //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
                if (return_cas) {  
                    //......  
                } else {  
                    <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                            it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
                    //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>;get userId  
                    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;  
                    //<span class="class">VALUE</span> userId <span class="number">0</span> <span class="number">5</span>  
                    //<span class="number">55555</span>  
                    //<span class="class">END</span>  
                    if (&amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                            || &amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                            || &amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, <span class="class">ITEM_suffix</span>(it),  
                                    it-&amp;gt;nsuffix + it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                        item_remove(it);  
                        break;  
                    }  
                }  
                if (settings.verbose &amp;gt; <span class="number">1</span>) {  
                    int ii;  
                    fprintf(stderr, &amp;quot;&amp;gt;%d sending key &amp;quot;, c-&amp;gt;sfd);  
                    for (ii = <span class="number">0</span>; ii &amp;lt; it-&amp;gt;nkey; ++ii) {  
                        fprintf(stderr, &amp;quot;%c&amp;quot;, key[ii]);  
                    }  
                    fprintf(stderr, &amp;quot;\n&amp;quot;);  
                }  
                /* item_get() has incremented it-&amp;gt;refcount for us */  
                pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].get_hits++;  
                c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
                pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                item_update(it);  
                *(c-&amp;gt;ilist + i) = it;  
                i++;  
            } else {  
                pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                c-&amp;gt;thread-&amp;gt;stats.get_misses++;  
                c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
                pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, key, nkey, -<span class="number">1</span>, <span class="number">0</span>);  
            }  
            key_token++;  
        }  
        /* 
         * <span class="class">If</span> the command string hasn&amp;apos;t been fully processed, get the next set 
         * of tokens. 
         */  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;get&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
        if (key_token-&amp;gt;value != <span class="class">NULL</span>) {  
            ntokens = tokenize_command(key_token-&amp;gt;value, tokens, <span class="class">MAX_TOKENS</span>);  
            key_token = tokens;  
        }  
    } while (key_token-&amp;gt;value != <span class="class">NULL</span>);  
    c-&amp;gt;icurr = c-&amp;gt;ilist;  
    c-&amp;gt;ileft = i;  
    if (return_cas) {  
        c-&amp;gt;suffixcurr = c-&amp;gt;suffixlist;  
        c-&amp;gt;suffixleft = i;  
    }  
    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;gt;%d <span class="class">END</span>\n&amp;quot;, c-&amp;gt;sfd);  
    /* 
     <span class="class">If</span> the loop was terminated because of out-of-memory, it is not 
     reliable to add <span class="class">END</span>\r\n to the buffer, because it might not end 
     in \r\n. <span class="class">So</span> we send <span class="class">SERVER_ERROR</span> instead. 
     */  
    //&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#x675F</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;  
    if (key_token-&amp;gt;value != <span class="class">NULL</span> || &amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, &amp;quot;<span class="class">END</span>\r\n&amp;quot;, <span class="number">5</span>) != <span class="number">0</span>  
            || (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>)) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory writing get response&amp;quot;);  
    } else {  
        //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x3002</span>;  
        conn_set_state(c, conn_mwrite);  
        c-&amp;gt;msgcurr = <span class="number">0</span>;  
    }  
}
</code></pre><p>add_iov &#x65B9;&#x6CD5;</p>
<p>add_iov&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;Memcached&#x9700;&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5206;&#x6210;N&#x591A;&#x4E2A;IOV&#x7684;&#x5757;</p>
</li>
<li><p>&#x5C06;IOV&#x5757;&#x6DFB;&#x52A0;&#x5230;msghdr&#x7684;&#x7ED3;&#x6784;&#x4E2D;&#x53BB;&#x3002;</p>
<p> static int add_iov(conn <em>c, const void </em>buf, int len) {  </p>
<pre><code>struct msghdr *m;  
int leftover;  
bool limit_to_mtu;  
assert(c != <span class="class">NULL</span>);  
do {  
  //&amp;<span class="symbol">#x6D88</span>;&amp;<span class="symbol">#x606F</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>; msglist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
  //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;  
  m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgused - <span class="number">1</span>];  
  /* 
   * <span class="class">Limit</span> <span class="class">UDP</span> packets, and the first payloads of <span class="class">TCP</span> replies, to 
   * <span class="class">UDP_MAX_PAYLOAD_SIZE</span> bytes. 
   */  
  limit_to_mtu = <span class="class">IS_UDP</span>(c-&amp;gt;transport) || (<span class="number">1</span> == c-&amp;gt;msgused);  
  /* <span class="class">We</span> may need to start a new msghdr if this one is full. */  
  //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;iov&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
  if (m-&amp;gt;msg_iovlen == <span class="class">IOV_MAX</span>  
        || (limit_to_mtu &amp;amp;&amp;amp; c-&amp;gt;msgbytes &amp;gt;= <span class="class">UDP_MAX_PAYLOAD_SIZE</span>)) {  
    //&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;msghdr,&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;<span class="number">10</span>&amp;<span class="symbol">#x4E2A</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
    add_msghdr(c);  
    //&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgused - <span class="number">1</span>];  
  }  
  //&amp;<span class="symbol">#x786E</span>;&amp;<span class="symbol">#x8BA4</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x662F</span>;<span class="number">400</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6C34</span>;&amp;<span class="symbol">#x4F4D</span>;<span class="number">600</span>  
  //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
  if (ensure_iov_space(c) != <span class="number">0</span>)  
    return -<span class="number">1</span>;  
  /* <span class="class">If</span> the fragment is too big to fit in the datagram, split it up */  
  if (limit_to_mtu &amp;amp;&amp;amp; len + c-&amp;gt;msgbytes &amp;gt; <span class="class">UDP_MAX_PAYLOAD_SIZE</span>) {  
    leftover = len + c-&amp;gt;msgbytes - <span class="class">UDP_MAX_PAYLOAD_SIZE</span>;  
    len -= leftover;  
  } else {  
    leftover = <span class="number">0</span>;  
  }  
  m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgused - <span class="number">1</span>];  
  //m-&amp;gt;msg_iov&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;c-&amp;gt;iov&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x3002</span>;  
  //&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;m-&amp;gt;msg_iov&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5230</span>;c-&amp;gt;iov&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E0B</span>;add_msghdr&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
  //&amp;<span class="symbol">#x5411</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;<span class="class">BUF</span>  
  m-&amp;gt;msg_iov[m-&amp;gt;msg_iovlen].iov_base = (void *) buf;  
  //buf&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
  m-&amp;gt;msg_iov[m-&amp;gt;msg_iovlen].iov_len = len; //&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
  c-&amp;gt;msgbytes += len;  
  c-&amp;gt;iovused++;  
  m-&amp;gt;msg_iovlen++; //msg_iovlen + <span class="number">1</span>  
  buf = ((char *) buf) + len;  
  len = leftover;  
} while (leftover &amp;gt; <span class="number">0</span>);  
return <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>add_msghdr &#x65B9;&#x6CD5; msghdr&#x6269;&#x5BB9;</p>
<p>&#x5728;add_iov&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5F53;IOV&#x5757;&#x6DFB;&#x52A0;&#x6EE1;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6269;&#x5BB9;msgdhr&#x7684;&#x4E2A;&#x6570;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4E24;&#x4E2A;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x68C0;&#x67E5;c-&gt;msglist&#x5217;&#x8868;&#x957F;&#x5EA6;&#x662F;&#x5426;&#x591F;&#x7528;&#x3002;</p>
</li>
<li><p>&#x4F7F;&#x7528;&#x6700;&#x65B0;&#x7684;c-&gt;msglist&#x4E2D;&#x7684;&#x4E00;&#x4E2A;msghdr&#x5143;&#x7D20;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;msghdr-&gt;msg_iov&#x6307;&#x5411;c-&gt;iov&#x6700;&#x65B0;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x90A3;&#x4E2A;iov&#x7684;&#x6307;&#x9488;&#x5730;&#x5740;&#x3002;</p>
<p> static int add_msghdr(conn *c) {  </p>
<pre><code>//c-&amp;gt;msglist &amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
struct msghdr *msg;  
assert(c != <span class="class">NULL</span>);  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;msglist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;msglist&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
if (c-&amp;gt;msgsize == c-&amp;gt;msgused) {  
    //&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x500D</span>;  
    msg = realloc(c-&amp;gt;msglist, c-&amp;gt;msgsize * <span class="number">2</span> * sizeof(struct msghdr));  
    if (!msg) {  
        <span class="class">STATS_LOCK</span>();  
        stats.malloc_fails++;  
        <span class="class">STATS_UNLOCK</span>();  
        return -<span class="number">1</span>;  
    }  
    c-&amp;gt;msglist = msg; //&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;msglist&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;  
    c-&amp;gt;msgsize *= <span class="number">2</span>; //size&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8DDF</span>;&amp;<span class="symbol">#x7740</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;  
}  
//msg&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;  
msg = c-&amp;gt;msglist + c-&amp;gt;msgused;  
/* this wipes msg_iovlen, msg_control, msg_controllen, and 
 msg_flags, the last <span class="number">3</span> of which aren&amp;apos;t defined on <span class="method">solaris:</span> */  
//&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
memset(msg, <span class="number">0</span>, sizeof(struct msghdr));  
//&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7684</span>;msg_iov&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>; struct iovec *iov&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
msg-&amp;gt;msg_iov = &amp;amp;c-&amp;gt;iov[c-&amp;gt;iovused];  
if (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; c-&amp;gt;request_addr_size &amp;gt; <span class="number">0</span>) {  
    msg-&amp;gt;msg_name = &amp;amp;c-&amp;gt;request_addr;  
    msg-&amp;gt;msg_namelen = c-&amp;gt;request_addr_size;  
}  
c-&amp;gt;msgbytes = <span class="number">0</span>;  
c-&amp;gt;msgused++;  
if (<span class="class">IS_UDP</span>(c-&amp;gt;transport)) {  
    /* <span class="class">Leave</span> room for the <span class="class">UDP</span> header, which we&amp;apos;ll fill in later. */  
    return add_iov(c, <span class="class">NULL</span>, <span class="class">UDP_HEADER_SIZE</span>);  
}  
return <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>ensure_iov_space &#x65B9;&#x6CD5; IOV&#x6269;&#x5BB9;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x68C0;&#x67E5;c-&gt;iov&#x662F;&#x5426;&#x8FD8;&#x6709;&#x5269;&#x4F59;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x591F;&#x7528;&#x4E86;&#xFF0C;&#x5219;&#x6269;&#x5BB9;2&#x500D;&#x3002;</p>
<pre><code><span class="keyword">static</span> int ensure_iov_space(conn *<span class="built_in">c</span>) {  
    <span class="built_in">assert</span>(<span class="built_in">c</span> != <span class="type">NULL</span>);  
    <span class="comment">//&amp;#x5982;&amp;#x679C;IOV&amp;#x4E5F;&amp;#x4F7F;&amp;#x7528;&amp;#x5B8C;&amp;#x4E86;....IOV&amp;#xFF0C;&amp;#x5206;&amp;#x914D;&amp;#x65B0;&amp;#x7684;IOV  </span>
    <span class="keyword">if</span> (<span class="built_in">c</span>-&amp;gt;iovused &amp;gt;= <span class="built_in">c</span>-&amp;gt;iovsize) {  
        int i, iovnum;  
        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">new_iov</span> = (<span class="title">struct</span> <span class="title">iovec</span> *) <span class="title">realloc</span>(<span class="title">c</span>-&amp;<span class="title">gt</span>;<span class="title">iov</span>,  
                (<span class="title">c</span>-&amp;<span class="title">gt</span>;<span class="title">iovsize</span> * 2) * <span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">iovec</span>));  
        <span class="title">if</span> (!<span class="title">new_iov</span>) </span>{  
            <span class="type">STATS_LOCK</span>();  
            stats.malloc_fails++;  
            <span class="type">STATS_UNLOCK</span>();  
            <span class="keyword">return</span> -<span class="number">1</span>;  
        }  
        <span class="built_in">c</span>-&amp;gt;iov = new_iov;  
        <span class="built_in">c</span>-&amp;gt;iovsize *= <span class="number">2</span>; <span class="comment">//&amp;#x6269;&amp;#x5BB9;&amp;#x4E24;&amp;#x500D;  </span>
        <span class="comment">/* Point all the msghdr structures at the new list. */</span>  
        <span class="keyword">for</span> (i = <span class="number">0</span>, iovnum = <span class="number">0</span>; i &amp;lt; <span class="built_in">c</span>-&amp;gt;msgused; i++) {  
            <span class="built_in">c</span>-&amp;gt;msglist[i].msg_iov = &amp;amp;<span class="built_in">c</span>-&amp;gt;iov[iovnum];  
            iovnum += <span class="built_in">c</span>-&amp;gt;msglist[i].msg_iovlen;  
        }  
    }  
    <span class="keyword">return</span> <span class="number">0</span>;  
}
</code></pre><p>conn_mwrite</p>
<p>conn_mwrite&#x72B6;&#x6001;&#x5728;drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x3002;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x5199;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;add_iov&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;Memcached&#x4F1A;&#x5C06;&#x9700;&#x8981;&#x5F85;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x5199;&#x5165;c-&gt;msglist&#x7ED3;&#x6784;&#x4E2D;&#x3002;</p>
<p>&#x771F;&#x6B63;&#x5199;&#x6570;&#x636E;&#x7684;&#x65B9;&#x6CD5;&#x662F;transmit&#x3002;</p>
<pre><code>//drive_machine&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;conn_mwrite&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
case <span class="method">conn_mwrite:</span>  
    if (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; c-&amp;gt;msgcurr == <span class="number">0</span>  
            &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Failed</span> to build <span class="class">UDP</span> headers\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    //transmit&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;transmit_result&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
    switch (transmit(c)) {  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;  
    case <span class="class">TRANSMIT_COMPLETE</span>:  
        if (c-&amp;gt;state == conn_mwrite) {  
            conn_release_items(c);  
            /* <span class="class">XXX</span>:  <span class="class">I</span> don&amp;apos;t know why this wasn&amp;apos;t the general case */  
            if (c-&amp;gt;protocol == binary_prot) {  
                conn_set_state(c, c-&amp;gt;write_and_go);  
            } else {  
                //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
                //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x5230</span>;conn_new_cmd&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
                //conn_new_cmd&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;  
                conn_set_state(c, conn_new_cmd);  
            }  
        } else if (c-&amp;gt;state == conn_write) {  
            if (c-&amp;gt;write_and_free) {  
                free(c-&amp;gt;write_and_free);  
                c-&amp;gt;write_and_free = <span class="number">0</span>;  
            }  
            conn_set_state(c, c-&amp;gt;write_and_go);  
        } else {  
            if (settings.verbose &amp;gt; <span class="number">0</span>)  
                fprintf(stderr, &amp;quot;<span class="class">Unexpected</span> state %d\n&amp;quot;, c-&amp;gt;state);  
            conn_set_state(c, conn_closing);  
        }  
        break;
</code></pre><p>transmit &#x65B9;&#x6CD5;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6570;&#x636E;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;conn_mwrite&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6B62</span>;  
static enum transmit_result transmit(conn *c) {  
    assert(c != <span class="class">NULL</span>);  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x6821</span>;&amp;<span class="symbol">#x9A8C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;c-&amp;gt;msgcurr&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#xFF0C</span>;  
    //&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x4E0A</span>;  
    //c-&amp;gt;msgcurr&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">0</span>  
    if (c-&amp;gt;msgcurr &amp;lt; c-&amp;gt;msgused &amp;amp;&amp;amp; c-&amp;gt;msglist[c-&amp;gt;msgcurr].msg_iovlen == <span class="number">0</span>) {  
        /* <span class="class">Finished</span> writing the current msg; advance to the next. */  
        c-&amp;gt;msgcurr++;  
    }  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;msgcurr&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;msgused&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;msgcurr&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;msgused&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">TRANSMIT_COMPLETE</span>&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
    if (c-&amp;gt;msgcurr &amp;lt; c-&amp;gt;msgused) {  
        ssize_t res;  
        //&amp;<span class="symbol">#x4ECE</span>;c-&amp;gt;msglist&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
        struct msghdr *m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgcurr];  
        //&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        res = sendmsg(c-&amp;gt;sfd, m, <span class="number">0</span>);  
        //&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
        if (res &amp;gt; <span class="number">0</span>) {  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.bytes_written += res;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            /* <span class="class">We</span>&amp;apos;ve written some of the data. <span class="class">Remove</span> the completed 
             iovec entries from the list of pending writes. */  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;  
            while (m-&amp;gt;msg_iovlen &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; res &amp;gt;= m-&amp;gt;msg_iov-&amp;gt;iov_len) {  
                res -= m-&amp;gt;msg_iov-&amp;gt;iov_len;  
                m-&amp;gt;msg_iovlen--;  
                m-&amp;gt;msg_iov++;  
            }  
            /* <span class="class">Might</span> have written just part of the last iovec entry; 
             adjust it so the next write will do the rest. */  
            if (res &amp;gt; <span class="number">0</span>) {  
                m-&amp;gt;msg_iov-&amp;gt;iov_base = (caddr_t) m-&amp;gt;msg_iov-&amp;gt;iov_base + res;  
                m-&amp;gt;msg_iov-&amp;gt;iov_len -= res;  
            }  
            return <span class="class">TRANSMIT_INCOMPLETE</span>;  
        }  
        //&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
        if (res == -<span class="number">1</span> &amp;amp;&amp;amp; (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>)) {  
            if (!update_event(c, <span class="class">EV_WRITE</span> | <span class="class">EV_PERSIST</span>)) {  
                if (settings.verbose &amp;gt; <span class="number">0</span>)  
                    fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
                conn_set_state(c, conn_closing);  
                return <span class="class">TRANSMIT_HARD_ERROR</span>;  
            }  
            return <span class="class">TRANSMIT_SOFT_ERROR</span>;  
        }  
        /* if res == <span class="number">0</span> or res == -<span class="number">1</span> and error is not <span class="class">EAGAIN</span> or <span class="class">EWOULDBLOCK</span>, 
         we have a real error, on which we close the connection */  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            perror(&amp;quot;<span class="class">Failed</span> to write, and not due to blocking&amp;quot;);  
        if (<span class="class">IS_UDP</span>(c-&amp;gt;transport))  
            conn_set_state(c, conn_read);  
        else  
            conn_set_state(c, conn_closing);  
        return <span class="class">TRANSMIT_HARD_ERROR</span>;  
    } else {  
        return <span class="class">TRANSMIT_COMPLETE</span>;  
    }  
}
</code></pre><p>conn_shrink &#x65B9;&#x6CD5;</p>
<p>&#x5F53;&#x6570;&#x636E;&#x53D1;&#x9001;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;conn_new_cmd&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x7EE7;&#x7EED;&#x5904;&#x7406;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;reset_cmd_handler&#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;conn_shrink&#x65B9;&#x6CD5;&#x3002;</p>
<p>conn_shrink&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E;&#x68C0;&#x67E5;buf&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x662F;&#x5426;&#x8D85;&#x8FC7;&#x4E86;&#x9884;&#x5B9A;&#x7684;&#x6C34;&#x4F4D;&#xFF0C;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x4E86;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x91CD;&#x65B0;realloc&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;handler  
static void reset_cmd_handler(conn *c) {  
    c-&amp;gt;cmd = -<span class="number">1</span>;  
    c-&amp;gt;substate = bin_no_state;  
    if (c-&amp;gt;item != <span class="class">NULL</span>) {  
        item_remove(c-&amp;gt;item);  
        c-&amp;gt;item = <span class="class">NULL</span>;  
    }  
    conn_shrink(c); //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; &amp;gt; <span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_parse_cmd&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
        conn_set_state(c, conn_parse_cmd);  
    } else {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6765</span>;  
        conn_set_state(c, conn_waiting);  
    }  
}


//&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;rbuf&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
static void conn_shrink(conn *c) {  
    assert(c != <span class="class">NULL</span>);  
    if (<span class="class">IS_UDP</span>(c-&amp;gt;transport))  
        return;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;bufsize&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">READ_BUFFER_HIGHWAT</span>&amp;<span class="symbol">#xFF08</span>;<span class="number">8192</span>&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
    //<span class="class">DATA_BUFFER_SIZE</span>&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">2048</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5BF9</span>;rbuf&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;<span class="number">4</span>&amp;<span class="symbol">#x6B21</span>;recalloc  
    if (c-&amp;gt;rsize &amp;gt; <span class="class">READ_BUFFER_HIGHWAT</span> &amp;amp;&amp;amp; c-&amp;gt;rbytes &amp;lt; <span class="class">DATA_BUFFER_SIZE</span>) {  
        char *newbuf;  
        if (c-&amp;gt;rcurr != c-&amp;gt;rbuf)  
            memmove(c-&amp;gt;rbuf, c-&amp;gt;rcurr, (size_t) c-&amp;gt;rbytes); //&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;  
        newbuf = (char *) realloc((void *) c-&amp;gt;rbuf, <span class="class">DATA_BUFFER_SIZE</span>);  
        if (newbuf) {  
            c-&amp;gt;rbuf = newbuf;  
            c-&amp;gt;rsize = <span class="class">DATA_BUFFER_SIZE</span>;  
        }  
        /* <span class="class">TODO</span> check other branch... */  
        c-&amp;gt;rcurr = c-&amp;gt;rbuf;  
    }  
    if (c-&amp;gt;isize &amp;gt; <span class="class">ITEM_LIST_HIGHWAT</span>) {  
        item **newbuf = (item**) realloc((void *) c-&amp;gt;ilist,  
                <span class="class">ITEM_LIST_INITIAL</span> * sizeof(c-&amp;gt;ilist[<span class="number">0</span>]));  
        if (newbuf) {  
            c-&amp;gt;ilist = newbuf;  
            c-&amp;gt;isize = <span class="class">ITEM_LIST_INITIAL</span>;  
        }  
        /* <span class="class">TODO</span> check error condition? */  
    }  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;msglist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6C34</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;realloc  
    if (c-&amp;gt;msgsize &amp;gt; <span class="class">MSG_LIST_HIGHWAT</span>) {  
        struct msghdr *newbuf = (struct msghdr *) realloc((void *) c-&amp;gt;msglist,  
                <span class="class">MSG_LIST_INITIAL</span> * sizeof(c-&amp;gt;msglist[<span class="number">0</span>]));  
        if (newbuf) {  
            c-&amp;gt;msglist = newbuf;  
            c-&amp;gt;msgsize = <span class="class">MSG_LIST_INITIAL</span>;  
        }  
        /* <span class="class">TODO</span> check error condition? */  
    }  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;iovsize&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6C34</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;realloc  
    if (c-&amp;gt;iovsize &amp;gt; <span class="class">IOV_LIST_HIGHWAT</span>) {  
        struct iovec *newbuf = (struct iovec *) realloc((void *) c-&amp;gt;iov,  
                <span class="class">IOV_LIST_INITIAL</span> * sizeof(c-&amp;gt;iov[<span class="number">0</span>]));  
        if (newbuf) {  
            c-&amp;gt;iov = newbuf;  
            c-&amp;gt;iovsize = <span class="class">IOV_LIST_INITIAL</span>;  
        }  
        /* <span class="class">TODO</span> check return value */  
    }  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/273d920/" title="MemcachedClient 使用说明 -" itemprop="url">MemcachedClient 使用说明 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x4E0A;&#x4E00;&#x7BC7;&#x4ECB;&#x7ECD;&#x4E86;Memcached&#x57FA;&#x672C;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x300A;Memcached&#x4F7F;&#x7528;&#x624B;&#x518C;&#x300B;&#xFF0C;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;java&#x5982;&#x4F55;&#x64CD;&#x4F5C;memcached&#x3002;&#x4F7F;&#x7528;&#x7684;&#x662F;java_memcached-release_2.6.6&#x3002; </p>
<p>&#x4E00;&#x3001;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;</p>
<p>&#x65B0;&#x5EFA;&#x9879;&#x76EE;&#xFF0C;&#x6DFB;&#x52A0;&#x76F8;&#x5173;jar&#x5305;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/273c809.png" alt=""></p>
<p>&#x76F4;&#x63A5;&#x4E0A;&#x4EE3;&#x7801;&#x4E86;&#xFF0C;&#x6CE8;&#x91CA;&#x5199;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;&#xFF0C;&#x4E0D;&#x7528;&#x591A;&#x8BF4;&#x4E86;&#x554A;&#x3002;</p>
<pre><code>package www.xufei.com;

import com.danga.<span class="class">MemCached</span>.<span class="class">MemCachedClient</span>;
import com.danga.<span class="class">MemCached</span>.<span class="class">SockIOPool</span>;

public class <span class="class">MemcachedDemo</span> {

    public static void main(<span class="class">String</span>[] args) {
        //memcached&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;
        <span class="class">String</span>[] servers = {&amp;quot;<span class="number">127.0</span>.0.1:<span class="number">11211</span>&amp;quot;,&amp;quot;<span class="number">192.168</span>.1.3:<span class="number">11211</span>&amp;quot;};
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;cache&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6743</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x548C</span>;server&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x5E94</span>;
         */
        <span class="class">Integer</span>[] weights = {<span class="number">1</span>,<span class="number">2</span>};
        /**
         * &amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8BAF</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x62EC</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8BAF</span>;&amp;<span class="symbol">#x3001</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x3001</span>;hash&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x751F</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x3002</span>;
         * &amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8F7D</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;getInstance( <span class="class">String</span> poolName )&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;poolName&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">SockIOPool</span>&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x3002</span>;
         * &amp;<span class="symbol">#x7F3A</span>;&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x7684</span>;poolName&amp;<span class="symbol">#x662F</span>;default&amp;<span class="symbol">#x3002</span>;
         */
        <span class="class">SockIOPool</span> pool = <span class="class">SockIOPool</span>.getInstance();
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;memcached&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;
        pool.setServers(servers);
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;memcached&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x6743</span>;&amp;<span class="symbol">#x91CD</span>;
        pool.setWeights(weights);
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">TRUE</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;socket&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5E8F</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NULL</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">true</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x8BAE</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x6301</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;
        pool.setFailover( <span class="keyword">true</span> );
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;cache&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
        pool.setInitConn( <span class="number">10</span> ); 
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
        pool.setMinConn( <span class="number">5</span> );
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
        pool.setMaxConn( <span class="number">250</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7761</span>;&amp;<span class="symbol">#x7720</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x52A8</span>;
         * &amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;log&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FD0</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x76EE</span>;&amp;<span class="symbol">#x53CA</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x63A7</span>;&amp;<span class="symbol">#x5236</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x3002</span>;
         */
        pool.setMaintSleep( <span class="number">30</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;<span class="class">Nagle</span>&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8BAF</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x91CF</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x5BF9</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x63A7</span>;&amp;<span class="symbol">#x5236</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x54CD</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x53CA</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="keyword">false</span>&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">true</span>&amp;<span class="symbol">#xFF09</span>;
         */
        pool.setNagle( <span class="keyword">false</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x503C</span>;
         */
        pool.setSocketTO( <span class="number">3000</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x3002</span>;
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="keyword">true</span>&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x500D</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7F51</span>;&amp;<span class="symbol">#x7EDC</span>;&amp;<span class="symbol">#x8D1F</span>;&amp;<span class="symbol">#x8F7D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5BF9</span>;<span class="class">HA</span>&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x9AD8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x573A</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">TRUE</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">false</span>&amp;<span class="symbol">#x3002</span>;
         */
        pool.setAliveCheck( <span class="keyword">true</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5B8C</span>;pool&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x52A8</span>;pool&amp;<span class="symbol">#x3002</span>;
         */
        pool.initialize();

        /**
         * &amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;memcached&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5BF9</span>;memcached&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x9762</span>;
         */
        <span class="class">MemCachedClient</span> memCachedClient = new <span class="class">MemCachedClient</span>();
        /**
         * &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;username&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5218</span>;&amp;<span class="symbol">#x5FB7</span>;&amp;<span class="symbol">#x534E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="keyword">true</span>
         */
        boolean success = memCachedClient.set(&amp;quot;username&amp;quot;, &amp;quot;&amp;<span class="symbol">#x5218</span>;&amp;<span class="symbol">#x5FB7</span>;&amp;<span class="symbol">#x534E</span>;&amp;quot;);
        <span class="class">System</span>.out.println(success);

        /**
         * &amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;key&amp;<span class="symbol">#x4E3A</span>;username&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;
         */
        <span class="class">Object</span> o = memCachedClient.get(&amp;quot;username&amp;quot;);
        <span class="class">System</span>.out.println(o);

        /**
         * &amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x4E49</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;p&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">Persion</span>&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x5FC5</span>;&amp;<span class="symbol">#x987B</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x73B0</span>;<span class="class">Serializable</span>&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53E3</span>;
         */
        <span class="class">Persion</span> p = new <span class="class">Persion</span>();
        p.setId(&amp;quot;<span class="number">1</span>&amp;quot;);
        p.setName(&amp;quot;&amp;<span class="symbol">#x5468</span>;&amp;<span class="symbol">#x6770</span>;&amp;<span class="symbol">#x4F26</span>;&amp;quot;);

        /**
         * &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;p&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
         */
        memCachedClient.set(&amp;quot;p1&amp;quot;, p);

        /**
         * &amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;p&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
         */
        <span class="class">Persion</span> p1 = (<span class="class">Persion</span>) memCachedClient.get(&amp;quot;p1&amp;quot;);
        <span class="class">System</span>.out.println(p1.getName());

        /**
         * &amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;add&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;key&amp;<span class="symbol">#x4E3A</span>;p1&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x503C</span>;<span class="number">123</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;p1&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x4E86</span>;
         */
        memCachedClient.add(&amp;quot;p1&amp;quot;, <span class="number">123</span>);//&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;&amp;<span class="symbol">#xFF01</span>;&amp;<span class="symbol">#x65E0</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p1&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;

        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;person&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;

        /**
         * &amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;set&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p1
         */
        memCachedClient.set(&amp;quot;p1&amp;quot;, <span class="number">123</span>);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;<span class="number">123</span>

        /**
         * &amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;replace&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p1
         */
        memCachedClient.replace(&amp;quot;p1&amp;quot;, <span class="number">456</span>);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;<span class="number">456</span>

        /**
         * &amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;replace&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p2,&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542B</span>;&amp;<span class="symbol">#x6709</span>;key&amp;<span class="symbol">#x4E3A</span>;p2&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x65E0</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;
         */
        memCachedClient.replace(&amp;quot;p2&amp;quot;, <span class="number">456</span>);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p2&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;null

        /**
         * &amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;key&amp;<span class="symbol">#x4E3A</span>;p1&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;
         */
        memCachedClient.delete(&amp;quot;p1&amp;quot;);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;null
    }
}
</code></pre><p>&#x4E8C;&#x3001;&#x5E38;&#x7528;&#x65B9;&#x6CD5;&#x8BF4;&#x660E;</p>
<p>1 <strong>&#x3001;SockIOPool&#xA0;&#x662F;socket&#xA0;&#x8FDE;&#x63A5;&#x6C60;&#x7C7B;</strong></p>
<p>setServers(String[] servers)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x670D;&#x52A1;&#x5668;&#x4FE1;&#x606F;&#x6570;&#x7EC4;&#xFF1B;</p>
<p>setWeights(String[] weights)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x670D;&#x52A1;&#x5668;&#x6743;&#x91CD;&#x6570;&#x7EC4;&#xFF1B;</p>
<p>setInitConn(int count)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x521D;&#x59CB;&#x8FDE;&#x63A5;&#x6570;&#xFF1B;</p>
<p>setMinConn(int minConn)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5C0F;&#x8FDE;&#x63A5;&#x6570;&#xFF1B;</p>
<p>setMaxConn(int maxConn)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x8FDE;&#x63A5;&#x6570;&#xFF1B;</p>
<p>setMaxIdle(long arg0)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x5904;&#x7406;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>setMaintSleep(long arg0)&#xA0;&#xFF1A;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;&#x7761;&#x7720;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>initialize()&#xA0;&#xFF1A;&#x521D;&#x59CB;&#x5316;&#x8FDE;&#x63A5;&#x6C60;&#x3002;</p>
<p>2 <strong>&#x3001;MemCachedClient&#xA0;&#x7C7B;&#x53CA;&#x5176;&#x5E38;&#x7528;&#x65B9;&#x6CD5;</strong></p>
<p>add(String key, Object value)&#xA0;&#xFF1A;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#x5230;&#x7F13;&#x5B58;&#x4E2D;&#xFF1B;</p>
<p>add(String key, Object value,Date expires)&#xA0;&#xFF1A;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#x5230;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>set(String key, Object value)&#xA0;&#xFF1A;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x952E;&#x7684;&#x503C;&#xFF1B;</p>
<p>set(String key, Object value, Date expires)&#xA0;&#xFF1A;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x952E;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>get(String key)&#xA0;&#xFF1A;&#x83B7;&#x5F97;&#x67D0;&#x4E2A;&#x952E;&#x7684;&#x503C;&#x3002;</p>
<p>incr(String key)&#xA0;&#xFF1A;&#x4E3A;&#x67D0;&#x4E2A;&#x952E;&#x4E0A;&#x7684;&#x503C;&#x6267;&#x884C;+1&#xA0;&#x64CD;&#x4F5C;&#xFF1B;</p>
<p>decr(String key)&#xA0;&#xFF1A;&#x4E3A;&#x67D0;&#x4E2A;&#x952E;&#x4E0A;&#x7684;&#x503C;&#x6267;&#x884C;-1&#xA0;&#x64CD;&#x4F5C;&#xFF1B;</p>
<p>replace(String key, String value)&#xA0;&#xFF1A;&#x5C06;&#x67D0;&#x4E2A;&#x952E;&#x7684;&#x503C;&#x66FF;&#x6362;&#x6210;&#x65B0;&#x7684;&#x503C;&#xFF1B;</p>
<p>replace(String key, String value, Date expires)&#xA0;&#xFF1A;&#x5C06;&#x67D0;&#x4E2A;&#x952E;&#x7684;&#x503C;&#x66FF;&#x6362;&#x6210;&#x65B0;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x3002;</p>
<p>delete(String key)&#xFF1A;&#x5220;&#x9664;&#x7F13;&#x5B58;&#x4E2D;&#x4E00;&#x4E2A;key&#x7684;&#x503C;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2737507/" title="Linux下安装MemCached笔记 -" itemprop="url">Linux下安装MemCached笔记 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;</p>
<ol>
<li><p>MemCached&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7248;&#x672C;&#x4E3A;&#xFF1A;1.4.22&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE; <a href="http://memcached.org/" target="_blank" rel="external">&#x5B98;&#x7F51;</a> &#x4E0B;&#x8F7D;&#x5230;&#x3002; </p>
</li>
<li><p>MemCached&#x4F9D;&#x8D56;libevent&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x5B89;&#x88C5;MemCached&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5148;&#x5B89;&#x88C5;libevent&#x3002;</p>
</li>
</ol>
<p>2.1 &#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#xFF0C;&#x67E5;&#x770B;&#x7CFB;&#x7EDF;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;libevent&#x3002;</p>
<p>[root@SecurityCheck ~]# rpm -qa|grep libevent</p>
<p>libevent-headers-1.4.13-4.el6.noarch</p>
<p>libevent-1.4.13-4.el6.x86_64</p>
<p>libevent-doc-1.4.13-4.el6.noarch</p>
<p>libevent-devel-1.4.13-4.el6.x86_64</p>
<p>&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>3.&#xA0; &#x5C06;&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#x7684;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;/opt/favccxx&#xFF0C;&#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x89E3;&#x538B;&#x3002;</p>
<p>[root@SecurityCheck favccxx]# tar -zxvf memcached-1.4.22.tar.gz</p>
<ol>
<li><p>&#x8FD0;&#x884C; [root@SecurityCheck favccxx]# cd memcached-1.4.22 ,&#x5207;&#x6362;&#x5230;memcached&#x76EE;&#x5F55;&#x4E0B;&#x3002;</p>
</li>
<li><p>&#x8FD0;&#x884C; [root@SecurityCheck memcached-1.4.22]# ./configure &amp;&amp; make &amp;&amp; make test &amp;&amp; sudo make install &#xFF0C;&#x4E00;&#x952E;&#x5B8C;&#x6210;&#x5B89;&#x88C5;&#x3002;</p>
</li>
<li><p>&#x8FD0;&#x884C;root@SecurityCheck bin]# ./memcached -u root&#xFF0C; &#x542F;&#x52A8;MemCached&#x3002;MemCached&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x7AEF;&#x53E3;&#x4E3A;&#xFF1A;11211&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;[root@SecurityCheck bin]# ./memcached -p 12306 -u root&#xFF0C;&#x66F4;&#x6539;&#x9ED8;&#x8BA4;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x542F;&#x52A8;&#x3002;&#x5982;&#x679C;&#x60F3;&#x8981;&#x5728;&#x5173;&#x95ED;&#x7A97;&#x53E3;&#x7684;&#x60C5;&#x51B5;&#x4E0B;memcache&#x8FDB;&#x7A0B;&#x4ECD;&#x7136;&#x8FD0;&#x884C;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x547D;&#x4EE4;&#x540E;&#x9762;&#x52A0;&#x4E0A; -d&#xFF0C;&#x8868;&#x793A;&#x4EE5;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x3002;</p>
</li>
<li><p>MemCached&#x7684;&#x5E38;&#x7528;&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;[root@SecurityCheck bin]# ./memcached&#xA0; -h &#x67E5;&#x770B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E9B;&#x5E38;&#x7528;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
</li>
</ol>
<p>-d &#xFF1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;</p>
<p>-m&#xFF1A;&#x5206;&#x914D;&#x7ED9;Memcache&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x6570;&#x91CF;&#xFF0C;&#x5355;&#x4F4D;&#x662F;MB&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;64MB&#xFF0C;</p>
<p>-u &#xFF1A;&#x8FD0;&#x884C;Memcache&#x7684;&#x7528;&#x6237;</p>
<p>-l&#xA0; &#xFF1A;&#x76D1;&#x542C;&#x7684;&#x670D;&#x52A1;&#x5668;IP&#x5730;&#x5740;</p>
<p>-p &#xFF1A;&#x8BBE;&#x7F6E;Memcache&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;11211&#xA0; &#xA0; &#x6CE8;&#xFF1A;-p&#xFF08;p&#x4E3A;&#x5C0F;&#x5199;&#xFF09;</p>
<p>-c &#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x5E76;&#x53D1;&#x8FDE;&#x63A5;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1024</p>
<ol>
<li>&#x81F3;&#x6B64;&#xFF0C;MemCached&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x53EF;&#x4EE5;&#x4F53;&#x9A8C;MemCached&#x4E86;&#x3002;</li>
</ol>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2015-04/115643.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-04/115643.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2732958/" title="MemCached缓存知识知多少？ -" itemprop="url">MemCached缓存知识知多少？ -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li>MemCached&#x662F;&#x795E;&#x9A6C;&#xFF1F;</li>
</ol>
<p>Memcached&#xA0; &#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x7528;&#x4E8E;&#x52A8;&#x6001;Web&#x5E94;&#x7528;&#x4EE5;&#x51CF;&#x8F7B;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#x3002;&#x5B83;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x548C;&#x5BF9;&#x8C61;&#x6765;&#x51CF;&#x5C11;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x52A8;&#x6001;&#x3001;&#x6570;&#x636E;&#x5E93;&#x9A71;&#x52A8;&#x7F51;&#x7AD9;&#x7684;&#x901F;&#x5EA6;&#x3002;Memcached&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;/&#x503C;&#x5BF9;&#x7684;hashmap&#x3002;&#x5176;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF08;daemon &#xFF09;&#x662F;&#x7528;C&#x5199;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x7528;&#x4EFB;&#x4F55;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;memcached&#x534F;&#x8BAE;&#x4E0E;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x3002;</p>
<p>MemCached&#x6700;&#x65E9;&#x662F;&#x7531; Brad Fitzpatrick &#x5728;2003&#x5E74;&#x4E3A;LiveJournal&#x800C;&#x5F00;&#x53D1;&#x7684;&#x7F13;&#x5B58;&#x7A0B;&#x5E8F;&#x3002;&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7684;&#x7248;&#x672C;&#x4E3A;v1.4.22.</p>
<ol>
<li>MemCached&#x7684;&#x7279;&#x70B9;&#xFF1F;</li>
</ol>
<p>&#x534F;&#x8BAE;&#x7B80;&#x5355;&#xFF1A;memcached&#x7684;&#x670D;&#x52A1;&#x5668;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x4FE1;&#x5E76;&#x4E0D;&#x4F7F;&#x7528;&#x590D;&#x6742;&#x7684;MXL&#x7B49;&#x683C;&#x5F0F;&#xFF0C;&#x800C;&#x662F;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;&#x57FA;&#x4E8E;&#x6587;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x3002;</p>
<p>&#x57FA;&#x4E8E;libevent&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#xFF1A;libevent&#x662F;&#x4E2A;&#x7A0B;&#x5E8F;&#x5E93;&#xFF0C;&#x4ED6;&#x5C06;Linux &#x7684;epoll&#x3001;BSD&#x7C7B;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;kqueue&#x7B49;&#x65F6;&#x95F4;&#x5904;&#x7406;&#x529F;&#x80FD;&#x5C01;&#x88C5;&#x6210;&#x7EDF;&#x4E00;&#x7684;&#x63A5;&#x53E3;&#x3002;&#xA0; &#xA0; memcached&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;libevent&#x5E93;&#xFF0C;&#x56E0;&#x6B64;&#x80FD;&#x5728;Linux&#x3001;BSD&#x3001;Solaris&#x7B49;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#x53D1;&#x6325;&#x5176;&#x9AD8;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x5185;&#x7F6E;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF1A;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x91CD;&#x542F;memcached&#xFF0C;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x503C;&#x4E4B;&#x540E;memcached&#x56DE;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x9002;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;</p>
<p>&#x4E0D;&#x4E92;&#x901A;&#x4FE1;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#xFF1A;memcached&#x5C3D;&#x7BA1;&#x662F;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F46;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x529F;&#x80FD;&#x3002;&#x5404;&#x4E2A;memcached&#x4E0D;&#x4F1A;&#x4E92;&#x76F8;&#x901A;&#x4FE1;&#x4EE5;&#x5171;&#x4EAB;&#x4FE1;&#x606F;&#x3002;&#x4ED6;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<ol>
<li>MemCached&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF1F;</li>
</ol>
<p>&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x91CD;&#x542F;memcached&#x3001;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x503C;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x57FA;&#x4E8E;LRU(Least Recently Used)&#x7B97;&#x6CD5;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x4F7F;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;memcached&#x672C;&#x8EAB;&#x662F;&#x4E3A;&#x7F13;&#x5B58;&#x800C;&#x8BBE;&#x8BA1;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x8003;&#x8651;&#x6570;&#x636E;&#x7684;&#x6C38;&#x4E45;&#x6027;&#x95EE;&#x9898;&#x3002;</p>
<ol>
<li>MemCached&#x4E0E;Redis&#x7684;PK&#xFF1F;</li>
</ol>
<p>&#x6BCF;&#x79D2;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x4E0D;&#x662F;&#x74F6;&#x9888;&#xFF1A;Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;&#xFF0C;&#x800C;Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF0C;&#x6240;&#x4EE5;&#x4E8C;&#x8005;&#x6BD4;&#x8F83;&#x8D77;&#x6765;&#xFF0C;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;&#xFF0C;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#x3002;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77;Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;</p>
<p>&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#xFF1A;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x548C;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#x548C;&#x6570;&#x636E;&#x7279;&#x6027;&#x6709;&#x5173;&#x3002;</p>
<p>&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x4E0E;&#x6570;&#x636E;&#x540C;&#x6B65;&#xFF1A;Redis&#x652F;&#x6301;&#xFF0C;MemCached&#x4E0D;&#x652F;&#x6301;&#x3002;</p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;Redis&#x76F8;&#x6BD4;Memcached&#x6765;&#x8BF4;&#xFF0C;&#x62E5;&#x6709;&#x66F4;&#x591A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x652F;&#x6301;&#x66F4;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#x3002;&#x901A;&#x5E38;&#x5728;Memcached&#x91CC;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x62FF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8FDB;&#x884C;&#x7C7B;&#x4F3C;&#x7684;&#x4FEE;&#x6539;&#x518D;set&#x56DE;&#x53BB;&#x3002;&#x8FD9;&#x5927;&#x5927;&#x589E;&#x52A0;&#x4E86;&#x7F51;&#x7EDC;IO&#x7684;&#x6B21;&#x6570;&#x548C;&#x6570;&#x636E;&#x4F53;&#x79EF;&#x3002;&#x5728;Redis&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x7684;&#x64CD;&#x4F5C;&#x901A;&#x5E38;&#x548C;&#x4E00;&#x822C;&#x7684;GET/SET&#x4E00;&#x6837;&#x9AD8;&#x6548;&#x3002;</p>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2015-04/115642.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-04/115642.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2730248/" title="redis和memcached比较 -" itemprop="url">redis和memcached比较 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>1&#x3001;CPU&#x6838;&#x5FC3;&#xFF1A;</p>
<p>&#x7531;&#x4E8E;Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;&#xFF0C;&#x800C;Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF0C;&#x6240;&#x4EE5;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#xFF0C;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77; Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;</p>
<p>&#x56E0;&#x4E3A; Redis &#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x975E;&#x5E38;&#x5FEB;&#x901F;&#x2014;&#x2014;&#x5B83;&#x7684;&#x6570;&#x636E;&#x5168;&#x90E8;&#x5728;&#x5185;&#x5B58;&#x91CC;&#xFF0C;&#x5B8C;&#x5168;&#x4E0D;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x78C1;&#x76D8;&#x3002;&#x81F3;&#x4E8E;&#x5E76;&#x53D1;&#xFF0C;Redis &#x4F7F;&#x7528;&#x591A;&#x8DEF; I/O &#x590D;&#x7528;&#x6280;&#x672F;&#xFF0C;&#x672C;&#x8EAB;&#x7684;&#x5E76;&#x53D1;&#x6548;&#x7387;&#x4E0D;&#x6210;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x5355;&#x4E2A; Redis &#x8FDB;&#x7A0B;&#x6CA1;&#x529E;&#x6CD5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF08;&#x4EFB;&#x4E00;&#x65F6;&#x523B;&#x53EA;&#x80FD;&#x8DD1;&#x5728;&#x4E00;&#x4E2A; CPU &#x6838;&#x5FC3;&#x4E0A;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x672C;&#x6765;&#x5C31;&#x4E0D;&#x662F;&#x975E;&#x5E38;&#x8BA1;&#x7B97;&#x5BC6;&#x96C6;&#x578B;&#x7684;&#x670D;&#x52A1;&#x3002;&#x5982;&#x679C;&#x5355;&#x6838;&#x6027;&#x80FD;&#x4E0D;&#x591F;&#x7528;&#xFF0C;&#x53EF;&#x4EE5;&#x591A;&#x5F00;&#x51E0;&#x4E2A;&#x8FDB;&#x7A0B;&#x3002;</p>
<p>Redis &#x5355;&#x7EBF;&#x7A0B;-&#x591A;&#x8DEF;&#x590D;&#x7528;io&#x6A21;&#x578B; </p>
<p>2&#x3001;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#x5BF9;&#x6BD4;&#xFF1A;</p>
<p>&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#x7684;&#x8BDD;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8;&#xFF0C;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;</p>
<p>3&#x3001;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1A;</p>
<p>Redis&#x76F8;&#x6BD4;Memcached&#x6765;&#x8BF4;&#xFF0C;&#x62E5;&#x6709;&#x66F4;&#x591A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;&#x5E76;&#x652F;&#x6301;&#x66F4;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#xFF0C;&#x901A;&#x5E38;&#x5728;Memcached &#x91CC;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x62FF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8FDB;&#x884C;&#x7C7B;&#x4F3C;&#x7684;&#x4FEE;&#x6539;&#x518D;set&#x56DE;&#x53BB;&#x3002;&#x8FD9;&#x5927;&#x5927;&#x589E;&#x52A0;&#x4E86;&#x7F51;&#x7EDC;IO&#x7684;&#x6B21;&#x6570;&#x548C;&#x6570;&#x636E;&#x4F53;&#x79EF;&#x3002;&#x5728;Redis&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x7684;&#x64CD;&#x4F5C;&#xFFFD;&#xFFFD;&#xFFFD;&#x5E38;&#x548C;&#x4E00;&#x822C;&#x7684; GET/SET&#x4E00;&#x6837;&#x9AD8;&#x6548;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x7F13;&#x5B58;&#x80FD;&#x591F;&#x652F;&#x6301;&#x66F4;&#x590D;&#x6742;&#x7684;&#x7ED3;&#x6784;&#x548C;&#x64CD;&#x4F5C;&#xFF0C;&#x90A3;&#x4E48;Redis&#x4F1A;&#x662F;&#x4E0D;&#x9519;&#x7684;&#x9009;&#x62E9;&#x3002;</p>
<p>4&#x3001;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Redis/">Redis</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2727e72/" title="zabbix monitor redis memcached with python script -" itemprop="url">zabbix monitor redis memcached with python script -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>zabbix &#x76D1;&#x63A7;memcached&#x548C;redis&#xFF0C;&#x4EE5;&#x524D;&#x90FD;&#x662F;&#x7528;shell&#x5199;&#x811A;&#x672C;&#xFF0C;&#x4ECA;&#x5929;&#x4E0D;&#x662F;&#x592A;&#x5FD9;&#xFF0C;&#x6240;&#x4EE5;&#x7528;python&#x4EE3;&#x66FF;shell,&#x6765;&#x8BA9;zabbix&#x8C03;&#x7528;&#x53D6;&#x6570;&#x636E;</p>
<p>1&#x3001;&#x76D1;&#x63A7;memcached&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p> Python</p>
<pre><code><span class="comment"># cat get_memcached_status.py </span>
<span class="comment">#!/usr/bin/env python</span>
<span class="comment">#coding=utf8</span>
<span class="keyword">import</span> sys
<span class="keyword">import</span> os
<span class="class"><span class="keyword">class</span> <span class="title">GetMemStatus</span><span class="params">()</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>
        self.val = {}
    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span>
        <span class="keyword">try</span>:
            <span class="keyword">import</span> memcache
            self.mc = memcache.Client([&amp;apos;<span class="number">127.0</span>.0.1:<span class="number">11211</span>&amp;apos;], debug=<span class="number">0</span>)
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;Plugin needs the memcache module&amp;apos;
    <span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(self, key)</span>:</span>
        stats = self.mc.get_stats()
        <span class="keyword">try</span>:
            <span class="keyword">if</span> key <span class="keyword">in</span> stats[<span class="number">0</span>][<span class="number">1</span>]:
                self.val[key] = stats[<span class="number">0</span>][<span class="number">1</span>][key]
            <span class="keyword">return</span> self.val[key]
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;ERROR: key <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!&amp;apos;
<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:
        <span class="keyword">print</span> &amp;quot;ERROR! Please enter a key&amp;quot;
    <span class="keyword">elif</span> len(sys.argv) == <span class="number">2</span>:
        key = sys.argv[<span class="number">1</span>]
        a = GetMemStatus()
        a.check()
        <span class="keyword">print</span> a.extract(key)
<span class="keyword">if</span> __name__ == &amp;quot;__main__&amp;quot;:
    main()
</code></pre><p>&#x6267;&#x884C;&#x6D4B;&#x8BD5;&#xFF1A;</p>
<p> Shell</p>
<pre><code>[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py</span>
<span class="keyword">ERROR</span>! Please enter a <span class="keyword">key</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py pointer_size</span>
<span class="number">64</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py get_misses</span>
<span class="number">2</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py get_hits</span>
<span class="number">1</span>
<span class="preprocessor"># ./get_memcached_status.py aaa</span>
Traceback (most recent <span class="keyword">call</span> last):
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">36</span>, <span class="keyword">in</span> 


    main()
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">33</span>, <span class="keyword">in</span> main
    print a.extract(<span class="keyword">key</span>)
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">24</span>, <span class="keyword">in</span> extract
    raise Exception, &amp;apos;<span class="keyword">ERROR</span>: <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!&amp;apos;
Exception: <span class="keyword">ERROR</span>: <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!
</code></pre><p>&#x5F53;&#x811A;&#x672C;&#x540E;&#x9762;&#x4E0D;&#x8DDF;key&#x65F6;&#x63D0;&#x793A;error&#xFF0C;&#x5F53;&#x811A;&#x672C;&#x540E;&#x9762;&#x8DDF;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x7684;key&#x65F6;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;</p>
<p>2&#x3001;redis&#x811A;&#x672C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> Python</p>
<pre><code><span class="comment"># cat get_redis_status.py </span>
<span class="comment">#!/usr/bin/env python</span>
<span class="comment">#coding=utf8</span>
<span class="keyword">import</span> sys
<span class="keyword">import</span> os
<span class="class"><span class="keyword">class</span> <span class="title">GetRedisStatus</span><span class="params">()</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>
        self.val = {}
    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span>
        <span class="keyword">try</span>:
            <span class="keyword">import</span> redis
            self.redis = redis.Redis(&amp;apos;<span class="number">127.0</span>.0.1&amp;apos;, port=<span class="number">6379</span>, password=<span class="keyword">None</span>)
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;Plugin needs the redis module&amp;apos;
    <span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(self, key)</span>:</span>
        info = self.redis.info()
        <span class="keyword">try</span>:
            <span class="keyword">if</span> key <span class="keyword">in</span> info:
                self.val[key] = info[key]
            <span class="keyword">return</span> self.val[key]
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;ERROR info <span class="keyword">not</span> include this key!&amp;apos;
<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:
        <span class="keyword">print</span> &amp;quot;ERROR! Please enter a key&amp;quot;
    <span class="keyword">elif</span> len(sys.argv) == <span class="number">2</span>:
        key = sys.argv[<span class="number">1</span>]
        a = GetRedisStatus()
        a.check()
        <span class="keyword">print</span> a.extract(key)
<span class="keyword">if</span> __name__ == &amp;quot;__main__&amp;quot;:
    main()
</code></pre><p>&#x6267;&#x884C;:</p>
<p> Shell</p>
<pre><code>[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># python get_redis_status.py </span>
ERROR! Please enter a key
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py db11 </span>
Traceback (most recent call last):
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">40</span>, <span class="keyword">in</span> 


    main()
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">37</span>, <span class="keyword">in</span> main
    <span class="built_in">print</span> a.extract(key)
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">27</span>, <span class="keyword">in</span> extract
    raise Exception, &amp;apos;ERROR info <span class="keyword">not</span> include <span class="keyword">this</span> key!&amp;apos;
<span class="attribute">Exception</span>: ERROR info <span class="keyword">not</span> include <span class="keyword">this</span> key!
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_memory</span>
<span class="number">844384</span>
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_cpu_sys</span>
<span class="number">5422.29</span>
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_memory_human</span>
<span class="number">824.59</span>K
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Python/">Python</a><a href="/tags/zabbix/">zabbix</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/271dd50/" title="Memcached使用手册 -" itemprop="url">Memcached使用手册 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="memcached&#x7B80;&#x4ECB;">memcached&#x7B80;&#x4ECB;</h2><p>1 <strong>&#x3001;**</strong>memcached<strong> &#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x7EDF;&#xFFFD;&#xFFFD;&#xFFFD;&#x7684;&#x5DE8;&#x5927;&#x7684; </strong>hash** &#x8868;&#xFF0C;&#x5B83;&#x80FD;&#x591F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x5404;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5305;&#x62EC;&#x56FE;&#x50CF;&#x3001;&#x89C6;&#x9891;&#x3001;&#x6587;&#x4EF6;&#x4EE5;&#x53CA;&#x6570;&#x636E;&#x5E93;&#x68C0;&#x7D22;&#x7684;&#x7ED3;&#x679C;&#x7B49;&#x3002;</p>
<p>2 &#x3001;&#x5B83;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x548C;&#x5BF9;&#x8C61;&#x6765;&#x51CF;&#x5C11;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x52A8;&#x6001;&#x3001;&#x6570;&#x636E;&#x5E93;&#x9A71;&#x52A8;&#x7F51;&#x7AD9;&#x7684;&#x901F;&#x5EA6;&#x3002; <strong>3**</strong>&#x3001;<strong><strong>Memcached</strong></strong>&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;<strong><strong>/</strong></strong>&#x503C;&#x5BF9;&#x7684;<strong><strong>hashmap</strong></strong>&#x3002;<strong><strong>4</strong></strong>&#x3001;&#x5176;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF08;<strong><strong>daemon</strong></strong>&#xFF09;&#x662F;&#x7528;<strong><strong>C</strong></strong>&#x5199;&#x7684;&#xFF0C;<strong><strong>5</strong></strong>&#x3001;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x7528;&#x4EFB;&#x4F55;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;<strong><strong>memcached</strong></strong>&#x534F;&#x8BAE;&#x4E0E;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x3002;**</p>
<h2 id="memcached&#x5B89;&#x88C5;&#x8BF4;&#x660E;">memcached&#x5B89;&#x88C5;&#x8BF4;&#x660E;</h2><p>1 <strong>&#x3001;windows&#x5B89;&#x88C5;&#xFF1A;&#x53C2;&#x7167;</strong> <a href="http://www.cnblogs.com/wucg/archive/2011/03/01/1968185.html" target="_blank" rel="external">http://www.cnblogs.com/wucg/archive/2011/03/01/1968185.html</a></p>
<p>2 &#x3001;liunx&#x5B89;&#x88C5;&#xFF1A;&#x53C2;&#x7167;<a href="http://chenzhou123520.iteye.com/blog/1933489" target="_blank" rel="external">http://chenzhou123520.iteye.com/blog/1933489</a></p>
<h2 id="memcached&#x4F7F;&#x7528;&#x65B9;&#x6CD5;">memcached&#x4F7F;&#x7528;&#x65B9;&#x6CD5;</h2><p>1&#x3001;&#xA0; &#x5B89;&#x88C5;&#x5B8C;memcached&#x540E;&#xFF0C;&#x5982;&#x4F55;&#x8FDE;&#x63A5;memached&#x5462;&#xFF1F;</p>
<p>&#x4F7F;&#x7528;telnet&#x547D;&#x4EE4;&#x8FDE;&#x63A5;memcached&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5728;windows&#x4E0B;&#x6709;&#x53EF;&#x80FD;&#x63D0;&#x793A;telnet&#x547D;&#x4EE4;&#x65E0;&#x6548;&#xFF0C;&#x662F;&#x7531;&#x4E8E;telnet&#x5BA2;&#x6237;&#x7AEF;&#x6CA1;&#x6709;&#x5B89;&#x88C5;&#xFF0C;&#x5B89;&#x88C5;&#x65B9;&#x6CD5;&#x53C2;&#x89C1;&#xFF08; <a href="http://jingyan.baidu.com/article/925f8cb839ca6bc0dce05666.html" target="_blank" rel="external">http://jingyan.baidu.com/article/925f8cb839ca6bc0dce05666.html</a> &#xFF09;&#x3002; </p>
<p>telnet&#x8FDE;&#x63A5;memcached&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/271bb22.jpg" alt=""></p>
<p>&#x5F00;&#x59CB;&#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x663E;&#x793A;&#xFF0C;&#x56DE;&#x8F66;&#x540E;&#x8F93;&#x5165;&#x547D;&#x4EE4; stats &#x67E5;&#x770B;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF0C;&#x8BF4;&#x660E;&#x670D;&#x52A1;&#x5668;&#x8FD0;&#x4F5C;&#x6B63;&#x5E38;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c004.jpg" alt=""></p>
<p>&#x770B;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x4FE1;&#x606F;&#x8868;&#x793A;memcached&#x5B89;&#x88C5;&#x8FD0;&#x884C;&#x6B63;&#x5E38;&#xFF0C;&#x4F7F;&#x7528;telnet&#x8FDE;&#x63A5;memcached&#x6210;&#x529F;&#x3002;</p>
<h2 id="&#x5E38;&#x7528;memcached&#x547D;&#x4EE4;&#x8BE6;&#x89E3;">&#x5E38;&#x7528;memcached&#x547D;&#x4EE4;&#x8BE6;&#x89E3;</h2><p>Memcached&#x4F5C;&#x4E3A;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5BF9;&#x5176;&#x64CD;&#x4F5C;&#x7684;&#x547D;&#x4EE4;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x4E09;&#x7C7B;&#xFF1A;</p>
<p>1&#x3001;&#xA0; &#x670D;&#x52A1;&#x5668;&#x72B6;&#x6001;&#x547D;&#x4EE4;&#xFF1A;&#x53EF;&#x4EE5;&#x67E5;&#x770B;memcahced&#x670D;&#x52A1;&#x7684;&#x5F53;&#x524D;&#x72B6;&#x6001;</p>
<p>2&#x3001;&#xA0; &#x6570;&#x636E;&#x5B58;&#x50A8;&#x547D;&#x4EE4;&#xFF1A;&#x5982;&#x4F55;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x5230;memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;</p>
<p>3&#x3001;&#xA0; &#x6570;&#x636E;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;&#xFF1A;&#x83B7;&#x53D6;memacahed&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x7684;&#x6570;&#x636E;</p>
<p>4&#x3001;&#xA0; &#x6570;&#x636E;&#x5220;&#x9664;&#x547D;&#x4EE4;&#xFF1A;&#x5220;&#x9664;memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x7684;&#x6570;&#x636E;</p>
<p>&#x4E00;&#x3001;&#x670D;&#x52A1;&#x5668;&#x72B6;&#x6001;&#x547D;&#x4EE4;</p>
<p>1&#x3001;stats&#xFF1A; memcached &#x5B9E;&#x4F8B;&#x7684;&#x5F53;&#x524D;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#x3002; </p>
<p>STAT pid 22459&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8FDB;&#x7A0B;ID</p>
<p>STAT uptime 1027046&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x8FD0;&#x884C;&#x79D2;&#x6570;&#xA0;</p>
<p>STAT time 1273043062&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x5F53;&#x524D;unix&#x65F6;&#x95F4;&#x6233;&#xA0;</p>
<p>STAT version 1.4.4&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x7248;&#x672C;&#xA0;</p>
<p>STAT pointer_size 64&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5B57;&#x5927;&#x5C0F;(&#x8FD9;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x662F;64&#x4F4D;&#x7684;)&#xA0;</p>
<p>STAT rusage_user 0.040000&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8FDB;&#x7A0B;&#x7D2F;&#x8BA1;&#x7528;&#x6237;&#x65F6;&#x95F4;&#xA0;</p>
<p>STAT rusage_system 0.260000&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8FDB;&#x7A0B;&#x7D2F;&#x8BA1;&#x7CFB;&#x7EDF;&#x65F6;&#x95F4;&#xA0;</p>
<p>STAT curr_connections 10&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5F53;&#x524D;&#x6253;&#x5F00;&#x8FDE;&#x63A5;&#x6570;&#xA0;</p>
<p>STAT total_connections 82&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x66FE;&#x6253;&#x5F00;&#x7684;&#x8FDE;&#x63A5;&#x603B;&#x6570;&#xA0;</p>
<p>STAT connection_structures 13&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x5206;&#x914D;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;&#x6570;&#xA0;</p>
<p>STAT cmd_get 54&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x6267;&#x884C;get&#x547D;&#x4EE4;&#x603B;&#x6570;&#xA0;</p>
<p>STAT cmd_set 34&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x6267;&#x884C;set&#x547D;&#x4EE4;&#x603B;&#x6570;&#xA0;</p>
<p>STAT cmd_flush 3&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x6307;&#x5411;flush_all&#x547D;&#x4EE4;&#x603B;&#x6570;&#xA0;</p>
<p>STAT get_hits 9&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT get_misses 45&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT delete_misses 5&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; delete&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT delete_hits 1&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; delete&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT incr_misses 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; incr&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT incr_hits 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; incr&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT decr_misses 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; decr&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT decr_hits 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; decr&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT cas_misses 0&#xA0;&#xA0;&#xA0; cas&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT cas_hits 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cas&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT cas_badval 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x4F7F;&#x7528;&#x64E6;&#x62ED;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT auth_cmds 0&#xA0;</p>
<p>STAT auth_errors 0&#xA0;</p>
<p>STAT bytes_read 15785&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8BFB;&#x53D6;&#x5B57;&#x8282;&#x603B;&#x6570;&#xA0;</p>
<p>STAT bytes_written 15222&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5199;&#x5165;&#x5B57;&#x8282;&#x603B;&#x6570;&#xA0;</p>
<p>STAT limit_maxbytes 1048576&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x6570;&#xFF08;&#x5B57;&#x8282;&#xFF09;&#xA0;</p>
<p>STAT accepting_conns 1&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x76EE;&#x524D;&#x63A5;&#x53D7;&#x7684;&#x94FE;&#x63A5;&#x6570;&#xA0;</p>
<p>STAT listen_disabled_num 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</p>
<p>STAT threads 4&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x7EBF;&#x7A0B;&#x6570;&#xA0;</p>
<p>STAT conn_yields 0&#xA0;</p>
<p>STAT bytes 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5B58;&#x50A8;item&#x5B57;&#x8282;&#x6570;&#xA0;</p>
<p>STAT curr_items 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; item&#x4E2A;&#x6570;&#xA0;</p>
<p>STAT total_items 34&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; item&#x603B;&#x6570;&#xA0;</p>
<p>STAT evictions 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x4E3A;&#x83B7;&#x53D6;&#x7A7A;&#x95F4;&#x5220;&#x9664;item&#x7684;&#x603B;&#x6570;</p>
<p>&#x4E8C;&#x3001;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x547D;&#x4EE4;</p>
<p>1&#x3001;&#xA0; set &#x547D;&#x4EE4;</p>
<p>set&#x7684;&#x547D;&#x4EE4;&#x5728;memcached&#x4E2D;&#x7684;&#x4F7F;&#x7528;&#x9891;&#x7387;&#x6781;&#x9AD8;&#x3002;set&#x547D;&#x4EE4;&#x4E0D;&#x4F46;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x6DFB;&#x52A0;&#xFF0C;&#x5982;&#x679C;set&#x7684;key&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x8BE5;&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x66F4;&#x65B0;&#x8BE5;key&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x539F;&#x6765;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#xFFFD;&#xFFFD;&#xFFFD;&#x73B0;&#x66F4;&#x65B0;&#x7684;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x5B9E;&#x4F8B;&#xFF1A;set username&#xA0; 0&#xA0; 0&#xA0; 8&#x3002;</p>
<p>&#x6CE8;&#x610F;&#x4E00;&#x70B9;&#x5C31;&#x662F;&#xFF1A;&#x5982;&#x679C;&#x8BBE;&#x5B9A;&#x5B58;&#x50A8;&#x5B57;&#x8282;&#x6570;&#x4E3A;8&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x8F93;&#x5165;&#x7684;&#x5B58;&#x5728;&#x5185;&#x5BB9;&#x65F6;&#xFF0C;&#x5185;&#x5BB9;&#x5927;&#x5C0F;&#x5FC5;&#x987B;&#x662F;8&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5426;&#x5219;&#x5B58;&#x50A8;&#x4E0D;&#x6210;&#x529F;&#x3002;</p>
<p>2&#x3001;&#xA0; &#xA0;add &#x547D;&#x4EE4;</p>
<p>add&#x547D;&#x4EE4;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E0E;set&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#xFF0C;&#x533A;&#x522B;&#x662F;&#x53EA;&#x6709;&#x6570;&#x636E;&#x4E0D;&#x5B58;&#x5728;&#x65F6;&#x8FDB;&#x884C;&#x6DFB;&#x52A0;&#x7684;add&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x4E00;&#x4E2A;key&#x4E3A;username&#x7684;&#x6570;&#x636E;&#xFF0C;add&#x4E0D;&#x6210;&#x529F;&#x3002;</p>
<p>3&#x3001;&#xA0; replace &#x547D;&#x4EE4;</p>
<p>replace&#x547D;&#x4EE4;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E0E;set&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#xFF0C;&#x533A;&#x522B;&#x662F;&#x53EA;&#x6709;&#x6570;&#x636E;&#x5B58;&#x5728;&#x65F6;&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x66F4;&#x65B0;&#xFF0C;&#x5982;&#x679C;replace&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;key&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5219;replace&#x4E0D;&#x6210;&#x529F;&#x3002;&#x4E0E;add&#x547D;&#x4EE4;&#x76F8;&#x53CD;&#x3002;</p>
<p>&#x4E09;&#x3001;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;</p>
<p>1&#x3001;&#xA0; get&#x547D;&#x4EE4;</p>
<p>get&#x7A7A;&#x683C;key &#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x6307;&#x5B9A;key&#x7684;&#x6570;&#x636E;&#x3002;&#x591A;&#x4E2A;key&#x53EF;&#x4EE5;&#x7528;&#x7A7A;&#x683C;&#x9694;&#x5F00;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c004.jpg" alt=""></p>
<p>2&#x3001;&#xA0; gets&#x547D;&#x4EE4;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c275.jpg" alt=""></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;gets&#x547D;&#x4EE4;&#x6BD4;&#x666E;&#x901A;&#x7684;get&#x547D;&#x4EE4;&#x591A;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6570;&#x5B57;&#xFF08;&#x4E0A;&#x56FE;&#x4E2D;&#x4E3A;13&#xFF09;&#x3002;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x53EF;&#x4EE5;&#x68C0;&#x67E5;&#x6570;&#x636E;&#x662F;&#x5426;&#x53D1;&#x751F;&#x6539;&#x53D8;&#x3002;&#x5F53;key&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x6539;&#x53D8;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x591A;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x5B57;&#x4E5F;&#x4F1A;&#x6539;&#x53D8;&#x3002;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x7C7B;&#x4F3C;&#x4E8E;svn&#x4E2D;&#x7684;&#x7248;&#x672C;&#x53F7;&#x3002;</p>
<p>&#x56DB;&#x3001;&#x6570;&#x636E;&#x5220;&#x9664;&#x547D;&#x4EE4;</p>
<p>1&#x3001;&#xA0; delete&#x547D;&#x4EE4;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c275.jpg" alt=""></p>
<p>&#x5220;&#x9664;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x952E;&#x503C;&#x548C;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x8BB0;&#x5F55;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7684;&#x7ED3;&#x679C;&#x3002;</p>
<h2 id="java&#x64CD;&#x4F5C;memcached&#x5DE5;&#x5177;&#x4ECB;&#x7ECD;">java&#x64CD;&#x4F5C;memcached&#x5DE5;&#x5177;&#x4ECB;&#x7ECD;</h2><p>java&#x5BA2;&#x6237;&#x7AEF;&#x64CD;&#x4F5C;memcached&#x670D;&#x52A1;&#x5668;&#x7684;&#x5E38;&#x7528;&#x5DE5;&#x5177;&#x6709;&#xFF1A;memcached client for java &#x548C;spymemcached&#x3002;&#x6BD4;&#x8F83;&#x5E38;&#x7528;&#x7684;&#x5C31;&#x662F;memcached client for java&#x3002;&#x76EE;&#x524D;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x662F;memcached client for java&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/26f6ec1/" title="Redis、Memcached、Guava、Ehcache中的算法 -" itemprop="url">Redis、Memcached、Guava、Ehcache中的算法 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x7F13;&#x5B58;&#x90A3;&#x4E9B;&#x4E8B;&#xFF0C;&#x4E00;&#x662F;&#x5185;&#x5B58;&#x7206;&#x4E86;&#x8981;&#x7528;LRU(&#x6700;&#x8FD1;&#x6700;&#x5C11;&#x4F7F;&#x7528;)&#x3001;LFU(&#x6700;&#x5C11;&#x8BBF;&#x95EE;&#x6B21;&#x6570;)&#x3001;FIFO&#x7684;&#x7B97;&#x6CD5;&#x6E05;&#x7406;&#x4E00;&#x4E9B;&#xFF1B;&#x4E8C;&#x662F;&#x8BBE;&#x7F6E;&#x4E86;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x7684;&#x952E;&#x8FC7;&#x671F;&#x4FBF;&#x8981;&#x5220;&#x9664;&#xFF0C;&#x7528;&#x4E3B;&#x52A8;&#x6216;&#x60F0;&#x6027;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<h3 id="1-_LRU">1. LRU</h3><h4 id="&#x7B80;&#x5355;&#x7C97;&#x66B4;&#x7684;Redis">&#x7B80;&#x5355;&#x7C97;&#x66B4;&#x7684;Redis</h4><p>&#x4ECA;&#x5929;&#x770B; <a href="https://raw.githubusercontent.com/antirez/redis/3.0/00-RELEASENOTES" target="_blank" rel="external">Redis3.0&#x7684;&#x53D1;&#x884C;&#x901A;&#x544A;</a> &#x91CC;&#x8BF4;&#xFF0C;LRU&#x7B97;&#x6CD5;&#x5927;&#x5E45;&#x63D0;&#x5347;&#x4E86;&#xFF0C;&#x5C31;&#x7FFB;&#x5F00;&#x6E90;&#x7801;&#x6765;&#x516B;&#x5366;&#x4E00;&#x4E0B;&#xFF0C;&#x7ED3;&#x679C;&#x54ED;&#x7B11;&#x4E0D;&#x5F97;&#xFF0C;&#x8FD9;&#x65E7;&#x7248;&#x7684;&quot;&#x8FD1;&#x4F3C;LRU&quot;&#x7B97;&#x6CD5;&#xFF0C;&#x5B9E;&#x5728;&#x592A;&#x7B80;&#x5355;&#xFF0C;&#x592A;&#x5077;&#x61D2;&#xFF0C;&#x592A;Redis&#x4E86;&#x3002; </p>
<p>&#x5728; <a href="https://github.com/antirez/redis" target="_blank" rel="external">Github&#x7684;Redis&#x9879;&#x76EE;</a> &#x91CC;&#x641C;&#x7D22;lru&#xFF0C;&#x627E;&#x5230;&#x4EE3;&#x7801;&#x5728;redis.c&#x7684;freeMemoryIfNeeded()&#x51FD;&#x6570;&#x91CC;&#x3002; </p>
<p>&#x5148;&#x770B; <a href="https://github.com/huangz1990/annotated_redis_source/blob/unstable/src/redis.c#L2717" target="_blank" rel="external">2.6&#x7248;&#x7684;&#x4EE3;&#x7801;</a> &#xFF1A; &#x7ADF;&#x7136;&#x5C31;&#x662F;&#x968F;&#x673A;&#x627E;&#x4E09;&#x6761;&#x8BB0;&#x5F55;&#x51FA;&#x6765;&#xFF0C;&#x6BD4;&#x8F83;&#x54EA;&#x6761;&#x7A7A;&#x95F2;&#x65F6;&#x95F4;&#x6700;&#x957F;&#x5C31;&#x5220;&#x54EA;&#x6761;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x968F;&#x673A;&#x4E09;&#x6761;&#x51FA;&#x6765;&#xFF0C;&#x4E00;&#x76F4;&#x5220;&#x5230;&#x5185;&#x5B58;&#x8DB3;&#x591F;&#x653E;&#x4E0B;&#x65B0;&#x8BB0;&#x5F55;&#x4E3A;&#x6B62;…….&#x53EF;&#x601C;&#x6211;&#x770B; <a href="https://github.com/antirez/redis/blob/unstable/redis.conf#L481" target="_blank" rel="external">&#x914D;&#x7F6E;&#x6587;&#x6863;</a> &#x540E;&#x7684;&#x60F3;&#x8C61;&#xFF0C;&#x4E00;&#x76F4;&#x4EE5;&#x4E3A;&#x5B83;&#x4F1A;&#x5E2E;&#x6211;&#xFFFD;&#xFFFD;&#xFFFD;&#x6574;&#x4E2A;Redis&#x91CC;&#x627E;&#x7A7A;&#x95F2;&#x65F6;&#x95F4;&#x6700;&#x957F;&#x7684;&#xFF0C;&#x54EA;&#x60F3;&#x5230;&#x6211;&#x6709;&#x4E00;&#x767E;&#x4E07;&#x6761;&#x8BB0;&#x5F55;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x968F;&#x4FBF;&#x627E;&#x4E09;&#x6761;&#x5C31;&#x5F00;&#x59CB;&#x5220;&#x4E86;&#x3002; </p>
<p>&#x597D;&#xFF0C;&#x6536;&#x62FE;&#x5FC3;&#x60C5;&#x518D;&#x770B; <a href="https://github.com/huangz1990/redis-3.0-annotated/blob/unstable/src/redis.c#L3447" target="_blank" rel="external">3.0&#x7248;&#x7684;&#x6539;&#x8FDB;</a> &#xFF1A;&#x73B0;&#x5728;&#x6BCF;&#x6B21;&#x968F;&#x673A;&#x4E94;&#x6761;&#x8BB0;&#x5F55;&#x51FA;&#x6765;&#xFF0C;&#x63D2;&#x5165;&#x5230;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x4E3A;&#x5341;&#x516D;&#x7684;&#x6309;&#x7A7A;&#x95F2;&#x65F6;&#x95F4;&#x6392;&#x5E8F;&#x7684;&#x961F;&#x5217;&#x91CC;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x6392;&#x5934;&#x7684;&#x90A3;&#x6761;&#x5220;&#x6389;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x627E;&#x4E94;&#x6761;&#x51FA;&#x6765;&#xFF0C;&#x7EE7;&#x7EED;&#x5C1D;&#x8BD5;&#x63D2;&#x5165;&#x961F;&#x5217;………&#x55EF;&#xFF0C;&#x597D;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5427;&#xFF0C;&#x8D77;&#x7801;&#x6BCF;&#x6B21;&#x968F;&#x673A;&#x591A;&#x4E86;&#x4E24;&#x6761;&#xFF0C;&#x8D77;&#x7801;&#x4E0D;&#x53EA;&#x5728;&#x4E00;&#x6B21;&#x968F;&#x673A;&#x7684;&#x4E94;&#x6761;&#x91CC;&#x9762;&#x627E;&#x6700;&#x4E45;&#x90A3;&#x6761;&#xFF0C;&#x4F1A;&#x8FDE;&#x540C;&#x4E4B;&#x524D;&#x7684;&#x4E00;&#x8D77;&#x505A;&#x6BD4;&#x8F83;…… </p>
<h4 id="&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Memcached">&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Memcached</h4><p>&#x76F8;&#x6BD4;&#x4E4B;&#x4E0B;&#xFF0C;Memcached&#x5B9E;&#x73B0;&#x7684;&#x662F;&#x518D;&#x6807;&#x51C6;&#x4E0D;&#x8FC7;&#x7684;LRU&#x7B97;&#x6CD5;&#xFF0C;&#x4E13;&#x95E8;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;&#x6559;&#x79D1;&#x4E66;&#x5F0F;&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x6765;&#x5B58;&#x50A8;slab&#x5185;&#x7684;LRU&#x5173;&#x7CFB;&#xFF0C;&#x4EE3;&#x7801;&#x5728; <a href="https://github.com/memcached/memcached/blob/c5530027c8ea28674358327ab8212ebaf014c848/items.c" target="_blank" rel="external">item.c</a> &#x91CC;&#xFF0C;&#x8BE6;&#x89C1; <a href="http://blog.csdn.net/luotuo44/article/details/42869325" target="_blank" rel="external">memcached&#x6E90;&#x7801;&#x5206;&#x6790;——-LRU&#x961F;&#x5217;&#x4E0E;item&#x7ED3;&#x6784;&#x4F53;</a> &#xFF0C;&#x5143;&#x7D20;&#x63D2;&#x5165;&#x65F6;&#x628A;&#x81EA;&#x5DF1;&#x653E;&#x5230;&#x5217;&#x5934;&#xFF0C;&#x5220;&#x9664;&#x65F6;&#x628A;&#x81EA;&#x5DF1;&#x7684;&#x524D;&#x540E;&#x4E24;&#x4E2A;&#x5143;&#x7D20;&#x5BF9;&#x63A5;&#x8D77;&#x6765;&#xFF0C;&#x66F4;&#x65B0;&#x65F6;&#x5148;&#x505A;&#x5220;&#x9664;&#x518D;&#x505A;&#x63D2;&#x5165;&#x3002; </p>
<p>&#x5206;&#x914D;&#x5185;&#x5B58;&#x8D85;&#x9650;&#x65F6;&#xFF0C;&#x5F88;&#x81EA;&#x7136;&#x5C31;&#x4F1A;&#x4ECE;LRU&#x7684;&#x961F;&#x5C3E;&#x5F00;&#x59CB;&#x6E05;&#x7406;&#x3002;</p>
<h4 id="&#x540C;&#x6837;&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Guava_Cache">&#x540C;&#x6837;&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Guava Cache</h4><p>Guava Cache&#x540C;&#x6837;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x7684;Queue&#xFF0C;&#x89C1; <a href="https://github.com/google/guava/blob/56456cb58c0cb71d7c0f05047e13718ad202b748/guava/src/com/google/common/cache/LocalCache.java#L3743" target="_blank" rel="external">LocalCache&#x4E2D;&#x7684;AccessQueue</a> &#x7C7B;&#xFF0C;&#x4E5F;&#x4F1A;&#x5728;&#x8D85;&#x9650;&#x65F6;&#x4ECE;Queue&#x7684;&#x961F;&#x5C3E;&#x6E05;&#x7406;&#xFF0C;&#x89C1; <a href="https://github.com/google/guava/blob/56456cb58c0cb71d7c0f05047e13718ad202b748/guava/src/com/google/common/cache/LocalCache.java#L2663" target="_blank" rel="external">evictEntries()&#x51FD;&#x6570;</a> &#x3002; </p>
<h4 id="&#x548C;Redis&#x65E7;&#x7248;&#x4E00;&#x6837;&#x7684;Ehcache/Hazelcast">&#x548C;Redis&#x65E7;&#x7248;&#x4E00;&#x6837;&#x7684;Ehcache/Hazelcast</h4><p>&#x770B; <a href="http://ehcache.org/documentation/2.8/apis/cache-eviction-algorithms#least-recently-used-lru" target="_blank" rel="external">&#x6587;&#x6863;</a> &#xFF0C;&#x5C45;&#x7136;&#x548C;Redis2.6&#x4E00;&#x6837;&#xFF0C;&#x76F4;&#x63A5;&#x968F;&#x673A;8&#x6761;&#x8BB0;&#x5F55;&#xFF0C;&#x627E;&#x51FA;&#x6700;&#x65E7;&#x90A3;&#x6761;&#xFF0C;&#x5237;&#x5230;&#x78C1;&#x76D8;&#x91CC;&#xFF0C;&#x518D;&#x770B;&#x4EE3;&#x7801;&#xFF0C; <a href="https://github.com/ehcache/ehcache3/blob/16a12914afcfc89f2cb8a3c069fd295074f81ee5/api/src/main/java/org/ehcache/config/Eviction.java#L66" target="_blank" rel="external">Eviction&#x7C7B;</a> &#x548C; <a href="https://github.com/ehcache/ehcache3/blob/5a3884871eadaf6a3e23908e1497ba0b591cbfa9/impl/src/main/java/org/ehcache/internal/store/heap/OnHeapStore.java#L892" target="_blank" rel="external">OnHeapStore&#x7684;evict()&#x51FD;&#x6570;</a> &#x3002; </p>
<p>&#x518D;&#x770B;Hazelcast&#xFF0C;&#x51E0;&#x4E4E;&#x4E00;&#x6837;&#xFF0C;&#x968F;&#x673A;&#x53D6;25&#x6761;&#x3002; &#x8FD9;&#x79CD;&#x7B97;&#x6CD5;&#xFF0C;&#x5207;&#x6362;&#x5230;LFU&#x4E5F;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x3002;</p>
<h4 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h4><p>&#x4E0D;&#x8FC7;&#x540E;&#x6765;&#x518D;&#x60F3;&#x60F3;&#xFF0C;&#x4E5F;&#x8BB8;Redis&#x672C;&#x6765;&#x5C31;&#x4E0D;&#x662F;&#x4E3B;&#x6253;&#x505A;Cache&#x7684;&#xFF0C;&#x8FD9;&#x79CD;&#x5185;&#x5B58;&#x7206;&#x4E86;&#x9700;&#x8981;&#x901A;&#x8FC7;LRU&#x5220;&#x6389;&#x4E00;&#x4E9B;&#x5143;&#x7D20;&#x4E0D;&#x662F;&#x5B83;&#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#xFF0C;&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x90FD;&#x662F;noeviction&#x2014;&#x2014;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x76F4;&#x63A5;&#x62A5;&#x9519;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x61D2;&#x5F97;&#x5EFA;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#xFF0C;&#x800C;&#x4E14;&#x6BCF;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x90FD;&#x8981;&#x66F4;&#x65B0;&#x5B83;&#x4E86;&#xFF0C;&#x770B;Google Group&#x91CC;&#x957F;&#x957F;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x65B0;&#x7248;&#x7B97;&#x6CD5;&#x4E5F;&#x662F;&#x793E;&#x533A;&#x667A;&#x6167;&#x7684;&#x7ED3;&#x6676;&#x3002;&#x4F55;&#x51B5;&#xFF0C;Ehcache&#x548C;Hazelcast&#x4E5F;&#x662F;&#x548C;&#x5B83;&#x7684;&#x65E7;&#x7248;&#x4E00;&#x6837;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;Redis&#x7684;&#x65B0;&#x7248;&#x8FD8;&#x6BD4;&#x8FD9;&#x4E24;&#x8005;&#x5F3A;&#x4E86;&#x3002;</p>
<p>&#x540E;&#x6765;&#xFF0C;&#x6839;&#x636E;@&#x5218;&#x5C11;&#x58EE;&#x540C;&#x5B66;&#x7684;&#x63D0;&#x793A;&#xFF0C;JBoss&#x7684;InfiniSpan&#x91CC;&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;&#x6BD4;LRU&#x66F4;&#x9AD8;&#x7EA7;&#x7684; <a href="http://www.thinkingyu.com/articles/LIRS/" target="_blank" rel="external">LIRS&#x7B97;&#x6CD5;</a> &#xFF0C;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x4E00;&#x4E9B;&#x51B7;&#x6570;&#x636E;&#x56E0;&#x4E3A;&#x67D0;&#x4E2A;&#x539F;&#x56E0;&#x88AB;&#x5927;&#x91CF;&#x8BBF;&#x95EE;&#x540E;&#xFF0C;&#x628A;&#x70ED;&#x6570;&#x636E;&#x6324;&#x5360;&#x6389;&#x3002; </p>
<h3 id="2-_&#x8FC7;&#x671F;&#x952E;&#x5220;&#x9664;">2. &#x8FC7;&#x671F;&#x952E;&#x5220;&#x9664;</h3><p>&#x5982;&#x679C;&#x80FD;&#x4E3A;&#x6BCF;&#x4E00;&#x4E2A;&#x8BBE;&#x7F6E;&#x4E86;&#x8FC7;&#x671F;&#x7684;&#x5143;&#x7D20;&#x542F;&#x52A8;&#x4E00;&#x4E2A;Timer&#xFF0C;&#x4E00;&#x5230;&#x65F6;&#x95F4;&#x5C31;&#x89E6;&#x53D1;&#x628A;&#x5B83;&#x5220;&#x6389;&#xFF0C;&#x90A3;&#x65E0;&#x7591;&#x662F;&#x80FD;&#x6700;&#x5FEB;&#x5220;&#x9664;&#x8FC7;&#x671F;&#x952E;&#x6700;&#x7701;&#x7A7A;&#x95F4;&#x7684;&#xFF0C;&#x5728;Java&#x91CC;&#x7528;&#x4E00;&#x6761; <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/DelayQueue.html" target="_blank" rel="external">DeplayQueue</a> &#x5B58;&#x7740;&#xFF0C;&#x5F00;&#x6761;&#x7EBF;&#x7A0B;&#x4E0D;&#x65AD;&#x7684;&#x8BFB;&#x53D6;&#x5C31;&#x80FD;&#x505A;&#x5230;&#x3002;&#x4F46;&#x56E0;&#x4E3A;&#x8BE5;&#x7EBF;&#x7A0B;&#x6D88;&#x8017;CPU&#x8F83;&#x591A;&#xFF0C;&#x5728;&#x5185;&#x5B58;&#x4E0D;&#x7D27;&#x5F20;&#x65F6;&#x6709;&#x70B9;&#x6D6A;&#x8D39;&#xFF0C;&#x4F3C;&#x4E4E;&#x5927;&#x5BB6;&#x90FD;&#x4E0D;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002; </p>
<p>&#x6240;&#x4EE5;&#x6709;&#x4E86;&#x60F0;&#x6027;&#x68C0;&#x67E5;&#xFF0C;&#x5C31;&#x662F;&#x6BCF;&#x6B21;&#x5143;&#x7D20;&#x88AB;&#x8BBF;&#x95EE;&#x65F6;&#xFF0C;&#x624D;&#x53BB;&#x68C0;&#x67E5;&#x5B83;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8D85;&#x65F6;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x5404;&#x5BB6;&#x90FD;&#x4E00;&#x6837;&#x3002;&#x4F46;&#x5982;&#x679C;&#x90A3;&#x4E2A;&#x5143;&#x7D20;&#x540E;&#x6765;&#x90FD;&#x6CA1;&#x518D;&#x88AB;&#x8BBF;&#x95EE;&#x5462;&#xFF0C;&#x4F1A;&#x6C38;&#x8FDC;&#x5360;&#x7740;&#x4F4D;&#x5B50;&#x5417;&#xFF1F;&#x6240;&#x4EE5;&#x5404;&#x5BB6;&#x90FD;&#x518D;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x5B9A;&#x671F;&#x4E3B;&#x52A8;&#x5220;&#x9664;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<h4 id="Redis">Redis</h4><p>&#x4EE3;&#x7801;&#x5728; <a href="https://github.com/huangz1990/redis-3.0-annotated/blob/unstable/src/redis.c#L857" target="_blank" rel="external">redis.c&#x7684;activeExpireCycle()</a> &#x91CC;&#xFF0C;&#x770B;&#x8FC7;&#x6587;&#x6863;&#x7684;&#x4EBA;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x5B83;&#x4F1A;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x91CC;&#xFF0C;&#x6BCF;100&#x6BEB;&#x79D2;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x6BCF;&#x6B21;&#x968F;&#x673A;&#x62BD;20&#x6761;Key&#x68C0;&#x67E5;&#xFF0C;&#x5982;&#x679C;&#x6709;1/4&#x7684;&#x952E;&#x8FC7;&#x671F;&#x4E86;&#xFF0C;&#x8BC1;&#x660E;&#x6B64;&#x65F6;&#x8FC7;&#x671F;&#x7684;&#x952E;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x5C31;&#x4E0D;&#x7B49;100&#x6BEB;&#x79D2;&#xFF0C;&#x7ACB;&#x523B;&#x5F00;&#x59CB;&#x4E0B;&#x4E00;&#x8F6E;&#x7684;&#x68C0;&#x67E5;&#x3002;&#x4E0D;&#x8FC7;&#x4E3A;&#x514D;&#x628A;CPU&#x65F6;&#x95F4;&#x90FD;&#x5360;&#x4E86;&#xFF0C;&#x53C8;&#x9650;&#x5B9A;&#x6BCF;&#x8F6E;&#x7684;&#x603B;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x4E0D;&#x8D85;&#x8FC7;1&#x6BEB;&#x79D2;&#x3002; </p>
<h4 id="Memcached">Memcached</h4><p>Memcached&#x91CC;&#x6709;&#x4E2A;&#x6587;&#x4E0D;&#x5BF9;&#x9898;&#x7684; <a href="http://blog.csdn.net/luotuo44/article/details/42963793" target="_blank" rel="external">LRU&#x722C;&#x866B;&#x7EBF;&#x7A0B;</a> &#xFF0C;&#x5229;&#x7528;&#x4E86;&#x4E4B;&#x524D;&#x90A3;&#x6761;LRU&#x7684;&#x961F;&#x5217;&#xFF0C;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x591A;&#x4E45;&#x8DD1;&#x4E00;&#x6B21;(&#x9ED8;&#x8BA4;&#x4E5F;&#x662F;100&#x6BEB;&#x79D2;)&#xFF0C;&#x6CBF;&#x7740;&#x5217;&#x5C3E;&#x4E00;&#x76F4;&#x68C0;&#x67E5;&#x8FC7;&#x53BB;&#xFF0C;&#x6BCF;&#x6B21;&#x68C0;&#x67E5;LRU&#x961F;&#x5217;&#x4E2D;&#x7684;N&#x6761;&#x6570;&#x636E;&#x3002;&#x867D;&#x7136;&#x6BCF;&#x6761;Key&#x8BBE;&#x7F6E;&#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x53EF;&#x80FD;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x4F46;&#x600E;&#x4E48;&#x8BF4;&#x547D;&#x4E2D;&#x7387;&#x4E5F;&#x6BD4;Redis&#x7684;&#x968F;&#x673A;&#x9009;&#x62E9;N&#x6761;&#x6570;&#x636E;&#x597D;&#x4E00;&#x70B9;&#xFF0C;&#x4F46;&#x5B83;&#x6CA1;&#x6709;Redis&#x90A3;&#x79CD;&#x8FC7;&#x671F;&#x7684;&#x591A;&#x4E86;&#x7ACB;&#x9A6C;&#x5C55;&#x5F00;&#x4E0B;&#x4E00;&#x8F6E;&#x68C0;&#x67E5;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6240;&#x4EE5;&#x6BCF;&#x79D2;&#x6700;&#x591A;&#x53EA;&#x80FD;&#x68C0;&#x67E5;10N&#x6761;&#x6570;&#x636E;&#xFF0C;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x81EA;&#x5DF1;&#x6743;&#x8861;N&#x7684;&#x8BBE;&#x7F6E;&#x3002; </p>
<h4 id="Guava_Cache">Guava Cache</h4><p>&#x5728;Guava Cache&#x91CC;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;Cache&#x91CC;&#x6240;&#x6709;&#x5143;&#x7D20;&#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x6BD4;Memached&#x66F4;&#x65B9;&#x4FBF;&#xFF0C;&#x987A;&#x7740;&#x4E4B;&#x524D;&#x90A3;&#x6761;LRU&#x7684;Queue&#x68C0;&#x67E5;&#x8D85;&#x65F6;&#xFF0C;&#x4E0D;&#x9650;&#x5B9A;&#x4E2A;&#x6570;&#xFF0C;&#x76F4;&#x5230;&#x4E0D;&#x8D85;&#x65F6;&#x4E3A;&#x6B62;&#x3002;&#x800C;&#x4E14;&#x5B83;&#x8FD9;&#x4E2A;&#x68C0;&#x67E5;&#x7684;&#x8C03;&#x7528;&#x65F6;&#x673A;&#x5E76;&#x4E0D;&#x662F;100&#x6BEB;&#x79D2;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x6BCF;&#x6B21;&#x5404;&#x79CD;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#x7684; <a href="https://github.com/google/guava/blob/56456cb58c0cb71d7c0f05047e13718ad202b748/guava/src/com/google/common/cache/LocalCache.java#L3439" target="_blank" rel="external">preWriteCleanup()</a> &#x65B9;&#x6CD5;&#x4E2D;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#x3002; </p>
<p>&#x5410;&#x69FD;&#x4E00;&#x53E5;&#xFF0C;Guava&#x7684;Localcache&#x7C7B;&#x91CC;&#x9762;&#x5DF2;&#x7ECF;4872&#x884C;&#x4E86;&#xFF0C;&#x4E00;&#x70B9;&#x90FD;&#x4E0D;&#x8F7B;&#x91CF;&#x4E86;&#x3002;</p>
<h4 id="Ehcache">Ehcache</h4><p>Ehcache&#x66F4;&#x4E71;&#xFF0C;&#x9996;&#x5148;&#x5B83;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x4E2D;&#x53EA;&#x6709;&#x60F0;&#x6027;&#x68C0;&#x67E5;&#xFF0C;&#x6CA1;&#x6709;&#x4E3B;&#x52A8;&#x68C0;&#x67E5;&#x8FC7;&#x671F;&#x7684;&#xFF0C;&#x53EA;&#x4F1A;&#x5728;&#x5185;&#x5B58;&#x8D85;&#x9650;&#x65F6;&#x4E0D;&#x65AD;&#x7528;&#x8FD1;&#x4F3C;LRU&#x7B97;&#x6CD5;(&#x89C1;&#x4E0A;)&#x628A;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#x5237;&#x5230;&#x78C1;&#x76D8;&#x4E2D;&#xFF0C;&#x5728;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x4E2D;&#x624D;&#x6709;&#x8D85;&#x65F6;&#x68C0;&#x67E5;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C; <a href="http://ehcache.org/documentation/2.8/faq#why-is-there-an-expiry-thread-for-the-diskstore-but-not-for-the-memorystore" target="_blank" rel="external">FAQ</a> &#x91CC;&#x4E13;&#x95E8;&#x89E3;&#x91CA;&#x4E86;&#x539F;&#x56E0;&#x3002; </p>
<p>&#x7136;&#x540E;&#x78C1;&#x76D8;&#x5B58;&#x50A8;&#x90A3;&#x6709;&#x4E00;&#x6761;8&#x5C0F;&#x65F6;&#x5DE6;&#x53F3;&#x8DD1;&#x4E00;&#x6B21;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x6B21;&#x904D;&#x5386;&#x6240;&#x6709;&#x5143;&#x7D20;…..&#x89C1; <a href="https://github.com/ehcache/ehcache3/blob/9c7d83ce4e2a59e15be7cb167ea886fdc47b496e/impl/src/main/java/org/ehcache/internal/store/disk/DiskStorageFactory.java#L860" target="_blank" rel="external">DiskStorageFactory&#x91CC;&#x7684;DiskExpiryTask</a> &#x3002; &#x4E00;&#x5708;&#x770B;&#x4E0B;&#x6765;&#xFF0C;Ehcache&#x7684;&#x5B9E;&#x73B0;&#x6700;&#x5F31;&#x3002; </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Ehcache/">Ehcache</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Redis/">Redis</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23f2d3d/" title="Linux c 开发 - Memcached源码分析之增删改查操作（5） -" itemprop="url">Linux c 开发 - Memcached源码分析之增删改查操作（5） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:38.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x5728;&#x7B2C;&#x4E8C;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B; &#x548C;&#x7B2C;&#x4E09;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF08;3&#xFF09;&#x300B; &#x4E2D;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x901A;&#x8FC7;Memcached&#x7684;get&#x547D;&#x4EE4;&#xFF0C;&#x5206;&#x6790;&#x4E86;Memcached&#x7684;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x548C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x7684;&#x6A21;&#x5757;&#x529F;&#x80FD;&#x3002;&#x8FD9;&#x4E00;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x6765;&#x8BE6;&#x7EC6;&#x770B;&#x4E00;&#x4E0B;Memcached&#x5E38;&#x7528;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x5728;&#x770B;Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;process_command&#x65B9;&#x6CD5;&#x3002;Memcached&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x901A;&#x8FC7;process_command&#x65B9;&#x6CD5;&#x5C06;&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#x7684;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x5206;&#x53D1;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;rbuf&amp;<span class="symbol">#x4E2D</span>;\n&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x6210</span>;\<span class="number">0</span>  
static void process_command(conn *c, char *command) {  

    //tokens&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#xFF08</span>;command&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x683C</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x9694</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#xFF1A</span>;set username zhuli,&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">3</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x522B</span>;&amp;<span class="symbol">#x662F</span>;set&amp;<span class="symbol">#x548C</span>;username&amp;<span class="symbol">#x548C</span>;zhuli  
    //<span class="class">MAX_TOKENS</span>&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">8</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;memcached&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    token_t tokens[<span class="class">MAX_TOKENS</span>];  
    size_t ntokens;  
    int comm;  

    assert(c != <span class="class">NULL</span>);  

    <span class="class">MEMCACHED_PROCESS_COMMAND_START</span>(c-&amp;gt;sfd, c-&amp;gt;rcurr, c-&amp;gt;rbytes);  

    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;lt;%d %s\n&amp;quot;, c-&amp;gt;sfd, command);  

    /* 
     * for commands set/add/replace, we build an item and read the data 
     * directly into it, then continue in nread_complete(). 
     */  

    c-&amp;gt;msgcurr = <span class="number">0</span>;  
    c-&amp;gt;msgused = <span class="number">0</span>;  
    c-&amp;gt;iovused = <span class="number">0</span>;  
    if (add_msghdr(c) != <span class="number">0</span>) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory preparing response&amp;quot;);  
        return;  
    }  

    //tokenize_command&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;tokens&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;:command&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    ntokens = tokenize_command(command, tokens, <span class="class">MAX_TOKENS</span>);  

    //tokens[<span class="class">COMMAND_TOKEN</span>] <span class="class">COMMAND_TOKEN</span>=<span class="number">0</span>  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;get&amp;quot;) == <span class="number">0</span>)  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;bget&amp;quot;) == <span class="number">0</span>))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;get&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_get_command(c, tokens, ntokens, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">6</span> || ntokens == <span class="number">7</span>)  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;add&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_ADD</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;set&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_SET</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;replace&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_REPLACE</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;prepend&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_PREPEND</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;append&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_APPEND</span>)))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; add/set/replace/prepend/append  
        process_update_command(c, tokens, ntokens, comm, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">7</span> || ntokens == <span class="number">8</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;cas&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_CAS</span>))) {  

        process_update_command(c, tokens, ntokens, comm, <span class="keyword">true</span>);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;incr&amp;quot;) == <span class="number">0</span>)) {  

        process_arithmetic_command(c, tokens, ntokens, <span class="number">1</span>);  

    } else if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;gets&amp;quot;) == <span class="number">0</span>)) {  

        process_get_command(c, tokens, ntokens, <span class="keyword">true</span>);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;decr&amp;quot;) == <span class="number">0</span>)) {  

        process_arithmetic_command(c, tokens, ntokens, <span class="number">0</span>);  

    } else if (ntokens &amp;gt;= <span class="number">3</span> &amp;amp;&amp;amp; ntokens &amp;lt;= <span class="number">5</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;delete&amp;quot;) == <span class="number">0</span>)) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; delete  
        process_delete_command(c, tokens, ntokens);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;touch&amp;quot;) == <span class="number">0</span>)) {  

        process_touch_command(c, tokens, ntokens);  

    } else if (ntokens &amp;gt;= <span class="number">2</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;stats&amp;quot;) == <span class="number">0</span>)) {  

        //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_stat(c, tokens, ntokens);  
//.....more code  
}
</code></pre><p>Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x6E90;&#x7801;&#x5206;&#x6790; </p>
<p>&#x589E;/&#x6539; set add replace &#x64CD;&#x4F5C;</p>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E2A;Memcached&#x7684;&#x547D;&#x4EE4;&#x884C;&#x7684;set&#x64CD;&#x4F5C;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code><span class="built_in">set</span> <span class="built_in">key</span> flags exptime vlen  
<span class="built_in">value</span>
</code></pre><p>set&#xFF1A;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#x540D;&#x79F0;</p>
<p>key&#xFF1A;&#x7F13;&#x5B58;&#x7684;key</p>
<p>flags&#xFF1A;&#x7F13;&#x5B58;&#x6807;&#x8BC6;</p>
<p>exptime&#xFF1A;&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;0 - &#x4E0D;&#x8FC7;&#x671F;</p>
<p>vlen&#xFF1A;&#x7F13;&#x5B58;value&#x7684;&#x957F;&#x5EA6;</p>
<p>value&#xFF1A;&#x7F13;&#x5B58;&#x7684;&#x503C;&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x5728;&#x7B2C;&#x4E8C;&#x884C;&#x3002;</p>
<p>&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code><span class="keyword">set</span> username <span class="number">0</span> <span class="number">10</span> <span class="number">9</span>  
woshishen
</code></pre><p>&#x6211;&#x4EEC;&#x5728;&#x7B2C;&#x4E8C;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B;&#x4E2D;&#x8BB2;&#x89E3;&#x5230;&#x4E86;&#x5982;&#x4F55;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x7684;&#x3002;Memcached&#x4E00;&#x822C;&#x4F1A;&#x901A;&#x8FC7;\n&#x7B26;&#x53F7;&#x53BB;&#x5206;&#x9694;&#x6BCF;&#x4E2A;&#x547D;&#x4EE4;&#x884C;&#x8BED;&#x53E5;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x5C06;&#x4E00;&#x884C;&#x547D;&#x4EE4;&#x5207;&#x5272;&#x6210;N&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x5143;&#x7D20;&#x4F1A;&#x653E;&#x8FDB;&#x4E00;&#x4E2A;tokens&#x7684;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</p>
<p>&#x8FD9;&#x8FB9;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;set&#x547D;&#x4EE4;&#x4F1A;&#x5206;&#x5C42;&#x4E24;&#x90E8;&#x5206;&#xFF1A;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x548C;Value&#x503C;&#x90E8;&#x5206;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x4F1A;&#x5148;&#x53BB;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x4E14;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x4E2D;&#x5E26;&#x4E0A;&#x4E86;vlen&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;value&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x4F1A;&#x53BB;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x653E;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x89E3;&#x6790;&#x5B8C;&#x6BD5;&#xFF0C;Memcached&#x4F1A;&#x53BB;&#x7EE7;&#x7EED;&#x8BFB;&#x53D6;Socket&#x4E2D;&#x7684;&#x5269;&#x4F59;&#x6570;&#x636E;&#x62A5;&#x6587;&#xFF0C;&#x8FB9;&#x8BFB;&#x53D6;&#x8FB9;&#x590D;&#x5236;&#x5230;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E2D;&#xFF0C;&#x76F4;&#x5230;&#x8BFB;&#x53D6;&#x5230;&#x7684;Value&#x6570;&#x636E;&#x957F;&#x5EA6;&#x548C;&#x547D;&#x4EE4;&#x884C;&#x4E2D;&#x7684;vlen&#x957F;&#x5EA6;&#x4E00;&#x81F4;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x7ED3;&#x675F;&#x3002;&#x7136;&#x540E;&#x4F1A;&#x53BB;&#x5B58;&#x50A8;item&#xFF0C;&#x5982;&#x679C;item&#x5B58;&#x50A8;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;item&#x6302;&#x5230;HashTable&#x548C;LRU&#x94FE;&#x4E0A;&#x9762;&#xFF1B;&#x5982;&#x679C;&#x5B58;&#x50A8;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x4F1A;&#x5220;&#x9664;item&#x3002;</p>
</li>
</ol>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;process_update_command&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<p>1.&#xA0; &#x5E2E;&#x52A9;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;</p>
<p>2.&#xA0; &#x5206;&#x914D;&#x4E00;&#x4E2A;Item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x3002;</p>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;&#x72B6;&#x6001;&#x673A;drive_machine&#x4E2D;conn_nread&#x7684;&#x4EE3;&#x7801;&#x5757;&#x3002;conn_nread&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;value&#x6570;&#x636E;&#x3002;</p>
<pre><code>/********************************* 
&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x3001</span>;&amp;<span class="symbol">#x7F16</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>; 
&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;set&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; 

&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>; 
set key flags exptime vlen 
value 

&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;vlen&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>; 
flages &amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>; 
exptime&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="number">0</span> &amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>; 
value &amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;value&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E8C</span>;&amp;<span class="symbol">#x884C</span>; 

&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>; 
set username <span class="number">0</span> <span class="number">10</span> <span class="number">9</span> 
woshishen 
**************************************/  
static void process_update_command(conn *c, token_t *tokens,  
        const size_t ntokens, int comm, bool handle_cas) {  
    char *key; //key  
    size_t nkey; //key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    unsigned int flags; //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;  
    int32_t exptime_int = <span class="number">0</span>;  
    time_t exptime; //&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;  
    int vlen; //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    uint64_t req_cas_id = <span class="number">0</span>;  
    //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;key/value&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabclass&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;  
    item *it;  

    assert(c != <span class="class">NULL</span>);  

    set_noreply_maybe(c, tokens, ntokens);  
    //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>; key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;<span class="number">250</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;  
    if (tokens[<span class="class">KEY_TOKEN</span>].length &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x548C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //tokens[<span class="number">0</span>]&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    key = tokens[<span class="class">KEY_TOKEN</span>].value; //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
    nkey = tokens[<span class="class">KEY_TOKEN</span>].length; //key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  

    //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6027</span>;  
    if (!(safe_strtoul(tokens[<span class="number">2</span>].value, (uint32_t *) &amp;amp;flags)  
            &amp;amp;&amp;amp; safe_strtol(tokens[<span class="number">3</span>].value, &amp;amp;exptime_int)  
            &amp;amp;&amp;amp; safe_strtol(tokens[<span class="number">4</span>].value, (int32_t *) &amp;amp;vlen))) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    /* <span class="class">Ubuntu</span> <span class="number">8.04</span> breaks when <span class="class">I</span> pass exptime to safe_strtol */  
    exptime = exptime_int;  

    /* <span class="class">Negative</span> exptimes can underflow and end up immortal. realtime() will 
     immediately expire values that are greater than <span class="class">REALTIME_MAXDELTA</span>, but less 
     than process_started, so lets aim for that. */  
    if (exptime &amp;lt; <span class="number">0</span>)  
        exptime = <span class="class">REALTIME_MAXDELTA</span> + <span class="number">1</span>;  

    // does cas value exist?  
    if (handle_cas) {  
        if (!safe_strtoull(tokens[<span class="number">5</span>].value, &amp;amp;req_cas_id)) {  
            out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
            return;  
        }  
    }  

    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;vlen&amp;<span class="symbol">#x8981</span>;+<span class="number">2</span>&amp;<span class="symbol">#x5462</span>;&amp;<span class="symbol">#xFF1F</span>;  
    //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;/r/n  
    //&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;/r/n&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;\r\n&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>; &amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
    vlen += <span class="number">2</span>;  
    if (vlen &amp;lt; <span class="number">0</span> || vlen - <span class="number">2</span> &amp;lt; <span class="number">0</span>) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    if (settings.detail_enabled) {  
        stats_prefix_record_set(key, nkey);  
    }  

    //item_alloc&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x6838</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;item_alloc&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item  
    //&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;  
    //key&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;key  
    //nkey&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //<span class="method">flags:</span>&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x8BC6</span>;  
    //exptime&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    //vlen&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7591</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF1F</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x4E86</span>;vlen&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x5462</span>;&amp;<span class="symbol">#xFF1F</span>;  
    //<span class="number">1.</span> &amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;set/add/replace&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E9B</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x8F93</span>;  
    //<span class="number">2.</span> &amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x9009</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x62EC</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;  
    //<span class="number">3.</span> &amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7C98</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;  
    //&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5B8C</span>;  
    //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x5373</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x3002</span>;  
    //<span class="number">4.</span> &amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF1A</span>;conn_set_state(c, conn_nread); &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_nread&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;conn_nread  
    //&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;  
    it = item_alloc(key, nkey, flags, realtime(exptime), vlen);  

    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
    if (it == <span class="number">0</span>) {  
        if (!item_size_ok(nkey, flags, vlen))  
            out_string(c, &amp;quot;<span class="class">SERVER_ERROR</span> object too large for cache&amp;quot;);  
        else  
            out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory storing object&amp;quot;);  
        /* swallow the data line */  
        c-&amp;gt;write_and_go = conn_swallow;  
        c-&amp;gt;sbytes = vlen;  

        /* <span class="class">Avoid</span> stale data persisting in cache because we failed alloc. 
         * <span class="class">Unacceptable</span> for <span class="class">SET</span>. <span class="class">Anywhere</span> else too? */  
        if (comm == <span class="class">NREAD_SET</span>) {  
            it = item_get(key, nkey);  
            if (it) {  
                item_unlink(it);  
                item_remove(it);  
            }  
        }  

        return;  
    }  
    <span class="class">ITEM_set_cas</span>(it, req_cas_id);  

    c-&amp;gt;item = it;  
    c-&amp;gt;ritem = <span class="class">ITEM_data</span>(it); //value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    c-&amp;gt;rlbytes = it-&amp;gt;nbytes; //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    c-&amp;gt;cmd = comm;  
    //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_nread&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    conn_set_state(c, conn_nread);  
}
</code></pre><p>&#x770B;&#x4E00;&#x4E0B;item_alloc&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5206;&#x914D;&#x4E00;&#x5757;&#x53EF;&#x4EE5;&#x7528;&#x7684;Item&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>Memcached&#x662F;&#x901A;&#x8FC7;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x957F;&#x5EA6;&#x9009;&#x62E9;&#x5408;&#x9002;&#x7684;slab class&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8BE5;slabs class&#x4E0A;&#x5206;&#x914D;&#x4E00;&#x5757;item&#x3002;</p>
</li>
</ol>
<p>&#x5148;&#x770B;&#x4E00;&#x4E0B;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code>//item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
typedef struct _stritem {  
    //&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *next;  //&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *prev;  //&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    struct _stritem *h_next; //hashtable&amp;<span class="symbol">#x7684</span>;list   /* hash chain next */  
    //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    rel_time_t      time;       /* least recent access */  
    //&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    rel_time_t      exptime;    /* expire time */  
    //value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
    int             nbytes;     /* size of data */  
    unsigned short  refcount;  
    uint8_t         nsuffix;    /* length of flags-and-length string */  
    uint8_t         it_flags;   /* <span class="class">ITEM_</span>* above */  
    //slab class&amp;<span class="symbol">#x7684</span>;<span class="class">ID</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E0A</span>;  
    uint8_t         slabs_clsid;/* which slab class we&amp;apos;re in */  
    uint8_t         nkey;       /* key length, w/terminating null and padding */  
    /* this odd type prevents type-punning issues when we do 
     * the little shuffle to save space when not using <span class="class">CAS</span>. */  
    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;  
    union {  
        uint64_t cas;  
        char end;  
    } data[];  
    /* if it_flags &amp;amp; <span class="class">ITEM_CAS</span> we have <span class="number">8</span> bytes <span class="class">CAS</span> */  
    /* then null-terminated key */  
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
} item;


/* 
 * <span class="class">Allocates</span> a new item. 
 */  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
item *item_alloc(char *key, size_t nkey, int flags, rel_time_t exptime, int nbytes) {  
    item *it;  
    /* do_item_alloc handles its own locks */  
    it = do_item_alloc(key, nkey, flags, exptime, nbytes, <span class="number">0</span>);  
    return it;  
}


//&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
item *do_item_alloc(char *key, const size_t nkey, const int flags,  
                    const rel_time_t exptime, const int nbytes,  
                    const uint32_t cur_hv) {  
    uint8_t nsuffix;  
    item *it = <span class="class">NULL</span>; //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    char suffix[<span class="number">40</span>];  
    //item_make_header &amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    size_t ntotal = item_make_header(nkey + <span class="number">1</span>, flags, nbytes, suffix, &amp;amp;nsuffix);  
    if (settings.use_cas) {  
        ntotal += sizeof(uint64_t);  
    }  
    //&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;ntotal &amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    //<span class="class">Memcached</span>&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class  
    //&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#xFF0C</span>;slabs&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabs&amp;<span class="symbol">#x4E0A</span>;  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;chunk  
    //  
    //&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>; &amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">200</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x3002</span>;  
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;slabs_class&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;item&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
    //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;slabs&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;chunk&amp;<span class="symbol">#x5757</span>;  
    //&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;chunk&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    unsigned int id = slabs_clsid(ntotal);  
    if (id == <span class="number">0</span>)  
        return <span class="number">0</span>;  
    mutex_lock(&amp;amp;cache_lock);  
    /* do a quick check if we have any expired items in the tail.. */  
    int tries = <span class="number">5</span>;  
    /* <span class="class">Avoid</span> hangs if a slab has nothing but refcounted stuff in it. */  
    int tries_lrutail_reflocked = <span class="number">1000</span>;  
    int tried_alloc = <span class="number">0</span>;  
    item *search;  
    item *next_it;  
    void *hold_lock = <span class="class">NULL</span>;  
    rel_time_t oldest_live = settings.oldest_live;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    //item&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    search = tails[id];  
    /* <span class="class">We</span> walk up *only* for locked items. <span class="class">Never</span> searching for expired. 
     * <span class="class">Waste</span> of <span class="class">CPU</span> for almost all deployments */  
    for (; tries &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; search != <span class="class">NULL</span>; tries--, search=next_it) {  
        /* we might relink search mid-loop, so search-&amp;gt;prev isn&amp;apos;t reliable */  
        next_it = search-&amp;gt;prev;  
        if (search-&amp;gt;nbytes == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;nkey == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;it_flags == <span class="number">1</span>) {  
            /* <span class="class">We</span> are a crawler, ignore it. */  
            tries++;  
            continue;  
        }  
        uint32_t hv = hash(<span class="class">ITEM_key</span>(search), search-&amp;gt;nkey);  
        /* <span class="class">Attempt</span> to hash item lock the &amp;quot;search&amp;quot; item. <span class="class">If</span> locked, no 
         * other callers can incr the refcount 
         */  
        /* <span class="class">Don</span>&amp;apos;t accidentally grab ourselves, or bail if we can&amp;apos;t quicklock */  
        if (hv == cur_hv || (hold_lock = item_trylock(hv)) == <span class="class">NULL</span>)  
            continue;  
        /* <span class="class">Now</span> see if the item is refcount locked */  
        if (refcount_incr(&amp;amp;search-&amp;gt;refcount) != <span class="number">2</span>) {  
            /* <span class="class">Avoid</span> pathological case with ref&amp;apos;ed items in tail */  
            do_item_update_nolock(search);  
            tries_lrutail_reflocked--;  
            tries++;  
            refcount_decr(&amp;amp;search-&amp;gt;refcount);  
            itemstats[id].lrutail_reflocked++;  
            /* <span class="class">Old</span> rare bug could cause a refcount leak. <span class="class">We</span> haven&amp;apos;t seen 
             * it in years, but we leave this code in to prevent failures 
             * just in case */  
            if (settings.tail_repair_time &amp;amp;&amp;amp;  
                    search-&amp;gt;time + settings.tail_repair_time &amp;lt; current_time) {  
                itemstats[id].tailrepairs++;  
                search-&amp;gt;refcount = <span class="number">1</span>;  
                do_item_unlink_nolock(search, hv);  
            }  
            if (hold_lock)  
                item_trylock_unlock(hold_lock);  
            if (tries_lrutail_reflocked &amp;lt; <span class="number">1</span>)  
                break;  
            continue;  
        }  
        /* <span class="class">Expired</span> or flushed */  
        if ((search-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;exptime &amp;lt; current_time)  
            || (search-&amp;gt;time &amp;lt;= oldest_live &amp;amp;&amp;amp; oldest_live &amp;lt;= current_time)) {  
            itemstats[id].reclaimed++;  
            if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                itemstats[id].expired_unfetched++;  
            }  
            it = search;  
            slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
            do_item_unlink_nolock(it, hv);  
            /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
            it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
        //slabs_alloc&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
        } else if ((it = slabs_alloc(ntotal, id)) == <span class="class">NULL</span>) {  
            tried_alloc = <span class="number">1</span>;  
            if (settings.evict_to_free == <span class="number">0</span>) {  
                itemstats[id].outofmemory++;  
            } else {  
                itemstats[id].evicted++;  
                itemstats[id].evicted_time = current_time - search-&amp;gt;time;  
                if (search-&amp;gt;exptime != <span class="number">0</span>)  
                    itemstats[id].evicted_nonzero++;  
                if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                    itemstats[id].evicted_unfetched++;  
                }  
                it = search;  
                slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
                do_item_unlink_nolock(it, hv);  
                /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
                it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
                /* <span class="class">If</span> we&amp;apos;ve just evicted an item, and the automover is set to 
                 * angry bird mode, attempt to rip memory into this slab class. 
                 * <span class="class">TODO</span>: <span class="class">Move</span> valid object detection into a function, and on a 
                 * &amp;quot;successful&amp;quot; memory pull, look behind and see if the next alloc 
                 * would be an eviction. <span class="class">Then</span> kick off the slab mover before the 
                 * eviction happens. 
                 */  
                if (settings.slab_automove == <span class="number">2</span>)  
                    slabs_reassign(-<span class="number">1</span>, id);  
            }  
        }  
        refcount_decr(&amp;amp;search-&amp;gt;refcount);  
        /* <span class="class">If</span> hash values were equal, we don&amp;apos;t grab a second lock */  
        if (hold_lock)  
            item_trylock_unlock(hold_lock);  
        break;  
    }  
    if (!tried_alloc &amp;amp;&amp;amp; (tries == <span class="number">0</span> || search == <span class="class">NULL</span>))  
        it = slabs_alloc(ntotal, id);  
    if (it == <span class="class">NULL</span>) {  
        itemstats[id].outofmemory++;  
        mutex_unlock(&amp;amp;cache_lock);  
        return <span class="class">NULL</span>;  
    }  
    assert(it-&amp;gt;slabs_clsid == <span class="number">0</span>);  
    assert(it != heads[id]);  
    /* <span class="class">Item</span> initialization can happen outside of the lock; the item&amp;apos;s already 
     * been removed from the slab <span class="class">LRU</span>. 
     */  
    it-&amp;gt;refcount = <span class="number">1</span>;     /* the caller will have a reference */  
    mutex_unlock(&amp;amp;cache_lock);  
    it-&amp;gt;next = it-&amp;gt;prev = it-&amp;gt;h_next = <span class="number">0</span>;  
    it-&amp;gt;slabs_clsid = id;  
    <span class="class">DEBUG_REFCNT</span>(it, &amp;apos;*&amp;apos;);  
    it-&amp;gt;it_flags = settings.use_cas ? <span class="class">ITEM_CAS</span> : <span class="number">0</span>;  
    it-&amp;gt;nkey = nkey;  
    it-&amp;gt;nbytes = nbytes;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;  
    memcpy(<span class="class">ITEM_key</span>(it), key, nkey);  
    it-&amp;gt;exptime = exptime;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;  
    memcpy(<span class="class">ITEM_suffix</span>(it), suffix, (size_t)nsuffix);  
    it-&amp;gt;nsuffix = nsuffix;  
    return it;  
}
</code></pre><p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x72B6;&#x6001;&#x673A;drive_machine&#x4E2D;conn_nread&#x7684;&#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x8BFB;&#x53D6;&#x7F13;&#x5B58;&#x7684;value&#x503C;</p>
</li>
<li><p>&#x5C06;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#x5230;item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<p> //conn_nread &#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;&#x7F13;&#x5B58;&#x7684;value&#x6570;&#x636E;&#x62A5;&#x6587;<br> case conn_nread:  </p>
<pre><code>//&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>; value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E86</span>;  
if (c-&amp;gt;rlbytes == <span class="number">0</span>) {  
    complete_nread(c);  
    break;  
}  
/* <span class="class">Check</span> if rbytes &amp;lt; <span class="number">0</span>, to prevent crash */  
//&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
if (c-&amp;gt;rlbytes &amp;lt; <span class="number">0</span>) {  
    if (settings.verbose) {  
        fprintf(stderr, &amp;quot;<span class="class">Invalid</span> rlbytes to <span class="method">read:</span> len %d\n&amp;quot;,  
                c-&amp;gt;rlbytes);  
    }  
    conn_set_state(c, conn_closing);  
    break;  
}  
/* first check if we have leftovers in the conn_read buffer */  
//c-&amp;gt;rbytes &amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//c-&amp;gt;rlbytes &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
    //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76EE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;c-&amp;gt;rlbytes&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes &amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>; c-&amp;gt;rlbytes &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes &amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>; c-&amp;gt;rlbytes &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53E6</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8DEF</span>;&amp;<span class="symbol">#x4E0A</span>;  
    int tocopy = c-&amp;gt;rbytes &amp;gt; c-&amp;gt;rlbytes ? c-&amp;gt;rlbytes : c-&amp;gt;rbytes;  
    //c-&amp;gt;ritem &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6B21</span>;set/add/replace&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    if (c-&amp;gt;ritem != c-&amp;gt;rcurr) {  
        memmove(c-&amp;gt;ritem, c-&amp;gt;rcurr, tocopy);  
    }  
    c-&amp;gt;ritem += tocopy; //&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x52A0</span>;  
    c-&amp;gt;rlbytes -= tocopy; //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>; &amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    c-&amp;gt;rcurr += tocopy; //&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    c-&amp;gt;rbytes -= tocopy; //&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>; &amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>; &amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rlbytes&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;value&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x51FA</span>;  
    if (c-&amp;gt;rlbytes == <span class="number">0</span>) {  
        break;  
    }  
}  
/*  now try reading from the socket */  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;<span class="symbol">#x4ECE</span>;socket&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;c-&amp;gt;ritem&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;c-&amp;gt;rlbytes  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5230</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6B62</span>;  
res = read(c-&amp;gt;sfd, c-&amp;gt;ritem, c-&amp;gt;rlbytes);  
if (res &amp;gt; <span class="number">0</span>) {  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.bytes_read += res;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    if (c-&amp;gt;rcurr == c-&amp;gt;ritem) {  
        c-&amp;gt;rcurr += res;  
    }  
    c-&amp;gt;ritem += res;  
    c-&amp;gt;rlbytes -= res;  
    break;  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6D41</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
if (res == <span class="number">0</span>) { /* end of stream */  
    conn_set_state(c, conn_closing);  
    break;  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;  
if (res == -<span class="number">1</span> &amp;amp;&amp;amp; (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>)) {  
    if (!update_event(c, <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>)) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    stop = <span class="keyword">true</span>;  
    break;  
}  
/* otherwise we have a real error, on which we close the connection */  
if (settings.verbose &amp;gt; <span class="number">0</span>) {  
    fprintf(stderr, &amp;quot;<span class="class">Failed</span> to read, and not due to <span class="method">blocking:</span>\n&amp;quot;  
            &amp;quot;<span class="method">errno:</span> %d %s \n&amp;quot;  
            &amp;quot;rcurr=%lx ritem=%lx rbuf=%lx rlbytes=%d rsize=%d\n&amp;quot;, errno,  
            strerror(errno), (long) c-&amp;gt;rcurr, (long) c-&amp;gt;ritem,  
            (long) c-&amp;gt;rbuf, (int) c-&amp;gt;rlbytes, (int) c-&amp;gt;rsize);  
}  
//&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;  
conn_set_state(c, conn_closing);  
break;
</code></pre></li>
</ol>
<p>&#x8FD9;&#x8FB9;&#x5982;&#x679C;&#x8BFB;&#x53D6;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;complete_nread(c)&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5F80;&#x4E0B;&#x4E00;&#x76F4;&#x770B;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x5230;complete_nread_ascii&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x8C03;&#x7528;&#x5B58;&#x50A8;&#x6570;&#x636E;store_item&#x7684;&#x65B9;&#x6CD5;</p>
</li>
<li><p>&#x8C03;&#x7528;item_remove&#x5220;&#x9664;item&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p> static void complete_nread_ascii(conn *c) {  </p>
<pre><code>assert(c != NULL);  

item *it = c-&amp;<span class="keyword">gt</span>;item;  
<span class="keyword">int</span> comm = c-&amp;<span class="keyword">gt</span>;cmd;  
enum store_item_type ret;  

pthread_mutex_lock(&amp;amp;c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.mutex);  
c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.slab_stats[it-&amp;<span class="keyword">gt</span>;slabs_clsid].set_cmds++;  
pthread_mutex_unlock(&amp;amp;c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.mutex);  

<span class="keyword">if</span> (strncmp(ITEM_data(it) + it-&amp;<span class="keyword">gt</span>;nbytes - <span class="number">2</span>, &amp;quot;\r\n&amp;quot;, <span class="number">2</span>) != <span class="number">0</span>) {  
    out_string(c, &amp;quot;CLIENT_ERROR bad data chunk&amp;quot;);  
} <span class="keyword">else</span> {  
    <span class="regexp">//</span>&amp;<span class="comment">#x8FD9;&amp;#x8FB9;&amp;#x8C03;&amp;#x7528;&amp;#x5B58;&amp;#x50A8;Item&amp;#x7684;&amp;#x65B9;&amp;#x6CD5;  </span>
    ret = store_item(it, comm, c);  
</code></pre><p> //….  </p>
<pre><code>    switch (ret) {  
    case <span class="class">STORED</span>:  
        out_string(c, &amp;quot;<span class="class">STORED</span>&amp;quot;);  
        break;  
    case <span class="class">EXISTS</span>:  
        out_string(c, &amp;quot;<span class="class">EXISTS</span>&amp;quot;);  
        break;  
    case <span class="class">NOT_FOUND</span>:  
        out_string(c, &amp;quot;<span class="class">NOT_FOUND</span>&amp;quot;);  
        break;  
    case <span class="class">NOT_STORED</span>:  
        out_string(c, &amp;quot;<span class="class">NOT_STORED</span>&amp;quot;);  
        break;  
    <span class="method">default:</span>  
        out_string(c, &amp;quot;<span class="class">SERVER_ERROR</span> <span class="class">Unhandled</span> storage type.&amp;quot;);  
    }  

}  

//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7ADF</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#xFF1F</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x89C9</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5947</span>;&amp;<span class="symbol">#x602A</span>;&amp;<span class="symbol">#x4E48</span>;&amp;<span class="symbol">#xFF1F</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;item-&amp;gt;refcount,&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;alloc&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;refcount&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>  
//  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;store_item&amp;<span class="symbol">#xFF0C</span>;add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_link  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;refcount&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;  
//if (refcount_decr(&amp;amp;it-&amp;gt;refcount) == <span class="number">0</span>) &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
//  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;store_item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x786E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item  
//  
//&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x7ED5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x903B</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F46</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x5DE7</span>;&amp;<span class="symbol">#x5999</span>;  
item_remove(c-&amp;gt;item); /* release the c-&amp;gt;item reference */  
c-&amp;gt;item = <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;do_store_item&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x3002;&#x57FA;&#x672C;&#x5305;&#x62EC;&#x4E24;&#x79CD;&#x72B6;&#x6001;&#xFF1A;&#x5B58;&#x50A8;&#x6210;&#x529F;&#x548C;&#x5B58;&#x50A8;&#x5931;&#x8D25;&#x3002;</p>
<ol>
<li><p>add/replace&#x547D;&#x4EE4;&#xFF0C;&#x4F1A;&#x5224;&#x65AD;item&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x5219;add&#x547D;&#x4EE4;&#x64CD;&#x4F5C;&#x5931;&#x8D25;</p>
</li>
<li><p>set&#x547D;&#x4EE4;&#xFF0C;item&#x5B58;&#x5728;&#x6216;&#x8005;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x65B0;&#x7684;item&#xFF0C;&#x66FF;&#x6362;&#x8001;&#x7684;item&#x3002;</p>
<p> //&#x5B58;&#x50A8;Item&#x64CD;&#x4F5C;<br> enum store_item_type do_store_item(item <em>it, int comm, conn </em>c,  </p>
<pre><code>    const uint32_t hv) {  
char *key = <span class="class">ITEM_key</span>(it);  
//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;<span class="class">KEY</span>&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x65E7</span>;&amp;<span class="symbol">#x7684</span>;item  
//add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item  
item *old_it = do_item_get(key, it-&amp;gt;nkey, hv);  
enum store_item_type stored = <span class="class">NOT_STORED</span>;  
item *new_it = <span class="class">NULL</span>;  
int flags;  
//<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT_STORED</span>  
if (old_it != <span class="class">NULL</span> &amp;amp;&amp;amp; comm == <span class="class">NREAD_ADD</span>) {  
    /* add only adds a nonexistent item, but promote to head of <span class="class">LRU</span> */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //<span class="number">1.</span>&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;item&amp;<span class="symbol">#x7684</span>;it-&amp;gt;time&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x987A</span>;&amp;<span class="symbol">#x5E8F</span>;  
    //<span class="number">2.</span>&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;refcount  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;it-&amp;gt;refcount=<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;old_it&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    do_item_update(old_it);  
//replace/prepend/append &amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x505A</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;item&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT_STORED</span>  
} else if (!old_it  
        &amp;amp;&amp;amp; (comm == <span class="class">NREAD_REPLACE</span> || comm == <span class="class">NREAD_APPEND</span>  
                || comm == <span class="class">NREAD_PREPEND</span>)) {  
    /* replace only replaces an existing value; don&amp;apos;t store */  
} else if (comm == <span class="class">NREAD_CAS</span>) {  
    /* validate cas operation */  
    if (old_it == <span class="class">NULL</span>) {  
        // <span class="class">LRU</span> expired  
        stored = <span class="class">NOT_FOUND</span>;  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.cas_misses++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    } else if (<span class="class">ITEM_get_cas</span>(it) == <span class="class">ITEM_get_cas</span>(old_it)) {  
        // cas validates  
        // it and old_it may belong to different classes.  
        // <span class="class">I</span>&amp;apos;m updating the stats for the one that&amp;apos;s getting pushed out  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.slab_stats[old_it-&amp;gt;slabs_clsid].cas_hits++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        item_replace(old_it, it, hv);  
        stored = <span class="class">STORED</span>;  
    } else {  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.slab_stats[old_it-&amp;gt;slabs_clsid].cas_badval++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        if (settings.verbose &amp;gt; <span class="number">1</span>) {  
            fprintf(stderr, &amp;quot;<span class="class">CAS</span>:  <span class="method">failure:</span> expected %llu, got %llu\n&amp;quot;,  
                    (unsigned long long) <span class="class">ITEM_get_cas</span>(old_it),  
                    (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
        }  
        stored = <span class="class">EXISTS</span>;  
    }  
} else {  
    /* 
     * <span class="class">Append</span> - combine new and old record into single one. <span class="class">Here</span> it&amp;apos;s 
     * atomic and thread-safe. 
     */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8001</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x8FFD</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>; append&amp;<span class="symbol">#x548C</span>;prepend&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (comm == <span class="class">NREAD_APPEND</span> || comm == <span class="class">NREAD_PREPEND</span>) {  
        /* 
         * <span class="class">Validate</span> <span class="class">CAS</span> 
         */  
        if (<span class="class">ITEM_get_cas</span>(it) != <span class="number">0</span>) {  
            // <span class="class">CAS</span> much be equal  
            if (<span class="class">ITEM_get_cas</span>(it) != <span class="class">ITEM_get_cas</span>(old_it)) {  
                stored = <span class="class">EXISTS</span>;  
            }  
        }  
        if (stored == <span class="class">NOT_STORED</span>) {  
            /* we have it and old_it here - alloc memory to hold both */  
            /* flags was already lost - so recover them from <span class="class">ITEM_suffix</span>(it) */  
            flags = (int) strtol(<span class="class">ITEM_suffix</span>(old_it), (char **) <span class="class">NULL</span>, <span class="number">10</span>);  
            new_it = do_item_alloc(key, it-&amp;gt;nkey, flags, old_it-&amp;gt;exptime,  
                    it-&amp;gt;nbytes + old_it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */, hv);  
            if (new_it == <span class="class">NULL</span>) {  
                /* <span class="class">SERVER_ERROR</span> out of memory */  
                if (old_it != <span class="class">NULL</span>)  
                    do_item_remove(old_it);  
                return <span class="class">NOT_STORED</span>;  
            }  
            /* copy data from it and old_it to new_it */  
            if (comm == <span class="class">NREAD_APPEND</span>) {  
                memcpy(<span class="class">ITEM_data</span>(new_it), <span class="class">ITEM_data</span>(old_it),  
                        old_it-&amp;gt;nbytes);  
                memcpy(<span class="class">ITEM_data</span>(new_it) + old_it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */,  
                        <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes);  
            } else {  
                /* <span class="class">NREAD_PREPEND</span> */  
                memcpy(<span class="class">ITEM_data</span>(new_it), <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes);  
                memcpy(<span class="class">ITEM_data</span>(new_it) + it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */,  
                        <span class="class">ITEM_data</span>(old_it), old_it-&amp;gt;nbytes);  
            }  
            it = new_it;  
        }  
    }  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (stored == <span class="class">NOT_STORED</span>) {  
        if (old_it != <span class="class">NULL</span>)  
            //&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;old_it&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
            //it&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;it-&amp;gt;refcount=<span class="number">2</span>  
            item_replace(old_it, it, hv);  
        else  
            //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;it-&amp;gt;refcount=<span class="number">2</span>  
            do_item_link(it, hv);  
        c-&amp;gt;cas = <span class="class">ITEM_get_cas</span>(it);  
        stored = <span class="class">STORED</span>;  
    }  
    //&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x63D0</span>;&amp;<span class="symbol">#x5230</span>;it-&amp;gt;refcount?  
    //<span class="number">1.</span> &amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;it-&amp;gt;refcount&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9632</span>;&amp;<span class="symbol">#x6B62</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item  
    //<span class="number">2.</span> do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;refcount&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">ITEM</span>  
    //  
    //&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_store_item&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;memcached&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_remove(it);&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x3002</span>;  
    //do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5C06</span>;item&amp;<span class="symbol">#x751F</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">SET</span>/<span class="class">ADD</span>&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x597D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">SET</span>&amp;<span class="symbol">#x548C</span>;<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_link&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;item&amp;<span class="symbol">#x7684</span>;refcount&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;  
    //&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_remove(it);&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">0</span>&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x7ED5</span>;.....  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8001</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
if (old_it != <span class="class">NULL</span>)  
    do_item_remove(old_it); /* release our reference */  
//new_it&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;prepend/append&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
if (new_it != <span class="class">NULL</span>)  
    do_item_remove(new_it);  
if (stored == <span class="class">STORED</span>) {  
    c-&amp;gt;cas = <span class="class">ITEM_get_cas</span>(it);  
}  
return stored;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x5728;do_store_item&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x7EC8;&#x4F1A;&#x627E;&#x5230;do_item_link&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;item&#x6302;&#x5230;Hashtable&#x4E0A;&#x9762;</p>
</li>
<li><p>&#x5C06;item&#x6302;&#x5230;LRU&#x94FE;&#x4E0A;&#x9762;</p>
</li>
</ol>
<p>HashTable&#xFF1A;&#x628A;Item&#x6302;&#x5230;HashTable&#x4E0A;&#x53BB;&#x540E;&#xFF0C;&#x7528;&#x6237;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F13;&#x5B58;&#x7684;key&#x5230;HashTable&#x4E0A;&#x67E5;&#x8BE2;&#x8FD9;&#x4E2A;Item&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>LRU&#xFF1A;&#x662F;&#x4E00;&#x4E2A;&#x6E05;&#x9664;&#x7F13;&#x5B58;&#x7684;&#x7B56;&#x7565;&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x6E05;&#x7406;&#x6700;&#x4E0D;&#x5E38;&#x7528;&#x7684;&#x5143;&#x7D20;&#x3002;LRU&#x7684;&#x94FE;&#xFF0C;&#x4F1A;&#x653E;&#x5728;&#x4E0B;&#x9762;&#x4E24;&#x4E2A;Item&#x6307;&#x9488;&#x5730;&#x5740;&#x7684;&#x6570;&#x7EC4;&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>static item *heads[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
static item *tails[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;
</code></pre><p>v</p>
<pre><code><span class="comment">//&amp;#x65B0;&amp;#x589E;&amp;#x4E00;&amp;#x4E2A;Item&amp;#x7684;&amp;#x8FDE;&amp;#x63A5;&amp;#x5173;&amp;#x7CFB;  </span>
int do_item_link<span class="params">(item *it, const uint32_t hv)</span> {  
    MEMCACHED_ITEM_LINK<span class="params">(ITEM_key<span class="params">(it)</span>, it-&amp;gt;nkey, it-&amp;gt;nbytes)</span>;  
    assert<span class="params">(<span class="params">(it-&amp;gt;it_flags &amp;amp; <span class="params">(ITEM_LINKED|ITEM_SLABBED)</span>)</span> == <span class="number">0</span>)</span>;  
    mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
    it-&amp;gt;it_flags |= ITEM_LINKED;  
    it-&amp;gt;time = current_time;  

    STATS_LOCK<span class="params">()</span>;  
    stats.curr_bytes += ITEM_ntotal<span class="params">(it)</span>;  
    stats.curr_items += <span class="number">1</span>;  
    stats.total_items += <span class="number">1</span>;  
    STATS_UNLOCK<span class="params">()</span>;  

    <span class="comment">/* Allocate a new CAS ID on link. */</span>  
    ITEM_set_cas<span class="params">(it, <span class="params">(settings.use_cas)</span> ? get_cas_id<span class="params">()</span> : <span class="number">0</span>)</span>;  
    <span class="comment">//&amp;#x5206;&amp;#x914D;&amp;#x5230;HashTable&amp;#x7684;&amp;#x6876;&amp;#x4E0A;  </span>
    assoc_insert<span class="params">(it, hv)</span>;  
    <span class="comment">//LRU&amp;#x94FE;  </span>
    item_link_q<span class="params">(it)</span>;  
    refcount_incr<span class="params">(&amp;amp;it-&amp;gt;refcount)</span>; <span class="comment">//&amp;#x5F15;&amp;#x7528;&amp;#x6B21;&amp;#x6570;+1  </span>
    mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  

    return <span class="number">1</span>;  
}
</code></pre><p>&#x67E5;&#x8BE2; get &#x64CD;&#x4F5C;</p>
<p>&#x67E5;&#x8BE2;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x770B;&#x4E0B;process_get_command&#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5206;&#x89E3;get&#x547D;&#x4EE4;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;key&#x53BB;HashTable&#x4E0A;&#x627E;&#x5230;item&#x7684;&#x5730;&#x5740;&#x503C;&#x3002;</p>
</li>
<li><p>&#x8FD4;&#x56DE;&#x627E;&#x5230;&#x7684;item&#x6570;&#x636E;&#x503C;&#x3002;</p>
<p> /<em> ntokens is overwritten here… shrug.. </em>/<br> //&#x5904;&#x7406;GET&#x8BF7;&#x6C42;&#x7684;&#x547D;&#x4EE4;<br> static inline void process_get_command(conn <em>c, token_t </em>tokens, size_t ntokens,  </p>
<pre><code>    bool return_cas) {  
//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
char *key;  
size_t nkey;  
int i = <span class="number">0</span>;  
item *it;  
//&amp;amp;tokens[<span class="number">0</span>] &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;amp;tokens[<span class="number">1</span>] &amp;<span class="symbol">#x4E3A</span>;key  
//token_t &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E86</span>;value&amp;<span class="symbol">#x548C</span>;length  
token_t *key_token = &amp;amp;tokens[<span class="class">KEY_TOKEN</span>];  
char *suffix;  
assert(c != <span class="class">NULL</span>);  
do {  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
    while (key_token-&amp;gt;length != <span class="number">0</span>) {  
        key = key_token-&amp;gt;value;  
        nkey = key_token-&amp;gt;length;  
        //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;memcache key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">250</span>  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;  
        if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
            //out_string &amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
            while (i-- &amp;gt; <span class="number">0</span>) {  
                item_remove(*(c-&amp;gt;ilist + i));  
            }  
            return;  
        }  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5FEB</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        it = item_get(key, nkey);  
        if (settings.detail_enabled) {  
            //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
            stats_prefix_record_get(key, nkey, <span class="class">NULL</span> != it);  
        }  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        if (it) {  
            //c-&amp;gt;ilist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;buf  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;ilist&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
            if (i &amp;gt;= c-&amp;gt;isize) {  
                item **new_list = realloc(c-&amp;gt;ilist,  
                        sizeof(item *) * c-&amp;gt;isize * <span class="number">2</span>);  
                if (new_list) {  
                    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
                    c-&amp;gt;isize *= <span class="number">2</span>;  
                    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x652F</span>;&amp;<span class="symbol">#x6301</span>;  
                    c-&amp;gt;ilist = new_list;  
                } else {  
                    <span class="class">STATS_LOCK</span>();  
                    stats.malloc_fails++;  
                    <span class="class">STATS_UNLOCK</span>();  
                    item_remove(it);  
                    break;  
                }  
            }  
            /* 
             * <span class="class">Construct</span> the response. <span class="class">Each</span> hit adds three elements to the 
             * outgoing data <span class="method">list:</span> 
             *   &amp;quot;<span class="class">VALUE</span> &amp;quot; 
             *   key 
             *   &amp;quot; &amp;quot; + flags + &amp;quot; &amp;quot; + data length + &amp;quot;\r\n&amp;quot; + data (with \r\n) 
             */  
            //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
            if (return_cas) {  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                        it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                /* <span class="class">Goofy</span> mid-flight realloc. */  
                if (i &amp;gt;= c-&amp;gt;suffixsize) {  
                    char **new_suffix_list = realloc(c-&amp;gt;suffixlist,  
                            sizeof(char *) * c-&amp;gt;suffixsize * <span class="number">2</span>);  
                    if (new_suffix_list) {  
                        c-&amp;gt;suffixsize *= <span class="number">2</span>;  
                        c-&amp;gt;suffixlist = new_suffix_list;  
                    } else {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        item_remove(it);  
                        break;  
                    }  
                }  
                suffix = cache_alloc(c-&amp;gt;thread-&amp;gt;suffix_cache);  
                if (suffix == <span class="class">NULL</span>) {  
                    <span class="class">STATS_LOCK</span>();  
                    stats.malloc_fails++;  
                    <span class="class">STATS_UNLOCK</span>();  
                    out_of_memory(c,  
                            &amp;quot;<span class="class">SERVER_ERROR</span> out of memory making <span class="class">CAS</span> suffix&amp;quot;);  
                    item_remove(it);  
                    while (i-- &amp;gt; <span class="number">0</span>) {  
                        item_remove(*(c-&amp;gt;ilist + i));  
                    }  
                    return;  
                }  
                *(c-&amp;gt;suffixlist + i) = suffix;  
                int suffix_len = snprintf(suffix, <span class="class">SUFFIX_SIZE</span>, &amp;quot; %llu\r\n&amp;quot;,  
                        (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
                if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_suffix</span>(it), it-&amp;gt;nsuffix - <span class="number">2</span>) != <span class="number">0</span>  
                        || add_iov(c, suffix, suffix_len) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                    item_remove(it);  
                    break;  
                }  
            } else {  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                        it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
                //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>;get userId  
                //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;  
                //<span class="class">VALUE</span> userId <span class="number">0</span> <span class="number">5</span>  
                //<span class="number">55555</span>  
                //<span class="class">END</span>  
                if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_suffix</span>(it),  
                                it-&amp;gt;nsuffix + it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                    item_remove(it);  
                    break;  
                }  
            }  
            if (settings.verbose &amp;gt; <span class="number">1</span>) {  
                int ii;  
                fprintf(stderr, &amp;quot;&amp;gt;%d sending key &amp;quot;, c-&amp;gt;sfd);  
                for (ii = <span class="number">0</span>; ii &amp;lt; it-&amp;gt;nkey; ++ii) {  
                    fprintf(stderr, &amp;quot;%c&amp;quot;, key[ii]);  
                }  
                fprintf(stderr, &amp;quot;\n&amp;quot;);  
            }  
            /* item_get() has incremented it-&amp;gt;refcount for us */  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].get_hits++;  
            c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            item_update(it);  
            *(c-&amp;gt;ilist + i) = it;  
            i++;  
        } else {  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.get_misses++;  
            c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, key, nkey, -<span class="number">1</span>, <span class="number">0</span>);  
        }  
        key_token++;  
    }  
    /* 
     * <span class="class">If</span> the command string hasn&amp;apos;t been fully processed, get the next set 
     * of tokens. 
     */  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;get&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    if (key_token-&amp;gt;value != <span class="class">NULL</span>) {  
        ntokens = tokenize_command(key_token-&amp;gt;value, tokens, <span class="class">MAX_TOKENS</span>);  
        key_token = tokens;  
    }  
} while (key_token-&amp;gt;value != <span class="class">NULL</span>);  
c-&amp;gt;icurr = c-&amp;gt;ilist;  
c-&amp;gt;ileft = i;  
if (return_cas) {  
    c-&amp;gt;suffixcurr = c-&amp;gt;suffixlist;  
    c-&amp;gt;suffixleft = i;  
}  
if (settings.verbose &amp;gt; <span class="number">1</span>)  
    fprintf(stderr, &amp;quot;&amp;gt;%d <span class="class">END</span>\n&amp;quot;, c-&amp;gt;sfd);  
/* 
 <span class="class">If</span> the loop was terminated because of out-of-memory, it is not 
 reliable to add <span class="class">END</span>\r\n to the buffer, because it might not end 
 in \r\n. <span class="class">So</span> we send <span class="class">SERVER_ERROR</span> instead. 
 */  
//&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x675F</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;  
if (key_token-&amp;gt;value != <span class="class">NULL</span> || add_iov(c, &amp;quot;<span class="class">END</span>\r\n&amp;quot;, <span class="number">5</span>) != <span class="number">0</span>  
        || (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>)) {  
    out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory writing get response&amp;quot;);  
} else {  
    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x3002</span>;  
    conn_set_state(c, conn_mwrite);  
    c-&amp;gt;msgcurr = <span class="number">0</span>;  
}  
</code></pre><p> }</p>
</li>
</ol>
<p>Memcached&#x7684;&#x67E5;&#x8BE2;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;HashTable&#x6765;&#x67E5;&#x8BE2;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x3002;</p>
<p>HashTable&#x6211;&#x4EEC;&#x5728;&#x4E0A;&#x4E00;&#x7AE0;&#x5DF2;&#x7ECF;&#x8BB2;&#x8FC7;&#x3002;&#x524D;&#x9762;&#x4E5F;&#x8BB2;&#x8FC7;&#xFF0C;&#x5F53;&#x7F13;&#x5B58;&#x6570;&#x636E;SET&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#xFF0C;Memcached&#x4F1A;&#x5C06;item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5173;&#x8054;&#x5230;HashTable&#x548C;&#x5B83;&#x7684;LRU&#x7684;&#x94FE;&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;item_*&amp;<span class="symbol">#x7CFB</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x6838</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53E3</span>;  
item *item_get(const char *key, const size_t nkey) {  
    item *it;  
    uint32_t hv;  
    hv = hash(key, nkey); //&amp;<span class="symbol">#x5BF9</span>;key&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;hash,&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;uint32_t&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
    item_lock(hv); //&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4ED6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6027</span>;  
    it = do_item_get(key, nkey, hv);  
    item_unlock(hv);  
    return it;  
}
</code></pre><p>&#x8FD9;&#x8FB9;&#x7740;&#x91CD;&#x770B;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;&#x4ECE;HashTable&#x4E0A;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;Item&#x5730;&#x5740;&#x503C;&#x3002;</p>
<pre><code><span class="comment">/** wrapper around assoc_find which does the lazy expiration logic */</span>  
<span class="keyword">item</span> *do_item_get(const <span class="keyword">char</span> *key, const size_t nkey, const uint32_t hv) {  
   <span class="comment"> //mutex_lock(&amp;amp;cache_lock);  </span>
   <span class="comment"> //&amp;#x5728;HashTable&amp;#x4E0A;&amp;#x627E;Item  </span>
    <span class="keyword">item</span> *<span class="keyword">it</span> = assoc_find(key, nkey, hv);  
    <span class="keyword">if</span> (<span class="keyword">it</span> != <span class="constant">NULL</span>) {  
        refcount_incr(&amp;amp;<span class="keyword">it</span>-&amp;gt;refcount);  
        <span class="comment">/* Optimization for slab reassignment. prevents popular items from 
         * jamming in busy wait. Can only do this here to satisfy lock order 
         * of item_lock, cache_lock, slabs_lock. */</span>  
        <span class="keyword">if</span> (slab_rebalance_signal &amp;amp;&amp;amp;  
            ((void *)<span class="keyword">it</span> &amp;gt;= slab_rebal.slab_start &amp;amp;&amp;amp; (void *)<span class="keyword">it</span> &amp;lt; slab_rebal.slab_end)) {  
            do_item_unlink_nolock(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
        }  
    }  
   <span class="comment"> //mutex_unlock(&amp;amp;cache_lock);  </span>
    int was_found = <span class="number">0</span>;  
    <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">2</span>) {  
        int ii;  
        <span class="keyword">if</span> (<span class="keyword">it</span> == <span class="constant">NULL</span>) {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;&amp;gt; NOT FOUND &amp;quot;);  
        } <span class="keyword">else</span> {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;&amp;gt; FOUND KEY &amp;quot;);  
            was_found++;  
        }  
        <span class="keyword">for</span> (ii = <span class="number">0</span>; ii &amp;lt; nkey; ++ii) {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;%c&amp;quot;, key[ii]);  
        }  
    }  
    <span class="keyword">if</span> (<span class="keyword">it</span> != <span class="constant">NULL</span>) {  
        <span class="keyword">if</span> (settings.oldest_live != <span class="number">0</span> &amp;amp;&amp;amp; settings.oldest_live &amp;lt;= current_time &amp;amp;&amp;amp;  
            <span class="keyword">it</span>-&amp;gt;<span class="built_in">time</span> &amp;lt;= settings.oldest_live) {  
            do_item_unlink(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
            <span class="keyword">if</span> (was_found) {  
                fprintf(<span class="keyword">stderr</span>, &amp;quot; -nuked <span class="keyword">by</span> flush&amp;quot;);  
            }  
       <span class="comment"> //&amp;#x68C0;&amp;#x67E5;&amp;#x662F;&amp;#x5426;&amp;#x8FC7;&amp;#x671F;  </span>
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">it</span>-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; <span class="keyword">it</span>-&amp;gt;exptime &amp;lt;= current_time) {  
            do_item_unlink(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
            <span class="keyword">if</span> (was_found) {  
                fprintf(<span class="keyword">stderr</span>, &amp;quot; -nuked <span class="keyword">by</span> expire&amp;quot;);  
            }  
        } <span class="keyword">else</span> {  
            <span class="keyword">it</span>-&amp;gt;it_flags |= ITEM_FETCHED;  
            DEBUG_REFCNT(<span class="keyword">it</span>, &amp;apos;+&amp;apos;);  
        }  
    }  
    <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">2</span>)  
        fprintf(<span class="keyword">stderr</span>, &amp;quot;\n&amp;quot;);  
    <span class="constant">return</span> <span class="keyword">it</span>;  
}
</code></pre><p>&#x5220;&#x9664; delete &#x64CD;&#x4F5C;</p>
<p>&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x770B;process_delete_command&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li><p>&#x5148;&#x67E5;&#x8BE2;item&#x662F;&#x5426;&#x5B58;&#x5728;</p>
</li>
<li><p>&#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#x5220;&#x9664;item&#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;NOT FOUND</p>
<p> static void process_delete_command(conn <em>c, token_t </em>tokens,  </p>
<pre><code>    const size_t ntokens) {  
char *key;  
size_t nkey;  
item *it;  
assert(c != <span class="class">NULL</span>);  
//&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6027</span>;  
if (ntokens &amp;gt; <span class="number">3</span>) {  
    bool hold_is_zero = strcmp(tokens[<span class="class">KEY_TOKEN</span> + <span class="number">1</span>].value, &amp;quot;<span class="number">0</span>&amp;quot;) == <span class="number">0</span>;  
    bool sets_noreply = set_noreply_maybe(c, tokens, ntokens);  
    bool valid = (ntokens == <span class="number">4</span> &amp;amp;&amp;amp; (hold_is_zero || sets_noreply))  
            || (ntokens == <span class="number">5</span> &amp;amp;&amp;amp; hold_is_zero &amp;amp;&amp;amp; sets_noreply);  
    if (!valid) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format.  &amp;quot;  
                &amp;quot;<span class="class">Usage</span>: delete &amp;lt;key&amp;gt; [noreply]&amp;quot;);  
        return;  
    }  
}  
//&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
key = tokens[<span class="class">KEY_TOKEN</span>].value;  
nkey = tokens[<span class="class">KEY_TOKEN</span>].length;  
if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
    out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
    return;  
}  
if (settings.detail_enabled) {  
    stats_prefix_record_delete(key, nkey);  
}  
//&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT</span> <span class="class">FOUND</span>  
it = item_get(key, nkey);  
if (it) {  
    <span class="class">MEMCACHED_COMMAND_DELETE</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey);  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].delete_hits++;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;<span class="class">Item</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;<span class="class">Item</span>  
    item_unlink(it);  
    item_remove(it); /* release our reference */  
    out_string(c, &amp;quot;<span class="class">DELETED</span>&amp;quot;);  
} else {  
    //&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.delete_misses++;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    out_string(c, &amp;quot;<span class="class">NOT_FOUND</span>&amp;quot;);  
}  
</code></pre><p> }</p>
</li>
</ol>
<p>item_unlink&#x548C;do_item_unlink&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4E24;&#x4E2A;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x4ECE;HashTable&#x4E0A;&#x5C06;Item&#x7684;&#x5730;&#x5740;&#x503C;&#x5220;&#x9664;</p>
</li>
<li><p>&#x4ECE;LRU&#x7684;&#x94FE;&#x8868;&#x4E0A;&#xFF0C;&#x5C06;Item&#x7684;&#x5730;&#x5740;&#x503C;&#x5220;&#x9664;&#xFF08;LRU&#x94FE;&#x8868;&#x53EA;&#x8981;&#x5904;&#x7406;&#x5934;&#x90E8;&#x548C;&#x5C3E;&#x90E8;&#x5C31;&#x884C;&#x4E86;&#xFF09;</p>
<p> //&#x4ECE;LRU&#x548C;HashTable&#x89E3;&#x7ED1;<br> void item_unlink(item *item) {  </p>
<pre><code>uint32_t hv<span class="comment">;  </span>
hv = hash<span class="list">(<span class="keyword">ITEM_key</span><span class="list">(<span class="keyword">item</span>)</span>, item-&amp;gt<span class="comment">;nkey);  </span>
item_lock<span class="list">(<span class="keyword">hv</span>)</span><span class="comment">;  </span>
do_item_unlink<span class="list">(<span class="keyword">item</span>, hv)</span><span class="comment">;  </span>
item_unlock<span class="list">(<span class="keyword">hv</span>)</span><span class="comment">;  </span></span>
</code></pre><p> }</p>
</li>
</ol>
<p>item_remove&#x4E3B;&#x8981;&#x662F;&#x91CA;&#x653E;item</p>
<pre><code><span class="comment">//&amp;#x5220;&amp;#x9664;Item  </span>
void item_remove<span class="params">(item *item)</span> {  
    uint32_t hv;  
    hv = hash<span class="params">(ITEM_key<span class="params">(item)</span>, item-&amp;gt;nkey)</span>; <span class="comment">//Hash&amp;#x503C;  </span>

    item_lock<span class="params">(hv)</span>;  
    do_item_remove<span class="params">(item)</span>;  
    item_unlock<span class="params">(hv)</span>;  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/48/">48</a><a class="extend next" rel="next" href="/page/4/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>472</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>73</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>61</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>52</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>30</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>25</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>22</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>22</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Mac-OS-X/" title="Mac OS X">Mac OS X<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Ubuntu/" title="Ubuntu">Ubuntu<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Kafka/" title="Kafka">Kafka<sup>7</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
