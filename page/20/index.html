
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/20/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/19b0f14/" title="nginx+lua+memcache实现灰度发布 -" itemprop="url">nginx+lua+memcache实现灰度发布 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="&#x4E00;&#x3001;&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x539F;&#x7406;&#x8BF4;&#x660E;">&#x4E00;&#x3001;&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x539F;&#x7406;&#x8BF4;&#x660E;</h4><p>&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x5728;&#x767E;&#x5EA6;&#x767E;&#x79D1;&#x4E2D;&#x89E3;&#x91CA;&#xFF1A;</p>
<p>&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x662F;&#x6307;&#x5728;&#x9ED1;&#x4E0E;&#x767D;&#x4E4B;&#x95F4;&#xFF0C;&#x80FD;&#x591F;&#x5E73;&#x6ED1;&#x8FC7;&#x6E21;&#x7684;&#x4E00;&#x79CD;&#x53D1;&#x5E03;&#x65B9;&#x5F0F;&#x3002;AB test&#x5C31;&#x662F;&#x4E00;&#x79CD;&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x65B9;&#x5F0F;&#xFF0C;&#x8BA9;&#x4E00;&#x90E8;&#x5206;&#x7528;&#x6237;&#x7EE7;&#x7EED;&#x7528;A&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x7528;&#x6237;&#x5F00;&#x59CB;&#x7528;B&#xFF0C;&#x5982;&#x679C;&#x7528;&#x6237;&#x5BF9;B&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x53CD;&#x5BF9;&#x610F;&#x89C1;&#xFF0C;&#x90A3;&#x4E48;&#x9010;&#x6B65;&#x6269;&#x5927;&#x8303;&#x56F4;&#xFF0C;&#x628A;&#x6240;&#x6709;&#x7528;&#x6237;&#x90FD;&#x8FC1;&#x79FB;&#x5230;B&#x4E0A;&#x9762; &#x6765;&#x3002;&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x6574;&#x4F53;&#x7CFB;&#x7EDF;&#x7684;&#x7A33;&#x5B9A;&#xFF0C;&#x5728;&#x521D;&#x59CB;&#x7070;&#x5EA6;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x3001;&#x8C03;&#x6574;&#x95EE;&#x9898;&#xFF0C;&#x4EE5;&#x4FDD;&#x8BC1;&#x5176;&#x5F71;&#x54CD;&#x5EA6;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x7684;&#x7528;&#x4E8E;WEB&#x7CFB;&#x7EDF;&#x65B0;&#x4EE3;&#x7801;&#x7684;&#x6D4B;&#x8BD5;&#x53D1;&#x5E03;&#xFF0C;&#x8BA9;&#x4E00;&#x90E8;&#x5206;&#xFF08;IP&#xFF09;&#x7528;&#x6237;&#x8BBF;&#x95EE;&#x65B0;&#x7248;&#x672C;&#xFF0C;&#x4E00;&#x90E8;&#x5206;&#x7528;&#x6237;&#x4ECD;&#x7136;&#x8BBF;&#x95EE;&#x6B63;&#x5E38;&#x7248;&#x672C;&#xFF0C;&#x5176;&#x539F;&#x7406;&#x5982;&#x56FE;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/19aea75.jpg" alt=""></p>
<p>&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>1&#x3001;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5F53;&#x7528;&#x6237;&#x8BF7;&#x6C42;&#x5230;&#x8FBE;&#x524D;&#x7AEF;&#x4EE3;&#x7406;&#x670D;&#x52A1;Nginx&#xFF0C;&#x5185;&#x5D4C;&#x7684;lua&#x6A21;&#x5757;&#x89E3;&#x6790;Nginx&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;lua&#x811A;&#x672C;&#x4EE3;&#x7801;&#xFF1B;</p>
<p>2&#x3001;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Lua&#x53D8;&#x91CF;&#x83B7;&#x5F97;&#x5BA2;&#x6237;&#x7AEF;IP&#x5730;&#x5740;&#xFF0C;&#x53BB;&#x67E5;&#x8BE2;memcached&#x7F13;&#x5B58;&#x5185;&#x662F;&#x5426;&#x6709;&#x8BE5;&#x952E;&#x503C;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x8FD4;&#x56DE;&#x503C;&#x6267;&#x884C;@client_test&#xFF0C;&#x5426;&#x5219;&#x6267;&#x884C;@client&#x3002;</p>
<p>3&#x3001;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Location @client_test&#x628A;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9;&#x90E8;&#x7F72;&#x4E86;new&#x7248;&#x4EE3;&#x7801;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;location @client&#x628A;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9;&#x90E8;&#x7F72;&#x4E86;normal&#x7248;&#x4EE3;&#x7801;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x3002;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x5B8C;&#x6210;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x628A;&#x5B89;&#x88C5;&#x914D;&#x7F6E;&#x8FC7;&#x7A0B;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</p>
<h4 id="&#x4E8C;&#x3001;&#x5B89;&#x88C5;&#x914D;&#x7F6E;&#x8FC7;&#x7A0B;&#x8BE6;&#x89E3;">&#x4E8C;&#x3001;&#x5B89;&#x88C5;&#x914D;&#x7F6E;&#x8FC7;&#x7A0B;&#x8BE6;&#x89E3;</h4><p>1&#x3001;&#x5B89;&#x88C5;nginx</p>
<p>&#x5B89;&#x88C5;&#x4F9D;&#x8D56;&#x5305;</p>
<p><img src="http://taojinke.github.io/img/20150703/19aea75.gif" alt=""></p>
<pre><code>yum -y <span class="operator"><span class="keyword">install</span> gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers make pcre-devel

yum -y <span class="keyword">install</span> gd gd2 gd-devel gd2-devel lua lua-devel

yum &amp;#x2013;</span>y <span class="operator"><span class="keyword">install</span> memcached</span>
</code></pre><p><img src="http://taojinke.github.io/img/20150703/19aece6.gif" alt=""></p>
<p>&#x4E0B;&#x8F7D;lua&#x6A21;&#x5757;&#x3001;lua-memcache&#x64CD;&#x4F5C;&#x5E93;&#x6587;&#x4EF6;&#x548C;nginx&#x5305;</p>
<p><img src="http://taojinke.github.io/img/20150703/19aece6.gif" alt=""></p>
<pre><code>wget <span class="string">https:</span><span class="comment">//github.com/simpl/ngx_devel_kit/archive/v0.2.18.tar.gz</span>

wget <span class="string">https:</span><span class="comment">//github.com/chaoslawful/lua-nginx-module/archive/v0.8.5.tar.gz</span>

wget <span class="string">https:</span><span class="comment">//github.com/agentzh/lua-resty-memcached/archive/v0.11.tar.gz</span>

wget <span class="string">http:</span><span class="comment">//nginx.org/download/nginx-1.4.2.tar.gz</span>

tar xvf nginx-<span class="number">1.4</span>.2.tar.gz

cd nginx-<span class="number">1.4</span>.2/

.<span class="regexp">/configure --prefix=/</span>soft<span class="regexp">/nginx/</span> --with-http_gzip_static_module --add-module=<span class="regexp">/root/</span>ngx_devel_kit-<span class="number">0.2</span>.18<span class="regexp">/  --add-module=/</span>root<span class="regexp">/lua-nginx-module-0.8.5/</span>

make

make install
</code></pre><p><img src="http://taojinke.github.io/img/20150703/19aef57.gif" alt=""></p>
<p>&#x62F7;&#x8D1D;lua&#x7684;memcached&#x64CD;&#x4F5C;&#x5E93;&#x6587;&#x4EF6;</p>
<pre><code>tar xvf v0.<span class="number">11</span>.tar.gz

cp -r lua-resty-memcached-<span class="number">0.11</span><span class="regexp">/lib/</span>resty<span class="regexp">/ /u</span>sr<span class="regexp">/lib64/</span>lua<span class="regexp">/5.1/</span>
</code></pre><p>&#x914D;&#x7F6E;nginx</p>
<p><img src="http://taojinke.github.io/img/20150703/19af1c8.gif" alt=""></p>
<pre><code>#vim /soft/nginx/conf/nginx.conf
worker_processes  1<span class="comment">;</span>
events {
    worker_connections  1024<span class="comment">;</span>
}
http {
    include       mime.types<span class="comment">;</span>
    default_type  application/octet-stream<span class="comment">;</span>
    sendfile        on<span class="comment">;</span>
    keepalive_timeout  65<span class="comment">;</span>
    proxy_next_upstream     error timeout<span class="comment">;</span>
    proxy_redirect          off<span class="comment">;</span>
    proxy_set_header        Host $host<span class="comment">;</span>
    proxy_set_header        X-Real-IP $http_x_forwarded_for<span class="comment">;</span>
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for<span class="comment">;</span>
    client_max_body_size    100m<span class="comment">;</span>
    client_body_buffer_size 256k<span class="comment">;</span>
    proxy_connect_timeout   180<span class="comment">;</span>
    proxy_send_timeout      180<span class="comment">;</span>
    proxy_read_timeout      180<span class="comment">;</span>
    proxy_buffer_size       8k<span class="comment">;</span>
    proxy_buffers           8 64k<span class="comment">;</span>
    proxy_busy_buffers_size 128k<span class="comment">;</span>
    proxy_temp_file_write_size 128k<span class="comment">;</span>
     upstream client {
        server   <span class="number">192.168.200.29</span>:80<span class="comment">;</span>
    }
    upstream client_test {
        server   <span class="number">192.168.200.29</span>:81<span class="comment">;</span>
    }
    server {
        listen       80<span class="comment">;</span>
        server_name  localhost<span class="comment">;</span>
       location / {
       content_by_lua &amp;apos<span class="comment">;</span>
            clientIP = ngx.req.get_headers()[&amp;quot<span class="comment">;X-Real-IP&amp;quot;]</span>
            if clientIP == nil then
                clientIP = ngx.req.get_headers()[&amp;quot<span class="comment">;x_forwarded_for&amp;quot;]</span>
            end
            if clientIP == nil then
                clientIP = ngx.var.remote_addr
            end
                local memcached = require &amp;quot<span class="comment">;resty.memcached&amp;quot;</span>
                local memc, err = memcached:new()
                if not memc then
                    ngx.say(&amp;quot<span class="comment">;failed to instantiate memc: &amp;quot;, err)</span>
                    return
                end
                local ok, err = memc:connect(&amp;quot<span class="comment">;127.0.0.1&amp;quot;, 11211)</span>
                if not ok then
                    ngx.say(&amp;quot<span class="comment">;failed to connect: &amp;quot;, err)</span>
                    return
                end
                local res, flags, err = memc:get(clientIP)
                if err then
                    ngx.say(&amp;quot<span class="comment">;failed to get clientIP &amp;quot;, err)</span>
                    return
                end
                if  res == &amp;quot<span class="comment">;1&amp;quot; then</span>
                    ngx.exec(&amp;quot<span class="comment">;@client_test&amp;quot;)</span>
                    return
                end
                 ngx.exec(&amp;quot<span class="comment">;@client&amp;quot;)</span>
               &amp;apos<span class="comment">;;</span>
       }
       location @client{
           proxy_pass http://client<span class="comment">;</span>
       }
       location @client_test{
           proxy_pass http://client_test<span class="comment">;</span>
       }
    location /hello {
        default_type &amp;apos<span class="comment">;text/plain&amp;apos;;</span>
        content_by_lua &amp;apos<span class="comment">;ngx.say(&amp;quot;hello, lua&amp;quot;)&amp;apos;;</span>
    }
    location = /50x.html {
        root   html<span class="comment">;</span>
    }
   }
}
</code></pre><p><img src="http://taojinke.github.io/img/20150703/19af439.gif" alt=""></p>
<p>&#x68C0;&#x6D4B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<pre><code>#<span class="regexp">/soft/</span>nginx<span class="regexp">/sbin/</span>nginx -t

nginx: the configuration <span class="keyword">file</span> <span class="regexp">/soft/</span>nginx<span class="regexp">/conf/</span>nginx.conf syntax is ok

nginx: configuration <span class="keyword">file</span> <span class="regexp">/soft/</span>nginx<span class="regexp">/conf/</span>nginx.conf test is successful
</code></pre><p>&#x542F;&#x52A8;nginx</p>
<pre><code><span class="regexp">/soft/</span>nginx<span class="regexp">/sbin/</span>nginx
</code></pre><p>&#x542F;&#x52A8;memcached&#x670D;&#x52A1;</p>
<pre><code>memcached -<span class="keyword">u</span> nobody -<span class="keyword">m</span> 1024 -c 2048 -p 11211 &amp;#x2013;<span class="literal">d</span>
</code></pre><p>&#x4E09;&#x3001;&#x6D4B;&#x8BD5;&#x9A8C;&#x8BC1;</p>
<p>&#x6D4B;&#x8BD5;lua&#x6A21;&#x5757;&#x662F;&#x5426;&#x8FD0;&#x884C;&#x6B63;&#x5E38;</p>
<p>&#x8BBF;&#x95EE;<a href="http://&#x6D4B;&#x8BD5;&#x670D;&#x52A1;&#x5668;ip&#x5730;&#x5740;/hello&#x3002;&#x5982;&#x679C;&#x663E;&#x793A;&#xFF1A;hello&#xFF0C;lua" target="_blank" rel="external">http://&#x6D4B;&#x8BD5;&#x670D;&#x52A1;&#x5668;ip&#x5730;&#x5740;/hello&#x3002;&#x5982;&#x679C;&#x663E;&#x793A;&#xFF1A;hello&#xFF0C;lua</a> &#x8868;&#x793A;&#x5B89;&#x88C5;&#x6210;&#x529F;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19af6aa.jpg" alt=""></p>
<p>&#x5728;&#x53E6;&#x4E00;&#x53F0;&#x6D4B;&#x8BD5;&#x673A;(&#x8FD9;&#x91CC;&#x662F;192.168.200.29)&#x8BBE;&#x7F6E;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x4E3B;&#x673A;&#xFF0C;&#x4E00;&#x4E2A;&#x7528;80&#x7AEF;&#x53E3;&#x662F;&#x6267;&#x884C;&#x6B63;&#x5E38;&#x4EE3;&#x7801;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;81&#x7AEF;&#x53E3;&#x6267;&#x884C;&#x7070;&#x5EA6;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x5728;memcached&#x4E2D;&#x4EE5;&#x4F60;&#x7684;&#x5BA2;&#x6237;&#x673A;IP&#x5730;&#x5740;&#x4E3A;key&#xFF0C;value&#x503C;&#x4E3A;1&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x7684;IP&#x662F;192.168.68.211.</p>
<p><img src="http://taojinke.github.io/img/20150703/19af91b.gif" alt=""></p>
<pre><code><span class="tag">telnet</span> <span class="tag">localhost</span> 11211

<span class="rule"><span class="attribute">Trying </span>:<span class="value">:<span class="number">1</span>...

Connected to localhost.

Escape character is &amp;apos</span></span>;^]&amp;<span class="tag">apos</span>;.

<span class="tag">set</span> 192<span class="class">.168</span><span class="class">.68</span><span class="class">.211</span> 0 3600 1

1

<span class="tag">STORED</span>

<span class="tag">get</span> 192<span class="class">.168</span><span class="class">.68</span><span class="class">.211</span>

<span class="tag">VALUE</span> 192<span class="class">.168</span><span class="class">.68</span><span class="class">.211</span> 9 1

1

<span class="tag">END</span>

<span class="tag">quit</span>
</code></pre><p><img src="http://taojinke.github.io/img/20150703/19afb8c.gif" alt=""></p>
<p>&#x6CE8;&#x610F;&#xFF1A;</p>
<p>set&#x540E;&#x7B2C;&#x4E00;&#x4E2A;&#x503C;&#x4E3A;key&#x503C;&#x3002;</p>
<p>192.168.68.211&#x8FD9;&#x662F;key&#x503C;&#x662F;&#x9700;&#x8981;&#x7070;&#x5EA6;&#x6D4B;&#x8BD5;&#x7684;IP&#x5730;&#x5740;&#xFF1B;</p>
<p>0 &#x8868;&#x793A;&#x4E00;&#x4E2A;&#x8DDF;&#x8BE5;key&#x6709;&#x5173;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#xFF1B;</p>
<p>3600 &#x8868;&#x793A;&#x8BE5;key&#x503C;&#x7684;&#x6709;&#x6548;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>1 &#x8868;&#x793A;key&#x6240;&#x5BF9;&#x5E94;&#x7684;value&#x503C;&#x7684;&#x5B57;&#x8282;&#x6570;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x8BBF;&#x95EE;Nginx&#xFF0C;&#x6548;&#x679C;&#x7B26;&#x5408;&#x9884;&#x671F;&#xFF0C;&#x6211;&#x7684;IP&#x5DF2;&#x7ECF;&#x5728;memcached&#x4E2D;&#x5B58;&#x50A8;&#x503C;&#xFF0C;&#x6240;&#x4EE5;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9;&#x6267;&#x884C;&#x7070;&#x5EA6;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;&#x7684;&#x4E3B;&#x673A;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19afb8c.jpg" alt=""></p>
<p>&#x4ECE;memcached&#x5220;&#x9664;&#x6211;&#x7684;&#x4E3B;&#x673A;IP&#x503C;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19afdfd.jpg" alt=""></p>
<p>&#x518D;&#x6B21;&#x8BF7;&#x6C42;Nginx&#xFF0C;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9;&#x6267;&#x884C;&#x6B63;&#x5E38;&#x4EE3;&#x7801;&#x5185;&#x5BB9;&#x7684;&#x4E3B;&#x673A;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19afdfd.jpg" alt=""></p>
<p>&#x6574;&#x4E2A;&#x914D;&#x7F6E;&#x5E76;&#x4E0D;&#x590D;&#x6742;&#xFF0C;&#x6574;&#x4E2A;&#x5224;&#x65AD;&#x8FC7;&#x7A0B;&#x5BF9;&#x670D;&#x52A1;&#x7684;&#x5F71;&#x54CD;&#x975E;&#x5E38;&#x5C0F;&#x3002;&#x5982;&#x679C;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x6700;&#x597D;&#x81EA;&#x5DF1;&#x770B;&#x770B;lua&#x811A;&#x672C;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Lua/">Lua</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Nginx/">Nginx</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/19a46e2/" title="Linux下搭建Memcached缓存系统 -" itemprop="url">Linux下搭建Memcached缓存系统 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x9996;&#x5148;&#x8BF4;&#x4E0B;&#x62B1;&#x6B49;&#xFF0C;&#x535A;&#x4E3B;&#x6700;&#x8FD1;&#x5355;&#x4F4D;&#x7ECF;&#x5E38;&#x52A0;&#x73ED;&#xFF0C;&#x535A;&#x5BA2;&#x66F4;&#x65B0;&#x6709;&#x70B9;&#x6162;&#xFF0C;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x7406;&#x89E3;&#xFF0C;&#x8349;&#x7A3F;&#x7BB1;&#x91CC;&#x5B58;&#x4E86;&#x4E0D;&#x5C11;&#x5185;&#x5BB9;&#xFF0C;&#x7B49;&#x4E0D;&#x5FD9;&#x65F6;&#x5019;&#x4E00;&#x70B9;&#x70B9;&#x586B;&#x5751;~</p>
<p>&#x5728;&#x4E00;&#x822C;&#x7684;&#x7F51;&#x7AD9;&#x5F00;&#x53D1;&#x5B66;&#x4E60;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x4F1A;&#x628A;&#x6570;&#x636E;&#x5B58;&#x653E;&#x5728;RDBMS&#xFF08;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#x7CFB;&#x7EDF;(Relational Database Management System&#xFF09;&#x4E2D;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x901A;&#x8FC7;&#x8BFB;&#x53D6;RDBMS&#x6765;&#x53D6;&#x5F97;&#x6570;&#x636E;&#x663E;&#x793A;&#x5728;&#x9875;&#x9762;&#x4E0A;&#x3002;&#x8FD9;&#x5728;&#x6211;&#x4EEC;&#x4EE5;&#x5F80;&#x7F16;&#x5199;&#x7EC3;&#x4E60;&#x9879;&#x76EE;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x95EE;&#x9898;&#x7684;&#x3002;&#x6839;&#x636E;&#x6728;&#x6876;&#x7406;&#x8BBA;&#xFF0C;&#x4E00;&#x53EA;&#x6C34;&#x6876;&#x80FD;&#x88C5;&#x591A;&#x5C11;&#x6C34;&#x53D6;&#x51B3;&#x4E8E;&#x5B83;&#x6700;&#x77ED;&#x7684;&#x90A3;&#x5757;&#x6728;&#x677F;&#xFF0C;&#x5728;&#x5B9E;&#x9645;&#x7684;&#x7F51;&#x7AD9;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x968F;&#x7740;&#x6570;&#x636E;&#x91CF;&#x7684;&#x589E;&#x5927;&#xFF0C;&#x8BBF;&#x95EE;&#x7684;&#x96C6;&#x4E2D;&#xFF0C;&#x5C31;&#x4F1A;&#x51FA;&#x73B0;RDBMS&#x7684;&#x8D1F;&#x62C5;&#x52A0;&#x91CD;&#x3001;&#x6570;&#x636E;&#x5E93;&#x54CD;&#x5E94;&#x6076;&#x5316;&#x3001; &#x7F51;&#x7AD9;&#x663E;&#x793A;&#x5EF6;&#x8FDF;&#x7B49;&#x91CD;&#x5927;&#x5F71;&#x54CD;&#x3002;</p>
<p>&#x8FD9;&#x65F6;&#x5019;&#x5C31;&#x8F6E;&#x5230;Memcached&#x5927;&#x663E;&#x8EAB;&#x624B;&#x4E86;&#xFF0C;&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF0C;Memcached&#x662F;&#x4E00;&#x5957;&#x901A;&#x8FC7;&#x5185;&#x5B58;&#x5B9E;&#x73B0;&#x7684;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x800C;&#x4E14;&#x5B83;&#x5B9E;&#x73B0;&#x4E86;&#x5206;&#x5E03;&#x5F0F;&#x5B58;&#x50A8;&#x3002;&#x4E00;&#x822C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;Memcached&#x7684;&#x76EE;&#x7684;&#xFF0C;&#x662F;&#x901A;&#x8FC7;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#xFF0C;&#x51CF;&#x5C11;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x7F51;&#x7AD9;&#x6027;&#x80FD;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19a1d61.jpg" alt=""></p>
<p>&#x8BD5;&#x60F3;&#x4E00;&#x4E0B;&#x8FD9;&#x4E48;&#x4E2A;&#x60C5;&#x51B5;&#xFF0C;&#x6211;&#x4EEC;&#x5E73;&#x5E38;&#x4E0A;&#x7684;&#x6DD8;&#x5B9D;&#x7F51;&#xFF0C;&#x9996;&#x9875;&#x91CC;&#x9762;&#x6709;&#x5546;&#x54C1;&#x5206;&#x7C7B;&#x3001;&#x5546;&#x54C1;&#x54C1;&#x724C;&#x3001;&#x70ED;&#x9500;&#x5546;&#x54C1;&#x3001;&#x5404;&#x79CD;&#x6D3B;&#x52A8;&#x7684;&#x5C55;&#x793A;&#x3002;&#x5728;&#x4E0D;&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x8BBF;&#x95EE;&#x9996;&#x9875;&#xFF0C;&#x9700;&#x8981;&#x5230;RDBMS&#x4E2D;&#x67E5;&#x8BE2;&#x5206;&#x7C7B;&#x3001;&#x54C1;&#x724C;&#x3001;&#x70ED;&#x9500;&#x3001;&#x6D3B;&#x52A8;&#x7B49;&#x6570;&#x5341;&#x5F20;&#x8868;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x7F51;&#x7AD9;&#x54CD;&#x5E94;&#x7F13;&#x6162;&#x3002;&#x5176;&#x5B9E;&#x8FD9;&#x4E9B;&#x9996;&#x9875;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x6BCF;&#x5929;&#x7684;&#x53D8;&#x5316;&#x4E0D;&#x662F;&#x5F88;&#x9891;&#x7E41;&#xFF0C;&#x5BF9;&#x5B9E;&#xFFFD;&#xFFFD;&#xFFFD;&#x6027;&#x7684;&#x8981;&#x6C42;&#x4E0D;&#x662F;&#x5F88;&#x9AD8;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BA9;&#x6BCF;&#x6B21;&#x8BBF;&#x95EE;&#x9996;&#x9875;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7A0B;&#x5E8F;&#x4ECE;&#x7F13;&#x5B58;&#x4E2D;&#x8BFB;&#x53D6;&#x9996;&#x9875;&#x9700;&#x8981;&#x5C55;&#x793A;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4ECE;&#x800C;&#x51CF;&#x5C11;&#x5BF9;RDBMS&#x7684;&#x538B;&#x529B;&#x3002;&#x5047;&#x8BBE;&#x539F;&#x672C;&#x6BCF;&#x79D2;&#x8BBF;&#x95EE;&#x4E00;&#x6B21;&#xFF0C;&#x73B0;&#x5728;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7F13;&#x5B58;&#xFF0C;&#x7F13;&#x5B58;&#x6BCF;5&#x5206;&#x949F;&#x5237;&#x65B0;&#xFF0C;&#x90A3;&#x4E48;&#x5BF9;RDBMS&#x7684;&#x8BBF;&#x95EE;&#x53EA;&#x6709;&#x539F;&#x6765;&#x7684;1/300&#x3002;&#x66F4;&#x4F55;&#x51B5;&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x4E2D;&#xFF0C;&#x7F51;&#x7AD9;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x8FDC;&#x8FDC;&#x4E0D;&#x6B62;&#x6BCF;&#x79D2;&#x4E00;&#x6B21;&#xFF0C;&#x5373;&#x4F7F;&#x6BCF;&#x79D2;10&#x6B21;&#x3001;100&#x6B21;&#xFF0C;&#x5BF9;&#x4E8E;RDBMS&#x7684;&#x8BBF;&#x95EE;&#x90FD;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#x3002;</p>
<p>Memcached&#x867D;&#x7136;&#x79F0;&#x4E3A;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F46;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E76;&#x6CA1;&#x6709;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x529F;&#x80FD;&#x3002;Memcached&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5B8C;&#x5168;&#x662F;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x6839;&#x636E;&#x4FDD;&#x5B58;&#x7684;key&#x6765;&#x51B3;&#x5B9A;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x7684;Memcached&#x670D;&#x52A1;&#x5668;&#x3002;&#x540C;&#x6837;&#xFF0C;&#x53D6;&#x5F97;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x4F1A;&#x6839;&#x636E;key&#x6765;&#x4ECE;&#x4E0D;&#x540C;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x53D6;&#x5F97;&#x6570;&#x636E;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x5C06;&#x4E0D;&#x540C;&#x7684;&#x952E;&#x4FDD;&#x5B58;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x5C31;&#x5B9E;&#x73B0;&#x4E86;Memcached&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x3002; Memcached&#x670D;&#x52A1;&#x5668;&#x589E;&#x591A;&#x540E;&#xFF0C;&#x952E;&#x5C31;&#x4F1A;&#x5206;&#x6563;&#xFF0C;&#x5373;&#x4F7F;&#x4E00;&#x53F0;Memcached&#x670D;&#x52A1;&#x5668;&#x53D1;&#x751F;&#x6545;&#x969C;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F9D;&#x7136;&#x80FD;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x3002;</p>
<p>Memcached&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#x7684;&#x642D;&#x5EFA;&#x5176;&#x5B9E;&#x5341;&#x5206;&#x7B80;&#x5355;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4EE5;Linux&#x4E0B;&#x9762;&#x7684;&#x642D;&#x5EFA;&#x4E3A;&#x4F8B;:&#x7CFB;&#x7EDF;&#x73AF;&#x5883;ubuntu15.04 64&#x4F4D; </p>
<p>&#x5B89;&#x88C5;Memcached&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x53EA;&#x9700;&#x8981;&#x4E00;&#x53E5;&#x547D;&#x4EE4;</p>
<pre><code>sudo apt-<span class="keyword">get</span> install memcached
</code></pre><p>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x542F;&#x52A8;Memcached</p>
<pre><code>memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -p 11211 -<span class="keyword">u</span> root
</code></pre><p>&#x987A;&#x4FBF;&#x8BF4;&#x4E0B;memcached&#x7684;&#x542F;&#x52A8;&#x53C2;&#x6570;</p>
<p>-d &#x9009;&#x9879;&#x662F;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;</p>
<p>-m &#x662F;&#x5206;&#x914D;&#x7ED9;Memcache&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x6570;&#x91CF;&#xFF0C;&#x5355;&#x4F4D;&#x662F;MB&#xFF0C;&#x8FD9;&#x91CC;&#x662F;128MB&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;64MB</p>
<p>-u &#x662F;&#x8FD0;&#x884C;Memcache&#x7684;&#x7528;&#x6237;&#xFF0C;&#x8FD9;&#x91CC;&#x662F;root</p>
<p>-l &#x662F;&#x76D1;&#x542C;&#x7684;&#x670D;&#x52A1;&#x5668;IP&#x5730;&#x5740;&#xFF0C;&#x9ED8;&#x8BA4;&#x5E94;&#x8BE5;&#x662F;&#x672C;&#x673A;</p>
<p>-p &#x662F;&#x8BBE;&#x7F6E;Memcache&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;11211&#xFF0C;&#x6700;&#x597D;&#x662F;1024&#x4EE5;&#x4E0A;&#x7684;&#x7AEF;&#x53E3;</p>
<p>-c &#x9009;&#x9879;&#x662F;&#x6700;&#x5927;&#x8FD0;&#x884C;&#x7684;&#x5E76;&#x53D1;&#x8FDE;&#x63A5;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1024&#xFF0C;&#x8FD9;&#x91CC;&#x8BBE;&#x7F6E;&#x4E86;10240&#xFF0C;&#x6309;&#x7167;&#x4F60;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8D1F;&#x8F7D;&#x91CF;&#x6765;&#x8BBE;&#x5B9A;</p>
<p>-P &#x662F;&#x8BBE;&#x7F6E;&#x4FDD;&#x5B58;Memcache&#x7684;pid&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;</p>
<p>-h &#x6253;&#x5370;&#x5E2E;&#x52A9;&#x4FE1;&#x606F;</p>
<p>-v &#x8F93;&#x51FA;&#x8B66;&#x544A;&#x548C;&#x9519;&#x8BEF;&#x4FE1;&#x606F;</p>
<p>-vv &#x6253;&#x5370;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x548C;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;</p>
<p>&#x5F00;&#x53D1;&#x65F6;&#x5019;&#x5EFA;&#x8BAE;&#x52A0;&#x4E0A;-vv&#xFF0C;&#x6B64;&#x65F6;&#x4F1A;&#x663E;&#xFFFD;&#xFFFD;&#xFFFD;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x4FE1;&#x606F;&#xFF0C;&#x6BD4;&#x8F83;&#x65B9;&#x4FBF;&#x6211;&#x4EEC;&#x8FDB;&#x884C;&#x8C03;&#x8BD5;&#xFF0C;&#x800C;&#x4E14;&#x663E;&#x793A;&#x7684;&#x6548;&#x679C;&#x6BD4;&#x8F83;cool&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19a1d61.jpg" alt=""></p>
<p>Memcached&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;telnet ip &#x7AEF;&#x53E3;&#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;telnet 127.0.0.1 11211&#x3002;</p>
<p>&#x8FDE;&#x63A5;&#x4E0A;Memcached&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x884C;&#x5BF9;&#x7F13;&#x5B58;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x5E38;&#x7528;&#x7684;Memcached&#x547D;&#x4EE4;&#x6709;5&#x79CD;&#x3002;</p>
<p>set</p>
<p>add</p>
<p>replace</p>
<p>get</p>
<p>delete</p>
<p>&#x524D;&#x4E09;&#x4E2A;&#x547D;&#x4EE4;&#x662F;&#x7528;&#x4E8E;&#x64CD;&#x4F5C;&#x5B58;&#x50A8;&#x5728; Memcached&#x4E2D;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x7684;&#x6807;&#x51C6;&#x4FEE;&#x6539;&#x547D;&#x4EE4;&#x3002;&#x5B83;&#x4EEC;&#x90FD;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x6613;&#x7528;&#xFF0C;&#x4E14;&#x90FD;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;&#x8BED;&#x6CD5;&#xFF1A;</p>
<p>command &lt;key&gt; &lt;flags&gt; &lt;expiration time&gt; &lt;bytes&gt;&lt;value&gt; </p>
<p>&#x53C2;&#x6570; &#x7528;&#x6CD5;</p>
<p>key key &#x7528;&#x4E8E;&#x67E5;&#x627E;&#x7F13;&#x5B58;&#x503C;</p>
<p>flags &#x53EF;&#x4EE5;&#x5305;&#x62EC;&#x952E;&#x503C;&#x5BF9;&#x7684;&#x6574;&#x578B;&#x53C2;&#x6570;&#xFF0C;&#x5BA2;&#x6237;&#x673A;&#x4F7F;&#x7528;&#x5B83;&#x5B58;&#x50A8;&#x5173;&#x4E8E;&#x952E;&#x503C;&#x5BF9;&#x7684;&#x989D;&#x5916;&#x4FE1;&#x606F;</p>
<p>expiration time &#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x4FDD;&#x5B58;&#x952E;&#x503C;&#x5BF9;&#x7684;&#x65F6;&#x95F4;&#x957F;&#x5EA6;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF0C;0 &#x8868;&#x793A;&#x6C38;&#x8FDC;&#xFF09;</p>
<p>bytes &#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x5B57;&#x8282;&#x70B9;</p>
<p>value &#x5B58;&#x50A8;&#x7684;&#x503C;&#xFF08;&#x59CB;&#x7EC8;&#x4F4D;&#x4E8E;&#x7B2C;&#x4E8C;&#x884C;&#xFF09;</p>
<p>&#x73B0;&#x5728;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x547D;&#x4EE4;&#x7684;&#x5B9E;&#x9645;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x65E0;&#x8BBA;&#x5982;&#x4F55;&#x90FD;&#x5B58;&#x50A8;&#x7684;set</p>
<p>set &#x547D;&#x4EE4;&#x7528;&#x4E8E;&#x5411;&#x7F13;&#x5B58;&#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x3002;&#x5982;&#x679C;&#x952E;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x4E4B;&#x524D;&#x7684;&#x503C;&#x5C06;&#x88AB;&#x66FF;&#x6362;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19a1fd2.jpg" alt=""></p>
<p>&#x53EA;&#x6709;&#x6570;&#x636E;&#x4E0D;&#x5B58;&#x5728;&#x65F6;&#x8FDB;&#x884C;&#x6DFB;&#x52A0;&#x7684;add&#x4EC5;&#x5F53;&#x7F13;&#x5B58;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#x952E;&#x65F6;&#xFF0C;add &#x547D;&#x4EE4;&#x624D;&#x4F1A;&#x5411;&#x7F13;&#x5B58;&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#x3002;&#x5982;&#x679C;&#x7F13;&#x5B58;&#x4E2D;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x952E;&#xFF0C;&#x5219;&#x4E4B;&#x524D;&#x7684;&#x503C;&#x5C06;&#x4ECD;&#x7136;&#x4FDD;&#x6301;&#x76F8;&#x540C;&#xFF0C;&#x5C06;&#x83B7;&#x5F97;&#x54CD;&#x5E94;NOT_STORED&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/19a1fd2.jpg" alt=""></p>
<p>&#x53EA;&#x6709;&#x6570;&#x636E;&#x5B58;&#x5728;&#x65F6;&#x8FDB;&#x884C;&#x66FF;&#x6362;&#x7684;replace&#x4EC5;&#x5F53;&#x952E;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x65F6;&#xFF0C;replace &#x547D;&#x4EE4;&#x624D;&#x4F1A;&#x66FF;&#x6362;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x952E;&#x3002;&#x5982;&#x679C;&#x7F13;&#x5B58;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#x952E;&#xFF0C;&#x5C06;&#x83B7;&#x5F97;&#x54CD;&#x5E94;NOT_STORED&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/19a2243.jpg" alt=""></p>
<p>getget &#x547D;&#x4EE4;&#x7528;&#x4E8E;&#x53D6;&#x5F97;&#x4E4B;&#x524D;&#x6DFB;&#x52A0;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x76F8;&#x5173;&#x7684;&#x503C;&#xFF0C;get&#x547D;&#x4EE4;&#x7684;key&#x53EF;&#x4EE5;&#x8868;&#x793A;&#x4E00;&#x4E2A;&#x6216;&#x8005;&#x591A;&#x4E2A;&#x952E;&#xFF0C;&#x952E;&#x4E4B;&#x95F4;&#x4EE5;&#x7A7A;&#x683C;&#x9694;&#x5F00;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/19a24b4.jpg" alt=""></p>
<p>gets&#x4E0D;&#x80FD;&#x987E;&#x540D;&#x601D;&#x4E49;&#x7684;&#x8BA4;&#x4E3A;get&#x662F;&#x8FD4;&#x56DE;&#x5355;&#x4E2A;key&#xFF0C;gets&#x53EF;&#x4EE5;&#x67E5;&#x8BE2;&#x591A;&#x4E2A;key&#xFF0C;gets&#x547D;&#x4EE4;&#x7684;&#x529F;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x57FA;&#x672C;&#x7684;get&#x547D;&#x4EE4;&#x3002;&#x4E24;&#x4E2A;&#x547D;&#x4EE4;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x5728;&#x4E8E;&#xFF0C;gets&#x8FD4;&#x56DE;&#x7684;&#x4FE1;&#x606F;&#x7A0D;&#x5FAE;&#x591A;&#x4E00;&#x4E9B;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/19a2725.jpg" alt=""></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;gets&#x547D;&#x4EE4;&#x6BD4;&#x666E;&#x901A;&#x7684;get&#x547D;&#x4EE4;&#x591A;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6570;&#x5B57;&#xFF08;&#x4E0A;&#x56FE;&#x4E2D;&#x4E3A;3&#x548C;2&#xFF09;&#x3002;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x53EF;&#x4EE5;&#x68C0;&#x67E5;&#x6570;&#x636E;&#x662F;&#x5426;&#x53D1;&#x751F;&#x6539;&#x53D8;&#x3002;&#x5F53;key&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x6539;&#x53D8;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x591A;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x5B57;&#x4E5F;&#x4F1A;&#x6539;&#x53D8;&#x3002;</p>
<p>deletedelete &#x7528;&#x6765;&#x5220;&#x9664;Memcached&#x4E2D;&#x7684;&#x4EFB;&#x4F55;&#x73B0;&#x6709;&#x503C;&#xFF0C;&#x5220;&#x9664;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x952E;&#x503C;&#x548C;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x8BB0;&#x5F55;&#x4F1A;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7684;&#x7ED3;&#x679C;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/19a2996.jpg" alt=""></p>
<p>flush_all&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x7684;&#x7528;&#x5904;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5B83;&#x603B;&#x662F;&#x6267;&#x884C;&#x6210;&#x529F;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x53D1;&#x9001;OK&#x56DE;&#x5E94;&#x3002;&#x5B83;&#x7684;&#x6548;&#x679C;&#x662F;&#x4F7F;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x7684;&#x7F13;&#x5B58;&#x9879;&#x76EE;&#x7ACB;&#x5373;&#x5931;&#x6548;&#xFF08;&#x7F3A;&#x7701;&#xFF09;&#x3002;flush_all &#x5B9E;&#x9645;&#x4E0A;&#x6CA1;&#x6709;&#x7ACB;&#x5373;&#x91CA;&#x653E;&#x9879;&#x76EE;&#x6240;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x800C;&#x662F;&#x5728;&#x968F;&#x540E;&#x9646;&#x7EED;&#x6709;&#x65B0;&#x7684;&#x9879;&#x76EE;&#x88AB;&#x50A8;&#x5B58;&#x65F6;&#x6267;&#x884C;&#xFF08;&#x8FD9;&#x662F;&#x7531;Memcached&#x7684;&#x61D2;&#x60F0;&#x68C0;&#x6D4B;&#x548C;&#x5220;&#x9664;&#x673A;&#x5236;&#x51B3;&#x5B9A;&#x7684;&#xFF09;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/19a2996.jpg" alt=""></p>
<p>stats</p>
<p>stats &#x547D;&#x4EE4;&#x7684;&#x529F;&#x80FD;&#x6B63;&#x5982;&#x5176;&#x540D;&#xFF1A;&#x8F93;&#x51FA;&#x6240;&#x8FDE;&#x63A5;&#x7684; Memcached&#x5B9E;&#x4F8B;&#x7684;&#x5F53;&#x524D;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19a2e78.jpg" alt=""></p>
<p><img src="http://taojinke.github.io/img/20150703/19a30e9.jpg" alt=""></p>
<p><img src="http://taojinke.github.io/img/20150703/19a30e9.jpg" alt=""></p>
<p>&#xFF08;&#x5B8C;&#xFF09;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/199eefe/" title="谈OSSIM服务器内存开销问题 -" itemprop="url">谈OSSIM服务器内存开销问题 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="&#x8C08;OSSIM&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x5F00;&#x9500;&#x95EE;&#x9898;">&#x8C08;OSSIM&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x5F00;&#x9500;&#x95EE;&#x9898;</h4><p> OSSIM&#x7ECF;&#x5386;&#x5341;&#x591A;&#x5E74;&#x53D1;&#x5C55;&#xFF0C;&#x76EE;&#x524D;&#x5DF2;&#x7ECF;&#x6210;&#x4E3A;&#x6700;&#x4F18;&#x79C0;&#x7684;&#x5F00;&#x6E90;&#x5B89;&#x5168;&#x4E8B;&#x4EF6;&#x4FE1;&#x606F;&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#xFF0C;&#x5B83;&#x5728;&#x6211;&#x56FD;&#x7684;&#x5E94;&#x7528;&#x624D;&#x521A;&#x521A;&#x8D77;&#x6B65;&#x3002;&#x591A;&#x5E74;&#x524D;&#xFF0C;&#x5728;&#x56FD;&#x5916;&#x8003;&#x67E5;&#x65F6;&#x6211;&#x610F;&#x5916;&#x53D1;&#x73B0;&#x4E86;&#x8FD9;&#x6B3E;&#x4F18;&#x79C0;&#x7684;&#x8F6F;&#x4EF6;&#x7CFB;&#x7EDF;&#xFF0C;&#x5E76;&#x4E0D;&#x65AD;&#x6539;&#x8FDB;&#x4E4B;&#x540E;&#x5F00;&#x59CB;&#x5728;&#x56FD;&#x5185;&#x5F00;&#x59CB;&#x63A8;&#x5E7F;&#x5E94;&#x7528;OSSIM&#xFF0C;&#x5728;&#x6211;&#x64B0;&#x5199;&#x7684;&#x300A;Unix/Linux&#x7F51;&#x7EDC;&#x65E5;&#x5FD7;&#x4E0E;&#x6D41;&#x91CF;&#x76D1;&#x63A7;&#x300B;&#x4E00;&#x4E66;&#x4E2D;&#x82B1;&#x8D39;30%&#x7684;&#x7B14;&#x58A8;&#xFF0C;&#x8BB2;&#x8FF0;&#x4E86;OSSIM&#x90E8;&#x7F72;&#x53CA;&#x5E94;&#x7528;&#x6280;&#x5DE7;&#x3002;&#x4F46;&#x521D;&#x5B66;&#x8005;&#x5F80;&#x5F80;&#x591A;&#x8FD9;&#x79CD;&#x7CFB;&#x7EDF;&#x7684;&#x786C;&#x4EF6;&#x8981;&#x6C42;&#x4E4B;&#x9AD8;&#x5E76;&#x4E0D;&#x7406;&#x89E3;&#xFF0C;&#x672C;&#x6587;&#x5C31;&#x8C08;&#x8C08;&#x5230;&#x5E95;OSSIM&#x7684;&#x54EA;&#x4E9B;&#x670D;&#x52A1;&#x5728;&#x6D88;&#x8017;&#x7740;&#x5185;&#x5B58;&#x3002;  &#x9664;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x672C;&#x751F;&#x4EE5;&#x4E0B;&#x5B50;&#x7CFB;&#x7EDF;&#x5C06;&#x6D88;&#x8017;&#x5927;&#x91CF;&#x5185;&#x5B58;&#x3002;&#xFF08;&#x6709;&#x5173;&#x7CFB;&#x7EDF;&#x786C;&#x4EF6;&#x9009;&#x578B;&#x95EE;&#x9898;&#x5927;&#x5BB6;&#x53EF;&#x53C2;&#x8003;&#x6211;&#x7684;&#x4E13;&#x8457;&#xFF09;</p>
<p> 1  &#xFF09;  <strong>. iptables</strong>  &#x94FE;&#x3001;&#x8868;&#x53CA;&#x89C4;&#x5219;&#x90FD;&#x6D88;&#x8017;&#x6709;&#x9650;&#x7684;&#x7CFB;&#x7EDF;&#x5185;&#x5B58;&#xFF0C;&#x800C;&#x4E14;&#x89C4;&#x5219;&#x52A0;&#x8F7D;&#x8D8A;&#x591A;&#x6D88;&#x8017;&#x5185;&#x5B58;&#x8D8A;&#x5927;&#xFF1B;</p>
<p> 2  &#xFF09;  .  <em><strong>Snort</strong></em>  &#x6A21;&#x5757;&#xFF0C;&#x5DE5;&#x4F5C;&#x65F6;&#x65E2;&#x6D88;&#x8017;  CPU  &#x8BA1;&#x7B97;&#x8D44;&#x6E90;&#x5B83;&#x7684;&#x89C4;&#x5219;&#x540C;&#x65F6;&#x6D88;&#x8017;&#x5927;&#x91CF;&#x5185;&#x5B58;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;&#x5229;&#x7528;  Snort  &#x53EF;&#x4EE5;&#x5C06;  SPAN  &#x8FC7;&#x6765;&#x7684;&#x6D41;&#x91CF;&#x8FDB;&#x884C;&#x6DF1;&#x5EA6;&#x5305;&#x68C0;&#x6D4B;&#xFF0C;&#x8FD9;&#x662F;&#x7CFB;&#x7EDF;&#x9700;&#x8981;&#x5BF9;&#x6570;&#x636E;&#x5305;&#x7684;&#x5185;&#x5BB9;&#x8FDB;&#x884C;&#x8BC6;&#x522B;&#xFF0C;&#x5206;&#x6790;&#x548C;&#x5206;&#x7C7B;&#xFF0C;&#x5C06;&#x91C7;&#x7528;&#x57FA;&#x4E8E;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x591A;&#x6A21;&#x5F0F;&#x5339;&#x914D;&#x7B97;&#x6CD5;&#x548C;&#x57FA;&#x4E8E;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x591A;&#x6A21;&#x5F0F;&#x5339;&#x914D;&#x7B97;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x4EE5;&#x6765;&#x5927;&#x90E8;&#x5206;  CPU  &#x7684;&#x8BA1;&#x7B97;&#x65F6;&#x95F4;&#x5C06;&#x88AB;  snort  &#x5360;&#x7528;&#xFF0C;&#x4E0E;&#x6B64;&#x540C;&#x65F6;  snort  &#x8FD8;&#x4F1A;&#x8FDE;&#x63A5;&#x6570;&#x636E;&#x5E93;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x65E5;&#x5FD7;&#x4ECE;&#x800C;&#x5360;&#x7528;&#x78C1;&#x76D8;  IO  &#xFF1B;</p>
<p> 3  &#xFF09; <strong>Squid</strong> &#xFF0C;&#x5B9E;&#x73B0;  squid  &#x5BF9;&#x672C;&#x673A;&#x7684;  apache  &#x670D;&#x52A1;&#x5B9E;&#x73B0;&#x52A0;&#x901F;&#x529F;&#x80FD;  ,  &#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;  /etc/squid3/squid.conf  &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x201C;  Recommended minimum configuration  &#x201D;&#x63A8;&#x8350;&#x6700;&#x5C0F;&#x5316;&#x914D;&#x7F6E;&#x4E00;&#x680F;&#x67E5;&#x627E;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#xFF1B;</p>
<p> 4  &#xFF09; <strong>Memcache</strong> ,  &#x5F53;&#x6570;&#x636E;&#x91CF;&#x5927;&#x65F6;&#xFF0C;&#x5229;&#x7528;  memcached  &#x53EF;&#x4EE5;&#x7F13;&#x5B58;  session  &#x6570;&#x636E;&#x3001;&#x4E34;&#x65F6;&#x6570;&#x636E;&#x4EE5;&#x51CF;&#x5C11;&#x5BF9;&#x4ED6;&#x4EEC;&#x7684;&#x6570;&#x636E;&#x5E93;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x4F46;&#x5B83;&#x6D88;&#x8017;&#x5185;&#x5B58;&#x4E5F;&#x5F88;&#x5927;&#xFF1B;</p>
<p> 5)  <strong>Redis  &#x3001;  memcache</strong>  ,  &#x90FD;&#x662F;&#x57FA;&#x4E8E;  key/value  &#x5B58;&#x50A8;&#xFF0C;&#x5F53;&#x63D2;&#x5165;&#x7684;&#x6570;&#x636E;&#x8D8A;&#x591A;&#x65F6;&#x6D88;&#x8017;&#x5185;&#x5B58;&#x8D8A;&#x5927;&#xFF0C;&#x5F53;&#x6570;&#x636E;&#x7EE7;&#x7EED;&#x589E;&#x52A0;&#x4ED6;&#x4EEC;&#x6709;&#x53EF;&#x80FD;&#x4F1A;&#x5360;&#x7528;  70%  &#x7684;&#x5185;&#x5B58;&#xFF0C;&#x6D88;&#x8017;&#x5F88;&#x5927;&#xFF1B;</p>
<p> 6) <strong>LAMP</strong> ,  &#x9664;  Linux  &#x7CFB;&#x7EDF;&#x672C;&#x8EAB;&#x7684;&#x5185;&#x5B58;&#x6D88;&#x8017;&#x5916;&#xFF0C;&#x8FD8;&#x6709;  Apache  &#x3001;  Mysql  &#x3001;  PHP  &#x53CA;&#x6A21;&#x5757;&#x7684;&#x5185;&#x5B58;&#x6D88;&#x8017;&#xFF1B;</p>
<p> 7) <strong>OSSEC</strong>,  &#x5229;&#x7528;&#x89C4;&#x5219;&#x8FDB;&#x884C;&#x5165;&#x4FB5;&#x68C0;&#x6D4B;&#x5206;&#x6790;&#x65F6;&#xFF0C;&#x6D88;&#x8017;&#x5927;&#x91CF;&#x5185;&#x5B58;&#xFF1B;</p>
<p> 8  &#xFF09;  <strong>OpenVas</strong>  &#x5728;&#x8FDB;&#x884C;&#x6F0F;&#x6D1E;&#x626B;&#x63CF;&#x65F6;&#x4F1A;&#x52A0;&#x8F7D;&#x6F0F;&#x6D1E;&#x5E93;&#x8FD9;&#x6837;&#x4F1A;&#x6D88;&#x8017;&#x5927;&#x91CF;&#x5185;&#x5B58;&#xFF1B;</p>
<p> 9  &#xFF09; <strong>Ntop</strong> &#xFF0C;&#x5728;&#x76D1;&#x63A7;&#x65F6;&#xFF0C;&#x5728;&#x8BFB;&#x53D6;&#x6D41;&#x91CF;&#x5230;  Ntop  &#x4E2D;&#xFF0C;  ntop  &#x5C06;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x4E3B;&#x673A;&#x6570;&#x91CF;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x6D88;&#x8017;&#x5927;&#x91CF;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#xFF1B;&#x5982;&#x679C;&#x5229;&#x7528;  &quot;q&#x201D;  &#x53C2;&#x6570;&#x5C06;  ntop  &#x4EA7;&#x751F;&#x7684;&#x53EF;&#x4EE5;&#x5305;&#x8F6C;&#x50A8;&#x4E3A;&#x6587;&#x4EF6;&#x5728;&#x8FD9;&#x4E00;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x540C;&#x6837;&#x6D88;&#x8017;&#x5185;&#x5B58;&#xFF1B;</p>
<p> 10  &#xFF09;  <strong>Agent</strong>  &#xFF0C;&#x5728;  Sensor  &#x4E2D;&#x5305;&#x542B;&#x4E0A;&#x767E;&#x4E2A;  Agent  &#x63D2;&#x4EF6;&#x8FD9;&#x4E9B;&#x90FD;&#x6D88;&#x8017;&#x7740;&#x5927;&#x91CF;&#x5185;&#x5B58;&#xFF1B;</p>
<p> 11  &#xFF09;  <strong>Alienvault  &#x6846;&#x67B6;</strong>  &#x8FD0;&#x884C;&#x540C;&#x6837;&#x6D88;&#x8017;&#x5185;&#x5B58;&#xFF1B;</p>
<p> 12  &#xFF09;  <strong>OSSIM  &#x4E2D;&#x5173;&#x8054;&#x5F15;&#x64CE;</strong>  &#x7684;&#x805A;&#x5408;&#x6A21;&#x5757;&#xFF0C;&#x5728;&#x5904;&#x7406;&#x590D;&#x6742;&#x62A5;&#x8B66;&#x5E76;&#x5BF9;&#x62A5;&#x8B66;&#x4E8B;&#x4EF6;&#x8FDB;&#x884C;&#x805A;&#x5408;&#x5904;&#x7406;&#x65F6;&#xFF0C;&#x4F1A;&#x8FDB;&#x884C;&#x5927;&#x91CF;&#x8BA1;&#x7B97;&#x6D88;&#x8017;&#x5185;&#x5B58;&#x4EE5;&#x53CA;  CPU  &#x8D44;&#x6E90;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5BF9;&#x4E8E;&#x77ED;&#x65F6;&#x95F4;&#x591A;&#x6B21;&#x8FDE;&#x7EED;&#x653B;&#x51FB;&#xFF0C;&#x626B;&#x63CF;&#x5F15;&#x64CE;&#x7684;&#x62A5;&#x8B66;&#x6570;&#x76EE;&#x66F4;&#x591A;&#xFF0C;&#x57FA;&#x4E8E;&#x7F51;&#x683C;&#x7684;&#x805A;&#x5408;&#x65B9;&#x6CD5;&#xFF0C;&#x5408;&#x5E76;&#x8D77;&#x6765;&#x7CFB;&#x7EDF;&#x505A;&#x5173;&#x8054;&#x5206;&#x6790;&#x4EFB;&#x52A1;&#x91CF;&#x5F88;&#x5927;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x6D88;&#x8017;&#x5927;&#x91CF;&#x7CFB;&#x7EDF;&#x8D44;&#x6E90;&#x3002;</p>
<p>&#x6700;&#x91CD;&#x8981;&#x7684;&#x4E09;&#x4E2A;&#x6307;&#x6807;&#xFF1A;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x3001;CPU&#x6570;&#x91CF;&#x3001;&#x78C1;&#x76D8;I/O&#x53CA;&#x7F51;&#x7EDC;I/O&#x5927;&#x5C0F;&#xA0;</p>
<p>16GB&#x5185;&#x5B58;&#x662F;&#x57FA;&#x672C;&#x914D;&#x7F6E;&#x5C31;&#x4E0D;&#x8DB3;&#x4E3A;&#x5947;&#xFF0C;&#x6700;&#x597D;&#x5C06;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x914D;&#x7F6E;&#x5230;32GB&#x53CA;&#x4EE5;&#x4E0A;&#x3002;  &#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x5C0F;&#x4E8E;8GB&#x7684;&#x73AF;&#x5883;&#x4E2D;&#x4F7F;&#x7528;OSSIM&#xFF0C;&#x8FD8;&#x4E0D;&#x5982;&#x73B0;&#x5728;&#x5C31;&#x653E;&#x5F03; :-)</p>
<p>&#x672C;&#x6587;&#x51FA;&#x81EA; &#x201C;&#x674E;&#x6668;&#x5149;&#x539F;&#x521B;&#x6280;&#x672F;&#x535A;&#x5BA2;&#x201D; &#x535A;&#x5BA2;&#xFF0C;&#x8C22;&#x7EDD;&#x8F6C;&#x8F7D;&#xFF01; </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Snort/">Snort</a><a href="/tags/操作系统/">操作系统</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/199c09b/" title="个人站搭建手册 -" itemprop="url">个人站搭建手册 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x8FD9;&#x91CC;&#x662F;&#x6211;&#x8D2D;&#x4E70; VPS&#xFF0C;&#x7136;&#x540E;&#x5728;&#x4E0A;&#x9762;&#x642D;&#x5EFA;&#x8FD9;&#x4E2A;&#x7F51;&#x7AD9;&#x7684;&#x7B14;&#x8BB0;&#xFF0C;&#x4F9B;&#x53C2;&#x8003;&#x3002;</p>
<h2 id="VPS_&#x7684;&#x9009;&#x62E9;">VPS &#x7684;&#x9009;&#x62E9;</h2><p>&#x8BF7;&#x770B;&#x8FD9;&#x91CC;&#x901F;&#x5EA6;&#x66F4;&#x5FEB;&#x7684;&#x6D77;&#x5916; VPS </p>
<h2 id="&#x642D;&#x5EFA;&#x4E00;&#x4E2A;_VPN&#xFF0C;&#x7FFB;&#x9605;&#x957F;&#x57CE;">&#x642D;&#x5EFA;&#x4E00;&#x4E2A; VPN&#xFF0C;&#x7FFB;&#x9605;&#x957F;&#x57CE;</h2><p>&#x53C2;&#x7167;&#x4E86; DigitalOcean &#x7684; <a href="https://www.digitalocean.com/community/tutorials/how-to-setup-a-multi-protocol-vpn-server-using-softether" target="_blank" rel="external">&#x6559;&#x7A0B;</a> &#xFF0C;&#x4F7F;&#x7528;&#x4E86; <a href="http://www.softether.org/" target="_blank" rel="external">SoftEther</a> &#x6765;&#x521B;&#x5EFA;&#x4E86; VPN &#x670D;&#x52A1;&#x3002; </p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x6839;&#x636E; SoftEther &#x7684;&#x5B98;&#x65B9; <a href="http://www.softether.org/4-docs/2-howto/9.L2TPIPsec_Setup_Guide_for_SoftEther_VPN_Server/1.Setup_L2TP%2F%2F%2F%2FIPsec_VPN_Server_on_SoftEther_VPN_Server" target="_blank" rel="external">L2TP/IPsec VPN Server &#x6559;&#x7A0B;</a> &#xFF0C;&#x8981;&#x4F7F;&#x7528; SoftEther &#x7684; L2TP/IPsec VPN &#x670D;&#x52A1;&#xFF0C;&#x9700;&#x8981;&#x5728; iptables &#x4E2D;&#x5F00;&#x542F; UDP 500 &#x4E0E; 4500 &#x7AEF;&#x53E3;&#x3002;&#x9664;&#x6B64;&#x4E4B;&#x5916;&#xFF0C;&#x4E3A;&#x4E86;&#x4F7F; L2TP &#x80FD;&#x6B63;&#x5E38;&#x8FDE;&#x63A5;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x5F00;&#x542F; UDP 1701 &#x7AEF;&#x53E3;&#x3002; </p>
<h2 id="&#x5B89;&#x88C5;_LEMP">&#x5B89;&#x88C5; LEMP</h2><p>&#x4E3A;&#x4EC0;&#x4E48;&#x662F; LEMP?</p>
<p>&apos;&apos; <strong>&#x56E0;&#x4E3A; Nginx &#x662F; EngineX</strong> &apos;&apos; </p>
<h3 id="&#x5B89;&#x88C5;_MySQL">&#x5B89;&#x88C5; MySQL</h3><p>&#x5982;&#x679C;&#x4E70;&#x7684;&#x662F;&#x5185;&#x5B58;&#x4E3A; 512M &#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x9700;&#x8981;&#x505A;&#x4E00;&#x4E2A; SWAP &#x6587;&#x4EF6;&#x5E76;&#x6302;&#x8F7D;&#xFF0C;&#x5426;&#x5219; MySQL &#x65E0;&#x6CD5;&#x5B89;&#x88C5;&#x6210;&#x529F;&#x3002;</p>
<pre><code>dd <span class="keyword">if</span>=/dev/zero of=/swapfile <span class="keyword">bs</span>=1M <span class="keyword">count</span>=1024
mkswap /swapfile
swapon /swapfile
echo &amp;apos;swapon /swapfile&amp;apos; &amp;gt;&amp;gt; /etc/rc.<span class="keyword">d</span>/rc.<span class="keyword">local</span>
</code></pre><p>&#x6DFB;&#x52A0;&#x7528;&#x6237;&#xFF0C;&#x5E76;&#x5B89;&#x88C5; MySQL &#xFF0C;&#x6211;&#x4F7F;&#x7528;&#x7684;&#x4F7F; percona &#x7684; rpm &#x5305;&#x3002;</p>
<pre><code>useradd <span class="operator">-s</span> /sbin/nologin mysql
</code></pre><p>MySQl &#x5B89;&#x88C5;&#x597D;&#x540E;&#xFF0C;&#x5220;&#x9664;&#x5176;&#x4E2D;&#x7684;&#x533F;&#x540D;&#x7528;&#x6237;</p>
<pre><code>mysql&amp;gt; <span class="operator"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.<span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">user</span>=&amp;apos;</span>&amp;apos;;
mysql&amp;gt; <span class="operator"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span>
</code></pre><h3 id="&#x6E90;&#x7801;&#x5B89;&#x88C5;_PHP">&#x6E90;&#x7801;&#x5B89;&#x88C5; PHP</h3><p>&#x5B89;&#x88C5;&#x4F9D;&#x8D56;&#x5305;</p>
<pre><code><span class="label">yum</span> install -y gcc gcc-c++ autoconf cmake libjpeg-devel libpng-devel freetype-devel libxml2-devel zlib-devel glibc-devel glib2-devel <span class="keyword">bzip2-devel </span>curl-devel openssl-devel pcre-devel libmcrypt-devel
</code></pre><p>&#x4E0B;&#x8F7D;&#x5B89;&#x88C5; php</p>
<pre><code><span class="comment">tar</span> <span class="comment">zxf</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">5</span><span class="string">.</span><span class="comment">5</span><span class="string">.</span><span class="comment">13</span><span class="string">.</span><span class="comment">tar</span><span class="string">.</span><span class="comment">gz</span>
<span class="comment">cd</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">5</span><span class="string">.</span><span class="comment">5</span><span class="string">.</span><span class="comment">13</span>
<span class="string">.</span><span class="comment">/configure</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">prefix=/usr/local/php</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">disable</span><span class="literal">-</span><span class="comment">fileinfo</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">fpm</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">ftp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">gd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mysql</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">curl</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mcrypt</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">zlib</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">zip</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">jpeg</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">png</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">openssl</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">mbstring</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">pdo</span><span class="literal">-</span><span class="comment">mysql</span>
<span class="comment">make</span>
<span class="comment">make</span> <span class="comment">install</span>
<span class="comment">ln</span> <span class="literal">-</span><span class="comment">s</span> <span class="comment">/usr/local/php/bin/php</span> <span class="comment">/usr/bin/php</span>
</code></pre><p>&#x590D;&#x5236; php &#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>
<pre><code>cp -f php.ini-production <span class="regexp">/usr/</span>local<span class="regexp">/php/</span>lib/php.ini
mv <span class="regexp">/usr/</span>local<span class="regexp">/php/</span>etc<span class="regexp">/php-fpm.conf.default /</span>usr<span class="regexp">/local/</span>php<span class="regexp">/etc/</span>php-fpm.conf
</code></pre><p>&#x6DFB;&#x52A0; php &#x7684; bin &#x76EE;&#x5F55;&#x5230; PATH</p>
<pre><code>PATH=<span class="string">$PATH:</span>$HOME<span class="regexp">/bin:/</span>usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>
</code></pre><h3 id="&#x6E90;&#x7801;&#x5B89;&#x88C5;_Memcached">&#x6E90;&#x7801;&#x5B89;&#x88C5; Memcached</h3><p>&#x5B89;&#x88C5; Memcached</p>
<pre><code>useradd -M -s /sbin/nologin memcached
yum -y <span class="operator"><span class="keyword">install</span> libevent-devel

tar zxf memcached-<span class="number">1.4</span>.20.tar.gz
cd memcached-<span class="number">1.4</span>.20
./configure &amp;amp;</span>&amp;amp; make &amp;amp;&amp;amp; make <span class="operator"><span class="keyword">install</span>

<span class="keyword">ln</span> -s /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/memcached /usr/<span class="keyword">bin</span>/memcached
mkdir /<span class="keyword">var</span>/run/memcached
cp scripts/memcached.sysv /etc/init.d/memcached
chkconfig memcached <span class="keyword">on</span></span>
</code></pre><p>&#x6DFB;&#x52A0; Memcached &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x521B;&#x5EFA; &apos;&apos;/etc/sysconfig/memcached&apos;&apos; &#x6587;&#x4EF6;&#x5E76;&#x52A0;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;</p>
<pre><code>PORT=&amp;quot<span class="comment">;11211&amp;quot;</span>
USER=&amp;quot<span class="comment">;memcached&amp;quot;</span>
MAXCONN=&amp;quot<span class="comment">;256&amp;quot;</span>
CACHESIZE=&amp;quot<span class="comment">;32&amp;quot;</span>
OPTIONS=&amp;quot<span class="comment">;-l 127.0.0.1&amp;quot;</span>
</code></pre><p>&#x542F;&#x52A8; Memcached</p>
<pre><code><span class="keyword">service</span> memcached <span class="literal">start</span>
</code></pre><p>&#x5B89;&#x88C5; PHP &#x7684; Memcached &#x6269;&#x5C55;</p>
<pre><code>tar zxf libmemcached-1.0.18.tar.gz
cd libmemcached-1.0.18
./configure &amp;amp;&amp;amp; make &amp;amp;&amp;amp; make <span class="operator"><span class="keyword">install</span>

tar zxf memcached-<span class="number">2.2</span>.0.tgz
cd memcached-<span class="number">2.2</span>.0
/usr/<span class="keyword">local</span>/php/<span class="keyword">bin</span>/phpize
./configure <span class="comment">--with-php-config=/usr/local/php/bin/php-config --disable-memcached-sasl</span>
make &amp;amp;</span>&amp;amp; make <span class="operator"><span class="keyword">install</span></span>
</code></pre><h3 id="&#x5B89;&#x88C5;_Nginx">&#x5B89;&#x88C5; Nginx</h3><pre><code>tar zxf nginx-<span class="number">1.6</span>.<span class="number">0</span>.tar.gz
<span class="keyword">cd</span> nginx-<span class="number">1.6</span>.<span class="number">0</span>
./configure --with-http_stub_status_module --with-http_ssl_module --prefix=/<span class="keyword">opt</span>/nginx
<span class="keyword">make</span>
<span class="keyword">make</span> install
</code></pre><p>&#x4FEE;&#x6539;&#x4E00;&#x4E9B; nginx &#x5E38;&#x7528;&#x8BBE;&#x7F6E;&#xFF1A;</p>
<pre><code>error_log  logs/<span class="keyword">error</span>.log;
<span class="keyword">pid</span>        logs/nginx.<span class="keyword">pid</span>;
</code></pre><h3 id="&#x4E24;&#x4E2A;&#x65B9;&#x4FBF;&#x7684;&#x51FD;&#x6570;">&#x4E24;&#x4E2A;&#x65B9;&#x4FBF;&#x7684;&#x51FD;&#x6570;</h3><p>&#x5728; ~/.bash_profile &#x4E2D;&#x6DFB;&#x52A0;&#x4E24;&#x4E2A;&#x65B9;&#x4FBF;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x7528;&#x6765;&#x91CD;&#x8F7D; Nginx &#x548C; php-fpm</p>
<pre><code><span class="xml">export PATH
# Reload Nginx
function rex()
</span><span class="expression">{
    <span class="variable">kill</span> <span class="variable">-HUP</span> `<span class="variable">cat</span> <span class="end-block">/opt</span><span class="end-block">/nginx</span><span class="end-block">/logs</span><span class="end-block">/nginx.pid</span>`
}</span><span class="xml">
# Reload php-fpm
function rep()
</span><span class="expression">{
    <span class="variable">killall</span> <span class="variable">php-fpm</span>
    <span class="end-block">/usr</span><span class="end-block">/local</span><span class="end-block">/php</span><span class="end-block">/sbin</span><span class="end-block">/php-fpm</span>
}</span><span class="xml"></span>
</code></pre><h3 id="&#x914D;&#x7F6E;_Nginx_&#x652F;&#x6301;_WordPress_&#x56FA;&#x5B9A;&#x94FE;&#x63A5;">&#x914D;&#x7F6E; Nginx &#x652F;&#x6301; WordPress &#x56FA;&#x5B9A;&#x94FE;&#x63A5;</h3><p>&#x5F85;&#x5B8C;&#x6210;</p>
<h3 id="&#x9759;&#x6001;&#x6587;&#x4EF6;_CDN_&#x52A0;&#x901F;&#x7B49;">&#x9759;&#x6001;&#x6587;&#x4EF6; CDN &#x52A0;&#x901F;&#x7B49;</h3><p>&#x4F7F;&#x7528; upyuan &#x53C2;&#x8003;&#xFF1A;</p>
<p><a href="http://www.84tt.com/web/2013/04/718.htmlhttp://www.meshuo.com/archives/2280.html" target="_blank" rel="external">http://www.84tt.com/web/2013/04/718.htmlhttp://www.meshuo.com/archives/2280.html</a> </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/MySQL/">MySQL</a><a href="/tags/PHP/">PHP</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/1990e62/" title="【maven项目】Spring MVC 中配置Memcache -" itemprop="url">【maven项目】Spring MVC 中配置Memcache -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x4ECA;&#x5929;&#x9879;&#x76EE;&#x4E0A;&#x8981;&#x6C42;&#x4F7F;&#x7528;Memcache&#x5BF9;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x7F13;&#x5B58;&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x4E3A;&#x4E4B;&#x524D;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#x7528;&#x8FC7;Memcache&#xFF0C;&#x6240;&#x4EE5;&#x6574;&#x7406;&#x4E0B;&#x6765;&#x3002;</p>
<p>&#x7B2C;&#x4E00;&#x6B65;&#xFF1A;&#x5F15;&#x5165;jar&#xFF1B;&#x5728;pom&#x6587;&#x4EF6;&#x4E2D;&#x6DFB;&#x52A0;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;</p>
<pre><code><span class="subst">&amp;</span><span class="literal">lt</span>;<span class="subst">!--</span> memcache <span class="subst">--&amp;</span><span class="literal">gt</span>;
              <span class="subst">&amp;</span><span class="literal">lt</span>;dependency<span class="subst">&amp;</span><span class="literal">gt</span>;
            <span class="subst">&amp;</span><span class="literal">lt</span>;groupId<span class="subst">&amp;</span><span class="literal">gt</span>;com<span class="built_in">.</span>whalin<span class="subst">&amp;</span><span class="literal">lt</span>;/groupId<span class="subst">&amp;</span><span class="literal">gt</span>;
            <span class="subst">&amp;</span><span class="literal">lt</span>;artifactId<span class="subst">&amp;</span><span class="literal">gt</span>;Memcached<span class="attribute">-Java</span><span class="attribute">-Client</span><span class="subst">&amp;</span><span class="literal">lt</span>;/artifactId<span class="subst">&amp;</span><span class="literal">gt</span>;
            <span class="subst">&amp;</span><span class="literal">lt</span>;version<span class="subst">&amp;</span><span class="literal">gt</span>;<span class="number">3.0</span><span class="built_in">.0</span><span class="subst">&amp;</span><span class="literal">lt</span>;/version<span class="subst">&amp;</span><span class="literal">gt</span>;
        <span class="subst">&amp;</span><span class="literal">lt</span>;/dependency<span class="subst">&amp;</span><span class="literal">gt</span>;
</code></pre><p>&#x7B2C;&#x4E8C;&#x6B65;&#xFF1A;&#x914D;&#x7F6E;Memcache&#x76F8;&#x5173;&#x5C5E;&#x6027;&#xFF08;init.properties&#xFF09;</p>
<pre><code>#######################&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;#######################
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;
memcached.server=&amp;<span class="symbol">#x76EE</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;<span class="method">ip:</span><span class="number">11211</span>  #&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x53E3</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">11211</span>
#&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x9519</span>;
memcached.failOver=<span class="keyword">true</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
memcached.initConn=<span class="number">20</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
memcached.minConn=<span class="number">10</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
memcached.maxConn=<span class="number">250</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7761</span>;&amp;<span class="symbol">#x7720</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;
memcached.maintSleep=<span class="number">3000</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;<span class="class">Nagle</span>&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF08</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">true</span>&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x51B2</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x5373</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;
memcached.nagle=<span class="keyword">false</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;
memcached.socketTO=<span class="number">3000</span>
#&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x5173</span>;
memcached.aliveCheck=<span class="keyword">true</span>
#######################&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;#######################
</code></pre><p>&#x7B2C;&#x4E09;&#x6B65;&#xFF1A;&#x52A0;&#x8F7D;Memcache&#x5C5E;&#x6027;&#xFF08;memcached-content.xml&#xFF09;</p>
<pre><code><span class="subst">&amp;</span><span class="literal">lt</span>;<span class="subst">?</span><span class="built_in">xml</span> version<span class="subst">=&amp;</span>quot;<span class="number">1.0</span><span class="subst">&amp;</span>quot; encoding<span class="subst">=&amp;</span>quot;UTF<span class="subst">-</span><span class="number">8</span><span class="subst">&amp;</span>quot;<span class="subst">?&amp;</span><span class="literal">gt</span>;
<span class="subst">&amp;</span><span class="literal">lt</span>;beans xmlns<span class="subst">=&amp;</span>quot;http:<span class="comment">//www.springframework.org/schema/beans&amp;quot;</span>
    xmlns:context<span class="subst">=&amp;</span>quot;http:<span class="comment">//www.springframework.org/schema/context&amp;quot; xmlns:tx=&amp;quot;http://www.springframework.org/schema/tx&amp;quot;</span>
    xmlns:xsi<span class="subst">=&amp;</span>quot;http:<span class="comment">//www.w3.org/2001/XMLSchema-instance&amp;quot; xmlns:dubbo=&amp;quot;http://code.alibabatech.com/schema/dubbo&amp;quot;</span>
    xmlns:aop<span class="subst">=&amp;</span>quot;http:<span class="comment">//www.springframework.org/schema/aop&amp;quot; xmlns:task=&amp;quot;http://www.springframework.org/schema/task&amp;quot;</span>
    xsi:schemaLocation<span class="subst">=&amp;</span>quot;http:<span class="comment">//www.springframework.org/schema/beans </span>
    http:<span class="comment">//www.springframework.org/schema/beans/spring-beans-3.2.xsd</span>
    http:<span class="comment">//www.springframework.org/schema/context </span>
    http:<span class="comment">//www.springframework.org/schema/context/spring-context-3.2.xsd</span>
    http:<span class="comment">//www.springframework.org/schema/tx </span>
    http:<span class="comment">//www.springframework.org/schema/tx/spring-tx-3.2.xsd</span>
    http:<span class="comment">//code.alibabatech.com/schema/dubbo    </span>
    http:<span class="comment">//code.alibabatech.com/schema/dubbo/dubbo.xsd</span>
    http:<span class="comment">//www.springframework.org/schema/aop</span>
    http:<span class="comment">//www.springframework.org/schema/aop/spring-aop-3.2.xsd</span>
    http:<span class="comment">//www.springframework.org/schema/task  </span>
    http:<span class="comment">//www.springframework.org/schema/task/spring-task-3.1.xsd&amp;quot;&amp;gt;</span>
    <span class="subst">&amp;</span><span class="literal">lt</span>;<span class="subst">!--</span> Memcached<span class="subst">&amp;</span><span class="variable">#x914D</span>;<span class="subst">&amp;</span><span class="variable">#x7F6E</span>; <span class="subst">--&amp;</span><span class="literal">gt</span>;  
    <span class="subst">&amp;</span><span class="literal">lt</span>;bean id<span class="subst">=&amp;</span>quot;memcachedPool<span class="subst">&amp;</span>quot; class<span class="subst">=&amp;</span>quot;com<span class="built_in">.</span>whalin<span class="built_in">.</span>MemCached<span class="built_in">.</span>SockIOPool<span class="subst">&amp;</span>quot;  
        factory<span class="attribute">-method</span><span class="subst">=&amp;</span>quot;getInstance<span class="subst">&amp;</span>quot; init<span class="attribute">-method</span><span class="subst">=&amp;</span>quot;initialize<span class="subst">&amp;</span>quot; destroy<span class="attribute">-method</span><span class="subst">=&amp;</span>quot;shutDown<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;servers<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;<span class="built_in">list</span><span class="subst">&amp;</span><span class="literal">gt</span>;  
                <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>server}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;/<span class="built_in">list</span><span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;initConn<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>initConn}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;minConn<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>minConn}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;maxConn<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>maxConn}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;maintSleep<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>maintSleep}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;nagle<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>nagle}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;property name<span class="subst">=&amp;</span>quot;socketTO<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;  
            <span class="subst">&amp;</span><span class="literal">lt</span>;value<span class="subst">&amp;</span><span class="literal">gt</span>;${memcached<span class="built_in">.</span>socketTO}<span class="subst">&amp;</span><span class="literal">lt</span>;/value<span class="subst">&amp;</span><span class="literal">gt</span>;  
        <span class="subst">&amp;</span><span class="literal">lt</span>;/property<span class="subst">&amp;</span><span class="literal">gt</span>;  
    <span class="subst">&amp;</span><span class="literal">lt</span>;/bean<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="subst">&amp;</span><span class="literal">lt</span>;/beans<span class="subst">&amp;</span><span class="literal">gt</span>;
</code></pre><p>&#x7B2C;&#x56DB;&#x6B65;&#xFF1A;&#x5F15;&#x5165;&#x5230;spring&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#xFF08;applicationContext.xml&#xFF09; </p>
<pre><code><span class="subst">&amp;</span><span class="literal">lt</span>;<span class="subst">!--</span> <span class="subst">&amp;</span><span class="variable">#x53EA</span>;<span class="subst">&amp;</span><span class="variable">#x9700</span>;<span class="subst">&amp;</span><span class="variable">#x8981</span>;<span class="subst">&amp;</span><span class="variable">#x52A0</span>;<span class="subst">&amp;</span><span class="variable">#x5165</span>;<span class="subst">&amp;</span><span class="variable">#x8FD9</span>;<span class="subst">&amp;</span><span class="variable">#x4E00</span>;<span class="subst">&amp;</span><span class="variable">#x53E5</span>;<span class="subst">&amp;</span><span class="variable">#x5C31</span>;<span class="subst">&amp;</span><span class="variable">#x53EF</span>;<span class="subst">&amp;</span><span class="variable">#x4EE5</span>; <span class="subst">--&amp;</span><span class="literal">gt</span>;
<span class="subst">&amp;</span><span class="literal">lt</span>;<span class="keyword">import</span> resource<span class="subst">=&amp;</span>quot;memcached<span class="attribute">-content</span><span class="built_in">.</span><span class="built_in">xml</span><span class="subst">&amp;</span>quot;<span class="subst">/</span><span class="subst">&amp;</span><span class="literal">gt</span>;
</code></pre><p>ok&#xFF0C;&#x5927;&#x529F;&#x544A;&#x6210;&#xFF01;&#x81F3;&#x4E8E;Memcache&#x5E94;&#x7528;&#xFF0C; &#x53EF;&#x4EE5;&#x7F51;&#x4E0A;&#x641C;&#x4EE5;&#x4E0B;&#xFF0C;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x7EAF;&#x7684;exe&#x6587;&#x4EF6;&#xFF0C; &#x7528;&#x7684;&#x65F6;&#x5019;&#x6253;&#x5F00;&#x5C31;&#x884C;&#xFF0C;&#x5982;&#x56FE;&#xFF0C; &#x6253;&#x5F00;&#x540E;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x6837;&#x5B50;<br><img src="http://taojinke.github.io/img/20150703/199022d.jpg" alt=""></p>
<p>&#x8981;&#x60F3;&#x770B;&#x662F;&#x5426;&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x7684;&#x8BDD;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;cmd&#x4E2D;telnet &#x670D;&#x52A1;&#x5668;&#x5730;&#x5740; 11211 &#xFF08;&#x670D;&#x52A1;&#x5668;&#x5730;&#x5740;&#x4E0E;&#x7AEF;&#x53E3;&#x53F7;&#x4E4B;&#x95F4;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;&#x683C;&#xFF0C; &#x4E0D;&#x8981;&#x8F93;&#x5165;&#x5192;&#x53F7;&#xFF09; </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Java/">Java</a><a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/198d3ca/" title="linux(centos 6.4)下安装php memcache服务端及其客户端(详细教程) -" itemprop="url">linux(centos 6.4)下安装php memcache服务端及其客户端(详细教程) -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x524D;&#x8A00;</p>
<p>&#x5728;&#x642D;&#x5EFA;&#x4E2A;&#x4EBA;&#x535A;&#x5BA2;&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x4EFB;&#x4F55;&#x6846;&#x67B6;&#xFF0C;&#x7EAF;&#x624B;&#x5DE5;code&#x524D;&#x53F0;&#x548C;&#x540E;&#x53F0;&#xFF0C;&#x5BFC;&#x81F4;&#x9047;&#x5230;&#x8BB8;&#x591A;&#x95EE;&#x9898;&#xFF0C;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x5C31;&#x662F;mysql&#x8FDE;&#x63A5;&#x5BFC;&#x81F4;&#x7684;&#x9875;&#x9762;&#x76F8;&#x5E94;&#x901F;&#x5EA6;&#x5F02;&#x5E38;&#x4F4E;&#x3002;&#x5728;&#x67E5;&#x8BE2;&#x5404;&#x79CD;&#x9014;&#x5F84;&#x540E;&#xFF0C;&#x53EA;&#x80FD;&#x8003;&#x8651;&#x4F7F;&#x7528;memcache&#x7F13;&#x5B58;&#x3002;&#x5728;&#x53C2;&#x8003;&#x4E86;&#x8BB8;&#x591A;&#x6587;&#x7AE0;&#x540E;&#xFF0C;&#x7EC8;&#x4E8E;&#x6210;&#x529F;&#x7684;&#x5728;centos6.4&#x4E0B;&#x5B89;&#x88C5;memcache&#x3002;&#x7531;&#x4E8E;&#x53D1;&#x73B0;&#x5728;&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x8BB8;&#x591A;&#x6587;&#x7AE0;&#x5728;&#x6709;&#x4E9B;&#x7EC6;&#x8282;&#x6CA1;&#x6709;&#x89E3;&#x91CA;&#x6E05;&#x695A;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x4E00;&#x76F4;&#x5361;&#x5728;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x4E0A;&#x9762;&#x3002;&#x4E3A;&#x4E86;&#x5E2E;&#x52A9;&#x5176;&#x4ED6;&#x53EF;&#x80FD;&#x548C;&#x6211;&#x9047;&#x5230;&#x4E86;&#x540C;&#x6837;&#x95EE;&#x9898;&#x7684;&#x5A03;&#x4EEC;&#xFF0C;&#x6211;&#x51C6;&#x5907;&#x4E5F;&#x628A;&#x6211;&#x7684;&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x4E0B;&#xFF0C;&#x800C;&#x4E0D;&#x662F;ctrl+c,ctrl+v&#x3002;&#x5E0C;&#x671B;&#x5BF9;&#x5927;&#x5BB6;&#x6709;&#x5E2E;&#x52A9;&#x3002;(&#x90E8;&#x5206;&#x53C2;&#x8003; <a href="http://www.52weis.com" target="_blank" rel="external">www.52weis.com</a> ) </p>
<p>&#x4E00;&#x3002;Memcached&#x5B89;&#x88C5;</p>
<p>&#x9996;&#x5148;&#x8BF4;&#x4E0B;&#xFF0C;Memcache&#x5206;&#x4E3A;&#x670D;&#x52A1;&#x7AEF;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x3002;Memcached&#x662F;&#x670D;&#x52A1;&#x7AEF;&#xFF0C;&#x5B89;&#x88C5;&#x5728;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x800C;&#x4E0B;&#x9762;&#x5C06;&#x8981;&#x4ECB;&#x7ECD;&#x7684;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5B89;&#x88C5;&#x5728;php&#x73AF;&#x5883;&#x4E0B;&#x7684;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<p>1&#x3001;memcached&#x4E0B;&#x8F7D;&#xFF1A;</p>
<p><a href="http://memcached.org/downloads" target="_blank" rel="external">http://memcached.org/downloads</a> (&#x5B98;&#x7F51;&#x4E0B;&#x8F7D;&#x5730;&#x5740;),&#x7B14;&#x8005;&#x4E0B;&#x8F7D;&#x7684;&#x7248;&#x672C;&#x662F; <a href="http://memcached.org/files/memcached-1.4.21.tar.gz" target="_blank" rel="external">memcached-1.4.21.tar.gz</a> (2014-10-12)&#xA0; </p>
<p>2&#x3001;libevent&#x4E0B;&#x8F7D;&#xFF1A;</p>
<p>&#x7531;&#x4E8E;libevent&#x9700;&#x8981;&#x4F7F;&#x7528;&#xFF0C;&#x6545;&#x9700;&#x8981;&#x4E0B;&#x8F7D;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E86;&#x5C31;&#x4E0D;&#x8981;&#x4E0B;&#x8F7D;&#x4E86;&#x3002;&#x5730;&#x5740;&#x4E3A;&#xFF1A; <a href="http://www.monkey.org/~provos/libevent/" target="_blank" rel="external">http://www.monkey.org/~provos/libevent/</a> &#x3002; &#x8FD9;&#x4E2A;&#x662F;memcached&#x5B89;&#x88C5;&#x9700;&#x8981;&#x7684;&#x4F9D;&#x8D56; </p>
<p>3&#x3001;libevent&#x5B89;&#x88C5;:</p>
<p>&#x7531;&#x4E8E;&#x8FD9;&#x4E24;&#x4E2A;&#x5B89;&#x88C5;&#x90FD;&#x4E0D;&#x662F;&#x5F88;&#x590D;&#x6742;&#xFF0C;&#x5C31;&#x53EA;&#x7F57;&#x5217;&#x547D;&#x4EE4;&#x4E86;(&#x89E3;&#x538B;&#x5C31;&#x4E0D;&#x4ECB;&#x7ECD;&#x4E86;&#xFF0C;&#x5E94;&#x8BE5;&#x90FD;&#x77E5;&#x9053;)&#xFF1A;</p>
<p>&#x8FDB;&#x5165;libevent&#x7684;&#x5B89;&#x88C5;&#x76EE;&#x5F55;&#xFF0C;</p>
<p>./configure —prefix=/usr/local/libevent &#xA0;(/usr/local/libevent &#x662F;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;)</p>
<p>&#x7136;&#x540E;make, make install</p>
<p>4&#x3001;memcached&#x5B89;&#x88C5;&#xFF1A;</p>
<p>&#x89E3;&#x538B;&#xFF0C;&#x8FDB;&#x5165;&#x76EE;&#x5F55;&#xFF0C;&#x5B89;&#x88C5;:</p>
<p>./configure —prefix=/usr/local/memcached</p>
<p>&#x7136;&#x540E;make, make install</p>
<p>&#x4E8C;&#x3001;&#x5B89;&#x88C5;php <strong>Memcache&#x6269;&#x5C55;</strong></p>
<p>1&#x3001;&#x4E0B;&#x8F7D;memcache&#xFF08;&#x5BA2;&#x6237;&#x7AEF;&#xFF09;: </p>
<p>&#x5730;&#x5740;&#x4E3A; <a href="http://pecl.php.net/package/memcache" target="_blank" rel="external">http://pecl.php.net/package/memcache</a> ,&#x7B14;&#x8005;&#x4E0B;&#x5F97;&#x7248;&#x672C;&#x662F;3.0.8 </p>
<p>2&#x3001;&#x5B89;&#x88C5;&#xFF1A;</p>
<p>&#x8FDB;&#x5165;&#x89E3;&#x538B;&#x540E;&#x7684;&#x76EE;&#x5F55;&#xFF0C;&#x7B14;&#x8005;&#x662F;/usr/local/memcache, php&#x5B89;&#x88C5;&#x76EE;&#x5F55;&#x5728;/usr/local/php</p>
<p>&#x6267;&#x884C;&#x547D;&#x4EE4;</p>
<p>/usr/local/php/bin/phpize(&#x5728;memcache&#x76EE;&#x5F55;&#x4E0B;&#x6267;&#x884C;)</p>
<p>&#x7136;&#x540E;&#x6267;&#x884C;</p>
<p>./configure —enable-memcache —with-php-config=/usr/local/php/bin/php-config —with-zlib-dir,</p>
<p>make, make install&#x3002;</p>
<p>&#x5728;&#x5B89;&#x88C5;&#x6210;&#x529F;&#x540E;&#x5C06;&#x663E;&#x793A;&#x5982;&#x4E0B;&#x4FE1;&#x606F;&#xFF0C; &#x8BB0;&#x5F55;&#x4E0B;&#x6765;&#xFF0C;&#x7B49;&#x4E0B;&#x9700;&#x8981;&#x7528;&#x5230;, &#x5982;&#x4E0B;&#xFF1A;</p>
<p>/usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/ </p>
<p>&#x7136;&#x540E;&#xFF0C;</p>
<p>&#x628A;php.ini&#x4E2D;&#x7684;extension_dir = &quot;./&quot;&#x4FEE;&#x6539;&#x4E3A;</p>
<p>extension_dir = &quot;/usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/&quot;</p>
<p>&#x7136;&#x540E;</p>
<p>&#x6DFB;&#x52A0;&#x4E00;&#x884C;&#x6765;&#x8F7D;&#x5165;memcache&#x6269;&#x5C55;&#xFF1A;extension=memcache.so</p>
<p>&#x6CE8;&#x610F;&#xFF0C;&#x5728;/usr/local/memcache&#x76EE;&#x5F55;&#x4E0B;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x80FD;&#x6CA1;&#x6709;&#x770B;&#x5230;configure,&#x6240;&#x4EE5;&#x4F1A;&#x56F0;&#x60D1;&#x5982;&#x4F55;&#x6267;&#x884C;./configure&#x5462;&#xFF1F;&#x5176;&#x5B9E;configure&#x662F;&#x7531;php&#x751F;&#x6210;&#x7684;&#xFF0C;&#x547D;&#x540D;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;</p>
<p>/usr/local/php/bin/phpize&#x3002;&#x8FD9;&#x4E2A;&#x5F88;&#x591A;&#x6559;&#x7A0B;&#x90FD;&#x6CA1;&#x6709;&#x8BF4;&#x6E05;&#x695A;&#xFF0C;&#x7B14;&#x8005;&#x4E5F;&#x662F;&#x627E;&#x4E86;&#x5F88;&#x591A;&#x8D44;&#x6599;&#x5728;&#x660E;&#x767D;configure&#x662F;&#x600E;&#x4E48;&#x6765;&#x7684;&#x3002;</p>
<h4 id="&#x4E09;&#x3001;memcached&#x7684;&#x57FA;&#x672C;&#x8BBE;&#x7F6E;&#xFF1A;">&#x4E09;&#x3001;memcached&#x7684;&#x57FA;&#x672C;&#x8BBE;&#x7F6E;&#xFF1A;</h4><p>1.&#x542F;&#x52A8;Memcache&#x7684;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#xFF1A;/usr/local/bin/memcached -d -m 10 -u root -l 192.168.0.200 -p 11211&#xA0;&#xA0;-c 256 -P /tmp/memcached.pid </p>
<p>&#x8FD9;&#x91CC;&#x89E3;&#x91CA;&#x4E0B;&#x542F;&#x52A8;&#x53C2;&#x6570;&#xFF1A;</p>
<p>-d&#xA0;&#xA0; &#x9009;&#x9879;&#x662F;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;</p>
<p>-m&#xA0; &#x662F;&#x5206;&#x914D;&#x7ED9;Memcache&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x6570;&#x91CF;&#xFF0C;&#x5355;&#x4F4D;&#x662F;MB&#xFF0C;&#x9ED8;&#x8BA4;64MB</p>
<p>-M&#xA0; return error on memory exhausted (rather than removing items)</p>
<p>-u&#xA0; &#x662F;&#x8FD0;&#x884C;Memcache&#x7684;&#x7528;&#x6237;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x4E3A;root &#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x6B64;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x7528;&#x6237;&#x3002;</p>
<p>-l&#xA0;&#xA0; &#x662F;&#x76D1;&#x542C;&#x7684;&#x670D;&#x52A1;&#x5668;IP&#x5730;&#x5740;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x6240;&#x6709;&#x7F51;&#x5361;&#x3002;</p>
<p>-p&#xA0; &#x662F;&#x8BBE;&#x7F6E;Memcache&#x7684;TCP&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x6700;&#x597D;&#x662F;1024&#x4EE5;&#x4E0A;&#x7684;&#x7AEF;&#x53E3;</p>
<p>-c&#xA0; &#x9009;&#x9879;&#x662F;&#x6700;&#x5927;&#x8FD0;&#x884C;&#x7684;&#x5E76;&#x53D1;&#x8FDE;&#x63A5;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1024</p>
<p>-P&#xA0; &#x662F;&#x8BBE;&#x7F6E;&#x4FDD;&#x5B58;Memcache&#x7684;pid&#x6587;&#x4EF6;</p>
<p>-f&#xA0;&#xA0; &lt;factor&gt;&#xA0;&#xA0; chunk size growth factor (default: 1.25)</p>
<p>-I&#xA0;&#xA0; Override the size of each slab page. Adjusts max item size(1.4.2&#x7248;&#x672C;&#x65B0;&#x589E;)</p>
<p>&#x8FD0;&#x884C;ps aux|grep memcached</p>
<p>&#x82E5;&#x6709;memcached&#x76F8;&#x5173;&#x8FDB;&#x7A0B;&#x5219;&#x8BF4;&#x660E;&#x6210;&#x529F;&#xFF01;</p>
<p>2.&#x5982;&#x679C;&#x8981;&#x7ED3;&#x675F;Memcache&#x8FDB;&#x7A0B;&#xFF0C;&#x6267;&#x884C;&#xFF1A;</p>
<p>kill <code>cat /tmp/memcached.pid</code></p>
<p>3&#x3001;&#x91CD;&#x542F;apache&#xFF1A;</p>
<p>service httpd restart</p>
<p>4&#x3001;&#x6D4B;&#x8BD5;</p>
<p>&#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7ED3;&#x679C;&#x8F93;&#x51FA;&#x5C31;&#x662F;&#x642D;&#x5EFA;&#x6210;&#x529F;&#x4E86;</p>
<p>&lt; ?php</p>
<p>$mem = new Memcache;</p>
<p>$mem-&gt;connect(&quot;127.0.0.1&quot;, 11211);//11211&#x4E0A;&#x4E0A;&#x9762;&#x8BBE;&#x7F6E;&#x7684;&#x76D1;&#x542C;&#x7AEF;&#x53E3;</p>
<p>$mem-&gt;set(&apos;key&apos;, &apos;it does work!&apos;);</p>
<p>$val = $mem-&gt;get(&apos;key&apos;);</p>
<p>echo $val;</p>
<p>?&gt;</p>
<p>&#x4E09;&#x3001;&#x7ED3;&#x675F;&#x8BED;</p>
<p>&#x5728;&#x5B89;&#x88C5;&#x5404;&#x79CD;&#x8F6F;&#x4EF6;&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x73AF;&#x5883;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x5BFC;&#x81F4;&#x5404;&#x79CD;&#x5B89;&#x88C5;&#x5931;&#x8D25;&#x662F;&#x5F88;&#x6B63;&#x5E38;&#x7684;&#xFF0C;&#x7B14;&#x8005;&#x5C31;&#x66FE;&#x7ECF;&#x5728;&#x5B89;&#x88C5;&#x4E00;&#x6B21;php&#xFF0C;&#x6362;&#x4E2A;&#x673A;&#x5668;&#x88C5;php&#xFF0C;&#x6309;&#x7167;&#x539F;&#x6765;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x5931;&#x8D25;&#x4E86;&#xFF0C;&#x90FD;&#x662F;&#x73AF;&#x5883;&#x7684;&#x95EE;&#x9898;&#x3002;&#x6240;&#x4EE5;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x5728;&#x9047;&#x5230;&#x95EE;&#x9898;&#x65F6;&#xFF0C;&#x5C3D;&#x91CF;&#x591A;&#x53C2;&#x8003;&#x7F51;&#x4E0A;&#x7684;&#x8D44;&#x6599;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x627E;&#x4E86;&#x5F88;&#x591A;&#x8D44;&#x6599;&#x540E;&#x624D;&#x89E3;&#x51B3;&#x95EE;&#x9898;&#xFF0C;&#x5E0C;&#x671B;&#x80FD;&#x628A;&#x7ECF;&#x9A8C;&#x5199;&#x4E0B;&#x6765;&#xFF0C;&#x548C;&#x5927;&#x5BB6;&#x4E00;&#x8D77;&#x5206;&#x4EAB;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7EAF;&#x7CB9;&#x7684;&#x590D;&#x5236;&#x7C98;&#x8D34;&#xFF0C;&#x907F;&#x514D;&#x5176;&#x4ED6;&#x4EBA;&#x6D6A;&#x8D39;&#x8FC7;&#x591A;&#x65F6;&#x95F4;&#x5728;&#x641C;&#x7D22;&#x7B54;&#x6848;&#x4E0A;&#x3002;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x5199;&#x6B64;&#x6559;&#x7A0B;&#x7684;&#x521D;&#x8877;&#xFF0C;&#x8FD8;&#x662F;&#x8981;&#x591A;&#x5206;&#x4EAB;&#x3002;(&#x66F4;&#x591A;&#x8BF7;&#x89C1; <a href="http://www.52weis.com" target="_blank" rel="external">www.52weis.com</a> ) </p>
<p>&#x56DB;&#x3001;&#x53C2;&#x8003;&#xFF1A;</p>
<p><a href="http://www.ccvita.com/257.html" target="_blank" rel="external">Linux&#x4E0B;&#x5F97;Memcache&#x5B89;&#x88C5;</a></p>
<p><a href="http://www.2cto.com/os/201408/328323.html" target="_blank" rel="external">linux&#x5B89;&#x88C5;php&#x4E0E;memcache&#x8FC7;&#x7A0B;&#x8BB0;&#x5F55;</a></p>
<p><a href="http://www.cnsecer.com/5092.html" target="_blank" rel="external">centos&#x4E0B;&#x4F7F;php5.3.X&#x652F;&#x6301;memcache</a></p>
<p>&#x5E0C;&#x671B;&#x4EE5;&#x4E0A;&#x5BF9;&#x5927;&#x5BB6;&#x6709;&#x5E2E;&#x52A9;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/PHP/">PHP</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/19843bf/" title="Memcached的内存管理方式 -" itemprop="url">Memcached的内存管理方式 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Memcached&#x91C7;&#x7528;&#x4E86;&#x540D;&#x4E3A;Slab Allocation&#x7684;&#x673A;&#x5236;&#x5206;&#x914D;&#xFF0C;&#x7BA1;&#x7406;&#x5185;&#x5B58;&#x3002;</p>
<p>Slab Allocation&#x7684;&#x539F;&#x7406;&#x76F8;&#x5F53;&#x7B80;&#x5355;&#x3002;&#x5C06;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5206;&#x5272;&#x6210;&#x5404;&#x79CD;&#x5C3A;&#x5BF8;&#x7684;&#x5757;&#xFF08;chucnk&#xFF09;&#xFF0C;&#x5E76;&#x628A;&#x5C3A;&#x5BF8;&#x76F8;&#x540C;&#x7684;&#x5757;&#x5206;&#x6210;&#x7EC4;&#xFF08;chucnk&#x7684;&#x96C6;&#x5408;&#xFF09;&#x5982;&#x56FE;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/1982dc6.jpg" alt=""></p>
<p>&#x800C;&#x4E14;slab Allocation&#x8FD8;&#x6709;&#x91CD;&#x590D;&#x4F7F;&#x7528;&#x5DF2;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x76EE;&#x7684;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5206;&#x914D;&#x5230;&#x7684;&#x5185;&#x5B58;&#x4E0D;&#x4F1A;&#x91CA;&#x653E;&#xFF0C;&#x800C;&#x662F;&#x91CD;&#x590D;&#x5229;&#x7528;&#x3002;</p>
<p>Slab Allocation &#x7684;&#x4E3B;&#x8981;&#x672F;&#x8BED;</p>
<ul>
<li>Page :&#x5206;&#x914D;&#x7ED9;Slab &#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1MB&#x3002;&#x5206;&#x914D;&#x7ED9;Slab &#x4E4B;&#x540E;&#x6839;&#x636E;slab &#x7684;&#x5927;&#x5C0F;&#x5207;&#x5206;&#x6210;chunk.</li>
<li>Chunk : &#x7528;&#x4E8E;&#x7F13;&#x5B58;&#x8BB0;&#x5F55;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3002;</li>
<li>Slab Class:&#x7279;&#x5B9A;&#x5927;&#x5C0F;&#x7684;chunk &#x7684;&#x7EC4;&#x3002;</li>
</ul>
<p>&#x5728;Slab &#x4E2D;&#x7F13;&#x5B58;&#x8BB0;&#x5F55;&#x7684;&#x539F;&#x7406;</p>
<p>Memcached&#x6839;&#x636E;&#x6536;&#x5230;&#x7684;&#x6570;&#x636E;&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x9009;&#x62E9;&#x6700;&#x5408;&#x9002;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x7684;Slab (&#x56FE;2) memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7740;slab&#x5185;&#x7A7A;&#x95F2;chunk&#x7684;&#x5217;&#x8868;&#xFF0C;&#x6839;&#x636E;&#x8BE5;&#x5217;&#x8868;&#x9009;&#x62E9;chunk,&#x7136;&#x540E;&#x5C06;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x4E8E;&#x5176;&#x4E2D;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/1983037.jpg" alt=""></p>
<p>Memcached&#x5728;&#x6570;&#x636E;&#x8FC7;&#x671F;&#x4E0E;&#x5220;&#x9664;</p>
<p>Memcached&#x5185;&#x90E8;&#x4E0D;&#x4F1A;&#x76D1;&#x89C6;&#x8BB0;&#x5F55;&#x662F;&#x5426;&#x8FC7;&#x671F;&#xFF0C;&#x800C;&#x662F;&#x5728;get&#x6B64;&#x6761;&#x8BB0;&#x5F55;&#x65F6;&#x67E5;&#x770B;&#x5176;&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x68C0;&#x67E5;&#x8BB0;&#x5F55;&#x662F;&#x5426;&#x8FC7;&#x671F;&#x3002;&#x8FD9;&#x79CD;&#x6280;&#x672F;&#x79F0;&#x4E3A;lazy expiration.&#x56E0;&#x6B64;memcached&#x4E0D;&#x4F1A;&#x518D;&#x8FC7;&#x671F;&#x76D1;&#x89C6;&#x4E0A;&#x8017;&#x8D39;CPU&#x65F6;&#x95F4;&#x3002;</p>
<p>&#x6DFB;&#x52A0;&#x65B0;&#x6570;&#x636E;&#x65F6;&#xFF0C;Memcached&#x4F1A;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x5DF2;&#x8D85;&#x65F6;&#x7684;&#x8BB0;&#x5F55;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x7A7A;&#x95F4;&#x4E0D;&#x8DB3;&#xFF0C;&#x6B64;&#x65F6;&#x5C31;&#x8981;&#x4F7F;&#x7528;&#x540D;&#x4E3A;Least Recently Used (LRU&#x6700;&#x8FD1;&#x6700;&#x5C11;&#x4F7F;&#x7528;)&#x673A;&#x5236;&#x6765;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x3002;&#x56E0;&#x6B64;&#x5F53;memcached&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x4E0D;&#x8DB3;&#x65F6;&#xFF08;&#x65E0;&#x6CD5;&#x4ECE;slab class&#xFF09;&#x83B7;&#x53D6;&#x5230;&#x65B0;&#x7A7A;&#x95F4;&#x65F6;&#xFF0C;&#x5C31;&#x4ECE;&#x6700;&#x8FD1;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x8BB0;&#x5F55;&#x4E2D;&#x641C;&#x7D22;&#xFF0C;&#x5E76;&#x5C06;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x7ED9;&#x65B0;&#x7684;&#x8BB0;&#x5F55;&#x3002;</p>
<p>Memcached&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x539F;&#x7406;</p>
<p>Memcached&#x662F;&#x901A;&#x8FC7;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x5B9E;&#x73B0;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#xFF0C;&#x4EE5;&#x65B0;&#x6570;&#x636E;&#xFF08;&#x952E;&#x503C;&#x5BF9;&#xFF09;&#x7684;&#x952E;&#x901A;&#x8FC7;&#x4E00;&#x5B9A;&#x7684;&#x7B97;&#x6CD5;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4FDD;&#x5B58;&#x5728;&#x6B64;&#x670D;&#x52A1;&#x5668;&#x7684;Memcached&#x4E2D;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<p>&#x5411;memcached&#x4E2D;&#x6DFB;&#x52A0;&#x201C;tokyo&#x201D;&#x3002;&#x5C06;&#x201C;tokyo&#x201D;&#x4F20;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#x5E93;&#x540E;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7684;&#x7B97;&#x6CD5;&#x5C31;&#x4F1A;&#x6839;&#x636E;&#x201C;&#x952E;&#x201D;&#x6765;&#x51B3;&#x5B9A;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x7684;memcached&#x670D;&#x52A1;&#x5668;&#x3002;&#x670D;&#x52A1;&#x5668;&#x9009;&#x5B9A;&#x540E;&#xFF0C;&#x5373;&#x547D;&#x4EE4;&#x5B83;&#x4FDD;&#x5B58;&#x201C;tokyo&#x201D;&#x53CA;&#x5176;&#x503C;&#x3002;&#x540C;&#x6837;&#xFF0C;&#x201C;kanagawa&#x201D;&#x201C;chiba&#x201D;&#x201C;saitama&#x201D;&#x201C;gunma&#x201D;&#x90FD;&#x662F;&#x5148;&#x9009;&#x62E9;&#x670D;&#x52A1;&#x5668;&#x518D;&#x4FDD;&#x5B58;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x83B7;&#x53D6;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x3002;&#x83B7;&#x53D6;&#x65F6;&#x4E5F;&#x8981;&#x5C06;&#x8981;&#x83B7;&#x53D6;&#x7684;&#x952E;&#x201C;tokyo&#x201D;&#x4F20;&#x9012;&#x7ED9;&#x51FD;&#x6570;&#x5E93;&#x3002;&#x51FD;&#x6570;&#x5E93;&#x901A;&#x8FC7;&#x4E0E;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x65F6;&#x76F8;&#x540C;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;&#x6839;&#x636E;&#x201C;&#x952E;&#x201D;&#x9009;&#x62E9;&#x670D;&#x52A1;&#x5668;&#x3002;&#x4F7F;&#x7528;&#x7684;&#x7B97;&#x6CD5;&#x76F8;&#x540C;&#xFF0C;&#x5C31;&#x80FD;&#x9009;&#x4E2D;&#x4E0E;&#x4FDD;&#x5B58;&#x65F6;&#x76F8;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x9001;get&#x547D;&#x4EE4;&#x3002;&#x53EA;&#x8981;&#x6570;&#x636E;&#x6CA1;&#x6709;&#x56E0;&#x4E3A;&#x67D0;&#x4E9B;&#x539F;&#x56E0;&#x88AB;&#x5220;&#x9664;&#xFF0C;&#x5C31;&#x80FD;&#x83B7;&#x5F97;&#x4FDD;&#x5B58;&#x7684;&#x503C;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/19832a8.jpg" alt=""></p>
<p>&#x8FD9;&#x6837;&#xFF0C;&#x5C06;&#x4E0D;&#x540C;&#x7684;&#x952E;&#x4FDD;&#x5B58;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x5C31;&#x5B9E;&#x73B0;&#x4E86;memcached&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x3002; memcached&#x670D;&#x52A1;&#x5668;&#x589E;&#x591A;&#x540E;&#xFF0C;&#x952E;&#x5C31;&#x4F1A;&#x5206;&#x6563;&#xFF0C;&#x5373;&#x4F7F;&#x4E00;&#x53F0;memcached&#x670D;&#x52A1;&#x5668;&#x53D1;&#x751F;&#x6545;&#x969C;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F9D;&#x7136;&#x80FD;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x3002;</p>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-06/../../Linux/2015-06/118830.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-06/118830.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/19812eb/" title="RDBMS，memcache -" itemprop="url">RDBMS，memcache -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:20.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>1&#x3001;RDBMS&#x5373;&#x5173;&#x7CFB;&#x6570;&#x636E;&#x5E93;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;(Relational Database Management System)&#xFF0C;&#x662F;&#x5C06;&#x6570;&#x636E;&#x7EC4;&#x7EC7;&#x4E3A;&#x76F8;&#x5173;&#x7684;&#x884C;&#x548C;&#x5217;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x800C;&#x7BA1;&#x7406;&#x5173;&#x7CFB;&#x6570;&#x636E;&#x5E93;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x8F6F;&#x4EF6;&#x5C31;&#x662F;&#x5173;&#x7CFB;&#x6570;&#x636E;&#x5E93;&#x7BA1;&#x7406;&#x7CFB;&#x7EDF;&#xFF0C;&#x5E38;&#x7528;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8F6F;&#x4EF6;&#x6709;Oracle&#x3001;SQL Server&#x7B49;&#x3002;</p>
<p>2&#x3001;memcache&#x662F;&#x4E00;&#x5957;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x7531;LiveJournal&#x7684;Brad Fitzpatrick&#x5F00;&#x53D1;&#xFF0C;&#x4F46;&#x76EE;&#x524D;&#x88AB;&#x8BB8;&#x591A;&#x7F51;&#x7AD9;&#x4F7F;&#x7528;&#x4EE5;&#x63D0;&#x5347;&#x7F51;&#x7AD9;&#x7684;&#x8BBF;&#x95EE;&#x901F;&#x5EA6;&#xFF0C;&#x5C24;&#x5176;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5927;&#x578B;&#x7684;&#x3001;&#x9700;&#x8981;&#x9891;&#x7E41;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x5E93;&#x7684;&#x7F51;&#x7AD9;&#x8BBF;&#x95EE;&#x901F;&#x5EA6;&#x63D0;&#x5347;&#x6548;&#x679C;&#x5341;&#x5206;&#x663E;&#x8457;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x5957;&#x5F00;&#x653E;&#x6E90;&#x4EE3;&#x7801;&#x8F6F;&#x4EF6;&#xFF0C;&#x4EE5;BSD license&#x6388;&#x6743;&#x53D1;&#x5E03;&#x3002;<br>MemCache&#x7684;&#x5DE5;&#x4F5C;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;&#x5148;&#x68C0;&#x67E5;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x636E;&#x662F;&#x5426;&#x5728;memcached&#x4E2D;&#xFF0C;&#x5982;&#x6709;&#xFF0C;&#x76F4;&#x63A5;&#x628A;&#x8BF7;&#x6C42;&#x6570;&#x636E;&#x8FD4;&#x56DE;&#xFF0C;&#x4E0D;&#x518D;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x8FDB;&#x884C;&#x4EFB;&#x4F55;&#x64CD;&#x4F5C;&#xFF1B;&#x5982;&#x679C;&#x8BF7;&#x6C42;&#x7684;&#x6570;&#x636E;&#x4E0D;&#x5728;memcached&#x4E2D;&#xFF0C;&#x5C31;&#x53BB;&#x67E5;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x628A;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x83B7;&#x53D6;&#x7684;&#x6570;&#x636E;&#x8FD4;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x540C;&#x65F6;&#x628A;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x4E00;&#x4EFD;&#x5230;memcached&#x4E2D;&#xFF08;memcached&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x8D1F;&#x8D23;&#xFF0C;&#x9700;&#x8981;&#x7A0B;&#x5E8F;&#x660E;&#x786E;&#x5B9E;&#x73B0;&#xFF09;&#xFF1B;&#x6BCF;&#x6B21;&#x66F4;&#x65B0;&#x6570;&#x636E;&#x5E93;&#x7684;&#x540C;&#x65F6;&#x66F4;&#x65B0;memcached&#x4E2D;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4FDD;&#x8BC1;&#x4E00;&#x81F4;&#x6027;&#xFF1B;&#x5F53;&#x5206;&#x914D;&#x7ED9;memcached&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x7528;&#x5B8C;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x4F7F;&#x7528;LRU&#xFF08;Least Recently Used&#xFF0C;&#x6700;&#x8FD1;&#x6700;&#x5C11;&#x4F7F;&#x7528;&#xFF09;&#x7B56;&#x7565;&#x52A0;&#x4E0A;&#x5230;&#x671F;&#x5931;&#x6548;&#x7B56;&#x7565;&#xFF0C;&#x5931;&#x6548;&#x6570;&#x636E;&#x9996;&#x5148;&#x88AB;&#x66FF;&#x6362;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x66FF;&#x6362;&#x6389;&#x6700;&#x8FD1;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x6570;&#x636E;&#x3002;<br>Memcache&#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x5DE8;&#x5927;&#x7684;hash&#x8868;&#xFF0C;&#x5B83;&#x80FD;&#x591F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x5404;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5305;&#x62EC;&#x56FE;&#x50CF;&#x3001;&#x89C6;&#x9891;&#x3001;&#x6587;&#x4EF6;&#x4EE5;&#x53CA;&#x6570;&#x636E;&#x5E93;&#x68C0;&#x7D22;&#x7684;&#x7ED3;&#x679C;&#x7B49;&#x3002;&#x7B80;&#x5355;&#x7684;&#x8BF4;&#x5C31;&#x662F;&#x5C06;&#x6570;&#x636E;&#x8C03;&#x7528;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x4ECE;&#x5185;&#x5B58;&#x4E2D;&#x8BFB;&#x53D6;&#xFF0C;&#x4ECE;&#x800C;&#x5927;&#x5927;&#x63D0;&#x9AD8;&#x8BFB;&#x53D6;&#x901F;&#x5EA6;&#x3002;—-&#x4EE5;&#x4E0A;&#x5185;&#x5BB9;&#x6765;&#x81EA;&#x767E;&#x5EA6; </p>
<p>3&#x3001;&#x5206;&#x4EAB;&#x4E0B;&#x6587;&#x7AE0; &#x5927;&#x578B;&#x7F51;&#x7AD9;&#x67B6;&#x6784;&#x4F53;&#x7CFB;&#x7684;&#x6F14;&#x53D8;&#xFF08;&#x4E0A;&#xFF09;</p>
<p>&#xFF1A;<a href="http://blog.jobbole.com/87736/&#xFF08;&#x4E0B;&#x56FE;&#x4E5F;&#x6765;&#x81EA;&#x8BE5;&#x6587;&#x7AE0;&amp;#xFF09" target="_blank" rel="external">http://blog.jobbole.com/87736/&#xFF08;&#x4E0B;&#x56FE;&#x4E5F;&#x6765;&#x81EA;&#x8BE5;&#x6587;&#x7AE0;&amp;#xFF09</a>;<br>&#x9644;&#x56FE;&#x4E00;&#x5F20;&#xFF0C;&#x5E2E;&#x52A9;&#x7406;&#x89E3;&#x4E0B;MemCache&#x7684;&#x5E94;&#x7528;&#xFF08;&#x7F51;&#x7AD9;&#xFF09;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/197f59f.png" alt=""></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/数据库/">数据库</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/11c0c6e/" title="storm源码分析之任务分配--task assignment -" itemprop="url">storm源码分析之任务分配--task assignment -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:06.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5728;&quot;storm&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;topology&#x63D0;&#x4EA4;&#x8FC7;&#x7A0B;&quot;&#x4E00;&#x6587;&#x6700;&#x540E;&#xFF0C;submitTopologyWithOpts&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4E86;mk-assignments&#x51FD;&#x6570;&#x3002;&#x8BE5;&#x51FD;&#x6570;&#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x5C31;&#x662F;&#x8FDB;&#x884C;topology&#x7684;&#x4EFB;&#x52A1;&#x5206;&#x914D;&#xFF08;task assignment&#xFF09;&#x3002;mk-assignments&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>;; get existing assignment (just the executor-&gt;node+port map) -&gt; default to {}</p>
<p>;; filter out ones which have a executor timeout</p>
<p>;; figure out available slots on cluster. add to that the used valid slots to get total slots. figure out how many executors should be in each slot (e.g., 4, 4, 4, 5)</p>
<p>;; only keep existing slots that satisfy one of those slots. for rest, reassign them across remaining slots</p>
<p>;; edge case for slots with no executor timeout but with supervisor timeout… just treat these as valid slots that can be reassigned to. worst comes to worse the executor will timeout and won&apos;t assign here next time around</p>
<p>( defnk  mk-assignments  [  nimbus  :scratch-topology-id  nil  ]</p>
<p>( let  [  conf ( :conf  nimbus ) </p>
<p> storm-cluster-state ( :storm-cluster-state  nimbus ) </p>
<p> ^  INimbus  inimbus ( :inimbus  nimbus ) </p>
<p> ;; read all the topologies</p>
<p> topology-ids ( .active-storms  storm-cluster-state ) </p>
<p> ;; topologies&#x7ED1;&#x5B9A;topology id-&gt;TopologyDetails&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map</p>
<p> topologies ( into  {} ( for  [  tid  topology-ids  ]</p>
<p> {  tid ( read-topology-details  nimbus  tid  )}))</p>
<p> ;; topologies&#x91CD;&#x65B0;&#x7ED1;&#x5B9A;Topologies&#x5BF9;&#x8C61;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;Topologies.java&#x3002;</p>
<p> topologies ( Topologies.  topologies ) </p>
<p> ;; read all the assignments</p>
<p> ;; assigned-topology-ids&#x7ED1;&#x5B9A;zookeeper&#x4E2D;/assignments/&#x4E0B;&#x7684;&#x6240;&#x6709;topology id&#x3002;</p>
<p> assigned-topology-ids ( .assignments  storm-cluster-state  nil ) </p>
<p> ;; existing-assignments&#x7ED1;&#x5B9A;topology id-&gt;AssignmentInfo&#x4FE1;&#x606F;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#x3002;storm&#x96C6;&#x7FA4;&#x4E0A;&#x6240;&#x6709;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x7684;&quot;&#x5206;&#x914D;&quot;</p>
<p> existing-assignments ( into  {} ( for  [  tid  assigned-topology-ids  ]</p>
<p> ;; for the topology which wants rebalance (specified by the scratch-topology-id)</p>
<p> ;; we exclude its assignment, meaning that all the slots occupied by its assignment</p>
<p> ;; will be treated as free slot in the scheduler code.</p>
<p>( when ( or ( nil?  scratch-topology-id ) ( not=  tid  scratch-topology-id )) </p>
<p>;; assignment-info&#x51FD;&#x6570;&#x8FD4;&#x56DE;tid&#x5BF9;&#x5E94;&#x7684;AssignmentInfo&#x4FE1;&#x606F;&#xFF0C;</p>
<p>;; (defrecord Assignment [master-code-dir node-&gt;host executor-&gt;node+port executor-&gt;start-time-secs])</p>
<p> {  tid ( .assignment-info  storm-cluster-state  tid  nil  )})))</p>
<p> ;; make the new assignments for topologies</p>
<p> ;; topology-&gt;executor-&gt;node+port&#x7ED1;&#x5B9A;cluster&#x4E2D;&#x6700;&#x65B0;&#x7684;&#x5206;&#x914D;&#x4FE1;&#x606F;{topology-id -&gt; {executor [node port]}}</p>
<p> topology-&gt;executor-&gt;node+port ( compute-new-topology-&gt;executor-&gt;node+port</p>
<p> nimbus</p>
<p> existing-assignments</p>
<p> topologies</p>
<p> scratch-topology-id ) </p>
<p> ;; now-secs&#x7ED1;&#x5B9A;&#x5F53;&#x524D;&#x65F6;&#x95F4;</p>
<p> now-secs ( current-time-secs ) </p>
<p> ;; basic-supervisor-details-map&#x7ED1;&#x5B9A;supervisor id-&gt;SupervisorDetails&#x7684;map</p>
<p> basic-supervisor-details-map ( basic-supervisor-details-map  storm-cluster-state ) </p>
<p> ;; construct the final Assignments by adding start-times etc into it</p>
<p> ;; new-assignments&#x7ED1;&#x5B9A;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x6700;&#x65B0;&#x5206;&#x914D;&#x4FE1;&#x606F;topology-id-&gt;Assignment&#x7684;map</p>
<p> new-assignments ( into  {} ( for  [[  topology-id  executor-&gt;node+port  ]  topology-&gt;executor-&gt;node+port</p>
<p> ;; existing-assignment&#x7ED1;&#x5B9A;topology-id&#x5728;zookeeper&#x4E0A;&#x7684;&#x5206;&#x914D;&#x4FE1;&#x606F;AssignmentInfo&#xFF0C;&#x5BF9;&#x4E8E;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x6765;&#x8BF4;&#xFF0C;existing-assignment&#x4E3A;nil</p>
<p> :let  [  existing-assignment ( get  existing-assignments  topology-id ) </p>
<p> ;; all-nodes&#x7ED1;&#x5B9A;cluster&#x4E2D;&#x5206;&#x914D;&#x7ED9;&#x5B83;&#x7684;supervisor id&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;#{node1 node2 …}</p>
<p> all-nodes ( -&gt;&gt;  executor-&gt;node+port  vals ( map  first ) set ) </p>
<p> ;; node-&gt;host&#x7ED1;&#x5B9A;supervisor id-&gt;host-name&#x7684;map&#xFF0C;&#x5982;{node1 host1 node2 host2 …}</p>
<p> node-&gt;host ( -&gt;&gt;  all-nodes</p>
<p>( mapcat ( fn  [  node  ]</p>
<p>( if-let  [  host ( .getHostName  inimbus  basic-supervisor-details-map  node  )]</p>
<p> [[  node  host  ]]</p>
<p>)))</p>
<p>( into  {}))</p>
<p> ;; &#x5BF9;&#x4E8E;&#x8FDB;&#x884C;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;topology&#xFF0C;node-&gt;host&#x5B58;&#x653E;&#x7684;&#x662F;cluster&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7ED9;&#x5B83;&#x7684;supervisor&#xFF0C;existing-assignment&#x5B58;&#x653E;&#x4E86;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x4E4B;&#x524D;&#xFF0C;&#x8BE5;topology&#x6240;&#x62E5;&#x6709;&#x7684;&#x65E7;&#x7684; ;;&#xA0;supervisor</p>
<p> ;; all-node-&gt;host&#x5B58;&#x653E;&#x4E86;&#x4E24;&#x8005;&#x7684;&#x5E76;&#x96C6;</p>
<p> all-node-&gt;host ( merge ( :node-&gt;host  existing-assignment ) node-&gt;host ) </p>
<p> ;; reassign-executors&#x7ED1;&#x5B9A;cluster&#x4E2D;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;executor&#xFF1B;changed-executors&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> reassign-executors ( changed-executors ( :executor-&gt;node+port  existing-assignment ) executor-&gt;node+port ) </p>
<p> ;; &#x4E3A;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;executor&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x4E0E;&#x65E7;&#x5206;&#x914D;&#x4E2D;executor&#x7684;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#x8FDB;&#x884C;&#x5408;&#x5E76;&#xFF0C;&#x4FDD;&#x5B58;&#x5728;start-times</p>
<p> start-times ( merge ( :executor-&gt;start-time-secs  existing-assignment ) </p>
<p>( into  {}</p>
<p>( for  [  id  reassign-executors  ]</p>
<p> [  id  now-secs  ]</p>
<p> )))]]</p>
<p> ;; &#x521B;&#x5EFA;topology-id-&gt;Assignment&#x7684;map</p>
<p> ;; Assignment&#x5B9A;&#x4E49;&#xFF1A;(defrecord Assignment [master-code-dir node-&gt;host executor-&gt;node+port executor-&gt;start-time-secs])</p>
<p> {  topology-id ( Assignment.</p>
<p> ;; master-stormdist-root&#x51FD;&#x6570;&#x8FD4;&#x56DE;topology&#x5728;nimbus&#x4E0A;&#x7684;&#x4EE3;&#x7801;&#x76EE;&#x5F55;</p>
<p>( master-stormdist-root  conf  topology-id ) </p>
<p> ;; select-keys&#x51FD;&#x6570;&#x8FD4;&#x56DE;all-node-&gt;host&#x4E2D;key&#x5305;&#x542B;&#x5728;all-nodes&#x96C6;&#x5408;&#x7684;&#x952E;&#x503C;&#x5BF9;</p>
<p>( select-keys  all-node-&gt;host  all-nodes ) </p>
<p> executor-&gt;node+port</p>
<p> start-times  )}))]</p>
<p> ;; tasks figure out what tasks to talk to by looking at topology at runtime</p>
<p> ;; only log/set when there&apos;s been a change to the assignment</p>
<p>( doseq  [[  topology-id  assignment  ]  new-assignments</p>
<p> :let  [  existing-assignment ( get  existing-assignments  topology-id ) </p>
<p> topology-details ( .getById  topologies  topology-id  )]]</p>
<p> ;; &#x5982;&#x679C;&#x65B0;&#x5206;&#x914D;assignment&#x4E0D;&#x7B49;&#x4E8E;zookeeper&#x4E2D;&#x7684;existing-assignment&#xFF0C;&#x5219;&#x8C03;&#x7528;storm-cluster-state&#x7684;set-assignment!&#x51FD;&#x6570;&#x5C06;&#x8FD9;&#x4E2A;&#x65B0;&#x5206;&#x914D;&#x4FE1;&#x606F;&#x91CD;&#x65B0;&#x5199;&#x5165;zookeeper</p>
<p>( if ( =  existing-assignment  assignment ) </p>
<p>( log-debug  &quot;Assignment for &quot;  topology-id  &quot; hasn&apos;t changed&quot; ) </p>
<p>( do</p>
<p>( log-message  &quot;Setting new assignment for topology id &quot;  topology-id  &quot;: &quot; ( pr-str  assignment )) </p>
<p>( .set-assignment!  storm-cluster-state  topology-id  assignment ) </p>
<p>)))</p>
<p>( -&gt;&gt;  new-assignments</p>
<p>( map ( fn  [[  topology-id  assignment  ]]</p>
<p>( let  [  existing-assignment ( get  existing-assignments  topology-id  )]</p>
<p> ;; newly-added-slots&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x65B0;&#x5206;&#x914D;&#x7ED9;&#x8BE5;topology&#x7684;slot&#x96C6;&#x5408;#{[node1 port1] [node1 port2] [node2 port1] …}</p>
<p> ;; (map to-worker-slot)&#x8FD4;&#x56DE;WorkerSlot&#x5BF9;&#x8C61;&#x7684;&#x96C6;&#x5408;</p>
<p> [  topology-id ( map  to-worker-slot ( newly-added-slots  existing-assignment  assignment  ))]</p>
<p>)))</p>
<p> ;; &#x8FD4;&#x56DE;topology-id-&gt;WorkerSlot&#x5BF9;&#x8C61;&#x96C6;&#x5408;&#x7684;map</p>
<p>( into  {})</p>
<p> ;; &#x5F53;&#x524D;&#x7248;&#x672C;assignSlots&#x51FD;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;&#x5B9E;&#x73B0;</p>
<p>( .assignSlots  inimbus  topologies )) </p>
<p>))</p>
<p>&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x91CA;&#x9610;&#x8FF0;&#x4E86;&#x8BE5;&#x51FD;&#x6570;&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x3002;conf&#x7ED1;&#x5B9A;nimbus&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;inimbus&#x7ED1;&#x5B9A;nimbus&#x5B9E;&#x4F8B;&#xFF0C;topology-ids&#x7ED1;&#x5B9A;&#x6240;&#x6709;&#x72B6;&#x6001;&#x4E3A;&quot;active&quot;&#x7684;topology id&#x96C6;&#x5408;&#x3002;active-storms&#x51FD;&#x6570;&#x83B7;&#x53D6;zookeeper&#x4E2D;/storms/&#x7684;&#x6240;&#x6709;children&#xFF08;&#x5373;&#x6240;&#x6709;topology id&#xFF09;&#xFF0C;/storms/{topology-id}&#x4E2D;&#x5B58;&#x653E;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;topology&#x4FE1;&#x606F;&#x3002;&#x4FDD;&#x5B58;&#x7684;&#x5185;&#x5BB9;&#x53C2;&#x8003;common.clj&#x4E2D;&#x7684;&#x7C7B;StormBase(defrecord StormBase [storm-name launch-time-secs status num-workers component-&gt;executors])&#x3002;topologies&#x7ED1;&#x5B9A;topology id-&gt;TopologyDetails&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#x3002;read-topology-details&#x51FD;&#x6570;&#x6839;&#x636E;&#x6BCF;&#x4E2A;topology id&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;TopologyDetails&#x5BF9;&#x8C61;&#x3002;TopologyDetails&#x7C7B;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> public  class  TopologyDetails  {</p>
<p> String  topologyId ; </p>
<p> Map  topologyConf ; </p>
<p> StormTopology  topology ; </p>
<p> Map  &lt;  ExecutorDetails  ,  String  &gt;  executorToComponent ; </p>
<p> int  numWorkers ; </p>
<p> //get and set&#x65B9;&#x6CD5;</p>
<p> …  …</p>
<p> //&#x6784;&#x9020;&#x65B9;&#x6CD5;</p>
<p> …  …</p>
<p> public  Map  &lt;  ExecutorDetails  ,  String  &gt;  selectExecutorToComponent ( Collection  &lt;  ExecutorDetails  &gt;  executors ) {</p>
<p> Map  &lt;  ExecutorDetails  ,  String  &gt;  ret  =  new  HashMap  &lt;  ExecutorDetails  ,  String  &gt;(  executors  .  size ()); </p>
<p> for ( ExecutorDetails  executor  :  executors ) {</p>
<p> String  compId  =  this  .  executorToComponent  .  get ( executor ); </p>
<p> if ( compId  !=  null ) {</p>
<p> ret  .  put ( executor  ,  compId ); </p>
<p> }</p>
<p> }</p>
<p> return  ret ; </p>
<p> }</p>
<p> public  Collection  &lt;  ExecutorDetails  &gt;  getExecutors () {</p>
<p> return  this  .  executorToComponent  .  keySet (); </p>
<p> }</p>
<p>}</p>
<p>Topologies&#x7C7B;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> public  class  Topologies  {</p>
<p> Map  &lt;  String  ,  TopologyDetails  &gt;  topologies ; </p>
<p> Map  &lt;  String  ,  String  &gt;  nameToId ; </p>
<p> public  Topologies ( Map  &lt;  String  ,  TopologyDetails  &gt;  topologies ) {</p>
<p> if ( topologies  ==  null ) topologies  =  new  HashMap (); </p>
<p> this  .  topologies  =  new  HashMap  &lt;  String  ,  TopologyDetails  &gt;(  topologies  .  size ()); </p>
<p> this  .  topologies  .  putAll ( topologies ); </p>
<p> this  .  nameToId  =  new  HashMap  &lt;  String  ,  String  &gt;(  topologies  .  size ()); </p>
<p> for ( String  topologyId  :  topologies  .  keySet ()) {</p>
<p> TopologyDetails  topology  =  topologies  .  get ( topologyId ); </p>
<p> this  .  nameToId  .  put ( topology  .  getName  (),  topologyId ); </p>
<p> }</p>
<p> }</p>
<p> public  TopologyDetails  getById ( String  topologyId ) {</p>
<p> return  this  .  topologies  .  get ( topologyId ); </p>
<p> }</p>
<p> public  TopologyDetails  getByName ( String  topologyName ) {</p>
<p> String  topologyId  =  this  .  nameToId  .  get ( topologyName ); </p>
<p> if ( topologyId  ==  null ) {</p>
<p> return  null ; </p>
<p> }  else  {</p>
<p> return  this  .  getById ( topologyId ); </p>
<p> }</p>
<p> }</p>
<p> public  Collection  &lt;  TopologyDetails  &gt;  getTopologies () {</p>
<p> return  this  .  topologies  .  values (); </p>
<p> }</p>
<p>}</p>
<p>read-topology-details&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  read-topology-details  [  nimbus  storm-id  ]</p>
<p>( let  [  conf ( :conf  nimbus ) </p>
<p> storm-base ( .storm-base ( :storm-cluster-state  nimbus ) storm-id  nil ) </p>
<p> topology-conf ( read-storm-conf  conf  storm-id ) </p>
<p> topology ( read-storm-topology  conf  storm-id ) </p>
<p> ;; executor-&gt;component&#x7ED1;&#x5B9A;ExecutorDetails&#x5BF9;&#x8C61;-&gt;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5982;{ExecutorDetails(1, 2) &quot;boltA&quot; ExecutorDetails(3, 4) &quot;boltA&quot; ExecutorDetails(5, 5) &quot;boltB&quot; ExecutorDetails(6, &#xA0; &#xA0; &#xA0; 6) &quot;boltB&quot;}&#xFF0C;compute-executor-&gt;component&#x51FD;&#x6570;&#x8BF7;&#x89C1;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> ;; ExecutorDetails&#x7C7B;&#x8BF7;&#x89C1;ExecutorDetails.java</p>
<p> executor-&gt;component ( -&gt;&gt; ( compute-executor-&gt;component  nimbus  storm-id ) </p>
<p>( map-key ( fn  [[  start-task  end-task  ]]</p>
<p>( ExecutorDetails. ( int  start-task ) ( int  end-task  )))))]</p>
<p> ;; &#x8FD4;&#x56DE;TopologyDetails&#x5BF9;&#x8C61;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;TopologyDetails.java</p>
<p>( TopologyDetails.  storm-id</p>
<p> topology-conf</p>
<p> topology</p>
<p>( :num-workers  storm-base ) </p>
<p> executor-&gt;component</p>
<p>)))</p>
<p>storm-base&#x7ED1;&#x5B9A;topology id&#x6240;&#x5BF9;&#x5E94;&#x7684;StormBase&#x5BF9;&#x8C61;&#x3002;storm-base&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5728;cluster.clj&#x6587;&#x4EF6;&#x7684;StormClusterState&#x534F;&#x8BAE;&#x4E2D;&#xFF0C;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( storm-base</p>
<p> [  this  storm-id  callback  ]</p>
<p>( when  callback</p>
<p>( swap!  storm-base-callback  assoc  storm-id  callback )) </p>
<p>( maybe-deserialize ( get-data  cluster-state ( storm-path  storm-id ) ( not-nil? callback</p>
<p>))))</p>
<p>maybe-deserialize&#x51FD;&#x6570;&#x5C06;get-data&#x51FD;&#x6570;&#x4ECE;zookeeper&#x7684;/storms/{topology id}&#x83B7;&#x53D6;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x636E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6210;StormBase&#x5BF9;&#x8C61;&#x3002;topology-conf&#x7ED1;&#x5B9A;topology&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;read-storm-conf&#x51FD;&#x6570;&#x4ECE;/nimbus/stormdist/{topology id}&#x8BFB;&#x53D6;stormconf.ser&#x4FE1;&#x606F;&#x5E76;&#x5408;&#x5E76;&#x5230;conf&#x4E2D;&#x8FD4;&#x56DE;&#xFF0C;read-storm-conf&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  read-storm-conf  [  conf  storm-id  ]</p>
<p>( let  [  stormroot ( master-stormdist-root  conf  storm-id  )]</p>
<p>( merge  conf</p>
<p>( Utils/deserialize</p>
<p>( FileUtils/readFileToByteArray</p>
<p>( File. ( master-stormconf-path  stormroot )) </p>
<p>)))))</p>
<p>topology&#x7ED1;&#x5B9A;read-storm-topology&#x51FD;&#x6570;&#x83B7;&#x53D6;&#x7684;topology&#x5BF9;&#x8C61;&#xFF0C;read-storm-topology&#x51FD;&#x6570;&#x4ECE;/nimbus/stormdist/{topology id}&#x8BFB;&#x53D6;stormcode.ser&#x4FE1;&#x606F;&#x5E76;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6210;&#x4E00;&#x4E2A;topology&#x5BF9;&#x8C61;&#x3002;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  read-storm-topology  [  conf  storm-id  ]</p>
<p>( let  [  stormroot ( master-stormdist-root  conf  storm-id  )]</p>
<p>( Utils/deserialize</p>
<p>( FileUtils/readFileToByteArray</p>
<p>( File. ( master-stormcode-path  stormroot )) </p>
<p>))))</p>
<p>compute-executor-&gt;component&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  compute-executor-&gt;component  [  nimbus  storm-id  ]</p>
<p>( let  [  conf ( :conf  nimbus ) </p>
<p> ;; executors&#x7ED1;&#x5B9A;&#x7EBF;&#x7A0B;id&#x96C6;&#x5408;&#xFF0C;&#x5982;([1 2] [3 4] [5 5] [6 6])&#xFF0C;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x8BF7;&#x89C1;compute-executors&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> executors ( compute-executors  nimbus  storm-id ) </p>
<p> topology ( read-storm-topology  conf  storm-id ) </p>
<p> storm-conf ( read-storm-conf  conf  storm-id ) </p>
<p> ;; task-&gt;component&#x7ED1;&#x5B9A;&#x4EFB;&#x52A1;id-&gt;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5F62;&#x5982;&#xFF1A;{1 &quot;boltA&quot;, 2 &quot;boltA&quot;, 3 &quot;boltA&quot;, 4 &quot;boltA&quot;, 5 &quot;boltB&quot;, 6 &quot;boltB&quot;}&#xFF0C;&#x5177;&#x4F53;&#x8BF7;&#x89C1;storm-task-info&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> task-&gt;component ( storm-task-info  topology  storm-conf ) </p>
<p> ;; executor-&gt;component&#x7ED1;&#x5B9A;&#x7EBF;&#x7A0B;id-&gt;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5982;{[1 2] &quot;boltA&quot; [3 4] &quot;boltA&quot; [5 5] &quot;boltB&quot; [6 6] &quot;boltB&quot;}</p>
<p> executor-&gt;component ( into  {} ( for  [  executor  executors</p>
<p> :let  [  start-task ( first  executor ) </p>
<p> component ( task-&gt;component  start-task  )]]</p>
<p> {  executor  component }))]))</p>
<p>compute-executors&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  compute-executors  [  nimbus  storm-id  ]</p>
<p>( let  [  conf ( :conf  nimbus ) </p>
<p> ;; storm-base&#x7ED1;&#x5B9A;start-storm&#x51FD;&#x6570;&#x5199;&#x5165;zookeeper&#x7684;topology&#x6240;&#x5BF9;&#x5E94;&#x7684;StormBase&#x5BF9;&#x8C61;</p>
<p> storm-base ( .storm-base ( :storm-cluster-state  nimbus ) storm-id  nil ) </p>
<p> ;; component-&gt;executors&#x7ED1;&#x5B9A;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;-&gt;&#x7EC4;&#x4EF6;&quot;&#x5E76;&#x884C;&#x5EA6;&quot;(&#x6BCF;&#x4E2A;&#x7EC4;&#x4EF6;&#x6709;&#x51E0;&#x4E2A;executor)&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5F62;&#x5982;{&quot;boltA&quot; 2, &quot;boltB&quot; 2}</p>
<p> component-&gt;executors ( :component-&gt;executors  storm-base ) </p>
<p> ;; storm-conf&#x7ED1;&#x5B9A;topology&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</p>
<p> storm-conf ( read-storm-conf  conf  storm-id ) </p>
<p> ;; topology&#x7ED1;&#x5B9A;topology&#x5BF9;&#x8C61;</p>
<p> topology ( read-storm-topology  conf  storm-id ) </p>
<p> ;; task-&gt;component&#x7ED1;&#x5B9A;&#x4EFB;&#x52A1;id-&gt;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5F62;&#x5982;&#xFF1A;{1 &quot;boltA&quot;, 2 &quot;boltA&quot;, 3 &quot;boltA&quot;, 4 &quot;boltA&quot;, 5 &quot;boltB&quot;, 6 &quot;boltB&quot;}</p>
<p> task-&gt;component ( storm-task-info  topology  storm-conf  )]</p>
<p> ;; -&gt;&gt;&#x662F;clojure&#x7684;&#x4E00;&#x4E2A;&#x5B8F;&#xFF0C;&#x5C06;(storm-task-info topology storm-conf)&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4F5C;&#x4E3A;reverse-map&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x5C06;reverse-map&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4F5C;&#x4E3A;map-val&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4F9D;&#x6B21;&#x7C7B;&#x63A8;</p>
<p>( -&gt;&gt; ( storm-task-info  topology  storm-conf ) </p>
<p> ;; reverse-map&#x51FD;&#x6570;&#x7684;&#x8F93;&#x5165;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;map&#xFF0C;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;map&#x6309;&#x503C;&#x5206;&#x7C7B;&#x540E;&#x7684;&#x7ED3;&#x679C;map&#xFF0C;&#x8F93;&#x5165;&#x53C2;&#x6570;&#x4E3A;{1 &quot;boltA&quot;, 2 &quot;boltA&quot;, 3 &quot;boltA&quot;, 4 &quot;boltA&quot;, 5 &quot;boltB&quot;, 6 &quot;boltB&quot;}</p>
<p> ;; &#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4E3A;{&quot;boltA&quot; [3 4 2 1], &quot;boltB&quot; [5 6]}&#x3002;reverse-map&#x5B9A;&#x4E49;&#x5728;util.clj&#x4E2D;</p>
<p> reverse-map</p>
<p> ;; map-val&#x51FD;&#x6570;&#x6709;&#x4E24;&#x4E2A;&#x8F93;&#x5165;&#x53C2;&#x6570;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x7B2C;&#x4E8C;&#x53C2;&#x6570;&#x662F;map&#xFF0C;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x662F;&#x4E00;&#x4E2A;map&#xFF1B;&#x7ED3;&#x679C;map&#x7684;key&#x5C31;&#x662F;&#x8F93;&#x5165;map&#x7684;key&#xFF0C;&#x7ED3;&#x679C;map&#x7684;value&#x662F;&#x8F93;&#x5165;map&#x7684;value&#x8C03;&#x7528;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;</p>
<p> ;;(map-val sort {&quot;boltA&quot; [3 4 2 1], &quot;boltB&quot; [5 6]})&#x8FD4;&#x56DE;{&quot;boltA&quot; (1 2 3 4), &quot;boltB&quot; (5 6)}&#x3002;map-val&#x5B9A;&#x4E49;&#x5728;util.clj&#x4E2D;</p>
<p>( map-val  sort ) </p>
<p> ;; join-maps&#x51FD;&#x6570;&#x5C06;component-&gt;executors&#x548C;(map-val sort)&#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x5408;&#x5E76;&#xFF0C;component-&gt;executors={&quot;boltA&quot; 2, &quot;boltB&quot; 2}&#xFF0C;(map-val sort)={&quot;boltA&quot; (1 2 3 4), &quot;boltB&quot; (5 6)}</p>
<p> ;; join-maps&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4E3A;{&quot;boltA&quot; (2 [1 2 3 4]), &quot;boltB&quot; (2 [5 6])}</p>
<p>( join-maps  component-&gt;executors ) </p>
<p> ;; map-val&#x51FD;&#x6570;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;partial&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x504F;&#x51FD;&#x6570;&#xFF0C;&#x51FD;&#x6570;&#x4F53;&#x5C31;&#x662F;apply partition-fixed&#x51FD;&#x6570;&#xFF0C;&#x7B2C;&#x4E8C;&#x53C2;&#x6570;&#x662F;join-maps&#x8FD4;&#x56DE;&#x7ED3;&#x679C;{&quot;boltA&quot; (2 [1 2 3 4]), &quot;boltB&quot; (2 [5 6])}&#xFF0C;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4E3A;</p>
<p> ;; {&quot;boltA&quot; [(1 2) (3 4)] &quot;boltB&quot; [(5) (6)]}</p>
<p>( map-val ( partial apply  partition-fixed )) </p>
<p> ;;((1 2) (3 4) (5) (6))</p>
<p>( mapcat  second ) </p>
<p> ;;([1 2] [3 4] [5 5] [6 6])</p>
<p>( map  to-executor-id ) </p>
<p>)))</p>
<p>storm-task-info&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  storm-task-info</p>
<p>&quot;Returns map from task -&gt; component id&quot;</p>
<p> [  ^  StormTopology  user-topology  storm-conf  ]</p>
<p>( -&gt;&gt; ( system-topology!  storm-conf  user-topology ) </p>
<p> ;; &#x83B7;&#x53D6;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;-&gt;&#x7EC4;&#x4EF6;&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map</p>
<p> all-components</p>
<p> ;; &#x8FD4;&#x56DE;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;-&gt;&#x7EC4;&#x4EF6;&#x4EFB;&#x52A1;task&#x6570;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5982;{&quot;boltA&quot; 4, &quot;boltB&quot; 2}</p>
<p>( map-val ( comp  # ( get  %  TOPOLOGY-TASKS ) component-conf )) </p>
<p> ;; &#x6309;&#x7167;&#x7EC4;&#x4EF6;&#x540D;&#x79F0;&#x5BF9;map&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x5E8F;&#x5217;&#xFF0C;&#x5982;([&quot;boltA&quot; 4] [&quot;boltB&quot; 2])</p>
<p>( sort-by  first ) </p>
<p> ;; mapcat&#x51FD;&#x6570;&#x7B49;&#x4EF7;&#x4E8E;&#x5BF9;(map (fn…))&#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x6267;&#x884C;concat&#x51FD;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;(&quot;boltA&quot; &quot;boltA&quot; &quot;boltA&quot; &quot;boltA&quot; &quot;boltB&quot; &quot;boltB&quot;)</p>
<p>( mapcat ( fn  [[  c  num-tasks  ]] ( repeat  num-tasks  c ))) </p>
<p> ;; {1 &quot;boltA&quot;, 2 &quot;boltA&quot;,3 &quot;boltA&quot;, 4 &quot;boltA&quot;, 5 &quot;boltB&quot;, 6 &quot;boltB&quot;}</p>
<p>( map ( fn  [  id  comp  ]  [  id  comp  ]) ( iterate ( comp int  inc ) ( int  1 ))) </p>
<p>( into  {})</p>
<p>))</p>
<p>compute-new-topology-&gt;executor-&gt;node+port&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;:</p>
<p>( defn  compute-new-topology-&gt;executor-&gt;node+port  [  nimbus  existing-assignments  topologies  scratch-topology-id  ]</p>
<p>( let  [  conf ( :conf  nimbus ) </p>
<p> storm-cluster-state ( :storm-cluster-state  nimbus ) </p>
<p> ;; topology-&gt;executors&#x7ED1;&#x5B9A;&#x6240;&#x6709;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x4EFB;&#x52A1;&#x7684;topology id-&gt;executor id&#x96C6;&#x5408;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5982;{&quot;topology-id-1&quot; #{[1 2] [3 4] [5 5] [6 6]} &quot;topology-id-2&quot; #{[1 2] [3 4] [5 6] [7 8]}}</p>
<p> ;; compute-topology-&gt;executors&#x51FD;&#x6570;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x53EA;&#x662F;&#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x4E86;compute-executors&#x51FD;&#x6570;&#xFF0C;&#x5173;&#x4E8E;compute-executors&#x51FD;&#x6570;&#x8BF7;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> topology-&gt;executors ( compute-topology-&gt;executors  nimbus ( keys  existing-assignments )) </p>
<p> ;; update the executors heartbeats first.</p>
<p> ;; &#x5C06;&#x7EBF;&#x7A0B;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x66F4;&#x65B0;&#x5230;nimbus&#x7684;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x7F13;&#x5B58;&#x4E2D;&#x3002;</p>
<p> _ ( update-all-heartbeats!  nimbus  existing-assignments  topology-&gt;executors ) </p>
<p> ;; topology-&gt;alive-executors&#x7ED1;&#x5B9A;topology id-&gt;alive-executor-id&#x96C6;&#x5408;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;compute-topology-&gt;alive-executors&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> topology-&gt;alive-executors ( compute-topology-&gt;alive-executors  nimbus</p>
<p> existing-assignments</p>
<p> topologies</p>
<p> topology-&gt;executors</p>
<p> scratch-topology-id ) </p>
<p> ;; supervisor-&gt;dead-ports&#x7ED1;&#x5B9A;supervisor-id-&gt;dead-port&#x952E;&#x503C;&#x5BF9;&#x7684;map&#x3002;compute-supervisor-&gt;dead-ports&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> supervisor-&gt;dead-ports ( compute-supervisor-&gt;dead-ports  nimbus</p>
<p> existing-assignments</p>
<p> topology-&gt;executors</p>
<p> topology-&gt;alive-executors ) </p>
<p> ;; topology-&gt;scheduler-assignment&#x7ED1;&#x5B9A;topology id-&gt;SchedulerAssignmentImpl&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map&#x3002;SchedulerAssignmentImpl&#x7C7B;&#x5B9A;&#x4E49;&#x53C2;&#x89C1;SchedulerAssignmentImpl.java&#x3002;compute-topology- &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &gt;scheduler-assignment&#x51FD;&#x6570;</p>
<p> ;; &#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p> topology-&gt;scheduler-assignment ( compute-topology-&gt;scheduler-assignment  nimbus</p>
<p> existing-assignments</p>
<p> topology-&gt;alive-executors ) </p>
<p> ;; missing-assignment-topologies&#x7ED1;&#x5B9A;&#x4E22;&#x5931;assignment&#x7684;topology id&#x96C6;&#x5408;</p>
<p> ;; topologies&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;Topologies&#x5BF9;&#x8C61;&#xFF0C;Topologies&#x7C7B;&#x53C2;&#x89C1;Topologies.java &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p> missing-assignment-topologies ( -&gt;&gt;  topologies</p>
<p> ;; getTopologies&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;Topologies&#x5BF9;&#x8C61;&#x4E2D;&#x7684;TopologyDetails&#x5BF9;&#x8C61;&#x7684;&#x96C6;&#x5408;</p>
<p> .getTopologies</p>
<p> ;; memfn&#x51FD;&#x6570;&#x5C06;java&#x4E2D;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x65B9;&#x5F0F;&#x8F6C;&#x6362;&#x6210;clojure&#x4E2D;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x65B9;&#x5F0F;&#xFF0C;(map (memfn getId))&#x8FD4;&#x56DE;topology id&#x96C6;&#x5408;</p>
<p>( map ( memfn  getId )) </p>
<p>( filter ( fn  [  t  ]</p>
<p> ;; alle&#x7ED1;&#x5B9A;storm&#x96C6;&#x7FA4;&#x4E0A;&#x6240;&#x6709;executor&#x7684;&#x96C6;&#x5408;</p>
<p>( let  [  alle ( get  topology-&gt;executors  t ) </p>
<p> ;; alivee&#x7ED1;&#x5B9A;storm&#x96C6;&#x7FA4;&#x4E0A;&#x6240;&#x6709;&quot;alive&quot;&#x7684;executor&#x96C6;&#x5408;</p>
<p> alivee ( get  topology-&gt;alive-executors  t  )]</p>
<p> ;; or&#x51FD;&#x6570;&#x7531;&#x4E09;&#x4E2A;&#x6761;&#x4EF6;&#x7EC4;&#x6210;&#xFF0C;&#x7528;&#x4E8E;&#x5224;&#x65AD;topology&#x662F;&#x5426;&#x4E22;&#x5931;assignment&#xFF0C;&#x5982;&#x679C;alle&#x4E3A;&#x7A7A;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;topology&#x4E22;&#x5931;&#x4E86;&#x6240;&#x6709;&#x7684;assignment&#x5373;executor &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x90FD;&quot;dead&quot;</p>
<p> ;; &#x5982;&#x679C;alle&#x4E0D;&#x7B49;&#x4E8E;alivee&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;topology&#x4E22;&#x5931;&#x4E86;&#x90E8;&#x5206;assignment&#x5373;&#x90E8;&#x5206;executor&#x662F;&quot;dead&quot;</p>
<p> ;; &#x5982;&#x679C;&#x8BE5;topology&#x5F53;&#x524D;&#x5B9E;&#x9645;workslot&#x4E2A;&#x6570;&#x5C0F;&#x4E8E;&#x5B9A;&#x4E49;&#x65F6;&#x6307;&#x5B9A;&#x7684;worker&#x4E2A;&#x6570;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;topology&#x4E22;&#x5931;&#x90E8;&#x5206;workslot&#x5373;&#x90E8;&#x5206;worker&#x8FDB;&#x7A0B;</p>
<p>( or ( empty?  alle ) </p>
<p>( not=  alle  alivee ) </p>
<p>( &lt; ( -&gt;  topology-&gt;scheduler-assignment</p>
<p>( get  t ) </p>
<p> num-used-workers ) </p>
<p>( -&gt;  topologies ( .getById  t ) .getNumWorkers ) </p>
<p>))</p>
<p>))))</p>
<p> ;; all-scheduling-slots&#x7ED1;&#x5B9A;&#x6240;&#x6709;supervisor id-&gt;&#x53EF;&#x7528;port&#x96C6;&#x5408;&#x7684;map&#xFF0C;&#x5982;{node1 #{port1 port2} node2 #{port1} …}</p>
<p> ;; all-scheduling-slots&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x6240;&#x6709;&#x53EF;&#x7528;&#x7684;node+port&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;([node1 port1] [node1 port2] [node2 port1] …)&#xFF0C;(map (fn [[node-id port]] {node-id #{port}}))&#x8FD4;&#x56DE;({node1 port1} &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; {node1 port2} {node2 port1} …)&#xFF0C;</p>
<p> ;; (apply merge-with set/union)&#x8FD4;&#x56DE;{node1 #{port1 port2} node2 #{port1} …} &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p> all-scheduling-slots ( -&gt;&gt; ( all-scheduling-slots  nimbus  topologies  missing-assignment-topologies ) </p>
<p>( map ( fn  [[  node-id  port  ]]  {  node-id  #  {  port  }}))</p>
<p>( apply merge-with  set/union )) </p>
<p> ;; supervisors&#x7ED1;&#x5B9A;storm&#x96C6;&#x7FA4;&#x4E0A;&#x6240;&#x6709;supervisor id-&gt;SupervisorDetails&#x5BF9;&#x8C61;&#x7684;map&#xFF0C;read-all-supervisor-details&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> supervisors ( read-all-supervisor-details  nimbus  all-scheduling-slots  supervisor-&gt;dead-ports ) </p>
<p> ;; cluster&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;Cluster&#x5BF9;&#x8C61;&#xFF0C;Cluster&#x7C7B;&#x53C2;&#x89C1;Cluster.java</p>
<p> cluster ( Cluster. ( :inimbus  nimbus ) supervisors  topology-&gt;scheduler-assignment ) </p>
<p> ;; call scheduler.schedule to schedule all the topologies</p>
<p> ;; the new assignments for all the topologies are in the cluster object.</p>
<p> ;; &#x8C03;&#x7528;IScheduler&#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#x7C7B;&#x7684;schedule&#x65B9;&#x6CD5;&#xFF0C;topologies&#x7ED1;&#x5B9A;&#x4E86;&#x4ECE;zookeeper&#x4E0A;&#x83B7;&#x53D6;&#x7684;storm&#x96C6;&#x7FA4;&#x4E2D;&#x7684;&#x5168;&#x90E8;topology&#x4FE1;&#x606F;&#xFF08;&#x5305;&#x62EC;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x4FE1;&#x606F;&#xFF09;&#xFF0C;cluster&#x7ED1;&#x5B9A;&#x4E86;&#x5F53;&#x524D;storm&#x96C6;&#x7FA4;&#x4E2D;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x6240;&#x6709;</p>
<p> ;; topology&#x7684;assignment&#x4FE1;&#x606F;&#xFF08;&#x4E0D;&#x5305;&#x62EC;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#xFF09;</p>
<p> ;; nimbus&#x4E2D;&#x7684;scheduler&#x662F;&#x7531;mk-scheduler&#x51FD;&#x6570;&#x751F;&#x6210;&#x7684;&#xFF0C;&#x901A;&#x8FC7;&#x5206;&#x6790;mk-scheduler&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5728;&#x6CA1;&#x6709;&#x914D;&#x7F6E;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x7684;scheduler&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;mk-scheduler&#x51FD;&#x6570;&#x9ED8;&#x8BA4;&#x8FD4;&#x56DE;DefaultScheduler</p>
<p> ;; &#x6240;&#x4EE5;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x662F;&#x8C03;&#x7528;DefaultScheduler&#x7C7B;&#x7684;schedule&#x65B9;&#x6CD5;&#xFF0C;schedule&#x65B9;&#x6CD5;&#x53C2;&#x89C1;DefaultScheduler.clj&#xFF0C;mk-scheduler&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> _ ( .schedule ( :scheduler  nimbus ) topologies  cluster ) </p>
<p> ;; new-scheduler-assignments&#x7ED1;&#x5B9A;&#x5206;&#x914D;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x96C6;&#x7FA4;&#x4E2D;&#x5F53;&#x524D;&#x6700;&#x65B0;&#x7684;topology id-&gt;AssignmentImpl&#x7684;map</p>
<p> new-scheduler-assignments ( .getAssignments  cluster ) </p>
<p> ;; add more information to convert SchedulerAssignment to Assignment</p>
<p> ;; new-topology-&gt;executor-&gt;node+port&#x7ED1;&#x5B9A;{topology-id -&gt; {executor [node port]}}&#xFF0C;compute-topology-&gt;executor-&gt;node+port&#x51FD;&#x6570;&#x5C06;topology id-&gt;AssignmentImpl&#x7684;map&#x8F6C;&#x6362;&#x6210;{topology-id &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; -&gt; {executor [node port]}}</p>
<p> new-topology-&gt;executor-&gt;node+port ( compute-topology-&gt;executor-&gt;node+port  new-scheduler-assignments  )]</p>
<p> ;; print some useful information.</p>
<p>( doseq  [[  topology-id  executor-&gt;node+port  ]  new-topology-&gt;executor-&gt;node+port</p>
<p> ;; old-executor-&gt;node+port&#x7ED1;&#x5B9A;&#x4ECE;zookeeper&#x4E0A;&#x83B7;&#x53D6;&#x7684;&#x5206;&#x914D;&#x4FE1;&#x606F;&#x76F8;&#x5BF9;&#x4E8E;&#x4ECE;cluster&#x5BF9;&#x8C61;&#x4E2D;&#x83B7;&#x53D6;&#x7684;new-topology-&gt;executor-&gt;node+port&#x5206;&#x914D;&#x4FE1;&#x606F;&#x4E3A;&quot;&#x65E7;&#x5206;&#x914D;&#x4FE1;&#x606F;&quot;</p>
<p> :let  [  old-executor-&gt;node+port ( -&gt;  topology-id</p>
<p> existing-assignments</p>
<p> :executor-&gt;node+port ) </p>
<p> ;; reassignment&#x7ED1;&#x5B9A;&#x88AB;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;executor&#x6240;&#x5BF9;&#x5E94;&#x7684;executor-&gt;node+port&#x7684;map</p>
<p> reassignment ( filter ( fn  [[  executor  node+port  ]]</p>
<p>( and ( contains?  old-executor-&gt;node+port  executor ) </p>
<p>( not ( =  node+port ( old-executor-&gt;node+port  executor ))))) </p>
<p> executor-&gt;node+port  )]]</p>
<p> ;; &#x5982;&#x679C;reassignment&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x5728;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x4E2D;&#x6253;&#x5370;&#x65B0;&#x589E;slot&#x7684;&#x4E2A;&#x6570;&#x548C;&#x88AB;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;executor</p>
<p>( when-not ( empty?  reassignment ) </p>
<p>( let  [  new-slots-cnt ( count ( set ( vals  executor-&gt;node+port ))) </p>
<p> reassign-executors ( keys  reassignment  )]</p>
<p>( log-message  &quot;Reassigning &quot;  topology-id  &quot; to &quot;  new-slots-cnt  &quot; slots&quot; ) </p>
<p>( log-message  &quot;Reassign executors: &quot; ( vec  reassign-executors ))))) </p>
<p> ;; &#x8FD4;&#x56DE;&#x6700;&#x65B0;&#x5206;&#x914D;&#x4FE1;&#x606F;new-topology-&gt;executor-&gt;node+port</p>
<p>new-topology-&gt;executor-&gt;node+port</p>
<p>))</p>
<p>update-all-heartbeats!&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  update-all-heartbeats!  [  nimbus  existing-assignments  topology-&gt;executors  ]</p>
<p>&quot;update all the heartbeats for all the topologies&apos;s executors&quot;</p>
<p>;; assignment&#x7ED1;&#x5B9A;AssignmentInfo&#xFF0C;tid&#x7ED1;&#x5B9A;topology id</p>
<p>( doseq  [[  tid  assignment  ]  existing-assignments</p>
<p> ;; all-executors&#x7ED1;&#x5B9A;executor id&#x96C6;&#x5408;</p>
<p> :let  [  all-executors ( topology-&gt;executors  tid  )]]</p>
<p>( update-heartbeats!  nimbus  tid  all-executors assignment</p>
<p>)))</p>
<p>update-heartbeats!&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  update-heartbeats!  [  nimbus  storm-id  all-executors  existing-assignment  ]</p>
<p>( log-debug  &quot;Updating heartbeats for &quot;  storm-id  &quot; &quot; ( pr-str  all-executors )) </p>
<p>( let  [  storm-cluster-state ( :storm-cluster-state  nimbus ) </p>
<p> ;; executor-beats&#x7ED1;&#x5B9A;&#x6307;&#x5B9A;&#x7684;executor&#x7684;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#xFF0C;executor-beats&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> executor-beats ( .executor-beats  storm-cluster-state  storm-id ( :executor-&gt;node+port  existing-assignment )) </p>
<p> ;; (@(:heartbeats-cache nimbus) storm-id)&#x6839;&#x636E;topology id(&#x5373;storm-id)&#x83B7;&#x53D6;nimbus&#x5FC3;&#x8DF3;&#x7F13;&#x5B58;map&#x4E2D;&#x4E0E;&#x4E4B;&#x5BF9;&#x5E94;&#x7684;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x4E00;&#x4E2A;map&#x5BF9;&#x8C61;&#xFF0C;update-heartbeat-cache&#x51FD;&#x6570;</p>
<p> ;; cache&#x7ED1;&#x5B9A;&#x66F4;&#x65B0;&#x540E;&#x7684;executor-id-&gt;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x7F13;&#x5B58;map&#x7684;&#x952E;&#x503C;&#x5BF9;map&#xFF0C;update-heartbeat-cache&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p> cache ( update-heartbeat-cache ( @ ( :heartbeats-cache  nimbus ) storm-id ) </p>
<p> executor-beats</p>
<p> all-executors</p>
<p>(( :conf  nimbus ) NIMBUS-TASK-TIMEOUT-SECS  ))]</p>
<p> ;; &#x5C06;storm-id&#x6807;&#x793A;&#x7684;topology&#x7684;&#x6700;&#x65B0;&#x7EBF;&#x7A0B;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x66F4;&#x65B0;&#x5230;nimbus&#x5FC3;&#x8DF3;&#x7F13;&#x5B58;map&#x4E2D;&#x3002;</p>
<p>( swap! ( :heartbeats-cache  nimbus ) assoc  storm-id cache</p>
<p>)))</p>
<p>executor-beats&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( executor-beats</p>
<p> [  this  storm-id  executor-&gt;node+port  ]</p>
<p> ;; need to take executor-&gt;node+port in explicitly so that we don&apos;t run into a situation where a</p>
<p> ;; long dead worker with a skewed clock overrides all the timestamps. By only checking heartbeats</p>
<p> ;; with an assigned node+port, and only reading executors from that heartbeat that are actually assigned,</p>
<p> ;; we avoid situations like that</p>
<p> ;; node+port-&gt;executors&#x7ED1;&#x5B9A;&#x7ED3;&#x70B9;+&#x7AEF;&#x53E3;-&gt;executor-id&#x952E;&#x503C;&#x5BF9;&#x7684;map&#xFF0C;&#x5982;{[node1 port1] [[1 2] [3 4]] [node2 port2] [[5 6] [7 8]]}</p>
<p>( let  [  node+port-&gt;executors ( reverse-map  executor-&gt;node+port ) </p>
<p> ;; all-heartbeats&#x7ED1;&#x5B9A;&#x6240;&#x6709;executor-id-&gt;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x7684;map&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;({[1 2] {:time-secs &#x5FC3;&#x8DF3; :uptime &#x5F00;&#x59CB;&#x65F6;&#x95F4; :stats BoltExecutorStats&#x6216;SpoutExecutorStats&#x5BF9;&#x8C61;}} [3 4]…)</p>
<p> all-heartbeats ( for  [[[  node  port  ]  executors  ]  node+port-&gt;executors  ]</p>
<p> ;; get-worker-heartbeat&#x51FD;&#x6570;&#x4ECE;zookeeper&#x7684;/workerbeats/{storm-id}/{node-port}&#x83B7;&#x53D6;worker&#x8FDB;&#x7A0B;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;</p>
<p>( -&gt;&gt; ( get-worker-heartbeat  this  storm-id  node  port ) </p>
<p> ;; convert-executor-beats&#x51FD;&#x6570;&#x4ECE;worker&#x8FDB;&#x7A0B;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#x4E2D;&#x83B7;&#x53D6;&#x7EBF;&#x7A0B;&#x7684;&#x5FC3;&#x8DF3;&#x4FE1;&#x606F;&#xFF0C;convert-executor-beats&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;&#x3002;</p>
<p>( convert-executor-beats  executors ) </p>
<p> ))]</p>
<p> ;; &#x5C06;all-heartbeats&#x96C6;&#x5408;&#x4E2D;&#x7684;map&#x8FDB;&#x884C;&#x5408;&#x5E76;&#xFF0C;&#x7ED3;&#x679C;&#x5982;{[1 2] {:time-secs &#x5FC3;&#x8DF3; :uptime &#x5F00;&#x59CB;&#x65F6;&#x95F4; :stats BoltExecutorStats&#x6216;SpoutExecutorStats&#x5BF9;&#x8C61;} [3 4]…}</p>
<p>( apply merge all-heartbeats</p>
<p>)))</p>
<p>convert-executor-beats&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  convert-executor-beats</p>
<p>&quot;Ensures that we only return heartbeats for executors assigned to</p>
<p>this worker.&quot;</p>
<p> [  executors  worker-hb  ]</p>
<p>;; (:executor-stats worker-hb)&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;map&#xFF0C;&#x53EF;&#x4EE5;&#x4E3A;executor-id</p>
<p>( let  [  executor-stats ( :executor-stats  worker-hb  )]</p>
<p>( -&gt;&gt;  executors</p>
<p>( map ( fn  [  t  ]</p>
<p> ;; &#x5224;&#x65AD;executor&#x662F;&#x5426;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E2A;worker&#x8FDB;&#x7A0B;</p>
<p>( if ( contains?  executor-stats  t ) </p>
<p> {  t  {  :time-secs ( :time-secs  worker-hb ) </p>
<p> :uptime ( :uptime  worker-hb ) </p>
<p> :stats ( get  executor-stats  t  )}})))</p>
<p>( into {}))))</p>
<p>update-heartbeat-cache&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  update-heartbeat-cache  [  cache  executor-beats  all-executors  timeout  ]</p>
<p>( let  [  cache ( select-keys  cache  all-executors  )]</p>
<p>( into  {}</p>
<p>( for  [  executor  all-executors  :let  [  curr ( cache  executor  )]]</p>
<p> [  executor</p>
<p>( update-executor-cache  curr ( get  executor-beats  executor ) timeout  )]</p>
<p>))))</p>
<p>&#x8BE5;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x8C03;&#x7528;&#x4E86;update-executor-cache&#x51FD;&#x6570;&#xFF0C;update-executor-cache&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  update-executor-cache  [  curr  hb  timeout  ]</p>
<p>;; reported-time&#x7ED1;&#x5B9A;&#x7EBF;&#x7A0B;&#x7684;&#x5FC3;&#x8DF3;&#x65F6;&#x95F4;</p>
<p>( let  [  reported-time ( :time-secs  hb ) </p>
<p> ;; &#x7ED1;&#x5B9A;&#x6700;&#x65B0;&#x4E00;&#x6B21;nimbus&#x65F6;&#x95F4;</p>
<p> {  last-nimbus-time  :nimbus-time</p>
<p> ;; last-reported-time&#x7ED1;&#x5B9A;&#x6700;&#x65B0;&#x4E00;&#x6B21;&#x5FC3;&#x8DF3;&#x65F6;&#x95F4;</p>
<p> last-reported-time  :executor-reported-time  }  curr</p>
<p> reported-time ( cond  reported-time  reported-time</p>
<p> last-reported-time  last-reported-time</p>
<p> :else  0 ) </p>
<p> ;; &#x5F53;last-nimbus-time&#x4E3A;nil&#x6216;last-reported-time&#x548C;reported-time&#x4E0D;&#x76F8;&#x7B49;&#x65F6;&#xFF0C;nimbus-time&#x7ED1;&#x5B9A;&#x5F53;&#x524D;&#x65F6;&#x95F4;&#xFF0C;&#x5426;&#x5219;&#x7ED1;&#x5B9A;&#x6700;&#x65B0;&#x4E00;&#x6B21;nimbus&#x65F6;&#x95F4;</p>
<p> nimbus-time ( if ( or ( not  last-nimbus-time ) </p>
<p>( not=  last-reported-time  reported-time )) </p>
<p>( current-time-secs ) </p>
<p> last-nimbus-time</p>
<p> )]</p>
<p> ;; &#x5224;&#x65AD;&#x662F;&#x5426;&#x8D85;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x5F53;&#x524D;&#x65F6;&#x95F4;-nimbus-time&gt;=timeout(timeout&#x7684;&#x503C;&#x4E3A;storm.yaml&#x4E2D;&#x7684;&quot;nimbus.task.timeout.secs&quot;)&#xFF0C;:is-timed-out&#x503C;&#x4E3A;true&#xFF0C;&#x5426;&#x5219;&#x4E3A;false</p>
<p> {  :is-timed-out ( and</p>
<p> nimbus-time</p>
<p>( &gt;= ( time-delta  nimbus-time ) timeout )) </p>
<p> :nimbus-time  nimbus-time</p>
<p> :executor-reported-time  reported-time }))</p>
<p>compute-topology-&gt;alive-executors&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>;; &#x901A;&#x8FC7;&#x8C03;&#x7528;alive-executors&#x51FD;&#x6570;&#x83B7;&#x53D6;a topology-id -&gt; alive executors map&#x3002;</p>
<p>( defn-  compute-topology-&gt;alive-executors  [  nimbus  existing-assignments  topologies  topology-&gt;executors  scratch-topology-id  ]</p>
<p>&quot;compute a topology-id -&gt; alive executors map&quot;</p>
<p>( into  {} ( for  [[  tid  assignment  ]  existing-assignments</p>
<p> :let  [  topology-details ( .getById  topologies  tid ) </p>
<p> all-executors ( topology-&gt;executors  tid ) </p>
<p> alive-executors ( if ( and  scratch-topology-id ( =  scratch-topology-id  tid )) </p>
<p> all-executors</p>
<p>( set ( alive-executors  nimbus  topology-details  all-executors  assignment  )))]]</p>
<p> {  tid  alive-executors })))</p>
<p>alive-executors&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  alive-executors</p>
<p> [  nimbus  ^  TopologyDetails  topology-details  all-executors  existing-assignment  ]</p>
<p>( log-debug  &quot;Computing alive executors for &quot; ( .getId  topology-details ) &quot;\n&quot;</p>
<p> &quot;Executors: &quot; ( pr-str  all-executors ) &quot;\n&quot;</p>
<p> &quot;Assignment: &quot; ( pr-str  existing-assignment ) &quot;\n&quot;</p>
<p> &quot;Heartbeat cache: &quot; ( pr-str ( @ ( :heartbeats-cache  nimbus ) ( .getId  topology-details ))) </p>
<p>)</p>
<p>;; TODO: need to consider all executors associated with a dead executor (in same slot) dead as well,</p>
<p>;; don&apos;t just rely on heartbeat being the same</p>
<p>( let  [  conf ( :conf  nimbus ) </p>
<p> storm-id ( .getId  topology-details ) </p>
<p> ;; executor-start-times&#x7ED1;&#x5B9A;executors&#x7684;&#x542F;&#x52A8;&#x65F6;&#x95F4;</p>
<p> executor-start-times ( :executor-&gt;start-time-secs  existing-assignment ) </p>
<p> ;; heartbeats-cache&#x7ED1;&#x5B9A;nimbus&#x7684;&#x5FC3;&#x8DF3;&#x7F13;&#x5B58;</p>
<p> heartbeats-cache ( @ ( :heartbeats-cache  nimbus ) storm-id  )]</p>
<p>( -&gt;&gt;  all-executors</p>
<p> ;; &#x4E3A;&#x6BCF;&#x4E2A;executor&#x8C03;&#x7528;&#x4E00;&#x4E2A;&#x533F;&#x540D;&#x51FD;&#x6570;&#xFF0C;&#x5224;&#x65AD;executor&#x662F;&#x5426;&quot;alive&quot;</p>
<p>( filter ( fn  [  executor  ]</p>
<p> ;; start-time&#x7ED1;&#x5B9A;executor&#x7684;&#x542F;&#x52A8;&#x65F6;&#x95F4;</p>
<p>( let  [  start-time ( get  executor-start-times  executor ) </p>
<p> ;; is-timed-out&#x7ED1;&#x5B9A;executor&#x7684;&#x8D85;&#x65F6;&#x72B6;&#x6001;</p>
<p> is-timed-out ( -&gt;  heartbeats-cache ( get  executor ) :is-timed-out  )]</p>
<p> ;; &#x5982;&#x679C;start-time&#x4E0D;&#x4E3A;nil&#x5E76;&#x4E14;&#x5F53;&#x524D;&#x65F6;&#x95F4;-start-time&lt;NIMBUS-TASK-LAUNCH-SECS&#x6216;is-timed-out=false&#xFF0C;&#x90A3;&#x4E48;&#x8BE5;executor&#x662F;&quot;alive&quot;&#x7684;</p>
<p> ;; filter&#x51FD;&#x6570;&#x53EA;&#x4F1A;&#x8FD4;&#x56DE;&#x533F;&#x540D;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4E3A;true&#x7684;executor&#xFF0C;NIMBUS-TASK-LAUNCH-SECS&#x914D;&#x7F6E;&#x9879;&#x7684;&#x4F5C;&#x7528;&#x662F;&#xFF1A;task&#x542F;&#x52A8;&#x65F6;&#x7684;&#x4E00;&#x4E2A;&#x7279;&#x6B8A;&#x8D85;&#x65F6;&#x8BBE;&#x7F6E;&#xFF0C;</p>
<p> ;; &#x5728;&#x542F;&#x52A8;&#x540E;&#x7B2C;&#x4E00;&#x6B21;&#x5FC3;&#x8DF3;&#x524D;&#x4F1A;&#x4F7F;&#x7528;&#x8BE5;&#x503C;&#x6765;&#x4E34;&#x65F6;&#x66FF;&#x4EE3;nimbus.task.timeout.secs&#x3002;&#x6240;&#x4EE5;&#x5F53;&#x524D;&#x65F6;&#x95F4;-start-time&lt;NIMBUS-TASK-LAUNCH-SECS&#x548C;is-timed-out=false&#x4E4B;&#x95F4;</p>
<p> ;; &#x662F;&#x6216;&#x5173;&#x7CFB;&#x3002;</p>
<p>( if ( and  start-time</p>
<p>( or</p>
<p>( &lt; ( time-delta  start-time ) </p>
<p>( conf  NIMBUS-TASK-LAUNCH-SECS )) </p>
<p>( not  is-timed-out ) </p>
<p>))</p>
<p> true</p>
<p>( do</p>
<p>( log-message  &quot;Executor &quot;  storm-id  &quot;:&quot;  executor  &quot; not alive&quot; ) </p>
<p> false )) </p>
<p>)))</p>
<p>doall</p>
<p>)))</p>
<p>compute-supervisor-&gt;dead-ports&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;:</p>
<p>( defn-  compute-supervisor-&gt;dead-ports  [  nimbus  existing-assignments  topology-&gt;executors  topology-&gt;alive-executors  ]</p>
<p>;; dead-slots&#x96C6;&#x5408;&#x5982;[([node1 port1]) ([node2 port2]) ([node1 port1]) ([node1 port2])]</p>
<p>( let  [  dead-slots ( into  [] ( for  [[  tid  assignment  ]  existing-assignments</p>
<p> ;; all-executors&#x7ED1;&#x5B9A;&#x6240;&#x6709;executor</p>
<p> :let  [  all-executors ( topology-&gt;executors  tid ) </p>
<p> ;; alive-executors&#x7ED1;&#x5B9A;&#x6240;&#x6709;&quot;alive&quot;&#x7684;executor</p>
<p> alive-executors ( topology-&gt;alive-executors  tid ) </p>
<p> ;; dead-executors&#x7ED1;&#x5B9A;all-executors&#x548C;alive-executors&#x7684;&#x5DEE;&#x96C6;&#xFF0C;&#x5373;&quot;dead&quot;&#x7684;executor</p>
<p> dead-executors ( set/difference  all-executors  alive-executors ) </p>
<p> ;; dead-slots&#x7ED1;&#x5B9A;dead-executors&#x96C6;&#x5408;&#x4E2D;executor&#x5BF9;&#x5E94;&#x7684;[node port]&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;(([node1 port1]) ([node2 port2]) ([node1 port1]) ([node1 port2]))</p>
<p> ;; &#x6CE8;&#x610F;dead-slots&#x96C6;&#x5408;&#x53EF;&#x80FD;&#x5305;&#x542B;&#x91CD;&#x590D;&#x5143;&#x7D20;&#x3002;</p>
<p> dead-slots ( -&gt;&gt; ( :executor-&gt;node+port  assignment ) </p>
<p>( filter  # ( contains?  dead-executors ( first  % ))) </p>
<p> vals  )]]</p>
<p> dead-slots )) </p>
<p> ;; supervisor-&gt;dead-ports&#x7ED1;&#x5B9A;supervisor-id-&gt;dead-port&#x96C6;&#x5408;&#x952E;&#x503C;&#x5BF9;&#x7684;map</p>
<p> supervisor-&gt;dead-ports ( -&gt;&gt;  dead-slots</p>
<p> ;; apply&#x51FD;&#x6570;&#x7684;&#x7ED3;&#x679C;&#x5982;([node1 port1] [node2 port2] [node1 port1] [node1 port2])</p>
<p>( apply  concat ) </p>
<p> ;; map&#x51FD;&#x6570;&#x7684;&#x7ED3;&#x679C;&#x5982;({node1 #{port1}} {node2 #{port2}} {node1 #{port1}} {node1 #{port2}})</p>
<p>( map ( fn  [[  sid  port  ]]  {  sid  #  {  port  }}))</p>
<p> ;; apply&#x51FD;&#x6570;&#x7684;&#x7ED3;&#x679C;&#x5982;({node1 #{port1 port2}} {node2 #{port2}}})&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x53BB;&#x91CD;&#x5408;&#x5E76;&#x3002;</p>
<p>( apply ( partial merge-with  set/union  )))]</p>
<p>( or  supervisor-&gt;dead-ports {})))</p>
<p>compute-topology-&gt;scheduler-assignment&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  compute-topology-&gt;scheduler-assignment  [  nimbus  existing-assignments  topology-&gt;alive-executors  ]</p>
<p>&quot;convert assignment information in zk to SchedulerAssignment, so it can be used by scheduler api.&quot;</p>
<p>;; tid&#x7ED1;&#x5B9A;topology id&#xFF0C;assignment&#x7ED1;&#x5B9A;&#x5BF9;&#x5E94;&#x7684;AssignmentInfo&#x5BF9;&#x8C61;</p>
<p>( into  {} ( for  [[  tid  assignment  ]  existing-assignments</p>
<p> ;; alive-executors&#x7ED1;&#x5B9A;&quot;alive&quot;&#x7684;executor&#x7684;&#x96C6;&#x5408;</p>
<p> :let  [  alive-executors ( topology-&gt;alive-executors  tid ) </p>
<p> ;; executor-&gt;node+port&#x7ED1;&#x5B9A;AssignmentInfo&#x5BF9;&#x8C61;&#x4E2D;&#x7684;executor-&gt;node+port&#x7684;map</p>
<p> executor-&gt;node+port ( :executor-&gt;node+port  assignment ) </p>
<p> ;; &#x5FAA;&#x73AF;&#x904D;&#x5386;executor-&gt;node+port&#xFF0C;&#x5982;&#x679C;executor&#x5305;&#x542B;&#x5728;alive-executors&#x96C6;&#x5408;&#x4E2D;&#xFF0C;&#x90A3;&#x4E48;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;ExecutorDetails-&gt;WorkerSlot&#x7684;map&#xFF0C;&#x6700;&#x540E;&#x5C06;for&#x5FAA;&#x73AF;&#x521B;&#x5EFA;&#x7684;map&#x5408;&#x5E76;&#x8D4B;&#x503C;&#x7ED9;executor-&gt;slot</p>
<p> executor-&gt;slot ( into  {} ( for  [[  executor  [  node  port  ]]  executor-&gt;node+port  ]</p>
<p> ;; filter out the dead executors</p>
<p>( if ( contains?  alive-executors  executor ) </p>
<p> {(  ExecutorDetails. ( first  executor ) </p>
<p>( second  executor )) </p>
<p>( WorkerSlot.  node  port  )}</p>
<p> {})))]]</p>
<p> ;; &#x8FD4;&#x56DE;topology id-&gt;SchedulerAssignmentImpl&#x5BF9;&#x8C61;&#x7684;map&#xFF0C;SchedulerAssignmentImpl&#x7C7B;&#x53C2;&#x89C1;SchedulerAssignmentImpl.java &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p> {  tid ( SchedulerAssignmentImpl.  tid  executor-&gt;slot )})))</p>
<p>SchedulerAssignmentImpl.java&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> public  class  SchedulerAssignmentImpl  implements  SchedulerAssignment  {</p>
<p> /**</p>
<ul>
<li>topology-id this assignment is for.</li>
</ul>
<p>*/</p>
<p> String  topologyId ; </p>
<p> /**</p>
<ul>
<li>assignment detail, a mapping from executor to &lt;code&gt;WorkerSlot&lt;/code&gt;</li>
</ul>
<p>*/</p>
<p> Map  &lt;  ExecutorDetails  ,  WorkerSlot  &gt;  executorToSlot ; </p>
<p> public  SchedulerAssignmentImpl ( String  topologyId  ,  Map  &lt;  ExecutorDetails  ,  WorkerSlot  &gt;  executorToSlots ) {</p>
<p> this  .  topologyId  =  topologyId ; </p>
<p> this  .  executorToSlot  =  new  HashMap  &lt;  ExecutorDetails  ,  WorkerSlot  &gt;(  0 ); </p>
<p> if ( executorToSlots  !=  null ) {</p>
<p> this  .  executorToSlot  .  putAll ( executorToSlots ); </p>
<p> }</p>
<p> }</p>
<p> @Override</p>
<p> public  Set  &lt;  WorkerSlot  &gt;  getSlots () {</p>
<p> return  new  HashSet ( executorToSlot  .  values ()); </p>
<p> }</p>
<p> /**</p>
<ul>
<li><p>Assign the slot to executors.</p>
</li>
<li><p>@param slot</p>
</li>
<li><p>@param executors</p>
</li>
</ul>
<p>*/</p>
<p> public  void  assign ( WorkerSlot  slot  ,  Collection  &lt;  ExecutorDetails  &gt;  executors ) {</p>
<p> for ( ExecutorDetails  executor  :  executors ) {</p>
<p> this  .  executorToSlot  .  put ( executor  ,  slot ); </p>
<p> }</p>
<p> }</p>
<p> /**</p>
<ul>
<li><p>Release the slot occupied by this assignment.</p>
</li>
<li><p>@param slot</p>
</li>
</ul>
<p>*/</p>
<p> public  void  unassignBySlot ( WorkerSlot  slot ) {</p>
<p> List  &lt;  ExecutorDetails  &gt;  executors  =  new  ArrayList  &lt;  ExecutorDetails  &gt;();</p>
<p> for ( ExecutorDetails  executor  :  this  .  executorToSlot  .  keySet ()) {</p>
<p> WorkerSlot  ws  =  this  .  executorToSlot  .  get ( executor ); </p>
<p> if ( ws  .  equals ( slot )) {</p>
<p> executors  .  add ( executor ); </p>
<p> }</p>
<p> }</p>
<p> // remove</p>
<p> for ( ExecutorDetails  executor  :  executors ) {</p>
<p> this  .  executorToSlot  .  remove ( executor ); </p>
<p> }</p>
<p> }</p>
<p> /**</p>
<ul>
<li><p>Does this slot occupied by this assignment?</p>
</li>
<li><p>@param slot</p>
</li>
<li><p>@return</p>
</li>
</ul>
<p>*/</p>
<p> public  boolean  isSlotOccupied ( WorkerSlot  slot ) {</p>
<p> return  this  .  executorToSlot  .  containsValue ( slot ); </p>
<p> }</p>
<p> public  boolean  isExecutorAssigned ( ExecutorDetails  executor ) {</p>
<p> return  this  .  executorToSlot  .  containsKey ( executor ); </p>
<p> }</p>
<p> public  String  getTopologyId () {</p>
<p> return  this  .  topologyId ; </p>
<p> }</p>
<p> public  Map  &lt;  ExecutorDetails  ,  WorkerSlot  &gt;  getExecutorToSlot () {</p>
<p> return  this  .  executorToSlot ; </p>
<p> }</p>
<p> /**</p>
<ul>
<li><p>Return the executors covered by this assignments</p>
</li>
<li><p>@return</p>
</li>
</ul>
<p>*/</p>
<p> public  Set  &lt;  ExecutorDetails  &gt;  getExecutors () {</p>
<p> return  this  .  executorToSlot  .  keySet (); </p>
<p> }</p>
<p>}</p>
<p>all-scheduling-slots&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  all-scheduling-slots</p>
<p> [  nimbus  topologies  missing-assignment-topologies  ]</p>
<p>( let  [  storm-cluster-state ( :storm-cluster-state  nimbus ) </p>
<p> ^  INimbus  inimbus ( :inimbus  nimbus ) </p>
<p> ;; supervisor-infos&#x7ED1;&#x5B9A;supervisor id-&gt;SupervisorInfo&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map</p>
<p> ;; SupervisorInfod&#x5B9A;&#x4E49;&#xFF1A;(defrecord SupervisorInfo [time-secs hostname assignment-id used-ports meta scheduler-meta uptime-secs])</p>
<p> supervisor-infos ( all-supervisor-info  storm-cluster-state  nil ) </p>
<p> ;; supervisor-details&#x7ED1;&#x5B9A;SupervisorDetails&#x5BF9;&#x8C61;&#x96C6;&#x5408;&#xFF0C;SupervisorDetails&#x7C7B;&#x53C2;&#x89C1;SupervisorDetails.java</p>
<p> supervisor-details ( dofor  [[  id  info  ]  supervisor-infos  ]</p>
<p> ;; info&#x7684;:meta&#x7684;&#x503C;&#x4E3A;&#x8FD9;&#x4E2A;&#x7ED3;&#x70B9;&#x7684;&#x6240;&#x6709;&#x7AEF;&#x53E3;&#x7684;&#x96C6;&#x5408;</p>
<p>( SupervisorDetails.  id ( :meta  info ))) </p>
<p> ;; ret&#x7ED1;&#x5B9A;storm&#x96C6;&#x7FA4;&#x4E0A;&#x6240;&#x6709;&#x53EF;&#x7528;&#x7684;workslot</p>
<p> ret ( .allSlotsAvailableForScheduling  inimbus</p>
<p> supervisor-details</p>
<p> topologies</p>
<p>( set  missing-assignment-topologies ) </p>
<p>)</p>
<p> ]</p>
<p> ;; &#x8FD4;&#x56DE;&#x6240;&#x6709;&#x53EF;&#x7528;&#x7684;node+port&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;([node1 port1] [node1 port2] [node2 port1] …)</p>
<p>( dofor  [  ^  WorkerSlot  slot  ret  ]</p>
<p> [(  .getNodeId  slot ) ( .getPort  slot  )]</p>
<p>)))</p>
<p>SupervisorDetails&#x7C7B;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> public  class  SupervisorDetails  {</p>
<p> String  id ; </p>
<p> /**</p>
<ul>
<li>hostname of this supervisor</li>
</ul>
<p>*/</p>
<p> String  host ; </p>
<p> Object  meta ; </p>
<p> /**</p>
<ul>
<li>meta data configured for this supervisor</li>
</ul>
<p>*/</p>
<p> Object  schedulerMeta ; </p>
<p> /**</p>
<ul>
<li>all the ports of the supervisor</li>
</ul>
<p>*/</p>
<p> Set  &lt;  Integer  &gt;  allPorts ; </p>
<p> // &#x6784;&#x9020;&#x65B9;&#x6CD5;</p>
<p> …  …</p>
<p> // get&#x548C;set&#x65B9;&#x6CD5;</p>
<p> …  …</p>
<p>}</p>
<p>read-all-supervisor-details&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  read-all-supervisor-details  [  nimbus  all-scheduling-slots  supervisor-&gt;dead-ports  ]</p>
<p>&quot;return a map: {topology-id SupervisorDetails}&quot;</p>
<p>( let  [  storm-cluster-state ( :storm-cluster-state  nimbus ) </p>
<p> ;; supervisor-infos&#x7ED1;&#x5B9A;&#x4ECE;zookeeper&#x4E0A;&#x83B7;&#x53D6;&#x7684;supervisor id-&gt;SupervisorInfo&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map</p>
<p> supervisor-infos ( all-supervisor-info  storm-cluster-state ) </p>
<p> ;; nonexistent-supervisor-slots&#x7ED1;&#x5B9A;all-scheduling-slots&#x4E2D;&#x6709;&#xFF0C;&#x4F46;supervisor-infos&#x4E2D;&#x6CA1;&#x6709;&#x7684;supervisor&#xFF0C;</p>
<p> ;; &#x6839;&#x636E;all-scheduling-slots&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;all-scheduling-slots&#x5C31;&#x662F;&#x7531;supervisor-infos&#x751F;&#x6210;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x76EE;&#x524D;nonexistent-supervisor-slots&#x5E94;&#x8BE5;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;map</p>
<p> nonexistent-supervisor-slots ( apply dissoc  all-scheduling-slots ( keys  supervisor-infos )) </p>
<p> ;; all-supervisor-details&#x7ED1;&#x5B9A;supervisor id-&gt;SupervisorDetails&#x5BF9;&#x8C61;&#x952E;&#x503C;&#x5BF9;&#x7684;map</p>
<p> all-supervisor-details ( into  {} ( for  [[  sid  supervisor-info  ]  supervisor-infos</p>
<p> :let  [  hostname ( :hostname  supervisor-info ) </p>
<p> scheduler-meta ( :scheduler-meta  supervisor-info ) </p>
<p> dead-ports ( supervisor-&gt;dead-ports  sid ) </p>
<p> ;; hide the dead-ports from the all-ports</p>
<p> ;; these dead-ports can be reused in next round of assignments</p>
<p> ;; all-ports&#x7ED1;&#x5B9A;&#x53BB;&#x9664;&quot;&#x6B7B;&#x4EA1;&quot;port&#x540E;&#x7684;&#x6240;&#x6709;port</p>
<p> all-ports ( -&gt; ( get  all-scheduling-slots  sid ) </p>
<p>( set/difference  dead-ports ) </p>
<p>(( fn  [  ports  ] ( map int  ports )))) </p>
<p> ;; supervisor-details&#x7ED1;&#x5B9A;SupervisorDetails&#x5BF9;&#x8C61;</p>
<p> supervisor-details ( SupervisorDetails.  sid  hostname  scheduler-meta  all-ports  )]]</p>
<p> {  sid  supervisor-details  }))]</p>
<p> ;; &#x8FD4;&#x56DE;&#x5408;&#x5E76;&#x540E;&#x7684;supervisor id-&gt;SupervisorDetails&#x5BF9;&#x8C61;&#x7684;map &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p>( merge  all-supervisor-details</p>
<p>( into  {}</p>
<p>( for  [[  sid  ports  ]  nonexistent-supervisor-slots  ]</p>
<p> [  sid ( SupervisorDetails.  sid  nil  ports  )]))</p>
<p>)))</p>
<p>Cluster&#x7C7B;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> public  class  Cluster  {</p>
<p> /**</p>
<ul>
<li>key: supervisor id, value: supervisor details</li>
</ul>
<p>*/</p>
<p> private  Map  &lt;  String  ,  SupervisorDetails  &gt;  supervisors ; </p>
<p> /**</p>
<ul>
<li>key: topologyId, value: topology&apos;s current assignments.</li>
</ul>
<p>*/</p>
<p> private  Map  &lt;  String  ,  SchedulerAssignmentImpl  &gt;  assignments ; </p>
<p> /**</p>
<ul>
<li>a map from hostname to supervisor id.</li>
</ul>
<p>*/</p>
<p> private  Map  &lt;  String  ,  List  &lt;  String  &gt;&gt;  hostToId ; </p>
<p> private  Set  &lt;  String  &gt;  blackListedHosts  =  new  HashSet  &lt;  String  &gt;();</p>
<p> private  INimbus  inimbus ; </p>
<p> // &#x5176;&#x4ED6;&#x65B9;&#x6CD5;</p>
<p> …  …</p>
<p>}</p>
<p>mk-scheduler&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  mk-scheduler  [  conf  inimbus  ]</p>
<p>;; &#x5F53;&#x524D;&#x7248;&#x672C;getForcedScheduler&#x51FD;&#x6570;&#x8FD4;&#x56DE;nil</p>
<p>( let  [  forced-scheduler ( .getForcedScheduler  inimbus ) </p>
<p> ;; scheduler&#x7ED1;&#x5B9A;IScheduler&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;</p>
<p> ;; cond&#x7B49;&#x4EF7;&#x4E8E;java&#x4E2D;&#x7684;switch&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x9996;&#x5148;&#x68C0;&#x67E5;forced-scheduler&#xFF0C;&#x5982;&#x679C;forced-scheduler&#x4E3A;nil&#xFF0C;&#x5219;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x7684;scheduler&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5219;</p>
<p> ;; &#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x7684;DefaultScheduler</p>
<p> scheduler ( cond</p>
<p> forced-scheduler</p>
<p>( do ( log-message  &quot;Using forced scheduler from INimbus &quot; ( class  forced-scheduler )) </p>
<p> forced-scheduler ) </p>
<p>( conf  STORM-SCHEDULER ) </p>
<p>( do ( log-message  &quot;Using custom scheduler: &quot; ( conf  STORM-SCHEDULER )) </p>
<p>( -&gt; ( conf  STORM-SCHEDULER ) new-instance )) </p>
<p> :else</p>
<p>( do ( log-message  &quot;Using default scheduler&quot; ) </p>
<p>( DefaultScheduler.  )))]</p>
<p> ;; &#x5148;&#x8C03;&#x7528;prepare&#x51FD;&#x6570;</p>
<p>( .prepare  scheduler  conf ) </p>
<p> ;; &#x7136;&#x540E;&#x8FD4;&#x56DE;scheduler</p>
<p> scheduler</p>
<p>))</p>
<p>DefaultScheduler.clj&#x4E2D;&#x7684;schedule&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x8C03;&#x7528;default-schedule&#x51FD;&#x6570;</p>
<p>( defn  -schedule  [  this  ^  Topologies  topologies  ^  Cluster  cluster  ]</p>
<p>( default-schedule  topologies cluster</p>
<p>))</p>
<p>DefaultScheduler.clj&#x4E2D;&#x7684;default-schedule&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  default-schedule  [  ^  Topologies  topologies  ^  Cluster  cluster  ]</p>
<p>;; needs-scheduling-topologies&#x7ED1;&#x5B9A;&#x9700;&#x8981;assign&#x7684;topology</p>
<p>;; Cluster&#x7C7B;&#x4E2D;&#x7684;needsSchedulingTopologies&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x9700;&#x8981;assign&#x7684;topology&#x7684;List&lt;TopologyDetails&gt;&#x4FE1;&#x606F;&#xFF0C;needsSchedulingTopologies&#x65B9;&#x6CD5;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p>( let  [  needs-scheduling-topologies ( .needsSchedulingTopologies  cluster  topologies  )]</p>
<p>( doseq  [  ^  TopologyDetails  topology  needs-scheduling-topologies</p>
<p> :let  [  topology-id ( .getId  topology ) </p>
<p> ;; available-slots&#x7ED1;&#x5B9A;storm&#x96C6;&#x7FA4;&#x4E2D;&#x6240;&#x6709;&#x672A;&#x88AB;&#x5206;&#x914D;&#x7684;node+port&#x96C6;&#x5408;&#xFF0C;&#x5982;([node1 port3] [node1 port6] [node1 port7] …)</p>
<p> ;; getAvailableSlots&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x5C06;&#x96C6;&#x7FA4;&#x4E2D;supervisor&#x5B9A;&#x4E49;&#x7684;&#x63A5;&#x53E3;&#x96C6;&#x5408;&#x51CF;&#x53BB;&#x5F53;&#x524D;&#x5DF2;&#x5206;&#x914D;&#x7684;&#x63A5;&#x53E3;&#x96C6;&#x5408;</p>
<p> available-slots ( -&gt;&gt; ( .getAvailableSlots  cluster ) </p>
<p>( map  # ( vector ( .getNodeId  % ) ( .getPort  % )))) </p>
<p> ;; all-executors&#x7ED1;&#x5B9A;&#x6307;&#x5B9A;&#x9700;&#x8981;&#x5206;&#x914D;&#x7684;topology&#x7684;executor id&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5982;([1 2] [3 4] [5 6] …)</p>
<p> all-executors ( -&gt;&gt;  topology</p>
<p> .getExecutors</p>
<p>( map  # ( vector ( .getStartTask  % ) ( .getEndTask  % ))) </p>
<p> set ) </p>
<p> ;; alive-assigned&#x7ED1;&#x5B9A;&quot;alive&quot;&#x5206;&#x914D;&#x4FE1;&#x606F;&#xFF0C;&#x5982;{[node1 port1] [[1 2] [3 4]] [node2 port1] [[5 6] [7 8]]}&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;topology-id&#x6807;&#x793A;</p>
<p> ;; &#x4E86;&#x4E24;&#x79CD;topology&#xFF0C;&#x4E00;&#x79CD;&#x662F;&#x5B9E;&#x9645;&#x5206;&#x914D;&#x7684;&#x8FDB;&#x7A0B;&#x5C0F;&#x4E8E;&#x671F;&#x671B;&#x8FDB;&#x7A0B;&#x5373;&#x8FDB;&#x884C;&#x4E86;&#x90E8;&#x5206;&#x5206;&#x914D;&#x7684;topology&#xFF0C;&#x4E00;&#x79CD;&#x662F;&#x5B8C;&#x5168;&#x6CA1;&#x6709;&#x5206;&#x914D;&#x7684;topology(&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x5C31;&#x662F;&#x5B8C;&#x5168;&#x6CA1;&#x6709;&#x5206;&#x914D;&#x7684;)&#xFF0C;&#x5BF9;&#x4E8E;&#x540E;&#x8005;alive-assigned&#x4E00;&#x5B9A; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x662F;&#x4E00;&#x4E2A;&#x7A7A;map</p>
<p> ;; get-alive-assigned-node+port-&gt;executors&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> alive-assigned ( EvenScheduler/get-alive-assigned-node+port-&gt;executors  cluster  topology-id ) </p>
<p> ;; alive-executors&#x5982;#{[1 2] [3 4] [5 6] [7 8]}&#xFF0C;&#x6CE8;&#x610F;&#x5BF9;&#x4E8E;&#x5B8C;&#x5168;&#x6CA1;&#x6709;&#x5206;&#x914D;&#x7684;topology&#xFF0C;alive-executors&#x4E3A;&#x7A7A;set</p>
<p> alive-executors ( -&gt;&gt;  alive-assigned  vals ( apply  concat ) set ) </p>
<p> ;; can-reassign-slots&#x7ED1;&#x5B9A;&#x4E86;&#x6240;&#x6709;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;slot&#xFF0C;alive executors&#x662F;&#x6709;&#x53EF;&#x80FD;&#x8DD1;&#x5728;dead slot&#x4E0A;&#x7684;, &#x6240;&#x4EE5;&#x4E0D;&#x662F;&#x6240;&#x6709;alive executors&#x7684;slot&#x90FD;&#x53EF;&#x7528;</p>
<p> ;; reassign&#x7684;&#x6761;&#x4EF6;, node&#x4E0D;&#x5728;cluster&#x7684;blacklist, port&#x662F;&#x5426;&#x5728;supervisor&#x7684;allPort&#x4E2D;(allPort&#x5DF2;&#x7ECF;&#x5728;read-all-supervisor-details&#x51FD;&#x6570;&#x4E2D;&#x53BB;&#x9664;&#x4E86;dead port), &#x5373;&#x8FD9;&#x4E2A;slot&#x662F;&#x53EF;&#x7528;&#x7684;</p>
<p> can-reassign-slots ( slots-can-reassign  cluster ( keys  alive-assigned )) </p>
<p> ;; total-slots-to-use&#x7ED1;&#x5B9A;&#x6307;&#x5B9A;topology&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;slot&#x603B;&#x6570;&#xFF0C;&#x53D6;&#x6307;&#x5B9A;topology&#x7684;&#x8FDB;&#x7A0B;&#x6570;&#x4E0E;&#xFF08;&#x53EF;&#x91CD;&#x65B0;&#x5206;&#x914D;slot&#x6570;+&#x53EF;&#x7528;slot&#x6570;&#xFF09;&#x7684;&#x6700;&#x5C0F;&#x503C;</p>
<p> total-slots-to-use ( min ( .getNumWorkers  topology ) </p>
<p>( + ( count  can-reassign-slots ) ( count  available-slots ))) </p>
<p> ;; bad-slots&#x7ED1;&#x5B9A;&quot;&#x5206;&#x914D;&#x4E0D;&#x7406;&#x60F3;&quot;&#x7684;WorkSlot&#x96C6;&#x5408;&#xFF0C;&quot;&#x5206;&#x914D;&#x4E0D;&#x7406;&#x60F3;&quot;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x7406;&#x89E3;&#xFF0C;&#x4E00;&#x4E2A;topology&#x5B9A;&#x4E49;&#x4E2D;&#x6709;3n&#x4E2A;executor&#xFF0C;n&#x4E2A;slot&#xFF08;&#x8FDB;&#x7A0B;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x96C6;&#x7FA4;&#x53EA;&#x7ED9;&#x5B83;&#x5206;&#x914D;&#x4E86;m&#xFF08;m&lt;n&#xFF09;&#x4E2A;slot,&#x6309;&#x7167;&#x5B9A;&#x4E49;&#x6BCF;&#x4E2A;slot &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E0A;&#x8FD0;&#x884C;3&#x4E2A;executor&#xFF0C;&#x4F46;&#x662F;</p>
<p> ;; &#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x5B83;&#x53EA;&#x6709;m&#x4E2A;slot&#xFF0C;&#x6BCF;&#x4E2A;slot&#x8FD0;&#x884C;3n/m&#x4E2A;executor&#xFF08;3n/m&#x662F;&#x5426;&#x6574;&#x9664;&#x6CA1;&#x6709;&#x5173;&#x7CFB;&#xFF09;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#x5206;&#x914D;&#x7ED9;topology&#x7684;&#x67D0;&#x4E9B;slot&#x6302;&#x6389;&#x4E86;&#xFF0C;&#x800C;&#x4E14;&#x96C6;&#x7FA4;&#x4E5F;&#x6CA1;&#x6709;&#x7A7A;&#x95F2;&#x7684;slot&#x5206;&#x914D;&#x7ED9;&#x5B83;&#xFF0C;&#x8FD9;&#x6837;&#x9020;&#x6210;&#x5B9E;&#x9645;&#x5206;&#x914D;&#x4E0E;&#x5B9A;&#x4E49; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#x4E0D;&#x7B26;&#x3002;</p>
<p> ;; alive-assigned&#x4E0E;alive-executors&#x662F;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x7684;&#xFF0C;&#x5982;&#x679C;or&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#x4E3A;true&#xFF0C;&#x5373;&#x8BE5;topology&#x5F53;&#x524D;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;slot&#x603B;&#x6570;&#x5927;&#x4E8E;&#x96C6;&#x7FA4;&#x5DF2;&#x5206;&#x914D;&#x7ED9;&#x5B83;&#x7684;slot&#x603B;&#x6570;&#xFF0C;&#x8BF4;&#x660E;&#x4E0A;&#x6B21;&#x5206;&#x914D;&#x7ED9;&#x5B83;&#x7684;slot&#x6570;&#x4E0D;&#x591F;</p>
<p> ;; &#x5373;&#x5B58;&#x5728;&quot;bad&quot;slot&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x6761;&#x4EF6;&#x4E3A;true&#xFF0C;alive-executors&#x96C6;&#x5408;&#x4E0D;&#x7B49;&#x4E8E;all-executors&#x96C6;&#x5408;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;topology&#x7684;&#x67D0;&#x4E9B;executor&#x56E0;&#x4E3A;&quot;&#x5FC3;&#x8DF3;&#x8D85;&#x65F6;&quot;&#x6216;&#x5176;&#x4ED6;&#x539F;&#x56E0;&#x6302;&#x6389;&#x4E86;&#xFF0C;&#x5373;&#x4E00;&#x5B9A;&#x5B58;&#x5728;&quot;bad&quot;slot</p>
<p> ;; &#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x6765;&#x8BF4;&#xFF0C;or&#x7684;&#x4E24;&#x4E2A;&#x6761;&#x4EF6;&#x90FD;&#x4E3A;true&#xFF0C;bad-slots&#x51FD;&#x6570;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> bad-slots ( if ( or ( &gt;  total-slots-to-use ( count  alive-assigned )) </p>
<p>( not=  alive-executors  all-executors )) </p>
<p> ;; bad-slots&#x8FD4;&#x56DE;&quot;&#x5206;&#x914D;&#x4E0D;&#x7406;&#x60F3;&quot;&#x7684;WorkSlot&#x96C6;&#x5408;&#xFF0C;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#xFF0C;bad-slots&#x8FD4;&#x56DE;&#x7A7A;&#x96C6;&#x5408;</p>
<p>( bad-slots  alive-assigned ( count  all-executors ) total-slots-to-use ) </p>
<p> [])]]</p>
<p> ;; freeSlots&#x51FD;&#x6570;&#x4ECE;cluster&#x7684;SchedulerAssignmentImpl&#x4E2D;&#x628A;&#x6240;&#x6709;bad-slots&#x96C6;&#x5408;&#x5305;&#x542B;&#x7684;slot&#x4ECE;executorToSlot&#x4E2D;&#x5220;&#x9664;&#xFF0C;&#x53EA;&#x8981;slot&#x6CA1;&#x6709;&#x88AB;executor&#x5360;&#x7528;&#x5C31;&#x662F;free&#xFF0C;freeSlots&#x65B9;&#x6CD5;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p>( .freeSlots  cluster  bad-slots ) </p>
<p>( EvenScheduler/schedule-topologies-evenly ( Topologies.  {  topology-id  topology  }) cluster</p>
<p>))))</p>
<p>Cluster&#x7C7B;&#x7684;needsSchedulingTopologies&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;&#x53C2;&#x6570;topologies&#x7ED1;&#x5B9A;&#x4E86;storm&#x96C6;&#x7FA4;&#x4E0A;&#x6240;&#x6709;&#x7684;topology</p>
<p> public  List  &lt;  TopologyDetails  &gt;  needsSchedulingTopologies ( Topologies  topologies ) {</p>
<p> List  &lt;  TopologyDetails  &gt;  ret  =  new  ArrayList  &lt;  TopologyDetails  &gt;();</p>
<p> for ( TopologyDetails  topology  :  topologies  .  getTopologies ()) {</p>
<p> // needsScheduling&#x65B9;&#x6CD5;&#x5224;&#x65AD;topology&#x662F;&#x5426;&#x9700;&#x8981;assign&#xFF0C;needsScheduling&#x65B9;&#x6CD5;&#x53C2;&#x89C1;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> if ( needsScheduling ( topology )) {</p>
<p> ret  .  add ( topology ); </p>
<p> }</p>
<p> }</p>
<p> return  ret ; </p>
<p>}</p>
<p>Cluster&#x7C7B;&#x7684;needsScheduling&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>/**</p>
<ul>
<li>Does the topology need scheduling?</li>
</ul>
<p>*</p>
<ul>
<li><p>A topology needs scheduling if one of the following conditions holds:</p>
</li>
<li><p>&lt;ul&gt;</p>
</li>
<li><p>&#xA0; &#xA0; &#xA0; &#x5982;&#x679C;topology&#x5DF2;&#x7ECF;assign&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x5206;&#x914D;&#x7684;&#x7EBF;&#x7A0B;&#x5C11;&#x4E8E;&#x671F;&#x671B;&#x7684;&#x7EBF;&#x7A0B;(&quot;&#x6B7B;&#x4EA1;&quot;slot&#x6216;&#x8005;&#x53EF;&#x7528;slot&#x4E0D;&#x591F;)&#xFF0C;&#x5219;&#x8BE5;topology&#x9700;&#x8981;assign</p>
</li>
<li><p>&#xA0; &lt;li&gt;Although the topology is assigned slots, but is squeezed. i.e. the topology is assigned less slots than desired.&lt;/li&gt;</p>
</li>
</ul>
<p>&#x8BE5;topology&#x6CA1;&#x6709;&#x5206;&#x914D;&#xFF0C;&#x5219;&#x9700;&#x8981;assign</p>
<ul>
<li><p>&#xA0; &lt;li&gt;There are unassigned executors in this topology&lt;/li&gt;</p>
</li>
<li><p>&lt;/ul&gt;</p>
</li>
</ul>
<p>*/</p>
<p> public  boolean  needsScheduling ( TopologyDetails  topology ) {</p>
<p> int  desiredNumWorkers  =  topology  .  getNumWorkers (); </p>
<p> // this&#x6307;&#x5411;&#x5F53;&#x524D;Cluster&#x5BF9;&#x8C61;&#xFF0C;Cluster&#x5BF9;&#x8C61;&#x5B58;&#x653E;&#x4E86;&#x5F53;&#x524D;storm&#x96C6;&#x7FA4;&#x8FD0;&#x884C;&#x7684;topology&#x7684;assignment&#x4FE1;&#x606F;,getAssignedNumWorkers&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6307;&#x5B9A;topology&#x7684;&#x5B9E;&#x9645;&#x8FDB;&#x7A0B;&#x6570;</p>
<p> int  assignedNumWorkers  =  this  .  getAssignedNumWorkers ( topology ); </p>
<p> if ( desiredNumWorkers  &gt;  assignedNumWorkers ) {</p>
<p> return  true ; </p>
<p> }</p>
<p> // getUnassignedExecutors&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x6307;&#x5B9A;topology&#x7684;&#x672A;assign&#x7684;Executors&#x7684;&#x96C6;&#x5408;</p>
<p> // &#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#xFF0C;&#x8BE5;&#x6761;&#x4EF6;&#x4E00;&#x5B9A;&#x4E3A;true&#xFF1B;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x4E0A;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x67D0;&#x4E2A;topology&#x7684;&#x67D0;&#x4E2A;executor&#x56E0;&#x4E3A;&quot;&#x5FC3;&#x8DF3;&quot;&#x8D85;&#x65F6;&#xFF0C;&#x4E5F;&#x4F1A;&#x4F7F;&#x8BE5;&#x6761;&#x4EF6;&#x4E3A;true</p>
<p> // getUnassignedExecutors&#x65B9;&#x6CD5;&#x53C2;&#x89C1;&#x5176;&#x5B9A;&#x4E49;&#x90E8;&#x5206;</p>
<p> return  this  .  getUnassignedExecutors ( topology  ).  size () &gt;  0 ; </p>
<p>}</p>
<p>Cluster&#x7C7B;&#x7684;getUnassignedExecutors&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1B;</p>
<p> public  Collection  &lt;  ExecutorDetails  &gt;  getUnassignedExecutors ( TopologyDetails  topology ) {</p>
<p> if ( topology  ==  null ) {</p>
<p> return  new  ArrayList  &lt;  ExecutorDetails  &gt;(  0 ); </p>
<p> }</p>
<p> // ret&#x6682;&#x5B58;topology&#x5B9A;&#x4E49;&#x4E2D;&#x9700;&#x8981;&#x7684;executor</p>
<p> Collection  &lt;  ExecutorDetails  &gt;  ret  =  new  HashSet ( topology  .  getExecutors ()); </p>
<p> // &#x83B7;&#x53D6;&#x6307;&#x5B9A;topology&#x7684;SchedulerAssignment</p>
<p> SchedulerAssignment  assignment  =  this  .  getAssignmentById ( topology  .  getId ()); </p>
<p> if ( assignment  !=  null ) {</p>
<p> // &#x83B7;&#x53D6;storm&#x96C6;&#x7FA4;&#x5B9E;&#x9645;&#x5206;&#x914D;&#x7ED9;&#x8BE5;topology&#x7684;executor</p>
<p> Set  &lt;  ExecutorDetails  &gt;  assignedExecutors  =  assignment  .  getExecutors (); </p>
<p> // ret&#x5220;&#x9664;&#x5B9E;&#x9645;&#x5206;&#x914D;&#x7684;executor&#xFF0C;&#x4FDD;&#x7559;&#x672A;&#x5206;&#x914D;&#x7684;executor</p>
<p> ret  .  removeAll ( assignedExecutors ); </p>
<p> }</p>
<p> return  ret ; </p>
<p>}</p>
<p>EvenScheduler.clj&#x4E2D;&#x7684;get-alive-assigned-node+port-&gt;executors&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  get-alive-assigned-node+port-&gt;executors  [  cluster  topology-id  ]</p>
<p>;; existing-assignment&#x7ED1;&#x5B9A;topology-id&#x5BF9;&#x5E94;&#x7684;SchedulerAssignmentImpl</p>
<p>( let  [  existing-assignment ( .getAssignmentById  cluster  topology-id ) </p>
<p> ;; executor-&gt;slot&#x7ED1;&#x5B9A;ExecutorDetails-&gt;WorkerSlot&#x7684;map</p>
<p> executor-&gt;slot ( if  existing-assignment</p>
<p>( .getExecutorToSlot  existing-assignment ) </p>
<p> {})</p>
<p> ;; executor-&gt;node+port&#x5982;{[1 2] [node1 port1], [3 4] [node1 port1], [5 6] [node2 port1], [7 8] [node2 port1]}</p>
<p> executor-&gt;node+port ( into  {} ( for  [[  ^  ExecutorDetails  executor  ^  WorkerSlot  slot  ]  executor-&gt;slot</p>
<p> :let  [  executor  [(  .getStartTask  executor ) ( .getEndTask  executor  )]</p>
<p> node+port  [(  .getNodeId  slot ) ( .getPort  slot  )]]]</p>
<p> {  executor  node+port  }))</p>
<p> ;; alive-assigned&#x5982;{[node1 port1] [[1 2] [3 4]] [node2 port1] [[5 6] [7 8]]}</p>
<p> alive-assigned ( reverse-map  executor-&gt;node+port  )]</p>
<p>alive-assigned</p>
<p>))</p>
<p>bad-slots&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>;; existing-slots&#x7ED1;&#x5B9A;[node+port]-&gt;[slot-id]&#x7684;map&#xFF0C;&#x8868;&#x793A;&#x8BE5;topology&#x7684;&quot;&#x4E0A;&#x4E00;&#x6B21;&#x5212;&#x5206;&quot;&#xFF0C;num-executors&#x7ED1;&#x5B9A;&#x8BE5;topology&#x5B9A;&#x4E49;&#x4E2D;&#x7684;executor&#x603B;&#x6570;&#xFF0C;num-workers&#x7ED1;&#x5B9A;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x4E2D;&#x8BE5;topology&#x53EF;&#x4EE5;&#x5206;&#x914D;&#x5230;&#x7684;&#x8FDB;&#x7A0B;&#x603B;&#x6570;&#xFF08;slot&#x603B;&#x6570;&#xFF09;</p>
<p>;; &#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x6765;&#x8BF4;&#xFF0C;bad-slots&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x96C6;&#x5408;</p>
<p>( defn-  bad-slots  [  existing-slots  num-executors  num-workers  ]</p>
<p>( if ( =  0  num-workers ) </p>
<p> &apos; () </p>
<p> ;; distribution&#x7ED1;&#x5B9A;&#x5728;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x72B6;&#x6001;&#x4E0B;&#x8BE5;topology&#x7684;&#x65B0;&#x5212;&#x5206;&#xFF0C;&#x5982;(integer-divided 5 2)&#x8FD4;&#x56DE;{2 1, 3 1}&#x8868;&#x793A;&#x4E00;&#x4E2A;slot&#x8FD0;&#x884C;2&#x4E2A;executor&#xFF0C;&#x4E00;&#x4E2A;slot&#x8FD0;&#x884C;3&#x4E2A;executor</p>
<p>( let  [  distribution ( atom ( integer-divided  num-executors  num-workers )) </p>
<p> ;; keepers&#x7ED1;&#x5B9A;&quot;&#x5206;&#x914D;&#x7406;&#x60F3;&quot;&#x7684;slot</p>
<p> keepers ( atom  {})]</p>
<p> ;; doseq&#x5FAA;&#x73AF;&#x7528;&#x4E8E;&#x8FC7;&#x6EE4;&#x51FA;&#x8BE5;topology&#x7684;&quot;&#x4E0A;&#x4E00;&#x6B21;&#x5212;&#x5206;&quot;&#x4E0E;&quot;&#x65B0;&#x5212;&#x5206;&quot;&#x76F8;&#x540C;&#x7684;&#x5212;&#x5206;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x5B58;&#x5165;keepers&#x4E2D;</p>
<p>( doseq  [[  node+port  executor-list  ]  existing-slots  :let  [  executor-count ( count  executor-list  )]]</p>
<p>( when ( pos? ( get  @  distribution  executor-count  0 )) </p>
<p>( swap!  keepers  assoc  node+port  executor-list ) </p>
<p>( swap!  distribution  update-in  [  executor-count  ]  dec ) </p>
<p>))</p>
<p> ;; &#x4ECE;&quot;&#x4E0A;&#x4E00;&#x6B21;&#x5212;&#x5206;&quot;existing-slots&#x4E2D;&#x5220;&#x9664;&quot;&#x5206;&#x914D;&#x7406;&#x60F3;&quot;&#x7684;&#x5212;&#x5206;keepers&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&quot;&#x5206;&#x914D;&#x4E0D;&#x7406;&#x60F3;&quot;&#x7684;WorkSlot&#x96C6;&#x5408;</p>
<p>( -&gt;&gt;  @  keepers</p>
<p> keys</p>
<p>( apply dissoc  existing-slots ) </p>
<p> keys</p>
<p>( map ( fn  [[  node  port  ]]</p>
<p>( WorkerSlot.  node port</p>
<p>)))))))</p>
<p>Cluster&#x7C7B;&#x4E2D;&#x7684;freeSlots&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;&#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x4E86;freeSlot&#x65B9;&#x6CD5;</p>
<p> public  void  freeSlots ( Collection  &lt;  WorkerSlot  &gt;  slots ) {</p>
<p> if ( slots  !=  null ) {</p>
<p> for ( WorkerSlot  slot  :  slots ) {</p>
<p> this  .  freeSlot ( slot ); </p>
<p> }</p>
<p> }</p>
<p>}</p>
<p>Cluster&#x7C7B;&#x4E2D;&#x7684;freeSlot&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;&#x5224;&#x65AD;&#x8BE5;slot&#x662F;&#x5426;&#x88AB;&#x5360;&#x7528;&#xFF08;cluster&#x4E2D;SchedulerAssignmentImpl&#x7684;executorToSlot&#x662F;&#x5426;&#x5305;&#x542B;&#x8BE5;slot&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x5360;&#x7528;&#xFF08;executorToSlot&#x5305;&#x542B;slot&#xFF09;&#x5219;&#x91CA;&#x653E;&#x5360;&#x7528;&#xFF0C;&#x6240;&#x8C13;&#x91CA;&#x653E;&#x5360;&#x7528;&#x5C31;&#x662F;&#x4ECE;SchedulerAssignmentImpl&#x7684;executorToSlot&#x4E2D;&#x5220;&#x9664;&#x8BE5;slot&#x5BF9;&#x5E94;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x3002;</p>
<p> public  void  freeSlot ( WorkerSlot  slot ) {</p>
<p> // remove the slot from the existing assignments</p>
<p> for ( SchedulerAssignmentImpl  assignment  :  this  .  assignments  .  values ()) {</p>
<p> if ( assignment  .  isSlotOccupied ( slot )) {</p>
<p> assignment  .  unassignBySlot ( slot ); </p>
<p> }</p>
<p> }</p>
<p>}</p>
<p>Cluster&#x7C7B;&#x4E2D;&#x7684;unassignBySlot&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> public  void  unassignBySlot ( WorkerSlot  slot ) {</p>
<p> List  &lt;  ExecutorDetails  &gt;  executors  =  new  ArrayList  &lt;  ExecutorDetails  &gt;();</p>
<p> for ( ExecutorDetails  executor  :  this  .  executorToSlot  .  keySet ()) {</p>
<p> WorkerSlot  ws  =  this  .  executorToSlot  .  get ( executor ); </p>
<p> if ( ws  .  equals ( slot )) {</p>
<p> executors  .  add ( executor ); </p>
<p> }</p>
<p> }</p>
<p> // remove</p>
<p> for ( ExecutorDetails  executor  :  executors ) {</p>
<p> this  .  executorToSlot  .  remove ( executor ); </p>
<p> }</p>
<p>}</p>
<p>EvenScheduler.clj&#x4E2D;&#x7684;schedule-topologies-evenly&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>;; topologies&#x7ED1;&#x5B9A;Topologies&#x5BF9;&#x8C61;&#xFF0C;cluster&#x7ED1;&#x5B9A;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x7684;&#x72B6;&#x6001;</p>
<p>( defn  schedule-topologies-evenly  [  ^  Topologies  topologies  ^  Cluster  cluster  ]</p>
<p>;; &#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;topologies&#x660E;&#x660E;&#x662F;&#x7531;&quot;&#x9700;&#x8981;&#x5206;&#x914D;&quot;&#x7684;topology id&#x548C;&#x5BF9;&#x5E94;TopologyDetails&#x6784;&#x5EFA;&#x7684;&#xFF0C;&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x91CC;&#x53C8;&#x91CD;&#x65B0;&#x8C03;&#x7528;&#x4E86;&#x4E00;&#x6B21;cluster&#x7684;needsSchedulingTopologies&#x65B9;&#x6CD5;&#x5462;&#xFF1F;</p>
<p>;; &#x539F;&#x56E0;&#x662F;&#x5728;default-schedule&#x51FD;&#x6570;&#x4E2D;&#x8C03;&#x7528;&#x4E86;(.freeSlots cluster bad-slots)&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4ECE;cluster&#x4E2D;&#x5220;&#x9664;&#x4E86;&quot;bad&quot; slot&#xFF0C;&#x6539;&#x53D8;&#x4E86;&#x96C6;&#x7FA4;&#x4E2D;&#x67D0;&#x4E9B;topology&#x7684;TopologyDetails&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x8C03;&#x7528;needsSchedulingTopologies</p>
<p>( let  [  needs-scheduling-topologies ( .needsSchedulingTopologies  cluster  topologies  )]</p>
<p>( doseq  [  ^  TopologyDetails  topology  needs-scheduling-topologies</p>
<p> :let  [  topology-id ( .getId  topology ) </p>
<p> ;; new-assignment&#x7ED1;&#x5B9A;&#x8BE5;topology&#x7684;&#x65B0;&#x589E;&#x5206;&#x914D;executor id-&gt;[node+port]&#x7684;map</p>
<p> new-assignment ( schedule-topology  topology  cluster ) </p>
<p> node+port-&gt;executors ( reverse-map  new-assignment  )]]</p>
<p>( doseq  [[  node+port  executors  ]  node+port-&gt;executors</p>
<p> ;; &#x751F;&#x6210;WorkerSlot&#x5BF9;&#x8C61;</p>
<p> :let  [  ^  WorkerSlot  slot ( WorkerSlot. ( first  node+port ) ( last  node+port )) </p>
<p> ;; &#x751F;&#x6210;ExecutorDetails&#x5BF9;&#x8C61;</p>
<p> executors ( for  [[  start-task  end-task  ]  executors  ]</p>
<p>( ExecutorDetails.  start-task  end-task  ))]]</p>
<p> ;; &#x901A;&#x8FC7;&#x8C03;&#x7528;cluster&#x7684;assign&#x65B9;&#x6CD5;&#xFF0C;&#x628A;&#x65B0;&#x589E;&#x7684;&#x5206;&#x914D;&#x4FE1;&#x606F;&#x6DFB;&#x52A0;&#x5230;cluster&#x4E2D;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x7684;&#x5206;&#x914D;&#x4FE1;&#x606F;&#x4E5F;&#x6DFB;&#x52A0;&#x5230;&#x4E86;cluter&#x4E2D; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p>( .assign  cluster  slot  topology-id executors</p>
<p>)))))</p>
<p>schedule-topology&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn-  schedule-topology  [  ^  TopologyDetails  topology  ^  Cluster  cluster  ]</p>
<p>( let  [  topology-id ( .getId  topology ) </p>
<p> ;; available-slots&#x7ED1;&#x5B9A;&#x5F53;&#x524D;&#x96C6;&#x7FA4;&#x6240;&#x6709;&#x53EF;&#x7528;&#x7684;slot</p>
<p> available-slots ( -&gt;&gt; ( .getAvailableSlots  cluster ) </p>
<p>( map  # ( vector ( .getNodeId  % ) ( .getPort  % )))) </p>
<p> ;; all-executors&#x7ED1;&#x5B9A;topology&#x5B9A;&#x4E49;&#x4E2D;&#x7684;&#x6240;&#x6709;executor&#x96C6;&#x5408; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;</p>
<p> all-executors ( -&gt;&gt;  topology</p>
<p> .getExecutors</p>
<p>( map  # ( vector ( .getStartTask  % ) ( .getEndTask  % ))) </p>
<p> set ) </p>
<p> ;; alive-assigned&#x7ED1;&#x5B9A;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x7ED9;&#x8BE5;topology&#x7684;slot&#xFF0C;&#x5BF9;&#x4E8E;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#xFF0C;alive-assigned&#x4E3A;&#x7A7A;&#x96C6;&#x5408;</p>
<p> alive-assigned ( get-alive-assigned-node+port-&gt;executors  cluster  topology-id ) </p>
<p> ;; total-slots-to-use&#x7ED1;&#x5B9A;&#x8BE5;topology&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;slot&#x603B;&#x6570;</p>
<p> total-slots-to-use ( min ( .getNumWorkers  topology ) </p>
<p>( + ( count  available-slots ) ( count  alive-assigned ))) </p>
<p> ;; reassign-slots&#x7ED1;&#x5B9A;&#x4E3A;&#x8BE5;topology&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;slot&#xFF0C;&#x5373;&#x589E;&#x52A0;&#x5206;&#x914D;&#x7684;slot&#xFF0C;&#x5206;&#x914D;&#x7684;&#x4E2A;&#x6570;&#x4E3A;total-slots-to-use&#x51CF;&#x53BB;&#x5DF2;&#x5206;&#x914D;&#x7684;slot&#x6570;</p>
<p> ;; sort-slots&#x51FD;&#x6570;&#x5BF9;available-slots&#x8FDB;&#x884C;&#x4EA4;&#x53C9;&#x6392;&#x5E8F;&#xFF0C;&#x5982;available-slots=([11 1] [11 2] [11 5] [22 1] [22 2] [22 3] [22 4] [22 5] [33 3] [33 4])</p>
<p> ;; &#x6392;&#x5E8F;&#x540E;&#x4E3A;([11 1] [22 1] [33 3] [11 2] [22 2] [33 4] [11 5] [22 3] [22 4] [22 5])</p>
<p> reassign-slots ( take ( -  total-slots-to-use ( count  alive-assigned )) </p>
<p>( sort-slots  available-slots )) </p>
<p> ;; reassign-executors&#x7ED1;&#x5B9A;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;executor&#x7684;&#x96C6;&#x5408;</p>
<p> reassign-executors ( sort ( set/difference  all-executors ( set ( apply concat ( vals  alive-assigned ))))) </p>
<p> ;; reassignment&#x7ED1;&#x5B9A;executor id-&gt;slot id&#x7684;map&#xFF0C;&#x8868;&#x793A;&#x589E;&#x52A0;&#x7684;assignment&#xFF0C;&#x4ECE;reassign-executors&#x53D6;&#x4E00;&#x4E2A;executor id&#x4F5C;&#x4E3A;map&#x7684;key&#xFF0C;&#x518D;&#x4ECE;reassign-slots&#x4E2D;</p>
<p> ;; &#x53D6;&#x4E00;&#x4E2A;slot&#x4F5C;&#x4E3A;map&#x7684;value&#xFF0C;&#x7531;&#x4E8E;reassign-slots&#x662F;&#x4EA4;&#x53C9;&#x6709;&#x5E8F;&#x7684;&#xFF0C;&#x8FD9;&#x6837;executor&#x5C31;&#x53EF;&#x4EE5;&#x5747;&#x5300;&#x7684;&#x5206;&#x914D;&#x7ED9;&#x5404;&#x4E2A;supervisor</p>
<p> reassignment ( into  {}</p>
<p>( map  vector</p>
<p> reassign-executors</p>
<p> ;; for some reason it goes into infinite loop without limiting the repeat-seq</p>
<p> ;; repeat-seq&#x51FD;&#x6570;&#x5C06;reassign-slots&#x96C6;&#x5408;&#x6269;&#x5C55;&#x6210;&#x539F;&#x6765;&#x7684;(count reassign-executors)&#x500D;&#xFF0C;&#x5982;reassign-slots=([11 1] [22 1])&#xFF0C;(count reassign-executors)=3</p>
<p> ;; &#x8FD4;&#x56DE;([11 1] [22 1] [11 1] [22 1] [11 1] [22 1])&#xFF0C;&#x8FD9;&#x6837;[11 1]&#x88AB;&#x5206;&#x914D;2&#x4E2A;executor&#xFF0C;[22 1]&#x88AB;&#x5206;&#x914D;1&#x4E2A;executor</p>
<p> ;; &#x4E4B;&#x6240;&#x4EE5;&#x9700;&#x8981;repeat-seq, &#x662F;&#x56E0;&#x4E3A;executors&#x5F80;&#x5F80;&#x591A;&#x4E8E;slots</p>
<p>( repeat-seq ( count  reassign-executors ) reassign-slots  )))]</p>
<p>( when-not ( empty?  reassignment ) </p>
<p>( log-message  &quot;Available slots: &quot; ( pr-str  available-slots )) </p>
<p>)</p>
<p> ;; &#x8FD4;&#x56DE;reassignment</p>
<p>reassignment</p>
<p>))</p>
<p>Cluter&#x7C7B;&#x4E2D;&#x7684;assign&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x5C31;&#x662F;&#x5C06;&#x65B0;&#x589E;&#x5206;&#x914D;&#x4FE1;&#x606F;&#x6DFB;&#x52A0;&#x5230;cluster&#x7684;SchedulerAssignmentImpl&#x7684;executorToSlot&#x4E2D;&#x3002;&#x901A;&#x8FC7;&#x8C03;&#x7528;assign&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x63D0;&#x4EA4;&#x7684;topology&#x7684;&#x5206;&#x914D;&#x4FE1;&#x606F;&#x4E5F;&#x6DFB;&#x52A0;&#x5230;&#x4E86;cluster&#x4E2D;&#x3002;</p>
<p> public  void  assign ( WorkerSlot  slot  ,  String  topologyId  ,  Collection  &lt;  ExecutorDetails  &gt;  executors ) {</p>
<p> if ( this  .  isSlotOccupied ( slot )) {</p>
<p> throw  new  RuntimeException ( &quot;slot: [&quot;  +  slot  .  getNodeId () +  &quot;, &quot;  +  slot  .  getPort () +  &quot;] is already occupied.&quot; ); </p>
<p> }</p>
<p> SchedulerAssignmentImpl  assignment  = ( SchedulerAssignmentImpl ) this  .  getAssignmentById ( topologyId ); </p>
<p> if ( assignment  ==  null ) {</p>
<p> assignment  =  new  SchedulerAssignmentImpl ( topologyId  ,  new  HashMap  &lt;  ExecutorDetails  ,  WorkerSlot  &gt;());</p>
<p> this  .  assignments  .  put ( topologyId  ,  assignment ); </p>
<p> }  else  {</p>
<p> for ( ExecutorDetails  executor  :  executors ) {</p>
<p> if ( assignment  .  isExecutorAssigned ( executor )) {</p>
<p> throw  new  RuntimeException ( &quot;the executor is already assigned, you should unassign it before assign it to another slot.&quot; ); </p>
<p> }</p>
<p> }</p>
<p> }</p>
<p> assignment  .  assign ( slot  ,  executors ); </p>
<p>}</p>
<p>changed-executors&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>( defn  changed-executors  [  executor-&gt;node+port  new-executor-&gt;node+port  ]</p>
<p>;; slot-assigned&#x5982;{[node1 port1] [[1 2] [3 4] [5 6]], [node1 port2] [[7 8] [9 10]]}</p>
<p>( let  [  slot-assigned ( reverse-map  executor-&gt;node+port ) </p>
<p> ;; new-slot-assigned&#x5982;{[node1 port1] [[1 2] [7 8]], [node2 port1] [[3 4] [9 10]], [node1 port2] [[5 6]]}</p>
<p> new-slot-assigned ( reverse-map  new-executor-&gt;node+port ) </p>
<p> ;; brand-new-slots&#x7ED1;&#x5B9A;&#x5728;new-slot-assigned&#x4E2D;&#x5B58;&#x5728;&#xFF0C;&#x4F46;&#x5728;slot-assigned&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5982;{[node1 port1] [[1 2] [7 8]], [node2 port1] [[3 4] [9 10]], [node1 port2] [[5 6]]}</p>
<p> brand-new-slots ( map-diff  slot-assigned  new-slot-assigned  )]</p>
<p> ;; ([1 2] [3 4] [5 6] [7 8] [9 10])</p>
<p>( apply concat ( vals  brand-new-slots )) </p>
<p>))</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/ZooKeeper/">ZooKeeper</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/10a4335/" title="supervisor management kafka zookeeper -" itemprop="url">supervisor management kafka zookeeper -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:05.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x4F7F;&#x7528;supervisor&#x6765;&#x7BA1;&#x7406;kafka&#x548C;zookeeper,&#x6211;&#x89C9;&#x5F97;&#x8FD8;&#x662F;&#x4E0D;&#x9519;&#x7684;&#xFF01;&#x81F3;&#x5C11;&#x76EE;&#x524D;&#x6211;&#x7528;&#x5F97;&#x89C9;&#x5F97;&#x8FD8;&#x53EF;&#x4EE5;&#xFF01;supervisor&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> Shell</p>
<pre><code># cat /etc/supervisord.conf | grep -v ^; | grep -v ^$
[unix_http_server]
<span class="keyword">file</span>=/tmp/supervisor.sock   ; (the path to the socket <span class="keyword">file</span>)
[supervisord]
logfile=/tmp/supervisord.<span class="keyword">log</span> ; (main <span class="keyword">log</span> <span class="keyword">file</span>;<span class="keyword">default</span> <span class="variable">$CWD</span>/supervisord.<span class="keyword">log</span>)
logfile_maxbytes=<span class="number">50</span>MB        ; (<span class="keyword">max</span> main logfile bytes b4 rotation;<span class="keyword">default</span> <span class="number">50</span>MB)
logfile_backups=<span class="number">10</span>           ; (num of main logfile rotation backups;<span class="keyword">default</span> <span class="number">10</span>)
loglevel=info                ; (<span class="keyword">log</span> level;<span class="keyword">default</span> info; others: debug,warn,<span class="keyword">trace</span>)
pidfile=/tmp/supervisord.pid ; (supervisord pidfile;<span class="keyword">default</span> supervisord.pid)
nodaemon=false               ; (start <span class="keyword">in</span> foreground <span class="keyword">if</span> true;<span class="keyword">default</span> false)
minfds=<span class="number">1024</span>                  ; (<span class="keyword">min</span>. avail startup <span class="keyword">file</span> descriptors;<span class="keyword">default</span> <span class="number">1024</span>)
minprocs=<span class="number">200</span>                 ; (<span class="keyword">min</span>. avail process descriptors;<span class="keyword">default</span> <span class="number">200</span>)
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
[supervisorctl]
serverurl=unix:<span class="comment">///tmp/supervisor.sock ; use a unix:// URL  for a unix socket</span>
[include]
files = /etc/supervisor_conf<span class="comment">/*.ini</span>
</code></pre><p>echo_supervisord_conf &#x751F;&#x6210;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x540E;&#x6CA1;&#x505A;&#x592A;&#x591A;&#x6539;&#x52A8;&#xFF0C;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x884C;include&#x6807;&#x7B7E;&#xFF0C;&#x5C06;kafka zookeeper&#x542F;&#x52A8;&#x914D;&#x7F6E;&#x5199;&#x5230;ini&#x6587;&#x4EF6;&#x4E2D;</p>
<p>kafka.ini&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> Shell</p>
<pre><code><span class="comment"># ll -h</span>
total <span class="number">12</span>K
-rw-r--r-- <span class="number">1</span> <span class="literal">root</span> <span class="literal">root</span> <span class="number">163</span> <span class="constant">Mar</span> <span class="number">23</span> <span class="number">15</span>:<span class="number">29</span> kafka.ini
-rw-r--r-- <span class="number">1</span> <span class="literal">root</span> <span class="literal">root</span> <span class="number">144</span> <span class="constant">Mar</span> <span class="number">23</span> <span class="number">20</span>:<span class="number">02</span> zookeeper2182.ini_old
-rw-r--r-- <span class="number">1</span> <span class="literal">root</span> <span class="literal">root</span> <span class="number">136</span> <span class="constant">Mar</span> <span class="number">23</span> <span class="number">15</span>:<span class="number">29</span> zookeeper.ini

<span class="comment"># cat kafka.ini </span>
[program:kafka]
<span class="literal">command</span>=/usr/local/kafka/bin/kafka-server-<span class="literal">start</span>.sh /usr/local/kafka/config/server.properties
<span class="keyword">user</span>=<span class="literal">root</span>
autostart=<span class="keyword">true</span>
autorestart=<span class="keyword">true</span>
startsecs=<span class="number">3</span>
</code></pre><p>zookeeper.ini&#x914D;&#x7F6E;&#xFF1A;</p>
<p> Shell</p>
<pre><code><span class="comment"># cat zookeeper.ini </span>
[program:zookeeper]
<span class="variable">command=</span>/usr/local/zookeeper/bin/zkServer.sh start-foreground
<span class="variable">user=</span>root
<span class="variable">autostart=</span><span class="constant">true</span>
<span class="variable">autorestart=</span><span class="constant">true</span>
<span class="variable">startsecs=</span><span class="number">3</span>
</code></pre><p>&#x542F;&#x52A8;:</p>
<p> Shell</p>
<pre><code><span class="preprocessor"># /etc/init.d/supervisord start</span>
</code></pre><p>&#x67E5;&#x770B;&#x72B6;&#x6001;&#xFF1A;</p>
<p> Shell</p>
<pre><code># <span class="tag">supervisorctl</span> <span class="tag">status</span>
<span class="tag">kafka</span>                            <span class="tag">RUNNING</span>   <span class="tag">pid</span> 1709, <span class="tag">uptime</span> 9<span class="pseudo">:50</span><span class="pseudo">:46</span>
<span class="tag">zookeeper</span>                        <span class="tag">RUNNING</span>   <span class="tag">pid</span> 1552, <span class="tag">uptime</span> 9<span class="pseudo">:51</span><span class="pseudo">:41</span>
</code></pre><p>&#x672C;&#x6587;&#x7CFB;&#x5C5E;&#x51D1;&#x6570;&#x7BC7;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Kafka/">Kafka</a><a href="/tags/Linux/">Linux</a><a href="/tags/ZooKeeper/">ZooKeeper</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/19/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/21/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>587</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>32</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>23</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>9</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
