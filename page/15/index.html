
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/15/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2727e72/" title="zabbix monitor redis memcached with python script -" itemprop="url">zabbix monitor redis memcached with python script -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>zabbix &#x76D1;&#x63A7;memcached&#x548C;redis&#xFF0C;&#x4EE5;&#x524D;&#x90FD;&#x662F;&#x7528;shell&#x5199;&#x811A;&#x672C;&#xFF0C;&#x4ECA;&#x5929;&#x4E0D;&#x662F;&#x592A;&#x5FD9;&#xFF0C;&#x6240;&#x4EE5;&#x7528;python&#x4EE3;&#x66FF;shell,&#x6765;&#x8BA9;zabbix&#x8C03;&#x7528;&#x53D6;&#x6570;&#x636E;</p>
<p>1&#x3001;&#x76D1;&#x63A7;memcached&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p> Python</p>
<pre><code><span class="comment"># cat get_memcached_status.py </span>
<span class="comment">#!/usr/bin/env python</span>
<span class="comment">#coding=utf8</span>
<span class="keyword">import</span> sys
<span class="keyword">import</span> os
<span class="class"><span class="keyword">class</span> <span class="title">GetMemStatus</span><span class="params">()</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>
        self.val = {}
    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span>
        <span class="keyword">try</span>:
            <span class="keyword">import</span> memcache
            self.mc = memcache.Client([&amp;apos;<span class="number">127.0</span>.0.1:<span class="number">11211</span>&amp;apos;], debug=<span class="number">0</span>)
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;Plugin needs the memcache module&amp;apos;
    <span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(self, key)</span>:</span>
        stats = self.mc.get_stats()
        <span class="keyword">try</span>:
            <span class="keyword">if</span> key <span class="keyword">in</span> stats[<span class="number">0</span>][<span class="number">1</span>]:
                self.val[key] = stats[<span class="number">0</span>][<span class="number">1</span>][key]
            <span class="keyword">return</span> self.val[key]
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;ERROR: key <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!&amp;apos;
<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:
        <span class="keyword">print</span> &amp;quot;ERROR! Please enter a key&amp;quot;
    <span class="keyword">elif</span> len(sys.argv) == <span class="number">2</span>:
        key = sys.argv[<span class="number">1</span>]
        a = GetMemStatus()
        a.check()
        <span class="keyword">print</span> a.extract(key)
<span class="keyword">if</span> __name__ == &amp;quot;__main__&amp;quot;:
    main()
</code></pre><p>&#x6267;&#x884C;&#x6D4B;&#x8BD5;&#xFF1A;</p>
<p> Shell</p>
<pre><code>[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py</span>
<span class="keyword">ERROR</span>! Please enter a <span class="keyword">key</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py pointer_size</span>
<span class="number">64</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py get_misses</span>
<span class="number">2</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py get_hits</span>
<span class="number">1</span>
<span class="preprocessor"># ./get_memcached_status.py aaa</span>
Traceback (most recent <span class="keyword">call</span> last):
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">36</span>, <span class="keyword">in</span> 


    main()
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">33</span>, <span class="keyword">in</span> main
    print a.extract(<span class="keyword">key</span>)
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">24</span>, <span class="keyword">in</span> extract
    raise Exception, &amp;apos;<span class="keyword">ERROR</span>: <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!&amp;apos;
Exception: <span class="keyword">ERROR</span>: <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!
</code></pre><p>&#x5F53;&#x811A;&#x672C;&#x540E;&#x9762;&#x4E0D;&#x8DDF;key&#x65F6;&#x63D0;&#x793A;error&#xFF0C;&#x5F53;&#x811A;&#x672C;&#x540E;&#x9762;&#x8DDF;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x7684;key&#x65F6;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;</p>
<p>2&#x3001;redis&#x811A;&#x672C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> Python</p>
<pre><code><span class="comment"># cat get_redis_status.py </span>
<span class="comment">#!/usr/bin/env python</span>
<span class="comment">#coding=utf8</span>
<span class="keyword">import</span> sys
<span class="keyword">import</span> os
<span class="class"><span class="keyword">class</span> <span class="title">GetRedisStatus</span><span class="params">()</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>
        self.val = {}
    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span>
        <span class="keyword">try</span>:
            <span class="keyword">import</span> redis
            self.redis = redis.Redis(&amp;apos;<span class="number">127.0</span>.0.1&amp;apos;, port=<span class="number">6379</span>, password=<span class="keyword">None</span>)
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;Plugin needs the redis module&amp;apos;
    <span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(self, key)</span>:</span>
        info = self.redis.info()
        <span class="keyword">try</span>:
            <span class="keyword">if</span> key <span class="keyword">in</span> info:
                self.val[key] = info[key]
            <span class="keyword">return</span> self.val[key]
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;ERROR info <span class="keyword">not</span> include this key!&amp;apos;
<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:
        <span class="keyword">print</span> &amp;quot;ERROR! Please enter a key&amp;quot;
    <span class="keyword">elif</span> len(sys.argv) == <span class="number">2</span>:
        key = sys.argv[<span class="number">1</span>]
        a = GetRedisStatus()
        a.check()
        <span class="keyword">print</span> a.extract(key)
<span class="keyword">if</span> __name__ == &amp;quot;__main__&amp;quot;:
    main()
</code></pre><p>&#x6267;&#x884C;:</p>
<p> Shell</p>
<pre><code>[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># python get_redis_status.py </span>
ERROR! Please enter a key
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py db11 </span>
Traceback (most recent call last):
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">40</span>, <span class="keyword">in</span> 


    main()
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">37</span>, <span class="keyword">in</span> main
    <span class="built_in">print</span> a.extract(key)
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">27</span>, <span class="keyword">in</span> extract
    raise Exception, &amp;apos;ERROR info <span class="keyword">not</span> include <span class="keyword">this</span> key!&amp;apos;
<span class="attribute">Exception</span>: ERROR info <span class="keyword">not</span> include <span class="keyword">this</span> key!
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_memory</span>
<span class="number">844384</span>
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_cpu_sys</span>
<span class="number">5422.29</span>
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_memory_human</span>
<span class="number">824.59</span>K
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Python/">Python</a><a href="/tags/zabbix/">zabbix</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2730248/" title="redis和memcached比较 -" itemprop="url">redis和memcached比较 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>1&#x3001;CPU&#x6838;&#x5FC3;&#xFF1A;</p>
<p>&#x7531;&#x4E8E;Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;&#xFF0C;&#x800C;Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF0C;&#x6240;&#x4EE5;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#xFF0C;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77; Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;</p>
<p>&#x56E0;&#x4E3A; Redis &#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x975E;&#x5E38;&#x5FEB;&#x901F;&#x2014;&#x2014;&#x5B83;&#x7684;&#x6570;&#x636E;&#x5168;&#x90E8;&#x5728;&#x5185;&#x5B58;&#x91CC;&#xFF0C;&#x5B8C;&#x5168;&#x4E0D;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x78C1;&#x76D8;&#x3002;&#x81F3;&#x4E8E;&#x5E76;&#x53D1;&#xFF0C;Redis &#x4F7F;&#x7528;&#x591A;&#x8DEF; I/O &#x590D;&#x7528;&#x6280;&#x672F;&#xFF0C;&#x672C;&#x8EAB;&#x7684;&#x5E76;&#x53D1;&#x6548;&#x7387;&#x4E0D;&#x6210;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x5355;&#x4E2A; Redis &#x8FDB;&#x7A0B;&#x6CA1;&#x529E;&#x6CD5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF08;&#x4EFB;&#x4E00;&#x65F6;&#x523B;&#x53EA;&#x80FD;&#x8DD1;&#x5728;&#x4E00;&#x4E2A; CPU &#x6838;&#x5FC3;&#x4E0A;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x672C;&#x6765;&#x5C31;&#x4E0D;&#x662F;&#x975E;&#x5E38;&#x8BA1;&#x7B97;&#x5BC6;&#x96C6;&#x578B;&#x7684;&#x670D;&#x52A1;&#x3002;&#x5982;&#x679C;&#x5355;&#x6838;&#x6027;&#x80FD;&#x4E0D;&#x591F;&#x7528;&#xFF0C;&#x53EF;&#x4EE5;&#x591A;&#x5F00;&#x51E0;&#x4E2A;&#x8FDB;&#x7A0B;&#x3002;</p>
<p>Redis &#x5355;&#x7EBF;&#x7A0B;-&#x591A;&#x8DEF;&#x590D;&#x7528;io&#x6A21;&#x578B; </p>
<p>2&#x3001;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#x5BF9;&#x6BD4;&#xFF1A;</p>
<p>&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#x7684;&#x8BDD;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8;&#xFF0C;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;</p>
<p>3&#x3001;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1A;</p>
<p>Redis&#x76F8;&#x6BD4;Memcached&#x6765;&#x8BF4;&#xFF0C;&#x62E5;&#x6709;&#x66F4;&#x591A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;&#x5E76;&#x652F;&#x6301;&#x66F4;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#xFF0C;&#x901A;&#x5E38;&#x5728;Memcached &#x91CC;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x62FF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8FDB;&#x884C;&#x7C7B;&#x4F3C;&#x7684;&#x4FEE;&#x6539;&#x518D;set&#x56DE;&#x53BB;&#x3002;&#x8FD9;&#x5927;&#x5927;&#x589E;&#x52A0;&#x4E86;&#x7F51;&#x7EDC;IO&#x7684;&#x6B21;&#x6570;&#x548C;&#x6570;&#x636E;&#x4F53;&#x79EF;&#x3002;&#x5728;Redis&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x7684;&#x64CD;&#x4F5C;&#xFFFD;&#xFFFD;&#xFFFD;&#x5E38;&#x548C;&#x4E00;&#x822C;&#x7684; GET/SET&#x4E00;&#x6837;&#x9AD8;&#x6548;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x7F13;&#x5B58;&#x80FD;&#x591F;&#x652F;&#x6301;&#x66F4;&#x590D;&#x6742;&#x7684;&#x7ED3;&#x6784;&#x548C;&#x64CD;&#x4F5C;&#xFF0C;&#x90A3;&#x4E48;Redis&#x4F1A;&#x662F;&#x4E0D;&#x9519;&#x7684;&#x9009;&#x62E9;&#x3002;</p>
<p>4&#x3001;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Redis/">Redis</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2732958/" title="MemCached缓存知识知多少？ -" itemprop="url">MemCached缓存知识知多少？ -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li>MemCached&#x662F;&#x795E;&#x9A6C;&#xFF1F;</li>
</ol>
<p>Memcached&#xA0; &#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x7528;&#x4E8E;&#x52A8;&#x6001;Web&#x5E94;&#x7528;&#x4EE5;&#x51CF;&#x8F7B;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#x3002;&#x5B83;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x548C;&#x5BF9;&#x8C61;&#x6765;&#x51CF;&#x5C11;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x52A8;&#x6001;&#x3001;&#x6570;&#x636E;&#x5E93;&#x9A71;&#x52A8;&#x7F51;&#x7AD9;&#x7684;&#x901F;&#x5EA6;&#x3002;Memcached&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;/&#x503C;&#x5BF9;&#x7684;hashmap&#x3002;&#x5176;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF08;daemon &#xFF09;&#x662F;&#x7528;C&#x5199;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x7528;&#x4EFB;&#x4F55;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;memcached&#x534F;&#x8BAE;&#x4E0E;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x3002;</p>
<p>MemCached&#x6700;&#x65E9;&#x662F;&#x7531; Brad Fitzpatrick &#x5728;2003&#x5E74;&#x4E3A;LiveJournal&#x800C;&#x5F00;&#x53D1;&#x7684;&#x7F13;&#x5B58;&#x7A0B;&#x5E8F;&#x3002;&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7684;&#x7248;&#x672C;&#x4E3A;v1.4.22.</p>
<ol>
<li>MemCached&#x7684;&#x7279;&#x70B9;&#xFF1F;</li>
</ol>
<p>&#x534F;&#x8BAE;&#x7B80;&#x5355;&#xFF1A;memcached&#x7684;&#x670D;&#x52A1;&#x5668;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x4FE1;&#x5E76;&#x4E0D;&#x4F7F;&#x7528;&#x590D;&#x6742;&#x7684;MXL&#x7B49;&#x683C;&#x5F0F;&#xFF0C;&#x800C;&#x662F;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;&#x57FA;&#x4E8E;&#x6587;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x3002;</p>
<p>&#x57FA;&#x4E8E;libevent&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#xFF1A;libevent&#x662F;&#x4E2A;&#x7A0B;&#x5E8F;&#x5E93;&#xFF0C;&#x4ED6;&#x5C06;Linux &#x7684;epoll&#x3001;BSD&#x7C7B;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;kqueue&#x7B49;&#x65F6;&#x95F4;&#x5904;&#x7406;&#x529F;&#x80FD;&#x5C01;&#x88C5;&#x6210;&#x7EDF;&#x4E00;&#x7684;&#x63A5;&#x53E3;&#x3002;&#xA0; &#xA0; memcached&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;libevent&#x5E93;&#xFF0C;&#x56E0;&#x6B64;&#x80FD;&#x5728;Linux&#x3001;BSD&#x3001;Solaris&#x7B49;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#x53D1;&#x6325;&#x5176;&#x9AD8;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x5185;&#x7F6E;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF1A;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x91CD;&#x542F;memcached&#xFF0C;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x503C;&#x4E4B;&#x540E;memcached&#x56DE;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x9002;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;</p>
<p>&#x4E0D;&#x4E92;&#x901A;&#x4FE1;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#xFF1A;memcached&#x5C3D;&#x7BA1;&#x662F;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F46;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x529F;&#x80FD;&#x3002;&#x5404;&#x4E2A;memcached&#x4E0D;&#x4F1A;&#x4E92;&#x76F8;&#x901A;&#x4FE1;&#x4EE5;&#x5171;&#x4EAB;&#x4FE1;&#x606F;&#x3002;&#x4ED6;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<ol>
<li>MemCached&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF1F;</li>
</ol>
<p>&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x91CD;&#x542F;memcached&#x3001;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x503C;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x57FA;&#x4E8E;LRU(Least Recently Used)&#x7B97;&#x6CD5;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x4F7F;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;memcached&#x672C;&#x8EAB;&#x662F;&#x4E3A;&#x7F13;&#x5B58;&#x800C;&#x8BBE;&#x8BA1;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x8003;&#x8651;&#x6570;&#x636E;&#x7684;&#x6C38;&#x4E45;&#x6027;&#x95EE;&#x9898;&#x3002;</p>
<ol>
<li>MemCached&#x4E0E;Redis&#x7684;PK&#xFF1F;</li>
</ol>
<p>&#x6BCF;&#x79D2;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x4E0D;&#x662F;&#x74F6;&#x9888;&#xFF1A;Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;&#xFF0C;&#x800C;Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF0C;&#x6240;&#x4EE5;&#x4E8C;&#x8005;&#x6BD4;&#x8F83;&#x8D77;&#x6765;&#xFF0C;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;&#xFF0C;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#x3002;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77;Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;</p>
<p>&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#xFF1A;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x548C;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#x548C;&#x6570;&#x636E;&#x7279;&#x6027;&#x6709;&#x5173;&#x3002;</p>
<p>&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x4E0E;&#x6570;&#x636E;&#x540C;&#x6B65;&#xFF1A;Redis&#x652F;&#x6301;&#xFF0C;MemCached&#x4E0D;&#x652F;&#x6301;&#x3002;</p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;Redis&#x76F8;&#x6BD4;Memcached&#x6765;&#x8BF4;&#xFF0C;&#x62E5;&#x6709;&#x66F4;&#x591A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x652F;&#x6301;&#x66F4;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#x3002;&#x901A;&#x5E38;&#x5728;Memcached&#x91CC;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x62FF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8FDB;&#x884C;&#x7C7B;&#x4F3C;&#x7684;&#x4FEE;&#x6539;&#x518D;set&#x56DE;&#x53BB;&#x3002;&#x8FD9;&#x5927;&#x5927;&#x589E;&#x52A0;&#x4E86;&#x7F51;&#x7EDC;IO&#x7684;&#x6B21;&#x6570;&#x548C;&#x6570;&#x636E;&#x4F53;&#x79EF;&#x3002;&#x5728;Redis&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x7684;&#x64CD;&#x4F5C;&#x901A;&#x5E38;&#x548C;&#x4E00;&#x822C;&#x7684;GET/SET&#x4E00;&#x6837;&#x9AD8;&#x6548;&#x3002;</p>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2015-04/115642.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-04/115642.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2737507/" title="Linux下安装MemCached笔记 -" itemprop="url">Linux下安装MemCached笔记 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;</p>
<ol>
<li><p>MemCached&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7248;&#x672C;&#x4E3A;&#xFF1A;1.4.22&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE; <a href="http://memcached.org/" target="_blank" rel="external">&#x5B98;&#x7F51;</a> &#x4E0B;&#x8F7D;&#x5230;&#x3002; </p>
</li>
<li><p>MemCached&#x4F9D;&#x8D56;libevent&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x5B89;&#x88C5;MemCached&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5148;&#x5B89;&#x88C5;libevent&#x3002;</p>
</li>
</ol>
<p>2.1 &#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#xFF0C;&#x67E5;&#x770B;&#x7CFB;&#x7EDF;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;libevent&#x3002;</p>
<p>[root@SecurityCheck ~]# rpm -qa|grep libevent</p>
<p>libevent-headers-1.4.13-4.el6.noarch</p>
<p>libevent-1.4.13-4.el6.x86_64</p>
<p>libevent-doc-1.4.13-4.el6.noarch</p>
<p>libevent-devel-1.4.13-4.el6.x86_64</p>
<p>&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>3.&#xA0; &#x5C06;&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#x7684;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;/opt/favccxx&#xFF0C;&#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x89E3;&#x538B;&#x3002;</p>
<p>[root@SecurityCheck favccxx]# tar -zxvf memcached-1.4.22.tar.gz</p>
<ol>
<li><p>&#x8FD0;&#x884C; [root@SecurityCheck favccxx]# cd memcached-1.4.22 ,&#x5207;&#x6362;&#x5230;memcached&#x76EE;&#x5F55;&#x4E0B;&#x3002;</p>
</li>
<li><p>&#x8FD0;&#x884C; [root@SecurityCheck memcached-1.4.22]# ./configure &amp;&amp; make &amp;&amp; make test &amp;&amp; sudo make install &#xFF0C;&#x4E00;&#x952E;&#x5B8C;&#x6210;&#x5B89;&#x88C5;&#x3002;</p>
</li>
<li><p>&#x8FD0;&#x884C;root@SecurityCheck bin]# ./memcached -u root&#xFF0C; &#x542F;&#x52A8;MemCached&#x3002;MemCached&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x7AEF;&#x53E3;&#x4E3A;&#xFF1A;11211&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;[root@SecurityCheck bin]# ./memcached -p 12306 -u root&#xFF0C;&#x66F4;&#x6539;&#x9ED8;&#x8BA4;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x542F;&#x52A8;&#x3002;&#x5982;&#x679C;&#x60F3;&#x8981;&#x5728;&#x5173;&#x95ED;&#x7A97;&#x53E3;&#x7684;&#x60C5;&#x51B5;&#x4E0B;memcache&#x8FDB;&#x7A0B;&#x4ECD;&#x7136;&#x8FD0;&#x884C;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x547D;&#x4EE4;&#x540E;&#x9762;&#x52A0;&#x4E0A; -d&#xFF0C;&#x8868;&#x793A;&#x4EE5;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x3002;</p>
</li>
<li><p>MemCached&#x7684;&#x5E38;&#x7528;&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;[root@SecurityCheck bin]# ./memcached&#xA0; -h &#x67E5;&#x770B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E9B;&#x5E38;&#x7528;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
</li>
</ol>
<p>-d &#xFF1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;</p>
<p>-m&#xFF1A;&#x5206;&#x914D;&#x7ED9;Memcache&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x6570;&#x91CF;&#xFF0C;&#x5355;&#x4F4D;&#x662F;MB&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;64MB&#xFF0C;</p>
<p>-u &#xFF1A;&#x8FD0;&#x884C;Memcache&#x7684;&#x7528;&#x6237;</p>
<p>-l&#xA0; &#xFF1A;&#x76D1;&#x542C;&#x7684;&#x670D;&#x52A1;&#x5668;IP&#x5730;&#x5740;</p>
<p>-p &#xFF1A;&#x8BBE;&#x7F6E;Memcache&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;11211&#xA0; &#xA0; &#x6CE8;&#xFF1A;-p&#xFF08;p&#x4E3A;&#x5C0F;&#x5199;&#xFF09;</p>
<p>-c &#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x5E76;&#x53D1;&#x8FDE;&#x63A5;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1024</p>
<ol>
<li>&#x81F3;&#x6B64;&#xFF0C;MemCached&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x53EF;&#x4EE5;&#x4F53;&#x9A8C;MemCached&#x4E86;&#x3002;</li>
</ol>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2015-04/115643.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-04/115643.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23ed2e8/" title="Linux c 开发 - Memcached源码分析之LRU算法（6） -" itemprop="url">Linux c 开发 - Memcached源码分析之LRU算法（6） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:38.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x524D;&#x8A00;</p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#xFF08;5&#xFF09; &#x300B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8BB2;&#x5230;&#x4E86;SET&#x547D;&#x4EE4;&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x5411;Memcached&#x670D;&#x52A1;&#x7AEF;SET&#x4E00;&#x6761;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5C06;&#x751F;&#x6210;&#x7684;Item&#x5730;&#x5740;&#x6302;&#x5230;LRU&#x7684;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x4E0A;&#x3002;&#x8FD9;&#x4E00;&#x7AE0;&#x8282;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x8BB2;&#x4E00;&#x4E0B;Memcached&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528;LRU&#x7B97;&#x6CD5;&#x7684;&#x3002;</p>
<p>LRU&#xFF1A;&#x662F;Least Recently Used &#x8FD1;&#x671F;&#x6700;&#x5C11;&#x4F7F;&#x7528;&#x7B97;&#x6CD5;&#x3002;</p>
<p>Memcached&#x7684;LRU&#x7B97;&#x6CD5;&#x5206;&#x6790;</p>
<p>Memcached&#x7684;LRU&#x51E0;&#x79CD;&#x7B56;&#x7565;</p>
<ol>
<li><p>&#x60F0;&#x6027;&#x5220;&#x9664;&#x3002;memcached&#x4E00;&#x822C;&#x4E0D;&#x4F1A;&#x4E3B;&#x52A8;&#x53BB;&#x6E05;&#x9664;&#x5DF2;&#x7ECF;&#x8FC7;&#x671F;&#x6216;&#x8005;&#x5931;&#x6548;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x5F53;get&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;item&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;item&#x662F;&#x5426;&#x5931;&#x6548;&#x3002;</p>
</li>
<li><p>flush&#x547D;&#x4EE4;&#x3002;flush&#x547D;&#x4EE4;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x7684;item&#x8BBE;&#x7F6E;&#x4E3A;&#x5931;&#x6548;&#x3002;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x68C0;&#x67E5;&#x3002;Memcached&#x4F1A;&#x5728;&#x521B;&#x5EFA;ITEM&#x7684;&#x65F6;&#x5019;&#x53BB;LRU&#x7684;&#x94FE;&#x8868;&#x5C3E;&#x90E8;&#x5F00;&#x59CB;&#x68C0;&#x67E5;&#xFF0C;&#x662F;&#x5426;&#x6709;&#x5931;&#x6548;&#x7684;ITEM&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7684;&#x8BDD;&#x5C31;&#x91CD;&#x65B0;&#x521B;&#x5EFA;&#x3002;</p>
</li>
<li><p>LRU&#x722C;&#x866B;&#x3002;memcached&#x9ED8;&#x8BA4;&#x662F;&#x5173;&#x95ED;LRU&#x722C;&#x866B;&#x7684;&#x3002;LRU&#x722C;&#x866B;&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x4F1A;&#x53BB;&#x6E05;&#x7406;&#x5931;&#x6548;&#x7684;ITEM&#x3002;</p>
</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/23e8257.jpg" alt=""></p>
<p>LRU&#x7684;&#x57FA;&#x672C;&#x64CD;&#x4F5C;&#x548C;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<p>Mecached&#x7684;LRU&#x7684;&#x94FE;&#x8868;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x5728;item.c&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E0A;&#x7684;&#x3002;&#x5176;&#x4E2D;&#x6570;&#x7EC4;heads&#x548C;tails&#x5206;&#x522B;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x7684;LRU&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x5934;&#x5730;&#x5740;&#x548C;&#x5C3E;&#x90E8;&#x5730;&#x5740;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;slabs class&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x3002;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x901A;&#x8FC7;item&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x4E24;&#x4E2A;&#x6307;&#x9488;&#x5730;&#x5740;&#x6765;&#x8BB0;&#x5F55;item&#x5728;&#x94FE;&#x8868;&#x4E0A;&#x5DE6;&#x53F3;&#x4E24;&#x8FB9;&#x4F4D;&#x7F6E;&#x7684;item&#x5730;&#x5740;&#x503C;&#x3002;</p>
<pre><code>//item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
typedef struct _stritem {  
    //&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x53CC</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *next;  //&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x53CC</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *prev;  //&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //....more code  
} item;


static item *heads[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
static item *tails[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;
</code></pre><p>item_link_q&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x4E00;&#x4E2A;item&#x6DFB;&#x52A0;&#x5230;LRU&#x94FE;&#x8868;&#x4E0A;&#x9762;&#xFF1A;</p>
<pre><code>//&amp;<span class="comment">#x4ECE;LRU&amp;#x94FE;&amp;#x8868;&amp;#x4E0A;&amp;#x65B0;&amp;#x589E;&amp;#x4E00;&amp;#x4E2A;Item  </span>
//LRU&amp;<span class="comment">#x94FE;&amp;#x8868;&amp;#x662F;&amp;#x4E00;&amp;#x4E2A;&amp;#x53CC;&amp;#x5411;&amp;#x94FE;&amp;#x8868;&amp;#x7ED3;&amp;#x6784;  </span>
static void item_link_<span class="string">q(item *it)</span> { <span class="regexp">/* item is the new head */</span>  
    item **head, **tail;  
    assert(it-&amp;<span class="keyword">gt</span>;slabs_clsid &amp;<span class="keyword">lt</span>; LARGEST_ID);  
    assert((it-&amp;<span class="keyword">gt</span>;it_flags &amp;amp; ITEM_SLABBED) == <span class="number">0</span>);  

    head = &amp;amp;heads[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    tail = &amp;amp;tails[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    assert(it != *head);  
    assert((*head &amp;amp;&amp;amp; *tail) || (*head == <span class="number">0</span> &amp;amp;&amp;amp; *tail == <span class="number">0</span>));  
    it-&amp;<span class="keyword">gt</span>;prev = <span class="number">0</span>;  
    it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> = *head;  
    <span class="keyword">if</span> (it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>) it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>-&amp;<span class="keyword">gt</span>;prev = it;  
    *head = it;  
    <span class="keyword">if</span> (*tail == <span class="number">0</span>) *tail = it;  
    sizes[it-&amp;<span class="keyword">gt</span>;slabs_clsid]++;  
    <span class="keyword">return</span>;  
}
</code></pre><p>item_unlink_q&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x4E00;&#x4E2A;item&#x4ECE;LRU&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x89E3;&#x9664;&#xFF1A;</p>
<pre><code>//&amp;<span class="comment">#x4ECE;LRU&amp;#x94FE;&amp;#x8868;&amp;#x4E0A;&amp;#x89E3;&amp;#x9664;Item  </span>
static void item_unlink_<span class="string">q(item *it)</span> {  
    item **head, **tail;  
    assert(it-&amp;<span class="keyword">gt</span>;slabs_clsid &amp;<span class="keyword">lt</span>; LARGEST_ID);  
    head = &amp;amp;heads[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    tail = &amp;amp;tails[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    <span class="keyword">if</span> (*head == it) {  
        assert(it-&amp;<span class="keyword">gt</span>;prev == <span class="number">0</span>);  
        *head = it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>;  
    }  
    <span class="keyword">if</span> (*tail == it) {  
        assert(it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> == <span class="number">0</span>);  
        *tail = it-&amp;<span class="keyword">gt</span>;prev;  
    }  
    assert(it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> != it);  
    assert(it-&amp;<span class="keyword">gt</span>;prev != it);  
    <span class="keyword">if</span> (it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>) it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>-&amp;<span class="keyword">gt</span>;prev = it-&amp;<span class="keyword">gt</span>;prev;  
    <span class="keyword">if</span> (it-&amp;<span class="keyword">gt</span>;prev) it-&amp;<span class="keyword">gt</span>;prev-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> = it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>;  
    sizes[it-&amp;<span class="keyword">gt</span>;slabs_clsid]--;  
    <span class="keyword">return</span>;  
}
</code></pre><p>&#x7B56;&#x7565;1 - &#x60F0;&#x6027;&#x5220;&#x9664;</p>
<p>Memcached&#x7684;&#x7F13;&#x5B58;&#x6E05;&#x9664;&#x7B56;&#x7565;&#x662F;&#x60F0;&#x6027;&#x7684;&#x3002;&#x8FD9;&#x4E2A;&#x5982;&#x4F55;&#x6765;&#x7406;&#x89E3;&#xFF1F;&#x5F53;&#x7528;&#x6237;&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x7F13;&#x5B58;&#x6709;&#x6548;&#x671F;&#x4E3A;5&#x5206;&#x949F;&#x3002;&#x5F53;5&#x5206;&#x949F;&#x65F6;&#x95F4;&#x8FC7;&#x540E;&#xFF0C;&#x7F13;&#x5B58;&#x5931;&#x6548;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;Memcached&#x5E76;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x53BB;&#x68C0;&#x67E5;&#x5F53;&#x524D;&#x7684;Item&#x662F;&#x5426;&#x8FC7;&#x671F;&#x3002;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x518D;&#x6B21;&#x6765;&#x8BF7;&#x6C42;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;&#x7F13;&#x5B58;&#x662F;&#x5426;&#x5931;&#x6548;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x5931;&#x6548;&#x5219;&#x4F1A;&#x53BB;&#x6E05;&#x9664;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x3002;</p>
<p>&#x770B;&#x4E00;&#x4E0B;do_item_get&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5224;&#x65AD;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x662F;&#x5426;&#x5931;&#x6548;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code>/** wrapper around assoc_find which does the lazy expiration logic */  
item *do_item_get(const char *key, const size_t nkey, const uint32_t hv) {  
//...code  
    if (it != <span class="class">NULL</span>) {  
        //settings.oldest_live&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
        //it-&amp;gt;time&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;item&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;set/add/replce&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF08</span>;get&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#xFF09</span>;  
        //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;time&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x8BE5</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;  
        if (settings.oldest_live != <span class="number">0</span> &amp;amp;&amp;amp; settings.oldest_live &amp;lt;= current_time &amp;amp;&amp;amp;  
            it-&amp;gt;time &amp;lt;= settings.oldest_live) {  
            //<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x7ED1</span>;&amp;<span class="symbol">#x5B9A</span>;  
            do_item_unlink(it, hv);  
            //&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8BE5</span>;<span class="class">Item</span>  
            do_item_remove(it);  
            it = <span class="class">NULL</span>; //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NULL</span>  
            if (was_found) {  
                fprintf(stderr, &amp;quot; -nuked by flush&amp;quot;);  
            }  
        //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6E05</span>;&amp;<span class="symbol">#x9664</span>;  
        } else if (it-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; it-&amp;gt;exptime &amp;lt;= current_time) {  
            //<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x7ED1</span>;&amp;<span class="symbol">#x5B9A</span>;  
            do_item_unlink(it, hv);  
            //&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8BE5</span>;<span class="class">Item</span>  
            do_item_remove(it);  
            it = <span class="class">NULL</span>;  
            if (was_found) {  
                fprintf(stderr, &amp;quot; -nuked by expire&amp;quot;);  
            }  
        } else {  
            it-&amp;gt;it_flags |= <span class="class">ITEM_FETCHED</span>;  
            <span class="class">DEBUG_REFCNT</span>(it, &amp;apos;+&amp;apos;);  
        }  
    }  
//...code  
}
</code></pre><p>&#x7B56;&#x7565;2 - flush&#x547D;&#x4EE4;</p>
<p>&#x5F53;&#x7528;&#x6237;&#x53D1;&#x9001;&#x4E00;&#x4E2A;flush&#x547D;&#x4EE4;&#x7684;&#x65F6;&#x5019;&#xFF0C;Memcached&#x4F1A;&#x5C06;&#x547D;&#x4EE4;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x7684;&#x7F13;&#x5B58;&#x90FD;&#x8BBE;&#x7F6E;&#x4E3A;&#x5931;&#x6548;&#x3002;</p>
<p>Memcached&#x4E0D;&#x4F1A;&#x4E3B;&#x52A8;&#x53BB;&#x6E05;&#x9664;&#x8FD9;&#x4E9B;item&#x3002;&#x4E3B;&#x8981;&#x901A;&#x8FC7;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ol>
<li>do_item_flush_expired&#x65B9;&#x6CD5;&#x3002;</li>
</ol>
<p>Memcached&#x4F1A;&#x5728;&#x63A5;&#x53D7;&#x5230;flush&#x547D;&#x4EE4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C06;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x53C2;&#x6570;settings.oldest_live =current_time - 1&#x3002;&#x7136;&#x540E;&#x53BB;&#x8C03;&#x7528;item_flush_expired&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x56E0;&#x4E3A;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x53C2;&#x6570;item_flush_expired&#x5230;&#x8C03;&#x7528;&#x7F13;&#x5B58;&#x9501;&#x65B9;&#x6CD5;&#x4E4B;&#x95F4;&#x4F1A;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x5DEE;&#xFF0C;&#x6709;&#x53EF;&#x80FD;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F1A;&#x6709;&#x65B0;&#x7684;item&#x5728;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x7136;&#x540E;Memcached&#x8C03;&#x7528;do_item_flush_expired&#x65B9;&#x6CD5;&#xFF0C;&#x53BB;&#x904D;&#x5386;&#x6240;&#x6709;&#x7684;LRU&#x94FE;&#x8868;&#x3002;do_item_flush_expired&#x4E0D;&#x4F1A;&#x5C06;&#x6BCF;&#x4E00;&#x4E2A;&#x5728;flush&#x547D;&#x4EE4;&#x524D;&#x7684;Item&#x5220;&#x9664;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x6837;&#x4F1A;&#x975E;&#x5E38;&#x8017;&#x65F6;&#xFF0C;&#x800C;&#x662F;&#x5220;&#x9664;&#x5728;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x5230;&#x52A0;&#x4E0A;&#x7F13;&#x5B58;&#x9501;&#x8FD9;&#x4E4B;&#x95F4;&#x64CD;&#x4F5C;&#x7684;item&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x52A0;&#x5FEB;flush&#x7684;&#x901F;&#x5EA6;&#x3002;</p>
<ol>
<li>&#x60F0;&#x6027;&#x5220;&#x9664;&#x65B9;&#x6CD5;&#x3002;</li>
</ol>
<p>Memcached&#x4F1A;&#x5728;get&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x53BB;&#x5224;&#x65AD;it-&gt;time&#x662F;&#x5426;&#x5C0F;&#x4E8E;settings.oldest_live&#xFF0C;&#x5982;&#x679C;&#x5C0F;&#x4E8E;&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;item&#x5C31;&#x662F;&#x8FC7;&#x671F;&#x7684;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x60F0;&#x6027;&#x5220;&#x9664;&#x5927;&#x6279;&#x91CF;&#x7684;item&#x6570;&#x636E;&#x3002;</p>
<pre><code><span class="xml">/* 
 * Flushes expired items after a flush_all call 
 */  
void item_flush_expired() </span><span class="expression">{  
    <span class="variable">mutex</span>_<span class="variable">lock</span>(&amp;<span class="variable">amp</span>;<span class="variable">cache</span>_<span class="variable">lock</span>);  
    <span class="variable">do</span>_<span class="variable">item</span>_<span class="variable">flush</span>_<span class="variable">expired</span>();  
    <span class="variable">mutex</span>_<span class="variable">unlock</span>(&amp;<span class="variable">amp</span>;<span class="variable">cache</span>_<span class="variable">lock</span>);  
}</span><span class="xml">


/* expires items that are more recent than the oldest_live setting. */  
void do_item_flush_expired(void) </span><span class="expression">{  
    <span class="variable">int</span> <span class="variable">i</span>;  
    <span class="variable">item</span> *<span class="variable">iter</span>, *<span class="variable">next</span>;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.oldest</span>_<span class="variable">live</span> == 0)  
        <span class="variable">return</span>;  
    <span class="variable">for</span> (<span class="variable">i</span> = 0; <span class="variable">i</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">LARGEST</span>_<span class="variable">ID</span>; <span class="variable">i</span>++) {  
        /* <span class="variable">The</span> <span class="variable">LRU</span> <span class="variable">is</span> <span class="variable">sorted</span> <span class="variable">in</span> <span class="variable">decreasing</span> <span class="variable">time</span> <span class="variable">order</span>, <span class="variable">and</span> <span class="variable">an</span> <span class="variable">item</span>&amp;<span class="variable">apos</span>;<span class="variable">s</span> <span class="variable">timestamp</span> 
         * <span class="variable">is</span> <span class="variable">never</span> <span class="variable">newer</span> <span class="variable">than</span> <span class="variable">its</span> <span class="variable">last</span> <span class="variable">access</span> <span class="variable">time</span>, <span class="variable">so</span> <span class="variable">we</span> <span class="variable">only</span> <span class="variable">need</span> <span class="variable">to</span> <span class="variable">walk</span> 
         * <span class="variable">back</span> <span class="variable">until</span> <span class="variable">we</span> <span class="variable">hit</span> <span class="variable">an</span> <span class="variable">item</span> <span class="variable">older</span> <span class="variable">than</span> <span class="variable">the</span> <span class="variable">oldest</span>_<span class="variable">live</span> <span class="variable">time.</span> 
         * <span class="variable">The</span> <span class="variable">oldest</span>_<span class="variable">live</span> <span class="variable">checking</span> <span class="variable">will</span> <span class="variable">auto-expire</span> <span class="variable">the</span> <span class="variable">remaining</span> <span class="variable">items.</span> 
         *<span class="end-block">/  </span>
        <span class="variable">for</span> (<span class="variable">iter</span> = <span class="variable">heads</span>[<span class="variable">i</span>]; <span class="variable">iter</span> != <span class="variable">NULL</span>; <span class="variable">iter</span> = <span class="variable">next</span>) {  
            /* <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> <span class="variable">of</span> 0 <span class="variable">are</span> <span class="variable">magic</span> <span class="variable">objects.</span> *<span class="end-block">/  </span>
            /<span class="end-block">/iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>1;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;  
            //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">settings.oldest</span>_<span class="variable">live</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">F</span>;  
            //&amp;<span class="begin-block">#x</span>56<span class="variable">E</span>0;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">do</span>_<span class="variable">item</span>_<span class="variable">flush</span>_<span class="variable">expired</span>&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>2;&amp;<span class="begin-block">#x</span>7<span class="variable">ECF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;<span class="variable">cache</span>&amp;<span class="begin-block">#x</span>9501;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;<span class="variable">worker</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7684;  
            //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>904<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5386;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">Item</span>&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">BB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>904<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5386;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>975<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>38;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>13;&amp;<span class="begin-block">#x</span>6162;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">BFC</span>;&amp;<span class="begin-block">#x</span>81<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>5<span class="variable">BA</span>2;&amp;<span class="begin-block">#x</span>6237;&amp;<span class="begin-block">#x</span>7<span class="variable">AEF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>85;&amp;<span class="begin-block">#x</span>3002;  
            /<span class="end-block">/  </span>
            /<span class="end-block">/Memcached</span>&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>60<span class="variable">F</span>3;&amp;<span class="begin-block">#x</span>51<span class="variable">FA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>806<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>660<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>529<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;<span class="variable">settings.oldest</span>_<span class="variable">live</span>&amp;<span class="begin-block">#x</span>5230;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9501;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>4<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>8;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;&amp;<span class="begin-block">#x</span>5<span class="variable">BA</span>2;&amp;<span class="begin-block">#x</span>6237;&amp;<span class="begin-block">#x</span>7<span class="variable">AEF</span>;  
            //&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;<span class="variable">Memcache</span>&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>90<span class="variable">E</span>8;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5148;&amp;<span class="begin-block">#x</span>6<span class="variable">E</span>05;&amp;<span class="begin-block">#x</span>7406;&amp;<span class="begin-block">#xFF</span>08;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>90<span class="variable">E</span>8;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>975<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>38;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>11;&amp;<span class="begin-block">#x</span>91<span class="variable">CF</span>;&amp;<span class="begin-block">#xFF</span>09;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>6837;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">FEB</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>901<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;  
            //&amp;<span class="begin-block">#x</span>800<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5269;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>59;<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">settings.oldest</span>_<span class="variable">live</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>6279;&amp;<span class="begin-block">#x</span>91<span class="variable">CF</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>60<span class="variable">F</span>0;&amp;<span class="begin-block">#x</span>6027;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>0<span class="variable">F</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5728;<span class="variable">get</span>&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>42;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">BB</span>;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;  
            <span class="variable"><span class="keyword">if</span></span> (<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> != 0 &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">settings.oldest</span>_<span class="variable">live</span>) {  
                <span class="variable">next</span> = <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>;  
                <span class="variable"><span class="keyword">if</span></span> ((<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> &amp;<span class="variable">amp</span>; <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>) == 0) {  
                    <span class="variable">do</span>_<span class="variable">item</span>_<span class="variable">unlink</span>_<span class="variable">nolock</span>(<span class="variable">iter</span>, <span class="variable">hash</span>(<span class="variable">ITEM</span>_<span class="variable">key</span>(<span class="variable">iter</span>), <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">nkey</span>));  
                }</span><span class="xml">  
            } else </span><span class="expression">{  
                /* <span class="variable">We</span>&amp;<span class="variable">apos</span>;<span class="variable">ve</span> <span class="variable">hit</span> <span class="variable">the</span> <span class="variable">first</span> <span class="variable">old</span> <span class="variable">item.</span> <span class="variable">Continue</span> <span class="variable">to</span> <span class="variable">the</span> <span class="variable">next</span> <span class="variable">queue.</span> *<span class="end-block">/  </span>
                <span class="variable">break</span>;  
            }</span><span class="xml">  
        }  
    }  
}</span>
</code></pre><p>&#x7B56;&#x7565;3 - &#x5206;&#x914D;Item&#x7684;&#x65F6;&#x5019;&#x53BB;&#x68C0;&#x67E5;</p>
<p>Memcached&#x5728;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Item&#x3002;&#xFF08;&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x6709;&#x70B9;&#x7ED5;&#xFF0C;&#x9700;&#x8981;&#x770B;N&#x904D;&#xFF0C;&#x624D;&#x80FD;&#x660E;&#x767D;&#xFF09;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x5148;&#x68C0;&#x67E5;&#x7F13;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x3002;&#x524D;&#x51E0;&#x7AE0;&#x6211;&#x4EEC;&#x8BB2;&#x5230;&#xFF0C;memcached&#x7684;&#x547D;&#x4EE4;&#x4E2D;&#x4F1A;&#x5C06;key&#x7684;&#x957F;&#x5EA6;&#x548C;value&#x7684;&#x957F;&#x5EA6;&#x5E26;&#x4E0A;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x8BA1;&#x7B97;&#x51FA;item&#x603B;&#x7684;&#x5360;&#x7528;&#x7A7A;&#x95F4;&#x7684;&#x5927;&#x5C0F;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;&#x7F13;&#x5B58;item&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x627E;&#x5230;slabs class&#x548C;slabs class&#x7684;LRU&#x53CC;&#x5411;&#x94FE;&#x8868;&#x3002;</p>
</li>
<li><p>&#x5F00;&#x59CB;&#x5C1D;&#x8BD5;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5C1D;&#x8BD5;&#x6B21;&#x6570;&#x4E3A;5&#x6B21;&#x3002;</p>
</li>
<li><p>&#x5C1D;&#x8BD5;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F1A;&#x4ECE;LRU&#x94FE;&#x8868;&#x7684;&#x5C3E;&#x90E8;&#x5F00;&#x59CB;&#x641C;&#x7D22;&#xFF0C;&#x68C0;&#x67E5;ITEM&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;item&#x5185;&#x5BB9;&#x4E3A;&#x7A7A;&#x6216;&#x8005;item&#x88AB;&#x5176;&#x5B83;worker&#x5F15;&#x7528;&#x9501;&#x5B9A;&#x7B49;&#x60C5;&#x51B5;&#xFF0C;&#x5219;&#x7EE7;&#x7EED;&#x5F80;LRU&#x5217;&#x8868;&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x5C1D;&#x8BD5;&#x4E86;5&#x6B21;&#xFF0C;&#x4ECE;LRU&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x90FD;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x7B26;&#xFFFD;&#xFFFD;&#xFFFD;&#x9884;&#x671F;&#x7684;ITEM&#xFF0C;&#x5219;&#x4F1A;slabs_alloc&#x65B9;&#x6CD5;&#xFF0C;&#x7533;&#x8BF7;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5185;&#x5B58;&#x5757;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x4ECE;LRU&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x627E;&#x5230;&#x7B26;&#x5408;&#x9884;&#x671F;&#x7684;ITEM&#xFF08;&#x6CA1;&#x6709;&#x9501;&#x5B9A;&#x548C;&#x6709;&#x6570;&#x636E;&#xFF09;&#xFF0C;&#x9996;&#x5148;&#x4F1A;&#x68C0;&#x67E5;ITEM&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8FC7;&#x4E86;&#x6709;&#x6548;&#x671F;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x8FC7;&#x4E86;&#x6709;&#x6548;&#x671F;&#xFF0C;&#x5219;&#x5C06;&#x8FD9;&#x4E2A;ITEM&#x6DD8;&#x6C70;&#xFF0C;&#x5360;&#x7528;&#x8BE5;ITEM&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;ITEM&#x8FD8;&#x662F;&#x6709;&#x6548;&#x7684;&#xFF0C;&#x5219;&#x4F7F;&#x7528;slabs_alloc&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;ITEM&#xFF0C;&#x5206;&#x914D;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x5C31;&#x7528;&#x6700;&#x65B0;&#x5206;&#x914D;&#x7684;ITEM</p>
</li>
<li><p>&#x5982;&#x679C;&#x4F7F;&#x7528;slabs_alloc&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;ITEM&#xFF0C;&#x5206;&#x914D;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x5F00;&#x542F;&#x4E86;&#x4E0D;&#x4F7F;&#x7528;LRU&#x5F3A;&#x5236;&#x6DD8;&#x6C70;&#xFF0C;&#x8FD4;&#x56DE;ERROR&#xFF1B;&#x5982;&#x679C;&#x5F00;&#x542F;&#x4E86;&#x5F3A;&#x5236;&#x6DD8;&#x6C70;&#xFF0C;&#x4F1A;&#x5C06;&#x5F53;&#x524D;LRU&#x94FE;&#x8868;&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x5230;&#x7684;ITEM&#x5F3A;&#x5236;&#x8FDB;&#x884C;&#x6DD8;&#x6C70;&#xFF08;&#x5982;&#x679C;ITEM&#x6709;&#x6548;&#x671F;&#x8FD8;&#x5728;&#x6216;&#x8005;&#x8BBE;&#x7F6E;&#x4E86;&#x6C38;&#x4E45;&#x7684;&#x4E5F;&#x4F1A;&#x88AB;&#x6DD8;&#x6C70;&#xFF09;</p>
<p> //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Item<br> item <em>do_item_alloc(char </em>key, const size_t nkey, const int flags,  </p>
<pre><code>                const rel_time_t exptime, const int nbytes,  
                const uint32_t cur_hv) {  
uint8_t nsuffix;  
item *it = <span class="class">NULL</span>; //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
char suffix[<span class="number">40</span>];  
//item_make_header &amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
size_t ntotal = item_make_header(nkey + <span class="number">1</span>, flags, nbytes, suffix, &amp;amp;nsuffix);  
if (settings.use_cas) {  
    ntotal += sizeof(uint64_t);  
}  
//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;ntotal &amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
//<span class="class">Memcached</span>&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class  
//&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#xFF0C</span>;slabs&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabs&amp;<span class="symbol">#x4E0A</span>;  
//&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;chunk  
//  
//&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#xFF1A</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>; &amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">200</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;slabs_class&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;item&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
//&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;slabs&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;chunk&amp;<span class="symbol">#x5757</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;chunk&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
unsigned int id = slabs_clsid(ntotal);  
if (id == <span class="number">0</span>)  
    return <span class="number">0</span>;  
mutex_lock(&amp;amp;cache_lock);  
/* do a quick check if we have any expired items in the tail.. */  
int tries = <span class="number">5</span>;  
/* <span class="class">Avoid</span> hangs if a slab has nothing but refcounted stuff in it. */  
int tries_lrutail_reflocked = <span class="number">1000</span>;  
int tried_alloc = <span class="number">0</span>;  
item *search;  
item *next_it;  
void *hold_lock = <span class="class">NULL</span>;  
rel_time_t oldest_live = settings.oldest_live;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
//item&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5BFB</span>;&amp;<span class="symbol">#x627E</span>;<span class="class">LRU</span> &amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
search = tails[id];  
/* <span class="class">We</span> walk up *only* for locked items. <span class="class">Never</span> searching for expired. 
 * <span class="class">Waste</span> of <span class="class">CPU</span> for almost all deployments */  
//tries = <span class="number">5</span> &amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x5C1D</span>;&amp;<span class="symbol">#x8BD5</span>;<span class="number">5</span>&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x641C</span>;&amp;<span class="symbol">#x7D22</span>;  
//search = tails[id] &amp;<span class="symbol">#x641C</span>;&amp;<span class="symbol">#x7D22</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>; &amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;  
for (; tries &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; search != <span class="class">NULL</span>; tries--, search=next_it) {  
    /* we might relink search mid-loop, so search-&amp;gt;prev isn&amp;apos;t reliable */  
    next_it = search-&amp;gt;prev;  
    if (search-&amp;gt;nbytes == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;nkey == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;it_flags == <span class="number">1</span>) {  
        /* <span class="class">We</span> are a crawler, ignore it. */  
        tries++;  
        continue;  
    }  
    uint32_t hv = hash(<span class="class">ITEM_key</span>(search), search-&amp;gt;nkey);  
    /* <span class="class">Attempt</span> to hash item lock the &amp;quot;search&amp;quot; item. <span class="class">If</span> locked, no 
     * other callers can incr the refcount 
     */  
    /* <span class="class">Don</span>&amp;apos;t accidentally grab ourselves, or bail if we can&amp;apos;t quicklock */  
    if (hv == cur_hv || (hold_lock = item_trylock(hv)) == <span class="class">NULL</span>)  
        continue;  
    /* <span class="class">Now</span> see if the item is refcount locked */  
    //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;search-&amp;gt;refcount&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E86</span>;refcount&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;item&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x5B83</span>;&amp;<span class="symbol">#x7684</span>;worker&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;  
    //refcount&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x52A0</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;  
    if (refcount_incr(&amp;amp;search-&amp;gt;refcount) != <span class="number">2</span>) {  
        /* <span class="class">Avoid</span> pathological case with ref&amp;apos;ed items in tail */  
        do_item_update_nolock(search);  
        tries_lrutail_reflocked--;  
        tries++; //try&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;+<span class="number">1</span>  
        refcount_decr(&amp;amp;search-&amp;gt;refcount); //&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>  
        itemstats[id].lrutail_reflocked++;  
        /* <span class="class">Old</span> rare bug could cause a refcount leak. <span class="class">We</span> haven&amp;apos;t seen 
         * it in years, but we leave this code in to prevent failures 
         * just in case */  
        if (settings.tail_repair_time &amp;amp;&amp;amp;  
                search-&amp;gt;time + settings.tail_repair_time &amp;lt; current_time) {  
            itemstats[id].tailrepairs++;  
            search-&amp;gt;refcount = <span class="number">1</span>;  
            do_item_unlink_nolock(search, hv);  
        }  
        if (hold_lock)  
            item_trylock_unlock(hold_lock);  
        if (tries_lrutail_reflocked &amp;lt; <span class="number">1</span>)  
            break;  
        continue;  
    }  
    /* <span class="class">Expired</span> or flushed */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;  
    if ((search-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;exptime &amp;lt; current_time)  
        || (search-&amp;gt;time &amp;lt;= oldest_live &amp;amp;&amp;amp; oldest_live &amp;lt;= current_time)) {  
        itemstats[id].reclaimed++;  
        if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
            itemstats[id].expired_unfetched++;  
        }  
        it = search;  
        slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
        do_item_unlink_nolock(it, hv);  
        /* <span class="class">Iniialize</span> the item <span class="method">block:</span> */  
        it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
    //slabs_alloc&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
    } else if ((it = slabs_alloc(ntotal, id)) == <span class="class">NULL</span>) {  
        tried_alloc = <span class="number">1</span>;  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">ERROR</span>  
        if (settings.evict_to_free == <span class="number">0</span>) {  
            itemstats[id].outofmemory++;  
        } else {  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E86</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;  
            itemstats[id].evicted++;  
            itemstats[id].evicted_time = current_time - search-&amp;gt;time;  
            if (search-&amp;gt;exptime != <span class="number">0</span>)  
                itemstats[id].evicted_nonzero++;  
            if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                itemstats[id].evicted_unfetched++;  
            }  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5C06</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
            it = search;  
            //&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass_t&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
            //&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x9738</span>;&amp;<span class="symbol">#x5360</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;  
            slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
            //&amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x54C8</span>;&amp;<span class="symbol">#x5E0C</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;lru&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
            //it-&amp;gt;refcount&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;item&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">HashTable</span>&amp;<span class="symbol">#x548C</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x7CFB</span>;  
            do_item_unlink_nolock(it, hv);  
            /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
            it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
            /* <span class="class">If</span> we&amp;apos;ve just evicted an item, and the automover is set to 
             * angry bird mode, attempt to rip memory into this slab class. 
             * <span class="class">TODO</span>: <span class="class">Move</span> valid object detection into a function, and on a 
             * &amp;quot;successful&amp;quot; memory pull, look behind and see if the next alloc 
             * would be an eviction. <span class="class">Then</span> kick off the slab mover before the 
             * eviction happens. 
             */  
            if (settings.slab_automove == <span class="number">2</span>)  
                slabs_reassign(-<span class="number">1</span>, id);  
        }  
    }  
    //&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;  
    refcount_decr(&amp;amp;search-&amp;gt;refcount);  
    /* <span class="class">If</span> hash values were equal, we don&amp;apos;t grab a second lock */  
    if (hold_lock)  
        item_trylock_unlock(hold_lock);  
    break;  
}  
/* &amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E86</span>;<span class="number">5</span>&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item */  
if (!tried_alloc &amp;amp;&amp;amp; (tries == <span class="number">0</span> || search == <span class="class">NULL</span>))  
    it = slabs_alloc(ntotal, id);  
if (it == <span class="class">NULL</span>) {  
    itemstats[id].outofmemory++;  
    mutex_unlock(&amp;amp;cache_lock);  
    return <span class="class">NULL</span>;  
}  
assert(it-&amp;gt;slabs_clsid == <span class="number">0</span>);  
assert(it != heads[id]);  
/* <span class="class">Item</span> initialization can happen outside of the lock; the item&amp;apos;s already 
 * been removed from the slab <span class="class">LRU</span>. 
 */  
it-&amp;gt;refcount = <span class="number">1</span>; //&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>; &amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>   /* the caller will have a reference */  
mutex_unlock(&amp;amp;cache_lock);  
it-&amp;gt;next = it-&amp;gt;prev = it-&amp;gt;h_next = <span class="number">0</span>;  
it-&amp;gt;slabs_clsid = id;  
<span class="class">DEBUG_REFCNT</span>(it, &amp;apos;*&amp;apos;);  
it-&amp;gt;it_flags = settings.use_cas ? <span class="class">ITEM_CAS</span> : <span class="number">0</span>;  
it-&amp;gt;nkey = nkey;  
it-&amp;gt;nbytes = nbytes;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;  
memcpy(<span class="class">ITEM_key</span>(it), key, nkey);  
it-&amp;gt;exptime = exptime;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;  
memcpy(<span class="class">ITEM_suffix</span>(it), suffix, (size_t)nsuffix);  
it-&amp;gt;nsuffix = nsuffix;  
return it;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7B56;&#x7565;4 - LRU&#x722C;&#x866B;</p>
<ol>
<li><p>Memcached&#x7684;LRU&#x722C;&#x866B;&#x9ED8;&#x8BA4;&#x662F;&#x5173;&#x95ED;&#x7684;&#x3002;</p>
</li>
<li><p>Memcached&#x4F1A;&#x5F00;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x5BF9;&#x5931;&#x6548;&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;</p>
</li>
<li><p>&#x722C;&#x866B;&#x4EE3;&#x7801;&#x4E3B;&#x8981;&#x5728;item.c&#x4E2D;&#xFF0C;&#x8FD9;&#x8FB9;&#x53EA;&#x770B;&#x4E24;&#x4E2A;&#x6700;&#x91CD;&#x8981;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p> //LRU&#x722C;&#x866B;<br> static void <em>item_crawler_thread(void </em>arg) {  </p>
<pre><code>int i;  
pthread_mutex_lock<span class="params">(&amp;amp;lru_crawler_lock)</span>;  
<span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
    fprintf<span class="params">(stderr, &amp;quot;Starting LRU crawler background thread\n&amp;quot;)</span>;  
while <span class="params">(do_run_lru_crawler_thread)</span> {  
pthread_cond_wait<span class="params">(&amp;amp;lru_crawler_cond, &amp;amp;lru_crawler_lock)</span>;  
while <span class="params">(crawler_count)</span> {  
    item <span class="built_in">*</span><span class="built_in">search</span> = NULL;  
    void <span class="built_in">*</span>hold_lock = NULL;  
    <span class="keyword">for</span> <span class="params">(i = <span class="number">0</span>; i &amp;lt; LARGEST_ID; i++)</span> {  
        <span class="keyword">if</span> <span class="params">(crawlers[i].it_flags != <span class="number">1</span>)</span> {  
            continue;  
        }  
        pthread_mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="built_in">search</span> = crawler_crawl_q<span class="params">(<span class="params">(item *)</span>&amp;amp;crawlers[i])</span>;  
        <span class="keyword">if</span> <span class="params">(search == NULL ||  
            <span class="params">(crawlers[i].remaining &amp;amp;&amp;amp; --crawlers[i].remaining &amp;lt; <span class="number">1</span>)</span>)</span> {  
            <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
                fprintf<span class="params">(stderr, &amp;quot;Nothing left to crawl for %d\n&amp;quot;, i)</span>;  
            crawlers[i].it_flags = <span class="number">0</span>;  
            crawler_count--;  
            crawler_unlink_q<span class="params">(<span class="params">(item *)</span>&amp;amp;crawlers[i])</span>;  
            pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            continue;  
        }  
        uint32_t hv = hash<span class="params">(ITEM_key<span class="params">(search)</span>, search-&amp;gt;nkey)</span>;  
        <span class="comment">/* Attempt to hash item lock the &amp;quot;search&amp;quot; item. If locked, no 
         * other callers can incr the refcount 
         */</span>  
        <span class="keyword">if</span> <span class="params">(<span class="params">(hold_lock = item_trylock<span class="params">(hv)</span>)</span> == NULL)</span> {  
            pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            continue;  
        }  
        <span class="comment">/* Now see if the item is refcount locked */</span>  
        <span class="keyword">if</span> <span class="params">(refcount_incr<span class="params">(&amp;amp;search-&amp;gt;refcount)</span> != <span class="number">2</span>)</span> {  
            refcount_decr<span class="params">(&amp;amp;search-&amp;gt;refcount)</span>;  
            <span class="keyword">if</span> <span class="params">(hold_lock)</span>  
                item_trylock_unlock<span class="params">(hold_lock)</span>;  
            pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            continue;  
        }  
        <span class="comment">/* Frees the item or decrements the refcount. */</span>  
        <span class="comment">/* Interface for this could improve: do the free/decr here 
         * instead? */</span>  
        item_crawler_evaluate<span class="params">(search, hv, i)</span>;  
        <span class="keyword">if</span> <span class="params">(hold_lock)</span>  
            item_trylock_unlock<span class="params">(hold_lock)</span>;  
        pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="keyword">if</span> <span class="params">(settings.lru_crawler_sleep)</span>  
            usleep<span class="params">(settings.lru_crawler_sleep)</span>;  
    }  
}  
<span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
    fprintf<span class="params">(stderr, &amp;quot;LRU crawler thread sleeping\n&amp;quot;)</span>;  
STATS_LOCK<span class="params">()</span>;  
stats.lru_crawler_running = <span class="literal">false</span>;  
STATS_UNLOCK<span class="params">()</span>;  
}  
pthread_mutex_unlock<span class="params">(&amp;amp;lru_crawler_lock)</span>;  
<span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
    fprintf<span class="params">(stderr, &amp;quot;LRU crawler thread stopping\n&amp;quot;)</span>;  
return NULL;  
</code></pre><p> }<br> int start_item_crawler_thread(void) {  </p>
<pre><code>int ret<span class="comment">;  </span>
if <span class="list">(<span class="keyword">settings</span>.lru_crawler)</span>  
    return <span class="number">-1</span><span class="comment">;  </span>
pthread_mutex_lock<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;lru_crawler_lock);  </span>
do_run_lru_crawler_thread = <span class="number">1</span><span class="comment">;  </span>
settings.lru_crawler = true<span class="comment">;  </span>
if <span class="list">(<span class="list">(<span class="keyword">ret</span> = pthread_create<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;item_crawler_tid, NULL,  </span>
    item_crawler_thread, NULL)</span>)</span> != <span class="number">0</span>)</span> {  
    fprintf<span class="list">(<span class="keyword">stderr</span>, <span class="keyword">&amp;quot</span><span class="comment">;Can&amp;apos;t create LRU crawler thread: %s\n&amp;quot;,  </span>
        strerror<span class="list">(<span class="keyword">ret</span>)</span>)</span><span class="comment">;  </span>
    pthread_mutex_unlock<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;lru_crawler_lock);  </span>
    return <span class="number">-1</span><span class="comment">;  </span>
}  
pthread_mutex_unlock<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;lru_crawler_lock);  </span>
return <span class="number">0</span><span class="comment">;  </span></span></span></span>
</code></pre><p> }</p>
</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a><a href="/tags/链表/">链表</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23f2d3d/" title="Linux c 开发 - Memcached源码分析之增删改查操作（5） -" itemprop="url">Linux c 开发 - Memcached源码分析之增删改查操作（5） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:38.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x5728;&#x7B2C;&#x4E8C;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B; &#x548C;&#x7B2C;&#x4E09;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF08;3&#xFF09;&#x300B; &#x4E2D;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x901A;&#x8FC7;Memcached&#x7684;get&#x547D;&#x4EE4;&#xFF0C;&#x5206;&#x6790;&#x4E86;Memcached&#x7684;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x548C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x7684;&#x6A21;&#x5757;&#x529F;&#x80FD;&#x3002;&#x8FD9;&#x4E00;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x6765;&#x8BE6;&#x7EC6;&#x770B;&#x4E00;&#x4E0B;Memcached&#x5E38;&#x7528;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x5728;&#x770B;Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;process_command&#x65B9;&#x6CD5;&#x3002;Memcached&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x901A;&#x8FC7;process_command&#x65B9;&#x6CD5;&#x5C06;&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#x7684;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x5206;&#x53D1;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;rbuf&amp;<span class="symbol">#x4E2D</span>;\n&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x6210</span>;\<span class="number">0</span>  
static void process_command(conn *c, char *command) {  

    //tokens&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#xFF08</span>;command&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x683C</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x9694</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#xFF1A</span>;set username zhuli,&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">3</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x522B</span>;&amp;<span class="symbol">#x662F</span>;set&amp;<span class="symbol">#x548C</span>;username&amp;<span class="symbol">#x548C</span>;zhuli  
    //<span class="class">MAX_TOKENS</span>&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">8</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;memcached&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    token_t tokens[<span class="class">MAX_TOKENS</span>];  
    size_t ntokens;  
    int comm;  

    assert(c != <span class="class">NULL</span>);  

    <span class="class">MEMCACHED_PROCESS_COMMAND_START</span>(c-&amp;gt;sfd, c-&amp;gt;rcurr, c-&amp;gt;rbytes);  

    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;lt;%d %s\n&amp;quot;, c-&amp;gt;sfd, command);  

    /* 
     * for commands set/add/replace, we build an item and read the data 
     * directly into it, then continue in nread_complete(). 
     */  

    c-&amp;gt;msgcurr = <span class="number">0</span>;  
    c-&amp;gt;msgused = <span class="number">0</span>;  
    c-&amp;gt;iovused = <span class="number">0</span>;  
    if (add_msghdr(c) != <span class="number">0</span>) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory preparing response&amp;quot;);  
        return;  
    }  

    //tokenize_command&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;tokens&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;:command&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    ntokens = tokenize_command(command, tokens, <span class="class">MAX_TOKENS</span>);  

    //tokens[<span class="class">COMMAND_TOKEN</span>] <span class="class">COMMAND_TOKEN</span>=<span class="number">0</span>  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;get&amp;quot;) == <span class="number">0</span>)  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;bget&amp;quot;) == <span class="number">0</span>))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;get&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_get_command(c, tokens, ntokens, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">6</span> || ntokens == <span class="number">7</span>)  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;add&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_ADD</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;set&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_SET</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;replace&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_REPLACE</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;prepend&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_PREPEND</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;append&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_APPEND</span>)))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; add/set/replace/prepend/append  
        process_update_command(c, tokens, ntokens, comm, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">7</span> || ntokens == <span class="number">8</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;cas&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_CAS</span>))) {  

        process_update_command(c, tokens, ntokens, comm, <span class="keyword">true</span>);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;incr&amp;quot;) == <span class="number">0</span>)) {  

        process_arithmetic_command(c, tokens, ntokens, <span class="number">1</span>);  

    } else if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;gets&amp;quot;) == <span class="number">0</span>)) {  

        process_get_command(c, tokens, ntokens, <span class="keyword">true</span>);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;decr&amp;quot;) == <span class="number">0</span>)) {  

        process_arithmetic_command(c, tokens, ntokens, <span class="number">0</span>);  

    } else if (ntokens &amp;gt;= <span class="number">3</span> &amp;amp;&amp;amp; ntokens &amp;lt;= <span class="number">5</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;delete&amp;quot;) == <span class="number">0</span>)) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; delete  
        process_delete_command(c, tokens, ntokens);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;touch&amp;quot;) == <span class="number">0</span>)) {  

        process_touch_command(c, tokens, ntokens);  

    } else if (ntokens &amp;gt;= <span class="number">2</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;stats&amp;quot;) == <span class="number">0</span>)) {  

        //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_stat(c, tokens, ntokens);  
//.....more code  
}
</code></pre><p>Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x6E90;&#x7801;&#x5206;&#x6790; </p>
<p>&#x589E;/&#x6539; set add replace &#x64CD;&#x4F5C;</p>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E2A;Memcached&#x7684;&#x547D;&#x4EE4;&#x884C;&#x7684;set&#x64CD;&#x4F5C;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code><span class="built_in">set</span> <span class="built_in">key</span> flags exptime vlen  
<span class="built_in">value</span>
</code></pre><p>set&#xFF1A;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#x540D;&#x79F0;</p>
<p>key&#xFF1A;&#x7F13;&#x5B58;&#x7684;key</p>
<p>flags&#xFF1A;&#x7F13;&#x5B58;&#x6807;&#x8BC6;</p>
<p>exptime&#xFF1A;&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;0 - &#x4E0D;&#x8FC7;&#x671F;</p>
<p>vlen&#xFF1A;&#x7F13;&#x5B58;value&#x7684;&#x957F;&#x5EA6;</p>
<p>value&#xFF1A;&#x7F13;&#x5B58;&#x7684;&#x503C;&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x5728;&#x7B2C;&#x4E8C;&#x884C;&#x3002;</p>
<p>&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code><span class="keyword">set</span> username <span class="number">0</span> <span class="number">10</span> <span class="number">9</span>  
woshishen
</code></pre><p>&#x6211;&#x4EEC;&#x5728;&#x7B2C;&#x4E8C;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B;&#x4E2D;&#x8BB2;&#x89E3;&#x5230;&#x4E86;&#x5982;&#x4F55;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x7684;&#x3002;Memcached&#x4E00;&#x822C;&#x4F1A;&#x901A;&#x8FC7;\n&#x7B26;&#x53F7;&#x53BB;&#x5206;&#x9694;&#x6BCF;&#x4E2A;&#x547D;&#x4EE4;&#x884C;&#x8BED;&#x53E5;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x5C06;&#x4E00;&#x884C;&#x547D;&#x4EE4;&#x5207;&#x5272;&#x6210;N&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x5143;&#x7D20;&#x4F1A;&#x653E;&#x8FDB;&#x4E00;&#x4E2A;tokens&#x7684;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</p>
<p>&#x8FD9;&#x8FB9;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;set&#x547D;&#x4EE4;&#x4F1A;&#x5206;&#x5C42;&#x4E24;&#x90E8;&#x5206;&#xFF1A;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x548C;Value&#x503C;&#x90E8;&#x5206;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x4F1A;&#x5148;&#x53BB;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x4E14;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x4E2D;&#x5E26;&#x4E0A;&#x4E86;vlen&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;value&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x4F1A;&#x53BB;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x653E;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x89E3;&#x6790;&#x5B8C;&#x6BD5;&#xFF0C;Memcached&#x4F1A;&#x53BB;&#x7EE7;&#x7EED;&#x8BFB;&#x53D6;Socket&#x4E2D;&#x7684;&#x5269;&#x4F59;&#x6570;&#x636E;&#x62A5;&#x6587;&#xFF0C;&#x8FB9;&#x8BFB;&#x53D6;&#x8FB9;&#x590D;&#x5236;&#x5230;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E2D;&#xFF0C;&#x76F4;&#x5230;&#x8BFB;&#x53D6;&#x5230;&#x7684;Value&#x6570;&#x636E;&#x957F;&#x5EA6;&#x548C;&#x547D;&#x4EE4;&#x884C;&#x4E2D;&#x7684;vlen&#x957F;&#x5EA6;&#x4E00;&#x81F4;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x7ED3;&#x675F;&#x3002;&#x7136;&#x540E;&#x4F1A;&#x53BB;&#x5B58;&#x50A8;item&#xFF0C;&#x5982;&#x679C;item&#x5B58;&#x50A8;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;item&#x6302;&#x5230;HashTable&#x548C;LRU&#x94FE;&#x4E0A;&#x9762;&#xFF1B;&#x5982;&#x679C;&#x5B58;&#x50A8;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x4F1A;&#x5220;&#x9664;item&#x3002;</p>
</li>
</ol>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;process_update_command&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<p>1.&#xA0; &#x5E2E;&#x52A9;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;</p>
<p>2.&#xA0; &#x5206;&#x914D;&#x4E00;&#x4E2A;Item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x3002;</p>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;&#x72B6;&#x6001;&#x673A;drive_machine&#x4E2D;conn_nread&#x7684;&#x4EE3;&#x7801;&#x5757;&#x3002;conn_nread&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;value&#x6570;&#x636E;&#x3002;</p>
<pre><code>/********************************* 
&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x3001</span>;&amp;<span class="symbol">#x7F16</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>; 
&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;set&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; 

&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>; 
set key flags exptime vlen 
value 

&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;vlen&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>; 
flages &amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>; 
exptime&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="number">0</span> &amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>; 
value &amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;value&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E8C</span>;&amp;<span class="symbol">#x884C</span>; 

&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>; 
set username <span class="number">0</span> <span class="number">10</span> <span class="number">9</span> 
woshishen 
**************************************/  
static void process_update_command(conn *c, token_t *tokens,  
        const size_t ntokens, int comm, bool handle_cas) {  
    char *key; //key  
    size_t nkey; //key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    unsigned int flags; //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;  
    int32_t exptime_int = <span class="number">0</span>;  
    time_t exptime; //&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;  
    int vlen; //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    uint64_t req_cas_id = <span class="number">0</span>;  
    //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;key/value&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabclass&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;  
    item *it;  

    assert(c != <span class="class">NULL</span>);  

    set_noreply_maybe(c, tokens, ntokens);  
    //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>; key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;<span class="number">250</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;  
    if (tokens[<span class="class">KEY_TOKEN</span>].length &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x548C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //tokens[<span class="number">0</span>]&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    key = tokens[<span class="class">KEY_TOKEN</span>].value; //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
    nkey = tokens[<span class="class">KEY_TOKEN</span>].length; //key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  

    //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6027</span>;  
    if (!(safe_strtoul(tokens[<span class="number">2</span>].value, (uint32_t *) &amp;amp;flags)  
            &amp;amp;&amp;amp; safe_strtol(tokens[<span class="number">3</span>].value, &amp;amp;exptime_int)  
            &amp;amp;&amp;amp; safe_strtol(tokens[<span class="number">4</span>].value, (int32_t *) &amp;amp;vlen))) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    /* <span class="class">Ubuntu</span> <span class="number">8.04</span> breaks when <span class="class">I</span> pass exptime to safe_strtol */  
    exptime = exptime_int;  

    /* <span class="class">Negative</span> exptimes can underflow and end up immortal. realtime() will 
     immediately expire values that are greater than <span class="class">REALTIME_MAXDELTA</span>, but less 
     than process_started, so lets aim for that. */  
    if (exptime &amp;lt; <span class="number">0</span>)  
        exptime = <span class="class">REALTIME_MAXDELTA</span> + <span class="number">1</span>;  

    // does cas value exist?  
    if (handle_cas) {  
        if (!safe_strtoull(tokens[<span class="number">5</span>].value, &amp;amp;req_cas_id)) {  
            out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
            return;  
        }  
    }  

    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;vlen&amp;<span class="symbol">#x8981</span>;+<span class="number">2</span>&amp;<span class="symbol">#x5462</span>;&amp;<span class="symbol">#xFF1F</span>;  
    //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;/r/n  
    //&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;/r/n&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;\r\n&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>; &amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
    vlen += <span class="number">2</span>;  
    if (vlen &amp;lt; <span class="number">0</span> || vlen - <span class="number">2</span> &amp;lt; <span class="number">0</span>) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    if (settings.detail_enabled) {  
        stats_prefix_record_set(key, nkey);  
    }  

    //item_alloc&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x6838</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;item_alloc&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item  
    //&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;  
    //key&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;key  
    //nkey&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //<span class="method">flags:</span>&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x8BC6</span>;  
    //exptime&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    //vlen&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7591</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF1F</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x4E86</span>;vlen&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x5462</span>;&amp;<span class="symbol">#xFF1F</span>;  
    //<span class="number">1.</span> &amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;set/add/replace&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E9B</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x8F93</span>;  
    //<span class="number">2.</span> &amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x9009</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x62EC</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;  
    //<span class="number">3.</span> &amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7C98</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;  
    //&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5B8C</span>;  
    //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x5373</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x3002</span>;  
    //<span class="number">4.</span> &amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF1A</span>;conn_set_state(c, conn_nread); &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_nread&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;conn_nread  
    //&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;  
    it = item_alloc(key, nkey, flags, realtime(exptime), vlen);  

    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
    if (it == <span class="number">0</span>) {  
        if (!item_size_ok(nkey, flags, vlen))  
            out_string(c, &amp;quot;<span class="class">SERVER_ERROR</span> object too large for cache&amp;quot;);  
        else  
            out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory storing object&amp;quot;);  
        /* swallow the data line */  
        c-&amp;gt;write_and_go = conn_swallow;  
        c-&amp;gt;sbytes = vlen;  

        /* <span class="class">Avoid</span> stale data persisting in cache because we failed alloc. 
         * <span class="class">Unacceptable</span> for <span class="class">SET</span>. <span class="class">Anywhere</span> else too? */  
        if (comm == <span class="class">NREAD_SET</span>) {  
            it = item_get(key, nkey);  
            if (it) {  
                item_unlink(it);  
                item_remove(it);  
            }  
        }  

        return;  
    }  
    <span class="class">ITEM_set_cas</span>(it, req_cas_id);  

    c-&amp;gt;item = it;  
    c-&amp;gt;ritem = <span class="class">ITEM_data</span>(it); //value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    c-&amp;gt;rlbytes = it-&amp;gt;nbytes; //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    c-&amp;gt;cmd = comm;  
    //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_nread&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    conn_set_state(c, conn_nread);  
}
</code></pre><p>&#x770B;&#x4E00;&#x4E0B;item_alloc&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5206;&#x914D;&#x4E00;&#x5757;&#x53EF;&#x4EE5;&#x7528;&#x7684;Item&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>Memcached&#x662F;&#x901A;&#x8FC7;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x957F;&#x5EA6;&#x9009;&#x62E9;&#x5408;&#x9002;&#x7684;slab class&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8BE5;slabs class&#x4E0A;&#x5206;&#x914D;&#x4E00;&#x5757;item&#x3002;</p>
</li>
</ol>
<p>&#x5148;&#x770B;&#x4E00;&#x4E0B;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code>//item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
typedef struct _stritem {  
    //&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *next;  //&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *prev;  //&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    struct _stritem *h_next; //hashtable&amp;<span class="symbol">#x7684</span>;list   /* hash chain next */  
    //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    rel_time_t      time;       /* least recent access */  
    //&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    rel_time_t      exptime;    /* expire time */  
    //value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
    int             nbytes;     /* size of data */  
    unsigned short  refcount;  
    uint8_t         nsuffix;    /* length of flags-and-length string */  
    uint8_t         it_flags;   /* <span class="class">ITEM_</span>* above */  
    //slab class&amp;<span class="symbol">#x7684</span>;<span class="class">ID</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E0A</span>;  
    uint8_t         slabs_clsid;/* which slab class we&amp;apos;re in */  
    uint8_t         nkey;       /* key length, w/terminating null and padding */  
    /* this odd type prevents type-punning issues when we do 
     * the little shuffle to save space when not using <span class="class">CAS</span>. */  
    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;  
    union {  
        uint64_t cas;  
        char end;  
    } data[];  
    /* if it_flags &amp;amp; <span class="class">ITEM_CAS</span> we have <span class="number">8</span> bytes <span class="class">CAS</span> */  
    /* then null-terminated key */  
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
} item;


/* 
 * <span class="class">Allocates</span> a new item. 
 */  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
item *item_alloc(char *key, size_t nkey, int flags, rel_time_t exptime, int nbytes) {  
    item *it;  
    /* do_item_alloc handles its own locks */  
    it = do_item_alloc(key, nkey, flags, exptime, nbytes, <span class="number">0</span>);  
    return it;  
}


//&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
item *do_item_alloc(char *key, const size_t nkey, const int flags,  
                    const rel_time_t exptime, const int nbytes,  
                    const uint32_t cur_hv) {  
    uint8_t nsuffix;  
    item *it = <span class="class">NULL</span>; //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    char suffix[<span class="number">40</span>];  
    //item_make_header &amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    size_t ntotal = item_make_header(nkey + <span class="number">1</span>, flags, nbytes, suffix, &amp;amp;nsuffix);  
    if (settings.use_cas) {  
        ntotal += sizeof(uint64_t);  
    }  
    //&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;ntotal &amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    //<span class="class">Memcached</span>&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class  
    //&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#xFF0C</span>;slabs&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabs&amp;<span class="symbol">#x4E0A</span>;  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;chunk  
    //  
    //&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>; &amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">200</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x3002</span>;  
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;slabs_class&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;item&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
    //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;slabs&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;chunk&amp;<span class="symbol">#x5757</span>;  
    //&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;chunk&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    unsigned int id = slabs_clsid(ntotal);  
    if (id == <span class="number">0</span>)  
        return <span class="number">0</span>;  
    mutex_lock(&amp;amp;cache_lock);  
    /* do a quick check if we have any expired items in the tail.. */  
    int tries = <span class="number">5</span>;  
    /* <span class="class">Avoid</span> hangs if a slab has nothing but refcounted stuff in it. */  
    int tries_lrutail_reflocked = <span class="number">1000</span>;  
    int tried_alloc = <span class="number">0</span>;  
    item *search;  
    item *next_it;  
    void *hold_lock = <span class="class">NULL</span>;  
    rel_time_t oldest_live = settings.oldest_live;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    //item&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    search = tails[id];  
    /* <span class="class">We</span> walk up *only* for locked items. <span class="class">Never</span> searching for expired. 
     * <span class="class">Waste</span> of <span class="class">CPU</span> for almost all deployments */  
    for (; tries &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; search != <span class="class">NULL</span>; tries--, search=next_it) {  
        /* we might relink search mid-loop, so search-&amp;gt;prev isn&amp;apos;t reliable */  
        next_it = search-&amp;gt;prev;  
        if (search-&amp;gt;nbytes == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;nkey == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;it_flags == <span class="number">1</span>) {  
            /* <span class="class">We</span> are a crawler, ignore it. */  
            tries++;  
            continue;  
        }  
        uint32_t hv = hash(<span class="class">ITEM_key</span>(search), search-&amp;gt;nkey);  
        /* <span class="class">Attempt</span> to hash item lock the &amp;quot;search&amp;quot; item. <span class="class">If</span> locked, no 
         * other callers can incr the refcount 
         */  
        /* <span class="class">Don</span>&amp;apos;t accidentally grab ourselves, or bail if we can&amp;apos;t quicklock */  
        if (hv == cur_hv || (hold_lock = item_trylock(hv)) == <span class="class">NULL</span>)  
            continue;  
        /* <span class="class">Now</span> see if the item is refcount locked */  
        if (refcount_incr(&amp;amp;search-&amp;gt;refcount) != <span class="number">2</span>) {  
            /* <span class="class">Avoid</span> pathological case with ref&amp;apos;ed items in tail */  
            do_item_update_nolock(search);  
            tries_lrutail_reflocked--;  
            tries++;  
            refcount_decr(&amp;amp;search-&amp;gt;refcount);  
            itemstats[id].lrutail_reflocked++;  
            /* <span class="class">Old</span> rare bug could cause a refcount leak. <span class="class">We</span> haven&amp;apos;t seen 
             * it in years, but we leave this code in to prevent failures 
             * just in case */  
            if (settings.tail_repair_time &amp;amp;&amp;amp;  
                    search-&amp;gt;time + settings.tail_repair_time &amp;lt; current_time) {  
                itemstats[id].tailrepairs++;  
                search-&amp;gt;refcount = <span class="number">1</span>;  
                do_item_unlink_nolock(search, hv);  
            }  
            if (hold_lock)  
                item_trylock_unlock(hold_lock);  
            if (tries_lrutail_reflocked &amp;lt; <span class="number">1</span>)  
                break;  
            continue;  
        }  
        /* <span class="class">Expired</span> or flushed */  
        if ((search-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;exptime &amp;lt; current_time)  
            || (search-&amp;gt;time &amp;lt;= oldest_live &amp;amp;&amp;amp; oldest_live &amp;lt;= current_time)) {  
            itemstats[id].reclaimed++;  
            if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                itemstats[id].expired_unfetched++;  
            }  
            it = search;  
            slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
            do_item_unlink_nolock(it, hv);  
            /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
            it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
        //slabs_alloc&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
        } else if ((it = slabs_alloc(ntotal, id)) == <span class="class">NULL</span>) {  
            tried_alloc = <span class="number">1</span>;  
            if (settings.evict_to_free == <span class="number">0</span>) {  
                itemstats[id].outofmemory++;  
            } else {  
                itemstats[id].evicted++;  
                itemstats[id].evicted_time = current_time - search-&amp;gt;time;  
                if (search-&amp;gt;exptime != <span class="number">0</span>)  
                    itemstats[id].evicted_nonzero++;  
                if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                    itemstats[id].evicted_unfetched++;  
                }  
                it = search;  
                slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
                do_item_unlink_nolock(it, hv);  
                /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
                it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
                /* <span class="class">If</span> we&amp;apos;ve just evicted an item, and the automover is set to 
                 * angry bird mode, attempt to rip memory into this slab class. 
                 * <span class="class">TODO</span>: <span class="class">Move</span> valid object detection into a function, and on a 
                 * &amp;quot;successful&amp;quot; memory pull, look behind and see if the next alloc 
                 * would be an eviction. <span class="class">Then</span> kick off the slab mover before the 
                 * eviction happens. 
                 */  
                if (settings.slab_automove == <span class="number">2</span>)  
                    slabs_reassign(-<span class="number">1</span>, id);  
            }  
        }  
        refcount_decr(&amp;amp;search-&amp;gt;refcount);  
        /* <span class="class">If</span> hash values were equal, we don&amp;apos;t grab a second lock */  
        if (hold_lock)  
            item_trylock_unlock(hold_lock);  
        break;  
    }  
    if (!tried_alloc &amp;amp;&amp;amp; (tries == <span class="number">0</span> || search == <span class="class">NULL</span>))  
        it = slabs_alloc(ntotal, id);  
    if (it == <span class="class">NULL</span>) {  
        itemstats[id].outofmemory++;  
        mutex_unlock(&amp;amp;cache_lock);  
        return <span class="class">NULL</span>;  
    }  
    assert(it-&amp;gt;slabs_clsid == <span class="number">0</span>);  
    assert(it != heads[id]);  
    /* <span class="class">Item</span> initialization can happen outside of the lock; the item&amp;apos;s already 
     * been removed from the slab <span class="class">LRU</span>. 
     */  
    it-&amp;gt;refcount = <span class="number">1</span>;     /* the caller will have a reference */  
    mutex_unlock(&amp;amp;cache_lock);  
    it-&amp;gt;next = it-&amp;gt;prev = it-&amp;gt;h_next = <span class="number">0</span>;  
    it-&amp;gt;slabs_clsid = id;  
    <span class="class">DEBUG_REFCNT</span>(it, &amp;apos;*&amp;apos;);  
    it-&amp;gt;it_flags = settings.use_cas ? <span class="class">ITEM_CAS</span> : <span class="number">0</span>;  
    it-&amp;gt;nkey = nkey;  
    it-&amp;gt;nbytes = nbytes;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;  
    memcpy(<span class="class">ITEM_key</span>(it), key, nkey);  
    it-&amp;gt;exptime = exptime;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;  
    memcpy(<span class="class">ITEM_suffix</span>(it), suffix, (size_t)nsuffix);  
    it-&amp;gt;nsuffix = nsuffix;  
    return it;  
}
</code></pre><p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x72B6;&#x6001;&#x673A;drive_machine&#x4E2D;conn_nread&#x7684;&#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x8BFB;&#x53D6;&#x7F13;&#x5B58;&#x7684;value&#x503C;</p>
</li>
<li><p>&#x5C06;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#x5230;item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<p> //conn_nread &#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;&#x7F13;&#x5B58;&#x7684;value&#x6570;&#x636E;&#x62A5;&#x6587;<br> case conn_nread:  </p>
<pre><code>//&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>; value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E86</span>;  
if (c-&amp;gt;rlbytes == <span class="number">0</span>) {  
    complete_nread(c);  
    break;  
}  
/* <span class="class">Check</span> if rbytes &amp;lt; <span class="number">0</span>, to prevent crash */  
//&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
if (c-&amp;gt;rlbytes &amp;lt; <span class="number">0</span>) {  
    if (settings.verbose) {  
        fprintf(stderr, &amp;quot;<span class="class">Invalid</span> rlbytes to <span class="method">read:</span> len %d\n&amp;quot;,  
                c-&amp;gt;rlbytes);  
    }  
    conn_set_state(c, conn_closing);  
    break;  
}  
/* first check if we have leftovers in the conn_read buffer */  
//c-&amp;gt;rbytes &amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//c-&amp;gt;rlbytes &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
    //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76EE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;c-&amp;gt;rlbytes&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes &amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>; c-&amp;gt;rlbytes &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes &amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>; c-&amp;gt;rlbytes &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53E6</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8DEF</span>;&amp;<span class="symbol">#x4E0A</span>;  
    int tocopy = c-&amp;gt;rbytes &amp;gt; c-&amp;gt;rlbytes ? c-&amp;gt;rlbytes : c-&amp;gt;rbytes;  
    //c-&amp;gt;ritem &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6B21</span>;set/add/replace&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    if (c-&amp;gt;ritem != c-&amp;gt;rcurr) {  
        memmove(c-&amp;gt;ritem, c-&amp;gt;rcurr, tocopy);  
    }  
    c-&amp;gt;ritem += tocopy; //&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x52A0</span>;  
    c-&amp;gt;rlbytes -= tocopy; //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>; &amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    c-&amp;gt;rcurr += tocopy; //&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    c-&amp;gt;rbytes -= tocopy; //&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>; &amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>; &amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rlbytes&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;value&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x51FA</span>;  
    if (c-&amp;gt;rlbytes == <span class="number">0</span>) {  
        break;  
    }  
}  
/*  now try reading from the socket */  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;<span class="symbol">#x4ECE</span>;socket&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;c-&amp;gt;ritem&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;c-&amp;gt;rlbytes  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5230</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6B62</span>;  
res = read(c-&amp;gt;sfd, c-&amp;gt;ritem, c-&amp;gt;rlbytes);  
if (res &amp;gt; <span class="number">0</span>) {  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.bytes_read += res;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    if (c-&amp;gt;rcurr == c-&amp;gt;ritem) {  
        c-&amp;gt;rcurr += res;  
    }  
    c-&amp;gt;ritem += res;  
    c-&amp;gt;rlbytes -= res;  
    break;  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6D41</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
if (res == <span class="number">0</span>) { /* end of stream */  
    conn_set_state(c, conn_closing);  
    break;  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;  
if (res == -<span class="number">1</span> &amp;amp;&amp;amp; (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>)) {  
    if (!update_event(c, <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>)) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    stop = <span class="keyword">true</span>;  
    break;  
}  
/* otherwise we have a real error, on which we close the connection */  
if (settings.verbose &amp;gt; <span class="number">0</span>) {  
    fprintf(stderr, &amp;quot;<span class="class">Failed</span> to read, and not due to <span class="method">blocking:</span>\n&amp;quot;  
            &amp;quot;<span class="method">errno:</span> %d %s \n&amp;quot;  
            &amp;quot;rcurr=%lx ritem=%lx rbuf=%lx rlbytes=%d rsize=%d\n&amp;quot;, errno,  
            strerror(errno), (long) c-&amp;gt;rcurr, (long) c-&amp;gt;ritem,  
            (long) c-&amp;gt;rbuf, (int) c-&amp;gt;rlbytes, (int) c-&amp;gt;rsize);  
}  
//&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;  
conn_set_state(c, conn_closing);  
break;
</code></pre></li>
</ol>
<p>&#x8FD9;&#x8FB9;&#x5982;&#x679C;&#x8BFB;&#x53D6;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;complete_nread(c)&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5F80;&#x4E0B;&#x4E00;&#x76F4;&#x770B;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x5230;complete_nread_ascii&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x8C03;&#x7528;&#x5B58;&#x50A8;&#x6570;&#x636E;store_item&#x7684;&#x65B9;&#x6CD5;</p>
</li>
<li><p>&#x8C03;&#x7528;item_remove&#x5220;&#x9664;item&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p> static void complete_nread_ascii(conn *c) {  </p>
<pre><code>assert(c != NULL);  

item *it = c-&amp;<span class="keyword">gt</span>;item;  
<span class="keyword">int</span> comm = c-&amp;<span class="keyword">gt</span>;cmd;  
enum store_item_type ret;  

pthread_mutex_lock(&amp;amp;c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.mutex);  
c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.slab_stats[it-&amp;<span class="keyword">gt</span>;slabs_clsid].set_cmds++;  
pthread_mutex_unlock(&amp;amp;c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.mutex);  

<span class="keyword">if</span> (strncmp(ITEM_data(it) + it-&amp;<span class="keyword">gt</span>;nbytes - <span class="number">2</span>, &amp;quot;\r\n&amp;quot;, <span class="number">2</span>) != <span class="number">0</span>) {  
    out_string(c, &amp;quot;CLIENT_ERROR bad data chunk&amp;quot;);  
} <span class="keyword">else</span> {  
    <span class="regexp">//</span>&amp;<span class="comment">#x8FD9;&amp;#x8FB9;&amp;#x8C03;&amp;#x7528;&amp;#x5B58;&amp;#x50A8;Item&amp;#x7684;&amp;#x65B9;&amp;#x6CD5;  </span>
    ret = store_item(it, comm, c);  
</code></pre><p> //….  </p>
<pre><code>    switch (ret) {  
    case <span class="class">STORED</span>:  
        out_string(c, &amp;quot;<span class="class">STORED</span>&amp;quot;);  
        break;  
    case <span class="class">EXISTS</span>:  
        out_string(c, &amp;quot;<span class="class">EXISTS</span>&amp;quot;);  
        break;  
    case <span class="class">NOT_FOUND</span>:  
        out_string(c, &amp;quot;<span class="class">NOT_FOUND</span>&amp;quot;);  
        break;  
    case <span class="class">NOT_STORED</span>:  
        out_string(c, &amp;quot;<span class="class">NOT_STORED</span>&amp;quot;);  
        break;  
    <span class="method">default:</span>  
        out_string(c, &amp;quot;<span class="class">SERVER_ERROR</span> <span class="class">Unhandled</span> storage type.&amp;quot;);  
    }  

}  

//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7ADF</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#xFF1F</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x89C9</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5947</span>;&amp;<span class="symbol">#x602A</span>;&amp;<span class="symbol">#x4E48</span>;&amp;<span class="symbol">#xFF1F</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;item-&amp;gt;refcount,&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;alloc&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;refcount&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>  
//  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;store_item&amp;<span class="symbol">#xFF0C</span>;add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_link  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;refcount&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;  
//if (refcount_decr(&amp;amp;it-&amp;gt;refcount) == <span class="number">0</span>) &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
//  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;store_item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x786E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item  
//  
//&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x7ED5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x903B</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F46</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x5DE7</span>;&amp;<span class="symbol">#x5999</span>;  
item_remove(c-&amp;gt;item); /* release the c-&amp;gt;item reference */  
c-&amp;gt;item = <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;do_store_item&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x3002;&#x57FA;&#x672C;&#x5305;&#x62EC;&#x4E24;&#x79CD;&#x72B6;&#x6001;&#xFF1A;&#x5B58;&#x50A8;&#x6210;&#x529F;&#x548C;&#x5B58;&#x50A8;&#x5931;&#x8D25;&#x3002;</p>
<ol>
<li><p>add/replace&#x547D;&#x4EE4;&#xFF0C;&#x4F1A;&#x5224;&#x65AD;item&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x5219;add&#x547D;&#x4EE4;&#x64CD;&#x4F5C;&#x5931;&#x8D25;</p>
</li>
<li><p>set&#x547D;&#x4EE4;&#xFF0C;item&#x5B58;&#x5728;&#x6216;&#x8005;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x65B0;&#x7684;item&#xFF0C;&#x66FF;&#x6362;&#x8001;&#x7684;item&#x3002;</p>
<p> //&#x5B58;&#x50A8;Item&#x64CD;&#x4F5C;<br> enum store_item_type do_store_item(item <em>it, int comm, conn </em>c,  </p>
<pre><code>    const uint32_t hv) {  
char *key = <span class="class">ITEM_key</span>(it);  
//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;<span class="class">KEY</span>&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x65E7</span>;&amp;<span class="symbol">#x7684</span>;item  
//add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item  
item *old_it = do_item_get(key, it-&amp;gt;nkey, hv);  
enum store_item_type stored = <span class="class">NOT_STORED</span>;  
item *new_it = <span class="class">NULL</span>;  
int flags;  
//<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT_STORED</span>  
if (old_it != <span class="class">NULL</span> &amp;amp;&amp;amp; comm == <span class="class">NREAD_ADD</span>) {  
    /* add only adds a nonexistent item, but promote to head of <span class="class">LRU</span> */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //<span class="number">1.</span>&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;item&amp;<span class="symbol">#x7684</span>;it-&amp;gt;time&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x987A</span>;&amp;<span class="symbol">#x5E8F</span>;  
    //<span class="number">2.</span>&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;refcount  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;it-&amp;gt;refcount=<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;old_it&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    do_item_update(old_it);  
//replace/prepend/append &amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x505A</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;item&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT_STORED</span>  
} else if (!old_it  
        &amp;amp;&amp;amp; (comm == <span class="class">NREAD_REPLACE</span> || comm == <span class="class">NREAD_APPEND</span>  
                || comm == <span class="class">NREAD_PREPEND</span>)) {  
    /* replace only replaces an existing value; don&amp;apos;t store */  
} else if (comm == <span class="class">NREAD_CAS</span>) {  
    /* validate cas operation */  
    if (old_it == <span class="class">NULL</span>) {  
        // <span class="class">LRU</span> expired  
        stored = <span class="class">NOT_FOUND</span>;  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.cas_misses++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    } else if (<span class="class">ITEM_get_cas</span>(it) == <span class="class">ITEM_get_cas</span>(old_it)) {  
        // cas validates  
        // it and old_it may belong to different classes.  
        // <span class="class">I</span>&amp;apos;m updating the stats for the one that&amp;apos;s getting pushed out  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.slab_stats[old_it-&amp;gt;slabs_clsid].cas_hits++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        item_replace(old_it, it, hv);  
        stored = <span class="class">STORED</span>;  
    } else {  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.slab_stats[old_it-&amp;gt;slabs_clsid].cas_badval++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        if (settings.verbose &amp;gt; <span class="number">1</span>) {  
            fprintf(stderr, &amp;quot;<span class="class">CAS</span>:  <span class="method">failure:</span> expected %llu, got %llu\n&amp;quot;,  
                    (unsigned long long) <span class="class">ITEM_get_cas</span>(old_it),  
                    (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
        }  
        stored = <span class="class">EXISTS</span>;  
    }  
} else {  
    /* 
     * <span class="class">Append</span> - combine new and old record into single one. <span class="class">Here</span> it&amp;apos;s 
     * atomic and thread-safe. 
     */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8001</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x8FFD</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>; append&amp;<span class="symbol">#x548C</span>;prepend&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (comm == <span class="class">NREAD_APPEND</span> || comm == <span class="class">NREAD_PREPEND</span>) {  
        /* 
         * <span class="class">Validate</span> <span class="class">CAS</span> 
         */  
        if (<span class="class">ITEM_get_cas</span>(it) != <span class="number">0</span>) {  
            // <span class="class">CAS</span> much be equal  
            if (<span class="class">ITEM_get_cas</span>(it) != <span class="class">ITEM_get_cas</span>(old_it)) {  
                stored = <span class="class">EXISTS</span>;  
            }  
        }  
        if (stored == <span class="class">NOT_STORED</span>) {  
            /* we have it and old_it here - alloc memory to hold both */  
            /* flags was already lost - so recover them from <span class="class">ITEM_suffix</span>(it) */  
            flags = (int) strtol(<span class="class">ITEM_suffix</span>(old_it), (char **) <span class="class">NULL</span>, <span class="number">10</span>);  
            new_it = do_item_alloc(key, it-&amp;gt;nkey, flags, old_it-&amp;gt;exptime,  
                    it-&amp;gt;nbytes + old_it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */, hv);  
            if (new_it == <span class="class">NULL</span>) {  
                /* <span class="class">SERVER_ERROR</span> out of memory */  
                if (old_it != <span class="class">NULL</span>)  
                    do_item_remove(old_it);  
                return <span class="class">NOT_STORED</span>;  
            }  
            /* copy data from it and old_it to new_it */  
            if (comm == <span class="class">NREAD_APPEND</span>) {  
                memcpy(<span class="class">ITEM_data</span>(new_it), <span class="class">ITEM_data</span>(old_it),  
                        old_it-&amp;gt;nbytes);  
                memcpy(<span class="class">ITEM_data</span>(new_it) + old_it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */,  
                        <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes);  
            } else {  
                /* <span class="class">NREAD_PREPEND</span> */  
                memcpy(<span class="class">ITEM_data</span>(new_it), <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes);  
                memcpy(<span class="class">ITEM_data</span>(new_it) + it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */,  
                        <span class="class">ITEM_data</span>(old_it), old_it-&amp;gt;nbytes);  
            }  
            it = new_it;  
        }  
    }  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (stored == <span class="class">NOT_STORED</span>) {  
        if (old_it != <span class="class">NULL</span>)  
            //&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;old_it&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
            //it&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;it-&amp;gt;refcount=<span class="number">2</span>  
            item_replace(old_it, it, hv);  
        else  
            //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;it-&amp;gt;refcount=<span class="number">2</span>  
            do_item_link(it, hv);  
        c-&amp;gt;cas = <span class="class">ITEM_get_cas</span>(it);  
        stored = <span class="class">STORED</span>;  
    }  
    //&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x63D0</span>;&amp;<span class="symbol">#x5230</span>;it-&amp;gt;refcount?  
    //<span class="number">1.</span> &amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;it-&amp;gt;refcount&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9632</span>;&amp;<span class="symbol">#x6B62</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item  
    //<span class="number">2.</span> do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;refcount&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">ITEM</span>  
    //  
    //&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_store_item&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;memcached&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_remove(it);&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x3002</span>;  
    //do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5C06</span>;item&amp;<span class="symbol">#x751F</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">SET</span>/<span class="class">ADD</span>&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x597D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">SET</span>&amp;<span class="symbol">#x548C</span>;<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_link&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;item&amp;<span class="symbol">#x7684</span>;refcount&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;  
    //&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_remove(it);&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">0</span>&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x7ED5</span>;.....  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8001</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
if (old_it != <span class="class">NULL</span>)  
    do_item_remove(old_it); /* release our reference */  
//new_it&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;prepend/append&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
if (new_it != <span class="class">NULL</span>)  
    do_item_remove(new_it);  
if (stored == <span class="class">STORED</span>) {  
    c-&amp;gt;cas = <span class="class">ITEM_get_cas</span>(it);  
}  
return stored;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x5728;do_store_item&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x7EC8;&#x4F1A;&#x627E;&#x5230;do_item_link&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;item&#x6302;&#x5230;Hashtable&#x4E0A;&#x9762;</p>
</li>
<li><p>&#x5C06;item&#x6302;&#x5230;LRU&#x94FE;&#x4E0A;&#x9762;</p>
</li>
</ol>
<p>HashTable&#xFF1A;&#x628A;Item&#x6302;&#x5230;HashTable&#x4E0A;&#x53BB;&#x540E;&#xFF0C;&#x7528;&#x6237;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F13;&#x5B58;&#x7684;key&#x5230;HashTable&#x4E0A;&#x67E5;&#x8BE2;&#x8FD9;&#x4E2A;Item&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>LRU&#xFF1A;&#x662F;&#x4E00;&#x4E2A;&#x6E05;&#x9664;&#x7F13;&#x5B58;&#x7684;&#x7B56;&#x7565;&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x6E05;&#x7406;&#x6700;&#x4E0D;&#x5E38;&#x7528;&#x7684;&#x5143;&#x7D20;&#x3002;LRU&#x7684;&#x94FE;&#xFF0C;&#x4F1A;&#x653E;&#x5728;&#x4E0B;&#x9762;&#x4E24;&#x4E2A;Item&#x6307;&#x9488;&#x5730;&#x5740;&#x7684;&#x6570;&#x7EC4;&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>static item *heads[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
static item *tails[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;
</code></pre><p>v</p>
<pre><code><span class="comment">//&amp;#x65B0;&amp;#x589E;&amp;#x4E00;&amp;#x4E2A;Item&amp;#x7684;&amp;#x8FDE;&amp;#x63A5;&amp;#x5173;&amp;#x7CFB;  </span>
int do_item_link<span class="params">(item *it, const uint32_t hv)</span> {  
    MEMCACHED_ITEM_LINK<span class="params">(ITEM_key<span class="params">(it)</span>, it-&amp;gt;nkey, it-&amp;gt;nbytes)</span>;  
    assert<span class="params">(<span class="params">(it-&amp;gt;it_flags &amp;amp; <span class="params">(ITEM_LINKED|ITEM_SLABBED)</span>)</span> == <span class="number">0</span>)</span>;  
    mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
    it-&amp;gt;it_flags |= ITEM_LINKED;  
    it-&amp;gt;time = current_time;  

    STATS_LOCK<span class="params">()</span>;  
    stats.curr_bytes += ITEM_ntotal<span class="params">(it)</span>;  
    stats.curr_items += <span class="number">1</span>;  
    stats.total_items += <span class="number">1</span>;  
    STATS_UNLOCK<span class="params">()</span>;  

    <span class="comment">/* Allocate a new CAS ID on link. */</span>  
    ITEM_set_cas<span class="params">(it, <span class="params">(settings.use_cas)</span> ? get_cas_id<span class="params">()</span> : <span class="number">0</span>)</span>;  
    <span class="comment">//&amp;#x5206;&amp;#x914D;&amp;#x5230;HashTable&amp;#x7684;&amp;#x6876;&amp;#x4E0A;  </span>
    assoc_insert<span class="params">(it, hv)</span>;  
    <span class="comment">//LRU&amp;#x94FE;  </span>
    item_link_q<span class="params">(it)</span>;  
    refcount_incr<span class="params">(&amp;amp;it-&amp;gt;refcount)</span>; <span class="comment">//&amp;#x5F15;&amp;#x7528;&amp;#x6B21;&amp;#x6570;+1  </span>
    mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  

    return <span class="number">1</span>;  
}
</code></pre><p>&#x67E5;&#x8BE2; get &#x64CD;&#x4F5C;</p>
<p>&#x67E5;&#x8BE2;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x770B;&#x4E0B;process_get_command&#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5206;&#x89E3;get&#x547D;&#x4EE4;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;key&#x53BB;HashTable&#x4E0A;&#x627E;&#x5230;item&#x7684;&#x5730;&#x5740;&#x503C;&#x3002;</p>
</li>
<li><p>&#x8FD4;&#x56DE;&#x627E;&#x5230;&#x7684;item&#x6570;&#x636E;&#x503C;&#x3002;</p>
<p> /<em> ntokens is overwritten here… shrug.. </em>/<br> //&#x5904;&#x7406;GET&#x8BF7;&#x6C42;&#x7684;&#x547D;&#x4EE4;<br> static inline void process_get_command(conn <em>c, token_t </em>tokens, size_t ntokens,  </p>
<pre><code>    bool return_cas) {  
//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
char *key;  
size_t nkey;  
int i = <span class="number">0</span>;  
item *it;  
//&amp;amp;tokens[<span class="number">0</span>] &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;amp;tokens[<span class="number">1</span>] &amp;<span class="symbol">#x4E3A</span>;key  
//token_t &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E86</span>;value&amp;<span class="symbol">#x548C</span>;length  
token_t *key_token = &amp;amp;tokens[<span class="class">KEY_TOKEN</span>];  
char *suffix;  
assert(c != <span class="class">NULL</span>);  
do {  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
    while (key_token-&amp;gt;length != <span class="number">0</span>) {  
        key = key_token-&amp;gt;value;  
        nkey = key_token-&amp;gt;length;  
        //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;memcache key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">250</span>  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;  
        if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
            //out_string &amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
            while (i-- &amp;gt; <span class="number">0</span>) {  
                item_remove(*(c-&amp;gt;ilist + i));  
            }  
            return;  
        }  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5FEB</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        it = item_get(key, nkey);  
        if (settings.detail_enabled) {  
            //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
            stats_prefix_record_get(key, nkey, <span class="class">NULL</span> != it);  
        }  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        if (it) {  
            //c-&amp;gt;ilist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;buf  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;ilist&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
            if (i &amp;gt;= c-&amp;gt;isize) {  
                item **new_list = realloc(c-&amp;gt;ilist,  
                        sizeof(item *) * c-&amp;gt;isize * <span class="number">2</span>);  
                if (new_list) {  
                    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
                    c-&amp;gt;isize *= <span class="number">2</span>;  
                    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x652F</span>;&amp;<span class="symbol">#x6301</span>;  
                    c-&amp;gt;ilist = new_list;  
                } else {  
                    <span class="class">STATS_LOCK</span>();  
                    stats.malloc_fails++;  
                    <span class="class">STATS_UNLOCK</span>();  
                    item_remove(it);  
                    break;  
                }  
            }  
            /* 
             * <span class="class">Construct</span> the response. <span class="class">Each</span> hit adds three elements to the 
             * outgoing data <span class="method">list:</span> 
             *   &amp;quot;<span class="class">VALUE</span> &amp;quot; 
             *   key 
             *   &amp;quot; &amp;quot; + flags + &amp;quot; &amp;quot; + data length + &amp;quot;\r\n&amp;quot; + data (with \r\n) 
             */  
            //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
            if (return_cas) {  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                        it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                /* <span class="class">Goofy</span> mid-flight realloc. */  
                if (i &amp;gt;= c-&amp;gt;suffixsize) {  
                    char **new_suffix_list = realloc(c-&amp;gt;suffixlist,  
                            sizeof(char *) * c-&amp;gt;suffixsize * <span class="number">2</span>);  
                    if (new_suffix_list) {  
                        c-&amp;gt;suffixsize *= <span class="number">2</span>;  
                        c-&amp;gt;suffixlist = new_suffix_list;  
                    } else {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        item_remove(it);  
                        break;  
                    }  
                }  
                suffix = cache_alloc(c-&amp;gt;thread-&amp;gt;suffix_cache);  
                if (suffix == <span class="class">NULL</span>) {  
                    <span class="class">STATS_LOCK</span>();  
                    stats.malloc_fails++;  
                    <span class="class">STATS_UNLOCK</span>();  
                    out_of_memory(c,  
                            &amp;quot;<span class="class">SERVER_ERROR</span> out of memory making <span class="class">CAS</span> suffix&amp;quot;);  
                    item_remove(it);  
                    while (i-- &amp;gt; <span class="number">0</span>) {  
                        item_remove(*(c-&amp;gt;ilist + i));  
                    }  
                    return;  
                }  
                *(c-&amp;gt;suffixlist + i) = suffix;  
                int suffix_len = snprintf(suffix, <span class="class">SUFFIX_SIZE</span>, &amp;quot; %llu\r\n&amp;quot;,  
                        (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
                if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_suffix</span>(it), it-&amp;gt;nsuffix - <span class="number">2</span>) != <span class="number">0</span>  
                        || add_iov(c, suffix, suffix_len) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                    item_remove(it);  
                    break;  
                }  
            } else {  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                        it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
                //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>;get userId  
                //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;  
                //<span class="class">VALUE</span> userId <span class="number">0</span> <span class="number">5</span>  
                //<span class="number">55555</span>  
                //<span class="class">END</span>  
                if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_suffix</span>(it),  
                                it-&amp;gt;nsuffix + it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                    item_remove(it);  
                    break;  
                }  
            }  
            if (settings.verbose &amp;gt; <span class="number">1</span>) {  
                int ii;  
                fprintf(stderr, &amp;quot;&amp;gt;%d sending key &amp;quot;, c-&amp;gt;sfd);  
                for (ii = <span class="number">0</span>; ii &amp;lt; it-&amp;gt;nkey; ++ii) {  
                    fprintf(stderr, &amp;quot;%c&amp;quot;, key[ii]);  
                }  
                fprintf(stderr, &amp;quot;\n&amp;quot;);  
            }  
            /* item_get() has incremented it-&amp;gt;refcount for us */  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].get_hits++;  
            c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            item_update(it);  
            *(c-&amp;gt;ilist + i) = it;  
            i++;  
        } else {  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.get_misses++;  
            c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, key, nkey, -<span class="number">1</span>, <span class="number">0</span>);  
        }  
        key_token++;  
    }  
    /* 
     * <span class="class">If</span> the command string hasn&amp;apos;t been fully processed, get the next set 
     * of tokens. 
     */  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;get&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    if (key_token-&amp;gt;value != <span class="class">NULL</span>) {  
        ntokens = tokenize_command(key_token-&amp;gt;value, tokens, <span class="class">MAX_TOKENS</span>);  
        key_token = tokens;  
    }  
} while (key_token-&amp;gt;value != <span class="class">NULL</span>);  
c-&amp;gt;icurr = c-&amp;gt;ilist;  
c-&amp;gt;ileft = i;  
if (return_cas) {  
    c-&amp;gt;suffixcurr = c-&amp;gt;suffixlist;  
    c-&amp;gt;suffixleft = i;  
}  
if (settings.verbose &amp;gt; <span class="number">1</span>)  
    fprintf(stderr, &amp;quot;&amp;gt;%d <span class="class">END</span>\n&amp;quot;, c-&amp;gt;sfd);  
/* 
 <span class="class">If</span> the loop was terminated because of out-of-memory, it is not 
 reliable to add <span class="class">END</span>\r\n to the buffer, because it might not end 
 in \r\n. <span class="class">So</span> we send <span class="class">SERVER_ERROR</span> instead. 
 */  
//&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x675F</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;  
if (key_token-&amp;gt;value != <span class="class">NULL</span> || add_iov(c, &amp;quot;<span class="class">END</span>\r\n&amp;quot;, <span class="number">5</span>) != <span class="number">0</span>  
        || (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>)) {  
    out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory writing get response&amp;quot;);  
} else {  
    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x3002</span>;  
    conn_set_state(c, conn_mwrite);  
    c-&amp;gt;msgcurr = <span class="number">0</span>;  
}  
</code></pre><p> }</p>
</li>
</ol>
<p>Memcached&#x7684;&#x67E5;&#x8BE2;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;HashTable&#x6765;&#x67E5;&#x8BE2;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x3002;</p>
<p>HashTable&#x6211;&#x4EEC;&#x5728;&#x4E0A;&#x4E00;&#x7AE0;&#x5DF2;&#x7ECF;&#x8BB2;&#x8FC7;&#x3002;&#x524D;&#x9762;&#x4E5F;&#x8BB2;&#x8FC7;&#xFF0C;&#x5F53;&#x7F13;&#x5B58;&#x6570;&#x636E;SET&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#xFF0C;Memcached&#x4F1A;&#x5C06;item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5173;&#x8054;&#x5230;HashTable&#x548C;&#x5B83;&#x7684;LRU&#x7684;&#x94FE;&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;item_*&amp;<span class="symbol">#x7CFB</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x6838</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53E3</span>;  
item *item_get(const char *key, const size_t nkey) {  
    item *it;  
    uint32_t hv;  
    hv = hash(key, nkey); //&amp;<span class="symbol">#x5BF9</span>;key&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;hash,&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;uint32_t&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
    item_lock(hv); //&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4ED6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6027</span>;  
    it = do_item_get(key, nkey, hv);  
    item_unlock(hv);  
    return it;  
}
</code></pre><p>&#x8FD9;&#x8FB9;&#x7740;&#x91CD;&#x770B;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;&#x4ECE;HashTable&#x4E0A;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;Item&#x5730;&#x5740;&#x503C;&#x3002;</p>
<pre><code><span class="comment">/** wrapper around assoc_find which does the lazy expiration logic */</span>  
<span class="keyword">item</span> *do_item_get(const <span class="keyword">char</span> *key, const size_t nkey, const uint32_t hv) {  
   <span class="comment"> //mutex_lock(&amp;amp;cache_lock);  </span>
   <span class="comment"> //&amp;#x5728;HashTable&amp;#x4E0A;&amp;#x627E;Item  </span>
    <span class="keyword">item</span> *<span class="keyword">it</span> = assoc_find(key, nkey, hv);  
    <span class="keyword">if</span> (<span class="keyword">it</span> != <span class="constant">NULL</span>) {  
        refcount_incr(&amp;amp;<span class="keyword">it</span>-&amp;gt;refcount);  
        <span class="comment">/* Optimization for slab reassignment. prevents popular items from 
         * jamming in busy wait. Can only do this here to satisfy lock order 
         * of item_lock, cache_lock, slabs_lock. */</span>  
        <span class="keyword">if</span> (slab_rebalance_signal &amp;amp;&amp;amp;  
            ((void *)<span class="keyword">it</span> &amp;gt;= slab_rebal.slab_start &amp;amp;&amp;amp; (void *)<span class="keyword">it</span> &amp;lt; slab_rebal.slab_end)) {  
            do_item_unlink_nolock(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
        }  
    }  
   <span class="comment"> //mutex_unlock(&amp;amp;cache_lock);  </span>
    int was_found = <span class="number">0</span>;  
    <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">2</span>) {  
        int ii;  
        <span class="keyword">if</span> (<span class="keyword">it</span> == <span class="constant">NULL</span>) {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;&amp;gt; NOT FOUND &amp;quot;);  
        } <span class="keyword">else</span> {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;&amp;gt; FOUND KEY &amp;quot;);  
            was_found++;  
        }  
        <span class="keyword">for</span> (ii = <span class="number">0</span>; ii &amp;lt; nkey; ++ii) {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;%c&amp;quot;, key[ii]);  
        }  
    }  
    <span class="keyword">if</span> (<span class="keyword">it</span> != <span class="constant">NULL</span>) {  
        <span class="keyword">if</span> (settings.oldest_live != <span class="number">0</span> &amp;amp;&amp;amp; settings.oldest_live &amp;lt;= current_time &amp;amp;&amp;amp;  
            <span class="keyword">it</span>-&amp;gt;<span class="built_in">time</span> &amp;lt;= settings.oldest_live) {  
            do_item_unlink(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
            <span class="keyword">if</span> (was_found) {  
                fprintf(<span class="keyword">stderr</span>, &amp;quot; -nuked <span class="keyword">by</span> flush&amp;quot;);  
            }  
       <span class="comment"> //&amp;#x68C0;&amp;#x67E5;&amp;#x662F;&amp;#x5426;&amp;#x8FC7;&amp;#x671F;  </span>
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">it</span>-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; <span class="keyword">it</span>-&amp;gt;exptime &amp;lt;= current_time) {  
            do_item_unlink(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
            <span class="keyword">if</span> (was_found) {  
                fprintf(<span class="keyword">stderr</span>, &amp;quot; -nuked <span class="keyword">by</span> expire&amp;quot;);  
            }  
        } <span class="keyword">else</span> {  
            <span class="keyword">it</span>-&amp;gt;it_flags |= ITEM_FETCHED;  
            DEBUG_REFCNT(<span class="keyword">it</span>, &amp;apos;+&amp;apos;);  
        }  
    }  
    <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">2</span>)  
        fprintf(<span class="keyword">stderr</span>, &amp;quot;\n&amp;quot;);  
    <span class="constant">return</span> <span class="keyword">it</span>;  
}
</code></pre><p>&#x5220;&#x9664; delete &#x64CD;&#x4F5C;</p>
<p>&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x770B;process_delete_command&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li><p>&#x5148;&#x67E5;&#x8BE2;item&#x662F;&#x5426;&#x5B58;&#x5728;</p>
</li>
<li><p>&#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#x5220;&#x9664;item&#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;NOT FOUND</p>
<p> static void process_delete_command(conn <em>c, token_t </em>tokens,  </p>
<pre><code>    const size_t ntokens) {  
char *key;  
size_t nkey;  
item *it;  
assert(c != <span class="class">NULL</span>);  
//&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6027</span>;  
if (ntokens &amp;gt; <span class="number">3</span>) {  
    bool hold_is_zero = strcmp(tokens[<span class="class">KEY_TOKEN</span> + <span class="number">1</span>].value, &amp;quot;<span class="number">0</span>&amp;quot;) == <span class="number">0</span>;  
    bool sets_noreply = set_noreply_maybe(c, tokens, ntokens);  
    bool valid = (ntokens == <span class="number">4</span> &amp;amp;&amp;amp; (hold_is_zero || sets_noreply))  
            || (ntokens == <span class="number">5</span> &amp;amp;&amp;amp; hold_is_zero &amp;amp;&amp;amp; sets_noreply);  
    if (!valid) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format.  &amp;quot;  
                &amp;quot;<span class="class">Usage</span>: delete &amp;lt;key&amp;gt; [noreply]&amp;quot;);  
        return;  
    }  
}  
//&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
key = tokens[<span class="class">KEY_TOKEN</span>].value;  
nkey = tokens[<span class="class">KEY_TOKEN</span>].length;  
if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
    out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
    return;  
}  
if (settings.detail_enabled) {  
    stats_prefix_record_delete(key, nkey);  
}  
//&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT</span> <span class="class">FOUND</span>  
it = item_get(key, nkey);  
if (it) {  
    <span class="class">MEMCACHED_COMMAND_DELETE</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey);  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].delete_hits++;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;<span class="class">Item</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;<span class="class">Item</span>  
    item_unlink(it);  
    item_remove(it); /* release our reference */  
    out_string(c, &amp;quot;<span class="class">DELETED</span>&amp;quot;);  
} else {  
    //&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.delete_misses++;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    out_string(c, &amp;quot;<span class="class">NOT_FOUND</span>&amp;quot;);  
}  
</code></pre><p> }</p>
</li>
</ol>
<p>item_unlink&#x548C;do_item_unlink&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4E24;&#x4E2A;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x4ECE;HashTable&#x4E0A;&#x5C06;Item&#x7684;&#x5730;&#x5740;&#x503C;&#x5220;&#x9664;</p>
</li>
<li><p>&#x4ECE;LRU&#x7684;&#x94FE;&#x8868;&#x4E0A;&#xFF0C;&#x5C06;Item&#x7684;&#x5730;&#x5740;&#x503C;&#x5220;&#x9664;&#xFF08;LRU&#x94FE;&#x8868;&#x53EA;&#x8981;&#x5904;&#x7406;&#x5934;&#x90E8;&#x548C;&#x5C3E;&#x90E8;&#x5C31;&#x884C;&#x4E86;&#xFF09;</p>
<p> //&#x4ECE;LRU&#x548C;HashTable&#x89E3;&#x7ED1;<br> void item_unlink(item *item) {  </p>
<pre><code>uint32_t hv<span class="comment">;  </span>
hv = hash<span class="list">(<span class="keyword">ITEM_key</span><span class="list">(<span class="keyword">item</span>)</span>, item-&amp;gt<span class="comment">;nkey);  </span>
item_lock<span class="list">(<span class="keyword">hv</span>)</span><span class="comment">;  </span>
do_item_unlink<span class="list">(<span class="keyword">item</span>, hv)</span><span class="comment">;  </span>
item_unlock<span class="list">(<span class="keyword">hv</span>)</span><span class="comment">;  </span></span>
</code></pre><p> }</p>
</li>
</ol>
<p>item_remove&#x4E3B;&#x8981;&#x662F;&#x91CA;&#x653E;item</p>
<pre><code><span class="comment">//&amp;#x5220;&amp;#x9664;Item  </span>
void item_remove<span class="params">(item *item)</span> {  
    uint32_t hv;  
    hv = hash<span class="params">(ITEM_key<span class="params">(item)</span>, item-&amp;gt;nkey)</span>; <span class="comment">//Hash&amp;#x503C;  </span>

    item_lock<span class="params">(hv)</span>;  
    do_item_remove<span class="params">(item)</span>;  
    item_unlock<span class="params">(hv)</span>;  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/235b9ce/" title="memcached 1.4.23 发布，集中式缓存系统 -" itemprop="url">memcached 1.4.23 发布，集中式缓存系统 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.oschina.net/news/61534/oschina-opensource-collection-plan-for-it-companies" target="_blank" rel="external">&#x5F00;&#x6E90;&#x4E2D;&#x56FD;&#x7684; IT &#x516C;&#x53F8;&#x5F00;&#x6E90;&#x8F6F;&#x4EF6;&#x6574;&#x7406;&#x8BA1;&#x5212;&#x4ECB;&#x7ECD;</a></p>
<p>memcached 1.4.23 &#x53D1;&#x5E03;&#xFF0C;&#x6B64;&#x7248;&#x672C;&#x73B0;&#x5DF2;&#x63D0;&#x4F9B;&#x4E0B;&#x8F7D;&#xFF1A; <a href="http://www.memcached.org/files/memcached-1.4.23.tar.gz" target="_blank" rel="external">http://www.memcached.org/files/memcached-1.4.23.tar.gz</a> &#x3002; </p>
<p>&#x6B64;&#x7248;&#x672C;&#x66F4;&#x65B0;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<h3 id="Bug_&#x4FEE;&#x590D;">Bug &#x4FEE;&#x590D;</h3><ul>
<li>spinlocks removed since they never seem to improve performance.</li>
<li>flush_all was not thread safe.</li>
<li>better handle items refcounted in tail by unlinking them from the LRU&apos;s</li>
</ul>
<h3 id="&#x65B0;&#x7279;&#x6027;">&#x65B0;&#x7279;&#x6027;</h3><p>&#x91CD;&#x5199;&#x4E86; memcached &#x7684;&#x6838;&#x5FC3; LRU &#x7B97;&#x6CD5;&#xFF1A;</p>
<ul>
<li>global cache_lock is gone, LRU&apos;s are now independently locked.</li>
<li>LRU&apos;s are now split between HOT, WARM, and COLD LRU&apos;s. New items enter the HOT LRU.</li>
<li>LRU updates only happen as items reach the bottom of an LRU. If active in HOT, stay in HOT, if active in WARM, stay in WARM. If active in COLD, move to WARM.</li>
<li>HOT/WARM each capped at 32% of memory available for that slab class. COLD is uncapped.</li>
<li>Items flow from HOT/WARM into COLD.</li>
<li>A background thread exists which shuffles items between/within the LRU&apos;s as capacities are reached.</li>
</ul>
<p>&#x4E3B;&#x8981;&#x76EE;&#x6807;&#x662F;&#x4FDD;&#x62A4;&#x201C;scanning&#x201D;&#x7684; active items&#xFF0C;&#x5176;&#x6B21;&#x662F;&#x4E3A;&#x4E86;&#x6539;&#x8FDB;&#x5EF6;&#x8FDF;&#x3002;</p>
<p>&#x66F4;&#x591A;&#x6539;&#x8FDB;&#x5185;&#x5BB9;&#x8BF7;&#x770B; <a href="https://code.google.com/p/memcached/wiki/ReleaseNotes1423" target="_blank" rel="external">&#x53D1;&#x884C;&#x8BF4;&#x660E;</a> &#x3002; </p>
<p>memcached&#x662F;&#x4E00;&#x5957;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x5FEB;&#x53D6;&#x7CFB;&#x7EDF;&#xFF0C;&#x5F53;&#x521D;&#x662F;Danga Interactive&#x4E3A;&#x4E86;LiveJournal&#x6240;&#x53D1;&#x5C55;&#x7684;&#xFF0C;&#x4F46;&#x76EE;&#x524D;&#x88AB;&#x8BB8;&#x591A;&#x8F6F;&#x4EF6;&#xFF08;&#x5982;MediaWiki&#xFF09;&#x6240;&#x4F7F;&#x7528;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x5957;&#x5F00;&#x653E;&#x6E90;&#x4EE3;&#x7801;&#x8F6F;&#x4EF6;&#xFF0C;&#x4EE5;BSD license&#x6388;&#x6743;&#x91CA;&#x51FA;&#x3002; </p>
<p>memcached&#x7F3A;&#x4E4F;&#x8BA4;&#x8BC1;&#x4EE5;&#x53CA;&#x5B89;&#x5168;&#x7BA1;&#x5236;&#xFF0C;&#x8FD9;&#x4EE3;&#x8868;&#x5E94;&#x8BE5;&#x5C06;memcached&#x670D;&#x52A1;&#x5668;&#x653E;&#x7F6E;&#x5728;&#x9632;&#x706B;&#x5899;&#x540E;&#x3002;</p>
<p>memcached &#x7684;API&#x4F7F;&#x7528;&#x4E09;&#x5341;&#x4E8C;&#x4F4D;&#x5143;&#x7684;&#x5FAA;&#x73AF;&#x5197;&#x4F59;&#x6821;&#x9A8C;&#xFF08;CRC-32&#xFF09;&#x8BA1;&#x7B97;&#x952E;&#x503C;&#x540E;&#xFF0C;&#x5C06;&#x8D44;&#x6599;&#x5206;&#x6563;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x3002;&#x5F53;&#x8868;&#x683C;&#x6EE1;&#x4E86;&#x4EE5;&#x540E;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x65B0;&#x589E;&#x7684;&#x8D44;&#x6599;&#x4F1A;&#x4EE5;LRU&#x673A;&#x5236;&#x66FF;&#x6362;&#x6389;&#x3002; &#x7531;&#x4E8E;memcached&#x901A;&#x5E38;&#x53EA;&#x662F;&#x5F53;&#x4F5C;&#x5FEB;&#x53D6;&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;memcached&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5F0F;&#x5728;&#x5199;&#x56DE;&#x8F83;&#x6162;&#x7684;&#x7CFB;&#x7EDF;&#x65F6;&#xFF08;&#x50CF;&#x662F;&#x540E;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF09;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x7A0B;&#x5F0F;&#x7801;&#x66F4;&#x65B0; memcached&#x5185;&#x7684;&#x8D44;&#x6599;&#x3002;</p>
<p>memcached&#x5177;&#x6709;&#x591A;&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x5F00;&#x53D1;&#x5305;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;Perl/PHP/JAVA/C/Python/Ruby/C#/MySQL/</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x5305;&#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#x662F;&#xFF1A; <a href="http://code.google.com/p/memcached/wiki/Clients" target="_blank" rel="external">http://code.google.com/p/memcached/wiki/Clients</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23c66ca/" title="memcache（三）内存管理 -" itemprop="url">memcache（三）内存管理 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="memcached&#xFF08;&#x4E09;&#xFF09;&#x5185;&#x5B58;&#x7BA1;&#x7406;">memcached&#xFF08;&#x4E09;&#xFF09;&#x5185;&#x5B58;&#x7BA1;&#x7406;</h2><p>memcached&#x4F7F;&#x7528;&#x9884;&#x7533;&#x8BF7;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x7BA1;&#x7406;&#x5185;&#x5B58;&#x7684;&#x5206;&#x914D;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x5185;&#x5B58;&#x788E;&#x7247;&#x5316;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5982;&#x679C;&#x91C7;&#x7528;mallo&#x548C;free&#x6765;&#x52A8;&#x6001;&#x7684;&#x7533;&#x8BF7;&#x548C;&#x9500;&#x6BC1;&#x5185;&#x5B58;&#xFF0C;&#x5FC5;&#x7136;&#x4F1A;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x7684;&#x5185;&#x5B58;&#x788E;&#x7247;&#x3002;</p>
<h2 id="&#x57FA;&#x672C;&#x77E5;&#x8BC6;">&#x57FA;&#x672C;&#x77E5;&#x8BC6;</h2><p>slab&#xFF1A;&#x5185;&#x5B58;&#x5757;&#x662F;memcached&#x4E00;&#x6B21;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x5143;&#xFF0C;&#x5728;memcached&#x4E2D;&#x4E00;&#x4E2A;slab&#x7684;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;1M&#xFF1B;</p>
<p>slabclass&#xFF1A;&#x7279;&#x5B9A;&#x5927;&#x5C0F;&#x7684;chunk&#x7684;&#x7EC4;&#x3002;</p>
<p>chunk&#xFF1A;&#x7F13;&#x5B58;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x4E00;&#x4E2A;slab&#x88AB;&#x5212;&#x5206;&#x4E3A;&#x82E5;&#x5E72;&#x4E2A;chunk&#xFF1B;</p>
<p>item&#xFF1A;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x5143;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;chunk&#x90FD;&#x4F1A;&#x5305;&#x542B;&#x4E00;&#x4E2A;item&#xFF1B;</p>
<p>factor:&#x589E;&#x957F;&#x56E0;&#x5B50;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;1.25&#xFF0C;&#x76F8;&#x90BB;slab&#x4E2D;&#x7684;item&#x5927;&#x5C0F;&#x4E0E;factor&#x6210;&#x6BD4;&#x4F8B;&#x5173;&#x7CFB;&#xFF1B;</p>
<h2 id="&#x57FA;&#x672C;&#x539F;&#x7406;">&#x57FA;&#x672C;&#x539F;&#x7406;</h2><p>memcached&#x4F7F;&#x7528;&#x9884;&#x5206;&#x914D;&#x65B9;&#x6CD5;&#xFF0C;&#x907F;&#x514D;&#x9891;&#x7E41;&#x7684;&#x8C03;&#x7528;malloc&#x548C;free&#xFF1B;</p>
<p>memcached&#x901A;&#x8FC7;&#x4E0D;&#x540C;&#x7684;slab&#x6765;&#x7BA1;&#x7406;&#x4E0D;&#x540C;chunk&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x4ECE;&#x800C;&#x6EE1;&#x8DB3;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>slab&#x7684;&#x7533;&#x8BF7;&#x662F;&#x901A;&#x8FC7;&#x5728;&#x4F7F;&#x7528;item&#x65F6;&#x7533;&#x8BF7;slab&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x628A;&#x5185;&#x5B58;&#x5207;&#x5272;&#x4E3A;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x7684;item&#xFF0C;&#x6302;&#x5728;&#x5230;slab&#x7684;&#x672A;&#x4F7F;&#x7528;&#x94FE;&#x8868;&#x4E0A;&#x3002;</p>
<p>&#x8FC7;&#x671F;&#x548C;&#x88AB;&#x5220;&#x9664;item&#x5E76;&#x4E0D;&#x4F1A;&#x88AB;free&#x6389;&#xFF0C;memcached&#x5E76;&#x4E0D;&#x4F1A;&#x5220;&#x9664;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF1B;</p>
<p>Memcached&#x4F1A;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x5DF2;&#x8D85;&#x65F6;&#x7684;&#x8BB0;&#x5F55;&#x7A7A;&#x95F4;&#xFF0C;&#x901A;&#x8FC7;LRU&#x7B97;&#x6CD5;&#xFF1B;</p>
<p>memcached&#x4F7F;&#x7528;lazy expiration&#xFFFD;&#xFFFD;&#xFFFD;&#x5224;&#x65AD;&#x5143;&#x7D20;&#x662F;&#x5426;&#x8FC7;&#x671F;&#xFF0C;&#x6240;&#x4EE5;&#x8FC7;&#x671F;&#x76D1;&#x89C6;&#x4E0A;&#x4E0D;&#x4F1A;&#x5360;&#x7528;cpu&#x65F6;&#x95F4;&#x3002;</p>
<h2 id="&#x6E90;&#x7801;&#x5206;&#x6790;">&#x6E90;&#x7801;&#x5206;&#x6790;</h2><p>&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5206;&#x6790;memcached&#x7684;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x548C;&#x5B58;&#x50A8;&#x76F8;&#x5173;&#x4EE3;&#x7801;&#x3002;</p>
<h3 id="item">item</h3><p>item&#x662F;key/value&#x7684;&#x5B58;&#x50A8;&#x5355;&#x5143;&#x3002;</p>
<pre><code><span class="xml">typedef struct _stritem </span><span class="expression">{
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;      /* &amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;<span class="variable">slab-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>; */
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;    /* <span class="variable">hash</span> <span class="variable">chain</span> <span class="variable">next</span> */
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* &amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4; */
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* &amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4; */
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* &amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>; */
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;   /* &amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570; */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">suffix</span>&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6; */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* &amp;<span class="begin-block">#x</span>6240;&amp;<span class="begin-block">#x</span>6709;<span class="variable">slab</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">id</span> */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span>&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6; */
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span>
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> */
    <span class="variable">union</span> {
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;
        <span class="variable">char</span> <span class="variable">end</span>;
    }</span><span class="xml"> data[]; /* cas|key|suffix|value */
} item;</span>
</code></pre><h3 id="slab&#x521D;&#x59CB;&#x5316;">slab&#x521D;&#x59CB;&#x5316;</h3><pre><code>void slabs_init(const size_t limit, const double factor, const bool prealloc) {
    int i = <span class="class">POWER_SMALLEST</span> - <span class="number">1</span>;
    unsigned int size = sizeof(item) + settings.chunk_size; /* &amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
    mem_limit = limit;
    if (prealloc) { /* &amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>; */
        ...
    }
    memset(slabclass, <span class="number">0</span>, sizeof(slabclass)); /* &amp;<span class="symbol">#x628A</span>;slabclass&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;slabclass&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;slab&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>; */
    while (++i &amp;lt; <span class="class">POWER_LARGEST</span> &amp;amp;&amp;amp; size &amp;lt;= settings.item_size_max / factor) {  /* &amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5BB9</span>;,&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;slab&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;max_size/factor */
        /* <span class="class">Make</span> sure items are always n-byte aligned */
        if (size % <span class="class">CHUNK_ALIGN_BYTES</span>)  /* &amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x9F50</span>; */
            size += <span class="class">CHUNK_ALIGN_BYTES</span> - (size % <span class="class">CHUNK_ALIGN_BYTES</span>);
        slabclass[i].size = size; /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;slabclass&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
        slabclass[i].perslab = settings.item_size_max / slabclass[i].size; /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x91CF</span>; */
        size *= factor;  /* item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x968F</span>;factor&amp;<span class="symbol">#x9010</span>;&amp;<span class="symbol">#x6E10</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x5927</span>; */
        ...
    }
    /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab,&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;max_size&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item */
    power_largest = i;
    slabclass[power_largest].size = settings.item_size_max;
    slabclass[power_largest].perslab = <span class="number">1</span>;
    ...
}
</code></pre><p>&#x4ECE;&#x6E90;&#x7801;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#x540C;&#x4E00;&#x4E2A;slab&#x4E2D;&#x6240;&#x6709;&#x7684;item&#x7684;&#x5927;&#x5C0F;&#x90FD;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;</p>
<h3 id="&#x7533;&#x8BF7;slab&#x5185;&#x5B58;">&#x7533;&#x8BF7;slab&#x5185;&#x5B58;</h3><pre><code><span class="xml">static void *do_slabs_alloc(const size_t size, unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;
    <span class="variable">void</span> *<span class="variable">ret</span> = <span class="variable">NULL</span>;
    <span class="variable">item</span> *<span class="variable">it</span> = <span class="variable">NULL</span>;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> || <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; <span class="variable">power</span>_<span class="variable">largest</span>) { /* &amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">id</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5408;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5; */
        <span class="variable">MEMCACHED</span>_<span class="variable">SLABS</span>_<span class="variable">ALLOCATE</span>_<span class="variable">FAILED</span>(<span class="variable">size</span>, 0);
        <span class="variable">return</span> <span class="variable">NULL</span>;
    }</span><span class="xml">
    p = &amp;amp;slabclass[id]; /* &amp;#x83B7;&amp;#x53D6;slab */
    assert(p-&amp;gt;sl_curr == 0 || ((item *)p-&amp;gt;slots)-&amp;gt;slabs_clsid == 0);
    /* fail unless we have space at the end of a recently allocated page,
       we have something on our freelist, or we could allocate a new page */
    if (! (p-&amp;gt;sl_curr != 0 || do_slabs_newslab(id) != 0)) </span><span class="expression">{ /*&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">sl</span>_<span class="variable">curr</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CA</span>1;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>5269;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>59;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">newslab</span>&amp;<span class="begin-block">#x</span>7533;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;*/
        /* <span class="variable">We</span> <span class="variable">don</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">have</span> <span class="variable">more</span> <span class="variable">memory</span> <span class="variable">available</span> */
        <span class="variable">ret</span> = <span class="variable">NULL</span>;
    }</span><span class="xml"> else if (p-&amp;gt;sl_curr != 0) </span><span class="expression">{ /* &amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>672<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>8<span class="variable">BE</span>5;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>76;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#x</span>8<span class="variable">BE</span>5;<span class="variable">item</span> */
        /* <span class="variable">return</span> <span class="variable">off</span> <span class="variable">our</span> <span class="variable">freelist</span> */
        <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;
        <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>;
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;
        <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr--</span>;
        <span class="variable">ret</span> = (<span class="variable">void</span> *)<span class="variable">it</span>;
    }</span><span class="xml">
    ...
    return ret;
}</span>
</code></pre><p>sl_curr&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5BB9;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x9700;&#x8981;&#x8C03;&#x7528;do_slabs_newslab&#x6765;&#x7533;&#x8BF7;slab&#x7A7A;&#x95F4;&#x3002;</p>
<pre><code>static int do_slabs_newslab(const unsigned int id) {
    slabclass_t *p = &amp;amp;slabclass[id];
    int len = settings.slab_reassign ? settings.item_size_max
        : p-&amp;gt;size * p-&amp;gt;perslab;
    char *ptr;
    /* <span class="number">1.</span> &amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x9650</span>;&amp;<span class="symbol">#x5236</span>;
         <span class="number">2.</span> &amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;
         <span class="number">3.</span> &amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;slab-&amp;gt;size*slab-&amp;gt;perslab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;
         <span class="number">4.</span>&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;grow_slab_list&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5927</span>;slab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
    if ((mem_limit &amp;amp;&amp;amp; mem_malloced + len &amp;gt; mem_limit &amp;amp;&amp;amp; p-&amp;gt;slabs &amp;gt; <span class="number">0</span>) ||
        (grow_slab_list(id) == <span class="number">0</span>) ||
        ((ptr = memory_allocate((size_t)len)) == <span class="number">0</span>)) {
        <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED</span>(id);
        return <span class="number">0</span>;
    }
    memset(ptr, <span class="number">0</span>, (size_t)len);
    split_slab_page_into_freelist(ptr, id); /* &amp;<span class="symbol">#x628A</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5230</span>;slots&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>; */
    p-&amp;gt;slab_list[p-&amp;gt;slabs++] = ptr;
    mem_malloced += len;
    <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE</span>(id);
    return <span class="number">1</span>;
}
</code></pre><p>&#x7533;&#x8BF7;&#x7A7A;&#x95F4;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;split_slab_page_into_freelist&#x51FD;&#x6570;&#x628A;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5230;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x94FE;&#x8868;&#x4E2D;&#x3002;</p>
<pre><code><span class="xml">static void split_slab_page_into_freelist(char *ptr, const unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];
    <span class="variable">int</span> <span class="variable">x</span>;
    <span class="variable">for</span> (<span class="variable">x</span> = 0; <span class="variable">x</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">perslab</span>; <span class="variable">x</span>++) { /* &amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58; */
        <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, 0, <span class="variable">id</span>);
        <span class="variable">ptr</span> += <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>;
    }</span><span class="xml">
}
static void do_slabs_free(void *ptr, const size_t size, unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;
    <span class="variable">item</span> *<span class="variable">it</span>;
    <span class="variable">...</span>
    <span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];
    /* &amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>628<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>6302;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>5230;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>589<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>0;<span class="variable">sl</span>_<span class="variable">curr</span> */
    <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">ptr</span>;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> |= <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span> = <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = <span class="variable">it</span>;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it</span>;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr</span>++;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">requested</span> <span class="variable">-</span>= <span class="variable">size</span>;
    <span class="variable">return</span>;
}</span><span class="xml"></span>
</code></pre><h3 id="&#x83B7;&#x53D6;&#x9002;&#x5F53;&#x5927;&#x5C0F;&#x7684;item">&#x83B7;&#x53D6;&#x9002;&#x5F53;&#x5927;&#x5C0F;&#x7684;item</h3><p>&#x5728;do_item_alloc&#x4E2D;&#xFF0C;&#x8C03;&#x7528;&#x4E86;slabs_clsid&#x6765;&#x83B7;&#x53D6;&#x9002;&#x5408;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x5143;&#x7D20;&#x7684;slab id&#x3002;</p>
<pre><code>unsigned <span class="built_in">int</span> slabs_clsid(<span class="keyword">const</span> size_t <span class="built_in">size</span>) {
    <span class="built_in">int</span> res = POWER_SMALLEST;
    <span class="keyword">if</span> (<span class="built_in">size</span> == <span class="number">0</span>)
        <span class="keyword">return</span> <span class="number">0</span>;
    <span class="keyword">while</span> (<span class="built_in">size</span> &amp;gt; slabclass[res].<span class="built_in">size</span>)    <span class="comment">/* &amp;#x904D;&amp;#x5386;slabclass&amp;#x6765;&amp;#x627E;&amp;#x5230;&amp;#x9002;&amp;#x5408;size&amp;#x7684;item */</span>
        <span class="keyword">if</span> (res++ == power_largest)     <span class="comment">/* won&amp;apos;t fit in the biggest slab */</span>
            <span class="keyword">return</span> <span class="number">0</span>;
    <span class="keyword">return</span> res;
}
</code></pre><h2 id="&#x4F18;&#x7F3A;&#x70B9;">&#x4F18;&#x7F3A;&#x70B9;</h2><p>&#x5185;&#x5B58;&#x9884;&#x5206;&#x914D;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5185;&#x5B58;&#x788E;&#x7247;&#x4EE5;&#x53CA;&#x907F;&#x514D;&#x52A8;&#x6001;&#x5206;&#x914D;&#x9020;&#x6210;&#x7684;&#x5F00;&#x9500;&#x3002;</p>
<p>&#x5185;&#x5B58;&#x5206;&#x914D;&#x662F;&#x7531;&#x5197;&#x4F59;&#x7684;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;slab&#x4E0D;&#x80FD;&#x88AB;&#x5B83;&#x6240;&#x62E5;&#x6709;&#x7684;chunk&#x5927;&#x5C0F;&#x6574;&#x9664;&#x65F6;&#xFF0C;slab&#x5C3E;&#x90E8;&#x5269;&#x4F59;&#x7684;&#x7A7A;&#x95F4;&#x5C31;&#x4F1A;&#x88AB;&#x4E22;&#x5F03;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x5206;&#x914D;&#x7684;&#x662F;&#x7279;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x6709;&#x6548;&#x5730;&#x5229;&#x7528;&#x6240;&#x6709;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4F8B;&#x5982;&#x5982;&#x679C;&#x5C06;100&#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5728;128&#x5B57;&#x8282;&#x7684;chunk&#x4E2D;&#xFF0C;&#x4F1A;&#x9020;&#x6210;28&#x5B57;&#x8282;&#x7684;&#x6D6A;&#x8D39;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a><a href="/tags/链表/">链表</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23c1b1b/" title="Linux c 开发 - Memcached源码分析之HashTable（4） -" itemprop="url">Linux c 开发 - Memcached源码分析之HashTable（4） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x8BB2;&#x89E3;&#x4E86;Memcached&#x7684;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x673A;&#x5236;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF08;3&#xFF09;&#x300B;&#x3002;&#x4ECE;&#x8FD9;&#x4E00;&#x7AE0;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x6162;&#x6162;&#x8BB2;&#x89E3;Memcached&#x662F;&#x5982;&#x4F55;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x3002;</p>
<p>&#x8BB2;&#x89E3;&#x672C;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E2A;Memcached&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;item&#x7684;&#x57FA;&#x672C;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code><span class="xml">//item&amp;#x7684;&amp;#x5177;&amp;#x4F53;&amp;#x7ED3;&amp;#x6784;  
typedef struct _stritem </span><span class="expression">{  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;<span class="variable">HashTable</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">Item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;  
    //&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>1;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">set</span><span class="end-block">/add</span><span class="end-block">/replace</span>&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>66<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>57;&amp;<span class="begin-block">#x</span>6<span class="variable">BB</span>5;  
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">BD</span>4;&amp;<span class="begin-block">#x</span>8<span class="variable">F</span>83;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5931;&amp;<span class="begin-block">#x</span>6548;  
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* <span class="variable">least</span> <span class="variable">recent</span> <span class="variable">access</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>13;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>38;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>45;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>6548;&amp;<span class="begin-block">#x</span>3002;  
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">Memcached</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>6<span class="variable">DD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>70;  
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* <span class="variable">expire</span> <span class="variable">time</span> *<span class="end-block">/  </span>
    /<span class="end-block">/value</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* <span class="variable">size</span> <span class="variable">of</span> <span class="variable">data</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>3002;  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;<span class="variable">refcount</span>&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">refcount</span> <span class="variable">-</span>1 = 0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;  
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;  
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">length</span> <span class="variable">of</span> <span class="variable">flags-and-length</span> <span class="variable">string</span> *<span class="end-block">/  </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> *<span class="end-block">/  </span>
    /<span class="end-block">/slabs</span>_<span class="variable">class</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">ID</span>&amp;<span class="begin-block">#x</span>3002;  
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* <span class="variable">which</span> <span class="variable">slab</span> <span class="variable">class</span> <span class="variable">we</span>&amp;<span class="variable">apos</span>;<span class="variable">re</span> <span class="variable">in</span> *<span class="end-block">/  </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span> <span class="variable">length</span>, <span class="variable">w</span><span class="end-block">/terminating null and padding </span>*<span class="end-block">/  </span>
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span> 
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    <span class="variable">union</span> {  
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;  
        <span class="variable">char</span> <span class="variable">end</span>;  
    }</span><span class="xml"> data[];  
    /* if it_flags &amp;amp; ITEM_CAS we have 8 bytes CAS */  
    /* then null-terminated key */  
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
} item;</span>
</code></pre><p>&#x8BF4;&#x660E;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x4E0A;&#x5B58;&#x50A8;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;Item&#x7684;&#x7ED3;&#x6784;&#x3002;</p>
</li>
<li><p>Item&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x8BB0;&#x5F55;&#x4E0E;HashTable&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4EE5;&#x53CA;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;slabs_class&#xFF08;&#x540E;&#x9762;&#x51E0;&#x7AE0;&#x8282;&#x4F1A;&#x8BB2;&#x89E3;&#xFF09;&#x7684;&#x5173;&#x7CFB;&#x4EE5;&#x53CA;key&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x548C;&#x957F;&#x5EA6;&#x7B49;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>Item&#x5757;&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x5728;slabclass&#x4E0A;&#xFF0C;slabclass&#x4F1A;&#x5728;&#x4E0B;&#x4E0B;&#x7AE0;&#x8282;&#x4E2D;&#x8BE6;&#x7EC6;&#x8BB2;&#x89E3;&#x3002;</p>
</li>
<li><p>HashTable&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#xFF1A;&#x7528;&#x4E8E;&#x901A;&#x8FC7;key&#x5FEB;&#x901F;&#x67E5;&#x8BE2;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
</ol>
<p>Memcached&#x7684;HashTable&#x6E90;&#x7801;&#x5206;&#x6790;</p>
<p>HashTable&#x7ED3;&#x6784;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/23c0040.jpg" alt=""></p>
<p>&#x8BF4;&#x660E;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x9ED8;&#x8BA4;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;HashTable&#xFF0C;&#x8FD9;&#x4E2A;table&#x7684;&#x9ED8;&#x8BA4;&#x957F;&#x5EA6;&#x4E3A;65536&#x3002;</p>
</li>
<li><p>&#x6211;&#x4EEC;&#x5C06;&#x8FD9;&#x4E2A;HashTable&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x79F0;&#x4E3A;&#x6876;&#xFF0C;&#x6BCF;&#x4E2A;&#x6876;&#x5C31;&#x662F;&#x4E00;&#x4E2A;item&#x7ED3;&#x6784;&#x7684;&#x5355;&#x5411;&#x94FE;&#x8868;&#x3002;</p>
</li>
<li><p>Memcached&#x4F1A;&#x5C06;key&#x503C;hash&#x6210;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x540D;&#x79F0;&#x4E3A;hv&#x7684;uint32_t&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;hv&#x4E0E;&#x6876;&#x7684;&#x4E2A;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x6309;&#x4F4D;&#x4E0E;&#x8BA1;&#x7B97;&#xFF0C;hv &amp; hashmask(hashpower)&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x7684;key&#x4F1A;&#x843D;&#x5728;&#x54EA;&#x4E2A;&#x6876;&#x4E0A;&#x9762;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x4F1A;&#x5C06;item&#x6302;&#x5230;&#x8FD9;&#x4E2A;&#x6876;&#x7684;&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x3002;&#x94FE;&#x8868;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;item&#x7ED3;&#x6784;&#x4E2D;&#x7684;h_next&#x5B9E;&#x73B0;&#x3002;</p>
</li>
</ol>
<p>item_get - &#x7EE7;&#x7EED;&#x4ECE;get&#x65B9;&#x6CD5;&#x8BF4;&#x8D77;</p>
<p>&#x7ED3;&#x5408;&#x7B2C;&#x4E8C;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;Memcached get&#x7684;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;key &#x54C8;&#x5E0C;&#x6210;&#x4E00;&#x4E2A;uint32_t&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002;</p>
</li>
<li><p>&#x8C03;&#x7528;do_item_get&#x65B9;&#x6CD5;&#x3002;</p>
<p> //&#x8FD9;&#x8FB9;&#x7684;item_<em>&#x7CFB;&#x5217;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;Memcached&#x6838;&#x5FC3;&#x5B58;&#x50A8;&#x5757;&#x7684;&#x63A5;&#x53E3;<br> item </em>item_get(const char *key, const size_t nkey) {  </p>
<pre><code>item *it;  
uint32_t hv;  
hv = hash(key, nkey); //&amp;<span class="symbol">#x5BF9</span>;key&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;hash,&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;uint32_t&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
item_lock(hv); //&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4ED6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6027</span>;  
it = do_item_get(key, nkey, hv);  
item_unlock(hv);  
return it;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7EE7;&#x7EED;&#x770B;do_item_get&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x67E5;&#x8BE2;HashTable&#x4E0A;&#x7684;Item</p>
<pre><code><span class="comment">/** wrapper around assoc_find which does the lazy expiration logic */</span>  
item *do_item_get(<span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">size_t</span> nkey, <span class="keyword">const</span> <span class="keyword">uint32_t</span> hv) {  
    <span class="comment">//mutex_lock(&amp;amp;cache_lock);  </span>
    item *it = assoc_find(key, nkey, hv); <span class="comment">//hashTable&amp;#x4E0A;&amp;#x5B58;&amp;#x50A8;Item  </span>
    <span class="comment">//....more code  </span>
}
</code></pre><p>assoc.c - assoc_init &#x521D;&#x59CB;&#x5316;HashTable</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8FDB;&#x5165;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x540E;&#xFF0C;&#x53D1;&#x73B0;HashTable&#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x5728;assoc.c&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<ol>
<li><p>assoc_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3A;HashTable&#x521D;&#x59CB;&#x5316;&#xFF0C;assoc_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x5165;&#x53E3;&#x51FD;&#x6570;main&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x7684;&#x3002;</p>
</li>
<li><p>HashTable&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x4E3A;16&#xFF0C;1 &lt;&lt; 16&#x540E;&#x5F97;&#x5230;65536&#x4E2A;&#x6876;&#x3002;&#x5982;&#x679C;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x8BBE;&#x7F6E;&#xFF0C;&#x8BBE;&#x7F6E;&#x503C;&#x5728;12-64&#x4E4B;&#x95F4;&#x3002;</p>
</li>
<li><p>&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;memcached&#x7684;&#x6876;&#x7684;&#x4E2A;&#x6570;&#x8DB3;&#x591F;&#x4F7F;&#x7528;&#x4E86;&#x3002;</p>
<p> //&#x521D;&#x59CB;&#x5316;HahsTable&#x8868;<br> void assoc_init(const int hashtable_init) {  </p>
<pre><code>//&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>; hashtable_init&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">12</span> &amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">64</span>  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hashtable_init&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;hashpower&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">16</span>  
if (hashtable_init) {  
    hashpower = hashtable_init;  
}  
//primary_hashtable&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">HashTable</span>  
//hashsize&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hashpower=<span class="number">16</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">65536</span>  
primary_hashtable = calloc(hashsize(hashpower), sizeof(void *));  
if (! primary_hashtable) {  
    fprintf(stderr, &amp;quot;<span class="class">Failed</span> to init hashtable.\n&amp;quot;);  
    exit(<span class="class">EXIT_FAILURE</span>);  
}  
<span class="class">STATS_LOCK</span>();  
stats.hash_power_level = hashpower;  
stats.hash_bytes = hashsize(hashpower) * sizeof(void *);  
<span class="class">STATS_UNLOCK</span>();  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_find &#x67E5;&#x627E;&#x4E00;&#x4E2A;Item</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x904D;&#x5386;&#x6876;&#x7684;&#x5355;&#x94FE;&#x8868;&#xFF0C;&#x6BD4;&#x8F83;key&#x503C;&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;item</p>
<p> //&#x5BFB;&#x627E;&#x4E00;&#x4E2A;Item<br> item <em>assoc_find(const char </em>key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item *it;  
unsigned int oldbucket;  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;...  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    it = old_hashtable[oldbucket];  
} else {  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    it = primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
}  
item *ret = <span class="class">NULL</span>;  
int depth = <span class="number">0</span>; //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6DF1</span>;&amp;<span class="symbol">#x5EA6</span>;  
while (it) {  
    //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;list&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
    if ((nkey == it-&amp;gt;nkey) &amp;amp;&amp;amp; (memcmp(key, <span class="class">ITEM_key</span>(it), nkey) == <span class="number">0</span>)) {  
        ret = it;  
        break;  
    }  
    it = it-&amp;gt;h_next;  
    ++depth;  
}  
<span class="class">MEMCACHED_ASSOC_FIND</span>(key, nkey, depth);  
return ret;  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_insert &#x65B0;&#x589E;&#x4E00;&#x4E2A;Item</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x5C06;item&#x653E;&#x5230;&#x5BF9;&#x5E94;&#x6876;&#x7684;&#x5355;&#x94FE;&#x8868;&#x7684;&#x5934;&#x90E8;</p>
</li>
<li><p>&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x6269;&#x5BB9;&#xFF0C;&#x5982;&#x679C;&#x6269;&#x5BB9;&#xFF0C;&#x5219;&#x4F1A;&#x5728;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x3002;&#xFF08;&#x6876;&#x7684;&#x4E2A;&#x6570;(&#x9ED8;&#x8BA4;&#xFF1A;65536) * 3&#xFF09; / 2</p>
<p> //&#x65B0;&#x589E;Item&#x64CD;&#x4F5C;<br> int assoc_insert(item *it, const uint32_t hv) {  </p>
<pre><code>unsigned int oldbucket;  
assert(assoc_find(<span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) == <span class="number">0</span>);  /* shouldn&amp;apos;t have duplicately named things defined */  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5E8F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x65E7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    it-&amp;gt;h_next = old_hashtable[oldbucket];  
    old_hashtable[oldbucket] = it;  
} else {  
    //hv &amp;amp; hashmask(hashpower) &amp;<span class="symbol">#x6309</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E0E</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item-&amp;gt;h_next &amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;  
    it-&amp;gt;h_next = primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
    //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;hashtable&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x9875</span>;<span class="class">Item</span>&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x503C</span>;  
    primary_hashtable[hv &amp;amp; hashmask(hashpower)] = it;  
}  
hash_items++; //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hash_items&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;  &amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;(&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">65536</span>) * <span class="number">3</span>&amp;<span class="symbol">#xFF09</span>; / <span class="number">2</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
//&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x8EAB</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5FC5</span>;&amp;<span class="symbol">#x987B</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4F30</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x8017</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x957F</span>;  
if (! expanding &amp;amp;&amp;amp; hash_items &amp;gt; (hashsize(hashpower) * <span class="number">3</span>) / <span class="number">2</span>) {  
    assoc_start_expand();  
}  
<span class="class">MEMCACHED_ASSOC_INSERT</span>(<span class="class">ITEM_key</span>(it), it-&amp;gt;nkey, hash_items);  
return <span class="number">1</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_delete &#x5220;&#x9664;item&#x64CD;&#x4F5C;</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x627E;&#x5230;&#x6876;&#x5BF9;&#x5E94;&#x7684;&#x94FE;&#x8868;&#xFF0C;&#x904D;&#x5386;&#x5355;&#x94FE;&#x8868;&#xFF0C;&#x5220;&#x9664;&#x5BF9;&#x5E94;&#x7684;Item&#x3002;</p>
<p> //&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5BFB;&#x627E;<br> static item<em>* _hashitem_before (const char </em>key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item **pos;  
unsigned int oldbucket;  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    pos = &amp;amp;old_hashtable[oldbucket];  
} else {  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    pos = &amp;amp;primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
}  
//&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;list&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5339</span>;&amp;<span class="symbol">#x914D</span>;key&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">Item</span>  
while (*pos &amp;amp;&amp;amp; ((nkey != (*pos)-&amp;gt;nkey) || memcmp(key, <span class="class">ITEM_key</span>(*pos), nkey))) {  
    pos = &amp;amp;(*pos)-&amp;gt;h_next;  
}  
return pos;  
</code></pre><p> }<br> //&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x6876;&#x4E0A;&#x7684;Item<br> void assoc_delete(const char *key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item **before = _hashitem_before(key, nkey, hv); //&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;<span class="class">Item</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">Item</span>&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
if (*before) {  
    item *nxt;  
    hash_items--; //item&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>  
    /* <span class="class">The</span> <span class="class">DTrace</span> probe cannot be triggered as the last instruction 
     * due to possible tail-optimization by the compiler 
     */  
    <span class="class">MEMCACHED_ASSOC_DELETE</span>(key, nkey, hash_items);  
    nxt = (*before)-&amp;gt;h_next;  
    (*before)-&amp;gt;h_next = <span class="number">0</span>;   /* probably pointless, but whatever. */  
    *before = nxt;  
    return;  
}  
/* <span class="class">Note</span>:  we never actually get here.  the callers don&amp;apos;t delete things 
   they can&amp;apos;t find. */  
assert(*before != <span class="number">0</span>);  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - &#x5173;&#x4E8E;&#x6269;&#x5BB9;</p>
<p>Memcached&#x7684;&#x6269;&#x5BB9;&#x90FD;&#x662F;&#x5728;&#x5355;&#x72EC;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x7684;&#x3002;</p>
<p>&#xFF08;&#x6876;&#x7684;&#x4E2A;&#x6570;(&#x9ED8;&#x8BA4;&#xFF1A;65536) * 3&#xFF09; / 2&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x6269;&#x5BB9;&#x3002;&#x6269;&#x5BB9;&#x9700;&#x8981;&#x7684;&#x65F6;&#x95F4;&#x6BD4;&#x8F83;&#x4E45;&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#x8FDB;&#x884C;&#x81EA;&#x52A8;&#x6269;&#x5BB9;&#x5904;&#x7406;&#x3002;</p>
<pre><code>static void assoc_start_expand<span class="params">(void)</span> {  
    <span class="keyword">if</span> <span class="params">(started_expanding)</span>  
        return;  
    started_expanding = <span class="literal">true</span>;  
    <span class="comment">//&amp;#x5524;&amp;#x9192;&amp;#x7EBF;&amp;#x7A0B;  </span>
    pthread_cond_signal<span class="params">(&amp;amp;maintenance_cond)</span>;  
}  
<span class="comment">/* grows the hashtable to the next power of 2. */</span>  
<span class="comment">//&amp;#x6269;&amp;#x5BB9;&amp;#x65B9;&amp;#x6CD5;  </span>
static void assoc_expand<span class="params">(void)</span> {  
    old_hashtable = primary_hashtable;  
    primary_hashtable = calloc<span class="params">(hashsize<span class="params">(hashpower + <span class="number">1</span>)</span>, sizeof<span class="params">(void *)</span>)</span>;  
    <span class="keyword">if</span> <span class="params">(primary_hashtable)</span> {  
        <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">1</span>)</span>  
            fprintf<span class="params">(stderr, &amp;quot;Hash table expansion starting\n&amp;quot;)</span>;  
        hashpower++;  
        expanding = <span class="literal">true</span>;  
        expand_bucket = <span class="number">0</span>;  
        STATS_LOCK<span class="params">()</span>;  
        stats.hash_power_level = hashpower;  
        stats.hash_bytes += hashsize<span class="params">(hashpower)</span> <span class="built_in">*</span> sizeof<span class="params">(void *)</span>;  
        stats.hash_is_expanding = <span class="number">1</span>;  
        STATS_UNLOCK<span class="params">()</span>;  
    } <span class="keyword">else</span> {  
        primary_hashtable = old_hashtable;  
        <span class="comment">/* Bad news, but we can keep running. */</span>  
    }  
}  
static volatile int do_run_maintenance_thread = <span class="number">1</span>;  
<span class="built_in">#</span>define DEFAULT_HASH_BULK_MOVE <span class="number">1</span>  
int hash_bulk_move = DEFAULT_HASH_BULK_MOVE;  
static void <span class="built_in">*</span>assoc_maintenance_thread<span class="params">(void *arg)</span> {  
    while <span class="params">(do_run_maintenance_thread)</span> {  
        int ii = <span class="number">0</span>;  
        <span class="comment">/* Lock the cache, and bulk move multiple buckets to the new 
         * hash table. */</span>  
        item_lock_global<span class="params">()</span>;  
        mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="keyword">for</span> <span class="params">(ii = <span class="number">0</span>; ii &amp;lt; hash_bulk_move &amp;amp;&amp;amp; expanding; ++ii)</span> {  
            item <span class="built_in">*</span>it, <span class="built_in">*</span>next;  
            int bucket;  
            <span class="keyword">for</span> <span class="params">(it = old_hashtable[expand_bucket]; NULL != it; it = next)</span> {  
                next = it-&amp;gt;h_next;  
                bucket = hash<span class="params">(ITEM_key<span class="params">(it)</span>, it-&amp;gt;nkey)</span> &amp;amp; hashmask<span class="params">(hashpower)</span>;  
                it-&amp;gt;h_next = primary_hashtable[bucket];  
                primary_hashtable[bucket] = it;  
            }  
            old_hashtable[expand_bucket] = NULL;  
            expand_bucket++;  
            <span class="keyword">if</span> <span class="params">(expand_bucket == hashsize<span class="params">(hashpower - <span class="number">1</span>)</span>)</span> {  
                expanding = <span class="literal">false</span>;  
                free<span class="params">(old_hashtable)</span>;  
                STATS_LOCK<span class="params">()</span>;  
                stats.hash_bytes -= hashsize<span class="params">(hashpower - <span class="number">1</span>)</span> <span class="built_in">*</span> sizeof<span class="params">(void *)</span>;  
                stats.hash_is_expanding = <span class="number">0</span>;  
                STATS_UNLOCK<span class="params">()</span>;  
                <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">1</span>)</span>  
                    fprintf<span class="params">(stderr, &amp;quot;Hash table expansion done\n&amp;quot;)</span>;  
            }  
        }  
        mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        item_unlock_global<span class="params">()</span>;  
        <span class="keyword">if</span> <span class="params">(!expanding)</span> {  
            <span class="comment">/* finished expanding. tell all threads to use fine-grained locks */</span>  
            switch_item_lock_type<span class="params">(ITEM_LOCK_GRANULAR)</span>;  
            slabs_rebalancer_resume<span class="params">()</span>;  
            <span class="comment">/* We are done expanding.. just wait for next invocation */</span>  
            mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
            started_expanding = <span class="literal">false</span>;  
            pthread_cond_wait<span class="params">(&amp;amp;maintenance_cond, &amp;amp;cache_lock)</span>;  
            <span class="comment">/* Before doing anything, tell threads to use a global lock */</span>  
            mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            slabs_rebalancer_pause<span class="params">()</span>;  
            switch_item_lock_type<span class="params">(ITEM_LOCK_GLOBAL)</span>;  
            mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
            assoc_expand<span class="params">()</span>;  
            mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        }  
    }  
    return NULL;  
}  
static pthread_t maintenance_tid;  
int start_assoc_maintenance_thread<span class="params">()</span> {  
    int ret;  
    char <span class="built_in">*</span>env = getenv<span class="params">(&amp;quot;MEMCACHED_HASH_BULK_MOVE&amp;quot;)</span>;  
    <span class="keyword">if</span> <span class="params">(env != NULL)</span> {  
        hash_bulk_move = atoi<span class="params">(env)</span>;  
        <span class="keyword">if</span> <span class="params">(hash_bulk_move == <span class="number">0</span>)</span> {  
            hash_bulk_move = DEFAULT_HASH_BULK_MOVE;  
        }  
    }  
    <span class="keyword">if</span> <span class="params">(<span class="params">(ret = pthread_create<span class="params">(&amp;amp;maintenance_tid, NULL,  
                              assoc_maintenance_thread, NULL)</span>)</span> != <span class="number">0</span>)</span> {  
        fprintf<span class="params">(stderr, &amp;quot;Can&amp;apos;t create thread: %s\n&amp;quot;, strerror<span class="params">(ret)</span>)</span>;  
        return -<span class="number">1</span>;  
    }  
    return <span class="number">0</span>;  
}  
void stop_assoc_maintenance_thread<span class="params">()</span> {  
    mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
    do_run_maintenance_thread = <span class="number">0</span>;  
    pthread_cond_signal<span class="params">(&amp;amp;maintenance_cond)</span>;  
    mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
    <span class="comment">/* Wait for the maintenance thread to stop */</span>  
    pthread_join<span class="params">(maintenance_tid, NULL)</span>;  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2391c81/" title="libmc - 一个高效轻便的 C++/Python Memcached 客户端库 -" itemprop="url">libmc - 一个高效轻便的 C++/Python Memcached 客户端库 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><img src="http://taojinke.github.io/img/20150703/238e1e9.png" alt=""></p>
<p>libmc is a memcached client library for Python without any other dependencies in runtime. It&apos;s mainly written in C++ and Cython. libmc can be considered as a drop in replacement for <strong>libmemcached andpython-libmemcached</strong> . </p>
<p>libmc is developing and maintaining by Douban Inc. Currently, It is working in production environment, powering all web traffics in douban.com. Realtime <a href="https://travis-ci.org/douban/libmc/builds/57124335#L1611" target="_blank" rel="external">benchmark result</a> is available on travis. </p>
<h2 id="Build_and_Installation">Build and Installation</h2><p>For users:</p>
<pre><code>pip <span class="keyword">install</span> libmc
</code></pre><p>Usage:</p>
<pre><code><span class="preprocessor"><span class="keyword">import</span> libmc

mc = libmc.Client([&amp;apos;</span>localhost:<span class="number">11211</span>&amp;apos;, &amp;apos;localhost:<span class="number">11212</span>&amp;apos;])
mc.<span class="keyword">set</span>(&amp;apos;foo&amp;apos;, &amp;apos;bar&amp;apos;)
assert mc.<span class="keyword">get</span>(&amp;apos;foo&amp;apos;) == &amp;apos;bar&amp;apos;
</code></pre><h2 id="Under_the_hood">Under the hood</h2><p>Under the hood, libmc consists of 2 parts: an internal fully-functional memcached client implementation in C++ and a Cython wrapper around that implementation. Dynamic memory allocation and memory-copy are slow, so we tried our best to avoid them. The set_multi command is not natively supported by thememcached protocol. Some techniques are applied to make set_multi command extremely fast in libmc (compared to some other similiar libraries). </p>
<h2 id="Configuration">Configuration</h2><pre><code><span class="built_in">import</span> libmc
from libmc <span class="built_in">import</span> (
    MC_HASH_MD5, MC_POLL_TIMEOUT, MC_CONNECT_TIMEOUT, MC_RETRY_TIMEOUT
)
<span class="variable">mc =</span> libmc.Client(
    [&amp;apos;localhost:<span class="number">11211</span>&amp;apos;, &amp;apos;localhost:<span class="number">11212</span>&amp;apos;], <span class="variable">do_split=</span>True,
    <span class="variable">comp_threshold=</span><span class="number">0</span>, <span class="variable">noreply=</span>False, <span class="variable">prefix=</span>None,
    <span class="variable">hash_fn=</span>MC_HASH_MD5, <span class="variable">failover=</span>False
)
mc.config(MC_POLL_TIMEOUT, <span class="number">100</span>)  <span class="comment"># 100 ms</span>
mc.config(MC_CONNECT_TIMEOUT, <span class="number">300</span>)  <span class="comment"># 300 ms</span>
mc.config(MC_RETRY_TIMEOUT, <span class="number">5</span>)  <span class="comment"># 5 s</span>
</code></pre><ul>
<li>do_split : Memcached server will refuse to store value if size &gt;= 1MB, if do_split is enabled, large value (&lt; 10 MB) will be splitted into several blocks. If the value is too large (&gt;= 10 MB), it will not be stored. default: True</li>
<li>comp_threshold : All kinds of values will be encoded into string buffer. If buffer length &gt; comp_threshold &gt; 0 , it will be compressed using zlib. If comp_threshold = 0 , string buffer will never be compressed using zlib. default:</li>
<li>noreply : Whether to enable memcached&apos;s noreply behaviour. default: False</li>
<li>prefix : The key prefix. default: &apos;&apos;</li>
<li>hash_fn : hashing function for keys. possible values: </li>
</ul>
<ul>
<li>MC_HASH_MD5</li>
<li>MC_HASH_FNV1_32</li>
<li>MC_HASH_FNV1A_32</li>
<li>MC_HASH_CRC_32</li>
</ul>
<p>default: MC_HASH_MD5</p>
<p>NOTE:fnv1_32, fnv1a_32, crc_32 implementations in libmc are per each spec, but they&apos;re not compatible with corresponding implementions in libmemcached.</p>
<ul>
<li>failover : Whether to failover to next server when current server is not available. default: False</li>
<li>MC_POLL_TIMEOUT Timeout parameter used during set/get procedure. (default:ms)</li>
<li>MC_CONNECT_TIMEOUT Timeout parameter used when connecting to memcached server on initial phase. (default:ms)</li>
<li>MC_RETRY_TIMEOUT When a server is not available dur to server-end error. libmc will try to establish the broken connection in every MC_RETRY_TIMEOUT s until the connection is back to live.(default:s)</li>
</ul>
<p>NOTE:The hashing algorithm for host mapping on continuum is always md5. </p>
<h2 id="Contributing_to_libmc">Contributing to libmc</h2><p>Feel free to send a <strong>Pull Request</strong> . For feature requests or any questions, please open an <strong>Issue</strong> . </p>
<p>For <strong>SECURITY DISCLOSURE</strong> , please disclose the information responsibly by sending an email to <a href="mailto:security@douban.com" target="_blank" rel="external">security@douban.com</a> directly instead of creating a GitHub issue. </p>
<h4 id="Does_libmc_support_PHP?">Does libmc support PHP?</h4><p>No. But if you like, you can write a wrapper for PHP based on the C++ implementation.</p>
<h4 id="Is_Memcached_binary_protocol_supported_?">Is Memcached binary protocol supported ?</h4><p>No. Only Memcached ASCII protocol is supported currently.</p>
<h4 id="Why_reinventing_the_wheel?">Why reinventing the wheel?</h4><p>Before libmc, we&apos;re usingpython-libmemcached, which is a python extention for <a href="http://libmemcached.org/libMemcached.html" target="_blank" rel="external">libmemcached</a> . libmemcached is quite weird and buggy. After nearly one decade, there&apos;re still some unsolved bugs. </p>
<h4 id="Is_libmc_thread-safe_?">Is libmc thread-safe ?</h4><p>libmc is a single-threaded memcached client. If you initialize a libmc client in one thread but reuse that in another thread, a Python Exception ThreadUnsafe will raise in Python. </p>
<h4 id="Is_libmc_compatible_with_gevent?">Is libmc compatible with gevent?</h4><p>Yes, with the help ofgreenify, libmc is friendly to gevent. Read tests/shabby/gevent_issue.py for details. </p>
<h2 id="Acknowledgments">Acknowledgments</h2><ul>
<li>Thanks to@fahrenheit2539 and the llvm project for the standalone. <a href="http://fahrenheit2539.blogspot.com/2012/06/introduction-in-depths-look-at.html" target="_blank" rel="external">SmallVector</a> implementation.</li>
<li>Thanks to@miloyip for the high performancei64toa implementation.</li>
<li>Thanks to <a href="https://twitter.com/d0znpp" target="_blank" rel="external">Ivan Novikov</a> for the research in <a href="https://www.blackhat.com/us-14/briefings.html#the-new-page-of-injections-book-memcached-injections" target="_blank" rel="external">THE NEW PAGE OF INJECTIONS BOOK: MEMCACHED INJECTIONS</a> .</li>
<li>Thanks to the PolarSSL project for the md5 implementation.</li>
<li>Thanks to@lericson for the <a href="https://github.com/lericson/pylibmc/blob/master/bin/runbench.py" target="_blank" rel="external">benchmark script in pylibmc</a> .</li>
<li>Thanks to the libmemcached project and some other projects possibly not mentioned here.</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/C/">C++</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/14/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/59/">59</a><a class="extend next" rel="next" href="/page/16/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>587</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>32</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>23</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Ubuntu/" title="Ubuntu">Ubuntu<sup>9</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
