
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/18/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23c66ca/" title="memcache（三）内存管理 -" itemprop="url">memcache（三）内存管理 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="memcached&#xFF08;&#x4E09;&#xFF09;&#x5185;&#x5B58;&#x7BA1;&#x7406;">memcached&#xFF08;&#x4E09;&#xFF09;&#x5185;&#x5B58;&#x7BA1;&#x7406;</h2><p>memcached&#x4F7F;&#x7528;&#x9884;&#x7533;&#x8BF7;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x7BA1;&#x7406;&#x5185;&#x5B58;&#x7684;&#x5206;&#x914D;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x5185;&#x5B58;&#x788E;&#x7247;&#x5316;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5982;&#x679C;&#x91C7;&#x7528;mallo&#x548C;free&#x6765;&#x52A8;&#x6001;&#x7684;&#x7533;&#x8BF7;&#x548C;&#x9500;&#x6BC1;&#x5185;&#x5B58;&#xFF0C;&#x5FC5;&#x7136;&#x4F1A;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x7684;&#x5185;&#x5B58;&#x788E;&#x7247;&#x3002;</p>
<h2 id="&#x57FA;&#x672C;&#x77E5;&#x8BC6;">&#x57FA;&#x672C;&#x77E5;&#x8BC6;</h2><p>slab&#xFF1A;&#x5185;&#x5B58;&#x5757;&#x662F;memcached&#x4E00;&#x6B21;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x5143;&#xFF0C;&#x5728;memcached&#x4E2D;&#x4E00;&#x4E2A;slab&#x7684;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;1M&#xFF1B;</p>
<p>slabclass&#xFF1A;&#x7279;&#x5B9A;&#x5927;&#x5C0F;&#x7684;chunk&#x7684;&#x7EC4;&#x3002;</p>
<p>chunk&#xFF1A;&#x7F13;&#x5B58;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x4E00;&#x4E2A;slab&#x88AB;&#x5212;&#x5206;&#x4E3A;&#x82E5;&#x5E72;&#x4E2A;chunk&#xFF1B;</p>
<p>item&#xFF1A;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x5143;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;chunk&#x90FD;&#x4F1A;&#x5305;&#x542B;&#x4E00;&#x4E2A;item&#xFF1B;</p>
<p>factor:&#x589E;&#x957F;&#x56E0;&#x5B50;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;1.25&#xFF0C;&#x76F8;&#x90BB;slab&#x4E2D;&#x7684;item&#x5927;&#x5C0F;&#x4E0E;factor&#x6210;&#x6BD4;&#x4F8B;&#x5173;&#x7CFB;&#xFF1B;</p>
<h2 id="&#x57FA;&#x672C;&#x539F;&#x7406;">&#x57FA;&#x672C;&#x539F;&#x7406;</h2><p>memcached&#x4F7F;&#x7528;&#x9884;&#x5206;&#x914D;&#x65B9;&#x6CD5;&#xFF0C;&#x907F;&#x514D;&#x9891;&#x7E41;&#x7684;&#x8C03;&#x7528;malloc&#x548C;free&#xFF1B;</p>
<p>memcached&#x901A;&#x8FC7;&#x4E0D;&#x540C;&#x7684;slab&#x6765;&#x7BA1;&#x7406;&#x4E0D;&#x540C;chunk&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x4ECE;&#x800C;&#x6EE1;&#x8DB3;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>slab&#x7684;&#x7533;&#x8BF7;&#x662F;&#x901A;&#x8FC7;&#x5728;&#x4F7F;&#x7528;item&#x65F6;&#x7533;&#x8BF7;slab&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x628A;&#x5185;&#x5B58;&#x5207;&#x5272;&#x4E3A;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x7684;item&#xFF0C;&#x6302;&#x5728;&#x5230;slab&#x7684;&#x672A;&#x4F7F;&#x7528;&#x94FE;&#x8868;&#x4E0A;&#x3002;</p>
<p>&#x8FC7;&#x671F;&#x548C;&#x88AB;&#x5220;&#x9664;item&#x5E76;&#x4E0D;&#x4F1A;&#x88AB;free&#x6389;&#xFF0C;memcached&#x5E76;&#x4E0D;&#x4F1A;&#x5220;&#x9664;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF1B;</p>
<p>Memcached&#x4F1A;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x5DF2;&#x8D85;&#x65F6;&#x7684;&#x8BB0;&#x5F55;&#x7A7A;&#x95F4;&#xFF0C;&#x901A;&#x8FC7;LRU&#x7B97;&#x6CD5;&#xFF1B;</p>
<p>memcached&#x4F7F;&#x7528;lazy expiration&#xFFFD;&#xFFFD;&#xFFFD;&#x5224;&#x65AD;&#x5143;&#x7D20;&#x662F;&#x5426;&#x8FC7;&#x671F;&#xFF0C;&#x6240;&#x4EE5;&#x8FC7;&#x671F;&#x76D1;&#x89C6;&#x4E0A;&#x4E0D;&#x4F1A;&#x5360;&#x7528;cpu&#x65F6;&#x95F4;&#x3002;</p>
<h2 id="&#x6E90;&#x7801;&#x5206;&#x6790;">&#x6E90;&#x7801;&#x5206;&#x6790;</h2><p>&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5206;&#x6790;memcached&#x7684;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x548C;&#x5B58;&#x50A8;&#x76F8;&#x5173;&#x4EE3;&#x7801;&#x3002;</p>
<h3 id="item">item</h3><p>item&#x662F;key/value&#x7684;&#x5B58;&#x50A8;&#x5355;&#x5143;&#x3002;</p>
<pre><code><span class="xml">typedef struct _stritem </span><span class="expression">{
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;      /* &amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;<span class="variable">slab-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>; */
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;    /* <span class="variable">hash</span> <span class="variable">chain</span> <span class="variable">next</span> */
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* &amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4; */
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* &amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4; */
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* &amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>; */
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;   /* &amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570; */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">suffix</span>&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6; */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* &amp;<span class="begin-block">#x</span>6240;&amp;<span class="begin-block">#x</span>6709;<span class="variable">slab</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">id</span> */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span>&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6; */
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span>
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> */
    <span class="variable">union</span> {
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;
        <span class="variable">char</span> <span class="variable">end</span>;
    }</span><span class="xml"> data[]; /* cas|key|suffix|value */
} item;</span>
</code></pre><h3 id="slab&#x521D;&#x59CB;&#x5316;">slab&#x521D;&#x59CB;&#x5316;</h3><pre><code>void slabs_init(const size_t limit, const double factor, const bool prealloc) {
    int i = <span class="class">POWER_SMALLEST</span> - <span class="number">1</span>;
    unsigned int size = sizeof(item) + settings.chunk_size; /* &amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
    mem_limit = limit;
    if (prealloc) { /* &amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>; */
        ...
    }
    memset(slabclass, <span class="number">0</span>, sizeof(slabclass)); /* &amp;<span class="symbol">#x628A</span>;slabclass&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;slabclass&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;slab&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>; */
    while (++i &amp;lt; <span class="class">POWER_LARGEST</span> &amp;amp;&amp;amp; size &amp;lt;= settings.item_size_max / factor) {  /* &amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5BB9</span>;,&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;slab&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;max_size/factor */
        /* <span class="class">Make</span> sure items are always n-byte aligned */
        if (size % <span class="class">CHUNK_ALIGN_BYTES</span>)  /* &amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x9F50</span>; */
            size += <span class="class">CHUNK_ALIGN_BYTES</span> - (size % <span class="class">CHUNK_ALIGN_BYTES</span>);
        slabclass[i].size = size; /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;slabclass&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
        slabclass[i].perslab = settings.item_size_max / slabclass[i].size; /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x91CF</span>; */
        size *= factor;  /* item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x968F</span>;factor&amp;<span class="symbol">#x9010</span>;&amp;<span class="symbol">#x6E10</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x5927</span>; */
        ...
    }
    /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab,&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;max_size&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item */
    power_largest = i;
    slabclass[power_largest].size = settings.item_size_max;
    slabclass[power_largest].perslab = <span class="number">1</span>;
    ...
}
</code></pre><p>&#x4ECE;&#x6E90;&#x7801;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#x540C;&#x4E00;&#x4E2A;slab&#x4E2D;&#x6240;&#x6709;&#x7684;item&#x7684;&#x5927;&#x5C0F;&#x90FD;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;</p>
<h3 id="&#x7533;&#x8BF7;slab&#x5185;&#x5B58;">&#x7533;&#x8BF7;slab&#x5185;&#x5B58;</h3><pre><code><span class="xml">static void *do_slabs_alloc(const size_t size, unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;
    <span class="variable">void</span> *<span class="variable">ret</span> = <span class="variable">NULL</span>;
    <span class="variable">item</span> *<span class="variable">it</span> = <span class="variable">NULL</span>;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> || <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; <span class="variable">power</span>_<span class="variable">largest</span>) { /* &amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">id</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5408;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5; */
        <span class="variable">MEMCACHED</span>_<span class="variable">SLABS</span>_<span class="variable">ALLOCATE</span>_<span class="variable">FAILED</span>(<span class="variable">size</span>, 0);
        <span class="variable">return</span> <span class="variable">NULL</span>;
    }</span><span class="xml">
    p = &amp;amp;slabclass[id]; /* &amp;#x83B7;&amp;#x53D6;slab */
    assert(p-&amp;gt;sl_curr == 0 || ((item *)p-&amp;gt;slots)-&amp;gt;slabs_clsid == 0);
    /* fail unless we have space at the end of a recently allocated page,
       we have something on our freelist, or we could allocate a new page */
    if (! (p-&amp;gt;sl_curr != 0 || do_slabs_newslab(id) != 0)) </span><span class="expression">{ /*&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">sl</span>_<span class="variable">curr</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CA</span>1;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>5269;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>59;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">newslab</span>&amp;<span class="begin-block">#x</span>7533;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;*/
        /* <span class="variable">We</span> <span class="variable">don</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">have</span> <span class="variable">more</span> <span class="variable">memory</span> <span class="variable">available</span> */
        <span class="variable">ret</span> = <span class="variable">NULL</span>;
    }</span><span class="xml"> else if (p-&amp;gt;sl_curr != 0) </span><span class="expression">{ /* &amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>672<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>8<span class="variable">BE</span>5;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>76;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#x</span>8<span class="variable">BE</span>5;<span class="variable">item</span> */
        /* <span class="variable">return</span> <span class="variable">off</span> <span class="variable">our</span> <span class="variable">freelist</span> */
        <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;
        <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>;
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;
        <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr--</span>;
        <span class="variable">ret</span> = (<span class="variable">void</span> *)<span class="variable">it</span>;
    }</span><span class="xml">
    ...
    return ret;
}</span>
</code></pre><p>sl_curr&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5BB9;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x9700;&#x8981;&#x8C03;&#x7528;do_slabs_newslab&#x6765;&#x7533;&#x8BF7;slab&#x7A7A;&#x95F4;&#x3002;</p>
<pre><code>static int do_slabs_newslab(const unsigned int id) {
    slabclass_t *p = &amp;amp;slabclass[id];
    int len = settings.slab_reassign ? settings.item_size_max
        : p-&amp;gt;size * p-&amp;gt;perslab;
    char *ptr;
    /* <span class="number">1.</span> &amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x9650</span>;&amp;<span class="symbol">#x5236</span>;
         <span class="number">2.</span> &amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;
         <span class="number">3.</span> &amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;slab-&amp;gt;size*slab-&amp;gt;perslab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;
         <span class="number">4.</span>&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;grow_slab_list&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5927</span>;slab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
    if ((mem_limit &amp;amp;&amp;amp; mem_malloced + len &amp;gt; mem_limit &amp;amp;&amp;amp; p-&amp;gt;slabs &amp;gt; <span class="number">0</span>) ||
        (grow_slab_list(id) == <span class="number">0</span>) ||
        ((ptr = memory_allocate((size_t)len)) == <span class="number">0</span>)) {
        <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED</span>(id);
        return <span class="number">0</span>;
    }
    memset(ptr, <span class="number">0</span>, (size_t)len);
    split_slab_page_into_freelist(ptr, id); /* &amp;<span class="symbol">#x628A</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5230</span>;slots&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>; */
    p-&amp;gt;slab_list[p-&amp;gt;slabs++] = ptr;
    mem_malloced += len;
    <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE</span>(id);
    return <span class="number">1</span>;
}
</code></pre><p>&#x7533;&#x8BF7;&#x7A7A;&#x95F4;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;split_slab_page_into_freelist&#x51FD;&#x6570;&#x628A;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5230;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x94FE;&#x8868;&#x4E2D;&#x3002;</p>
<pre><code><span class="xml">static void split_slab_page_into_freelist(char *ptr, const unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];
    <span class="variable">int</span> <span class="variable">x</span>;
    <span class="variable">for</span> (<span class="variable">x</span> = 0; <span class="variable">x</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">perslab</span>; <span class="variable">x</span>++) { /* &amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58; */
        <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, 0, <span class="variable">id</span>);
        <span class="variable">ptr</span> += <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>;
    }</span><span class="xml">
}
static void do_slabs_free(void *ptr, const size_t size, unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;
    <span class="variable">item</span> *<span class="variable">it</span>;
    <span class="variable">...</span>
    <span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];
    /* &amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>628<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>6302;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>5230;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>589<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>0;<span class="variable">sl</span>_<span class="variable">curr</span> */
    <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">ptr</span>;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> |= <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span> = <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = <span class="variable">it</span>;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it</span>;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr</span>++;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">requested</span> <span class="variable">-</span>= <span class="variable">size</span>;
    <span class="variable">return</span>;
}</span><span class="xml"></span>
</code></pre><h3 id="&#x83B7;&#x53D6;&#x9002;&#x5F53;&#x5927;&#x5C0F;&#x7684;item">&#x83B7;&#x53D6;&#x9002;&#x5F53;&#x5927;&#x5C0F;&#x7684;item</h3><p>&#x5728;do_item_alloc&#x4E2D;&#xFF0C;&#x8C03;&#x7528;&#x4E86;slabs_clsid&#x6765;&#x83B7;&#x53D6;&#x9002;&#x5408;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x5143;&#x7D20;&#x7684;slab id&#x3002;</p>
<pre><code>unsigned <span class="built_in">int</span> slabs_clsid(<span class="keyword">const</span> size_t <span class="built_in">size</span>) {
    <span class="built_in">int</span> res = POWER_SMALLEST;
    <span class="keyword">if</span> (<span class="built_in">size</span> == <span class="number">0</span>)
        <span class="keyword">return</span> <span class="number">0</span>;
    <span class="keyword">while</span> (<span class="built_in">size</span> &amp;gt; slabclass[res].<span class="built_in">size</span>)    <span class="comment">/* &amp;#x904D;&amp;#x5386;slabclass&amp;#x6765;&amp;#x627E;&amp;#x5230;&amp;#x9002;&amp;#x5408;size&amp;#x7684;item */</span>
        <span class="keyword">if</span> (res++ == power_largest)     <span class="comment">/* won&amp;apos;t fit in the biggest slab */</span>
            <span class="keyword">return</span> <span class="number">0</span>;
    <span class="keyword">return</span> res;
}
</code></pre><h2 id="&#x4F18;&#x7F3A;&#x70B9;">&#x4F18;&#x7F3A;&#x70B9;</h2><p>&#x5185;&#x5B58;&#x9884;&#x5206;&#x914D;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5185;&#x5B58;&#x788E;&#x7247;&#x4EE5;&#x53CA;&#x907F;&#x514D;&#x52A8;&#x6001;&#x5206;&#x914D;&#x9020;&#x6210;&#x7684;&#x5F00;&#x9500;&#x3002;</p>
<p>&#x5185;&#x5B58;&#x5206;&#x914D;&#x662F;&#x7531;&#x5197;&#x4F59;&#x7684;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;slab&#x4E0D;&#x80FD;&#x88AB;&#x5B83;&#x6240;&#x62E5;&#x6709;&#x7684;chunk&#x5927;&#x5C0F;&#x6574;&#x9664;&#x65F6;&#xFF0C;slab&#x5C3E;&#x90E8;&#x5269;&#x4F59;&#x7684;&#x7A7A;&#x95F4;&#x5C31;&#x4F1A;&#x88AB;&#x4E22;&#x5F03;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x5206;&#x914D;&#x7684;&#x662F;&#x7279;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x6709;&#x6548;&#x5730;&#x5229;&#x7528;&#x6240;&#x6709;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4F8B;&#x5982;&#x5982;&#x679C;&#x5C06;100&#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5728;128&#x5B57;&#x8282;&#x7684;chunk&#x4E2D;&#xFF0C;&#x4F1A;&#x9020;&#x6210;28&#x5B57;&#x8282;&#x7684;&#x6D6A;&#x8D39;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a><a href="/tags/链表/">链表</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2359a11/" title="论实现序列化的在云端的必要性 -" itemprop="url">论实现序列化的在云端的必要性 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5BF9;&#x4E8E;java&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x91CD;&#x8981;&#x6027;&#xFF0C;&#x5728;&#x5355;&#x673A;&#x7A0B;&#x5E8F;&#x5185;&#x662F;&#x4E0D;&#x592A;&#x5BB9;&#x6613;&#x88AB;&#x91CD;&#x89C6;&#x7684;&#xFF0C;&#x5728;&#x672C;&#x5730;&#x8C03;&#x8BD5;&#x4E2D;&#xFF0C;tomacat&#x81EA;&#x52A8;&#x4E3A;&#x4E3A;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x7A0B;&#x5E8F;&#x5B9E;&#x73B0;&#x4E86;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x800C;&#x4E14;bean(&#x7528;&#x6765;&#x5B9E;&#x73B0;&#x7F13;&#x5B58;&#x7684;java&#x7A0B;&#x5E8F;)&#x592A;&#x5C0F;&#xFF0C;&#x4E0D;&#x4F1A;&#x51FA;&#x73B0;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x4E00;&#x65E6;&#x90E8;&#x7F72;&#x5230;&#x4E91;&#x7AEF;&#xFF0C;&#x9EBB;&#x70E6;&#x5C31;&#x51FA;&#x73B0;&#x4E86;&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;session&#x4E3A;&#x4EC0;&#x4E48;&#x5B58;&#x4E0D;&#x8FDB;&#x503C;&#x5462;?&#x4E0D;&#x4E45;&#x524D;&#x6211;&#x5728;&#x65B0;&#x6D6A;&#x4E91;&#x4E91;&#x7AEF;&#x90E8;&#x7F72;session&#x5C31;&#x51FA;&#x73B0;&#x4E86;&#x672A;&#x80FD;&#x53D6;&#x4E0D;&#x5230;&#x503C;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/23577e3.jpg" alt=""></p>
<p>&#x9488;&#x5BF9;&#x65B0;&#x6D6A;&#x4E91;&#x670D;&#x52A1;&#x5668;&#xFF0C;session&#x7684;&#x4FE1;&#x606F;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5206;&#x5E03;&#x5F0F;Memcache&#x5B58;&#x50A8;&#x3002;</p>
<p>&#x800C;Memcache&#x5B58;&#x50A8;&#x5462;?</p>
<p>&#x4E0D;&#x5C11;&#x60F3;&#x6784;&#x5EFA;&#x5927;&#x8D1F;&#x8F7D;&#x7684;&#x7F51;&#x7AD9;&#x90FD;&#x91C7;&#x53D6;Memcache&#x6765;&#x5206;&#x62C5;&#x6570;&#x636E;&#x5E93;&#x7684;&#x538B;&#x529B;&#x3002;</p>
<p>Memcache&#x9996;&#x5148;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x5185;&#x5B58;&#x4E2D;&#x5F00;&#x8F9F;&#x4E00;&#x4E2A;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;hash&#x8868;&#x3002;</p>
<p>memcache &#x4EE5;&#x5B88;&#x62A4;&#x7A0B;&#x5E8F;&#x7684;&#x5F62;&#x5F0F;&#x8FD0;&#x884C;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;(&#x4E00;&#x4E2A;&#x6216;&#x8005;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x5668;)&#xFF0C;&#x968F;&#x65F6;&#x63A5;&#x53D7;&#x6765;&#x81EA;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x5B58;&#x53D6;&#x6570;&#x636E;&#xFF0C;Memcache&#x662F;&#x4E00;&#x6B3E;nosql&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x3002;&#x91C7;&#x7528;&#x7684;&#x662F;&#x952E;&#x503C;&#x5B58;&#x50A8;&#xFF0C;&#x6BCF;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x5B58;&#x5165;&#x7684;&#x5BF9;&#x8C61;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;key&#x3002;&#x4F46;&#x662F;&#x5BF9;&#x8C61;&#x662F;&#x6CA1;&#x529E;&#x6CD5;&#x6301;&#x4E45;&#x5316;&#x7684;&#xFF0C;&#x8DDF;memcache&#x5F88;&#x76F8;&#x4F3C;&#x7684;redis&#x662F;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x6301;&#x4E45;&#x5316;&#x5230;&#x786C;&#x76D8;&#x7684;&#x3002;&#x7136;&#x540E;&#x628A;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;&#x4EE5;key-value&#x7684;&#x5F62;&#x5F0F;&#x4FDD;&#x5B58;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#xFF0C;value&#x503C;&#x5B58;&#x5165;key&#x503C;hash&#x8F6C;&#x5316;&#x540E;&#x7684;&#x5BF9;&#x5E94;&#x7684;&#x67D0;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;&#x53D6;&#x503C;&#x7684;&#x65F6;&#x5019;&#x901A;&#x8FC7;&#x540C;&#x6837;&#x7684;&#x8F6C;&#x5316;&#x540E;&#x5BF9;&#x54CD;&#x5E94;&#xFFFD;&#xFFFD;&#xFFFD;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x4ED8;&#x51FA;&#x8BF7;&#x6C42;&#x5373;&#x53EF;&#x3002;</p>
<p>&#x800C;&#x5728;&#x5E8F;&#x5217;&#x5316;&#x5728;&#x5728;&#x5176;&#x4E2D;&#x8D77;&#x5230;&#x4EC0;&#x4E48;&#x4F5C;&#x7528;&#x5462;?</p>
<p>&#x5728;memcache&#x7F13;&#x5B58;&#x5230;&#x5185;&#x5B58;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5230;&#x5E8F;&#x5217;&#x5316;&#x5B58;&#x50A8;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5982;&#x679C;&#x4F60;&#x7684;bean&#x5305;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x6CA1;&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x63A5;&#x53E3;&#xFF0C;&#x5728;&#x7F13;&#x5B58;&#x7684;&#x65F6;&#x5019;&#x662F;&#x4E0D;&#x4F1A;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x9020;&#x6210;&#x4E86;session&#x5E76;&#x6CA1;&#x6709;&#x5B58;&#x503C;&#x7684;&#x95EE;&#x9898;&#x53D1;&#x751F;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5728;&#x90E8;&#x7F72;&#x5230;&#x65B0;&#x6D6A;&#x4E91;&#x7684;&#x7A0B;&#x5E8F;&#x5B58;&#x50A8;&#x5230;session&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x63A5;&#x53E3;&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;session&#x5B58;&#x50A8;&#x7684;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/235b9ce/" title="memcached 1.4.23 发布，集中式缓存系统 -" itemprop="url">memcached 1.4.23 发布，集中式缓存系统 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.oschina.net/news/61534/oschina-opensource-collection-plan-for-it-companies" target="_blank" rel="external">&#x5F00;&#x6E90;&#x4E2D;&#x56FD;&#x7684; IT &#x516C;&#x53F8;&#x5F00;&#x6E90;&#x8F6F;&#x4EF6;&#x6574;&#x7406;&#x8BA1;&#x5212;&#x4ECB;&#x7ECD;</a></p>
<p>memcached 1.4.23 &#x53D1;&#x5E03;&#xFF0C;&#x6B64;&#x7248;&#x672C;&#x73B0;&#x5DF2;&#x63D0;&#x4F9B;&#x4E0B;&#x8F7D;&#xFF1A; <a href="http://www.memcached.org/files/memcached-1.4.23.tar.gz" target="_blank" rel="external">http://www.memcached.org/files/memcached-1.4.23.tar.gz</a> &#x3002; </p>
<p>&#x6B64;&#x7248;&#x672C;&#x66F4;&#x65B0;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<h3 id="Bug_&#x4FEE;&#x590D;">Bug &#x4FEE;&#x590D;</h3><ul>
<li>spinlocks removed since they never seem to improve performance.</li>
<li>flush_all was not thread safe.</li>
<li>better handle items refcounted in tail by unlinking them from the LRU&apos;s</li>
</ul>
<h3 id="&#x65B0;&#x7279;&#x6027;">&#x65B0;&#x7279;&#x6027;</h3><p>&#x91CD;&#x5199;&#x4E86; memcached &#x7684;&#x6838;&#x5FC3; LRU &#x7B97;&#x6CD5;&#xFF1A;</p>
<ul>
<li>global cache_lock is gone, LRU&apos;s are now independently locked.</li>
<li>LRU&apos;s are now split between HOT, WARM, and COLD LRU&apos;s. New items enter the HOT LRU.</li>
<li>LRU updates only happen as items reach the bottom of an LRU. If active in HOT, stay in HOT, if active in WARM, stay in WARM. If active in COLD, move to WARM.</li>
<li>HOT/WARM each capped at 32% of memory available for that slab class. COLD is uncapped.</li>
<li>Items flow from HOT/WARM into COLD.</li>
<li>A background thread exists which shuffles items between/within the LRU&apos;s as capacities are reached.</li>
</ul>
<p>&#x4E3B;&#x8981;&#x76EE;&#x6807;&#x662F;&#x4FDD;&#x62A4;&#x201C;scanning&#x201D;&#x7684; active items&#xFF0C;&#x5176;&#x6B21;&#x662F;&#x4E3A;&#x4E86;&#x6539;&#x8FDB;&#x5EF6;&#x8FDF;&#x3002;</p>
<p>&#x66F4;&#x591A;&#x6539;&#x8FDB;&#x5185;&#x5BB9;&#x8BF7;&#x770B; <a href="https://code.google.com/p/memcached/wiki/ReleaseNotes1423" target="_blank" rel="external">&#x53D1;&#x884C;&#x8BF4;&#x660E;</a> &#x3002; </p>
<p>memcached&#x662F;&#x4E00;&#x5957;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x5FEB;&#x53D6;&#x7CFB;&#x7EDF;&#xFF0C;&#x5F53;&#x521D;&#x662F;Danga Interactive&#x4E3A;&#x4E86;LiveJournal&#x6240;&#x53D1;&#x5C55;&#x7684;&#xFF0C;&#x4F46;&#x76EE;&#x524D;&#x88AB;&#x8BB8;&#x591A;&#x8F6F;&#x4EF6;&#xFF08;&#x5982;MediaWiki&#xFF09;&#x6240;&#x4F7F;&#x7528;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x5957;&#x5F00;&#x653E;&#x6E90;&#x4EE3;&#x7801;&#x8F6F;&#x4EF6;&#xFF0C;&#x4EE5;BSD license&#x6388;&#x6743;&#x91CA;&#x51FA;&#x3002; </p>
<p>memcached&#x7F3A;&#x4E4F;&#x8BA4;&#x8BC1;&#x4EE5;&#x53CA;&#x5B89;&#x5168;&#x7BA1;&#x5236;&#xFF0C;&#x8FD9;&#x4EE3;&#x8868;&#x5E94;&#x8BE5;&#x5C06;memcached&#x670D;&#x52A1;&#x5668;&#x653E;&#x7F6E;&#x5728;&#x9632;&#x706B;&#x5899;&#x540E;&#x3002;</p>
<p>memcached &#x7684;API&#x4F7F;&#x7528;&#x4E09;&#x5341;&#x4E8C;&#x4F4D;&#x5143;&#x7684;&#x5FAA;&#x73AF;&#x5197;&#x4F59;&#x6821;&#x9A8C;&#xFF08;CRC-32&#xFF09;&#x8BA1;&#x7B97;&#x952E;&#x503C;&#x540E;&#xFF0C;&#x5C06;&#x8D44;&#x6599;&#x5206;&#x6563;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x3002;&#x5F53;&#x8868;&#x683C;&#x6EE1;&#x4E86;&#x4EE5;&#x540E;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x65B0;&#x589E;&#x7684;&#x8D44;&#x6599;&#x4F1A;&#x4EE5;LRU&#x673A;&#x5236;&#x66FF;&#x6362;&#x6389;&#x3002; &#x7531;&#x4E8E;memcached&#x901A;&#x5E38;&#x53EA;&#x662F;&#x5F53;&#x4F5C;&#x5FEB;&#x53D6;&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;memcached&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5F0F;&#x5728;&#x5199;&#x56DE;&#x8F83;&#x6162;&#x7684;&#x7CFB;&#x7EDF;&#x65F6;&#xFF08;&#x50CF;&#x662F;&#x540E;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF09;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x7A0B;&#x5F0F;&#x7801;&#x66F4;&#x65B0; memcached&#x5185;&#x7684;&#x8D44;&#x6599;&#x3002;</p>
<p>memcached&#x5177;&#x6709;&#x591A;&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x5F00;&#x53D1;&#x5305;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;Perl/PHP/JAVA/C/Python/Ruby/C#/MySQL/</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x5305;&#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#x662F;&#xFF1A; <a href="http://code.google.com/p/memcached/wiki/Clients" target="_blank" rel="external">http://code.google.com/p/memcached/wiki/Clients</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/236f4bf/" title="Memcache的hash策略及配置总结 -" itemprop="url">Memcache的hash策略及配置总结 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.drupal001.com/wp-content/plugins/down-as-pdf/generate.php?id=1290" target="_blank" rel="external">PDF&#x7248;&#x672C;</a></p>
<p>Memcach&#x662F;web&#x5E94;&#x7528;/ <a href="http://drupal001.net" target="_blank" rel="external">Drupal</a> &#x5E94;&#x7528;&#x6027;&#x80FD;&#x63D0;&#x9AD8;&#x7684;&#x5229;&#x5668;&#xFF0C;&#x8FD1;&#x671F;&#x5728;&#x4F7F;&#x7528;Memcache&#x4E2D;&#xFF0C;&#x53D1;&#x73B0;&#x6709;&#x5F88;&#x591A;&#x5C0F;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x6B64;&#x4F5C;&#x8005;&#x7279;&#x610F;&#x603B;&#x7ED3;&#x4E86;&#x51E0;&#x4E2A;&#xFF0C;&#x653E;&#x4E0A;&#x6765;&#x4F9B;&#x5927;&#x5BB6;&#x53C2;&#x8003;&#x4F7F;&#x7528;&#x3002; </p>
<h4 id="1-_Memcache&#x548C;Memcached&#x7684;&#x533A;&#x522B;">1. Memcache&#x548C;Memcached&#x7684;&#x533A;&#x522B;</h4><h4 id="&#x8FD9;&#x4E2A;&#x662F;&#x5386;&#x53F2;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x662F;&#xFF0C;&#x8A00;&#x800C;&#x603B;&#x4E4B;&#xFF1A;&#x540D;&#x5B57;&#x957F;&#x7684;&#x66F4;&#x725B;&#x903C;!_&#xA0;">&#x8FD9;&#x4E2A;&#x662F;&#x5386;&#x53F2;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x662F;&#xFF0C;&#x8A00;&#x800C;&#x603B;&#x4E4B;&#xFF1A;&#x540D;&#x5B57;&#x957F;&#x7684;&#x66F4;&#x725B;&#x903C;! &#xA0;</h4><p>&#x6240;&#x4EE5;&#xFF0C;&#x63A8;&#x8350;&#x4F7F;&#x7528;memcached&#x3002;&#x53E6;&#x5916;&#xFF0C;memcached&#x6709;&#x5F88;&#x591A;&#x65B0;&#x7279;&#x6027;&#xFF0C;&#x5305;&#x62EC;getMulti/setMulti&#x3001;&#x652F;&#x6301;&#x5B58;&#x50A8;object&#x3001;&#x652F;&#x6301;count+1&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x4F1A;&#x6BD4;memcache&#x7684;&#x597D;&#x7528;&#x4E00;&#x4E9B;&#xFF0C;&#x53EF;&#x4EE5;&#x8BD5;&#x8BD5;&#xFF0C;&#x6216;&#x8BB8;&#x4EE5;&#x540E;&#x652F;&#x6301;&#x66F4;&#x591A;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x8D76;&#x4E0A;redis&#x3002;&#x3002; </p>
<p><a href="http://drupal001.net" target="_blank" rel="external">Drupal&#x5927;&#x5B66;</a> &#x4E0A;&#x5173;&#x4E8E;memcache&#x7684;&#x95EE;&#x7B54;&#xFF1A; <a href="http://drupal001.net/search/apachesolr_search/memcache" target="_blank" rel="external">http://drupal001.net/search/apachesolr_search/memcache</a></p>
<p>&#x5982;&#x4E0B;&#xFF08;&#x6458;&#x81EA;&#x5FB7;&#x95EE;&#xFF09;&#xFF1A; </p>
<pre><code><span class="symbol">#Memcache</span>
<span class="char">$m</span> = new <span class="class">Memcache</span>();
<span class="char">$m</span>-&amp;amp;gt;addServer(&amp;apos;localhost&amp;apos;, <span class="number">11211</span>);
<span class="char">$v</span> = <span class="char">$m</span>-&amp;amp;gt;get(&amp;apos;counter&amp;apos;);
<span class="char">$m</span>-&amp;amp;gt;set(&amp;apos;counter&amp;apos;, <span class="char">$v</span> + <span class="number">1</span>); 
#&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x4E8E</span>;get/set&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x65E0</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#xFF0C</span>;
#&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x4E22</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x8BA9</span>;&amp;<span class="symbol">#x4EBA</span>;&amp;<span class="symbol">#x607C</span>;&amp;<span class="symbol">#x706B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x4EC0</span>;&amp;<span class="symbol">#x4E48</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x4E22</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x3002</span>;

<span class="symbol">#Memcached</span>
<span class="char">$m</span>d = new <span class="class">Memcached</span>();
<span class="char">$m</span>d-&amp;amp;gt;addServer(&amp;apos;localhost&amp;apos;, <span class="number">11211</span>);
<span class="char">$v</span> = <span class="char">$m</span>d-&amp;amp;gt;get(&amp;apos;counter&amp;apos;, null, <span class="char">$t</span>oken)
<span class="char">$m</span>d-&amp;amp;gt;cas(<span class="char">$t</span>oken, &amp;apos;counter&amp;apos;, <span class="char">$v</span> + <span class="number">1</span>);
<span class="symbol">#cas</span>&amp;<span class="symbol">#x662F</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7248</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x63D0</span>;&amp;<span class="symbol">#x4F9B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x767D</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4E50</span>;&amp;<span class="symbol">#x89C2</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#xFF0C</span>;
#&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x628A</span>;<span class="char">$t</span>oken&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;var_dump&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;<span class="char">$t</span>oken&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7248</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#xFF0C</span>;
#&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;get&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;<span class="char">$t</span>oken&amp;<span class="symbol">#x7248</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x5728</span>;cas&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x522B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;
#&amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x65F6</span>;cas&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x81F3</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;&amp;<span class="symbol">#x4E86</span>;
</code></pre><p>&#x4E24;&#x8005;&#x7684;&#x533A;&#x522B;&#x5982;&#x4E0B;&#xFF0C;&#x4E0B;&#x9762;&#x662F;Memcache&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/236c65c.png" alt=""></p>
<p>&#x4E0B;&#x9762;&#x662F;memcached&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/236c8cd.png" alt=""></p>
<h4 id="2-_Memcache&#x7684;&#x54C8;&#x5E0C;&#x7B56;&#x7565;">2. Memcache&#x7684;&#x54C8;&#x5E0C;&#x7B56;&#x7565;</h4><p>&#x5E38;&#x89C4;&#x7684;hash&#x7B56;&#x7565;&#x662F;&#x53D6;&#x6A21;&#xFF0C;&#x6BD4;&#x5982;key=10, &#x6709;&#x4E24;&#x53F0;&#x670D;&#x52A1;&#xFF0C;&#x5C31;10%2=0&#xFF0C;&#x7B97;&#x51FA;&#x8BE5;&#x503C;&#x5206;&#x5E03;&#x5728;&#x7B2C;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;&#x90A3;&#x4E48;&#x7F3A;&#x70B9;&#x4E5F;&#x5F88;&#x660E;&#x663E;&#xFF0C;&#x6BD4;&#x5982;&#x670D;&#x52A1;&#x5668;&#x589E;&#x52A0;&#x4E00;&#x53F0;&#xFF0C;&#x4E4B;&#x524D;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7B56;&#x7565;&#x5168;&#x5B8C;&#x86CB;&#x3002; </p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x4E1A;&#x754C;&#x9700;&#x8981;&#x66F4;&#x725B;&#x903C;&#x7684;&#x7B97;&#x6CD5;~</p>
<p>&#x4E00;&#x81F4;&#x6027;hash&#x7B97;&#x6CD5;&#x9686;&#x91CD;&#x767B;&#x573A;&#xFF01;</p>
<p>&#x7B80;&#x5355;&#x8BF4;&#x6765;&#xFF0C;&#x4E00;&#x81F4;&#x6027;hash&#x7B97;&#x6CD5;&#x5C31;&#x662F;&#x5148;&#x628A;&#x670D;&#x52A1;&#x5668;&#x4E5F;&#x901A;&#x8FC7;&#x67D0;&#x4E00;&#x4E2A;&#x7279;&#x5F81;&#xFF08;&#x5982;IP/MAC&#x5730;&#x5740;&#xFF09;hash&#x4E00;&#x4E0B;&#xFF0C;&#x8FD9;&#x6837;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x6309;&#x7167;&#x5206;&#x5E03;&#xFF08;&#x53EF;&#x80FD;&#x4E0D;&#x5747;&#x5300;&#xFF09;&#x5728;&#x4E00;&#x4E2A;&#x8303;&#x56F4;&#xFF0C;&#x7136;&#x540E;&#x628A;key&#x518D;hash&#x4E00;&#x4E0B;&#xFF0C;&#x7136;&#x540E;&#x770B;key&#x6700;&#x8FD1;&#x7684;&#x4E0B;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x4F5C;&#x4E3A;&#x8BE5;key&#x7684;&#x5B58;&#x50A8;bin&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x5982;&#x679C;&#x589E;&#x52A0;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x7684;key&#x53EA;&#x662F;&#x5206;&#x5E03;&#x518D;&#x65B0;&#x589E;&#x7684;&#x8FD9;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x548C;&#x4E0A;&#x4E00;&#x4E2A;&#x6700;&#x8FD1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x7684;key&#xFF0C;&#x5176;&#x4F59;&#x7684;&#x90FD;&#x4E0D;&#x53D8;&#x3002; </p>
<p>&#x521D;&#x6B65;&#x7684;&#x670D;&#x52A1;&#x5668;&#x5206;&#x5E03;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/236cb3e.jpg" alt=""></p>
<p>&#x589E;&#x52A0;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5206;&#x5E03;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/236cdaf.jpg" alt=""></p>
<p>&#x4E0A;&#x9762;&#x7684;&#x63CF;&#x8FF0;&#x7684;&#x662F;&#x767D;&#x8BDD;&#xFF0C;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x62D7;&#x53E3;&#xFF0C;&#x7B14;&#x8005;&#x6587;&#x5B57;&#x6C34;&#x5E73;&#x6709;&#x9650;&#xFF0C;&#x8BE6;&#x60C5;&#x89C1;&#x4E0B;&#x9762;&#x7684;&#x94FE;&#x63A5;&#xFF1A;</p>
<p><a href="http://blogread.cn/it/article/5271" target="_blank" rel="external">http://blogread.cn/it/article/5271</a></p>
<p><a href="http://blog.csdn.net/kongqz/article/details/669541" target="_blank" rel="external">http://blog.csdn.net/kongqz/article/details/669541</a> 7 </p>
<h4 id="3-_Memcache&#x7684;hash&#x7B56;&#x7565;&#x914D;&#x7F6E;">3. Memcache&#x7684;hash&#x7B56;&#x7565;&#x914D;&#x7F6E;</h4><p>Memcache&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x54C8;&#x5E0C;&#x7B56;&#x7565;&#xFF0C;memcache.hash_strategy&#x3002;&#x76EE;&#x524D;&#x6709;standard&#x6A21;&#x5F0F;&#x548C;consistent&#x6A21;&#x5F0F;&#x3002;standard&#x6A21;&#x5F0F;&#x5176;&#x5B9E;&#x5C31;&#x662F;%&#xFF0C;&#x5373;&#x53D6;&#x6A21;&#x3002;&#x800C;consistent&#xFF0C;&#x5C31;&#x662F;hash&#x7684;&#x4E00;&#x81F4;&#x6027;&#x7B97;&#x6CD5;&#x3002;</p>
<p>&#x5728;Memcache&#x4E2D;&#xFF0C;hash&#x7B56;&#x7565;&#x5728;PHP.ini&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;</p>
<pre><code>[Memcache] 
Memcache.<span class="variable">allow_failover =</span> <span class="number">1</span> 
&amp;<span class="comment">#x2026;&amp;#x2026; </span>
&amp;<span class="comment">#x2026;&amp;#x2026; </span>
Memcache.<span class="variable">hash_strategy =</span>consistent 
Memcache.<span class="variable">hash_function =</span>crc32
</code></pre><p>&#x5728;Memcached&#x4E2D;&#xFF0C;hash&#x7B56;&#x7565;&#x5728;PHP&#x7684;&#x53C2;&#x6570;&#x4E2D;&#x8BBE;&#x7F6E;&#xFF1A;</p>
<pre><code>mem <span class="subst">=</span> <span class="literal">new</span> memcached(); 
<span class="variable">$mem</span><span class="subst">-&amp;</span>amp;<span class="literal">gt</span>;setOption(Memcached<span class="tag">::OPT_DISTRIBUTION</span>,Memcached<span class="tag">::DISTRIBUTION_CONSISTENT</span>); 
<span class="variable">$mem</span><span class="subst">-&amp;</span>amp;<span class="literal">gt</span>;setOption(Memcached<span class="tag">::OPT_LIBKETAMA_COMPATIBLE</span>,<span class="literal">true</span>);
</code></pre><h4 id="4-_&#x540E;&#x8BB0;">4. &#x540E;&#x8BB0;</h4><p>&#x56E0;&#x6B64;&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#xFF0C;&#x4F46;&#x51E1;&#x4E8B;&#x65E0;&#x7EDD;&#x5BF9;&#xFF0C;&#x6BD4;&#x5982;&#x4E00;&#x4E2A;&#x5C0F;&#x7684;&#x7AD9;&#x70B9;&#xFF0C;memcache&#x7684;&#x670D;&#x52A1;&#x51E0;&#x4E4E;&#x6C38;&#x4E0D;&#x4F1A;&#x589E;&#x52A0;&#xFF0C;&#x8FD9;&#x662F;&#x7528;&#x5E38;&#x89C4;&#x7684;standard&#x7684;&#x7B97;&#x6CD5;&#x4E5F;&#x662F;&#x6BD4;&#x8F83;&#x63A8;&#x8350;&#x7684;&#xFF0C;&#x6BD5;&#x7ADF;&#x4E00;&#x81F4;&#x6027;&#x7B97;&#x6CD5;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x5747;&#x5300;&#x5206;&#x5E03;&#x7684;&#x95EE;&#x9898;&#xFF08;&#x53EF;&#x80FD;&#x5DF2;&#x7ECF;&#x89E3;&#x51B3;&#x4E86;&#x3002;&#x3002;&#xFF09;</p>
<p>&#x6253;&#x5B8C;&#x6536;&#x5DE5;&#xFF01;</p>
<p>&#x5173;&#x4E8E; <a href="http://www.drupal001.com" target="_blank" rel="external">drupal</a> &#x548C;memcache&#x7684;&#x96C6;&#x6210;&#xFF0C;&#xFFFD;&#xFFFD;&#xFFFD;&#x5BB6;&#x53C2;&#x8003;&#x4E0B;&#x9762;&#x7684;&#x6587;&#x7AE0;&#xFF1A; </p>
<p><a href="http://www.drupal001.com/2013/09/drupal7-memcache/" target="_blank" rel="external">&#x5982;&#x4F55;&#x5728;Drupal7&#x4E2D;&#x914D;&#x7F6E;Memcache</a></p>
<p>&#x66F4;&#x591A;&#x95EE;&#x9898;&#x8BF7;&#x5230; <a href="http://drupal001.net/" target="_blank" rel="external">Drupal&#x5927;&#x5B66;</a> &#x63D0;&#x95EE;&#xFF1A; <a href="http://drupal001.net/" target="_blank" rel="external">http://drupal001.net/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/234073c/" title="轻量的Memcached代理Twemproxy的部署 -" itemprop="url">轻量的Memcached代理Twemproxy的部署 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x8F7B;&#x91CF;&#x7684;Memcached&#x4EE3;&#x7406;Twemproxy&#x7684;&#x90E8;&#x7F72; </p>
<p>Twemproxy(&#x53C8;&#x79F0;&#x4E3A;nutcracker)&#x662F;&#x4E00;&#x4E2A;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;Redis&#x548C;Memcached&#x4EE3;&#x7406;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x51CF;&#x5C11;&#x5BF9;&#x540E;&#x7AEF;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x3002;&#x7531;Twitter&#x5F00;&#x6E90;&#x51FA;&#x6765;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7BA1;&#x7406;&#x5DE5;&#x5177;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5F25;&#x8865;Redis&#x548C;Memcached&#x5BF9;&#x96C6;&#x7FA4;(cluster)&#x7BA1;&#x7406;&#x6307;&#x51FA;&#x7684;&#x4E0D;&#x8DB3;&#x3002;</p>
<p>Twemproxy&#x662F;&#x4E00;&#x4E2A;&#x5FEB;&#x901F;&#x7684;&#x5355;&#x7EBF;&#x7A0B;&#x4EE3;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x652F;&#x6301;Memcached ASCII&#x534F;&#x8BAE;&#x548C;&#x66F4;&#x65B0;&#x7684;Redis&#x534F;&#x8BAE;&#x3002;</p>
<p>Twemproxy&#x6700;&#x4E86;&#x4E0D;&#x8D77;&#x7684;&#x5730;&#x65B9;&#x5C31;&#x5728;&#x4E8E;&#x5B83;&#x80FD;&#x5728;&#x8282;&#x70B9;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#x5378;&#x8F7D;&#x5B83;&#xFF0C;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x4EE5;&#x540E;&#x91CD;&#x65B0;&#x5C1D;&#x8BD5;&#xFF08;&#x968F;&#x5373;&#xFF09;&#x8FDE;&#x63A5;&#xFF0C;&#x53C8;&#x6216;&#x8005;&#x53EF;&#x4EE5;&#x4E25;&#x683C;&#x6309;&#x7167;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5199;&#x7684;&#x952E;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#x3002;</p>
<h4 id="&#x5B89;&#x88C5;&#x90E8;&#x7F72;">&#x5B89;&#x88C5;&#x90E8;&#x7F72;</h4><p>&#x73B0;&#x6709;&#x6D4B;&#x8BD5;&#x673A;&#xFF1A;192.168.11.51/52/68</p>
<p>&#x5148;&#x5728;51&#x548C;52&#x6D4B;&#x8BD5;&#x673A;&#x4E0A;&#x5B89;&#x88C5;&#x597D;libevent&#x548C;memcached&#xFF0C;&#x5206;&#x522B;&#x542F;&#x52A8;&#x4E24;&#x4E2A;memcached&#x5B9E;&#x4F8B;&#xFF1B;</p>
<p>&#x7136;&#x540E;&#x5728;68&#x4E0A;&#x5B89;&#x88C5;&#x597D;twemproxy&#xFF0C;&#x914D;&#x7F6E;&#x597D;&#x53C2;&#x6570;&#xFF0C;&#x542F;&#x52A8;twemproxy&#x5B9E;&#x4F8B;&#x3002;</p>
<p>&#x5B89;&#x88C5;&#x548C;&#x542F;&#x52A8;memcached&#x5B9E;&#x4F8B; </p>
<p>&#x8BE6;&#x7EC6;&#x6B65;&#x9AA4;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;&#x4E4B;&#x524D;&#x7684;&#x535A;&#x6587; <a href="http://ultrasql.blog.51cto.com/9591438/1632179" target="_blank" rel="external">&#x300A;Memcached 1.4.22&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;&#x300B;</a> &#xFF0C;&#x5206;&#x522B;&#x542F;&#x52A8;&#x5982;&#x4E0B;&#x5B9E;&#x4F8B;&#xFF1A; </p>
<pre><code>/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.51 -p 11211 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached1.pid
/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.51 -p 11212 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached2.pid
/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.52 -p 11211 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached1.pid
/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.52 -p 11212 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached2.pid
</code></pre><p>&#x5B89;&#x88C5;&#x548C;&#x542F;&#x52A8;twemproxy&#x5B9E;&#x4F8B; </p>
<p>1 <strong>&#x3001;&#x5B89;&#x88C5;autoconf</strong></p>
<pre><code>cd /tmp
wget <span class="symbol">http:</span>/<span class="regexp">/ftp.gnu.org/gnu</span><span class="regexp">/autoconf/autoconf</span>-<span class="number">2.69</span>.tar.gz
tar zxvf autoconf-<span class="number">2.69</span>.tar.gz
cd autoconf-<span class="number">2.69</span>
./configure --prefix=<span class="regexp">/usr/</span>
make &amp;amp;&amp;amp; make install
</code></pre><p>2 <strong>&#x3001;&#x5B89;&#x88C5;twemproxy</strong></p>
<pre><code><span class="keyword">cd</span> /tmp
wget https:<span class="comment">//github.com/twitter/twemproxy/archive/master.zip</span>
unzip master.<span class="keyword">zip</span> -<span class="keyword">d</span> /usr/<span class="keyword">local</span>/
<span class="keyword">cd</span> /usr/<span class="keyword">local</span>
mv twemproxy-master twemproxy
<span class="keyword">cd</span> twemproxy
CFLAGS=&amp;quot;-ggdb3 -O0&amp;quot; autoreconf -fvi
./configure --prefix=/usr/<span class="keyword">local</span>/twemproxy --enable-debug=<span class="literal">log</span>
make &amp;amp;&amp;amp; make install
</code></pre><p>3 <strong>&#x3001;&#x67E5;&#x770B;&#x5E2E;&#x52A9;</strong></p>
<pre><code>[root@test01 twemproxy]# ./sbin/nutcracker -<span class="literal">h</span>

This is nutcracker-0.4.0
Usage: nutcracker [-?hVdDt] [-v verbosity level] [-o output <span class="keyword">file</span>]
[-c <span class="keyword">conf</span> <span class="keyword">file</span>] [-s stats port] [-a stats addr]
[-i stats interval] [-p pid <span class="keyword">file</span>] [-<span class="keyword">m</span> mbuf size]
Options:
-<span class="keyword">h</span>, --<span class="keyword">help</span> : this <span class="keyword">help</span>
-V, --<span class="keyword">version</span> : show <span class="keyword">version</span> and <span class="keyword">exit</span>
-t, --<span class="keyword">test</span>-<span class="keyword">conf</span> : <span class="keyword">test</span> configuration <span class="keyword">for</span> <span class="keyword">syntax</span> errors and <span class="keyword">exit</span>
-<span class="keyword">d</span>, --daemonize : <span class="keyword">run</span> <span class="keyword">as</span> a daemon
-<span class="keyword">D</span>, --<span class="keyword">describe</span>-stats : <span class="keyword">print</span> stats description and <span class="keyword">exit</span>
-v, --verbose=<span class="keyword">N</span> : <span class="keyword">set</span> logging level (default: 5, min: 0, max: 11)
-o, --output=S : <span class="keyword">set</span> logging <span class="keyword">file</span> (default: stderr)
-c, --<span class="keyword">conf</span>-<span class="keyword">file</span>=S : <span class="keyword">set</span> configuration <span class="keyword">file</span> (default: <span class="keyword">conf</span>/nutcracker.yml)
-s, --stats-port=<span class="keyword">N</span> : <span class="keyword">set</span> stats monitoring port (default: 22222)
-a, --stats-addr=S : <span class="keyword">set</span> stats monitoring ip (default: 0.0.0.0)
-i, --stats-interval=<span class="keyword">N</span> : <span class="keyword">set</span> stats aggregation interval <span class="keyword">in</span> msec (default: 30000 msec)
-p, --pid-<span class="keyword">file</span>=S : <span class="keyword">set</span> pid <span class="keyword">file</span> (default: off)
-<span class="keyword">m</span>, --mbuf-size=<span class="keyword">N</span> : <span class="keyword">set</span> size of mbuf chunk <span class="keyword">in</span> bytes (default: 16384 bytes)
</code></pre><p>4 <strong>&#x3001;&#x4FEE;&#x6539;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</strong></p>
<pre><code>mkdir <span class="regexp">/etc/</span>nutcracker
cp .<span class="regexp">/conf/</span>nutcracker.yml <span class="regexp">/etc/</span>nutcracker/
vi <span class="regexp">/etc/</span>nutcracker/nutcracker.yml
<span class="label">
memcached:</span>
<span class="string">listen:</span> <span class="number">192.168</span>.11.55:<span class="number">22121</span>
<span class="string">hash:</span> fnvla_64
<span class="string">distribution:</span> ketama
<span class="string">timeout:</span> <span class="number">400</span>
<span class="string">backlog:</span> <span class="number">1024</span>
<span class="string">preconnect:</span> <span class="literal">true</span>
<span class="string">auto_eject_hosts:</span> <span class="literal">true</span>
<span class="string">server_retry_timeout:</span> <span class="number">30000</span>
<span class="string">server_failure_limit:</span> <span class="number">3</span>
<span class="string">servers:</span>
- <span class="number">192.168</span>.11.51:<span class="number">11211</span>:<span class="number">1</span>
- <span class="number">192.168</span>.11.51:<span class="number">11212</span>:<span class="number">1</span>
- <span class="number">192.168</span>.11.52:<span class="number">11211</span>:<span class="number">1</span>
- <span class="number">192.168</span>.11.52:<span class="number">11212</span>:<span class="number">1</span>
</code></pre><p>&#x53C2;&#x6570;&#x89E3;&#x6790;&#xFF1A;</p>
<p>listen: &#x542F;&#x52A8;twemproxy&#x670D;&#x52A1;&#x7684;IP&#x548C;&#x7AEF;&#x53E3;</p>
<p>hash: &#x6307;&#x5B9A;&#x5177;&#x4F53;&#x7684;&#x54C8;&#x5E0C;&#x51FD;&#x6570;</p>
<p>distribution: &#x6307;&#x5B9A;&#x5177;&#x4F53;&#x7684;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;</p>
<p>preconnect: &#x4E00;&#x4E2A;&#x5E03;&#x5C14;&#x503C;&#xFF0C;&#x5982;&#x679C;&#x8BE5;&#x63A7;&#x4EF6;&#x7684;nutcracker&#x524D;&#x7AEF;&#x8FDE;&#x63A5;&#x5728;&#x8FD9;&#x4E2A;&#x6C60;&#x4E0A;&#x7684;&#x6240;&#x6709;&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x3002;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;&#x5047;</p>
<p>auto_eject_hosts: &#x662F;&#x5426;&#x5728;&#x7ED3;&#x70B9;&#x65E0;&#x6CD5;&#x54CD;&#x5E94;&#x7684;&#x65F6;&#x5019;&#x4E34;&#x65F6;&#x6458;&#x9664;&#x7ED3;&#x70B9;</p>
<p>server_retry_timeout: &#x91CD;&#x8BD5;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x6BEB;&#x79D2;&#xFF09;</p>
<p>server_failure_limit: &#x7ED3;&#x70B9;&#x6545;&#x969C;&#x591A;&#x5C11;&#x6B21;&#x5C31;&#x7B97;&#x6458;&#x9664;&#x6389;</p>
<p>servers: &#x4E0B;&#x9762;&#x8868;&#x793A;&#x6240;&#x6709;&#x7684;memcached&#x8282;&#x70B9;&#xFF08;IP:&#x7AEF;&#x53E3;&#x53F7;:&#x6743;&#x91CD;&#xFF09;</p>
<p>5 <strong>&#x3001;&#x914D;&#x7F6E;&#x4EE5;&#x670D;&#x52A1;&#x542F;&#x52A8;</strong></p>
<pre><code>cp .<span class="regexp">/scripts/</span>nutcracker.init <span class="regexp">/etc/</span>init.d/nutcracker
chmod <span class="number">755</span> <span class="regexp">/etc/</span>init.d/nutcracker
vi <span class="regexp">/etc/</span>init.d/nutcracker
</code></pre><ol>
<li><p>&#x65B0;&#x589E;&#x5B9A;&#x4E49;daemo</p>
<p> daemon=&quot;/usr/local/twemproxy/sbin/nutcracker&quot;</p>
</li>
<li><p>&#x66FF;&#x6362;&#x6240;&#x6709;</p>
<p> daemon —user ${USER} ${prog} $OPTIONS</p>
</li>
</ol>
<p>&#x4E3A;</p>
<pre><code><span class="label">${daemo}</span> <span class="label">$OPTIONS</span>

chkconfig --add nutcracker
chkconfig --level 35 nutcracker <span class="keyword">on</span>
chkconfig --<span class="keyword">list</span> nutcracker

vi /etc/profile
</code></pre><p>&#x5728;&#x91CC;&#x9762;&#x52A0;&#x5165;&#xFF1A;</p>
<pre><code>export <span class="constant">PATH=</span>&amp;quot;<span class="variable">$PATH</span><span class="symbol">:/usr/local/twemproxy/sbin&amp;quot</span>;

. /etc/profile
echo <span class="variable">$PATH</span>
</code></pre><p>6 <strong>&#x3001;&#x6D4B;&#x8BD5;&#x914D;&#x7F6E;&#x5E76;&#x542F;&#x52A8;&#x670D;&#x52A1;</strong></p>
<pre><code>nutcracker -t -c /etc/nutcracker/nutcracker.yml
<span class="keyword">service</span> nutcracker <span class="literal">start</span>
</code></pre><h4 id="&#x6570;&#x636E;&#x5199;&#x5165;&#x6D4B;&#x8BD5;">&#x6570;&#x636E;&#x5199;&#x5165;&#x6D4B;&#x8BD5;</h4><pre><code>[root@test01 init.d]# telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character is &amp;apos;^]&amp;apos;.
<span class="operator"><span class="keyword">set</span> key1 <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>
<span class="number">1</span>
STORED
<span class="keyword">set</span> key2 <span class="number">0</span> <span class="number">0</span> <span class="number">2</span>
<span class="number">22</span>
STORED
<span class="keyword">set</span> key3 <span class="number">0</span> <span class="number">0</span> <span class="number">3</span>
<span class="number">333</span>
STORED
<span class="keyword">set</span> key4 <span class="number">0</span> <span class="number">0</span> <span class="number">4</span>
<span class="number">4444</span>
STORED
<span class="keyword">set</span> key5 <span class="number">0</span> <span class="number">0</span> <span class="number">5</span>
<span class="number">55555</span>
STORED
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test01 ~]# telnet <span class="number">192.168</span>.11.51 <span class="number">11211</span>

Trying <span class="number">192.168</span>.11.51...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.51.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test01 ~]# telnet <span class="number">192.168</span>.11.51 <span class="number">11212</span>

Trying <span class="number">192.168</span>.11.51...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.51.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test02 ~]# telnet <span class="number">192.168</span>.11.52 <span class="number">11211</span>

Trying <span class="number">192.168</span>.11.52...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.52.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test02 ~]# telnet <span class="number">192.168</span>.11.52 <span class="number">11212</span>

Trying <span class="number">192.168</span>.11.52...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.52.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
VALUE key1 0 1
1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">VALUE</span> key2 <span class="number">0</span> <span class="number">2</span>
<span class="number">22</span>
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">VALUE</span> key3 <span class="number">0</span> <span class="number">3</span>
<span class="number">333</span>
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">VALUE</span> key4 <span class="number">0</span> <span class="number">4</span>
<span class="number">4444</span>
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">VALUE</span> key5 <span class="number">0</span> <span class="number">5</span>
<span class="number">55555</span>
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.</span>
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6570;&#x636E;&#x5168;&#x90E8;&#x4ECE;52&#x7684;11212&#x7AEF;&#x53E3;&#x83B7;&#x53D6;&#x5230;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x505C;&#x6389;52&#x7684;11212&#x7AEF;&#x53E3;&#x670D;&#x52A1;&#x3002;</p>
<p>&#x7EE7;&#x7EED;&#x5F80;&#x4EE3;&#x7406;&#x5199;&#x6570;&#x636E;&#x3002;</p>
<pre><code><span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
set username 0 0 6
ryanxu
STORED
set aa 0 0 2
aa
STORED
quit
Connection <span class="keyword">closed</span> by foreign host.

<span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
get key1
SERVER_ERROR Connection refused
Connection <span class="keyword">closed</span> by foreign host.

<span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
get key1
SERVER_ERROR Connection refused
Connection <span class="keyword">closed</span> by foreign host.

<span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
get key1
END
get key2
END
get key3
END
quit
Connection <span class="keyword">closed</span> by foreign host.
</code></pre><p>&#x4E00;&#x53F0;memcached &#x6302;&#x6389;&#x540E;&#xFF0C;twemproxy &#x80FD;&#x591F;&#x81EA;&#x52A8;&#x6458;&#x9664;&#x3002;&#x6062;&#x590D;&#x540E;&#xFF0C;twemproxy &#x80FD;&#x591F;&#x81EA;&#x52A8;&#x8BC6;&#x522B;&#x3001;&#x6062;&#x590D;&#x5E76;&#x91CD;&#x65B0;&#x52A0;&#x5165;&#x5230; memcached &#x7EC4;&#x4E2D;&#x91CD;&#x65B0;&#x4F7F;&#x7528;&#x3002;</p>
<h4 id="&#x95EE;&#x9898;&#x603B;&#x7ED3;">&#x95EE;&#x9898;&#x603B;&#x7ED3;</h4><p>1&#xFF09;.yml&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x503C;&#x5BF9;&#x5206;&#x9694;&#x7B26;&#x201D;:&#x201D;&#x540E;&#x9700;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x7A7A;&#x683C;&#x3002;</p>
<p>2&#xFF09;&#x4E0D;&#x540C;&#x5C42;&#x6B21;&#x7684;&#x53C2;&#x6570;&#x9700;&#x8981;&#x7F29;&#x8FDB;&#x533A;&#x5206;&#xFF0C;&#x6700;&#x597D;&#x4F7F;&#x7528;tab&#x952E;&#x7F29;&#x8FDB;&#xFF0C;&#x5426;&#x5219;nutcracker&#x8FDB;&#x7A0B;&#x4E0D;&#x80FD;&#x542F;&#x52A8;&#x3002;</p>
<p>3&#xFF09;&#x5728;auto_eject_hosts: true&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5173;&#x95ED;&#x4E00;&#x4E2A;memcached&#x5B9E;&#x4F8B;&#x540E;&#xFF0C;&#x5199;&#x5165;&#x6570;&#x636E;&#x8FD8;&#x662F;&#x63D0;&#x793A;&#x201C;(error) ERR Connection refused&#x201D;&#x3002;&#x8FD9;&#x4E2A;&#x4E0E;server_retry_timeout&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x592A;&#x5C0F;&#x6709;&#x5173;&#xFF0C;30000&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x7684;&#x9009;&#x62E9;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/233ddbb/" title="JS结合Memcache实现爬虫程序的识别与阻挡 -" itemprop="url">JS结合Memcache实现爬虫程序的识别与阻挡 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x6700;&#x8FD1;&#x516C;&#x53F8;&#x7F51;&#x7AD9;&#x7684;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;&#x4E00;&#x76F4;&#x906D;&#x53D7;&#x722C;&#x866B;&#x7684;&#x8BBF;&#x95EE;&#xFF0C;&#x7531;&#x4E8E;&#x5BF9;&#x65B9;&#x901A;&#x8FC7;&#x6570;&#x91CF;&#x5DE8;&#x5927;&#x7684;&#x5206;&#x5E03;&#x5F0F;IP&#x8BBF;&#x95EE;(&#x5927;&#x7EA6;&#x662F;&#x6B63;&#x5E38;&#x8BBF;&#x95EE;IP&#x6570;&#x91CF;&#x7684;&#x51E0;&#x767E;&#x500D;)&#xFF0C;&#x540C;&#x65F6;&#x5355;&#x4E2A;IP&#x7684;&#x8BBF;&#x95EE;&#x9891;&#x7387;&#x53C8;&#x6BD4;&#x8F83;&#x4F4E;&#xFF0C;&#x6240;&#x4EE5;&#x4EE5;&#x5F80;&#x90E8;&#x7F72;&#x7684;&#x4E00;&#x4E9B;&#x6839;&#x636E;&#x8BBF;&#x95EE;&#x9891;&#x7387;&#x7279;&#x5F81;&#x8BC6;&#x522B;&#x963B;&#x6321;&#x7684;&#x7B56;&#x7565;&#x57FA;&#x672C;&#x65E0;&#x6CD5;&#x8D77;&#x5230;&#x6709;&#x6548;&#x7684;&#x9632;&#x8303;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x9891;&#x7387;&#x7279;&#x5F81;&#x8BC6;&#x522B;&#x884C;&#x4E0D;&#x901A;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x53C8;&#x901A;&#x8FC7;&#x8BC6;&#x522B;&#x722C;&#x866B;&#x5DE5;&#x5177;&#x7684;HTTP&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x7279;&#x5F81;&#xFF1A;&#x662F;&#x5426;&#x5305;&#x542B;&#x7279;&#x5B9A;&#x7684;HTTP&#x5934;&#x6216;&#x6CA1;&#x6709;&#x5305;&#x542B;&#x67D0;&#x4E9B;&#x6B63;&#x5E38;&#x6D4F;&#x89C8;&#x5668;&#x8BF7;&#x6C42;&#x5E94;&#x8BE5;&#x643A;&#x5E26;&#x7684;HTTP&#x5934;(&#x5982;cookie&#x548C;referrer)&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x5C01;&#x9501;&#x6BD4;&#x8F83;&#x6709;&#x9488;&#x5BF9;&#x6027;&#xFF0C;&#x4F46;&#x662F;HTTP&#x5934;&#x7684;&#x4FEE;&#x6539;&#x6210;&#x672C;&#x5F88;&#x4F4E;&#xFF0C;&#x5BF9;&#x65B9;&#x540E;&#x6765;&#x4E5F;&#x786E;&#x5B9E;&#x591A;&#x6B21;&#x8C03;&#x6574;HTTP&#x5934;&#x4FE1;&#x606F;&#x6765;&#x89C4;&#x907F;&#x6211;&#x4EEC;&#x7684;&#x68C0;&#x67E5;&#x3002;&#x540C;&#x65F6;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x8BEF;&#x4F24;&#x4E00;&#x4E9B;&#x6B63;&#x5E38;&#x7684;&#x8BBF;&#x95EE;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x66F4;&#x6709;&#x6548;&#x5730;&#x8BC6;&#x522B;&#x722C;&#x866B;&#x7A0B;&#x5E8F;&#xFF0C;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x5BFB;&#x627E;&#x5176;&#x5B83;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x4E5F;&#x5728;&#x7F51;&#x4E0A;&#x67E5;&#x4E86;&#x4E00;&#x4E9B;&#x8D44;&#x6599;&#x3002;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x666E;&#x904D;&#x5E94;&#x7528;&#x7684;&#x539F;&#x7406;&#xFF0C;&#x662F;&#x57FA;&#x4E8E;&#x722C;&#x866B;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x6784;&#x9020;&#x67E5;&#x8BE2;&#x8BF7;&#x6C42;&#x76F4;&#x63A5;Post&#x5230;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;&#x8FD9;&#x4E00;&#x7279;&#x5F81;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x9875;&#x9762;&#x5D4C;&#x5165;JS&#x4EE3;&#x7801;&#x5224;&#x65AD;&#x8BBF;&#x95EE;&#x6765;&#x6E90;&#x662F;&#x4E00;&#x4E2A;&#x771F;&#x5B9E;&#x6D4F;&#x89C8;&#x5668;&#x8FD8;&#x662F;&#x4E00;&#x4E2A;&#x76F4;&#x63A5;&#x8BF7;&#x6C42;&#x63A5;&#x53E3;&#x7684;&#x7A0B;&#x5E8F;&#x3002;&#x5728;&#x66F4;&#x5B8C;&#x6574;&#x7684;&#x65B9;&#x6848;&#x91CC;&#xFF0C;&#x8FD8;&#x6709;&#x540C;&#x65F6;&#x7ED3;&#x5408;memcache&#x6216;redis&#x5BF9;&#x8BF7;&#x6C42;&#x7684;IP&#x8FDB;&#x884C;&#x8BA1;&#x6570;&#x7EDF;&#x8BA1;&#xFF1A;&#x5728;&#x67E5;&#x8BE2;&#x63A5;&#x53E3;&#x65F6;&#xFF0C;&#x5BF9;&#x6765;&#x6E90;IP&#x8BF7;&#x6C42;&#x8BA1;&#x6570;+1&#xFF0C;&#x540C;&#x65F6;&#xFFFD;&#xFFFD;&#xFFFD;&#x54CD;&#x5E94;&#x9875;&#x9762;&#x7684;JS&#x91CC;&#x5B9E;&#x73B0;&#x5BF9;&#x6765;&#x6E90;IP&#x8BF7;&#x6C42;-1&#xFF0C;&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;&#x6B63;&#x5E38;&#x7684;&#x7528;&#x6237;&#x6D4F;&#x89C8;&#x5668;&#x67E5;&#x8BE2;&#x8BBF;&#x95EE;&#xFF0C;&#x4E24;&#x6B21;&#x64CD;&#x4F5C;&#x8BA1;&#x6570;&#x62B5;&#x6D88;&#xFF0C;&#x8BA1;&#x6570;&#x5E94;&#x8BE5;&#x59CB;&#x7EC8;&#x4FDD;&#x6301;&#x5728;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x4F4E;&#x7684;&#x503C;(&#x7406;&#x60F3;&#x60C5;&#x51B5;&#x5E94;&#x8BE5;&#x59CB;&#x7EC8;&#x5728;0&#x6216;1&#xFF0C;&#x4F46;&#x8003;&#x8651;&#x5230;&#x54CD;&#x5E94;&#x9875;&#x9762;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x52A0;&#x8F7D;&#x4E0D;&#x5B8C;&#x5168;&#x7B49;&#x60C5;&#x51B5;&#xFF0C;&#x4E0D;&#x4E00;&#x5B9A;&#x6BCF;&#x6B21;&#x90FD;&#x80FD;&#x51CF;&#x503C;)&#xFF0C;&#x800C;&#x722C;&#x866B;&#x7A0B;&#x5E8F;&#x7531;&#x4E8E;&#x5E76;&#x4E0D;&#x89E6;&#x53D1;JS&#xFF0C;&#x7D2F;&#x8BA1;&#x67E5;&#x8BE2;&#x59CB;&#x7EC8;&#x589E;&#x957F;&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x6709;&#x6548;&#x8BC6;&#x522B;&#x51FA;&#x54EA;&#x4E9B;&#x6765;&#x6E90;&#x662F;&#x722C;&#x866B;&#x8BF7;&#x6C42;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8981;&#x600E;&#x4E48;&#x5904;&#x7406;&#x5C31;&#x7B80;&#x5355;&#x4E86;&#x3002; </p>
<p>&#x8BF4;&#x8D77;&#x6765;&#x603B;&#x662F;&#x6CA1;&#x6709;&#x770B;&#x8D77;&#x6765;&#x90A3;&#x4E48;&#x6E05;&#x6670;&#x660E;&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x548C;&#x56E2;&#x961F;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x4EEC;&#x5546;&#x91CF;&#x505A;&#x4E2A;demo&#x6765;&#x6F14;&#x793A;&#x4E00;&#x4E0B;&#xFF0C;&#x8BF4;&#x5E72;&#x5C31;&#x5E72;&#xFF0C;&#x7528;&#x7B80;&#x5355;&#x5F3A;&#x5927;&#x53C8;&#x597D;&#x7528;&#x7684;Python(&#x6211;&#x4E0D;&#x4F1A;&#x544A;&#x8BC9;&#x4F60;&#x5176;&#x5B9E;&#x662F;&#x56E0;&#x4E3A;&#x6211;&#x53EA;&#x4F1A;Python&#x7684;)&#x642D;&#x4E2A;&#x7F51;&#x7AD9;&#xFF0C;&#x8D77;&#x4E2A;memcache&#xFF0C;&#x534A;&#x4E2A;&#x4E0B;&#x5348;&#x57FA;&#x672C;&#x9F50;&#x6D3B;&#x4E86;&#x3002;</p>
<p>&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>#!/bin/python

import memcache
import web
render = web.template.render(&amp;apos;templates/&amp;apos;)

mc = memcache.<span class="class">Client</span>([&amp;apos;x.x.x.<span class="method">x:</span><span class="number">11211</span>&amp;apos;], debug=<span class="number">0</span>)

<span class="symbol">#index</span>&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x641C</span>;&amp;<span class="symbol">#x7D22</span>;&amp;<span class="symbol">#x6846</span>;&amp;<span class="symbol">#xFF0C</span>;post&amp;<span class="symbol">#x5230</span>;search&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5728</span>;search&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x663E</span>;&amp;<span class="symbol">#x793A</span>;post&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x3002</span>;
#&amp;<span class="symbol">#x5728</span>;search&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x5D4C</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">JS</span>&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5411</span>;memcache&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x8D77</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;
urls = (
  &amp;apos;/&amp;apos;,&amp;apos;index&amp;apos;,
  &amp;apos;/search&amp;apos;,&amp;apos;search&amp;apos;,
  &amp;apos;/memcache&amp;apos;,&amp;apos;mem&amp;apos;

)

class <span class="method">index:</span>
  def <span class="class">GET</span>(<span class="keyword">self</span>):
    return render.index()

#&amp;<span class="symbol">#x5728</span>;search&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;memcache&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x6E90</span>;<span class="class">IP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x6570</span>;+<span class="number">1</span>
#&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x505A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;memcache&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">IP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x6570</span>;&amp;gt;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;
class <span class="method">search:</span>
  def <span class="class">POST</span>(<span class="keyword">self</span>):
    data = web.input().get(&amp;apos;searchstr&amp;apos;)
    <span class="symbol">#data</span> = web.ctx[&amp;apos;ip&amp;apos;]
    srcip = str(web.ctx[&amp;apos;ip&amp;apos;])
    if mc.get(srcip):
      mc.incr(srcip)
    <span class="method">else:</span>
      mc.set(srcip,<span class="number">1</span>)
    if mc.get(srcip) &amp;gt; <span class="number">1</span>:
      return render.bug()
    <span class="method">else:</span>
      return render.search(data)

<span class="symbol">#memcache</span>&amp;<span class="symbol">#x9875</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x6E90</span>;<span class="class">IP</span>&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x6570</span>;-<span class="number">1</span>
class <span class="method">mem:</span>
  def <span class="class">GET</span>(<span class="keyword">self</span>):
    srcip = str(web.ctx[&amp;apos;ip&amp;apos;])
    if mc.get(srcip):
      mc.decr(srcip)


if __name__ == &amp;quot;__main__&amp;quot;:
  app = web.application(urls,globals())
  app.run()
</code></pre><p>&#x7B2C;&#x4E00;&#x6B21;&#x8D34;&#x5B8C;&#x4EE3;&#x7801;&#x53D1;&#x73B0;&#x679C;&#x7136;&#x8FD8;&#x662F;&#x6CA1;&#x6709;&#x517B;&#x6210;&#x5199;&#x6CE8;&#x91CA;&#x7684;&#x597D;&#x4E60;&#x60EF;&#xFF0C;&#x597D;&#x5728;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x8D76;&#x7D27;&#x8865;&#x5145;&#x4E00;&#x4E0B;&#x3002;&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x8D77;&#x6765;&#xFF0C;&#x9996;&#x9875;&#x5C31;&#x957F;&#x8FD9;&#x6837;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/233ca33.png" alt=""></p>
<p>Paste_Image.png</p>
<p>&#x968F;&#x4FBF;&#x8F93;&#x5165;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#xFF0C;&#x6BD4;&#x5982;&quot;123&quot;&#xFF0C;&#x67E5;&#x8BE2;&#x51FA;&#x7684;&#x7ED3;&#x679C;&#x9875;&#xFF0C;&#x957F;&#x8FD9;&#x6837;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/233cca4.png" alt=""></p>
<p>Paste_Image.png</p>
<p>&#x8FD9;&#x65F6;&#x5019;&#xFF0C;&#x53BB;&#x770B;&#x4E00;&#x4E0B;memcache&#x91CC;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;IP&#x7684;&#x8BB0;&#x5F55;&#x6709;&#x4E86;&#xFF0C;&#x8BA1;&#x6570;&#x662F;0</p>
<p><img src="http://taojinke.github.io/img/20150703/233cf15.png" alt=""></p>
<p>Paste_Image.png</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x5DE5;&#x5177;&#x6784;&#x9020;POST&#x8BF7;&#x6C42;&#x6A21;&#x62DF;&#x722C;&#x866B;&#x7684;&#x884C;&#x4E3A;&#x3002;&#x6784;&#x9020;&#x5DE5;&#x5177;&#x5F88;&#x591A;&#x5F88;&#x591A;&#xFF0C;&#x6211;&#x4EEC;&#x4E3A;&#x4E86;&#x65B9;(tou)&#x4FBF;(lan)&#xFF0C;&#x5C31;&#x7528;linux&#x81EA;&#x5E26;&#x7684;wget&#xFF0C;&#x9053;&#x7406;&#x662F;&#x4E00;&#x6837;&#x4E00;&#x6837;&#x7684;</p>
<pre><code>$ wget <span class="variable">--post-data=</span>&amp;quot;<span class="variable">searchstr=</span><span class="number">123</span>&amp;amp;<span class="variable">submit=</span>Submit&amp;quot; http://x.x.x.x:<span class="number">8080</span>/search
</code></pre><p>&#x55EF;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x67E5;&#x8BE2;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x83B7;&#x53D6;&#x7684;&#x7ED3;&#x679C;&#x548C;&#x7528;&#x6D4F;&#x89C8;&#x5668;&#x8BBF;&#x95EE;&#x5F97;&#x5230;&#x7684;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/233cf15.png" alt=""></p>
<p>Paste_Image.png</p>
<p>&#x4F46;&#x662F;&#x770B;&#x770B;&#x6211;&#x4EEC;&#x7684;memcache&#xFF0C;&#x7531;&#x4E8E;&#x5DE5;&#x5177;&#x5E76;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x7ED3;&#x679C;&#x9875;&#x9762;&#x4E0A;&#x7684;JS&#xFF0C;&#x6240;&#x4EE5;&#x8BA1;&#x6570;&#x7D2F;&#x8BA1;&#x5230;&#x4E86;1</p>
<p><img src="http://taojinke.github.io/img/20150703/233cf15.png" alt=""></p>
<p>Paste_Image.png</p>
<p>&#x4E8E;&#x662F;&#x518D;&#x7528;&#x5DE5;&#x5177;&#x6765;&#x67E5;&#x8BE2;&#x4E00;&#x6B21;&#x770B;&#x770B;&#xFF0C;&#x7531;&#x4E8E;memcache&#x4E2D;&#x7D2F;&#x8BA1;&#x5230;&#x4E86;2&#xFF0C;&#x7A0B;&#x5E8F;&#x5904;&#x7406;&#x76F4;&#x63A5;&#x8DF3;&#x5230;&#x62A5;&#x9519;&#x9875;&#x9762;&#x4E86;&#x3002;&#x771F;&#x5B9E;&#x5E94;&#x7528;&#x4E2D;&#xFF0C;&#x8FD9;&#x91CC;&#x4E5F;&#x53EF;&#x4EE5;&#x662F;&#x9A8C;&#x8BC1;&#x7801;&#x4E4B;&#x7C7B;&#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/233d186.png" alt=""></p>
<p>Paste_Image.png</p>
<p>&#x8FD9;&#x4E2A;demo&#x5E76;&#x6CA1;&#x6709;&#x7528;&#x5230;&#x7279;&#x522B;&#x6DF1;&#x7684;&#x539F;&#x7406;&#x548C;&#x6280;&#x672F;&#xFF0C;&#x4E0D;&#x8FC7;&#x80FD;&#x901A;&#x8FC7;&#x81EA;&#x5DF1;&#x7684;&#x53CC;&#x624B;&#x628A;&#x522B;&#x4EBA;&#x63D0;&#x4F9B;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x6F14;&#x793A;&#x51FA;&#x6765;&#xFF0C;&#x611F;&#x89C9;&#x8FD8;&#x662F;&#x68D2;&#x68D2;&#x54D2;&#xFF0C;&#x4E0D;&#x65AD;&#x7406;&#x8BBA;&#x7ED3;&#x5408;&#x5B9E;&#x8DF5;&#x5E76;&#x505A;&#x597D;&#x603B;&#x7ED3;&#x624D;&#x662F;&#x63D0;&#x9AD8;&#x6280;&#x672F;&#x6C34;&#x5E73;&#x7684;&#x597D;&#x65B9;&#x6CD5;&#x3002;&#x7EB8;&#x4E0A;&#x5F97;&#x6765;&#x7EC8;&#x89C9;&#x6D45;&#xFF0C;&#x7EDD;&#x77E5;&#x6B64;&#x4E8B;&#x8981;&#x8EAC;&#x884C;&#xFF0C;&#x4EE5;&#x6B64;&#x4F5C;&#x4E3A;&#x7B80;&#x4E66;&#x7B2C;&#x4E00;&#x7BC7;&#x3002; </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/JavaScript/">JavaScript</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23731c8/" title="Linux c 开发 - Memcached源码分析之总结篇（8） -" itemprop="url">Linux c 开发 - Memcached源码分析之总结篇（8） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x5171;8&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x524D;7&#x7BC7;&#x6587;&#x7AE0;&#x4E3B;&#x8981;&#x5206;&#x6790;&#x6BCF;&#x4E2A;&#x6A21;&#x5757;&#x7684;c&#x6E90;&#x4EE3;&#x7801;&#x3002;&#x8FD9;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x4E4B;&#x524D;&#x7684;&#x6D41;&#x7A0B;&#x4E32;&#x8D77;&#x6765;&#xFF0C;&#x603B;&#x7ED3;&#x548C;&#x56DE;&#x987E;&#x3002;&#x540C;&#x65F6;&#x901A;&#x8FC7;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x53EF;&#x4EE5;&#x5168;&#x5C40;&#x53BB;&#x770B;Memcached&#x7684;&#x7ED3;&#x6784;&#x3002;</p>
<p>Memcache&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B; </p>
<ol>
<li><p>Memcached&#x4E3B;&#x8981;&#x662F;&#x57FA;&#x4E8E;Libevent &#x7F51;&#x7EDC;&#x4E8B;&#x4EF6;&#x5E93;&#x8FDB;&#x884C;&#x5F00;&#x53D1;&#x7684;&#x3002;</p>
</li>
<li><p>Memcached&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#x5206;&#x4E3A;&#x4E24;&#x90E8;&#x5206;&#xFF1A;&#x4E3B;&#x7EBF;&#x7A0B;&#x548C;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x63A5;&#x6536;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#xFF1B;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x63A5;&#x7BA1;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#xFF0C;&#x5904;&#x7406;&#x5177;&#x4F53;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x5F00;&#x542F;8&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;</p>
</li>
<li><p>&#x4E3B;&#x7EBF;&#x7A0B;&#x548C;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;pipe&#x7BA1;&#x9053;&#x6765;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x3002;&#x5F53;&#x4E3B;&#x7EBF;&#x7A0B;&#x63A5;&#x6536;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;&#x8F6E;&#x8BE2;&#x7684;&#x65B9;&#x5F0F;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF0C;&#x7136;&#x540E;&#x5411;&#x8BE5;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x7BA1;&#x9053;pipe&#x5199;&#x6570;&#x636E;&#x3002;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x76D1;&#x542C;&#x5230;&#x7BA1;&#x9053;&#x4E2D;&#x6709;&#x6570;&#x636E;&#x5199;&#x5165;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x53BB;&#x63A5;&#x7BA1;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x3002;</p>
</li>
<li><p>&#x6BCF;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E5F;&#x662F;&#x57FA;&#x4E8E;Libevent&#x7684;&#x4E8B;&#x4EF6;&#x673A;&#x5236;&#xFF0C;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x6709;&#x6570;&#x636E;&#x5199;&#x5165;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x8BFB;&#x53D6;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
</li>
</ol>
<p>&#x8BE6;&#x7EC6;&#x7684;&#x6E90;&#x7801;&#x89E3;&#x8BFB;&#x8FD8;&#x662F;&#x8BF7;&#x770B;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#x8FD9;&#x4E00;&#x7AE0;&#x8282;&#xFF0C;&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x5F20;Memcached&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#x56FE;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/23705d6.jpg" alt=""></p>
<p>Memcached&#x7684;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x548C;&#x6D88;&#x606F;&#x56DE;&#x5E94; </p>
<ol>
<li><p>&#x6BCF;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;struct conn&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x8BE5;&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x4FDD;&#x5B58;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#xFF0C;&#x4EE5;&#x53CA;&#x8BFB;&#x53D6;&#x5BA2;&#x6237;&#x7AEF;&#x6570;&#x636E;&#x7684;buf&#x7ED3;&#x6784;&#xFF0C;&#x4EE5;&#x53CA;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x7684;iov&#x548C;msghdr&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
</li>
<li><p>Memcached&#x7684;&#x547D;&#x4EE4;&#x662F;&#x901A;&#x8FC7;\n&#x7B26;&#x53F7;&#x6765;&#x8FDB;&#x884C;&#x5206;&#x5272;&#x7684;&#x3002;&#x5F53;&#x63A5;&#x6536;&#x5230;&#x4E00;&#x4E32;&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;rbuf&#x4E2D;&#x662F;&#x5426;&#x6709;\n&#x7B26;&#x53F7;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x5219;&#x7EE7;&#x7EED;&#x7B49;&#x5F85;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x5230;&#x6765;&#xFF1B;&#x5982;&#x679C;&#x6709;\n&#x7B26;&#x53F7;&#xFF0C;&#x5219;&#x53BB;&#x89E3;&#x6790;&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x3002;</p>
</li>
<li><p>&#x6BCF;&#x4E2A;&#x547D;&#x4EE4;&#x884C;&#x547D;&#x4EE4;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x7B26;&#x53F7;&#x5206;&#x5272;&#x7684;&#x3002;&#x4F8B;&#x5982;&#xFF1A;get username&#x3002;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x7B26;&#x53F7;&#xFF0C;&#x5C06;&#x547D;&#x4EE4;&#x5206;&#x89E3;&#x6210;N&#xFF08;N&#x5C0F;&#x4E8E;8&#xFF09;&#x4E2A;&#x90E8;&#x5206;&#xFF0C;&#x7136;&#x540E;&#x653E;&#x5165;tokens&#x7684;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x4E2D;&#x3002;&#x7136;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x547D;&#x4EE4;&#xFF0C;&#x6765;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x3002;</p>
</li>
<li><p>Memcached&#x7684;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;&#x5C01;&#x88C5;iov&#x548C;msghdr&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x8C03;&#x7528;sendmsg&#x65B9;&#x6CD5;&#x6765;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6570;&#x636E;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x4E5F;&#x662F;&#x901A;&#x8FC7;\n&#x7684;&#x7B26;&#x53F7;&#x6765;&#x5206;&#x9694;&#x547D;&#x4EE4;&#x884C;&#x3002;</p>
</li>
</ol>
<p>&#x5177;&#x4F53;&#x7684;&#x6E90;&#x7801;&#x89E3;&#x6790;&#xFF0C;&#x9700;&#x8981;&#x8BE6;&#x7EC6;&#x770B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x548C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x7684;&#x7AE0;&#x8282;&#x3002;</p>
<p>&#x770B;&#x4E00;&#x4E0B;conn&#x7ED3;&#x6784;&#x4E2D;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x51E0;&#x4E2A;&#x53C2;&#x6570;:</p>
<p><img src="http://taojinke.github.io/img/20150703/2370847.jpg" alt=""></p>
<p>&#x7136;&#x540E;&#x770B;&#x4E00;&#x4E0B;&#x6574;&#x4E2A;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x548C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x7684;&#x6D41;&#x7A0B;&#x56FE;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2370847.jpg" alt=""></p>
<p>Memcached&#x7684;&#x7F13;&#x5B58;&#x5B58;&#x50A8; </p>
<ol>
<li><p>Memcached&#x7684;&#x7F13;&#x5B58;&#x5B58;&#x50A8;&#x7684;&#x57FA;&#x672C;&#x5355;&#x5143;&#x662F;struct item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x6BCF;&#x4E00;&#x4E2A;item&#x90FD;&#x5305;&#x542B;&#x4E86;&#x5B58;&#x50A8;&#x7F13;&#x5B58;&#x7684;key&#xFF0C;key&#x7684;&#x957F;&#x5EA6;&#xFF0C;value&#x503C;&#xFF0C;value&#x503C;&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x7F13;&#x5B58;&#x6709;&#x6548;&#x671F;&#xFF0C;&#x6700;&#x8FD1;&#x8BBF;&#x95EE;&#x65F6;&#x95F4;&#x7B49;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>Memcached&#x5728;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x7684;&#x6570;&#x7EC4;&#xFF08;slabclass&#xFF09;&#x3002;slabclass&#x662F;&#x6570;&#x636E;&#x7A7A;&#x95F4;&#xFF0C;&#x89C4;&#x5B9A;&#x4E86;&#x4E0D;&#x540C;&#x957F;&#x5EA6;&#x7684;item&#x4F1A;&#x5B58;&#x50A8;&#x5728;&#x4E0D;&#x540C;&#x7684;slabclass_t&#x7684;&#x7ED3;&#x6784;&#x4E0A;&#x9762;&#x3002;&#x4F8B;&#x5982;slabclass<a href="http://taojinke.github.io/img/20150703/23705d6.jpg">0</a>&#x6700;&#x5927;&#x5B58;&#x50A8;96byte&#xFF0C;slabclass<a href="http://taojinke.github.io/img/20150703/2370847.jpg">1</a>&#x6700;&#x5927;&#x5B58;&#x50A8;120byte&#xFF0C;slabclass<a href="http://taojinke.github.io/img/20150703/237147c.jpg">2</a>&#x6700;&#x5927;&#x5B58;&#x50A8;150byte&#xFF0C;&#x5219;&#x5F53;&#x4E00;&#x4E2A;item&#x7684;&#x5927;&#x5C0F;&#x4E3A;135byte&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5B58;&#x50A8;&#x5728;slabclass<a href="http://taojinke.github.io/img/20150703/237147c.jpg">2</a>&#x4E0A;&#x9762;&#x3002;</p>
</li>
<li><p>Memcached&#x6BCF;&#x6B21;&#x5206;&#x914D;&#x5185;&#x5B58;&#x90FD;&#x662F;&#x4EE5;slab&#x4E3A;&#x57FA;&#x7840;&#x5355;&#x4F4D;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;slab&#x7684;&#x5927;&#x5C0F;&#x4E3A;1M&#x3002;slabclass&#x5728;&#x521D;&#x59CB;&#xFFFD;&#xFFFD;&#xFFFD;&#x7684;&#x65F6;&#x5019;&#xFF0C;Memcached&#x4F1A;&#x7ED9;&#x6BCF;&#x4E00;&#x4E2A;slabclass_t&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5206;&#x914D;&#x4E00;&#x4E2A;1M&#x5927;&#x5C0F;&#x7684;slab&#x3002;slab&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x5B58;&#x50A8;item&#x6570;&#x636E;&#x7684;&#xFF0C;&#x5F53;slab&#x88AB;&#x5206;&#x914D;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x6839;&#x636E;&#x6BCF;&#x4E2A;slabclass_t&#x6240;&#x80FD;&#x5B58;&#x50A8;&#x7684;&#x6700;&#x5927;size&#xFF08;slabclass_t-&gt;size&#xFF09;&#xFF0C;&#x6765;&#x5207;&#x5206;&#x6210;N&#x4E2A;item&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x8FD9;&#x90E8;&#x5206;item&#x653E;&#x5165;slabclass_t&#x7684;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#xFF08;*slots&#xFF09;&#xFF0C;&#x5F53;&#x9700;&#x8981;&#x4F7F;&#x7528;item&#x7684;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x4ECE;&#x8FD9;&#x4E2A;&#x7A7A;&#x95F2;&#x91CC;&#x5217;&#x8868;&#x4E2D;&#x53D6;&#x4E00;&#x4E2A;&#x3002;</p>
</li>
<li><p>&#x6BCF;&#x4E2A;slabclass_t&#x5206;&#x914D;&#x7684;item&#x5927;&#x5C0F;&#x90FD;&#x662F;&#x6839;&#x636E;slabclass_t-&gt;size&#x6765;&#x8BBE;&#x7F6E;&#x7684;&#xFF0C;&#x771F;&#x6B63;&#x5B58;&#x50A8;&#x7684;&#x65F6;&#x5019;&#x5B9E;&#x9645;item&#x7684;&#x5927;&#x5C0F;&#x53EF;&#x80FD;&#x4F1A;&#x5C0F;&#x4E8E;slabclass_t-&gt;size&#x7684;&#x60C5;&#x51B5;&#x3002;&#x6D6A;&#x8D39;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x51CF;&#x5C11;&#x5185;&#x5B58;&#x788E;&#x7247;&#xFF0C;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x8D77;&#x6765;&#x66F4;&#x52A0;&#x5408;&#x7406;&#x3002;</p>
</li>
<li><p>Memcached&#x5728;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x4E8E;HashTable&#x3002;&#x5F53;&#x6BCF;&#x6B21;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Item&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x4F1A;&#x5C06;item&#x7684;&#x5730;&#x5740;&#x6302;&#x8F7D;&#x5230;HashTable&#x4E0A;&#x53BB;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;key&#x6765;&#x67E5;&#x8BE2;&#x5230;&#x5BF9;&#x5E94;&#x7684;item&#x5730;&#x5740;&#x4E86;&#x3002;</p>
</li>
<li><p>&#x5F53;Memcached&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E0D;&#x591F;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x4ECE;LRU&#x94FE;&#x4E2D;&#x5F3A;&#x5236;&#x6DD8;&#x6C70;&#x4E00;&#x4E2A;item&#xFF0C;&#x8BA9;&#x5165;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#xFF0C;&#x4EE5;&#x4F9B;&#x4F7F;&#x7528;&#x3002;</p>
</li>
</ol>
<p>&#x8BE6;&#x7EC6;&#x7684;&#x6E90;&#x7801;&#x89E3;&#x8BFB;&#x8FD8;&#x5F97;&#x770B;&#x524D;&#x9762;&#x7684;&#x6587;&#x7AE0;&#xFF0C;Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#xFF0C;HashTable&#xFF0C;LRU&#xFF0C;&#x7F13;&#x5B58;&#x5B58;&#x50A8;&#x673A;&#x5236;slabs</p>
<p>&#x770B;&#x4E00;&#x4E0B;Item&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code><span class="xml">//item&amp;#x7684;&amp;#x5177;&amp;#x4F53;&amp;#x7ED3;&amp;#x6784;    
typedef struct _stritem </span><span class="expression">{    
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;    
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;    
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;    
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;    
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;<span class="variable">HashTable</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">Item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;    
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;    
    //&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>1;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">set</span><span class="end-block">/add</span><span class="end-block">/replace</span>&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>66<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>57;&amp;<span class="begin-block">#x</span>6<span class="variable">BB</span>5;    
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">BD</span>4;&amp;<span class="begin-block">#x</span>8<span class="variable">F</span>83;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5931;&amp;<span class="begin-block">#x</span>6548;    
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* <span class="variable">least</span> <span class="variable">recent</span> <span class="variable">access</span> *<span class="end-block">/    </span>
    //&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>13;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>38;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>45;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>6548;&amp;<span class="begin-block">#x</span>3002;    
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">Memcached</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>6<span class="variable">DD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>70;    
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* <span class="variable">expire</span> <span class="variable">time</span> *<span class="end-block">/    </span>
    /<span class="end-block">/value</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;    
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* <span class="variable">size</span> <span class="variable">of</span> <span class="variable">data</span> *<span class="end-block">/    </span>
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>3002;    
    //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;<span class="variable">refcount</span>&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">refcount</span> <span class="variable">-</span>1 = 0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;    
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;    
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">length</span> <span class="variable">of</span> <span class="variable">flags-and-length</span> <span class="variable">string</span> *<span class="end-block">/    </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> *<span class="end-block">/    </span>
    /<span class="end-block">/slabs</span>_<span class="variable">class</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">ID</span>&amp;<span class="begin-block">#x</span>3002;    
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* <span class="variable">which</span> <span class="variable">slab</span> <span class="variable">class</span> <span class="variable">we</span>&amp;<span class="variable">apos</span>;<span class="variable">re</span> <span class="variable">in</span> *<span class="end-block">/    </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span> <span class="variable">length</span>, <span class="variable">w</span><span class="end-block">/terminating null and padding </span>*<span class="end-block">/    </span>
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span>  
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> *<span class="end-block">/    </span>
    //&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;    
    <span class="variable">union</span> {    
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;    
        <span class="variable">char</span> <span class="variable">end</span>;    
    }</span><span class="xml"> data[];    
    /* if it_flags &amp;amp; ITEM_CAS we have 8 bytes CAS */    
    /* then null-terminated key */    
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */    
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */    
} item;</span>
</code></pre><p>slabclass&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code>//slabclass&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;    
typedef struct {    
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;slabclass&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item    
    unsigned int size;    
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;item.&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>; &amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;size&amp;<span class="symbol">#x51B3</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x3002</span>;    
    unsigned int perslab;    
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;slabclass&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;item&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF09</span>;freelist &amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;    
    //freelist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x7CFB</span>;    
    void *slots;           /* list of item ptrs */    
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item    
    //&amp;<span class="symbol">#x5F53</span>;sl_curr=<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x6210</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF09</span>;    
    unsigned int sl_curr;   /* total free items in list */    
    //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;slabs    
    unsigned int slabs;     /* how many slabs were allocated for this class */    
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;    
    void **slab_list;       /* array of slab pointers */    
    unsigned int list_size; /* size of prev array */    
    unsigned int killing;  /* index+<span class="number">1</span> of dying slab, or zero if none */    
    //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;bytes    
    size_t requested; /* <span class="class">The</span> number of requested bytes */    
} slabclass_t;    
//&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x4E49</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;<span class="number">200</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7684</span>;slabclass_t&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x3002</span>;    
static slabclass_t slabclass[<span class="class">MAX_NUMBER_OF_SLAB_CLASSES</span>];
</code></pre><p>slabclass&#x548C;slab&#x3001;item&#x4EE5;&#x53CA;free list&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/237147c.jpg" alt=""></p>
<p>&#x901A;&#x8FC7;item&#x7684;size&#x6765;&#x9009;&#x62E9;slab_class&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/23716ed.jpg" alt=""></p>
<p>HashTable&#xFF0C;Memcahced&#x4E3B;&#x8981;&#x901A;&#x8FC7;HashTable&#x6765;&#x67E5;&#x8BE2;Item&#x7684;&#x5730;&#x5740;&#xFF1A;&#xA0;</p>
<p><img src="http://taojinke.github.io/img/20150703/237195e.jpg" alt=""></p>
<p>LUR&#x94FE;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x5206;&#x914D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FDB;&#x884C;item&#x7684;&#x6DD8;&#x6C70;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2371bcf.jpg" alt=""></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2348d83/" title="memcache源代码研究 - 数据结构篇（上） -" itemprop="url">memcache源代码研究 - 数据结构篇（上） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="LIBEVENT_THREAD">LIBEVENT_THREAD</h4><p>&#x2003;&#x2003; LIBEVENT_THREAD &#x4EE3;&#x8868;&#x7684;&#x662F; memcache &#x91CC;&#x7684; worker thread&#xFF0C;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code>typedef struct {  
    pthread_t thread_id;        /<span class="keyword">*</span> unique ID of this thread <span class="keyword">*</span>/
    struct event_base <span class="keyword">*</span>base;    /<span class="keyword">*</span> libevent handle this thread uses <span class="keyword">*</span>/
    struct event notify_event;  /<span class="keyword">*</span> listen event for notify pipe <span class="keyword">*</span>/
    int notify_receive_fd;      /<span class="keyword">*</span> receiving end of notify pipe <span class="keyword">*</span>/
    int notify_send_fd;         /<span class="keyword">*</span> sending end of notify pipe <span class="keyword">*</span>/
    struct thread_stats stats;  /<span class="keyword">*</span> Stats generated by this thread <span class="keyword">*</span>/
    struct conn_queue <span class="keyword">*</span>new_conn_queue; /<span class="keyword">*</span> queue of new connections to handle <span class="keyword">*</span>/
    cache_t <span class="keyword">*</span>suffix_cache;      /<span class="keyword">*</span> suffix cache <span class="keyword">*</span>/
} LIBEVENT_THREAD;
</code></pre><p>&#x91CC;&#x9762;&#x7684;&#x6570;&#x636E;&#x6210;&#x5458;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E; main thread &#x4E0E; worker thread &#x4E4B;&#x95F4;&#x901A;&#x4FE1;&#x7684;&#x3002;&#x4E3B;&#x8FDB;&#x7A0B;&#x6BCF;&#x6B21;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; pipe&#xFF0C;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x91CC;&#x5BF9;&#x5E94;&#x7684;&#x662F; notify_send_fd &#x548C; notify_receive_fd &#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code><span class="atom">void</span> <span class="atom">memcached_thread_init</span>(...) {  
    ...
    <span class="atom">for</span> (<span class="atom">i</span> = <span class="number">0</span>; <span class="atom">i</span> &amp;<span class="atom">lt</span>; <span class="atom">nthreads</span>; <span class="atom">i</span>++) {
    <span class="atom">int</span> <span class="atom">fds</span>[<span class="number">2</span>];
    <span class="atom">if</span> (<span class="atom">pipe</span>(<span class="atom">fds</span>)) { // &amp;<span class="atom">lt</span>;-- &amp;#<span class="atom">x521B</span>;&amp;#<span class="atom">x5EFA</span>; <span class="atom">pipe</span>
        ...
    }
    <span class="atom">threads</span>[<span class="atom">i</span>].<span class="atom">notify_receive_fd</span> = <span class="atom">fds</span>[<span class="number">0</span>];
    <span class="atom">threads</span>[<span class="atom">i</span>].<span class="atom">notify_send_fd</span> = <span class="atom">fds</span>[<span class="number">1</span>];
    <span class="atom">setup_thread</span>(&amp;<span class="atom">amp</span>;<span class="atom">threads</span>[<span class="atom">i</span>]);
       ...
    }
    ...
}
</code></pre><p>&#x6BCF;&#x5F53;&#x6709;&#x65B0;&#x7684;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3B;&#x8FDB;&#x7A0B;&#x5C31;&#x4F1A;&#x5F80; notify_send_fd &#x91CC;&#x5199;&#x6570;&#x636E;&#x6765;&#x901A;&#x77E5;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF0C;&#x5B50;&#x7EBF;&#x7A0B;&#x63A5;&#x5230;&#x6D88;&#x606F;&#x4E4B;&#x540E;&#x4F1A;&#x521B;&#x5EFA;&#x65B0;&#x7684;connection&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code><span class="xml">void dispatch_conn_new(...) </span><span class="expression">{  
    <span class="variable">CQ</span>_<span class="variable">ITEM</span> *<span class="variable">item</span> = <span class="variable">cqi</span>_<span class="variable">new</span>(); /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> <span class="variable">CQ</span>_<span class="variable">ITEM</span> &amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>8;&amp;<span class="begin-block">#x</span>5173;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5404;&amp;<span class="begin-block">#x</span>79<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;
    <span class="variable">char</span> <span class="variable">buf</span>[1];
    <span class="variable">...</span>
    <span class="variable">int</span> <span class="variable">tid</span> = (<span class="variable">last</span>_<span class="variable">thread</span> + 1) % <span class="variable">settings.num</span>_<span class="variable">threads</span>;
    <span class="variable">LIBEVENT</span>_<span class="variable">THREAD</span> *<span class="variable">thread</span> = <span class="variable">threads</span> + <span class="variable">tid</span>; /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>9009;&amp;<span class="begin-block">#x</span>62<span class="variable">E</span>9;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>50;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;
    <span class="variable">last</span>_<span class="variable">thread</span> = <span class="variable">tid</span>;
    /<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>5404;&amp;<span class="begin-block">#x</span>79<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span> = <span class="variable">sfd</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">init</span>_<span class="variable">state</span> = <span class="variable">init</span>_<span class="variable">state</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">event</span>_<span class="variable">flags</span> = <span class="variable">event</span>_<span class="variable">flags</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span> = <span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span> = <span class="variable">transport</span>; 
    <span class="variable">cq</span>_<span class="variable">push</span>(<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">new</span>_<span class="variable">conn</span>_<span class="variable">queue</span>, <span class="variable">item</span>); /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>42;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>538<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5165;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7684; <span class="variable">connection</span> &amp;<span class="begin-block">#x</span>961<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;
    <span class="variable">...</span>
    <span class="variable">buf</span>[0] = &amp;<span class="variable">apos</span>;<span class="variable">c</span>&amp;<span class="variable">apos</span>;;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">write</span>(<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">notify</span>_<span class="variable">send</span>_<span class="variable">fd</span>, <span class="variable">buf</span>, 1) != 1) { /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7; <span class="variable">pipe</span> &amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>77<span class="variable">E</span>5; <span class="variable">worker</span> <span class="variable">thread</span>
        <span class="variable">perror</span>(&amp;<span class="variable">quot</span>;<span class="variable">Writing</span> <span class="variable">to</span> <span class="variable">thread</span> <span class="variable">notify</span> <span class="variable">pipe</span>&amp;<span class="variable">quot</span>;);
    }</span><span class="xml">
}



// &amp;#x5B50;&amp;#x7EBF;&amp;#x7A0B;&amp;#x63A5;&amp;#x6536;&amp;#x8BF7;&amp;#x6C42;&amp;#x901A;&amp;#x77E5;
static void thread_libevent_process(int fd, short which, void *arg) </span><span class="expression">{  
    <span class="variable">...</span>
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">read</span>(<span class="variable">fd</span>, <span class="variable">buf</span>, 1) != 1)
        <span class="variable">...</span>
    <span class="variable">switch</span> (<span class="variable">buf</span>[0]) {
    <span class="variable">case</span> &amp;<span class="variable">apos</span>;<span class="variable">c</span>&amp;<span class="variable">apos</span>;:
    <span class="variable">item</span> = <span class="variable">cq</span>_<span class="variable">pop</span>(<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">new</span>_<span class="variable">conn</span>_<span class="variable">queue</span>); /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;&amp;<span class="begin-block">#x</span>961<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>91<span class="variable">CC</span>;&amp;<span class="begin-block">#x</span>9762;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>42;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">NULL</span> != <span class="variable">item</span>) {
        /<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>521<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EFA</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;
        <span class="variable">conn</span> *<span class="variable">c</span> = <span class="variable">conn</span>_<span class="variable">new</span>(<span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">init</span>_<span class="variable">state</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">event</span>_<span class="variable">flags</span>,
                           <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>, <span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">base</span>);
       <span class="variable">...</span>
    }</span><span class="xml">
        break;
   ...
   }
}</span>
</code></pre><h4 id="connection">connection</h4><p>&#x2003;&#x2003; connection &#x4EE3;&#x8868;&#x7684;&#x662F;&#x670D;&#x52A1;&#x63A5;&#x6536;&#x7684;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x3002;&#x5982;&#x4E0A;&#x9762;&#x6CE8;&#x91CA;&#x91CC;&#x63D0;&#x5230;&#x7684;&#xFF0C;&#x662F;&#x5728;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x63A5;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#x521B;&#x5EFA;&#x7684;&#x3002; connection &#x5185;&#x90E8;&#x7ED3;&#x6784;&#x6BD4;&#x8F83;&#x5E9E;&#x5927;&#xFF0C;&#x58F0;&#x660E;&#x4E86;&#x4E0E;&#x8FDE;&#x63A5;&#x76F8;&#x5173;&#x7684;&#x5404;&#x79CD;&#x53D8;&#x91CF;&#x3002;&#x6BD4;&#x5982;&#x5176;&#x4E2D;&#x7684; rbuf &#x548C; rbytes &#xFF0C;&#x5B83;&#x4EEC;&#x662F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x4ECE; socket &#x8FDE;&#x63A5;&#x4E2D;&#x8BFB;&#x53D6;&#x7684;&#x5185;&#x5BB9;&#x7684;&#xFF0C;&#x8FD8;&#x6709; rcurr &#x5219;&#x662F;&#x7528;&#x6765;&#x6807;&#x8BB0; rbuf &#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x5230;&#x4E86;&#x54EA;&#x91CC;&#x3002; </p>
<p>memcached &#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x53EB;&#x505A; conns &#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x7528;&#x6765;&#x7F13;&#x5B58;&#x6240;&#x6709;&#x8FDE;&#x63A5;&#x3002;&#x5F53;&#x8C03;&#x7528; conn_new &#x51FD;&#x6570;&#x521B;&#x5EFA;&#x65B0;&#x7684; connection &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5148;&#x4ECE; conns &#x5F53;&#x4E2D;&#x67E5;&#x8BE2;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x4E86;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5219;&#x8FD4;&#x56DE;&#x73B0;&#x6709;&#x7684; connection &#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x624D;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#xFF0C;&#x4EE3;&#x7801;&#x5927;&#x81F4;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code>conn *conn_new(...) {  
    conn *<span class="built_in">c</span>;
    <span class="built_in">assert</span>(sfd &amp;gt;= <span class="number">0</span> &amp;amp;&amp;amp; sfd &amp;lt; max_fds);
    <span class="built_in">c</span> = conns[sfd];
    <span class="keyword">if</span> (<span class="type">NULL</span> == <span class="built_in">c</span>) {
        <span class="comment">// &amp;#x521B;&amp;#x5EFA;&amp;#x65B0;&amp;#x7684; connection</span>
        ...
        <span class="built_in">c</span>-&amp;gt;sfd = sfd;
        conns[sfd] = <span class="built_in">c</span>;
    }
    <span class="comment">// &amp;#x4F7F;&amp;#x7528;&amp;#x7F13;&amp;#x5B58;&amp;#x7684; connection</span>
    ...
    <span class="keyword">return</span> <span class="built_in">c</span>;
}
</code></pre><h4 id="slabclass_t_&amp;_item">slabclass_t &amp; item</h4><p>slabclass_t &#x548C; item &#x662F; memcache &#x91CC;&#x4E0E;&#x7F13;&#x5B58;&#x529F;&#x80FD;&#x548C;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x76F8;&#x5173;&#x8054;&#x7684;&#x5173;&#x952E;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002; </p>
<p>To be continued …</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/数据结构/">数据结构</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2374f14/" title="memcache 源代码研究 - 请求处理流程 -" itemprop="url">memcache 源代码研究 - 请求处理流程 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> memcache &#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x6D41;&#x7A0B;&#x4E3B;&#x8981;&#x96C6;&#x4E2D;&#x5728; drive_machine &#x51FD;&#x6570;&#x91CC;&#x9762;&#xFF0C; drive_machine &#x662F;&#x4E00;&#x4E2A;&#x72B6;&#x6001;&#x673A;&#xFF0C;&#x91CC;&#x9762;&#x5B9A;&#x4E49;&#x7684;&#x72B6;&#x6001;&#x5982;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;: </p>
<pre><code><span class="class"><span class="keyword">enum</span> <span class="title">conn_states</span> </span>{  
    conn_listening,  
    conn_new_cmd,    
    conn_waiting,    
    conn_read,       
    conn_parse_cmd,  
    conn_write,      
    conn_nread,      
    conn_swallow,    
    conn_closing,    
    conn_mwrite,     
    conn_closed,     
    conn_max_state   
};
</code></pre><p>&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x5927;&#x81F4;&#x6D41;&#x7A0B;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x63A5;&#x6536;&#x65B0;&#x7684;socket&#x8FDE;&#x63A5;&#xFF0C;&#x5206;&#x53D1;&#x7ED9; worker thread</li>
<li>worker thread &#x7B49;&#x5F85;socket&#x8FDE;&#x63A5;&#x4F20;&#x6765;&#x7684;&#x5185;&#x5BB9;</li>
<li>&#x89E3;&#x6790;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x8FC7;&#x6765;&#x7684;&#x547D;&#x4EE4;&#x5E76;&#x6267;&#x884C;</li>
<li>&#x5982;&#x679C;&#x547D;&#x4EE4;&#x662F; quit &#xFF0C;&#x5219;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF0C;&#x5E76;&#x6E05;&#x7406;&#x4E0E;&#x8FDE;&#x63A5;&#x76F8;&#x5173;&#x7684;&#x5185;&#x5B58;&#x6570;&#x636E;&#x3002;</li>
<li>&#x5982;&#x679C;&#x4E0D;&#x662F; quit &#xFF0C;&#x6267;&#x884C;&#x5B8C;&#x547D;&#x4EE4;&#x540E;&#xFF0C;&#x5219;&#x91CD;&#x590D;&#x6B65;&#x9AA4;2&#x3001;3</li>
</ol>
<p>&#x8BE6;&#x7EC6;&#x6D41;&#x7A0B;&#x5927;&#x81F4;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/237406e.png" alt=""></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2385931/" title="C# memcache -" itemprop="url">C# memcache -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="&#x6982;&#x8FF0;">&#x6982;&#x8FF0;</h2><p>memcache&#x662F;&#x4E00;&#x5957;&#x5F00;&#x653E;&#x6E90;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#x3002;&#x7531;&#x670D;&#x52A1;&#x7AEF;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x7EC4;&#x6210;&#xFF0C;&#x4EE5;&#x5B88;&#x62A4;&#x7A0B;&#x5E8F;(&#x76D1;&#x542C;)&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#x4E8E;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x4E2D;&#xFF0C;&#x968F;&#x65F6;&#x4F1A;&#x63A5;&#x6536;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x548C;&#x64CD;&#x4F5C;&#x3002;memcache&#x4E3B;&#x8981;&#x628A;&#x6570;&#x636E;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x5DE8;&#x5927;&#x7684;hash&#x8868;&#x3002;&#x7B80;&#x5355;&#x7684;&#x8BF4;&#x5C31;&#x662F;&#x5C06;&#x6570;&#x636E;&#x8C03;&#x7528;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x4ECE;&#x5185;&#x5B58;&#x4E2D;&#x8BFB;&#x53D6;&#xFF0C;&#x4ECE;&#x800C;&#x5927;&#x5927;&#x63D0;&#x9AD8;&#x8BFB;&#x53D6;&#x901F;&#x5EA6;&#x3002;memcache&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;/&#x503C;&#x5BF9;&#x7684;hashmap&#x8FDB;&#x884C;&#x5B58;&#x50A8;&#x5BF9;&#x8C61;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#x3002;memcache&#x662F;&#x7528;C&#x5199;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x7528;&#x4EFB;&#x4F55;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;memcached&#x534F;&#x8BAE;&#x4E0E;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x3002;</p>
<h4 id="&#x7279;&#x6027;&#xFF1A;">&#x7279;&#x6027;&#xFF1A;</h4><ul>
<li>&#x5728; Memcached&#x4E2D;&#x53EF;&#x4EE5;&#x4FDD;&#x5B58;&#x7684;item&#x6570;&#x636E;&#x91CF;&#x662F;&#x6CA1;&#x6709;&#x9650;&#x5236;&#x7684;&#xFF0C;&#x53EA;&#x8981;&#x5185;&#x5B58;&#x8DB3;&#x591F; &#x3002;</li>
<li>Memcached&#x5355;&#x8FDB;&#x7A0B;&#x5728;32&#x4F4D;&#x7CFB;&#x7EDF;&#x4E2D;&#x6700;&#x5927;&#x4F7F;&#x7528;&#x5185;&#x5B58;&#x4E3A;2G&#xFF0C;&#x82E5;&#x5728;64&#x4F4D;&#x7CFB;&#x7EDF;&#x5219;&#x6CA1;&#x6709;&#x9650;&#x5236;,&#x8FD9;&#x662F;&#x7531;&#x4E8E;32&#x4F4D;&#x7CFB;&#x7EDF;&#x9650;&#x5236;&#x5355;&#x8FDB;&#x7A0B;&#x6700;&#x591A;&#x53EF;&#x4F7F;&#x7528;2G&#x5185;&#x5B58;,&#x8981;&#x4F7F;&#x7528;&#x66F4;&#x591A;&#x5185;&#x5B58;&#xFF0C;&#x53EF;&#x4EE5;&#x5206;&#x591A;&#x4E2A;&#x7AEF;&#x53E3;&#x5F00;&#x542F;&#x591A;&#x4E2A;Memcached&#x8FDB;&#x7A0B; &#x3002;</li>
<li>&#x6700;&#x5927;30&#x5929;&#x7684;&#x6570;&#x636E;&#x8FC7;&#x671F;&#x65F6;&#x95F4;,&#x8BBE;&#x7F6E;&#x4E3A;&#x6C38;&#x4E45;&#x7684;&#x4E5F;&#x4F1A;&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x8FC7;&#x671F;&#xFF0C;&#x5E38;&#x91CF;REALTIME_MAXDELTA</li>
<li>&#x5355;&#x4E2A;item&#x6700;&#x5927;&#x6570;&#x636E;&#x662F;1MB&#xFF0C;&#x8D85;&#x8FC7;1MB&#x6570;&#x636E;&#x4E0D;&#x4E88;&#x5B58;&#x50A8;&#xFF0C;&#x5E38;&#x91CF;POWER_BLOCK 1048576&#x8FDB;&#x884C;&#x63A7;&#x5236;</li>
</ul>
<h2 id="Windows&#x4E0B;&#x5B89;&#x88C5;Memcache">Windows&#x4E0B;&#x5B89;&#x88C5;Memcache</h2><p>&#x4E86;&#x89E3;memcache&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x540E;&#xFF0C;&#x5728;&#x6765;&#x5C1D;&#x8BD5;&#x5728;windows&#x4E0B;&#x5B89;&#x88C5;memcache&#x670D;&#x52A1;&#x7AEF;&#x3002;</p>
<ol>
<li>&#x9996;&#x5148;&#x4E0B;&#x8F7D;memcache&#x5B89;&#x88C5;&#x6587;&#x4EF6;&#xFF1A;&#x3010; <a href="http://pan.baidu.com/s/1kTIISUb" target="_blank" rel="external">&#x5B89;&#x88C5;&#x5305;</a> &#x3011;&#x3002;&#x5B89;&#x88C5;&#x5305;&#x91CC;&#x9762;&#x4F1A;&#x6709;x64&#x548C;x86&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x6839;&#x636E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x6253;&#x5F00;&#x4F1A;&#x627E;&#x5230;memcached.exe&#x3002;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x53CC;&#x51FB;&#x8FD0;&#x884C;&#x5B89;&#x88C5;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;cmd&#x8FDB;&#x884C;&#x5B89;&#x88C5;&#x3002;</li>
<li>&#x5B89;&#x88C5;&#x6B65;&#x9AA4;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF1A;</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/238062f.png" alt=""></p>
<p>&#x6B65;&#x9AA4;:</p>
<p>1.&#x7A97;&#x53E3;+R&#xFF1A;&#x8F93;&#x5165;cmd</p>
<p>2.&#x8FDB;&#x884C;G&#x76D8;&#xFF1A; &#x8F93;&#x5165; G:</p>
<p>3.&#x8FDB;&#x884C;Memcached for window 32/64&#x7684;&#x5B89;&#x88C5;&#x76EE;&#x5F55;&#xFF1A;&#x8F93;&#x5165; cd CK\memcached_en32or64\x64</p>
<p>4.&#x5B89;&#x88C5;memcached:&#x8F93;&#x5165; memcached -d install</p>
<p>5.&#x542F;&#x52A8;&#x670D;&#x52A1;&#xFF1A;&#x8F93;&#x5165; memcached -d start</p>
<p>&#x542F;&#x52A8;&#x670D;&#x52A1;&#x540E;&#x5728;Windows&#x8FDB;&#x7A0B;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;memcached.exe.</p>
<p>memcached -d start|stop|shutdown|restart|uninstall|install &#x542F;&#x52A8;|&#x505C;&#x6B62;|&#x5173;&#x95ED;|&#x91CD;&#x542F;|&#x5378;&#x8F7D;|&#x5B89;&#x88C5;&#x3002;</p>
<p>&#x5B89;&#x88C5;&#x6B65;&#x9AA4;&#x4E0D;&#x662F;&#x5F88;&#x590D;&#x6742;&#x3002;&#x7B2C;&#x4E00;&#xFF1A;&#x627E;&#x5230;&#x6587;&#x4EF6;(memcached.exe)&#x8DEF;&#x5F84;&#x3002;&#x7B2C;&#x4E8C;&#xFF1A;&#xA0;memcached -d&#xA0;install &#xA0;&#x5C31;OK..</p>
<h4 id="&#x57FA;&#x672C;&#x9ED8;&#x8BA4;&#x53C2;&#x6570;&#x8BF4;&#x660E;&#xFF1A;">&#x57FA;&#x672C;&#x9ED8;&#x8BA4;&#x53C2;&#x6570;&#x8BF4;&#x660E;&#xFF1A;</h4><p>-p &#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;</p>
<p>-l &#x8FDE;&#x63A5;&#x7684;IP&#x5730;&#x5740;, &#x9ED8;&#x8BA4;&#x662F;&#x672C;&#x673A;</p>
<p>-d start &#x542F;&#x52A8;memcached&#x670D;&#x52A1;</p>
<p>-d restart &#x91CD;&#x8D77;memcached&#x670D;&#x52A1;</p>
<p>-d stop|shutdown &#x5173;&#x95ED;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;memcached&#x670D;&#x52A1;</p>
<p>-d install &#x5B89;&#x88C5;memcached&#x670D;&#x52A1;</p>
<p>-d uninstall &#x5378;&#x8F7D;memcached&#x670D;&#x52A1;</p>
<p>-u &#x4EE5;&#x7684;&#x8EAB;&#x4EFD;&#x8FD0;&#x884C; (&#x4EC5;&#x5728;&#x4EE5;root&#x8FD0;&#x884C;&#x7684;&#x65F6;&#x5019;&#x6709;&#x6548;)</p>
<p>-m &#x6700;&#x5927;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#xFF0C;&#x5355;&#x4F4D;MB&#x3002;&#x9ED8;&#x8BA4;64MB</p>
<p>-M &#x5185;&#x5B58;&#x8017;&#x5C3D;&#x65F6;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5220;&#x9664;&#x9879;</p>
<p>-c &#x6700;&#x5927;&#x540C;&#x65F6;&#x8FDE;&#x63A5;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1024</p>
<p>-f &#x5757;&#x5927;&#x5C0F;&#x589E;&#x957F;&#x56E0;&#x5B50;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1.25</p>
<p>-n &#x6700;&#x5C0F;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#xFF0C;key+value+flags&#x9ED8;&#x8BA4;&#x662F;48</p>
<p>-h &#x663E;&#x793A;&#x5E2E;&#x52A9;</p>
<p>&#x670D;&#x52A1;&#x5668;&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x672C;&#x673A;telnet &#x5230;&#x670D;&#x52A1;&#x6D4B;&#x8BD5;&#x4E00;&#x4E2A;&#x4E0B;&#x3002;&#xFF08;&#x5982;&#x679C;&#x63D0;&#x793A;telnet&#x547D;&#x4EE4;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x9700;&#x8981;&#x53BB;&#x63A7;&#x4EF6;&#x9762;&#x677F;&#x5F00;&#x542F;windows&#x7684;tel&#x670D;&#x52A1;&#x529F;&#x80FD;&#xFF0C;&#xA0;win7&#x7684;&#x5F00;&#x542F;tel&#x529F;&#x80FD;&#x64CD;&#x4F5C;&#x6B65;&#x9AA4;&#x662F;&#xFF1A;&#x3010;&#x63A7;&#x5236;&#x9762;&#x677F;&#x3011;-&gt;&#x3010;&#x7A0B;&#x5E8F;&#x548C;&#x529F;&#x80FD;&#x3011;-&gt;&#x3010;&#x6253;&#x5F00;&#x6216;&#x5173;&#x95ED;window&#x529F;&#x80FD;&#x3011;&#xFF0C;&#x7136;&#x540E;&#x627E;&#x5230;&#x5E76;&#x52FE;&#x9009;tel&#x76F8;&#x5173;&#x5373;&#x53EF;&#x3002;&#x5176;&#x4ED6;window&#x7CFB;&#x7EDF;&#x6B65;&#x9AA4;&#x7C7B;&#x4F3C;&#x3002;&#xFF09;</p>
<p>&#x6D4B;&#x8BD5;telnet&#x662F;&#x5426;&#x6B63;&#x5E38;&#x8FD0;&#x884C; telnet 172.21.0.192&#xA0;11211</p>
<p><img src="http://taojinke.github.io/img/20150703/2380d82.jpg" alt=""></p>
<p>&#x8FDB;&#x5165;&#x540E;&#x5148;&#x6309;ctrl+]&#x542F;&#x52A8;&#x56DE;&#x793A;&#x529F;&#x80FD;&#xFF0C;&#x5426;&#x5219;&#x65E0;&#x6CD5;&#x770B;&#x5230;&#x8F93;&#x5165;&#x4FE1;&#x606F;&#x3002;&#x56DE;&#x793A;&#x529F;&#x80FD;&#x542F;&#x52A8;&#x6210;&#x529F;&#x540E;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2380ff3.jpg" alt=""></p>
<p>&#x7136;&#x540E;&#x6309;&#x56DE;&#x8F66;&#x8F93;&#x5165;&#x53C2;&#x6570;stats:</p>
<p><img src="http://taojinke.github.io/img/20150703/2380ff3.jpg" alt=""></p>
<p><img src="http://taojinke.github.io/img/20150703/23814d5.jpg" alt=""></p>
<p>&#x5B89;&#x88C5;&#x548C;&#x6D4B;&#x8BD5;&#x5DE5;&#x4F5C;&#x5DF2;&#x5B8C;&#x6210;..</p>
<h2 id="&#x5B9E;&#x4F8B;&#x4EE3;&#x7801;">&#x5B9E;&#x4F8B;&#x4EE3;&#x7801;</h2><p>&#x6709;&#x5F88;&#x591A;C#&#x7248;&#x672C;&#x7684;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#x3002;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x662F;Memcached.ClientLibrary.dll&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;&#x8C03;&#x7528;&#x9700;&#x8981;&#x4E8C;&#x4E2A;DLL:</p>
<p>Memcached.ClientLibrary.dll &#xA0;(Memcached&#x5BA2;&#x6237;&#x7AEF;&#x7C7B;&#x5E93;)</p>
<p>log4net.dll (log4net&#x662F;&#x4E3A;Memcached&#x63D0;&#x4F9B;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;) &#xA0; &#xA0;&#xA0;DLL&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#xFF1A;&#x3010;&#x70B9;&#x51FB;&#x4E0B;&#x8F7D;&#x3011; </p>
<p>&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x5F15;&#x7528;&#x8FD9;&#x4E2A;&#x4E8C;&#x4E2A;dll,&#x5F15;&#x7528;log4net.dll&#x540E;&#x8FD8;&#x9700;&#x8FDB;&#x884C;&#x4E00;&#x7CFB;&#x5217;&#x914D;&#x7F6E;&#x5DE5;&#x4F5C;&#x3002;&#x5728;&#x4E0A;&#x7BC7;&#x535A;&#x5BA2;&#x4E2D;&#x6709;&#x5BF9;log4net&#x7684;&#x914D;&#x7F6E;&#x4ECB;&#x7ECD;&#x3002;</p>
<p><a href="http://www.cnblogs.com/caokai520/p/4387491.html" target="_blank" rel="external">&#x3010;Log4Net &#x65E5;&#x5FD7;&#x914D;&#x7F6E;[&#x9644;&#x5E26;&#x6E90;&#x7801;]&#x3011;</a></p>
<p>&#x6CE8;&#x610F;&#xFF1A;Memcached.ClientLibrary.dll&#x548C;log4net.dll&#x6709;&#x7248;&#x672C;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x3002;</p>
<p>2.&#x5982;&#x679C;&#x4F7F;&#x7528;WinForm&#x6216;&#x63A7;&#x5236;&#x53F0;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x628A;log4net&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x72EC;&#x7ACB;&#x51FA;&#x73B0;,&#x548C;&#x5199;&#x5728;App.config&#x91CC;&#x9762;&#x9700;&#x8981;&#x5C0F;&#x5C0F;&#x8BBE;&#x7F6E;&#x4E00;&#x4E0B;&#x3002;</p>
<p>&#x5982;&#x56FE;&#xFF1A;Log4Net.config&#x5C5E;&#x6027;&#x201C;&#x590D;&#x5236;&#x5230;&#x8F93;&#x51FA;&#x76EE;&#x5F55;&#x201D;&#xFF1A;&#x201C;&#x59CB;&#x7EC8;&#x590D;&#x5236;&#x201D;&#x3002;&#x4E0D;&#x7136;&#x5728;bin&#x76EE;&#x5F55;&#x4E0B;&#x627E;&#x4E0D;&#x5230;&#x5BF9;&#x5E94;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x4F1A;&#x4EA7;&#x751F;&#x62A5;&#x9519;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/2381746.jpg" alt=""></p>
<p>memcache&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;/&#x503C;&#x5BF9;&#x7684;hashmap&#x8FDB;&#x884C;&#x5B58;&#x50A8;&#x5BF9;&#x8C61;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x4E3B;&#x8981;&#x5728;&#x64CD;&#x4F5C;hashmap&#x7684;&#x952E;&#x503C;&#x5BF9;&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x4E00;&#x4E9B;&#x7B80;&#x5355;&#x64CD;&#x4F5C;[&#x589E;&#xFF0C;&#x5220;&#xFF0C;&#x6539;&#xFF0C;&#x67E5;]&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;
string <span class="class">SockIOPoolName</span> = &amp;quot;<span class="class">Test_SockIOPoolName</span>&amp;quot;;
string[] <span class="class">MemcacheServiceList</span> = { &amp;quot;<span class="number">172.21</span>.0.192:<span class="number">11211</span>&amp;quot; };
//&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;
<span class="class">SockIOPool</span> <span class="class">SPool</span> = <span class="class">SockIOPool</span>.<span class="class">GetInstance</span>(<span class="class">SockIOPoolName</span>);
<span class="class">SPool</span>.<span class="class">SetServers</span>(<span class="class">MemcacheServiceList</span>);
<span class="class">SPool</span>.<span class="class">Initialize</span>();
//&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5316</span>;<span class="class">Client</span>
<span class="class">MemcachedClient</span> <span class="class">MClient</span> = new <span class="class">MemcachedClient</span>();
<span class="class">MClient</span>.<span class="class">PoolName</span> = <span class="class">SockIOPoolName</span>;
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="number">1.</span>&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;memcache&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;<span class="class">Hello</span> <span class="class">World</span>&amp;quot;);
<span class="class">MClient</span>.<span class="class">Add</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;, &amp;quot;<span class="class">Hello</span> <span class="class">World</span>&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="number">2.</span>&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;{<span class="number">0</span>}&amp;quot;, <span class="class">MClient</span>.<span class="class">Get</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;));
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="number">3.</span>&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;memcache&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;<span class="class">Hello</span> <span class="class">World</span>&amp;quot;);
<span class="class">MClient</span>.<span class="class">Set</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;, &amp;quot;<span class="class">Hello</span> <span class="class">World</span> - &amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x7248</span>;&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="number">4.</span>&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;{<span class="number">0</span>}&amp;quot;, <span class="class">MClient</span>.<span class="class">Get</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;));
if (<span class="class">MClient</span>.<span class="class">KeyExists</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;))
{
    <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="number">5.</span>&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;memcache&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;quot;);
    <span class="class">MClient</span>.<span class="class">Delete</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;);
}
if (<span class="class">MClient</span>.<span class="class">KeyExists</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;))
    <span class="class">Console</span>.<span class="class">WriteLine</span>(<span class="class">MClient</span>.<span class="class">Get</span>(&amp;quot;<span class="class">Key1001</span>&amp;quot;));
else
    <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="number">6.</span>&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;quot;);
</code></pre><p>&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/23819b7.jpg" alt=""></p>
<h2 id="Memcached&#x5206;&#x5E03;&#x5B58;&#x50A8;">Memcached&#x5206;&#x5E03;&#x5B58;&#x50A8;</h2><p>&#x4E0B;&#x9762;&#x5047;&#x8BBE;memcached&#x670D;&#x52A1;&#x5668;&#x6709;node1&#xFF5E;node3&#x4E09;&#x53F0;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8981;&#x4FDD;&#x5B58;&#x952E;&#x540D;&#x4E3A;&#x201C;tokyo&#x201D;&#x3001;&#x201C;kanagawa&#x201D;&#x3001;&#x201C;chiba&#x201D;&#x3001;&#x201C;saitama&#x201D;&#x3001;&#x201C;gunma&#x201D;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/23819b7.jpg" alt=""></p>
<p>&#x9996;&#x5148;&#x5411;memcached&#x4E2D;&#x6DFB;&#x52A0;&#x201C;tokyo&#x201D;&#x3002;&#x5C06;&#x201C;tokyo&#x201D;&#x4F20;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#x5E93;&#x540E;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7684;&#x7B97;&#x6CD5;&#x5C31;&#x4F1A;&#x6839;&#x636E; &#x201C;&#x952E;&#x201D; &#x6765;&#x51B3;&#x5B9A;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x7684;memcached&#x670D;&#x52A1;&#x5668;&#x3002;&#x670D;&#x52A1;&#x5668;&#x9009;&#x5B9A;&#x540E;&#xFF0C;&#x5373;&#x547D;&#x4EE4;&#x5B83;&#x4FDD;&#x5B58;&#x201C;tokyo&#x201D;&#x53CA;&#x5176;&#x503C;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2381c28.jpg" alt=""></p>
<p>&#x540C;&#x6837;&#xFF0C;&#x201C;kanagawa&#x201D;&#x3001;&#x201C;chiba&#x201D;&#x3001;&#x201C;saitama&#x201D;&#x3001;&#x201C;gunma&#x201D;&#x90FD;&#x662F;&#x5148;&#x9009;&#x62E9;&#x670D;&#x52A1;&#x5668;&#x518D;&#x4FDD;&#x5B58;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x83B7;&#x53D6;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x3002;&#x83B7;&#x53D6;&#x65F6;&#x4E5F;&#x8981;&#x5C06;&#x8981;&#x83B7;&#x53D6;&#x7684;&#x952E;&#x201C;tokyo&#x201D;&#x4F20;&#x9012;&#x7ED9;&#x51FD;&#x6570;&#x5E93;&#x3002;&#x51FD;&#x6570;&#x5E93;&#x901A;&#x8FC7;&#x4E0E;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x65F6;&#x76F8;&#x540C;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;&#x6839;&#x636E;&#x201C;&#x952E;&#x201D;&#x9009;&#x62E9;&#x670D;&#x52A1;&#x5668;&#x3002;&#x4F7F;&#x7528;&#x7684;&#x7B97;&#x6CD5;&#x76F8;&#x540C;&#xFF0C;&#x5C31;&#x80FD;&#x9009;&#x4E2D;&#x4E0E;&#x4FDD;&#x5B58;&#x65F6;&#x76F8;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x9001;get&#x547D;&#x4EE4;&#x3002;&#x53EA;&#x8981;&#x6570;&#x636E;&#x6CA1;&#x6709;&#x56E0;&#x4E3A;&#x67D0;&#x4E9B;&#x539F;&#x56E0;&#x88AB;&#x5220;&#x9664;&#xFF0C;&#x5C31;&#x80FD;&#x83B7;&#x5F97;&#x4FDD;&#x5B58;&#x7684;&#x503C;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/2381e99.jpg" alt=""></p>
<p>&#x8FD9;&#x6837;&#xFF0C;&#x5C06;&#x4E0D;&#x540C;&#x7684;&#x952E;&#x4FDD;&#x5B58;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x5C31;&#x5B9E;&#x73B0;&#x4E86;memcached&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x3002;memcached&#x670D;&#x52A1;&#x5668;&#x589E;&#x591A;&#x540E;&#xFF0C;&#x952E;&#x5C31;&#x4F1A;&#x5206;&#x6563;&#xFF0C;&#x5373;&#x4F7F;&#x4E00;&#x53F0;memcached&#x670D;&#x52A1;&#x5668;&#x53D1;&#x751F;&#x6545;&#x969C;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x5176;&#x4ED6;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x7CFB;&#x7EDF;&#x4F9D;&#x7136;&#x80FD;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x3002; &#xFF08;&#x53C2;&#x8003;&#xFF1A;memcached&#x5168;&#x9762;&#x5256;&#x6790;&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/2382ace.gif" alt=""></p>
<pre><code>//&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;
string[] <span class="class">MemcacheServiceList</span> = { &amp;quot;<span class="number">172.21</span>.0.192:<span class="number">11211</span>&amp;quot;, &amp;quot;<span class="number">172.21</span>.0.28:<span class="number">11211</span>&amp;quot;, &amp;quot;<span class="number">172.21</span>.13.246:<span class="number">11211</span>&amp;quot; };
//&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;
<span class="class">SockIOPool</span> <span class="class">SPool</span> = <span class="class">SockIOPool</span>.<span class="class">GetInstance</span>();
<span class="class">SPool</span>.<span class="class">SetServers</span>(<span class="class">MemcacheServiceList</span>);
<span class="class">SPool</span>.<span class="class">Initialize</span>();
<span class="class">MemcachedClient</span> <span class="class">MClient</span> = new <span class="class">MemcachedClient</span>();
<span class="class">MClient</span>.<span class="class">FlushAll</span>();
int count = <span class="number">5</span>;
var time = <span class="class">Stopwatch</span>.<span class="class">StartNew</span>();
for (int i = <span class="number">0</span>; i &amp;lt; count; i++)
{
    <span class="class">MClient</span>.<span class="class">Add</span>(i.<span class="class">ToString</span>(), &amp;quot;value&amp;quot; + i);
}
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;memcached&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8017</span>;&amp;<span class="symbol">#x65F6</span>;:{<span class="number">0</span>}&amp;quot;,time.<span class="class">ElapsedTicks</span>);
time = <span class="class">Stopwatch</span>.<span class="class">StartNew</span>();
for (int i = <span class="number">0</span>; i &amp;lt; count; i++)
{
    if (<span class="class">MClient</span>.<span class="class">KeyExists</span>(i.<span class="class">ToString</span>()))
    {
        <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">key:</span>{<span class="number">0</span>}.<span class="method">value:</span>{<span class="number">1</span>}&amp;quot;, i, <span class="class">MClient</span>.<span class="class">Get</span>(i.<span class="class">ToString</span>()));
    }
    else
    {
        <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;--------&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;<span class="method">key:</span>{<span class="number">0</span>}--------&amp;quot;,i);
    }
}
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;memcached&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8017</span>;&amp;<span class="symbol">#x65F6</span>;:{<span class="number">0</span>}&amp;quot;, time.<span class="class">ElapsedTicks</span>);
<span class="class">SPool</span>.<span class="class">Shutdown</span>();
</code></pre><p> View Code</p>
<p><a href="http://files.cnblogs.com/files/caokai520/Project.Memcache.rar" target="_blank" rel="external">&#x3010;&#x5B9E;&#x4F8B;&#x4EE3;&#x7801;&#x3011;</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/C/">C#</a><a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/17/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/61/">61</a><a class="extend next" rel="next" href="/page/19/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>606</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>10</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
