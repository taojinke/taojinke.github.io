
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/14/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
                        <a href="http://nodejs-xx.sblig.club/" target="_blank">NodeJs</a>
                    </li>
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/06/70d13cd/" title="Gulp 范儿——Gulp 高级技巧 -" itemprop="url">Gulp 范儿——Gulp 高级技巧 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-06T01:25:16.000Z" itemprop="datePublished"> 发表于 2015-07-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://gulpjs.com/" target="_blank" rel="external">Gulp.js</a> &#x4E0A;&#x624B;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x66F4;&#x591A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x662F;&#x4E00;&#x4E9B;&#x9AD8;&#x7EA7;&#x6280;&#x5DE7;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x57FA;&#x7840;&#x4F8B;&#x5B50;&#x3002;&#x672C;&#x6587;&#x4ECE;&#x9AD8;&#x7EA7;&#x3001;&#x5B9A;&#x5236;&#x5C42;&#x9762;&#xFF0C;&#x63A2;&#x8BA8;&#x4F7F;&#x7528; gulp.js &#x53CA;&#x76F8;&#x5173;&#x63D2;&#x4EF6;&#x3001;stream &#x8FC7;&#x7A0B;&#x5B58;&#x5728;&#x7684;&#x9677;&#x9631;&#x3002; </p>
<h2 id="&#x57FA;&#x7840;&#x4EFB;&#x52A1;">&#x57FA;&#x7840;&#x4EFB;&#x52A1;</h2><p>Gulp &#x7684;&#x8BED;&#x6CD5;&#x76F8;&#x6BD4; Grunt &#x8981;&#x76F4;&#x89C2;&#x5F88;&#x591A;&#xFF0C;&#x914D;&#x7F6E;&#x4E00;&#x4E2A;&#x57FA;&#x7840;&#x4EFB;&#x52A1;&#x5B8C;&#x5168;&#x662F;&#x5C0F;&#x83DC;&#x4E00;&#x789F;&#xFF1A;</p>
<pre><code>gulp.task<span class="params">(&amp;apos;scripts&amp;apos;, function<span class="params">()</span> {  
  return gulp.src<span class="params">(&amp;apos;./src/**/*.js&amp;apos;)</span>
    .pipe<span class="params">(uglify<span class="params">()</span>)</span>
    .pipe<span class="params">(concat<span class="params">(&amp;apos;all.min.js&amp;apos;)</span>)</span>
    .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;build/&amp;apos;)</span>)</span>;
})</span>;
</code></pre><p>&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x80FD;&#x591F;&#x5E94;&#x4ED8;&#x5F88;&#x591A;&#x60C5;&#x5F62;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x9700;&#x8981;&#x66F4;&#x591A;&#x5B9A;&#x5236;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x9047;&#x5230;&#x4E00;&#x4E9B;&#x68D8;&#x624B;&#x7684;&#x95EE;&#x9898;&#x3002;&#x672C;&#x6587;&#x5C06;&#x4ECB;&#x7ECD;&#x4E00;&#x90E8;&#x5206;&#x95EE;&#x9898;&#x5E76;&#x63D0;&#x4F9B;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;</p>
<h2 id="&#x4E0D;&#x517C;&#x5BB9;_stream&#xFF1F;">&#x4E0D;&#x517C;&#x5BB9; stream&#xFF1F;</h2><p>&#x4F7F;&#x7528; gulp &#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5076;&#x5C14;&#x4F1A;&#x9047;&#x5230; Streaming not supported &#x8FD9;&#x6837;&#x7684;&#x9519;&#x8BEF;&#x3002;&#x8FD9;&#x901A;&#x5E38;&#x662F;&#x56E0;&#x4E3A;&#x5E38;&#x89C4; stream &#x4E8E; vinyl &#x6587;&#x4EF6;&#x5BF9;&#x8C61;&#x6709;&#x5DEE;&#x5F02;&#xFF0C;&#x800C; gulp &#x63D2;&#x4EF6;&#x4F7F;&#x7528;&#x4E86;&#x53EA;&#x652F;&#x6301; buffer &#xFF08;&#x4E0D;&#x652F;&#x6301; stream&#xFF09;&#x7684;&#x5E93;&#x3002; </p>
<p>&#x6BD4;&#x5982;&#xFF0C;&#x4E0D;&#x80FD;&#x628A; Node stream &#x76F4;&#x63A5;&#x4F20;&#x9012;&#x7ED9; gulp &#x53CA;&#x5176;&#x63D2;&#x4EF6;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x8BD5;&#x56FE;&#x4F7F;&#x7528; <a href="https://www.npmjs.org/package/gulp-uglify" target="_blank" rel="external">gulp-uglify</a> &#x548C; <a href="https://www.npmjs.org/package/gulp-rename" target="_blank" rel="external">gulp-rename</a> &#x8F6C;&#x6362;&#x4E00;&#x4E2A;&#x8BFB;&#x53D6;&#x6D41;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528; gulp.dest() &#x5199;&#x5165;&#x7ED3;&#x679C;&#xFF1A; </p>
<pre><code>var uglify = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-uglify&amp;apos;);  </span>
var rename = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-rename&amp;apos;);</span>

gulp.task<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;bundle&amp;apos;, function() {  </span>
  return fs.createReadStream<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;app.js&amp;apos;)</span>
    .pipe<span class="list">(<span class="keyword">uglify</span><span class="list">()</span>)</span>
    .pipe<span class="list">(<span class="keyword">rename</span><span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;bundle.min.js&amp;apos;))</span>
    .pipe<span class="list">(<span class="keyword">gulp</span>.dest<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;dist/&amp;apos;));</span>
})</span><span class="comment">;</span></span></span></span></span></span></span></span>
</code></pre><p>&#x663E;&#x7136;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E0D;&#x4F1A;&#x6309;&#x7167;&#x9884;&#x671F;&#x6267;&#x884C;&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x80FD;&#x628A;&#x8BFB;&#x53D6;&#x6D41;&#x4F20;&#x9001;&#x7ED9; gulp &#x63D2;&#x4EF6;&#x5462;&#xFF1F;Gulp &#x4E0D;&#x662F;&#x4F20;&#x8BF4;&#x4E2D;&#x7684; <strong>streaming</strong> &#x6784;&#x5EFA;&#x5DE5;&#x5177;&#x5417;&#xFF1F;&#x6CA1;&#x9519;&#xFF0C;&#x4F46;&#x662F;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5FFD;&#x7565;&#x4E86; gulp &#x9884;&#x671F;&#x8F93;&#x5165;&#x7684;&#x662F; Vinyl &#x6587;&#x4EF6;&#x5BF9;&#x8C61;&#xFF0C;&#x76F4;&#x63A5;&#x8F93;&#x5165;&#x8BFB;&#x53D6;&#x6D41;&#x5F53;&#x7136;&#x4E0D;&#x884C;&#x3002; </p>
<h3 id="Vinyl_&#x6587;&#x4EF6;&#x5BF9;&#x8C61;">Vinyl &#x6587;&#x4EF6;&#x5BF9;&#x8C61;</h3><p>Gulp &#x4F7F;&#x7528; <a href="https://github.com/wearefractal/vinyl-fs" target="_blank" rel="external">vinyl-fs</a> &#xFF0C;&#x5E76;&#x4ECE; vinyl-fs &#x7EE7;&#x627F;&#x4E86; gulp.src() &#x548C; gulp.dest() &#x65B9;&#x6CD5;&#x3002;&#x800C; vinyl-fs &#x4F7F;&#x7528;&#x4E86; <a href="https://github.com/wearefractal/vinyl" target="_blank" rel="external">vinyl</a> &#x6587;&#x4EF6;&#x5BF9;&#x8C61;&#xFF0C;&#x5373; &#x300C;&#x865A;&#x62DF;&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x300D;&#x3002;&#x8981;&#x5728; gulp &#x53CA;&#x5176;&#x63D2;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x5E38;&#x89C4;&#x8BFB;&#x53D6;&#x6D41;&#xFF0C;&#x9700;&#x8981;&#x628A;&#x8BFB;&#x53D6;&#x6D41;&#x8F6C;&#x6362;&#x4E3A; vinyl &#x5148;&#x3002; </p>
<p><a href="https://www.npmjs.org/package/vinyl-source-stream" target="_blank" rel="external">vinyl-source-stream</a> &#x4FBF;&#x662F;&#x4E00;&#x4E2A;&#x8F6C;&#x6362;&#x5DE5;&#x5177;&#xFF1A; </p>
<pre><code>var source = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;vinyl-source-stream&amp;apos;);  </span>
var marked = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-marked&amp;apos;);</span>

fs.createReadStream<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;*.md&amp;apos;)  </span>
  .pipe<span class="list">(<span class="keyword">source</span><span class="list">()</span>)</span>
  .pipe<span class="list">(<span class="keyword">marked</span><span class="list">()</span>)</span>
  .pipe<span class="list">(<span class="keyword">gulp</span>.dest<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;dist/&amp;apos;));</span></span></span></span></span></span>
</code></pre><p>&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4F7F;&#x7528; [Browserify][] &#x6253;&#x5305;&#xFF0C;&#x6700;&#x540E;&#x628A;&#x7ED3;&#x679C;&#x8F6C;&#x6362;&#x6210; vinyl &#x6D41;&#x3002;</p>
<pre><code>var browserify = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;browserify&amp;apos;);  </span>
var uglify = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-uglify&amp;apos;);  </span>
var source = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;vinyl-source-stream&amp;apos;);</span>

gulp.task<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;bundle&amp;apos;, function() {  </span>
  return browserify<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;./src/app.js&amp;apos;)</span>
    .bundle<span class="list">()</span>
    .pipe<span class="list">(<span class="keyword">source</span><span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;bundle.min.js&amp;apos;))</span>
    .pipe<span class="list">(<span class="keyword">uglify</span><span class="list">()</span>)</span>
    .pipe<span class="list">(<span class="keyword">gulp</span>.dest<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;dist/&amp;apos;));</span>
})</span><span class="comment">;</span></span></span></span></span></span></span></span></span>
</code></pre><p>&#x641E;&#x5B9A;&#xFF01;vinyl-source-stream &#x4F7F;&#x7528;&#x6307;&#x5B9A;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A; vinyl &#x6587;&#x4EF6;&#x5B9E;&#x4F8B;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x4E0D;&#x518D;&#x4F7F;&#x7528; gulp-rename&#xFF08; gulp.dest &#x5C06;&#x7528;&#x6B64;&#x6587;&#x4EF6;&#x540D;&#x5199;&#x5165;&#x7ED3;&#x679C;&#xFF09;&#x3002; </p>
<h4 id="gulp-dest">gulp.dest</h4><p>gulp.dest() &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5199;&#x5165;&#x6D41;&#xFF0C;&#x4F7F;&#x7528;&#x6765;&#x81EA;&#x8BFB;&#x53D6;&#x6D41;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x521B;&#x5EFA;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x9700;&#x8981;&#x4F7F;&#x7528; <a href="https://www.npmjs.org/package/mkdirp" target="_blank" rel="external">mkdirp</a> &#x521B;&#x5EFA;&#x6587;&#x4EF6;&#x5939;&#x3002;&#x5199;&#x5165;&#x6587;&#x4EF6;&#x540E;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x4F20;&#x9001; stream &#x8FDB;&#x884C;&#x5176;&#x4ED6;&#x64CD;&#x4F5C;&#xFF08;&#x6BD4;&#x5982; gzip &#x6570;&#x636E;&#x7136;&#x540E;&#x5199;&#x5165;&#x5176;&#x4ED6;&#x6587;&#x4EF6;&#xFF09;&#x3002; </p>
<h3 id="stream_&#x548C;_Buffer">stream &#x548C; Buffer</h3><p>Vinyl &#x53EF;&#x7528;&#x4E8E;&#x5305;&#x542B; buffer &#x6216; stream &#x518D;&#x6216;&#x8005; null &#x7684;&#x865A;&#x62DF;&#x6587;&#x4EF6;&#x3002; </p>
<p>&#x5BF9;&#x4E8E;&#x5E38;&#x89C4;&#x8BFB;&#x53D6;&#x6D41;&#xFF0C;&#x53EF;&#x4EE5;&#x76D1;&#x542C;&#x53D1;&#x5C04;&#x7684;&#x6570;&#x636E;&#x5757;&#xFF08;chunk&#xFF09;&#xFF1A;</p>
<pre><code>fs<span class="built_in">.</span>createReadStream(<span class="subst">&amp;</span>apos;/usr/share/dict/words<span class="subst">&amp;</span>apos;)<span class="built_in">.</span><span class="keyword">on</span>(<span class="subst">&amp;</span>apos;<span class="built_in">data</span><span class="subst">&amp;</span>apos;, function(chunk) {  
  console<span class="built_in">.</span><span class="keyword">log</span>(<span class="subst">&amp;</span>apos;Read <span class="subst">%</span>d <span class="built_in">bytes</span> of <span class="built_in">data</span><span class="subst">&amp;</span>apos;, chunk<span class="built_in">.</span>length);
});


<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; <span class="attribute">...</span>
</code></pre><p>&#x4E0E;&#x4E4B;&#x76F8;&#x53CD;&#xFF0C; gulp.src() &#x628A;&#x8F6C;&#x6362;&#x6210; buffer &#x7684; vinyl &#x6587;&#x4EF6;&#x5BF9;&#x8C61;&#x53D1;&#x5C04;&#x56DE; stream&#xFF0C;&#x56E0;&#x6B64; gulp &#x4E2D;&#x5F97;&#x5230;&#x7684;&#x4E0D;&#x662F;&#x6570;&#x636E;&#x5757;&#xFF08;chunk&#xFF09;&#xFF0C;&#x800C;&#x662F;&#x5305;&#x542B; buffer &#x7684;&#x865A;&#x62DF;&#x6587;&#x4EF6;&#x3002;Vinyl &#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x6709;&#x4E00;&#x4E2A; contents &#x5C5E;&#x6027;&#x6765;&#x5448;&#x73B0;&#x91CC;&#x9762;&#x662F; buffer &#x6216; stream&#x3002;Gulp &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; buffer&#xFF1A; </p>
<pre><code>gulp.src(&amp;apos;/usr/share/dict/<span class="property">words</span>&amp;apos;).<span class="keyword">on</span>(&amp;apos;data&amp;apos;, function(<span class="type">file</span>) {  
  console.<span class="command">log</span>(&amp;apos;Read %d bytes <span class="keyword">of</span> data&amp;apos;, <span class="type">file</span>.<span class="property">contents</span>.<span class="property">length</span>);
});


&amp;gt; Read <span class="number">2493109</span> bytes <span class="keyword">of</span> data
</code></pre><p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5C55;&#x793A;&#x4E86;&#x6574;&#x4E2A;&#x6587;&#x4EF6;&#x53D1;&#x5C04;&#x7ED9; stream &#x4E4B;&#x524D;&#xFF0C;&#x6570;&#x636E;&#x5148;&#x88AB;&#x8F6C;&#x6362;&#x6210; buffer &#x4E86;&#x3002;</p>
<h3 id="Gulp_&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;_buffer">Gulp &#x9ED8;&#x8BA4;&#x4F7F;&#x7528; buffer</h3><p>&#x867D;&#x7136;&#x4E00;&#x822C;&#x63A8;&#x8350; stream &#x5316;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x662F;&#x8BB8;&#x591A; gulp &#x63D2;&#x4EF6;&#x57FA;&#x4E8E;&#x4F7F;&#x7528; buffer &#x7684;&#x5E93;&#x5F00;&#x53D1;&#x3002;&#x6709;&#x65F6;&#x5219;&#x662F;&#x9700;&#x8981;&#x57FA;&#x4E8E;&#x5B8C;&#x6574;&#x7684;&#x6E90;&#x5185;&#x5BB9;&#x505A;&#x8F6C;&#x6362;&#xFF0C;&#x6BD4;&#x5982;&#x57FA;&#x4E8E;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x6B63;&#x5219;&#x66FF;&#x6362;&#xFF0C;&#x5206;&#x5757;&#x7684;&#x6587;&#x4EF6;&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x73B0;&#x5339;&#x914D;&#x9057;&#x6F0F;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x540C;&#x6837;&#x5730;&#xFF0C;&#x8BF8;&#x5982; <a href="http://lisperator.net/uglifyjs/" target="_blank" rel="external">UglifyJS</a> &#x53CA; <a href="https://github.com/google/traceur-compiler" target="_blank" rel="external">Traceur compiler</a> &#x4E4B;&#x7C7B;&#x7684;&#x5DE5;&#x5177;&#x4E5F;&#x9700;&#x8981;&#x5B8C;&#x6574;&#x7684;&#x6587;&#x4EF6;&#x8F93;&#x5165;&#xFF08;&#x81F3;&#x5C11;&#x662F; JavaScript &#x53E5;&#x6CD5;&#x5B8C;&#x6574;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF09;&#x3002; </p>
<p>&#x56E0;&#x6B64; gulp &#x9009;&#x62E9;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x8F6C;&#x6362;&#x6210; buffer &#x7684;&#x6D41;&#xFF0C;&#x4EE5;&#x65B9;&#x4FBF;&#x5904;&#x7406;&#x3002;</p>
<p>&#x4F7F;&#x7528;&#x8F6C;&#x6362;&#x6210; buffer &#x7684;&#x6D41;&#x7F3A;&#x70B9;&#x662F;&#x5BF9;&#x4E8E;&#x5927;&#x6587;&#x4EF6;&#x5904;&#x7406;&#x6548;&#x7387;&#x4F4E;&#x4E0B;&#xFF0C;&#x56E0;&#x4E3A;&#x6587;&#x4EF6;&#x53D1;&#x5C04;&#x56DE; stream &#x4E4B;&#x524D;&#x5FC5;&#x987B;&#x5B8C;&#x6574;&#x8BFB;&#x53D6;&#x3002;&#x4F46;&#x5BF9;&#x4E8E;&#x5E38;&#x89C1;&#x7684;&#x6587;&#x672C;&#x6587;&#x4EF6;&#xFF0C;&#x5982; JavaScript&#x3001;CSS&#x3001;&#x6A21;&#x677F;&#x7B49;&#xFF0C;&#x4F7F;&#x7528; buffer &#x53EA;&#x662F;&#x5F88;&#x5C0F;&#x7684;&#x82B1;&#x9500;&#xFF0C;&#x4E0D;&#x4F1A;&#x771F;&#x6B63;&#x635F;&#x5BB3;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x8BBE;&#x7F6E; buffer: false &#x9009;&#x9879;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9; gulp &#x7981;&#x7528; buffer&#xFF1A; </p>
<pre><code>gulp<span class="built_in">.</span>src(<span class="subst">&amp;</span>apos;/usr/share/dict/words<span class="subst">&amp;</span>apos;, {buffer: <span class="literal">false</span>})<span class="built_in">.</span><span class="keyword">on</span>(<span class="subst">&amp;</span>apos;<span class="built_in">data</span><span class="subst">&amp;</span>apos;, function(file) {  
  <span class="built_in">var</span> stream <span class="subst">=</span> file<span class="built_in">.</span>contents;
  stream<span class="built_in">.</span><span class="keyword">on</span>(<span class="subst">&amp;</span>apos;<span class="built_in">data</span><span class="subst">&amp;</span>apos;, function(chunk) {
    console<span class="built_in">.</span><span class="keyword">log</span>(<span class="subst">&amp;</span>apos;Read <span class="subst">%</span>d <span class="built_in">bytes</span> of <span class="built_in">data</span><span class="subst">&amp;</span>apos;, chunk<span class="built_in">.</span>length);
  });
});


<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; Read <span class="number">65536</span> <span class="built_in">bytes</span> of <span class="built_in">data</span>
<span class="subst">&amp;</span><span class="literal">gt</span>; <span class="attribute">...</span>
</code></pre><h2 id="stream_&#x548C;_buffer_&#x4E4B;&#x95F4;&#x8F6C;&#x6362;">stream &#x548C; buffer &#x4E4B;&#x95F4;&#x8F6C;&#x6362;</h2><h3 id="&#x4ECE;_stream_&#x5230;_buffer">&#x4ECE; stream &#x5230; buffer</h3><p>&#x57FA;&#x4E8E;&#x4F9D;&#x8D56;&#x7684;&#x6A21;&#x5757;&#x8FD4;&#x56DE;&#x7684;&#x662F; stream&#xFF0C; &#x4EE5;&#x53CA; gulp &#x63D2;&#x4EF6;&#x5BF9; stream &#x7684;&#x652F;&#x6301;&#x60C5;&#x51B5;&#xFF0C;&#x6709;&#x65F6;&#x9700;&#x8981;&#x628A; stream &#x8F6C;&#x6362;&#x4E3A; buffer&#xFF08;&#x53CD;&#x4E4B;&#x4EA6;&#x7136;&#xFF09;&#x3002;&#x5982;&#x524D;&#x9762;&#x6240;&#x8A00;&#xFF0C;&#x5F88;&#x591A;&#x63D2;&#x4EF6;&#x53EA;&#x652F;&#x6301; buffer&#xFF0C;&#x5982; <a href="https://www.npmjs.org/package/gulp-uglify" target="_blank" rel="external">gulp-uglify</a> &#x3001; <a href="https://www.npmjs.org/package/gulp-traceur" target="_blank" rel="external">gulp-traceur</a> &#xFF0C;&#x4F7F;&#x7528;&#x65F6;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <a href="https://www.npmjs.org/package/gulp-buffer" target="_blank" rel="external">gulp-buffer</a> &#x8F6C;&#x6362;&#xFF1A; </p>
<pre><code>var source = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;vinyl-source-stream&amp;apos;);  </span>
var buffer = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-buffer&amp;apos;);  </span>
var uglify = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-uglify&amp;apos;);</span>

fs.createReadStream<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;./src/app.js&amp;apos;)  </span>
  .pipe<span class="list">(<span class="keyword">source</span><span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;app.min.js&amp;apos;))</span>
  .pipe<span class="list">(<span class="keyword">buffer</span><span class="list">()</span>)</span>
  .pipe<span class="list">(<span class="keyword">uglify</span><span class="list">()</span>)</span>
  .pipe<span class="list">(<span class="keyword">gulp</span>.dest<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;dist/&amp;apos;));</span></span></span></span></span></span></span></span></span>
</code></pre><p>&#x6216;&#x8005;&#xFF0C;&#x86CB;&#x75BC;&#x7684;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code>var buffer = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-buffer&amp;apos;),  </span>
var traceur = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;gulp-traceur&amp;apos;);</span>

gulp.src<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;app.js&amp;apos;, {buffer: false})  </span>
  .pipe<span class="list">(<span class="keyword">buffer</span><span class="list">()</span>)</span>
  .pipe<span class="list">(<span class="keyword">traceur</span><span class="list">()</span>)</span>
  .pipe<span class="list">(<span class="keyword">gulp</span>.dest<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;dist/&amp;apos;));</span></span></span></span></span></span>
</code></pre><h3 id="&#x4ECE;_buffer_&#x5230;_stream">&#x4ECE; buffer &#x5230; stream</h3><p>&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4F7F;&#x7528; <a href="https://www.npmjs.org/package/gulp-streamify" target="_blank" rel="external">gulp-streamify</a> &#x6216;&#x8005; <a href="https://www.npmjs.org/package/gulp-stream" target="_blank" rel="external">gulp-stream</a> &#x63D2;&#x4EF6;&#xFF0C;&#x8BA9;&#x53EA;&#x652F;&#x6301; buffer &#x7684;&#x63D2;&#x4EF6;&#x76F4;&#x63A5;&#x5904;&#x7406; stream&#x3002;&#x8FD9;&#x6837;&#x5728;&#x57FA;&#x4E8E; buffer &#x7684;&#x63D2;&#x4EF6;&#x524D;&#x3001;&#x540E;&#x90FD;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x57FA;&#x4E8E; stream &#x7684;&#x63D2;&#x4EF6;&#x4E86;&#x3002; </p>
<pre><code>var wrap = require<span class="params">(&amp;apos;gulp-wrap&amp;apos;)</span>;  
var streamify = require<span class="params">(&amp;apos;gulp-streamify&amp;apos;)</span>;  
var uglify = require<span class="params">(&amp;apos;gulp-uglify&amp;apos;)</span>;  
var gzip = require<span class="params">(&amp;apos;gulp-gzip&amp;apos;)</span>;

gulp.src<span class="params">(&amp;apos;app.js&amp;apos;, {buffer: <span class="literal">false</span>})</span>  
  .pipe<span class="params">(wrap<span class="params">(&amp;apos;<span class="params">(function<span class="params">()</span>{&amp;lt;%= contents %&amp;gt;}<span class="params">()</span>)</span>;&amp;apos;)</span>)</span>
  .pipe<span class="params">(streamify<span class="params">(uglify<span class="params">()</span>)</span>)</span>
  .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;build&amp;apos;)</span>)</span>
  .pipe<span class="params">(gzip<span class="params">()</span>)</span>
  .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;build&amp;apos;)</span>)</span>;
</code></pre><h2 id="&#x4E0D;&#x8981;&#x8FC7;&#x5EA6;&#x4F9D;&#x8D56;&#x63D2;&#x4EF6;">&#x4E0D;&#x8981;&#x8FC7;&#x5EA6;&#x4F9D;&#x8D56;&#x63D2;&#x4EF6;</h2><p>&#x5C3D;&#x7BA1; Gulp &#x6709;&#x5F88;&#x591A;&#x4F7F;&#x7528;&#x3001;&#x65B9;&#x4FBF;&#x7684;&#x63D2;&#x4EF6;&#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x4E9B;&#x4EFB;&#x52A1;&#x4E0D;&#x4F7F;&#x7528;&#x63D2;&#x4EF6;&#x4E5F;&#x53EF;&#x4EE5;&#x8F7B;&#x677E;&#x5B8C;&#x6210;&#x3002;&#x63D2;&#x4EF6;&#x4F1A;&#x589E;&#x52A0;&#x989D;&#x5916;&#x7684; NPM &#x4F9D;&#x8D56;&#xFF0C;&#x63D2;&#x4EF6;&#x63A5;&#x53E3;&#x3001;&#x63D2;&#x4EF6;&#x8D28;&#x91CF;&#x7B49;&#x4E5F;&#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E9B;&#x7EF4;&#x62A4;&#x82B1;&#x9500;&#x3002;&#x5BF9;&#x4E8E;&#x6CA1;&#x6709;&#x63D2;&#x4EF6;&#x4E5F;&#x53EF;&#x4EE5;&#x8F7B;&#x677E;&#x5B9E;&#x73B0;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x6216;&#x8005;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6E90;&#x6A21;&#x5757;&#x7684;&#xFF0C;&#x5EFA;&#x8BAE;&#x4E0D;&#x8981;&#x4F7F;&#x7528;&#x63D2;&#x4EF6;&#x3002;</p>
<p>&#x7406;&#x89E3;&#x4E0A;&#x9762;&#x7684;&#x89C2;&#x70B9;&#x5BF9;&#x9488;&#x5BF9;&#x5B9E;&#x9645;&#x60C5;&#x5F62;&#x505A;&#x51FA;&#x6B63;&#x786E;&#x7684;&#x9009;&#x62E9;&#x5F88;&#x91CD;&#x8981;&#x3002;&#x6765;&#x770B;&#x51E0;&#x4E2A;&#x4F8B;&#x5B50;&#x3002;</p>
<h3 id="vinyl-source-stream">vinyl-source-stream</h3><p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x770B;&#x5230;&#x76F4;&#x63A5;&#x4F7F;&#x7528; Browserify &#x66FF;&#x4EE3; <a href="https://www.npmjs.org/package/gulp-browserify" target="_blank" rel="external">gulp-browserify</a> &#xFF08;&#x5DF2;&#x88AB; Gulp &#x5B98;&#x65B9;&#x62C9;&#x9ED1;&#xFF09;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x5B9E;&#x73B0;&#x8981;&#x70B9;&#x662F;&#x4F7F;&#x7528; vinyl-source-stream &#xFF08;&#x6216;&#x7C7B;&#x4F3C;&#x529F;&#x80FD;&#x7684;&#x6A21;&#x5757;&#xFF09;&#x628A;&#x5E38;&#x89C4;&#x8BFB;&#x53D6;&#x6D41;&#x8F93;&#x5165;&#x5230; Vinyl &#x63D2;&#x4EF6;&#x3002; </p>
<h3 id="&#x6587;&#x672C;&#x8F6C;&#x6362;&#x4EFB;&#x52A1;">&#x6587;&#x672C;&#x8F6C;&#x6362;&#x4EFB;&#x52A1;</h3><p>&#x53E6;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x662F;&#x57FA;&#x4E8E;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x8F6C;&#x6362;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x7840;&#x7684;&#x76F4;&#x63A5;&#x4F7F;&#x7528; vinyl buffer &#x7684;&#x63D2;&#x4EF6;&#xFF1A;</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">modify</span>(<span class="params">modifier</span>) </span>{  
  <span class="keyword">return</span> through2.obj(<span class="function"><span class="keyword">function</span>(<span class="params">file, encoding, done</span>) </span>{
    <span class="keyword">var</span> content = modifier(<span class="built_in">String</span>(file.contents));
    file.contents = <span class="keyword">new</span> Buffer(content);
    <span class="keyword">this</span>.push(file);
    done();
  });
}
</code></pre><p>&#x5728; gulp &#x4EFB;&#x52A1;&#x4E2D;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x4F7F;&#x7528;&#xFF1A;</p>
<pre><code>gulp.task<span class="params">(&amp;apos;modify&amp;apos;, function<span class="params">()</span> {  
  return gulp.src<span class="params">(&amp;apos;app.js&amp;apos;)</span>
    .pipe<span class="params">(modify<span class="params">(version)</span>)</span>
    .pipe<span class="params">(modify<span class="params">(swapStuff)</span>)</span>
    .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;build&amp;apos;)</span>)</span>;
})</span>;

<span class="function"><span class="keyword">function</span> <span class="title">version</span><span class="params">(data)</span> {</span>  
  return data.replace<span class="params">(/__VERSION__/, pkg.version)</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">swapStuff</span><span class="params">(data)</span> {</span>  
  return data.replace<span class="params">(/<span class="params">(\w+)</span>\s<span class="params">(\w+)</span>/, &amp;apos;$<span class="number">2</span>, $<span class="number">1</span>&amp;apos;)</span>;
}
</code></pre><p>&#x4E0A;&#x9762;&#x7684;&#x63D2;&#x4EF6;&#x8FD8;&#x4E0D;&#x5B8C;&#x5584;&#xFF0C;&#x6CA1;&#x6709;&#x5904;&#x7406; stream&#xFF0C;&#x4F46;&#x76F4;&#x89C2;&#x5C55;&#x793A;&#x4E86;&#x4F7F;&#x7528;&#x4E00;&#x4E9B;&#x57FA;&#x7840;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x8F6C;&#x6362;&#x4EFB;&#x52A1;&#x662F;&#x5F88;&#x5BB9;&#x6613;&#x7684;&#x3002; <a href="https://www.npmjs.org/package/through2" target="_blank" rel="external">through2</a> &#x662F;&#x4F18;&#x79C0;&#x7684; Node stream &#x5C01;&#x88C5;&#xFF0C;&#x4F7F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x50CF;&#x4E0A;&#x9762;&#x4E00;&#x6837;&#x5B9E;&#x73B0;&#x8F6C;&#x6362;&#x529F;&#x80FD;&#x3002; </p>
<h2 id="&#x4EFB;&#x52A1;&#x6D41;&#x7A0B;">&#x4EFB;&#x52A1;&#x6D41;&#x7A0B;</h2><p>&#x5982;&#x679C;&#x9700;&#x8981;&#x6267;&#x884C;&#x81EA;&#x5B9A;&#x4E49;&#x6216;&#x8005;&#x52A8;&#x6001;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x4E86;&#x89E3; gulp &#x6240;&#x4F7F;&#x7528;&#x7684; <a href="https://www.npmjs.org/package/orchestrator" target="_blank" rel="external">Orchestrator</a> &#x6A21;&#x5757;&#x4F1A;&#x5F88;&#x6709;&#x5E2E;&#x52A9;&#x3002; gulp.add &#x7B49;&#x540C;&#x4E8E; Orchestrator.add &#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x90FD;&#x7EE7;&#x627F;&#x81EA; Orchestrator &#x6A21;&#x5757;&#x3002;&#x4E0B;&#x5217;&#x60C5;&#x5F62;&#x53EF;&#x80FD;&#x4F1A;&#x9700;&#x8981; Orchestrator&#xFF1A; </p>
<ul>
<li>&#x4E0D;&#x60F3; gulp &#x4EFB;&#x52A1;&#x5217;&#x8868;&#x88AB;&#x300C;&#x79C1;&#x6709;&#x4EFB;&#x52A1;&#x300D;&#x5F04;&#x4E71;&#xFF08;&#x6BD4;&#x5982;&#x4E0D;&#x628A;&#x4EFB;&#x52A1;&#x66B4;&#x9732;&#x7ED9;&#x547D;&#x4EE4;&#x884C;&#x5DE5;&#x5177;&#xFF09;</li>
<li>&#x52A8;&#x6001;&#x6216;&#x8005;&#x53EF;&#x91CD;&#x7528;&#x7684;&#x5B50;&#x4EFB;&#x52A1;</li>
</ul>
<h2 id="&#x7EC8;&#x6781;&#x601D;&#x8003;">&#x7EC8;&#x6781;&#x601D;&#x8003;</h2><p>&#x8BF7;&#x6CE8;&#x610F; gulp &#xFF08;&#x6216;&#x8005; Grunt&#xFF09;&#x672C;&#x8EAB;&#x5E76;&#x4E0D;&#x662F;&#x6240;&#x6709;&#x573A;&#x666F;&#x7684;&#x6700;&#x4F73;&#x9009;&#x62E9;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x4EC5;&#x662F;&#x5408;&#x5E76;&#x3001;&#x538B;&#x7F29;&#x51E0;&#x4E2A; JavaScript&#xFF0C;&#x6216;&#x8005;&#x662F;&#x7F16;&#x8BD1; SASS&#xFF0C;&#x53EF;&#x80FD;&#x5E94;&#x8BE5;&#x8003;&#x8651;&#x4F7F;&#x7528; Makefile &#x6216;&#x8005; npm run &#xFF0C;&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x884C;&#x5B8C;&#x6210;&#x3002;&#x66F4;&#x5C11;&#x7684;&#x4F9D;&#x8D56;&#x3001;&#x66F4;&#x5C11;&#x7684;&#x914D;&#x7F6E;&#x624D;&#x662F;&#x6B63;&#x89E3;&#x3002; </p>
<p>&#x9605;&#x8BFB; <a href="http://substack.net/task_automation_with_npm_run" target="_blank" rel="external">&#x4F7F;&#x7528; npm run &#x5B9E;&#x73B0;&#x4EFB;&#x52A1;&#x81EA;&#x52A8;&#x5316;</a> &#x4EE5;&#x4E86;&#x89E3;&#x66F4;&#x591A;&#x3002;&#x9996;&#x5148;&#x6211;&#x4EEC;&#x8981;&#x660E;&#x786E;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x8FC7;&#x6784;&#x5EFA;&#x5B9E;&#x73B0;&#x4EC0;&#x4E48;&#xFF0C;&#x7136;&#x540E;&#x9009;&#x62E9;&#x6700;&#x9002;&#x5408;&#x7684;&#x5DE5;&#x5177;&#x3002; </p>
<p>&#x5F53;&#x7136;&#xFF0C;gulp &#x786E;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x4F18;&#x79C0;&#x7684;&#x6784;&#x5EFA;&#x7CFB;&#x7EDF;&#xFF0C;&#x6211;&#xFF08;&#x4F5C;&#x8005;&#xFF0C;&#x8BD1;&#x8005;&#x4E5F;&#x662F;&#xFF09;&#x5F88;&#x559C;&#x6B22;&#x4F7F;&#x7528;&#xFF0C;&#x4E5F;&#x8BA9;&#x6211;&#x9886;&#x7565;&#x5230; Node.js stream &#x7684;&#x5F3A;&#x5927;&#x3002;</p>
<p>&#x5E0C;&#x671B;&#x672C;&#x6587;&#x5BF9;&#x8BFB;&#x8005;&#x6709;&#x6240;&#x5E2E;&#x52A9;&#x3002;&#x5982;&#x6709;&#x4EFB;&#x4F55;&#x53CD;&#x9988;&#x6216;&#x8005;&#x5176;&#x4ED6;&#x6280;&#x5DE7;&#xFF0C;&#x8BF7;&#x5728;&#x8BC4;&#x8BBA;&#x6216;&#x4F5C;&#x8005; Twitter <a href="https://twitter.com/webprolific" target="_blank" rel="external">@webprolific</a> &#x4E2D;&#x7559;&#x8A00;&#x3002; </p>
<p>via <a href="https://medium.com/@webprolific/getting-gulpy-a2010c13d3d5" target="_blank" rel="external">Getting gulpy - Advanced tips for using gulp.js</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Gulp/">Gulp</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/06/705dba8/" title="最近的一些工作总结 -" itemprop="url">最近的一些工作总结 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-06T01:25:15.000Z" itemprop="datePublished"> 发表于 2015-07-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x6700;&#x8FD1;&#x4E00;&#x76F4;&#x5F88;&#x5FD9;&#x788C;&#xFF0C;&#x611F;&#x89C9;&#x65F6;&#x95F4;&#x8FC7;&#x7684;&#x5F88;&#x5FEB;&#xFF0C;&#x6765;&#x4E0A;&#x6D77;&#x6709;&#x4E8C;&#x5E74;&#x591A;&#x4E86;&#xFF0C;&#x8BB0;&#x5F97;&#x521A;&#x6765;&#x90A3;&#x4F1A;&#x4E00;&#x76F4;&#x611F;&#x89C9;&#x81EA;&#x5DF1;&#x5E74;&#x7EAA;&#x8FD8;&#x5C0F;&#xFF0C;&#x6CA1;&#x6709;&#x5F88;&#x591A;&#x987E;&#x8651;&#xFF0C;&#x60F3;&#x6CD5;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x627E;&#x4E00;&#x4EFD;&#x5DE5;&#x4F5C;&#xFF0C;&#x505A;&#x81EA;&#x5DF1;&#x559C;&#x6B22;&#x7684;&#x4E8B;&#xFF0C;&#x6BCF;&#x5929;&#x5C31;&#x4F1A;&#x5F88;&#x5F00;&#x5FC3;&#xFF0C;&#x603B;&#x5F97;&#x6765;&#x8BF4;&#x8FD8;&#x662F;&#x86EE;&#x5E78;&#x8FD0;&#x7684;&#xFF0C;&#x6CA1;&#x6709;&#x90A3;&#x4E48;&#x591A;&#x8F9B;&#x9178;&#x53F2;&#x3002;&#x4EBA;&#x662F;&#x6709;&#x601D;&#x60F3;&#x7684;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x9636;&#x6BB5;&#x60F3;&#x6CD5;&#x90FD;&#x4F1A;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x73B0;&#x5728;&#x6700;&#x5927;&#x7684;&#x611F;&#x53D7;&#x5C31;&#x662F;&#x6709;&#x65F6;&#x5019;&#x5C31;&#x4F1A;&#x611F;&#x89C9;&#x65F6;&#x95F4;&#x4E0E;&#x7CBE;&#x529B;&#x4E0D;&#x591F;&#x7528;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x987E;&#x8651;&#xFF0C;&#x5728;&#x5916;&#x9762;&#x4E0A;&#x73ED;&#xFF0C;money&#x662F;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x5F52;&#x5C5E;&#x611F;&#xFF0C;&#x73B0;&#x9636;&#x6BB5;&#x662F;&#x8FD9;&#x6837;&#x5B50;&#x7684;&#x611F;&#x89C9;&#x3002;</p>
<p>&#x575A;&#x6301;&#x4E0E;&#x4FDD;&#x6301;&#x70ED;&#x60C5;&#x662F;&#x4E00;&#x4EF6;&#x5F88;&#x96BE;&#x7684;&#x4E8B;&#xFF0C;&#x8BF4;&#x5B9E;&#x8BDD;&#x6709;&#x65F6;&#x5019;&#x6211;&#x4E5F;&#x4F1A;&#x8D28;&#x7591;&#x73B0;&#x5728;&#x53BB;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x4E00;&#x4E9B;&#x6280;&#x672F;&#x6709;&#x6CA1;&#x6709;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5FC3;&#x6001;&#x6709;&#x65F6;&#x5019;&#x4F1A;&#x592A;&#x6D6E;&#x8E81;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8C08;&#x8FD9;&#x4E2A;&#x5462;&#xFF0C;&#x56E0;&#x4E3A;&#x4ECE;&#x53BB;&#x5E74;&#x5F00;&#x59CB;&#x6211;&#x542C;&#x5230;&#x6700;&#x591A;&#x7684;&#x5C31;&#x662F;&#x8FD9;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x4E0A;&#x4E2A;&#x6708;&#x9886;&#x5BFC;&#x95EE;&#x8FC7;&#x6211;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x672A;&#x6765;5&#x5E74;&#x6709;&#x4EC0;&#x4E48;&#x804C;&#x4E1A;&#x89C4;&#x5212;&#xFF1F; &#x5176;&#x5B9E;&#x6309;&#x7167;&#x6211;&#x7684;&#x60F3;&#x6CD5;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;money&#x591A;&#x4E00;&#x4E9B;&#x51CF;&#x8F7B;&#x4E9B;&#x7269;&#x8D28;&#x4E0A;&#x7684;&#x538B;&#x529B;&#xFF0C;&#x591A;&#x966A;&#x966A;&#x4EB2;&#x4EBA;&#xFF0C;&#x80FD;&#x6709;&#x65F6;&#x95F4;&#x505A;&#x81EA;&#x5DF1;&#x559C;&#x6B22;&#x7684;&#x4E8B;&#x5C31;&#x591F;&#x4E86;&#x3002;</p>
<p>&#x8BF4;&#x4E00;&#x8BF4;&#x5DE5;&#x4F5C;&#xFF0C;&#x7B2C;&#x4E00;&#x4EFD;&#x5DE5;&#x4F5C;&#x505A;.NET &#xFF0C;&#x540E;&#x9762;&#x8F6C;&#x4E86;JAVA &#xFF0C;JAVA&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#x5F00;&#x6E90;&#x6210;&#x719F;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x786E;&#x5B9E;&#x8981;&#x591A;&#x5F88;&#x591A;&#xFF0C;&#x5982;spring,orm,soa,android,&#x5927;&#x6570;&#x636E;&#x7B49;&#x7B49;, &#x4E0D;&#x4F1A;&#x50CF;MS&#x90A3;&#x4E48;&#x72ED;&#x5C0F;&#xFF0C;&#x4E0D;&#x8FC7;&#x73B0;&#x5728;MS&#x4E5F;&#x5728;&#x8FDB;&#x6B65;&#x3002;&#x73B0;&#x5728;&#x7684;&#x516C;&#x53F8;&#x5462;&#xFF0C;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x8FD8;&#x662F;.NET &#xFF0C;&#x5E73;&#x65F6;&#x7684;&#x5DE5;&#x4F5C;&#x5F3A;&#xFFFD;&#xFFFD;&#xFFFD;&#x8FD8;&#x597D;&#xFF0C;&#x53BB;&#x5E74;&#x5728;&#x516C;&#x53F8;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x7F51;&#x7AD9;&#xFF0C;&#x73B0;&#x5728;&#x57FA;&#x672C;&#x5C31;&#x662F;&#x65B0;&#x589E;&#x529F;&#x80FD;&#x4E0E;&#x7EF4;&#x62A4;&#xFF0C;&#x53E6;&#x5916;&#x5C31;&#x662F;APP&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x8FD8;&#x6709;&#x5C31;&#x662F;&#x5404;&#x79CD;&#x652F;&#x4ED8; &#x652F;&#x4ED8;&#x5B9D; &#x5FAE;&#x4FE1; &#x94F6;&#x8054; &#x652F;&#x4ED8;&#x7B49;&#x7B49;&#xFF0C;&#x540E;&#x9762;&#x611F;&#x89C9;&#x5F88;&#x7E41;&#x7410;&#xFF0C;&#x5C31;&#x57FA;&#x4E0E;WEBAPI&#x5C01;&#x88C5;&#x4E86;&#x4E00;&#x5957;&#x5168;&#x652F;&#x4ED8;&#x63A5;&#x53E3;&#x3002;&#x5E73;&#x65F6;&#x7684;&#x5DE5;&#x4F5C;&#x5F3A;&#x5EA6;&#x8FD8;&#x80FD;&#x63A5;&#x53D7;&#xFF0C;&#x5C31;&#x662F;&#x591A;&#x800C;&#x6742;&#x3002;&#x6280;&#x672F;&#x4E0A;&#x5E73;&#x65F6;&#x4E86;&#x89E3;&#x81EA;&#x5DF1;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x6298;&#x817E;linux&#xFF0C;&#x4E86;&#x89E3;&#x70B9;&#x65B0;&#x8BED;&#x8A00; nodejs, golang &#x7B49;&#x7B49;&#x3002;</p>
<h2 id="&#x5DE5;&#x4F5C;">&#x5DE5;&#x4F5C;</h2><p>&#x7B80;&#x5355;&#x5148;&#x8BF4;&#x8BF4;&#x9879;&#x76EE;&#x90FD;&#x7528;&#x4E86;&#x54EA;&#x4E9B;&#x6280;&#x672F;&#x5427;&#x3002;</p>
<p>&#x4E00;.ASP.NET MVC</p>
<p>&#x7F51;&#x7AD9;&#x4F7F;&#x7528;ASP.NET MVC &#x5F00;&#x53D1;&#x6548;&#x7387;&#x76F8;&#x5BF9;&#x8FD8;&#x662F;&#x86EE;&#x5FEB;&#x7684;&#xFF0C;&#x6BD4;&#x5982;&#x6709;&#x5982;&#x4E0B;&#x7684;&#x7279;&#x6027;</p>
<p>1.&#x4F7F;&#x7528;&#x6A21;&#x578B;&#x7684;&#x58F0;&#x660E;&#x5F0F;&#x9A8C;&#x8BC1; &#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x8868;&#x5355;&#x9A8C;&#x8BC1;</p>
<p>2.Razor&#x89C6;&#x56FE;&#x6216;&#x5355;&#x72EC;&#x4F7F;&#x7528;RazorEngine</p>
<p>3.&#x62E6;&#x622A;&#x5668; &#x6211;&#x4E60;&#x60EF;&#x8FD9;&#x6837;&#x79F0;&#x547C;,&#x56E0;&#x4E3A;&#x4E4B;&#x524D;springmvc&#x4E00;&#x822C;&#x8FD9;&#x6837;&#x79F0;&#x547C;&#xFF0C;&#x6BD4;&#x5982;&#x505A;&#x4E00;&#x4E2A;&#x81EA;&#x52A8;&#x767B;&#x5F55;&#x7684;&#x9A8C;&#x8BC1;[cookies]&#xFF0C;&#x5168;&#x5C40;&#x7684;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#x7B49;</p>
<p>4.&#x8DEF;&#x7531;&#x4E5F;&#x662F;&#x86EE;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x4E1C;&#x897F;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5BF9;&#x6709;&#x6D01;&#x7656;&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x6765;&#x8BF4;&#xFF0C;&#x6BD4;&#x5982;&#x4F60;&#x5C31;&#x662F;&#x559C;&#x6B22;&#x8981;&#x6BCF;&#x4E00;&#x4E2A;&#x8BBF;&#x95EE;&#x7684;URL&#x90FD;&#x8981;&#x7B80;&#x77ED;&#x5E76;&#x4E14;&#x6709;&#x610F;&#x4E49;&#xFF0C;&#x6216;SEO&#x5B9E;&#x73B0;&#x7C7B;&#x4F3C;/shanghai&#x7684;URL&#x7B49;&#x7B49;(&#x5F00;&#x59CB;mvc4&#x8BD5;&#x4E86;&#x7279;&#x6027;&#x8DEF;&#x7531;<a href="http://attributerouting.net/" target="_blank" rel="external">http://attributerouting.net/</a>)&#xFF0C;ASP.NET MVC 5.1 &#x540E;&#x5DF2;&#x7ECF;&#x652F;&#x6301;&#xFF0C;&#x8C03;&#x8BD5;&#x8DEF;&#x7531;&#x7684;&#x5DE5;&#x5177; Install-Package routedebugger &#x7B49;</p>
<p>5.&#x8FD4;&#x56DE;&#x533F;&#x540D;&#x7C7B;JSON&#xFF0C;&#x5C40;&#x90E8;&#x89C6;&#x56FE;&#xFF0C;&#x6269;&#x5C55;htmlhelper&#x7B49;&#x7B49;&#xFF0C;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x975E;&#x5E38;&#x65B9;&#x4FBF;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x6269;&#x5C55;&#x81EA;&#x5DF1;&#x7684;&#x65B9;&#x6CD5;</p>
<p>6.&#x7F13;&#x5B58; &#x4F7F;&#x7528;MvcDonutCaching &#xFF0C;&#x529F;&#x80FD;&#x8FD8;&#x6BD4;&#x539F;&#x751F;&#x7684;&#x591A;&#x4E00;&#x4E9B;&#xFF0C;&#x57FA;&#x672C;&#x4E00;&#x81F4;&#xFF0C;&#x53E6;&#x5916;&#x7F13;&#x5B58;&#x670D;&#x52A1;Redis&#x6216;Couchbase</p>
<p>7.js&#x4E0E;css&#x7684;&#x5408;&#x5E76;&#x538B;&#x7F29;,Bundle &#x786E;&#x5B9E;&#x8981;&#x65B9;&#x4FBF;&#x5F88;&#x591A;&#xFF0C;&#x65E0;&#x9700;&#x7BA1;&#x7406;js&#x7684;&#x5408;&#x5E76;&#x4E0E;&#x6837;&#x5F0F;&#x7248;&#x672C;&#x53F7;&#x95EE;&#x9898;</p>
<p>8.&#x65E5;&#x5FD7; &#x4F7F;&#x7528;&#x4E86;NLog&#x4E2A;&#x4EBA;&#x611F;&#x89C9;&#x8981;&#x7B14;log4j&#x597D;&#x5F88;&#x591A;&#xFF0C;&#x9519;&#x8BEF;&#x4E0E;&#x5F02;&#x5E38;&#x7EA7;&#x522B;&#x8BB0;&#x5F55;&#x6587;&#x672C;,window&#x4E8B;&#x4EF6;,db,email,&#x57FA;&#x672C;&#x6EE1;&#x8DB3;&#x9700;&#x6C42;,&#x53E6;&#x5916;Elman&#x4E5F;&#x662F;&#x86EE;&#x597D;&#x7528;</p>
<p>9.XSS &#x4F7F;&#x7528;&#x4E86;AntiXSS&#xFF0C;ValidateAntiForgeryToken &#x53E6;&#x5916;&#x5C31;&#x662F;&#x5199;&#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x591A;&#x6CE8;&#x610F;</p>
<p>10.&#x9875;&#x9762;&#x6027;&#x80FD;&#xFF0C;&#x4F7F;&#x7528; MiniProfiler &#x68C0;&#x67E5;&#x8C03;&#x8BD5;&#x9875;&#x9762;&#x6027;&#x80FD;&#xFF0C;&#x8C8C;&#x4F3C;&#x6709;&#x65F6;&#x5019;&#x4F1A;&#x4E0E; routedebugger &#x7684;&#xFFFD;&#xFFFD;&#xFFFD;&#x5F0F;&#x6DF7;&#x4E71;</p>
<p>&#x4E8C;. WEBAPI</p>
<p>APP&#x7684;&#x63A5;&#x53E3;&#x4E0E;&#x4E00;&#x4E9B;&#x5E38;&#x7528;&#x7684;&#x63A5;&#x53E3;&#x4E4B;&#x524D;&#x662F;&#x4F7F;&#x7528;WCF&#x7684;Rest&#xFF0C;&#x540E;&#x9762;&#x611F;&#x89C9;&#x6BD4;&#x8F83;&#x81C3;&#x80BF;&#xFF0C;&#x5C31;&#x6362;&#x6210;&#x4E86;WEBAPI&#xFF0C; &#x4E2A;&#x4EBA;&#x975E;&#x5E38;&#x559C;&#x6B22;&#x8FD9;&#x4E2A;&#xFF0C;&#x76F8;&#x6BD4;WCF&#x6BD4;&#x8F83;&#x8F7B;&#x91CF;&#xFF0C;&#x597D;&#x6269;&#x5C55;&#xFF0C;&#x76F8;&#x6BD4;ASP.NET MVC&#x6211;&#x6539;&#x8FDB;&#x4E86;&#x4E00;&#x70B9;&#x4E1C;&#x897F; <img src="http://taojinke.github.io/img/20150706/705aad4.png" alt="image"></p>
<p>1.&#x4F7F;&#x7528;Autofac&#x4F5C;&#x4E3A;IOC&#x5BB9;&#x5668;</p>
<p>2.&#x4F7F;&#x7528;&#x7279;&#x6027;&#x8DEF;&#x7531;&#x5B9A;&#x4E49;&#x63A5;&#x53E3;URL</p>
<p>3.&#x4F7F;&#x7528;markdown&#x4E66;&#x5199;&#x63A5;&#x53E3;&#x6587;&#x6863;</p>
<p>5.&#x5168;&#x5C40;&#x62E6;&#x622A;&#x5668;&#x5BF9;&#x53C2;&#x6570;&#x7EA6;&#x675F;&#x9A8C;&#x8BC1;</p>
<p>6.&#x81EA;&#x52A8;&#x751F;&#x6210;/help&#x53C2;&#x6570;&#x6587;&#x6863; Install-Package Microsoft.AspNet.WebApi.HelpPage</p>
<p>7.&#x652F;&#x6301;&#x8DE8;&#x8D8A;&#x8BBF;&#x95EE; Install-Package Microsoft.AspNet.WebApi.Cors</p>
<p>8.&#x8DEF;&#x7531;&#x8C03;&#x8BD5; WebApiRouteDebugger &#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x8DDF;&#x8E2A; Install-Package Microsoft.AspNet.WebApi.Tracing Update-Package Microsoft.AspNet.WebApi.WebHost</p>
<p>9.&#x53E6;&#x5916;&#x63A8;&#x8350;&#x4E2A;HTTP&#x7C7B;&#x5E93;Flurl.Http&#x4E2A;&#x4EBA;&#x611F;&#x89C9;&#x8981;&#x6BD4;.NET 4.5&#x81EA;&#x5E26;&#x7684;HttpClient&#x8981;&#x597D;&#x7528;&#xFF0C;&#x652F;&#x6301;Task&#x5F02;&#x6B65; ;&#x6269;&#x5C55;&#x65B9;&#x6CD5; Z.ExtensionMethods&#x7C7B;&#x5E93;&#xFF0C;&#x5305;&#x542B;&#x5927;&#x591A;&#x6570;&#x5E38;&#x7528;&#x7684;&#x6269;&#x5C55;&#x65B9;&#x6CD5;</p>
<p>&#x4F8B;:</p>
<pre><code><span class="comment"><span class="xmlDocTag">///</span> &amp;lt;summary&amp;gt;</span>
<span class="comment"><span class="xmlDocTag">///</span> &amp;#x6D4B;&amp;#x8BD5;&amp;#x4E1A;&amp;#x52A1;&amp;#x5F02;&amp;#x6B65;&amp;#x56DE;&amp;#x8C03;&amp;#x63A5;&amp;#x53E3;&amp;#x662F;&amp;#x5426;&amp;#x6B63;&amp;#x786E;</span>
 <span class="comment"><span class="xmlDocTag">///</span> &amp;lt;/summary&amp;gt;</span>
<span class="comment"><span class="xmlDocTag">///</span> &amp;lt;param name=&amp;quot;notifyUrl&amp;quot;&amp;gt;&amp;#x4E1A;&amp;#x52A1;&amp;#x670D;&amp;#x52A1;&amp;#x5730;&amp;#x5740;&amp;lt;/param&amp;gt;</span>
<span class="comment"><span class="xmlDocTag">///</span> &amp;lt;returns&amp;gt;&amp;lt;/returns&amp;gt;</span>
[HttpPost]
[Route(&amp;quot;notify&amp;quot;)]
<span class="keyword">public</span> <span class="keyword">async</span> Task&amp;lt;IHttpActionResult&amp;gt; PostJsonAsync(<span class="keyword">string</span> notifyUrl)
{
    <span class="keyword">if</span> (notifyUrl.IsNullOrEmpty() || !notifyUrl.Contains(&amp;quot;http&amp;quot;, StringComparison.OrdinalIgnoreCase)) <span class="keyword">return</span> Ok(<span class="keyword">new</span> { IsError = <span class="keyword">true</span>, Msg = &amp;quot;NotifyUrl IS EMPTY&amp;quot;, Data = <span class="keyword">string</span>.Empty });
    <span class="comment">//notifyUrl = notifyUrl.UrlDecode(System.Text.Encoding.UTF8);</span>
    <span class="keyword">var</span> payPal = <span class="keyword">new</span> PayPalData
    {
        UserID = &amp;quot;test&amp;quot;,
        Subject = &amp;quot;&amp;<span class="preprocessor">#x6D4B;&amp;#x8BD5;&amp;#x5F02;&amp;#x6B65;&amp;#x56DE;&amp;#x8C03;&amp;#x63A5;&amp;#x53E3;&amp;quot;,</span>
        OutTradeNO = &amp;quot;<span class="number">10086</span>&amp;quot;,
        CreateTime = DateTime.Now,
        GuidNO = Guid.NewGuid().ToString(),
        TotalFee = &amp;quot;<span class="number">0.01</span>&amp;quot;,
        Origin = &amp;quot;WEB&amp;quot;
    };
    <span class="keyword">try</span>
    {
        <span class="keyword">var</span> data = <span class="keyword">await</span> notifyUrl.PostJsonAsync(payPal).ReceiveJson&amp;lt;WebAPIResponse&amp;gt;();
        logger.Info(&amp;quot;PayPalController JsonAsync : &amp;quot; + payPal.SerializeJson(System.Text.Encoding.UTF8));
        <span class="keyword">if</span> (data.IsError)
        {
            <span class="keyword">return</span> Ok(<span class="keyword">new</span> { IsError = <span class="keyword">true</span>, Msg = data.Msg, Data = data.Data });
        }
        <span class="keyword">return</span> Ok(<span class="keyword">new</span> { IsError = <span class="keyword">false</span>, Msg = <span class="keyword">string</span>.Empty, Data = payPal.SerializeJson(System.Text.Encoding.UTF8) });
    }
    <span class="keyword">catch</span> (Exception ex)
    {
        <span class="keyword">return</span> Ok(<span class="keyword">new</span> { IsError = <span class="keyword">true</span>, Msg = &amp;quot;PostJsonAsync Exception : &amp;quot; + ex.Message, Data = payPal.SerializeJson(System.Text.Encoding.UTF8) });
    }
}
</code></pre><p>&#x5217;:Filter</p>
<pre><code><span class="xml">/// &amp;lt;summary&amp;gt;
/// http://www.asp.net/web-api/overview/formats-and-model-binding/model-validation-in-aspnet-web-api
/// http://www.asp.net/web-api/overview/error-handling/exception-handling
/// &amp;lt;/summary&amp;gt;
public class ModelValidFilter : ActionFilterAttribute
</span><span class="expression">{
    //<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">summary</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;
    //<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>6<span class="variable">A</span>21;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>9<span class="variable">A</span>8<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BC</span>1;
    //<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="end-block">/summary</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;
    //<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">param</span> <span class="variable">name</span>=&amp;<span class="variable">quot</span>;<span class="variable">actionContext</span>&amp;<span class="variable">quot</span>;&amp;<span class="variable"><span class="keyword">gt</span></span>;&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="end-block">/param</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;
    //<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">param</span> <span class="variable">name</span>=&amp;<span class="variable">quot</span>;<span class="variable">cancellationToken</span>&amp;<span class="variable">quot</span>;&amp;<span class="variable"><span class="keyword">gt</span></span>;&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="end-block">/param</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;
    //<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">returns</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="end-block">/returns</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;
    <span class="variable">public</span> <span class="variable">override</span> <span class="variable">Task</span> <span class="variable">OnActionExecutingAsync</span>(<span class="variable">HttpActionContext</span> <span class="variable">actionContext</span>, <span class="variable">System.Threading.CancellationToken</span> <span class="variable">cancellationToken</span>)
    {
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">actionContext.ActionArguments.Values.FirstOrDefault</span>()<span class="variable">.IsNull</span>())
        {
            <span class="variable">var</span> <span class="variable">data</span> = <span class="variable">new</span> { <span class="variable">IsError</span> = <span class="variable">true</span>, <span class="variable">Msg</span> = &amp;<span class="variable">quot</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>01;&amp;<span class="variable">quot</span>;, <span class="variable">Data</span> = <span class="variable">string.Empty</span> }</span><span class="xml">;
            actionContext.Response = actionContext.Request.CreateResponse(HttpStatusCode.OK, data);
            return base.OnActionExecutingAsync(actionContext, cancellationToken);
        }
        if (!actionContext.ModelState.IsValid)
        </span><span class="expression">{
            /<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>6<span class="variable">CE</span>8;&amp;<span class="begin-block">#x</span>610<span class="variable">F</span>; !!!!&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>; <span class="variable">http</span>:/<span class="end-block">/tmenier.github.io</span><span class="end-block">/Flurl</span><span class="end-block">/fluent-http</span><span class="end-block">/ HttpStatusCode.BadRequest </span>
            <span class="variable">var</span> <span class="variable">data</span> = <span class="variable">new</span> { <span class="variable">IsError</span> = <span class="variable">true</span>, <span class="variable">Msg</span> = <span class="variable">actionContext.ModelState.Values.FirstOrDefault</span>()<span class="variable">.Errors.FirstOrDefault</span>()<span class="variable">.ErrorMessage</span>, <span class="variable">Data</span> = <span class="variable">actionContext.ModelState.Keys.FirstOrDefault</span>() + &amp;<span class="variable">quot</span>; :&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>9<span class="variable">A</span>8<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BC</span>1;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>8<span class="variable">BEF</span>;&amp;<span class="begin-block">#xFF</span>01;&amp;<span class="begin-block">#xFF</span>01;&amp;<span class="begin-block">#xFF</span>01;&amp;<span class="variable">quot</span>; }</span><span class="xml">;
            actionContext.Response = actionContext.Request.CreateResponse(HttpStatusCode.OK, data);
            return base.OnActionExecutingAsync(actionContext, cancellationToken);
        }
        return base.OnActionExecutingAsync(actionContext, cancellationToken);
    }
}</span>
</code></pre><p>&#x53E6;&#x5916;&#x63A8;&#x8350;&#x4E00;&#x4E2A;&#x5F00;&#x6E90;&#x7684;Markdown&#x7F16;&#x8F91;&#x5668;&#xA0;<a href="https://pandao.github.io/editor.md/" target="_blank" rel="external">https://pandao.github.io/editor.md/</a>&#xFF0C;&#x53EF;&#x4EE5;&#x96C6;&#x6210;&#x5230;&#x9879;&#x76EE;&#x4E2D;&#xFF0C;&#x5199;&#x5199;&#x63A5;&#x53E3;&#x6587;&#x6863;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150706/705ad45.png" alt="image"></p>
<p>&#x4E09;.StackExchange Dapper</p>
<p>&#x63A8;&#x8350;StackExchange&#x7684;&#x4E24;&#x6B3E;&#x5F00;&#x6E90;&#x9879;&#x76EE; StackExchange.Redis (<a href="https://github.com/StackExchange/StackExchange.Redis" target="_blank" rel="external">https://github.com/StackExchange/StackExchange.Redis</a>) &#x4E0E; Dapper</p>
<p>&#x4F7F;&#x7528;Dapper,&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x5E93;&#x7684;&#x4EE3;&#x7801;&#x76F8;&#x6BD4;&#x66F4;&#x7B80;&#x6D01; &#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x652F;&#x6301;.NET 4.5 Task&#x5F02;&#x6B65; &#xFF0C;&#x793A;&#x4F8B;&#x5177;&#x4F53;git&#x4E0B;&#x6765;&#x770B;&#x4E0B;&#x5355;&#x5143;&#x6D4B;&#x8BD5;<a href="https://github.com/StackExchange/dapper-dot-net" target="_blank" rel="external">https://github.com/StackExchange/dapper-dot-net</a>&#xFF0C;&#x4E0D;&#x8FC7;&#x8981;&#x4E3B;&#x8981;Dapper&#x4E0B;&#x7684;&#x4E00;&#x4E2A;&#x4E0E;MSSQL&#x6267;&#x884C;&#x8BA1;&#x5212;&#x7684;&#x95EE;&#x9898;&#xA0;</p>
<p>Be careful with varchars in Dapper &#xFF1A;<a href="http://www.codeproject.com/Articles/594133/BepluscarefulpluswithplusvarcharsplusinplusDapper" target="_blank" rel="external">http://www.codeproject.com/Articles/594133/BepluscarefulpluswithplusvarcharsplusinplusDapper</a></p>
<p>&#x56DB;. Quartz</p>
<p>&#x4F7F;&#x7528;&#x4E86;Quartznet&#xFF0C;&#x5BC4;&#x5BBF;window&#x670D;&#x52A1;&#xFF0C;&#x8FD0;&#x884C;&#x4E00;&#x76F4;&#x5F88;&#x7A33;&#x5B9A;&#x3002;&#x5982;&#x679C;&#x60F3;&#x4E0D;&#x60F3;&#x4F7F;&#x7528;&#x670D;&#x52A1;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x8BD5;&#x8BD5; Install-Package Hangfire &#x53EF;&#x4EE5;&#x96C6;&#x6210;MVC&#x6216;OWIN&#x7B49;&#x3002;</p>
<h2 id="&#x6D3B;&#x52A8;">&#x6D3B;&#x52A8;</h2><h4 id="&#x676D;JS2014">&#x676D;JS2014</h4><p>&#x53BB;&#x5E74;&#x53C2;&#x52A0;&#x4E86;<a href="http://2014.jsconf.cn" target="_blank" rel="external">&#x676D;JS2014</a>,&#x57FA;&#x672C;&#x5C31;&#x662F;&#x5206;&#x4EAB;&#x4E00;&#x4E9B;&#x5173;&#x4E8E;nodejs&#x76F8;&#x5173;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#x963F;&#x91CC;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;JAVA&#x5E1D;&#x56FD;&#x8FD8;&#x662F;&#x524D;&#x7AEF;&#x6C5F;&#x6E56;&#x7684;&#x7F14;&#x9020;&#x8005;&#x3002;</p>
<p>&#x676D;JS - 2014 JavaScript&#x4E2D;&#x56FD;&#x5F00;&#x53D1;&#x8005;&#x5927;&#x4F1A;: 2014-6-21 ~ 22</p>
<p><a href="https://cnodejs.org/topic/53473dde502e5602740078bc" target="_blank" rel="external">https://cnodejs.org/topic/53473dde502e5602740078bc</a></p>
<p>2014 &#x676D;JS&#x5927;&#x4F1A; &#x4F1A;&#x8BAE;&#x76DB;&#x51B5;&#x4E0E;&#x6280;&#x672F;&#x70ED;&#x70B9;&#x73B0;&#x573A;&#x62A5;&#x9053;&#xFF08;&#x76F4;&#x64AD;&#xFF09;</p>
<p><a href="http://segmentfault.com/a/1190000000584556" target="_blank" rel="external">http://segmentfault.com/a/1190000000584556</a></p>
<p>&#x676D;JS 2014 &#x6F14;&#x8BB2;&#x89C6;&#x9891;&#x5408;&#x96C6;</p>
<p><a href="https://cnodejs.org/topic/53bbc408a3ccaece73467f11" target="_blank" rel="external">https://cnodejs.org/topic/53bbc408a3ccaece73467f11</a></p>
<h4 id="PyConChina_2014">PyConChina 2014</h4><p><a href="http://cn.pycon.org/2014/shanghai.html" target="_blank" rel="external">PyCon2014</a>&#x8FD9;&#x4E2A;&#x7968;&#x662F;gitcafe&#x9001;&#x7684;,&#x4E00;&#x4E9B;&#x4E3B;&#x9898; linux&#x7684;&#x7EBF;&#x7A0B; &#x534F;&#x7A0B; &#x56DE;&#x8C03;&#x4E0E;&#x4E0A;&#x4E0B;&#x6587;&#x5207;&#x6362;; py&#x4E0E;&#x673A;&#x5668;&#x5B66;&#x4E60;&#x5F88;&#x5389;&#x5BB3;&#x7684;&#x6837;&#x5B50;;golang &#x7684;nsq&#x6D88;&#x606F;&#x5217;&#x961F;</p>
<h4 id="shanghai-osc-meeting-2014">shanghai-osc-meeting-2014</h4><p><a href="http://www.oschina.net/question/12_158672" target="_blank" rel="external">shanghai-osc-meeting</a>&#xA0;&#xA0; the docker way;go&#x7684;&#x6301;&#x7EED;&#x96C6;&#x6210;</p>
<p>OSC&#x4E0A;&#x6D77;&#x6E90;&#x521B;&#x4F1A;</p>
<p><a href="http://115.29.174.111/shanghai-osc-meeting/" target="_blank" rel="external">http://115.29.174.111/shanghai-osc-meeting/</a></p>
<h4 id="&#x642D;&#x5EFA;&#x670D;&#x52A1;">&#x642D;&#x5EFA;&#x670D;&#x52A1;</h4><p>&#x540E;&#x9762;&#x6211;&#x8FD8;&#x642D;&#x5EFA;&#x4E86;&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;nodejs&#x535A;&#x5BA2;&#xFF1A;<a href="http://115.29.174.111/" target="_blank" rel="external">http://115.29.174.111/</a>&#x4E0E;&#x57FA;&#x4E8E;golang&#x7684;git&#x670D;&#x52A1;:<a href="http://115.29.174.111:3000/" target="_blank" rel="external">http://115.29.174.111:3000/</a></p>
<h2 id="&#x73B0;&#x5728;">&#x73B0;&#x5728;</h2><p>&#x7801;&#x4E86;&#x8FD9;&#x4E48;&#x591A;&#x5B57;&#xFF0C;&#x90FD;&#x662F;&#x4E00;&#x4E9B;&#x96F6;&#x788E;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x611F;&#x89C9;&#x4E5F;&#x6CA1;&#x5565;&#x4E3B;&#x9898;&#xFF0C;&#x5C31;&#x662F;&#x8BB0;&#x5F55;&#x4E00;&#x4E9B;&#x7ECF;&#x5386;&#x8FC7;&#x7A0B;&#xFF0C;&#x5E74;&#x521D;&#x7684;&#x65F6;&#x5019;&#x5F04;&#x4E86;&#x53F0;Mac Pro ; &#x73B0;&#x5728;&#x5728;&#x6363;&#x9F13;&#x5565;&#x5462;</p>
<p>angularjs nodejs</p>
<p>objective-c golang</p>
<p>&#x4E71;&#x4E71;&#x7684;&#xFF0C;&#x5C31;&#x8FD9;&#x6837;&#x5B50;&#x5427;&#xFF0C;&#x5173;&#x673A;&#x7761;&#x89C9;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/ASP-NET-MVC/">ASP.NET MVC</a><a href="/tags/Java/">Java</a><a href="/tags/Node-js/">Node.js</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/06/70588a6/" title="Meteor再获2000万美元融资将从框架发展为平台 -" itemprop="url">Meteor再获2000万美元融资将从框架发展为平台 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-06T01:25:15.000Z" itemprop="datePublished"> 发表于 2015-07-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x77E5;&#x540D;JavaScript Web&#x6846;&#x67B6; <a href="https://github.com/meteor/meteor" target="_blank" rel="external">Meteor</a> &#xFF08;&#x6D41;&#x661F;&#x7684;&#x610F;&#x601D;&#xFF09;&#x80CC;&#x540E;&#x7684;&#x516C;&#x53F8;Meteor Development Group&#xFF08;&#x7B80;&#x79F0; <a href="https://www.meteor.com/" target="_blank" rel="external">MDG</a> &#xFF0C; <a href="https://www.crunchbase.com/organization/meteor" target="_blank" rel="external">CrunchBase</a> &#xFF09;B&#x8F6E;&#x53C8;&#x83B7;&#x5F97;&#x7ECF;&#x7EAC;&#xFF08;Matrix&#xFF09;&#x3001;A16Z&#x7B49;&#x9876;&#x7EA7;&#x98CE;&#x6295;&#x7684;2000&#x4E07;&#x7F8E;&#x5143;&#x6295;&#x8D44;&#x3002; </p>
<p>Meteor <a href="http://www.csdn.net/article/2012-07-26/2807736" target="_blank" rel="external">&#x4E0A;&#x4E00;&#x8F6E;&#x6295;&#x8D44;</a> &#x662F;2012&#x5E74;7&#x6708;&#x7684;A&#x8F6E;&#xFF0C;1120&#x4E07;&#x7F8E;&#x5143;&#x3002; </p>
<p>&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x6D41;&#x884C;&#x7684;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#xFF0C;Meteor&#x5728;GitHub&#x4E0A;&#x7684;&#x5173;&#x6CE8;&#x6570;&#x5DF2;&#x7ECF;&#x8D85;&#x8FC7;25000&#xFF0C;&#x5728;&#x6240;&#x6709;&#x9879;&#x76EE;&#x4E2D; <a href="https://github.com/search?p=1&amp;q=stars%3A%3E10000&amp;ref=searchresults&amp;type=Repositories&amp;utf8=%E2%9C%93" target="_blank" rel="external">&#x6392;&#x540D;&#x7B2C;&#x5341;</a> &#xFF0C;&#x524D;&#x4E5D;&#x4F4D;&#x4E2D;&#x7B2C;2&#x548C;&#x7B2C;7&#x662F;&#x56FE;&#x4E66;&#x548C;&#x5B57;&#x4F53;&#x3001;CSS&#x8D44;&#x6E90;&#xFF0C;&#x5176;&#x4ED6;7&#x4E2A;&#x9879;&#x76EE;&#x5206;&#x522B;&#x662F;Bootstrap&#x3001;Angular&#x3001;D3&#x3001;Nodejs&#x3001;jQuery&#x3001;HTML5 Boilerplate&#x548C;Rails&#x3002; </p>
<p>&#x516C;&#x53F8;CEO Geoff Schmidt&#x5BF9;TechCrunch <a href="http://techcrunch.com/2015/05/19/meteor-raises-20m-to-build-the-one-javascript-stack-to-rule-them-all/" target="_blank" rel="external">&#x8868;&#x793A;</a> &#xFF0C;&#x4E0B;&#x4E00;&#x6B65;&#x7684;&#x91CD;&#x70B9;&#x662F; <a href="http://info.meteor.com/blog/meteor-and-a-galaxy-of-containers-with-kubernetes" target="_blank" rel="external">Galaxy</a> &#xFF0C;&#x57FA;&#x4E8E;Google Kubernetes&#x5BB9;&#x5668;&#x6280;&#x672F;&#x7684;Meteor&#x5E94;&#x7528;&#x8FD0;&#x884C;&#x5E73;&#x53F0;&#x3002;&#x542C;&#x4E0A;&#x53BB;&#x50CF;&#x662F;&#x4E00;&#x4E2A;PaaS&#x670D;&#x52A1;&#x3002;&#x76EE;&#x524D;Galaxy&#x662F;&#x8FD0;&#x884C;&#x5728;AWS&#x4E0A;&#x7684;&#xFF0C;Azure&#x548C;GCE&#xFFFD;&#xFFFD;&#xFFFD;&#x5F00;&#x53D1;&#x4E2D;&#x3002; </p>
<p>Galaxy&#x53EA;&#x662F;&#x5927;&#x68CB;&#x5C40;&#x7684;&#x4E00;&#x6B65;&#xFF0C;&#x5E94;&#x7528;&#x6027;&#x80FD;&#x5206;&#x6790;&#x548C;&#x6D4B;&#x8BD5;&#x7B49;&#x4E5F;&#x5728;&#x89C4;&#x5212;&#x4E2D;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;Meteor&#x4E5F;&#x5728;&#x589E;&#x52A0;&#x5BF9;&#x5176;&#x4ED6;JavaScript UI&#x5E93;&#x6BD4;&#x5982;Angular&#x548C;React&#x7684;&#x652F;&#x6301;&#x3002;</p>
<p>Schmidt&#x5728; <a href="http://info.meteor.com/blog/announcing-our-20m-series-b-funding" target="_blank" rel="external">&#x5B98;&#x65B9;&#x535A;&#x5BA2;</a> &#x900F;&#x9732;&#xFF0C;&#x516C;&#x53F8;&#x8463;&#x4E8B;&#x4F1A;&#x6210;&#x5458;&#x91CC;&#x9664;&#x4E86;Rod Johnson&#xFF08;Spring&#x4E4B;&#x7236;&#xFF09;&#x5916;&#xFF0C;&#x7ECF;&#x7EAC;&#x7684;David Skok&#x3001;Trinity Ventures&#xFF08;&#x6B64;&#x516C;&#x53F8;&#x6295;&#x8D44;&#x4E86;Docker&#x548C;New Relic&#xFF09;&#x7684;Dan Scholnick&#x4E5F;&#x5C06;&#x52A0;&#x5165;&#x3002; </p>
<p>&#x5173;&#x4E8E;Meteor&#x672C;&#x8EAB;&#xFF0C;&#x4ED6;&#x8FD9;&#x6837;&#x5199;&#x9053;&#xFF1A;</p>
<p>&#x5F00;&#x53D1;Meteor&#x7684;&#x613F;&#x666F;&#x662F;&#x4F7F;&#x5B83;&#x6210;&#x4E3A;&#x5F00;&#x53D1;&#x51E0;&#x4E4E;&#x4EFB;&#x4F55;&#x5E94;&#x7528;&#x7684;&#x6700;&#x4F73;&#x5E73;&#x53F0;&#x3002;&#x2026;&#x2026;Meteor&#x5F00;&#x53D1;JavaScript&#x5E94;&#x7528;&#x7684;&#x5B8C;&#x6574;&#x5E73;&#x53F0;&#xFF0C;&#x5C31;&#x50CF;JavaScript&#x7F3A;&#x5931;&#x7684;SDK&#xFF0C;&#x63D0;&#x4F9B;&#x4F60;&#x5F00;&#x53D1;&#x79FB;&#x52A8;&#x548C;Web&#x7EDD;&#x4F73;&#x7684;&#x73B0;&#x4EE3;&#x4F53;&#x9A8C;&#x6240;&#x9700;&#x7684;&#x4E00;&#x5207;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Meteor/">Meteor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/06/7066460/" title="【nodejs】测量时间和内存函数 -" itemprop="url">【nodejs】测量时间和内存函数 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-06T01:25:15.000Z" itemprop="datePublished"> 发表于 2015-07-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x7528;&#x6765;&#x4ECB;&#x7ECD;&#x5728;nodejs&#x4E2D;&#xFF0C;&#x7528;&#x6765;&#x6D4B;&#x91CF;&#x65F6;&#x95F4;&#x548C;&#x5185;&#x5B58;&#x7684;&#x51FD;&#x6570;</p>
<h2 id="process-memoryUsage">process.memoryUsage</h2><p>&#x8FD4;&#x56DE;&#x63CF;&#x8FF0;&#x4EE5;&#x5B57;&#x8282;&#x4E3A;&#x5355;&#x4F4D;&#x7684;&#x8282;&#x70B9;&#x8FDB;&#x7A0B;&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x91CF;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x76F8;&#x5E94;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x4F8B;&#x5B50;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>var util = require<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;util&amp;apos;);</span>
console.log<span class="list">(<span class="keyword">util</span>.inspect<span class="list">(<span class="keyword">process</span>.memoryUsage<span class="list">()</span>)</span>)</span><span class="comment">;</span></span>
</code></pre><p>&#x76F8;&#x5E94;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>{ 
  <span class="attribute">rss</span>: <span class="number">4935680</span>,
  <span class="attribute">heapTotal</span>: <span class="number">1826816</span>,
  <span class="attribute">heapUsed</span>: <span class="number">650472</span> 
}
</code></pre><p>heapTotal&#x548C;heapUsed&#x53C2;&#x8003;V8&#x7684;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x3002;rss&#x4E3A;&#x9A7B;&#x7559;&#x96C6;&#x5927;&#x5C0F;&#xFF0C;&#x76F8;&#x5E94;&#x8BF4;&#x660E;&#x53EF;&#x4EE5;&#x53C2;&#x8003; <a href="http://baike.baidu.com/view/3319068.htm" target="_blank" rel="external">&#x9A7B;&#x7559;&#x96C6;</a></p>
<p>&#x76F8;&#x5E94;api&#x94FE;&#x63A5;&#x4E3A; <a href="http://nodejs.org/docs/v0.4.10/api/process.html#process.memoryUsage" target="_blank" rel="external">http://nodejs.org/docs/v0.4.10/api/process.html#process.memoryUsage</a></p>
<h2 id="process-hrtime">process.hrtime</h2><p>&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x9AD8;&#x5206;&#x8FA8;&#x7387;&#x5B9E;&#x65F6;&#x5728;[&#x79D2;&#xFF0C;&#x7EB3;&#x79D2;]&#x5143;&#x7EC4;&#x3002;&#x5B83;&#x662F;&#x76F8;&#x5BF9;&#x4E8E;&#x8FC7;&#x53BB;&#x4EFB;&#x610F;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x5B83;&#x548C;&#x4E00;&#x5929;&#x4E2D;&#x7684;&#x65F6;&#x95F4;&#x4E0D;&#x76F8;&#x5173;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x4E0D;&#x4F1A;&#x53D7;&#x5230; <a href="http://zh.wikipedia.org/wiki/%E6%97%B6%E9%92%9F%E5%81%8F%E7%A7%BB" target="_blank" rel="external">&#x65F6;&#x949F;&#x504F;&#x79FB;</a> &#x5F71;&#x54CD;&#x3002;&#x4E3B;&#x8981;&#x7528;&#x9014;&#x662F;&#x7528;&#x4E8E;&#x6D4B;&#x91CF;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#x4E4B;&#x95F4;&#x7684;&#x6027;&#x80FD;&#x3002; </p>
<p>&#x76F8;&#x5E94;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x4F8B;&#x5B50;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code><span class="keyword">var</span> time = process.hrtime();
<span class="comment">// [ 1800216, 25 ]</span>

setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
  <span class="keyword">var</span> diff = process.hrtime(time);
  <span class="comment">// [ 1, 552 ]</span>

  <span class="built_in">console</span>.log(&amp;apos;benchmark took %d nanoseconds&amp;apos;, diff[<span class="number">0</span>] * <span class="number">1e9</span> + diff[<span class="number">1</span>]);
  <span class="comment">// benchmark took 1000000527 nanoseconds</span>
}, <span class="number">1000</span>);
</code></pre><p>&#x76F8;&#x5E94;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code><span class="keyword">benchmark </span>took <span class="number">1000000527</span> nanoseconds
</code></pre><p>&#x76F8;&#x5E94;api&#x94FE;&#x63A5;&#x4E3A; <a href="https://nodejs.org/api/process.html#process_process_hrtime" target="_blank" rel="external">https://nodejs.org/api/process.html#process <em>process</em> hrtime</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node-js/">Node.js</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2f2ef4e/" title="A Gulp.js tutorial -" itemprop="url">A Gulp.js tutorial -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:57.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>Gulp is a build tool that helps you automate your development workflow. In this article, we will dive deep into Gulp to show you how to use it effectively to create a simple workflow.</p>
<p>Let&#x2019;s get started.</p>
<h2 id="Installing_Gulp">Installing Gulp</h2><p>We&#x2019;ll start off the process by installing Gulp onto your computer. Gulp requires you to have Node.js and Node Package Manager (NPM) installed on your system, so if you haven&#x2019;t gotten them yet, just head over to <a href="https://nodejs.org" target="_blank" rel="external">Node.js&#x2019;s website</a> and download the installer. </p>
<p>Once you&#x2019;re done installing Node.js and NPM, you can install Gulp by typing the following command in the command line:</p>
<pre><code>$ sudo npm <span class="keyword">install</span> gulp -g
<span class="comment"># <span class="doctag"><span class="keyword">Note</span></span>: Only Mac users require the `sudo` keyword</span>
</code></pre><p>This command installs gulp globally and allows you to use the gulp command anywhere on your computer. </p>
<p>We&#x2019;re now done with installing Gulp and we can move on to create a new project that uses Gulp.</p>
<h2 id="Creating_a_Gulp_Project">Creating a Gulp Project</h2><p>Let&#x2019;s create a folder named project as we work through this article. Once you have created the folder, you&#x2019;ll want to run npm init in it. </p>
<pre><code>$ <span class="built_in">npm</span> init
</code></pre><p>This npm init command asks you a few questions and creates a package.json file to store information about dependencies that you&#x2019;ll use in this project. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2a39f.png" alt=""></p>
<p>The first dependency in our project is Gulp since we&#x2019;re using it as our build tool. You&#x2019;ll have to install gulp within the project folder by augmenting the install code slightly: </p>
<pre><code>$ npm install gulp --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>See that we have removed sudo from the command and replaced the -g flag with the —save-dev flag? </p>
<p>This —save-dev flag tells NPM to install gulp locally in (a dev term for within) the project, and save this dependency information in the package.json file. </p>
<p>Since we&#x2019;re installing a package locally, we don&#x2019;t have a need for administrator rights and hence the sudo was dropped. Removing this sudo is important and could potentially cause errors if you don&#x2019;t. </p>
<p>Now, if you take a look at your package.json file, you should see that Gulp has been added as a dev dependency. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2a39f.png" alt=""></p>
<p>You should also see a gulp folder within the new node_modules folder that was created when you ran the npm install gulp —save-dev command. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2a610.png" alt=""></p>
<p>Next, we&#x2019;ll have to create a gulpfile.js file to store all our Gulp configurations. </p>
<p>There&#x2019;s one more thing to do before we start configuring Gulp to create a workflow. We have to make sure we&#x2019;re clear on how the project is structured.</p>
<h2 id="Determining_Project_Structure">Determining Project Structure</h2><p>Let&#x2019;s start off with a generic structure for a webapp:</p>
<pre><code>project/
  <span class="string">|- app/</span>
      <span class="string">|- css/</span>
      <span class="string">|- fonts/</span>
      <span class="string">|- images/ </span>
      <span class="string">|- index.html</span>
      <span class="string">|- js/ </span>
      <span class="string">|- scss/</span>
  <span class="string">|- dist/</span>
  <span class="string">|- gulpfile.js</span>
  <span class="string">|- node_modules/</span>
  <span class="string">|- package.json</span>
</code></pre><p>In this structure, the app folder will store all our written code, and the dist folder will be used to store code that&#x2019;s production-ready. </p>
<p>Don&#x2019;t worry if your actual projects has a structure that&#x2019;s different from the current one we&#x2019;re using right now. Once you&#x2019;ve gotten the hang of Gulp, you&#x2019;ll see how to tweak the gulpfile to work with your structure easily. So let&#x2019;s work with this structure for now.</p>
<p>Once you&#x2019;ve created the project structure with the corresponding folders, we can proceed on to writing your first Gulp task.</p>
<h2 id="Writing_Your_First_Task">Writing Your First Task</h2><p>To configure Gulp, you&#x2019;ll first have to require gulp within your gulpfile.js : </p>
<pre><code><span class="comment">// Requiring Gulp</span>
<span class="keyword">var</span> gulp = <span class="built_in">require</span>(&amp;apos;gulp&amp;apos;); 
</code></pre><p>This require statement tells Node.js to look under the node_modules folder, find a package named gulp and pass it to the gulp variable. </p>
<p>Once we have this gulp variable, we can use it to write different Gulp tasks. Here&#x2019;s the basic syntax of a gulp task. </p>
<pre><code><span class="comment">// Basic Gulp task syntax</span>
gulp.task(&amp;apos;task-name&amp;apos;, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{
  <span class="comment">// Stuff here</span>
})
</code></pre><p>Let&#x2019;s write a task named &#x2018;hello&#x2019; for a start, and let the task do a log that says &#x201C;Hello Zell!&#x201D;.</p>
<pre><code><span class="comment">// Basic Gulp task syntax</span>
gulp.task(&amp;apos;hello&amp;apos;, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
  <span class="built_in">console</span>.log(&amp;apos;Hello Zell!&amp;apos;);
})
</code></pre><p>The task name is important since you&#x2019;ll be able to use the task anywhere else in the Gulpfile to run the task.</p>
<p>You can also use run a task with the command line by using gulp plus the name of the task. </p>
<pre><code><span class="variable">$ </span>gulp hello
</code></pre><p>You should see a log from the terminal saying &#x201C;Hello Zell!&#x201D; once you ran the code in the terminal.</p>
<p><img src="http://taojinke.github.io/img/20150703/2f2a610.png" alt=""></p>
<p>In reality, gulp tasks are slightly more complex that what we have written so far. You&#x2019;ll have to use two other gulp methods, gulp.src and gulp.dest . </p>
<h2 id="Creating_a_Real_Task">Creating a Real Task</h2><p>Here&#x2019;s what a real task may look like:</p>
<pre><code>gulp.task<span class="comment">(&amp;apos;task-name&amp;apos;, function ()</span> {
  gulp.src<span class="comment">(&amp;apos;src&amp;apos;)</span> <span class="comment">// Get source files with gulp.src</span>
    .pipe<span class="comment">(somePlugin()</span>) <span class="comment">// Sends it through a gulp plugin</span>
    .pipe<span class="comment">(gulp.dest(&amp;apos;dest&amp;apos;)</span>) <span class="comment">// Outputs the file in the destination folder</span>
})
</code></pre><p>Let&#x2019;s put this template to use with a real example where we compile Sass to CSS. I&#x2019;ll explain how to set up the task while we&#x2019;re at it.</p>
<p>First, we&#x2019;ll need to install a gulp plugin, gulp-sass , to compile Sass to CSS. We can install it with the npm install command with the —save-dev flag like what we did above. </p>
<pre><code>$ npm install gulp-sass --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>We will then need to require this plugin in the gulpfile.</p>
<pre><code><span class="keyword">var</span> gulp = <span class="built_in">require</span>(&amp;apos;gulp&amp;apos;);
<span class="comment">// Requires the gulp-sass plugin</span>
<span class="keyword">var</span> sass = <span class="built_in">require</span>(&amp;apos;gulp-sass&amp;apos;);
</code></pre><p>Now, create a styles.scss file within the app/scss folder and give it some styles to convert from Sass to CSS. </p>
<pre><code><span class="comment">// Scss</span>
<span class="class">.testing</span> {
  <span class="attribute">display</span>: flex;
  <span class="attribute">width</span>: <span class="function">percentage</span>(<span class="number">5</span>/<span class="number">7</span>); 
  <span class="comment">// Percentage is a Sass function that will be evaluated to CSS when compiled</span>
}
</code></pre><p>This styles.scss file will be converted into CSS by passing through the gulp-sass plugin we installed. After passing through the plugin, it&#x2019;ll be created as styles.css in the app/css folder. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2a881.png" alt=""></p>
<p>Here&#x2019;s how the task would look like:</p>
<pre><code>gulp.task<span class="comment">(&amp;apos;sass&amp;apos;, function()</span> {
  gulp.src<span class="comment">(&amp;apos;app/scss/styles.scss&amp;apos;)</span> <span class="comment">// Gets the styles.scss file</span>
    .pipe<span class="comment">(sass()</span>) <span class="comment">// Passes it through a gulp-sass task</span>
    .pipe<span class="comment">(gulp.dest(&amp;apos;app/css&amp;apos;)</span>) <span class="comment">// Outputs it in the css folder</span>
});
</code></pre><p>We can test this sass task by running it in the command line. </p>
<pre><code><span class="variable">$ </span>gulp sass
</code></pre><p>Now, if you take a look at the styles.css file in app/css , you&#x2019;ll see that the percentage() function has been evaluated into the following code: </p>
<pre><code><span class="class">.testing</span> <span class="rules">{
  <span class="rule"><span class="attribute">display</span>:<span class="value"> flex</span></span>;
  <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">71.42857%</span></span></span>; }</span>
</code></pre><p>This means our styles.scss file has successfully been compiled into CSS. </p>
<h2 id="Adding_more_functionality_to_the_sass_task">Adding more functionality to the sass task</h2><p>Just compiling from Sass to CSS isn&#x2019;t good enough. Sometimes it makes more sense to add more plugins to make thing simpler for us. One of the best plugins that you&#x2019;ll ever use when converting from Sass to CSS is <a href="https://github.com/postcss/autoprefixer" target="_blank" rel="external">autoprefixer</a> ,which helps you write vendor prefixes according to <a href="http://www.caniuse.com" target="_blank" rel="external">caniuse</a> . </p>
<p>Let&#x2019;s try adding autoprefixer to our sass task. </p>
<p>To do so, we&#x2019;ll have to install the gulp plugin for autoprefixer.</p>
<pre><code>$ npm install gulp-autoprefixer --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>Then we&#x2019;ll have to require autoprefixer . </p>
<pre><code><span class="keyword">var</span> gulp = <span class="built_in">require</span>(&amp;apos;gulp&amp;apos;);
<span class="keyword">var</span> sass = <span class="built_in">require</span>(&amp;apos;gulp-sass&amp;apos;);
<span class="comment">// Requiring autoprefixer</span>
<span class="keyword">var</span> autoprefixer = <span class="built_in">require</span>(&amp;apos;gulp-autoprefixer&amp;apos;);
</code></pre><p>Autoprefixer is usually placed after Sass is compiled into CSS. In Gulp, we&#x2019;ll want to add another .pipe() so the resultant CSS gets passed through autoprefixer before it&#x2019;s created as styles.css in app/css . </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2a881.png" alt=""></p>
<p>The modified code is hence:</p>
<pre><code>gulp.task<span class="params">(&amp;apos;sass&amp;apos;, function<span class="params">()</span> {
  gulp.src<span class="params">(&amp;apos;app/scss/styles.scss&amp;apos;)</span> 
    .pipe<span class="params">(sass<span class="params">()</span>)</span> 
    .pipe<span class="params">(autoprefixer<span class="params">()</span>)</span> // Passes it through gulp-autoprefixer 
    .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;app/css&amp;apos;)</span>)</span>
})</span>
</code></pre><p>Now if you run gulp sass again, you&#x2019;ll notice that the output in the styles.css file has changed to include vendor prefixes for the display flex property: </p>
<pre><code><span class="class">.testing</span> <span class="rules">{
  <span class="rule"><span class="attribute">display</span>:<span class="value"> -webkit-box</span></span>;
  <span class="rule"><span class="attribute">display</span>:<span class="value"> -webkit-flex</span></span>;
  <span class="rule"><span class="attribute">display</span>:<span class="value"> -ms-flexbox</span></span>;
  <span class="rule"><span class="attribute">display</span>:<span class="value"> flex</span></span>;
  <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">71.42857%</span></span></span>; }</span>
</code></pre><p>Another task that&#x2019;ll help you out during development is to add sourcemaps.</p>
<p>A sourcemap is a string of information that tells the browser where different sections of the code is stored. With a CSS sourcemap, you can easily locate the original source code of specific lines of CSS just by checking out the inspector.</p>
<p><img src="http://taojinke.github.io/img/20150703/2f2aaf2.png" alt=""></p>
<p>To add sourcemaps to the sass task, we&#x2019;ll have to install the gulp-sourcemaps plugin. </p>
<pre><code>$ npm install gulp-sourcemaps --<span class="built_in">save</span>-<span class="built_in">dev</span>


<span class="comment">// Requiring Sourcemaps</span>
<span class="built_in">var</span> sourcemaps = require(&amp;apos;gulp-sourcemaps&amp;apos;);
</code></pre><p>The process to adding sourcemaps to our sass task is slightly different from adding autoprefixer. We&#x2019;ll have to add two pipes instead of one. </p>
<p>First, we&#x2019;ll need to initialize the sourcemap plugin right after getting source files from gulp.</p>
<p>Then, we&#x2019;ll have to let the files pass through gulp-sass and gulp-autoprefixer before writing the sourcemaps at the end of the css file. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2aaf2.png" alt=""></p>
<pre><code>gulp.task<span class="params">(&amp;apos;sass&amp;apos;, function<span class="params">()</span> {
  gulp.src<span class="params">(&amp;apos;app/scss/styles.scss&amp;apos;)</span> // Gets the styles.scss file
    .pipe<span class="params">(sourcemaps.init<span class="params">()</span>)</span> // Initialize sourcemap plugin
    .pipe<span class="params">(sass<span class="params">()</span>)</span>
    .pipe<span class="params">(autoprefixer<span class="params">()</span>)</span> 
    .pipe<span class="params">(sourcemaps.write<span class="params">()</span>)</span> // Writing sourcemaps 
    .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;app/css&amp;apos;)</span>)</span>
})</span>
</code></pre><p>Now if you run gulp sass on the terminal, you should be able to see that Gulp has written a sourcemap at the end of your CSS file. </p>
<pre><code><span class="class">.testing</span> <span class="rules">{
  <span class="rule"><span class="attribute">display</span>:<span class="value"> -webkit-box</span></span>;
  <span class="rule"><span class="attribute">display</span>:<span class="value"> -webkit-flex</span></span>;
  <span class="rule"><span class="attribute">display</span>:<span class="value"> -ms-flexbox</span></span>;
  <span class="rule"><span class="attribute">display</span>:<span class="value"> flex</span></span>;
  <span class="rule"><span class="attribute">width</span>:<span class="value"> <span class="number">71.42857%</span></span></span>; }</span>

<span class="comment">/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0eWxlcy5zY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0VBQ0UscUJBQWM7RUFBZCxzQkFBYztFQUFkLHFCQUFjO0VBQWQsY0FBYztFQUNkLGlCQUFpQixFQUZUIiwiZmlsZSI6InN0eWxlcy5jc3MiLCJzb3VyY2VzQ29udGVudCI6WyIudGVzdGluZyB7XG4gIGRpc3BsYXk6IGZsZXg7XG4gIHdpZHRoOiBwZXJjZW50YWdlKDUvNyk7XG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9 */</span>
</code></pre><h2 id="Automatically_update_the_CSS_file_when_you_save">Automatically update the CSS file when you save</h2><p>Now it&#x2019;s quite some work to run the gulp sass task whenever we want to compile Sass to CSS. Wouldn&#x2019;t it be awesome if Gulp would run it automatically? </p>
<p>Gulp can do that! You&#x2019;ll just have to let Gulp check whether the styles.scss file was changed when you save it. This checking process is called watching in programming terms. </p>
<p>Gulp does this watching by providing us with a watch method that allows you to run any task whenever a file is changed. </p>
<pre><code>// Gulp watch <span class="keyword">syntax</span>
gulp.watch(&amp;apos;<span class="keyword">files</span>-<span class="keyword">to</span>-watch&amp;apos;, [&amp;apos;tasks&amp;apos;, &amp;apos;<span class="keyword">to</span>&amp;apos;, &amp;apos;run&amp;apos;]); 
</code></pre><p>Instead of just watching the Sass files alone, you&#x2019;ll often want to watch many types of files and run different tasks during a development process. In order to achieve that, we can create a watch gulp task that watches different files. </p>
<pre><code>gulp.task(&amp;apos;watch&amp;apos;, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{
  gulp.watch(&amp;apos;app/scss/styles.scss&amp;apos;, [&amp;apos;sass&amp;apos;]);
  <span class="comment">// ... Other watchers</span>
});
</code></pre><p>Now if you run the watch command you&#x2019;ll see that gulp immediately starts watching your files for changes.</p>
<p><img src="http://taojinke.github.io/img/20150703/2f2ad63.png" alt=""></p>
<p>And if you change a line in styles.scss , Gulp will automatically run the sass task. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2ad63.gif" alt=""></p>
<p>There&#x2019;s only one thing that&#x2019;s lacking here. Gulp didn&#x2019;t run the sass task first before running watch , which means the CSS might not be the most updated one. Hence, we&#x2019;ll want to make sure the watch task runs after the sass task. </p>
<p>We can do so by adding a second parameter to the watch task. This second parameter is an array of tasks that must be completed before Gulp runs watch . </p>
<pre><code>gulp.task(&amp;apos;watch&amp;apos;, [&amp;apos;sass&amp;apos;], <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{
  gulp.watch(&amp;apos;app/scss/styles.scss&amp;apos;, [&amp;apos;sass&amp;apos;]);
  <span class="comment">// ... Other watchers</span>
}); 
</code></pre><p>Now if you run the watch task, you&#x2019;ll see that Gulp tells the command line to first run the sass task, followed by the watch task. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2ad63.png" alt=""></p>
<p>Since we&#x2019;re already watching and recompiling Sass files when it&#x2019;s changed, why not bring it further and reload the browser each time the file is saved?</p>
<h2 id="Automatically_Refreshing_the_Browser_when_you_save">Automatically Refreshing the Browser when you save</h2><p>Having the browser automatically refreshing when you save a file is a task that saves you lots of time and hand-ache.</p>
<p>The best project for refreshing the browser right now is <a href="http://www.browsersync.io" target="_blank" rel="external">Browser Sync</a> , and we can use with Gulp easily. </p>
<p>First, we&#x2019;ll have to install Browser Sync.</p>
<pre><code>$ npm install browser-sync --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>You&#x2019;ll notice that there&#x2019;s no more gulp- prefix when installing Browser Sync. This is because Browser Sync can be made to work with Gulp right out of the box; you don&#x2019;t need a Gulp plugin. </p>
<p>We&#x2019;ll have to require Browser Sync, as usual. </p>
<pre><code><span class="label">var</span> <span class="keyword">browserSync </span>= <span class="preprocessor">require</span>(&amp;apos<span class="comment">;browser-sync&amp;apos;);</span>
</code></pre><p>Browser Sync spins up a local server to load static HTML files. We&#x2019;ll have to provide it with some initial configurations so it knows where to find our index.html file. </p>
<p>Let&#x2019;s make a browserSync task for spinning up this server. </p>
<pre><code><span class="comment">// Start browserSync server</span>
gulp.task(&amp;apos;browserSync&amp;apos;, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{
  browserSync({
    server: {
      baseDir: &amp;apos;app&amp;apos;
    }
  })
})
</code></pre><p>Next, we&#x2019;ll need to change the sass task slightly to allow Browser Sync to inject new CSS into the HTML. To do so, we&#x2019;ll hav eto add a return before gulp.src and we&#x2019;ll have to .pipe() a Browser Sync reload method. </p>
<pre><code>gulp.task<span class="params">(&amp;apos;sass&amp;apos;, function<span class="params">()</span> {
  return gulp.src<span class="params">(&amp;apos;app/scss/styles.scss&amp;apos;)</span> // added return 
    .pipe<span class="params">(sourcemaps.init<span class="params">()</span>)</span>
    .pipe<span class="params">(sass<span class="params">()</span>)</span>
    .pipe<span class="params">(autoprefixer<span class="params">()</span>)</span>
    .pipe<span class="params">(sourcemaps.write<span class="params">()</span>)</span>
    .pipe<span class="params">(gulp.dest<span class="params">(&amp;apos;app/css&amp;apos;)</span>)</span>
    // Reloading the stream
    .pipe<span class="params">(browserSync.reload<span class="params">({
      stream: <span class="literal">true</span>
    })</span>)</span>;
})</span>;
</code></pre><p>We&#x2019;ll also have to make sure the browserSync task runs before the watch task. </p>
<pre><code>gulp.task(&amp;apos;watch&amp;apos;, [&amp;apos;browserSync&amp;apos;, &amp;apos;sass&amp;apos;], <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{
  gulp.watch(&amp;apos;app/scss/styles.scss&amp;apos;, [&amp;apos;sass&amp;apos;]);
});
</code></pre><p>If you run gulp watch in the terminal now, you&#x2019;ll see that browserSync and sass runs concurrently, followed by watch . In addition, a browser pops up to show you the current index.html file. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2afd4.png" alt=""></p>
<p>So if you change the styles.scss file and save&#x2026; </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2afd4.gif" alt=""></p>
<p>Viola! </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2b245.gif" alt=""></p>
<p>Since we&#x2019;re already watching for changes and refreshing the browser when we save styles.scss , why not do it for index.html as well? </p>
<pre><code><span class="component">gulp.task(&amp;apos;watch&amp;apos;, [&amp;apos;sass&amp;apos;], function() {
  gulp<span class="string">.watch(&amp;apos</span>;app/scss/styles<span class="string">.scss&amp;apos</span>;, [&amp;apos;sass&amp;apos;]);
  gulp<span class="string">.watch(&amp;apos</span>;app/index<span class="string">.html&amp;apos</span>;, [browserSync<span class="string">.reload])</span>;
}</span>); 
</code></pre><p>Now that&#x2019;s an example of a decent workflow that converts Sass to CSS. Of course, there&#x2019;s a lot of improvements you can make to it. For instance, you can configure options for each of the plugins used, and you can also watch more files with some node globbing knowledge.</p>
<p>We&#x2019;ll cover those in the next article </p>
<p><img src="http://taojinke.github.io/img/20150703/2f2b4b6.gif" alt=""></p>
<p>Now let&#x2019;s do a quick summary.</p>
<h2 id="Wrapping_Up">Wrapping Up</h2><p>So in this article we learned how to install Gulp and we learn to set up a basic task with Gulp.</p>
<p>Then we went ahead and setup a real task by adding different gulp plugins to the mix.</p>
<p>Eventually, we made it much better by watching the files for change and refreshing the browser whenever possible.</p>
<p>There&#x2019;s still a whole lot more to configuring Gulp, but we&#x2019;ll pause here for now. Let&#x2019;s continue in the next article.</p>
<p>What is one thing you&#x2019;ve learned about Gulp in this tutorial? Let me know in the comments below!</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Gulp/">Gulp</a><a href="/tags/Sass/">Sass</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2f37324/" title="How to Grunt and Gulp Your Way to Workflow Automation -" itemprop="url">How to Grunt and Gulp Your Way to Workflow Automation -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:57.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>This article is part of a web dev series from Microsoft. Thank you for supporting the partners who make SitePoint possible.</p>
<p>When you are new to front-end development and start mastering HTML5, CSS and JavaScript, the obvious next step is to put your hands on tools that most developers use to stay sane in this complex space. You too deserve to have more flexibility and features while writing your CSS sheets by using Less. You too deserve to optimize bandwidth by minifying your JS code. You too deserve to be able to automatically check that your JS code is good using JSHint. You deserve all this good stuff.</p>
<p>So you start to use all these great tools by hand; running more and more command lines manually. Sometimes, you forget to run the Less compiler. Sometimes you forget to run JSHint and a bug is shipped&#x2026;</p>
<p>And suddenly you find yourself wondering: is there any solution to automate all these tools? How can you create a repeatable workflow to prevent you from doing mistakes?</p>
<p>Obviously a solution exists, and two tools in particular are waiting for you to get started: <strong>Grunt</strong> and <strong>Gulp</strong> . </p>
<p>As a newbie using these tools, you are wondering how they work and which one to use, aren&#x2019;t you? Well perfect then, you are reading the right article!</p>
<h2 id="The_Sample_We&#x2019;ll_Use">The Sample We&#x2019;ll Use</h2><p>I will give you the basis for using Grunt and Gulp using a really simple example that you can download here: <a href="http://aka.ms/gruntgulpplugin?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">http://aka.ms/gruntgulpplugin</a></p>
<p>It is a simple web site composed of three files:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f307b8.png" alt=""></p>
<p>Styles.less define the CSS sheet in a richer manner that what you can do using standard CSS file. In the end we use the Less compiler to create a styles.css file. Using less, we are able for instance to use variables in the css file: </p>
<p><img src="http://taojinke.github.io/img/20150703/2f30a29.png" alt=""></p>
<p>Get more info about Less here: <a href="http://lesscss.org/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">http://lesscss.org/</a></p>
<p>The JavaScript and HTML code are really simple. The page should look like this:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f30c9a.png" alt=""></p>
<h2 id="Understanding_Node-js_Package_Manager">Understanding Node.js Package Manager</h2><p>You need to understand first how Node.JS Package Manager (npm) works.</p>
<p>Npm is the tool provided with Node.JS. It is used to get tools and frameworks while automatically resolving their dependencies.</p>
<p>For instance, to use less and compile it into a web usable CSS file, you first need to install less using this command:</p>
<pre><code>npm <span class="keyword">install</span> -g <span class="operator">less</span>
</code></pre><p><em>Note: To get the npm command line, you have to install nodejs from</em><a href="http://nodejs.org/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">http://nodejs.org/</a></p>
<p>Once this is done you can run this command to compile .less files into .css:</p>
<pre><code><span class="tag">lessc</span> <span class="tag">styles</span><span class="class">.less</span> &amp;<span class="tag">gt</span>; <span class="tag">styles</span><span class="class">.css</span>
</code></pre><p>Npm uses a file that it creates and store on the local folder it is working: package.json . This file is using the JavaScript Object Notation (JSON) format to let npm know which tool and version is installed and the frameworks used by the current project (which is represented by the current folder). </p>
<p>This file is important for Grunt and Gulp because it will contain the list of plugins downloaded and usable in your automation workflow.</p>
<p>To create an empty package.json file you can use the following npm command:</p>
<pre><code><span class="built_in">npm</span> init
</code></pre><p>You will go through some questions that you can answer using the default option, then you will be all set to start.</p>
<p>In this file you will have two kinds of dependencies:</p>
<ul>
<li>The ones needed for the execution of your web app / nodejs app</li>
<li>The ones needed for the development phase (like Less) and which are used to compile / check your code</li>
</ul>
<p>Npm basically gives you three ways to install packages:</p>
<ul>
<li>Globally on your machine using the &#x2013;g or-global option</li>
<li>For execution purpose, locally on your project folder using no options (only npm install [tools or framework])</li>
<li>For dev purpose, locally on your project folder using the —save-dev option</li>
</ul>
<p>The third one will create a devDependencies section / property inside the package.json file. </p>
<p><img src="http://taojinke.github.io/img/20150703/2f318cf.png" alt=""></p>
<h2 id="Grunt">Grunt</h2><h3 id="What_is_grunt?">What is grunt?</h3><p>Grunt is a pioneer in the JavaScript automation workflow area. There are a lot of <a href="http://gruntjs.com/who-uses-grunt?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">known Grunt users</a> like Twitter, jQuery and Modernizr. </p>
<p>The basic principle for Grunt is to give us an easy way to run tasks . A task is a set of code files and configuration files already created for you. You can get new tasks by installing Grunt plugins that you will get using npm. You can find a plugin for pretty much every tool you might use, such as <a href="https://www.npmjs.com/package/grunt-contrib-less?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Less</a> and <a href="https://www.npmjs.com/package/grunt-contrib-jshint?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">JSHint</a> . </p>
<p>To run Grunt, you have to create a Gruntfile in which you specify which tasks you want to run and the configuration for each of them. Once this is done, you only have to run the grunt command line specifying the task you want to run (default or a specific one) and it will do it automatically. </p>
<p>Now let&#x2019;s go through a step by step guide to set up all this.</p>
<h3 id="Step_1-_Create_the_package-json_file">Step 1. Create the package.json file</h3><p>Use npm to init the file: </p>
<pre><code><span class="built_in">npm</span> init
</code></pre><p>You will have to answer a few questions like the project name and what is the default .js file. You can also choose to create the file manually and setting its content to:</p>
<pre><code><span class="collection">{
  &amp;quot;name&amp;quot;: &amp;quot;project-name&amp;quot;,
  &amp;quot;devDependencies&amp;quot;: <span class="collection">{}</span>,
  &amp;quot;dependencies&amp;quot;: <span class="collection">{}</span>
}</span>
</code></pre><h3 id="Step_2-_Install_Grunt_globally_and_locally">Step 2. Install Grunt globally and locally</h3><p>You need to install Grunt globally to get the command line and locally to initialize everything needed for the project.</p>
<p>Run:</p>
<pre><code>npm <span class="keyword">install</span> -g grunt
</code></pre><p>Then run it locally:</p>
<pre><code>npm install grunt --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>Note: Do not forget the &#x2013;dev part for it to be specified as a devDependencie in the package.json file. </p>
<h3 id="Step_3-_Create_the_gruntFile-js">Step 3. Create the gruntFile.js</h3><p>Grunt works using a file named gruntFile.js. This file contains everything needed by Grunt, that is to say:</p>
<ul>
<li>Configuration for tasks</li>
<li>Custom tasks</li>
<li>Task loading</li>
</ul>
<p>Grunt expect the file to export a single function which take one parameter named grunt . You will use this object to perform all Grunt related actions. </p>
<p>Here is a minimal gruntfile that only read the package.json file and create a default task which runs nothing. </p>
<p>Note: place the file in the project folder, side by side with the package.json file </p>
<pre><code><span class="function"><span class="keyword">module</span>.<span class="title">exports</span> =</span> <span class="function"><span class="keyword">function</span><span class="params">(grunt)</span> {</span>

  <span class="comment">// Project configuration.</span>
  grunt.initConfig<span class="params">({
    pkg: grunt.file.readJSON<span class="params">(&amp;apos;package.json&amp;apos;)</span>,
  })</span>;

  <span class="comment">// Default task(s).</span>
  grunt.registerTask<span class="params">(&amp;apos;default&amp;apos;, [])</span>;

};
</code></pre><p>You can execute it to be sure everything is configured correctly.</p>
<p>To do that, open a command prompt on the project folder and run:</p>
<pre><code>grunt
</code></pre><p>You should see something like this:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f31b40.png" alt=""></p>
<h3 id="Step_4-_Add_your_first_task:_JSHint">Step 4. Add your first task: JSHint</h3><p>Now that your Gruntfile is ready, the next step is to add a plugin and use it. All plugins can be found here: <a href="http://gruntjs.com/plugins?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">http://gruntjs.com/plugins</a> . One of the common tasks performed in a Gruntfile is checking if the JavaScript syntax is correct. To do that, we usually use JSHint. </p>
<p>Let&#x2019;s add is to your grunt workflow.</p>
<p>If you search for JShint on the grunt plugins page, you will find grunt-contrib-jshint ( <a href="https://www.npmjs.com/package/grunt-contrib-jshint?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">here</a> ) which corresponds to what we need! </p>
<p>In the project folder, run:</p>
<pre><code>npm install grunt-contrib-jshint --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>One this is done you have to add it in your Gruntfile.js. There are two simple steps for that:</p>
<ul>
<li>Load the plugin</li>
<li>Configure the task</li>
</ul>
<p>To load the plugin, use the loadNpmTasks function: </p>
<pre><code><span class="comment">// Load the plugin that provides the &amp;quot;jshint&amp;quot; task</span>
grunt.loadNpmTasks<span class="params">(&amp;apos;grunt-contrib-jshint&amp;apos;)</span>;
</code></pre><p>The configuration is done in the initConfig function where you have to add a new property to the object given in parameter. This have to be the name of the task you want to add and is related to the plugin you use. The best way to know that name and the list of available options for the task is to have a look at the plugin documentation. You will always find a well-documented sample. </p>
<p>For instance, in our sample we want to check all the JavaScript files except the gruntfile.js . We also want to activate a set of rules to check in the JavaScript files like eqeqeq to ensure we use triple equals when needed. </p>
<p>Here is the initConfig function modified:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f31b40.png" alt=""></p>
<p>You can run your task by using the following command line (where you specify the task name as a parameter for grunt ): </p>
<pre><code><span class="title">grunt</span> jshint
</code></pre><p>The result is here:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f31db1.png" alt=""></p>
<p>You just have to run that command and it will automatically prompt you for any errors it encounter.</p>
<p>Congratulation, you now have a task automated in your grunt workflow!</p>
<h3 id="Step_5-_Add_a_second_task:_Less_compilation">Step 5. Add a second task: Less compilation</h3><p>Your JShint task works well but it is a little bit alone in the workflow. Usually, we are using tools like grunt to run more than one task.</p>
<p>It is really easy to add more of them as you just have to follow the same steps. Let&#x2019;s say you now want to add the compilation for your less file inside the automated process. If you search in the grunt plugins, you will find a grunt-contrib-less plugin that you can install on your project folder:</p>
<pre><code>npm <span class="keyword">install</span> grunt-contrib-<span class="operator">less</span> --save-dev
</code></pre><p>Like for the jshint task, you have to add the configuration:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f32022.png" alt=""></p>
<p>Then, load the task:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f32022.png" alt=""></p>
<p>You can now run Grunt and specify the less task: this will launch only less. That is OK but you want to run all the tasks right? That is the role of the default task. </p>
<p>When you just run grunt without specifying any task it will search for a default task and run all the task specified in its array. You can modify it to run less and jshint . Note that to add a group of tasks like default your need to call the registerTask function: </p>
<p><img src="http://taojinke.github.io/img/20150703/2f32293.png" alt=""></p>
<p>From now, when you run:</p>
<pre><code>grunt
</code></pre><p>It will run jshint, then less:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f32293.png" alt=""></p>
<p>You can add any task you want, and you can also specify other group of task like default and call them by passing their name as an argument to the grunt command line. </p>
<p>Easy right?</p>
<h3 id="Step_6-_Use_watch_so_you_do_not_have_to_run_grunt_manually">Step 6. Use watch so you do not have to run grunt manually</h3><p>Now, you are a happy developer. All you repetitive tasks are automated inside a grunt workflow and you just have to run grunt for them to execute. But that can be done even more easily. That can be done automatically.</p>
<p>To do that, you can add a specific task named watch . This task will constantly inspect your working folder and, based on rules, when a file is modified, grunt will run an associated task. </p>
<p>First, install watch in your project folder:</p>
<p>npm install grunt-contrib-watch &#x2013;save-dev</p>
<p>Load it like all other tasks using the loadNpmTasks function and configure it. The config part is a bit different here because you need to specify a configuration for each task you want to cover using watch . </p>
<p><img src="http://taojinke.github.io/img/20150703/2f32504.png" alt=""></p>
<p>You can find the full documentation for this task here: <a href="https://www.npmjs.com/package/grunt-contrib-watch?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">https://www.npmjs.com/package/grunt-contrib-watch</a></p>
<p>When you want to activate watch you only have to run the following command: </p>
<p>grunt watch</p>
<p>And it will execute tasks each time a file is changed and this file is in the scope of watched files for the specific task.</p>
<p><img src="http://taojinke.github.io/img/20150703/2f32504.png" alt=""></p>
<p>And that&#x2019;s it! You now know everything to create automated workflow using grunt.</p>
<h2 id="Gulp">Gulp</h2><p>What is Gulp?</p>
<p>Gulp is an alternative to grunt. It is a bit more recent and has a reputation as being more flexible than grunt. Before choosing which one you will use, let&#x2019;s have a look at how gulp works.</p>
<p>Gulp ( <a href="http://gulpjs.com/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">http://gulpjs.com/</a> ) is a workflow automation tool. Like grunt, it works using npm and the package.json file. All available plugins will also be downloaded using npm and added as devDependencies in the package.json file. </p>
<p>One of the main differences with Gulp is that it uses streams. A stream is a set of functions through which a file will go and be modified in memory . The file will be written on the disk only at the end of the process so it is more efficient. Grunt tasks, on the other hand, work as silos and cannot be chained. </p>
<p>Let&#x2019;s have a quick look at how Gulp works by following a few easy steps.</p>
<h3 id="Step_1-_Create_the_package-json_file-1">Step 1. Create the package.json file</h3><p>Similar to Grunt, you first have to create the package.json file. You can use the exact same technique you used for the grunt sample. </p>
<h3 id="Step_2-_Install_Gulp_and_gulp-util_globally_and_locally">Step 2. Install Gulp and gulp-util globally and locally</h3><p>Once the package.json file is created, install gulp globally and locally using:</p>
<pre><code>npm <span class="keyword">install</span> -g gulp
</code></pre><p>and</p>
<pre><code>npm install gulp --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>This will install the gulp command line and everything needed to run a gulp workflow.</p>
<p>You then have to install gulp utils which contains common function shared by other plugins:</p>
<pre><code>npm install gulp-util --<span class="built_in">save</span>-<span class="built_in">dev</span>
</code></pre><p>Finally, create the minimum gulp file which will look like this:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f32775.png" alt=""></p>
<p>As you can see it is a bit different from the grunt syntax. In gulp, plugins are loaded using the require syntax as you might be used to if you are a nodeJS developer. There is also a default task defined using the gulp.task function. </p>
<p>If you run the gulp command line using a command prompt in the project folder, you should see a result like this: </p>
<p><img src="http://taojinke.github.io/img/20150703/2f329e6.png" alt=""></p>
<h3 id="Step_3-_Using_your_first_task:_Less_compilation">Step 3. Using your first task: Less compilation</h3><p>To use a plugin in gulp, you use the same function as the one we used to create the default task. This is because you do not have to use a specific name to create a task. You just call gulp.task, set the name you want and give it a JavaScript function as a second parameter. When gulp runs the task, it will run this function. </p>
<p>To use a plugin, you call it using the name you chose when require -ing it. Usually, you call it as part of a streaming workflow which generally starts with a selection of files. This is done with the gulp.src function. It will select a bunch of files and return a stream that can be used by another function using pipe . That is how you can chain multiple actions without writing them to the disk. You just pass the stream from one plugin to another. </p>
<p>Here is a simple sample for less:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f32c57.png" alt=""></p>
<p>We first require (&#x2018;gulp-less&#x2019;) to load the less plugin for gulp. (We got it using npm install gulp-less —save-dev ). </p>
<p>Then gulp.src will select all the .less files, we &#x2018;pipe&#x2019; it to the less() function and it finally is &#x2018;piped&#x2019; to gulp.dest which indicates where to write the result. As gulp.src can select more than one file, gulp.dest specifies a folder. </p>
<p>Once you understand the piping model, you can easily get the same result as the one we got using grunt.</p>
<p>The power of gulp is that you can create custom task in which you call more than one plugin and where you can associate them the way you want.</p>
<p>Note: there is obviously also a gulp-watch plugin you can use to automated the launch of your workflow! </p>
<h2 id="Conclusion:_which_one_to_choose?">Conclusion: which one to choose?</h2><p>I hope that you have now a clearer understanding of why you need an automation workflow and how you can use grunt or gulp to get it. </p>
<p>Choosing one of them is more related to the task you want to achieve.</p>
<p>Grunt is easy to use. You do not have to understand the piping system and achieving simple task will be more straight-forward. It is a really mature tool, used by a lot of known editors and developers and there is a lot of plugins available.</p>
<p>Once that said, the way gulp is designed can give you a lot of flexibility. It has existed for quite some time now and even if you won&#x2019;t find as many plugins as you will for grunt, all the classic ones are available for gulp.</p>
<p>If you are using a really standard workflow with common steps like jshint, uglifying, css validating etc., Grunt is a good choice. If you are up to more complicated tasks, gulp will be a good wingman.</p>
<h2 id="More_information">More information</h2><ul>
<li>Grunt website: <a href="http://gruntjs.com/" target="_blank" rel="external">http://</a><a href="http://gruntjs.com/" target="_blank" rel="external">com/</a></li>
<li>Gulp website : <a href="http://gulpjs.com" target="_blank" rel="external">http://</a><a href="http://gulpjs.com" target="_blank" rel="external">com</a></li>
<li>Use grunt inside Microsoft Visual Studio:<a href="http://www.asp.net/vnext/overview/aspnet-vnext/grunt-and-bower-in-visual-studio-2015?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">http://www.asp.net/vnext/overview/aspnet-vnext/grunt-and-bower-in-visual-studio-2015</a></li>
</ul>
<h2 id="More_hands-on_with_JavaScript">More hands-on with JavaScript</h2><p>Microsoft has a bunch of free learning on many open source JavaScript topics and we&#x2019;re on a mission to create a lot more with <a href="http://blogs.windows.com/msedgedev/2015/04/29/introducing-microsoft-edge-the-browser-built-for-windows-10/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Microsoft Edge</a> . Here are some to check-out: </p>
<ul>
<li><a href="http://channel9.msdn.com/events/WebPlatformSummit/2015?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Microsoft Edge Web Summit 2015</a> (a complete series of what to expect with the new browser, new web platform features, and guest speakers from the community)</li>
<li><a href="http://www.microsoftvirtualacademy.com/training-courses/best-of-build-and-windows-10?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Build of //BUILD/ and Windows 10</a> (including the new JavaScript engine for sites and apps)</li>
<li><a href="http://channel9.msdn.com/Events/WebPlatformSummit/2015/Advancing-JavaScript-without-breaking-the-web?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Advancing JavaScript without Breaking the Web</a> (Christian Heilmann&#x2019;s recent keynote)</li>
<li><a href="http://channel9.msdn.com/Events/Build/2015/2-665?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Hosted Web Apps and Web Platform Innovations</a> (a deep-dive on topics like manifold.JS)</li>
<li><a href="http://channel9.msdn.com/Series/Practical-Performance-Tips-to-Make-Your-HTMLJavaScript-Faster/06?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Practical Performance Tips to Make your HTML/JavaScript Faster</a> (a 7-part series from responsive design to casual games to performance optimization)</li>
<li><a href="http://www.microsoftvirtualacademy.com/training-courses/the-modern-web-platform-jump-start?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">The Modern Web Platform JumpStart</a> (the fundamentals of HTML, CSS, and JS)</li>
</ul>
<p>And some free tools to get started: <a href="https://code.visualstudio.com/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Visual Studio Code</a> , <a href="http://azure.microsoft.com/en-us/pricing/free-trial/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Azure Trial</a> , and <a href="http://dev.modern.ie/?utm_source=SitePoint&amp;utm_medium=article34&amp;utm_campaign=SitePoint" target="_blank" rel="external">cross-browser testing tools</a> &#x2013; all available for Mac, Linux, or Windows. </p>
<p>This article is part of the web dev tech series from Microsoft. We&#x2019;re excited to share <a href="http://blogs.windows.com/msedgedev/2015/04/29/introducing-microsoft-edge-the-browser-built-for-windows-10/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">Microsoft Edge</a> and the new <a href="http://blogs.windows.com/msedgedev/2015/02/26/a-break-from-the-past-the-birth-of-microsofts-new-web-rendering-engine/?WT.mc_id=13410-DEV-sitepoint-article34" target="_blank" rel="external">EdgeHTML rendering engine</a> with you. Get free virtual machines or test remotely on your Mac, iOS, Android, or Windows device @ <a href="http://dev.modern.ie/?utm_source=SitePoint&amp;utm_medium=article34&amp;utm_campaign=SitePoint" target="_blank" rel="external">modern.IE</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Grunt/">Grunt</a><a href="/tags/Gulp/">Gulp</a><a href="/tags/工作流/">工作流</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2f40811/" title="The long road to Async/Await in JavaScript -" itemprop="url">The long road to Async/Await in JavaScript -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:57.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> This is a comparison of different methods for performing asynchronous control flow in JavaScript, specifically <strong>Callbacks</strong> , <strong>Promises</strong> , <strong>Generators</strong> / <strong>Yields</strong> (ES6), and <strong>Async</strong> / <strong>Await</strong> (ES7).&#xA0;To follow along be sure you understand how the <a href="https://thomashunter.name/blog/the-javascript-event-loop-presentation/" target="_blank" rel="external">JavaScript Event Loop</a> works and what it means&#xA0;when code is executed synchronously in the current stack, or shoved into the queue to be executed asynchronously in the future. </p>
<p>In the following contrived examples, publishLevel() is our main application code (perhaps something we&#x2019;d see in a <strong>Controller</strong> ), whereas&#xA0; getUser() , canCreate() , and saveLevel() are functions&#xA0;nested deeper in our application (perhaps in our <strong>Model</strong> s). </p>
<p>Compatibility:&#xA0;Keep in mind that anything marked as <strong>ES6</strong> will require Node.js &gt;= 0.12 with the —harmony flag enabled, or any version of io.js &gt;= 1.0. <a href="https://kangax.github.io/compat-table/es6/" target="_blank" rel="external">Browser support for ES6</a> is anything but spectacular and you&#x2019;ll likely need&#xA0;to transpile. Anything marked as <strong>ES7</strong> will definitely require a transpile for either Browser or Node.js. </p>
<h2 id="Stage_0:_Synchronous&#xA0;Code">Stage 0: Synchronous&#xA0;Code</h2><p>This of course is not Asynchronous code&#xA0;but&#xA0;it does show us&#xA0;eloquent syntax. If you&#x2019;re used to writing applications in, say, PHP, all of your code looks like this. This is the cleanest&#xA0;way one can write code and have it execute sequentially.</p>
<p>In the publishLevel() function we execute a function, get the result, pass it to the next function, run a branch, all in the current stack, all using minimal syntax.</p>
<pre><code><span class="keyword">var</span> level_result = publishLevel(<span class="number">12</span>, {data: <span class="literal">true</span>});
<span class="built_in">console</span>.log(level_result);

<span class="function"><span class="keyword">function</span> <span class="title">publishLevel</span>(<span class="params">user_id, level_data</span>) </span>{
  <span class="keyword">var</span> user = getUser(user_id);
  <span class="keyword">var</span> can_create = canCreate(user);

  <span class="keyword">if</span> (!can_create) {
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">var</span> level = saveLevel(user, level_data);

  <span class="keyword">return</span> level;
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id</span>) </span>{
  <span class="keyword">return</span> {
    id: user_id,
    nickname: &amp;apos;tlhunter&amp;apos;
  };
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> user.id === <span class="number">12</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data</span>) </span>{
  <span class="keyword">return</span> {
    id: <span class="number">100</span>,
    owner: user.nickname,
    data: data
  };
}
</code></pre><h2 id="Stage_1:_Callbacks">Stage 1: Callbacks</h2><p>This is the defacto approach&#xA0;used in&#xA0;Node.js applications where sequential&#xA0;asynchronous operations need to happen. As more function calls need to happen your code starts to nest even deeper. This phenomenon is affectionately known as callback hell.</p>
<p>What happens if you want to add another operation in the middle? You&#x2019;ve got to re-nest all subsequent tasks within the new operation. Over time&#xA0;your code begins&#xA0;to flare outward, and those git-blame&#x2019;s start to lie.</p>
<pre><code>publishLevel(<span class="number">12</span>, {data: <span class="literal">true</span>}, <span class="function"><span class="keyword">function</span>(<span class="params">level_result</span>) </span>{
  <span class="built_in">console</span>.log(level_result);
});

<span class="function"><span class="keyword">function</span> <span class="title">publishLevel</span>(<span class="params">user_id, level_data, cb</span>) </span>{
  getUser(user_id, <span class="function"><span class="keyword">function</span>(<span class="params">user</span>) </span>{
    canCreate(user, <span class="function"><span class="keyword">function</span>(<span class="params">can_create</span>) </span>{
      <span class="keyword">if</span> (!can_create) {
        <span class="keyword">return</span> cb(<span class="literal">null</span>);
      }
      saveLevel(user, level_data, <span class="function"><span class="keyword">function</span>(<span class="params">level</span>) </span>{
        cb(level);
      });
    });
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id, cb</span>) </span>{
  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    cb({
      id: user_id,
      nickname: &amp;apos;tlhunter&amp;apos;
    });
  }, <span class="number">100</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user, cb</span>) </span>{
  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    cb(user.id === <span class="number">12</span>);
  }, <span class="number">100</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data, cb</span>) </span>{
  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    cb({
      id: <span class="number">100</span>,
      owner: user.nickname,
      data: data
    });
  }, <span class="number">100</span>);
}
</code></pre><h2 id="Stage_2:_Promises_(ES6&#xA0;or&#xA0;ES5_+_Polyfill)">Stage 2: Promises (ES6&#xA0;or&#xA0;ES5 + Polyfill)</h2><p>This is the approach used by a large codebase I&#x2019;ve been working with lately. While we don&#x2019;t get Promises until ES6, ES5 can use them thanks to polyfills such as <a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">Bluebird</a> . </p>
<p>The benefit of using Promises is&#xA0;we don&#x2019;t need to continually nest functions, and adding new work in the middle is as simple as adding a few extra lines.</p>
<p>In my opinion the syntax is a bit ugly. Chaining .then() calls from previous executions and calling&#xA0;the next bit of asynchronous work within the same function just doesn&#x2019;t feel right.</p>
<pre><code>publishLevel(<span class="number">12</span>, {data: <span class="literal">true</span>}).then(<span class="function"><span class="keyword">function</span>(<span class="params">level_result</span>) </span>{
  <span class="built_in">console</span>.log(level_result);
});

<span class="function"><span class="keyword">function</span> <span class="title">publishLevel</span>(<span class="params">user_id, level_data, cb</span>) </span>{
  <span class="keyword">var</span> user = <span class="literal">null</span>;
  <span class="keyword">return</span> getUser(user_id).then(<span class="function"><span class="keyword">function</span>(<span class="params">_user</span>) </span>{
    user = _user;
    <span class="keyword">return</span> canCreate(_user);
  }).then(<span class="function"><span class="keyword">function</span>(<span class="params">can_create</span>) </span>{
    <span class="keyword">if</span> (!can_create) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }

    <span class="keyword">return</span> saveLevel(user, level_data);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: user_id,
        nickname: &amp;apos;tlhunter&amp;apos;
      });
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve(user.id === <span class="number">12</span>);
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: <span class="number">100</span>,
        owner: user.nickname,
        data: data
      });
    }, <span class="number">100</span>);
  });
}
</code></pre><p>Promises everywhere is certainly more fun than Promises somewhere. If you&#x2019;re planning on heavily using Promises with Node.js, check out <a href="https://github.com/normalize/mz" target="_blank" rel="external">mz,</a> which will Promisify the Node.js API. </p>
<h2 id="Stage_3:_Generators/Yields_(ES6)">Stage 3: Generators/Yields (ES6)</h2><p>ES6 gives us <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank" rel="external">Generator</a> functions which we can <strong>yield</strong> . When a function yields it is temporarily paused while the caller gets to do something with the yielded value. These were designed with&#xA0;doing iteration-based tasks in mind, yielding simple values, but here we&#x2019;re going to yield Promises! </p>
<p>This is the first time&#xA0;we see code able to get executed in a different stack&#xA0;yet exist within the same function scope. Of course this new paradigm requires a new syntax. Generator functions have a <strong>*</strong> in their declaration, and we make use of the&#xA0;new&#xA0; <strong>yield</strong> keyword. </p>
<p>These <em>can</em> be used for doing control flow, but it&#x2019;s really intended for iteration work, as you&#x2019;ll see in this next example where I run a whole bunch of ugly code to manually keep the generator alive: </p>
<pre><code><span class="keyword">var</span> generator = publishLevel(<span class="number">12</span>, {data: <span class="literal">true</span>});

generator.next().value.then(<span class="function"><span class="keyword">function</span>(<span class="params">user</span>) </span>{
   <span class="keyword">return</span> generator.next(user).value.then(<span class="function"><span class="keyword">function</span>(<span class="params">can_create</span>) </span>{
     <span class="keyword">return</span> generator.next(can_create).value.then(<span class="function"><span class="keyword">function</span>(<span class="params">level_result</span>) </span>{
       <span class="built_in">console</span>.log(level_result);
     });
   });
 });

<span class="function"><span class="keyword">function</span> * <span class="title">publishLevel</span>(<span class="params">user_id, level_data</span>) </span>{
  <span class="keyword">var</span> user = <span class="keyword">yield</span> getUser(user_id);
  <span class="keyword">var</span> can_create = <span class="keyword">yield</span> canCreate(user);

  <span class="keyword">if</span> (!can_create) {
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">var</span> level = <span class="keyword">yield</span> saveLevel(user, level_data);

  <span class="keyword">return</span> level;
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: user_id,
        nickname: &amp;apos;tlhunter&amp;apos;
      });
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve(user.id === <span class="number">12</span>);
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: <span class="number">100</span>,
        owner: user.nickname,
        data: data
      });
    }, <span class="number">100</span>);
  });
}
</code></pre><p>Notice this intimate knowledge we need to know about the function we&#x2019;re calling! We take the result, pass it into another generator.next() call as an argument (this becomes the result of the yielded assignment). </p>
<p>Objects returned by generators have a .next() method, with a .done and .value attribute. If done is true, then the generators work is finished&#xA0;(the final return), however if done is false then there&#x2019;s more work to happen&#xA0;(the preceding yield&#x2019;s).&#xA0;The calling function is given the intermediate yield values, and has to know to continue the execution of the generator. While this is great for doing iteration work, it&#x2019;s tedious&#xA0;from the perspective of doing asynchronous control flow. </p>
<h2 id="Stage_4:_Async/Await_(ES7)">Stage 4: Async/Await (ES7)</h2><p>Async / Await is amazing, the mecca of working with asynchronous code in JavaScript. Personally I think it&#x2019;s a shame we got Generators in ES6 instead of this. The solution is so eloquent that it will forever change the way we write JavaScript.</p>
<p>Internally it works with Promises. When the promise returned by an await&#xA0;resolves the code in the function will continue executing, and the resolved value will be provided.</p>
<pre><code>publishLevel(<span class="number">12</span>, {data: <span class="literal">true</span>}).then(<span class="function"><span class="keyword">function</span>(<span class="params">level_data</span>) </span>{
  <span class="built_in">console</span>.log(level_data);
});

<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">publishLevel</span>(<span class="params">user_id, level_data</span>) </span>{
  <span class="keyword">var</span> user = <span class="keyword">await</span> getUser(user_id);
  <span class="keyword">var</span> can_create = <span class="keyword">await</span> canCreate(user);

  <span class="keyword">if</span> (!can_create) {
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">var</span> level = <span class="keyword">await</span> saveLevel(user, level_data);

  <span class="keyword">return</span> level;
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: user_id,
        nickname: &amp;apos;tlhunter&amp;apos;
      });
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve(user.id === <span class="number">12</span>);
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: <span class="number">100</span>,
        owner: user.nickname,
        data: data
      });
    }, <span class="number">100</span>);
  });
}
</code></pre><p>You can transpile this down to ES5 today using Babel:</p>
<pre><code>$ npm install babel-<span class="keyword">runtime</span>
$ babel --stage=<span class="number">1</span> --optional <span class="keyword">runtime</span> <span class="built_in">input</span>.es7.js &amp;gt; output.es5.js
</code></pre><p>What does this code look like after transpilation?</p>
<pre><code>&amp;apos;use strict&amp;apos;;

<span class="keyword">var</span> _regeneratorRuntime = <span class="built_in">require</span>(&amp;apos;babel-runtime/regenerator&amp;apos;)[&amp;apos;<span class="keyword">default</span>&amp;apos;];

<span class="keyword">var</span> _Promise = <span class="built_in">require</span>(&amp;apos;babel-runtime/core-js/promise&amp;apos;)[&amp;apos;<span class="keyword">default</span>&amp;apos;];

publishLevel(<span class="number">12</span>, { data: <span class="literal">true</span> }).then(<span class="function"><span class="keyword">function</span> (<span class="params">level_data</span>) </span>{
  <span class="built_in">console</span>.log(level_data);
});

<span class="function"><span class="keyword">function</span> <span class="title">publishLevel</span>(<span class="params">user_id, level_data</span>) </span>{
  <span class="keyword">var</span> user, can_create, level;
  <span class="keyword">return</span> _regeneratorRuntime.async(<span class="function"><span class="keyword">function</span> <span class="title">publishLevel$</span>(<span class="params">context$1$0</span>) </span>{
    <span class="keyword">while</span> (<span class="number">1</span>) <span class="keyword">switch</span> (context$<span class="number">1</span>$<span class="number">0.</span>prev = context$<span class="number">1</span>$<span class="number">0.</span>next) {
      <span class="keyword">case</span> <span class="number">0</span>:
        context$<span class="number">1</span>$<span class="number">0.</span>next = <span class="number">2</span>;
        <span class="keyword">return</span> _regeneratorRuntime.awrap(getUser(user_id));

      <span class="keyword">case</span> <span class="number">2</span>:
        user = context$<span class="number">1</span>$<span class="number">0.</span>sent;
        context$<span class="number">1</span>$<span class="number">0.</span>next = <span class="number">5</span>;
        <span class="keyword">return</span> _regeneratorRuntime.awrap(canCreate(user));

      <span class="keyword">case</span> <span class="number">5</span>:
        can_create = context$<span class="number">1</span>$<span class="number">0.</span>sent;

        <span class="keyword">if</span> (can_create) {
          context$<span class="number">1</span>$<span class="number">0.</span>next = <span class="number">8</span>;
          <span class="keyword">break</span>;
        }

        <span class="keyword">return</span> context$<span class="number">1</span>$<span class="number">0.</span>abrupt(&amp;apos;<span class="keyword">return</span>&amp;apos;, <span class="literal">null</span>);

      <span class="keyword">case</span> <span class="number">8</span>:
        context$<span class="number">1</span>$<span class="number">0.</span>next = <span class="number">10</span>;
        <span class="keyword">return</span> _regeneratorRuntime.awrap(saveLevel(user, level_data));

      <span class="keyword">case</span> <span class="number">10</span>:
        level = context$<span class="number">1</span>$<span class="number">0.</span>sent;
        <span class="keyword">return</span> context$<span class="number">1</span>$<span class="number">0.</span>abrupt(&amp;apos;<span class="keyword">return</span>&amp;apos;, level);

      <span class="keyword">case</span> <span class="number">12</span>:
      <span class="keyword">case</span> &amp;apos;end&amp;apos;:
        <span class="keyword">return</span> context$<span class="number">1</span>$<span class="number">0.</span>stop();
    }
  }, <span class="literal">null</span>, <span class="keyword">this</span>);
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> _Promise(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      resolve({
        id: user_id,
        nickname: &amp;apos;tlhunter&amp;apos;
      });
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> _Promise(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      resolve(user.id === <span class="number">12</span>);
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> _Promise(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{
      resolve({
        id: <span class="number">100</span>,
        owner: user.nickname,
        data: data
      });
    }, <span class="number">100</span>);
  });
}
</code></pre><p>I&#x2019;m not sure how performant this code is. Certainly once JavaScript engines natively support Async / Await&#xA0;it&#x2019;ll be fast, but the output from Babel I&#x2019;m not too sure.</p>
<h2 id="Stage_3-5:_Generators/Yields&#xA0;+_co_(ES6)">Stage 3.5: Generators/Yields&#xA0;+ co (ES6)</h2><p>I put this one out of order so you&#x2019;d first see how awesome Async / Await is, and what the <a href="https://github.com/tj/co" target="_blank" rel="external">co</a> module&#xA0;attempts to emulate. </p>
<p>Async / Await is great&#xA0;but we can&#x2019;t use it today without complex&#xA0;transpilations! Generators are neat, but they require manual executions of .next() ! Luckily there&#x2019;s a sweet library called <strong>co</strong> which can sort of provide us the best of both worlds (transpile-free if you&#x2019;re running modern Node). It&#x2019;ll run .next() for us, and if we return Promises, when they resolve the generator will continue. Finally once the final return is called, that value is the final resolved value of the co-wrapped generator. </p>
<pre><code><span class="keyword">var</span> co = <span class="built_in">require</span>(&amp;apos;co&amp;apos;);

publishLevel(<span class="number">12</span>, {data: <span class="literal">true</span>}).then(<span class="function"><span class="keyword">function</span>(<span class="params">level_data</span>) </span>{
  <span class="built_in">console</span>.log(level_data);
});

<span class="function"><span class="keyword">function</span> <span class="title">publishLevel</span>(<span class="params">user_id, level_data</span>) </span>{
  <span class="keyword">return</span> co(<span class="function"><span class="keyword">function</span> * <span class="title">publishLevel</span>(<span class="params"></span>) </span>{
    <span class="keyword">var</span> user = <span class="keyword">yield</span> getUser(user_id);
    <span class="keyword">var</span> can_create = <span class="keyword">yield</span> canCreate(user);

    <span class="keyword">if</span> (!can_create) {
      <span class="keyword">return</span> <span class="literal">null</span>;
    }

    <span class="keyword">var</span> level = <span class="keyword">yield</span> saveLevel(user, level_data);

    <span class="keyword">return</span> level;
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params">user_id</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: user_id,
        nickname: &amp;apos;tlhunter&amp;apos;
      });
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">canCreate</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve(user.id === <span class="number">12</span>);
    }, <span class="number">100</span>);
  });
}

<span class="function"><span class="keyword">function</span> <span class="title">saveLevel</span>(<span class="params">user, data</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>{
    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
      resolve({
        id: <span class="number">100</span>,
        owner: user.nickname,
        data: data
      });
    }, <span class="number">100</span>);
  });
}
</code></pre><p>The solution isn&#x2019;t as eloquent as the Async/Await version. We need an additional function level and a library. But overall it&#x2019;s a nice alternative to nested callbacks or verbose Promises.</p>
<h2 id="tl;dr">tl;dr</h2><ul>
<li><strong>Stage 1: Callbacks</strong> shows us how nested callbacks give us control over Asynchronous code <ul>
<li>Pro&#x2019;s: ES5, Simple to understand, Node.js API works this way</li>
<li>Con&#x2019;s: Messy refactors, code nesting levels jump around</li>
</ul>
</li>
<li><strong>Stage 2: Promises</strong> gives us the power of callbacks but keeps code from getting out of hand <ul>
<li>Pro&#x2019;s: ES5&#xA0;with polyfill, nesting is under control</li>
<li>Con&#x2019;s: Verbose syntax</li>
</ul>
</li>
<li><strong>Stage 3: Generators/Yields</strong> describes generators and how they can get a bit messy <ul>
<li>Pro&#x2019;s:&#xA0;Works great with iterators, parts of functions can be executed in future</li>
<li>Con&#x2019;s: ES6 or transpile, painful to manually manage execution</li>
</ul>
</li>
<li><strong>Stage 3.5: Generators/Yields + co</strong> is a great solution you can use today <ul>
<li>Pro&#x2019;s: The advantage of using Generators without manually managing yields</li>
<li>Con&#x2019;s: ES6 or transpile</li>
</ul>
</li>
<li><strong>Stage 4: Async/Await</strong> is an amazing solution you can use tomorrow <ul>
<li>Pro&#x2019;s: Eloquent syntax</li>
<li>Con&#x2019;s: ES7 currently requires transpile regardless of environment</li>
</ul>
</li>
</ul>
<p>Pick your poison!</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/ECMAScript/">ECMAScript</a><a href="/tags/Node-js/">Node.js</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2f4aba4/" title="借助Nodejs探究WebSocket -" itemprop="url">借助Nodejs探究WebSocket -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:57.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x6587;&#x7AE0;&#x5BFC;&#x8BFB;&#xFF1A;</p>
<ul>
<li>&#x4E00;&#x3001;&#x6982;&#x8FF0;-what&apos;s WebSocket?</li>
<li>&#x4E8C;&#x3001;&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;WebSocket&#x5BA2;&#x6237;&#x7AEF;+&#x4F7F;&#x7528;ws&#x6A21;&#x5757;&#x642D;&#x5EFA;&#x7684;&#x7B80;&#x5355;&#x670D;&#x52A1;&#x5668;</li>
<li>&#x4E09;&#x3001;Node&#x4E2D;&#x7684;WebSocket</li>
<li>&#x56DB;&#x3001;socket.io</li>
<li>&#x4E94;&#x3001;&#x6269;&#x5C55;&#x9605;&#x8BFB;</li>
</ul>
<h3 id="&#x4E00;&#x3001;&#x6982;&#x8FF0;-what&apos;s_WebSocket?">&#x4E00;&#x3001;&#x6982;&#x8FF0;-what&apos;s WebSocket?</h3><h4 id="1-1_&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x9700;&#x8981;WebSocket&#x8FD9;&#x6837;&#x7684;&#x5B9E;&#x65F6;&#x7684;&#x901A;&#x4FE1;&#x534F;&#x8BAE;&#xFF1F;">1.1 &#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x9700;&#x8981;WebSocket&#x8FD9;&#x6837;&#x7684;&#x5B9E;&#x65F6;&#x7684;&#x901A;&#x4FE1;&#x534F;&#x8BAE;&#xFF1F;</h4><p>WebSocket&#x662F;web&#x901A;&#x4FE1;&#x65B9;&#x5F0F;&#x7684;&#x4E00;&#x79CD;&#xFF0C;&#x50CF;&#x6211;&#x4EEC;&#x719F;&#x77E5;&#x7684;HTTP&#x534F;&#x8BAE;&#x4E5F;&#x662F;web&#x901A;&#x4FE1;&#x65B9;&#x5F0F;&#x7684;&#x4E00;&#x79CD;&#x3002;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x77E5;&#x9053;HTTP&#x534F;&#x8BAE;&#x662F;&#x4E00;&#x79CD;&#x65E0;&#x72B6;&#x6001;&#x7684;&#x534F;&#x8BAE;&#xFF0C;&#x5176;&#x670D;&#x52A1;&#x7AEF;&#x672C;&#x8EAB;&#x4E0D;&#x5177;&#x5907;&#x8BC6;&#x522B;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x5FC5;&#x987B;&#x501F;&#x52A9;&#x5916;&#x90E8;&#x7684;&#x4E00;&#x4E9B;&#x4FE1;&#x606F;&#x6BD4;&#x5982;&#x8BF4;session&#x548C;cookie&#xFF0C;&#x624D;&#x80FD;&#x4E0E;&#x7279;&#x5B9A;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x4FDD;&#x6301;&#x901A;&#x4FE1;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6211;&#x4EEC;&#x6240;&#x53D1;&#x9001;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;HTTP&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x4F1A;&#x5E26;&#x4E0A;&#x8BF7;&#x6C42;&#x5934;&#x4E2D;&#x4E00;&#x4E9B;&#x76F8;&#x5E94;&#x7684;&#x4FE1;&#x606F;&#x8FD8;&#x6709;cookie&#xFF0C;&#x8FD9;&#x660E;&#x663E;&#x4F1A;&#x589E;&#x52A0;&#x6211;&#x4EEC;&#x4F20;&#x8F93;&#x7684;&#x4FE1;&#x606F;&#x7684;&#x4F53;&#x91CF;&#x4ECE;&#x800C;&#x5E26;&#x6765;&#x4E00;&#x5B9A;&#x7684;&#x7F51;&#x7EDC;&#x5EF6;&#x8FDF;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E9B;&#x5BF9;&#x901A;&#x4FE1;&#x7684;&#x5B9E;&#x65F6;&#x6027;&#x8981;&#x6C42;&#x6BD4;&#x8F83;&#x9AD8;&#x7684;&#x5E94;&#x7528;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#x4E0D;&#x53EF;&#x5FCD;&#x53D7;&#x7684;&#x4E86;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;&#x804A;&#x5929;&#x7A0B;&#x5E8F;&#x6216;&#x8005;&#x662F;&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;&#x5B9E;&#x65F6;&#x5C0F;&#x6E38;&#x620F;&#x3002;&#x6700;&#x90C1;&#x95F7;&#x7684;&#x5374;&#x8FD8;&#x662F;&#x8FD9;&#x4E9B;&#x5934;&#x4FE1;&#x606F;&#x548C;cookie&#x5F80;&#x5F80;&#x5BF9;&#x4E8E;&#x670D;&#x52A1;&#x5668;&#x54CD;&#x5E94;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x6765;&#x8BF4;&#x662F;&#x591A;&#x4F59;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x867D;&#x7136;&#x6211;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x90FD;&#x5E26;&#x4E86;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#xFF0C;&#x4F46;&#x662F;&#x670D;&#x52A1;&#x5668;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4EA4;&#x4E92;&#x8FC7;&#x7A0B;&#x4E2D;&#x53EF;&#x80FD;&#x6839;&#x672C;&#x7528;&#x4E0D;&#x4E0A;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x6539;&#x5584;HTTP&#x8BF7;&#x6C42;&#x7684;&#x8FD9;&#x79CD;&#x7F51;&#x7EDC;&#x5EF6;&#x8FDF;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x4E5F;&#x51FA;&#x73B0;&#x4E86;&#x4E00;&#x4E9B;&#x9002;&#x5E94;&#x4E0D;&#x540C;&#x9700;&#x6C42;&#x7684;&#x5176;&#x4ED6;&#x7684;[web&#x901A;&#x4FE1;]&#x65B9;&#x5F0F;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;&#xFF1A;&#x8F6E;&#x8BE2;&#xFF0C;&#x957F;&#x8F6E;&#x8BE2;( <a href="http://en.wikipedia.org/wiki/Push_technology#Long_polling" target="_blank" rel="external">long-polling</a> )&#xFF0C;&#x6570;&#x636E;&#x6D41;&#xFF0C;EventSouce&#x7B49;&#x7B49;&#xFF0C;WebSocket&#x4FBF;&#x662F;&#x5176;&#x4E2D;&#x4E00;&#x79CD;&#x3002; </p>
<p>&#x5B9E;&#x9645;&#x4E0A;&#x5927;&#x591A;&#x6570;&#x57FA;&#x4E8E;&#x56E0;&#x7279;&#x7F51;&#xFF08;&#x6216;&#x8005;&#x5C40;&#x57DF;&#x7F51;&#xFF09;&#x7684;&#x7F51;&#x7EDC;&#x94FE;&#x63A5;&#x901A;&#x5E38;&#x90FD;&#x5305;&#x542B;&#x957F;&#x8FDE;&#x63A5;&#x548C;&#x57FA;&#x4E8E;TCP&#x5957;&#x63A5;&#x5B57;&#x7684;&#x53CC;&#x5411;&#x6D88;&#x606F;&#x4EA4;&#x6362;&#x3002;&#x4F46;&#x662F;TCP&#x534F;&#x8BAE;&#x662F;&#x5C5E;&#x4E8E;&#x6700;&#x5E95;&#x5C42;&#x7684;&#x7F51;&#x7EDC;&#x901A;&#x4FE1;&#x534F;&#x8BAE;&#x4E86;&#xFF0C;&#x8BA9;&#x4E00;&#x4E9B;&#x4E0D;&#x80FD;&#x4FE1;&#x4EFB;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x811A;&#x672C;&#x53BB;&#x8BBF;&#x95EE;&#x5E95;&#x5C42;&#x7684;TCP&#x5957;&#x63A5;&#x5B57;&#x663E;&#x7136;&#x662F;&#x4E0D;&#x592A;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x56E0;&#x6B64;WebSocket&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x79CD;&#x8F83;&#x4E3A;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x6848;&#xFF0C;&#x5B83;&#x5141;&#x8BB8;&#x5BA2;&#x6237;&#x7AEF;&#x811A;&#x672C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x652F;&#x6301;WebSocket&#x534F;&#x8BAE;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x521B;&#x5EFA;&#x53CC;&#x5411;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x8FDE;&#x63A5;&#x3002;&#x4ECE;&#x800C;&#x4F7F;&#x5B9E;&#x65F6;&#x901A;&#x4FE1;&#x7684;&#x67D0;&#x4E9B;&#x7F51;&#x7EDC;&#x64CD;&#x4F5C;&#x53D8;&#x5F97;&#x7B80;&#x5355;&#x3002;</p>
<h4 id="1-2_WebSocket&#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF1F;">1.2 WebSocket&#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF1F;</h4><p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;WebSocket&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#xFF0C;&#x5141;&#x8BB8;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x5168;&#x53CC;&#x5DE5;&#xFF08;full-duplex&#xFF09;&#x7684;&#x5B9E;&#x65F6;&#x901A;&#x4FE1;&#x3002;&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x4F8B;&#x5B50;&#x7279;&#x522B;&#x597D;&#xFF1A;HTTP&#x534F;&#x8BAE;&#x50CF;&#x53D1;&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#xFF0C;&#x53D1;&#x51FA;&#x540E;&#x5FC5;&#x987B;&#x7B49;&#x5F85;&#x5BF9;&#x65B9;&#x56DE;&#x4FE1;&#xFF1B;WebSocket&#x5219;&#x662F;&#x50CF;&#x6253;&#x7535;&#x8BDD;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x5411;&#x5BF9;&#x65B9;&#x53D1;&#x9001;&#x6570;&#x636E;&#xFF0C;&#x5B83;&#x4EEC;&#x4E4B;&#x95F4;&#x5B58;&#x7740;&#x4E00;&#x6761;&#x6301;&#x7EED;&#x6253;&#x5F00;&#x7684;&#x6570;&#x636E;&#x901A;&#x9053;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;WebSocket&#x534F;&#x8BAE;&#x901A;&#x4FE1;&#x7684;&#x8BF7;&#x6C42;&#x5934;&#x548C;&#x54CD;&#x5E94;&#x5934;(&#x4E0B;&#x9762;&#x7B80;&#x5355;&#x5B9E;&#x4F8B;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x5934;)&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f41b99.png" alt=""></p>
<p>&#x5176;&#x4E2D;&#x4E0E;WebSocket&#x534F;&#x8BAE;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre><code><span class="number">1</span> Upgrade:websocket<span class="subst">-------</span>HTTP1<span class="built_in">.1</span><span class="subst">&amp;</span><span class="variable">#x534F</span>;<span class="subst">&amp;</span><span class="variable">#x8BAE</span>;<span class="subst">&amp;</span><span class="variable">#x89C4</span>;<span class="subst">&amp;</span><span class="variable">#x5B9A</span>;<span class="subst">&amp;</span><span class="variable">#xFF0C</span>;Upgrade<span class="subst">&amp;</span><span class="variable">#x5934</span>;<span class="subst">&amp;</span><span class="variable">#x4FE1</span>;<span class="subst">&amp;</span><span class="variable">#x606F</span>;<span class="subst">&amp;</span><span class="variable">#x8868</span>;<span class="subst">&amp;</span><span class="variable">#x793A</span>;<span class="subst">&amp;</span><span class="variable">#x5C06</span>;<span class="subst">&amp;</span><span class="variable">#x901A</span>;<span class="subst">&amp;</span><span class="variable">#x4FE1</span>;<span class="subst">&amp;</span><span class="variable">#x534F</span>;<span class="subst">&amp;</span><span class="variable">#x8BAE</span>;<span class="subst">&amp;</span><span class="variable">#x4ECE</span>;HTTP/<span class="number">1.1</span><span class="subst">&amp;</span><span class="variable">#x8F6C</span>;<span class="subst">&amp;</span><span class="variable">#x5411</span>;<span class="subst">&amp;</span><span class="variable">#x8BE5</span>;<span class="subst">&amp;</span><span class="variable">#x9879</span>;<span class="subst">&amp;</span><span class="variable">#x6240</span>;<span class="subst">&amp;</span><span class="variable">#x6307</span>;<span class="subst">&amp;</span><span class="variable">#x5B9A</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x534F</span>;<span class="subst">&amp;</span><span class="variable">#x8BAE</span>;<span class="subst">&amp;</span><span class="variable">#xFF1B</span>;
<span class="number">2</span> Connection:Upgrade<span class="subst">------&amp;</span><span class="variable">#x8868</span>;<span class="subst">&amp;</span><span class="variable">#x793A</span>;<span class="subst">&amp;</span><span class="variable">#x6D4F</span>;<span class="subst">&amp;</span><span class="variable">#x89C8</span>;<span class="subst">&amp;</span><span class="variable">#x5668</span>;<span class="subst">&amp;</span><span class="variable">#x901A</span>;<span class="subst">&amp;</span><span class="variable">#x77E5</span>;<span class="subst">&amp;</span><span class="variable">#x670D</span>;<span class="subst">&amp;</span><span class="variable">#x52A1</span>;<span class="subst">&amp;</span><span class="variable">#x5668</span>;<span class="subst">&amp;</span><span class="variable">#xFF0C</span>;<span class="subst">&amp;</span><span class="variable">#x5982</span>;<span class="subst">&amp;</span><span class="variable">#x679C</span>;<span class="subst">&amp;</span><span class="variable">#x5141</span>;<span class="subst">&amp;</span><span class="variable">#x8BB8</span>;<span class="subst">&amp;</span><span class="variable">#xFF0C</span>;<span class="subst">&amp;</span><span class="variable">#x5C31</span>;<span class="subst">&amp;</span><span class="variable">#x5C06</span>;<span class="subst">&amp;</span><span class="variable">#x901A</span>;<span class="subst">&amp;</span><span class="variable">#x4FE1</span>;<span class="subst">&amp;</span><span class="variable">#x534F</span>;<span class="subst">&amp;</span><span class="variable">#x8BAE</span>;<span class="subst">&amp;</span><span class="variable">#x5347</span>;<span class="subst">&amp;</span><span class="variable">#x7EA7</span>;<span class="subst">&amp;</span><span class="variable">#x5230</span>;websocket<span class="subst">&amp;</span><span class="variable">#x534F</span>;<span class="subst">&amp;</span><span class="variable">#x8BAE</span>;<span class="subst">&amp;</span><span class="variable">#xFF1B</span>;
<span class="number">3</span> Origin<span class="subst">------------------&amp;</span><span class="variable">#x7528</span>;<span class="subst">&amp;</span><span class="variable">#x4E8E</span>;<span class="subst">&amp;</span><span class="variable">#x9A8C</span>;<span class="subst">&amp;</span><span class="variable">#x8BC1</span>;<span class="subst">&amp;</span><span class="variable">#x6D4F</span>;<span class="subst">&amp;</span><span class="variable">#x89C8</span>;<span class="subst">&amp;</span><span class="variable">#x5668</span>;<span class="subst">&amp;</span><span class="variable">#x57DF</span>;<span class="subst">&amp;</span><span class="variable">#x540D</span>;<span class="subst">&amp;</span><span class="variable">#x662F</span>;<span class="subst">&amp;</span><span class="variable">#x5426</span>;<span class="subst">&amp;</span><span class="variable">#x5728</span>;<span class="subst">&amp;</span><span class="variable">#x670D</span>;<span class="subst">&amp;</span><span class="variable">#x52A1</span>;<span class="subst">&amp;</span><span class="variable">#x5668</span>;<span class="subst">&amp;</span><span class="variable">#x8BB8</span>;<span class="subst">&amp;</span><span class="variable">#x53EF</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x8303</span>;<span class="subst">&amp;</span><span class="variable">#x56F4</span>;<span class="subst">&amp;</span><span class="variable">#x5185</span>;;
<span class="number">4</span> Sec<span class="attribute">-WebSocket</span><span class="attribute">-Key</span><span class="subst">-------&amp;</span><span class="variable">#x5219</span>;<span class="subst">&amp;</span><span class="variable">#x662F</span>;<span class="subst">&amp;</span><span class="variable">#x7528</span>;<span class="subst">&amp;</span><span class="variable">#x4E8E</span>;<span class="subst">&amp;</span><span class="variable">#x63E1</span>;<span class="subst">&amp;</span><span class="variable">#x624B</span>;<span class="subst">&amp;</span><span class="variable">#x534F</span>;<span class="subst">&amp;</span><span class="variable">#x8BAE</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x5BC6</span>;<span class="subst">&amp;</span><span class="variable">#x94A5</span>;<span class="subst">&amp;</span><span class="variable">#xFF0C</span>;<span class="subst">&amp;</span><span class="variable">#x662F</span>;base64<span class="subst">&amp;</span><span class="variable">#x7F16</span>;<span class="subst">&amp;</span><span class="variable">#x7801</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="number">16</span><span class="subst">&amp;</span><span class="variable">#x5B57</span>;<span class="subst">&amp;</span><span class="variable">#x8282</span>;<span class="subst">&amp;</span><span class="variable">#x968F</span>;<span class="subst">&amp;</span><span class="variable">#x673A</span>;<span class="subst">&amp;</span><span class="variable">#x5B57</span>;<span class="subst">&amp;</span><span class="variable">#x7B26</span>;<span class="subst">&amp;</span><span class="variable">#x4E32</span>;;  
</code></pre><p>5 Sec-WebSocket-Accept——&#x662F;&#x670D;&#x52A1;&#x5668;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x63D0;&#x4F9B;&#x7684;Sec-WebSocket-Key&#x5B57;&#x7B26;&#x4E32;&#x540E;&#x9762;&#xFF0C;&#x6DFB;&#x52A0;&#x201C;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x201D; &#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x53D6;sha-1&#x7684;hash&#x503C;&#x3002;&#x6D4F;&#x89C8;&#x5668;&#x5C06;&#x5BF9;&#x8FD9;&#x4E2A;&#x503C;&#x8FDB;&#x884C;&#x9A8C;&#x8BC1;&#xFF0C;&#x4EE5;&#x8BC1;&#x660E;&#x786E;&#x5B9E;&#x662F;&#x76EE;&#x6807;&#x670D;&#x52A1;&#x5668;&#x56DE;&#x5E94;&#x4E86;webSocket&#x8BF7;&#x6C42;&#xFF1B;<br>6.Sec-WebSocket-Location—&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x8FD8;&#x6709;&#x8FD9;&#x4E2A;&#x54CD;&#x5E94;&#x6D88;&#x606F;&#x5934;&#x7528;&#x6765;&#x8868;&#x793A;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x7684;WebSocket&#x7F51;&#x5740;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x53EF;&#x80FD;&#x662F;&#x56E0;&#x4E3A;&#x6211;&#x4F8B;&#x5B50;&#x4E2D;&#x8BBE;&#x7F6E;&#x4E86;127.0.0.1&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x4FE1;&#x606F;&#x7701;&#x7565;&#x6389;&#x4E86;&#x3002;</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;WebSocket&#x63E1;&#x624B;&#x7684;&#x8FC7;&#x7A0B;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;WebSocket&#x8FDE;&#x63A5;&#x3002;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x770B;&#x8D77;&#x6765;&#x662F;&#x8FD9;&#x4E2A;&#x6837;&#x5B50;&#x7684;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f41e0a.png" alt=""></p>
<p>&#x5B8C;&#x6210;&#x63E1;&#x624B;&#x4EE5;&#x540E;&#xFF0C;WebSocket&#x534F;&#x8BAE;&#x5C31;&#x5728;TCP&#x534F;&#x8BAE;&#x4E4B;&#x4E0A;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x4F20;&#x9001;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>websocket&#x534F;&#x8BAE;&#x7528;ws&#x8868;&#x793A;&#xFF0C;&#x52A0;&#x5BC6;&#x7684;websocket&#x534F;&#x8BAE;&#x7528;wss&#x534F;&#x8BAE;&#xFF0C;&#x5C31;&#x50CF;&#x666E;&#x901A;&#x7684;HTTP&#x534F;&#x8BAE;&#x7528;http&#x8868;&#x793A;&#xFF0C;&#x52A0;&#x5BC6;&#x7684;HTTP&#x534F;&#x8BAE;&#x7528;https&#x8868;&#x793A;&#x4E00;&#x6837;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x5B9E;&#x4F8B;&#x770B;&#x4E00;&#x4E0B;websocket&#x7684;&#x4E0D;&#x540C;&#x5B9E;&#x73B0;&#x662F;&#x5982;&#x4F55;&#x5E94;&#x7528;&#x7684;&#x3002;</p>
<h3 id="&#x4E8C;&#x3001;&#xA0;&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;WebSocket&#x5BA2;&#x6237;&#x7AEF;+&#x4F7F;&#x7528;ws&#x6A21;&#x5757;&#x642D;&#x5EFA;&#x7684;&#x7B80;&#x5355;&#x670D;&#x52A1;&#x5668;">&#x4E8C;&#x3001;&#xA0;&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;WebSocket&#x5BA2;&#x6237;&#x7AEF;+&#x4F7F;&#x7528;ws&#x6A21;&#x5757;&#x642D;&#x5EFA;&#x7684;&#x7B80;&#x5355;&#x670D;&#x52A1;&#x5668;</h3><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8DD1;&#x8D77;&#x6765;&#x8FD9;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x4F8B;&#x770B;&#x4E00;&#x4E0B;&#x5982;&#x4F55;&#x7F16;&#x5199;&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;WebSocket&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5E76;&#x4E14;&#x770B;&#x5B83;&#x662F;&#x600E;&#x6837;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4EA4;&#x4E92;&#x7684;&#x3002;</p>
<h4 id="2-1_&#x8FD0;&#x884C;&#x5B9E;&#x4F8B;">2.1 &#x8FD0;&#x884C;&#x5B9E;&#x4F8B;</h4><p>&#x6211;&#x4EEC;&#x628A;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x548C;&#x670D;&#x52A1;&#x7AEF;&#x4EE3;&#x7801;&#x51C6;&#x5907;&#x597D;&#xFF0C;&#x7136;&#x540E;&#x542F;&#x52A8;&#x670D;&#x52A1;&#x5668;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;8080&#xFF0C;&#x518D;&#x7136;&#x540E;&#x8FD0;&#x884C;&#x6211;&#x4EEC;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x5373;&#x53EF;&#x770B;&#x5230;&#x6548;&#x679C;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x5199;&#x5728;html&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f4207b.gif" alt=""></p>
<pre><code> <span class="number">1</span> var onOpen = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
 <span class="number">2</span>                 console.<span class="built_in">log</span><span class="params">(&amp;quot;Socket opened.&amp;quot;)</span>;
 <span class="number">3</span>                 socket.send<span class="params">(&amp;quot;Hi, Server!&amp;quot;)</span>;
 <span class="number">4</span>             },
 <span class="number">5</span>             onClose = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
 <span class="number">6</span>                 console.<span class="built_in">log</span><span class="params">(&amp;quot;Socket closed.&amp;quot;)</span>;
 <span class="number">7</span>             },
 <span class="number">8</span> 
 <span class="number">9</span> 
<span class="number">10</span>             onMessage = <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
<span class="number">11</span>                 console.<span class="built_in">log</span><span class="params">(&amp;quot;We get signal:&amp;quot;)</span>;
<span class="number">12</span>                 console.<span class="built_in">log</span><span class="params">(data)</span>;
<span class="number">13</span>             },
<span class="number">14</span> 
<span class="number">15</span> 
<span class="number">16</span>             onError = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
<span class="number">17</span>                 console.<span class="built_in">log</span><span class="params">(&amp;quot;We got an error.&amp;quot;)</span>;
<span class="number">18</span>             },
<span class="number">19</span> 
<span class="number">20</span>             
<span class="number">21</span>             socket = new WebSocket<span class="params">(&amp;quot;ws://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/&amp;quot;)</span>;
<span class="number">22</span> 
<span class="number">23</span>         socket.onopen = onOpen;
<span class="number">24</span>         socket.onclose = onClose;
<span class="number">25</span>         socket.onerror = onError;
<span class="number">26</span>         socket.onmessage = onMessage;
</code></pre><p> View Code</p>
<p>[ <a href="https://github.com/zhangmengxue/Node-KOA/blob/master/websocket/simpleclient.html" target="_blank" rel="external">&#x67E5;&#x770B;&#x6E90;&#x7801;</a> ] </p>
<p>&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x5B83;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x5E76;&#x4E14;&#x76D1;&#x542C;open&#x548C;messege&#x7B49;&#x4E8B;&#x4EF6;&#xFF0C;&#x4E0E;&#x6B64;&#x540C;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x5F97;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7684;&#x54CD;&#x5E94;&#x3002;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;js&#x4EE3;&#x7801;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f4255d.gif" alt=""></p>
<pre><code> <span class="number">1</span> <span class="keyword">var</span> WebSocketServer = <span class="built_in">require</span>(&amp;apos;ws&amp;apos;).Server;
 <span class="number">2</span> <span class="keyword">var</span> wss = <span class="keyword">new</span> WebSocketServer({ port: <span class="number">8080</span> });
 <span class="number">3</span> 
 <span class="number">4</span> wss.on(&amp;apos;connection&amp;apos;, <span class="function"><span class="keyword">function</span> <span class="title">connection</span>(<span class="params">ws</span>) </span>{
 <span class="number">5</span>   ws.on(&amp;apos;message&amp;apos;, <span class="function"><span class="keyword">function</span> <span class="title">incoming</span>(<span class="params">message</span>) </span>{
 <span class="number">6</span>     <span class="built_in">console</span>.log(&amp;apos;received: %s&amp;apos;, message);
 <span class="number">7</span>   });
 <span class="number">8</span> 
 <span class="number">9</span>   ws.send(&amp;apos;something&amp;apos;);
<span class="number">10</span> });
</code></pre><p> View Code</p>
<p>[ <a href="https://github.com/zhangmengxue/Node-KOA/blob/master/websocket/simpleWSserver.js" target="_blank" rel="external">&#x67E5;&#x770B;&#x6E90;&#x7801;</a> ] </p>
<p>&#x8FD9;&#x4E2A;&#x7B80;&#x5355;&#x7684;websocket&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x4E86;[ <a href="https://github.com/websockets/ws" target="_blank" rel="external">ws&#x6A21;&#x5757;</a> ]&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B89;&#x88C5;&#x8FC7;&#xFF0C;&#x8981;&#x5148;&#x5B89;&#x88C5;&#x4E00;&#x4E0B;&#xFF1A; </p>
<pre><code><span class="number">1</span> sudo npm <span class="keyword">install</span> ws
</code></pre><p>&#x7136;&#x540E;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x6267;&#x884C;&#xFF1A;</p>
<pre><code>1 <span class="tag">node</span> <span class="tag">simpleWSserver</span><span class="class">.js</span>
</code></pre><p>&#x6211;&#x4EEC;&#x7684;&#x670D;&#x52A1;&#x5668;&#x542F;&#x52A8;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x8FD0;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF1A;</p>
<p>&#x6D4F;&#x89C8;&#x5668;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f4255d.jpg" alt=""></p>
<p>&#x547D;&#x4EE4;&#x884C;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f42cb0.jpg" alt=""></p>
<p>&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x770B;&#x8D77;&#x6765;&#x662F;&#x8FD9;&#x4E2A;&#x6837;&#x5B50;&#x7684;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f42cb0.jpg" alt=""></p>
<h4 id="2-2_&#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;websocket&#x5BA2;&#x6237;&#x7AEF;">2.2 &#x8FD0;&#x884C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;websocket&#x5BA2;&#x6237;&#x7AEF;</h4><p>&#x6211;&#x4EEC;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x7684;websocket&#x4E3B;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x65E0;&#x975E;&#x662F;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#xFF1A;</p>
<pre><code>1 &amp;<span class="id">#x5EFA</span>;&amp;<span class="id">#x7ACB</span>;&amp;<span class="id">#x8FDE</span>;&amp;<span class="id">#x63A5</span>;&amp;<span class="id">#x548C</span>;&amp;<span class="id">#x5173</span>;&amp;<span class="id">#x95ED</span>;&amp;<span class="id">#x8FDE</span>;&amp;<span class="id">#x63A5</span>; 
2 &amp;<span class="id">#x53D1</span>;&amp;<span class="id">#x9001</span>;&amp;<span class="id">#x6570</span>;&amp;<span class="id">#x636E</span>;&amp;<span class="id">#x548C</span>;&amp;<span class="id">#x63A5</span>;&amp;<span class="id">#x6536</span>;&amp;<span class="id">#x6570</span>;&amp;<span class="id">#x636E</span>;
3 &amp;<span class="id">#x5904</span>;&amp;<span class="id">#x7406</span>;&amp;<span class="id">#x9519</span>;&amp;<span class="id">#x8BEF</span>;
</code></pre><p>&#x5BF9;&#x5E94;&#x7684;&#x4F1A;&#x89E6;&#x53D1;&#x4EE5;&#x4E0B;&#x7684;&#x4E8B;&#x4EF6;&#xFF1A;</p>
<pre><code>1 onopen
2 onmessage
3 onclose
4 onerror
</code></pre><p>2.2.1 &#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x548C;&#x5173;&#x95ED;&#x8FDE;&#x63A5;</p>
<p>&#x901A;&#x5E38;&#x6211;&#x4EEC;&#x65B0;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;WebSocket&#x7684;&#x5B9E;&#x4F8B;&#x5C31;&#x53EF;&#x4EE5;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#xFF1A;</p>
<pre><code><span class="number">1</span> <span class="keyword">if</span>(<span class="built_in">window</span>.WebSocket != <span class="literal">undefined</span>) {
<span class="number">2</span>     <span class="keyword">var</span> socket = <span class="keyword">new</span> WebSocket(&amp;quot;ws:<span class="comment">//127.0.0.1:8080/&amp;quot;);</span>
<span class="number">3</span> }
</code></pre><p>&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x4E4B;&#x540E;&#x7684;WebSocket&#x5B9E;&#x4F8B;&#x6709;&#x4E00;&#x4E2A;readyState&#x5C5E;&#x6027;&#xFF0C;&#x7528;&#x6765;&#x6807;&#x8BC6;&#x5F53;&#x524D;&#x7684;&#x72B6;&#x6001;&#xFF1A;</p>
<pre><code>0<span class="tag">-</span>&amp;<span class="id">#x6B63</span>;&amp;<span class="id">#x5728</span>;&amp;<span class="id">#x8FDE</span>;&amp;<span class="id">#x63A5</span>;
1<span class="tag">-</span>&amp;<span class="id">#x8FDE</span>;&amp;<span class="id">#x63A5</span>;&amp;<span class="id">#x6210</span>;&amp;<span class="id">#x529F</span>;
2<span class="tag">-</span>&amp;<span class="id">#x6B63</span>;&amp;<span class="id">#x5728</span>;&amp;<span class="id">#x5173</span>;&amp;<span class="id">#x95ED</span>;
3<span class="tag">-</span>&amp;<span class="id">#x5173</span>;&amp;<span class="id">#x95ED</span>;&amp;<span class="id">#x6210</span>;&amp;<span class="id">#x529F</span>;
</code></pre><p>&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x540E;&#x4F1A;&#x89E6;&#x53D1;onopen&#x4E8B;&#x4EF6;&#xFF0C;&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x6570;&#x636E;&#x4E86;&#xFF1A;</p>
<pre><code><span class="number">1</span> var onOpen = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
<span class="number">2</span>       console.<span class="built_in">log</span><span class="params">(&amp;quot;Socket opened.&amp;quot;)</span>;
<span class="number">3</span>       socket.send<span class="params">(&amp;quot;Hi, Server!&amp;quot;)</span>;
<span class="number">4</span>  }
<span class="number">5</span> socket.onopen = onOpen;
</code></pre><p>&#x8981;&#x662F;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x7684;&#x8BDD;&#x5C31;&#x4F1A;&#x51FA;&#x53D1;onclose&#x4E8B;&#x4EF6;&#xFF1A;</p>
<pre><code>1 var onClose = function() {
2         console.log(&amp;quot;Socket <span class="keyword">closed</span>.&amp;quot;);
3   }
4 socket.onclose = onClose;
</code></pre><p>2.2.2 &#x53D1;&#x9001;&#x6570;&#x636E;&#x548C;&#x63A5;&#x6536;&#x6570;&#x636E;</p>
<p>&#x5728;&#x8FDE;&#x63A5;&#x5EFA;&#x7ACB;&#x6210;&#x529F;&#x540E;&#x89E6;&#x53D1;&#x7684;onopen&#x4E8B;&#x4EF6;&#x4E2D;&#x6211;&#x4EEC;&#x901A;&#x8FC7;send()&#x65B9;&#x6CD5;&#x53D1;&#x9001;&#x6570;&#x636E;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#xFF1A;</p>
<pre><code><span class="number">1</span> <span class="keyword">socket</span>.<span class="keyword">send</span>(&amp;quot;Hi, Server!&amp;quot;);
</code></pre><p>&#x9664;&#x4E86;&#x53D1;&#x9001;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; Blob &#x6216; ArrayBuffer &#x5BF9;&#x8C61;&#x53D1;&#x9001;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x636E;&#x3002;&#x4E0D;&#x4EC5;&#x5982;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5;&#x53D1;&#x9001;JSON&#x6570;&#x636E;&#xFF1A;</p>
<pre><code> <span class="number">1</span>  <span class="keyword">var</span> onOpen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
 <span class="number">2</span>       <span class="keyword">var</span> msg = {
 <span class="number">3</span>          type: &amp;quot;message&amp;quot;,
 <span class="number">4</span>          text: &amp;quot;something&amp;quot;,
 <span class="number">5</span>          id:   &amp;quot;number&amp;quot;,
 <span class="number">6</span>          date: <span class="built_in">Date</span>.now()
 <span class="number">7</span>       };
 <span class="number">8</span> 
 <span class="number">9</span>    <span class="comment">// Send the msg object as a JSON-formatted string.</span>
<span class="number">10</span>    socket.send(<span class="built_in">JSON</span>.stringify(msg));
<span class="number">11</span>   }
<span class="number">12</span>  socket.onopen = onOpen;
</code></pre><p>&#x8FD9;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;message&#x4E8B;&#x4EF6;&#xFF1A;</p>
<pre><code><span class="number">1</span> ws.<span class="keyword">on</span>(&amp;apos;<span class="keyword">message</span>&amp;apos;, <span class="function"><span class="keyword">function</span> <span class="title">incoming</span><span class="params">(<span class="keyword">message</span>)</span> <span class="comment">{
2     console.log(&amp;apos;received: %s&amp;apos;, message);
3   }</span>);</span>
</code></pre><p>&#x540C;&#x65F6;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x53D1;&#x6765;&#x4FE1;&#x606F;&#x7684;&#x65F6;&#x5019;&#xFF1A;</p>
<pre><code><span class="function">1 ws.<span class="title">send</span><span class="params">(&amp;apos;something&amp;apos;)</span></span>;
</code></pre><p>&#x4E5F;&#x4F1A;&#x89E6;&#x53D1;&#x5BA2;&#x6237;&#x7AEF;&#x7684;onmessage&#x4E8B;&#x4EF6;&#xFF1A;</p>
<pre><code><span class="number">1</span> var onMessage = <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
<span class="number">2</span>         console.<span class="built_in">log</span><span class="params">(&amp;quot;We get signal:&amp;quot;)</span>;
<span class="number">3</span>         console.<span class="built_in">log</span><span class="params">(data)</span>;
<span class="number">4</span>   }
<span class="number">5</span> socket.onmessage = onMessage;
</code></pre><p>2.2.3 &#x5904;&#x7406;&#x9519;&#x8BEF;</p>
<p>&#x53D1;&#x751F;&#x7684;&#x9519;&#x8BEF;&#x4F1A;&#x89E6;&#x53D1;onerror&#x4E8B;&#x4EF6;&#xFF1A;</p>
<pre><code><span class="number">1</span> <span class="keyword">var</span> onError = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="comment">{
2      console.log(&amp;quot;We got an error.&amp;quot;);
3  }</span>
4 <span class="title">socket</span>.<span class="title">onerror</span> = <span class="title">onError</span>;</span>
</code></pre><h3 id="&#x4E09;&#x3001;Node&#x4E2D;&#x7684;WebSocket">&#x4E09;&#x3001;Node&#x4E2D;&#x7684;WebSocket</h3><p>WebSocket&#x5728;Node&#x4E2D;&#x7684;&#x5B9E;&#x73B0;[ <a href="https://github.com/theturtle32/WebSocket-Node" target="_blank" rel="external">WebSocket-Node</a> ]&#x4F7F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;Nodejs&#x4E2D;&#x4F7F;&#x7528;websokcet&#x5F00;&#x53D1;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5B9E;&#x65F6;&#x4EA4;&#x4E92;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x65F6;&#x4EA4;&#x6362;&#x968F;&#x673A;&#x6570;&#x7684;&#x4F8B;&#x5B50;&#x770B;&#x770B;&#x5B83;&#x662F;&#x600E;&#x4E48;&#x5DE5;&#x4F5C;&#x7684;&#xFF1A; </p>
<p>&#x542F;&#x52A8;&#x670D;&#x52A1;&#x5668;&#xFF1A;</p>
<pre><code><span class="tag">node</span> <span class="tag">socketserver</span><span class="class">.js</span>
</code></pre><p>[ <a href="https://github.com/zhangmengxue/Node-KOA/blob/master/websocket/socketserver.js" target="_blank" rel="external">&#x67E5;&#x770B;&#x6E90;&#x7801;</a> ] </p>
<p>&#x542F;&#x52A8;&#x5BA2;&#x6237;&#x7AEF;&#xFF1A;</p>
<pre><code><span class="tag">node</span> <span class="tag">socketclient</span><span class="class">.js</span>
</code></pre><p>[ <a href="https://github.com/zhangmengxue/Node-KOA/blob/master/websocket/socketclient.js" target="_blank" rel="external">&#x67E5;&#x770B;&#x6E90;&#x7801;</a> ] </p>
<p><img src="http://taojinke.github.io/img/20150703/2f42f21.jpg" alt=""></p>
<p><img src="http://taojinke.github.io/img/20150703/2f43192.jpg" alt=""></p>
<h3 id="&#x56DB;&#x3001;socket-io">&#x56DB;&#x3001;socket.io</h3><p>&#x73B0;&#x5728;&#x5F88;&#x6D41;&#x884C;&#x7684;websocket&#x7684;&#x5B9E;&#x73B0;socket.io&#x540C;&#x6837;&#x5305;&#x62EC;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4E24;&#x90E8;&#x5206;&#x3002;&#x5B83;&#x4E0D;&#x4EC5;&#x7B80;&#x5316;&#x4E86;&#x63A5;&#x53E3;&#xFF0C;&#x4F7F;&#x5F97;&#x64CD;&#x4F5C;&#x66F4;&#x5BB9;&#x6613;&#xFF0C;&#x800C;&#x4E14;&#x5BF9;&#x4E8E;&#x90A3;&#x4E9B;&#x4E0D;&#x652F;&#x6301;WebSocket&#x7684;&#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x4F1A;&#x81EA;&#x52A8;&#x964D;&#x4E3A;Ajax&#x8FDE;&#x63A5;&#xFF0C;&#x6700;&#x5927;&#x9650;&#x5EA6;&#x5730;&#x4FDD;&#x8BC1;&#x4E86;&#x517C;&#x5BB9;&#x6027;&#x3002;&#x5B83;&#x7684;&#x76EE;&#x6807;&#x662F;&#x7EDF;&#x4E00;&#x901A;&#x4FE1;&#x673A;&#x5236;&#xFF0C;&#x4F7F;&#x5F97;&#x6240;&#x6709;&#x6D4F;&#x89C8;&#x5668;&#x548C;&#x79FB;&#x52A8;&#x8BBE;&#x5907;&#x90FD;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x5B9E;&#x65F6;&#x901A;&#x4FE1;&#x3002;</p>
<h4 id="4-1&#xA0;socket-io&#x4E0E;WebSocket&#x7684;&#x533A;&#x522B;&#x5728;&#x54EA;&#x91CC;&#x5462;&#xFF1F;&#xA0;">4.1&#xA0;socket.io&#x4E0E;WebSocket&#x7684;&#x533A;&#x522B;&#x5728;&#x54EA;&#x91CC;&#x5462;&#xFF1F;&#xA0;</h4><p>websocket&#x662F;&#x6D4F;&#x89C8;&#x5668;&#x5BF9;&#x8C61;&#xFF0C;websocket api&#x662F;&#x6D4F;&#x89C8;&#x5668;&#x63D0;&#x4F9B;&#x7ED9;&#x6211;&#x4EEC;&#x7684;&#x7528;&#x4E8E;&#x6D4F;&#x89C8;&#x5668;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5B9E;&#x65F6;&#x901A;&#x4FE1;&#x7684;&#x63A5;&#x53E3;&#x3002;</p>
<p>websocket&#x5728;node&#x4E2D;&#x7684;&#x5B9E;&#x73B0;&#x4F7F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F00;&#x53D1;&#x670D;&#x52A1;&#x7AEF;&#x7A0B;&#x5E8F;&#x65F6;&#x4F7F;&#x7528;websocket&#x7684;&#x7279;&#x6027;&#x3002;</p>
<p>&#x5728;&#x6211;&#x4EEC;&#x4F7F;&#x7528;websocket&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x662F;&#x6D4F;&#x89C8;&#x5668;&#x63D0;&#x4F9B;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x4E9B;&#x517C;&#x5BB9;&#x6027;&#x548C;&#x652F;&#x6301;&#x6027;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5BF9;&#x7A0B;&#x5E8F;&#x6240;&#x8FD0;&#x884C;&#x7684;&#x73AF;&#x5883;&#x6216;&#x5C40;&#x9650;&#x4E0D;&#x662F;&#x90A3;&#x4E48;&#x4E86;&#x89E3;&#x7684;&#x5316;&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF1A;</p>
<p>[ <a href="http://stackoverflow.com/questions/10112178/differences-between-socket-io-and-websockets" target="_blank" rel="external">Differences between socket.io and websocket</a> ] &#x3002;&#x800C;socket.io&#x5219;&#x662F;&#x8FDB;&#x5316;&#x4E86;&#x7684;websocket api&#x3002;socket.io&#x5EFA;&#x7ACB;&#x5728;websocket&#x4E4B;&#x4E0A;&#xFF0C;&#x5B83;&#x5728;&#x5408;&#x9002;&#x7684;&#x65F6;&#x5019;&#x4F7F;&#x7528;websocket&#x3002; </p>
<h4 id="4-2_socket-io&#x5B9E;&#x73B0;&#x804A;&#x5929;&#x5BA4;">4.2 socket.io&#x5B9E;&#x73B0;&#x804A;&#x5929;&#x5BA4;</h4><p>&#x4F7F;&#x7528;websocket&#x6216;socket.io&#x53EF;&#x4EE5;&#x4ECE;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x804A;&#x5929;&#x5BA4;&#x7A0B;&#x5E8F;&#x5F00;&#x59CB;&#x3002;&#x5BF9;&#x4E8E;socket.io&#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x975E;&#x5E38;&#x5BB9;&#x6613;&#x3002;</p>
<p>&#x57FA;&#x4E8E; <a href="https://nodejs.org/" target="_blank" rel="external">node</a> &#xFF0C;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;express&#x548C;socket.io&#xFF1A; </p>
<pre><code>1 npm <span class="operator"><span class="keyword">install</span> <span class="comment">--save express@4.10.2</span>
<span class="number">2</span> npm <span class="keyword">install</span> <span class="comment">--save socket.io</span></span>
</code></pre><p>&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x5199;&#x804A;&#x5929;&#x7A0B;&#x5E8F;&#x4E86;&#x3002;&#x5B83;&#x9700;&#x8981;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x804A;&#x5929;&#x7A97;&#x53E3;&#x548C;&#x4E00;&#x4E2A;&#x7528;&#x6765;&#x63A5;&#x6536;&#x6D88;&#x606F;&#x548C;&#x5206;&#x53D1;&#x6D88;&#x606F;&#x7684;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E09;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x5206;&#x522B;&#x65B0;&#x5EFA;&#xFF1A;package.json,index.js,index.html.</p>
<p>package.json:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f43192.gif" alt=""></p>
<pre><code><span class="number">1</span> {
<span class="number">2</span>   &amp;quot;<span class="property">name</span>&amp;quot;: &amp;quot;chat-<span class="type">application</span>&amp;quot;,
<span class="number">3</span>   &amp;quot;<span class="property">version</span>&amp;quot;: &amp;quot;<span class="number">0.0</span>.1&amp;quot;,
<span class="number">4</span>   &amp;quot;description&amp;quot;: &amp;quot;<span class="keyword">my</span> <span class="keyword">first</span> socket.io app&amp;quot;,
<span class="number">5</span>   &amp;quot;dependencies&amp;quot;: {
<span class="number">6</span>     &amp;quot;socket.io&amp;quot;: &amp;quot;^<span class="number">1.3</span>.5&amp;quot;
<span class="number">7</span>   }
<span class="number">8</span> }
</code></pre><p> View Code</p>
<p>index.js:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f43403.gif" alt=""></p>
<pre><code><span class="xml"> 1 var app = require(&amp;apos;express&amp;apos;)();
 2 var http = require(&amp;apos;http&amp;apos;).Server(app);
 3 var io = require(&amp;apos;socket.io&amp;apos;)(http);
 4 
 5 app.get(&amp;apos;/&amp;apos;, function(req, res)</span><span class="expression">{
 6   <span class="variable">res.sendfile</span>(&amp;<span class="variable">apos</span>;<span class="variable">index.html</span>&amp;<span class="variable">apos</span>;);
 7 }</span><span class="xml">);
 8 
 9 io.on(&amp;apos;connection&amp;apos;, function(socket)</span><span class="expression">{
10   <span class="variable">console.log</span>(&amp;<span class="variable">apos</span>;<span class="variable">a</span> <span class="variable">user</span> <span class="variable">connected</span>&amp;<span class="variable">apos</span>;);
11   //&amp;<span class="begin-block">#x</span>76<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>542<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">BA</span>2;&amp;<span class="begin-block">#x</span>6237;&amp;<span class="begin-block">#x</span>7<span class="variable">AEF</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">D</span>88;&amp;<span class="begin-block">#x</span>606<span class="variable">F</span>;
12   <span class="variable">socket.on</span>(&amp;<span class="variable">apos</span>;<span class="variable">chat</span> <span class="variable">message</span>&amp;<span class="variable">apos</span>;, <span class="variable">function</span>(<span class="variable">msg</span>){
13       //&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>6<span class="variable">D</span>88;&amp;<span class="begin-block">#x</span>606<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EBA</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5305;&amp;<span class="begin-block">#x</span>62<span class="variable">EC</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>8005;
14     <span class="variable">io.emit</span>(&amp;<span class="variable">apos</span>;<span class="variable">chat</span> <span class="variable">message</span>&amp;<span class="variable">apos</span>;, <span class="variable">msg</span>);
15   }</span><span class="xml">);
16   socket.on(&amp;apos;disconnect&amp;apos;, function()</span><span class="expression">{
17     <span class="variable">console.log</span>(&amp;<span class="variable">apos</span>;<span class="variable">user</span> <span class="variable">disconnected</span>&amp;<span class="variable">apos</span>;);
18   }</span><span class="xml">);
19 });
20 
21 http.listen(3000, function()</span><span class="expression">{
22   <span class="variable">console.log</span>(&amp;<span class="variable">apos</span>;<span class="variable">listening</span> <span class="variable">on</span> *:3000&amp;<span class="variable">apos</span>;);
23 }</span><span class="xml">);</span>
</code></pre><p> View Code</p>
<p>index.html:</p>
<p><img src="http://taojinke.github.io/img/20150703/2f43674.gif" alt=""></p>
<pre><code> <span class="number">1</span> <span class="subst">&amp;</span><span class="literal">lt</span>;<span class="subst">!</span>doctype html<span class="subst">&amp;</span><span class="literal">gt</span>;
 <span class="number">2</span> <span class="subst">&amp;</span><span class="literal">lt</span>;html<span class="subst">&amp;</span><span class="literal">gt</span>;
 <span class="number">3</span>   <span class="subst">&amp;</span><span class="literal">lt</span>;head<span class="subst">&amp;</span><span class="literal">gt</span>;
 <span class="number">4</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;title<span class="subst">&amp;</span><span class="literal">gt</span>;Socket<span class="built_in">.</span>IO chat<span class="subst">&amp;</span><span class="literal">lt</span>;/title<span class="subst">&amp;</span><span class="literal">gt</span>;
 <span class="number">5</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;style<span class="subst">&amp;</span><span class="literal">gt</span>;
 <span class="number">6</span>       <span class="subst">*</span> { margin: <span class="number">0</span>; padding: <span class="number">0</span>; box<span class="attribute">-sizing</span>: border<span class="attribute">-box</span>; }
 <span class="number">7</span>       body { font: <span class="number">13</span>px Helvetica, Arial; }
 <span class="number">8</span>       form { background: <span class="variable">#000</span>; padding: <span class="number">3</span>px; position: fixed; bottom: <span class="number">0</span>; width: <span class="number">100</span><span class="subst">%</span>; }
 <span class="number">9</span>       form input { border: <span class="number">0</span>; padding: <span class="number">10</span>px; width: <span class="number">90</span><span class="subst">%</span>; margin<span class="attribute">-right</span>: <span class="built_in">.</span><span class="number">5</span><span class="subst">%</span>; }
<span class="number">10</span>       form button { width: <span class="number">9</span><span class="subst">%</span>; background: rgb(<span class="number">130</span>, <span class="number">224</span>, <span class="number">255</span>); border: <span class="literal">none</span>; padding: <span class="number">10</span>px; }
<span class="number">11</span>       <span class="variable">#messages</span> { <span class="built_in">list</span><span class="attribute">-style</span><span class="attribute">-type</span>: <span class="literal">none</span>; margin: <span class="number">0</span>; padding: <span class="number">0</span>; }
<span class="number">12</span>       <span class="variable">#messages</span> li { padding: <span class="number">5</span>px <span class="number">10</span>px; }
<span class="number">13</span>       <span class="variable">#messages</span> li:nth<span class="attribute">-child</span>(odd) { background: <span class="variable">#eee</span>; }
<span class="number">14</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;/style<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">15</span>   <span class="subst">&amp;</span><span class="literal">lt</span>;/head<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">16</span>   <span class="subst">&amp;</span><span class="literal">lt</span>;body<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">17</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;ul id<span class="subst">=&amp;</span>quot;messages<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;<span class="subst">&amp;</span><span class="literal">lt</span>;/ul<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">18</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;form action<span class="subst">=&amp;</span>quot;<span class="subst">&amp;</span>quot;<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">19</span>       <span class="subst">&amp;</span><span class="literal">lt</span>;input id<span class="subst">=&amp;</span>quot;m<span class="subst">&amp;</span>quot; autocomplete<span class="subst">=&amp;</span>quot;off<span class="subst">&amp;</span>quot; <span class="subst">/</span><span class="subst">&amp;</span><span class="literal">gt</span>;<span class="subst">&amp;</span><span class="literal">lt</span>;button<span class="subst">&amp;</span><span class="literal">gt</span>;Send<span class="subst">&amp;</span><span class="literal">lt</span>;/button<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">20</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;/form<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">21</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;script src<span class="subst">=&amp;</span>quot;https:<span class="comment">//cdn.socket.io/socket.io-1.2.0.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;</span>
<span class="number">22</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;script src<span class="subst">=&amp;</span>quot;http:<span class="comment">//code.jquery.com/jquery-1.11.1.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;</span>
<span class="number">23</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;script<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">24</span>       <span class="built_in">var</span> socket <span class="subst">=</span> io();
<span class="number">25</span>       $(<span class="subst">&amp;</span>apos;form<span class="subst">&amp;</span>apos;)<span class="built_in">.</span>submit(function(){
<span class="number">26</span>         <span class="comment">//io.emit&amp;#x63D0;&amp;#x4F9B;&amp;#x7ED9;&amp;#x6211;&amp;#x4EEC;&amp;#x53EF;&amp;#x4EE5;&amp;#x53D1;&amp;#x9001;&amp;#x7ED9;&amp;#x6240;&amp;#x6709;&amp;#x4EBA;&amp;#x7684;&amp;#x4E8B;&amp;#x4EF6;io.emit(&amp;apos;some event&amp;apos;, { for: &amp;apos;everyone&amp;apos; });</span>
<span class="number">27</span>         socket<span class="built_in">.</span>emit(<span class="subst">&amp;</span>apos;chat message<span class="subst">&amp;</span>apos;, $(<span class="subst">&amp;</span>apos;<span class="variable">#m</span><span class="subst">&amp;</span>apos;)<span class="built_in">.</span>val());
<span class="number">28</span>         $(<span class="subst">&amp;</span>apos;<span class="variable">#m</span><span class="subst">&amp;</span>apos;)<span class="built_in">.</span>val(<span class="subst">&amp;</span>apos;<span class="subst">&amp;</span>apos;);
<span class="number">29</span>         <span class="keyword">return</span> <span class="literal">false</span>;
<span class="number">30</span>       });
<span class="number">31</span>       socket<span class="built_in">.</span><span class="keyword">on</span>(<span class="subst">&amp;</span>apos;chat message<span class="subst">&amp;</span>apos;, function(msg){
<span class="number">32</span>         $(<span class="subst">&amp;</span>apos;<span class="variable">#messages</span><span class="subst">&amp;</span>apos;)<span class="built_in">.</span>append($(<span class="subst">&amp;</span>apos;<span class="subst">&amp;</span><span class="literal">lt</span>;li<span class="subst">&amp;</span><span class="literal">gt</span>;<span class="subst">&amp;</span>apos;)<span class="built_in">.</span>text(msg));
<span class="number">33</span>       });
<span class="number">34</span>     <span class="subst">&amp;</span><span class="literal">lt</span>;/script<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">35</span>   <span class="subst">&amp;</span><span class="literal">lt</span>;/body<span class="subst">&amp;</span><span class="literal">gt</span>;
<span class="number">36</span> <span class="subst">&amp;</span><span class="literal">lt</span>;/html<span class="subst">&amp;</span><span class="literal">gt</span>;
</code></pre><p> View Code</p>
<p>&#x5148;&#x8FD0;&#x884C;&#xFF1A;</p>
<pre><code>node <span class="keyword">index</span>.js
</code></pre><p>&#x5728;&#x6253;&#x5F00;&#x4E24;&#x4E2A;<a href="http://localhost:3000&#x7684;&#x7A97;&#x53E3;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x804A;&#x5929;&#x4E86;&amp;#xFF1A" target="_blank" rel="external">http://localhost:3000&#x7684;&#x7A97;&#x53E3;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x804A;&#x5929;&#x4E86;&amp;#xFF1A</a>;</p>
<p><img src="http://taojinke.github.io/img/20150703/2f438e5.gif" alt=""></p>
<p><img src="http://taojinke.github.io/img/20150703/2f43b56.jpg" alt=""></p>
<p>[ <a href="https://github.com/zhangmengxue/Node-KOA/tree/master/websocket/chat-application" target="_blank" rel="external">&#x67E5;&#x770B;&#x6E90;&#x4EE3;&#x7801;</a> ] </p>
<p>socket.io&#x5B98;&#x7F51;&#x4E0A;&#x6709;&#x5F88;&#x8BE6;&#x7EC6;&#x7684;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x548C;&#x6559;&#x7A0B;&#xFF1A;[ <a href="http://socket.io/docs/" target="_blank" rel="external">socket.io doc</a> ] </p>
<h3 id="&#x4E94;&#x3001;&#x6269;&#x5C55;&#x9605;&#x8BFB;">&#x4E94;&#x3001;&#x6269;&#x5C55;&#x9605;&#x8BFB;</h3><p>[ <a href="http://javascript.ruanyifeng.com/htmlapi/websocket.html" target="_blank" rel="external">&#x6D4F;&#x89C8;&#x5668;&#x5BF9;&#x8C61;-WebSocket</a> ] </p>
<p>[web&#x901A;&#x4FE1;] </p>
<p>[&#x7EC6;&#x8BF4;WebSocket] </p>
<p>[ <a href="https://developer.mozilla.org/en-US/docs/WebSockets" target="_blank" rel="external">WebSocket MDN</a> ] </p>
<p>[ <a href="https://github.com/theturtle32/WebSocket-Node" target="_blank" rel="external">WebSocket-Node implementation</a> ] </p>
<p>[ <a href="http://buildnewgames.com/websockets/" target="_blank" rel="external">A Guide For WebSocket</a> ] </p>
<p>[ <a href="http://socket.io/" target="_blank" rel="external">socket.IO</a> ] </p>
<p>[ <a href="https://developer.mozilla.org/en-US/docs/WebSockets/Writing_WebSocket_client_applications" target="_blank" rel="external">writing websocket client</a> ] </p>
<p>[ <a href="http://stackoverflow.com/questions/10112178/differences-between-socket-io-and-websockets" target="_blank" rel="external">deferences between socket.io and websocket</a> ] </p>
<p>[ <a href="http://davidwalsh.name/websocket" target="_blank" rel="external">websocket and socketio</a> ] </p>
<p>[ <a href="http://socket.io/get-started/chat/" target="_blank" rel="external">socket.io application</a> ] </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node-js/">Node.js</a><a href="/tags/WebSocket/">WebSocket</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2f6aec7/" title="Automate Your Mac Via SMS using JavaScript for Automation, Node.js and Twilio -" itemprop="url">Automate Your Mac Via SMS using JavaScript for Automation, Node.js and Twilio -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:57.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> JavaScript is eating the programming world. Look around and you&#x2019;ll see JavaScript in places people never would&#x2019;ve expected 10 years ago. There&#x2019;s JavaScript running on servers. There are more front-end JavaScript frameworks than you can shake a stick at. And there&#x2019;s even JavaScript onmy dog! Lucky me because I love JavaScript. </p>
<p>A few months ago at <a href="http://brooklynjs.com" target="_blank" rel="external">BrooklynJS</a> I was super excited to discover a new way I can use JavaScript. <a href="https://twitter.com/alanmoo" target="_blank" rel="external">Alan Mooiman</a> gave a great talking showing how you can use JavaScript to automate your Mac. After seeing Alan&#x2019;s talk I wondered,&#xA0;could I write a script to take some action on my Mac via SMS? Spoiler alert: yes! yes I can!</p>
<p>This post is all about learning how to automate your Mac via SMS message. The actual task we automate could be one of countless options but for the sake of simplicity we&#x2019;re going to write an app that sends an iMessage message from the messages app when an SMS comes in.</p>
<h4 id="Our_Tools">Our Tools</h4><ul>
<li><a href="https://nodejs.org/" target="_blank" rel="external">Node.js</a> &#xA0;&#x2013; We&#x2019;ll be using node to receive our incoming SMS message from Twilio.</li>
<li>JavaScript for Automation &#x2013; It&#x2019;s like AppleScript but it&#x2019;s JavaScript.</li>
<li>OSX &gt;= 10.10 &#x2013; JavaScript for Automation requires Yosemite or higher.</li>
<li>Twilio &#x2013; Need an account?Sign up for free!</li>
</ul>
<p>Sending iMessages with JavaScript </p>
<p>We&#x2019;ll&#xA0;start by working on the automation portion of our application. We&#x2019;ll use <a href="https://developer.apple.com/library/mac/releasenotes/InterapplicationCommunication/RN-JavaScriptForAutomation/" target="_blank" rel="external">JavaScript for Automation</a> to make this happen. JavaScript for Automation allows you to do the things you would historically use AppleScript for using JavaScript. Pretty rad, right? </p>
<p>Writing this in Apple&#x2019;s Script Editor will make it easy for us to quickly test our code. If you&#x2019;re a Vim lover like me, I know it&#x2019;ll be tough but you can do it!</p>
<p>Once we open Script Editor we need to switch our language from AppleScript to JavaScript.</p>
<p>Now we can start writing our code. Since we&#x2019;re keeping it basic we only need 3 lines of code:</p>
<pre><code>var messages = <span class="constant">Application</span>(&amp;apos;<span class="constant">Messages</span>&amp;apos;);

var buddy = messages.services[&amp;quot;<span class="constant">E</span><span class="symbol">:%REPLACE_WITH_YOUR_IMESSAGE_EMAIL%&amp;quot</span>;].buddies[&amp;quot;%<span class="constant">REPLACE_WITH_BUDDYS_EMAIL</span>%&amp;quot;];

messages.send(&amp;quot;<span class="constant">JavaScript</span> sent this message!&amp;quot;, {<span class="symbol">to:</span> buddy});
</code></pre><p>Make sure your replace the first element with the e-mail address you use for iMessage but keep the preceding &#x201C;E:&#x201D;. For example, mine would be &#x201C;E:ricky@twilio.com&#x201D;.&#xA0;Are you unsure what your iMessage email is? In the Messages application press &#x201C;cmd ,&#x201D; and then click on the accounts tab. Replace the second element with the address of a buddy you&#x2019;d like to message&#xA0;or if you don&#x2019;t want to spam your friend during testing you can send a message to yourself. </p>
<p>Before we run this code let&#x2019;s break it down. On the first line we&#x2019;re getting an object that references the Messages application. The second line we get a reference to our buddy that we want to send a message to. On the last line, we call the send method and pass it the message content we want to send as well as the buddy we&#x2019;re sending to.</p>
<p>Now that we have our code in place we can run it by hitting the big play button in Script Editor (or if you want to be l33 by pressing cmd r). You&#x2019;ll see your message application open and a message is sent to the friend you specified. Oh yeah!</p>
<p><img src="http://taojinke.github.io/img/20150703/2f6917b.gif" alt=""></p>
<p>Hooking It Up To Twilio </p>
<p>Now that we&#x2019;ve automated our mac to send our iMessage it&#x2019;s time to write the code that triggers this automation when a text message comes in via Twilio.</p>
<p>First thing&#x2019;s first, we need to create a new node application. Hop into Terminal and get this bad boy started:</p>
<p> Shell</p>
<pre><code><span class="built_in">mkdir</span> sms-automation
<span class="built_in">cd</span> sms-automation
npm init
</code></pre><p>We&#x2019;re going to be using <a href="http://hapijs.com/" target="_blank" rel="external">hapi.js</a> for this application.&#xA0;If you haven&#x2019;t worked with hapi before, it&#x2019;s a framework that makes building node.js web applications super easy. If you&#x2019;ve worked with express it is a lot like that! In order to use hapi we need to install it: </p>
<p> Shell</p>
<pre><code>npm <span class="keyword">install</span> hapi
</code></pre><p>Now we can create our index.js file that will contain the code for our basic application:</p>
<pre><code><span class="built_in">var</span> Hapi <span class="subst">=</span> <span class="keyword">require</span>(<span class="subst">&amp;</span>apos;hapi<span class="subst">&amp;</span>apos;);

<span class="built_in">var</span> server <span class="subst">=</span> <span class="literal">new</span> Hapi<span class="built_in">.</span>Server();
server<span class="built_in">.</span>connection({
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; host: <span class="subst">&amp;</span>apos;localhost<span class="subst">&amp;</span>apos;,
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; port: <span class="number">8000</span>
});

server<span class="built_in">.</span>start();
</code></pre><p>We&#x2019;ve written the code for a basic server but right now it doesn&#x2019;t do anything. Luckily, we just need one route for our application. We can call the route incoming : </p>
<pre><code><span class="xml">server.route(</span><span class="expression">{
&amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0; <span class="variable">method</span>: &amp;<span class="begin-block">#x</span>2018;<span class="variable">POST</span>&amp;<span class="begin-block">#x</span>2019;,
&amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0; <span class="variable">path</span>:&amp;<span class="begin-block">#xA</span>0;&amp;<span class="variable">apos</span>;<span class="end-block">/incoming</span>&amp;<span class="begin-block">#x</span>2019;,
&amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0; <span class="variable">handler</span>: <span class="variable">function</span> (<span class="variable">request</span>, <span class="variable">reply</span>) {
&amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0;<span class="variable">reply</span>(&amp;<span class="variable">apos</span>;<span class="variable">hello</span> <span class="variable">world</span>&amp;<span class="variable">apos</span>;);
&amp;<span class="begin-block">#xA</span>0; &amp;<span class="begin-block">#xA</span>0; }</span><span class="xml">
});

server.start();</span>
</code></pre><p>Start up our server and test out our new route:</p>
<p> Shell</p>
<pre><code>node <span class="keyword">index</span>.js
</code></pre><p>You may have&#xA0;noticed that we made our route only respond to POST&#xA0;requests. We can use curl to&#xA0;try&#xA0;this out:</p>
<p> Shell</p>
<pre><code>curl -X POST <span class="string">http:</span><span class="comment">//127.0.0.1:8000/incoming</span>
</code></pre><p>We now see we&#x2019;re getting our beautiful &#x201C;hello world&#x201D; response. But we want to do something that receives information about our incoming message and then executes our JavaScript that sends the message. In order to use that we&#x2019;re going to need to use the <em>exec()</em> function. Warning! The exec function runs a shell command on your local machine so be careful that you make sure users can&#x2019;t do anything malicious if you open this up to the outside world. </p>
<p>In order to use <em>exec()</em> we need to require a couple standard libraries at the top of our index.js file: </p>
<pre><code><span class="built_in">var</span> sys <span class="subst">=</span> <span class="keyword">require</span>(<span class="subst">&amp;</span>apos;sys<span class="subst">&amp;</span>apos;),
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; exec <span class="subst">=</span> <span class="keyword">require</span>(<span class="subst">&amp;</span>apos;child_process<span class="subst">&amp;</span>apos;)<span class="built_in">.</span>exec;
</code></pre><p>Before we write the next part we need to jump back into Script Editor and save the code we wrote earlier in the same directory as our Node.js application.&#xA0;Save it as &#x201C;sendmessage.scpt&#x201D;.&#xA0;Saving a file&#xA0;sounds like it should be easy but the Script Editor dialogue can be confusing. When you go to save you need to click on the down arrow next to the &#x201C;Save As&#x201D; name and you&#x2019;ll have the ability to browse to your folder.</p>
<p>So far we&#x2019;ve only run our automation script via Script Editor but we can also run it from the command line. Jump into terminal and browse the directory where we just saved our file. Now run this command:</p>
<p> Shell</p>
<pre><code>osascript <span class="operator">-l</span> JavaScript ./sendmessage.scpt
</code></pre><p>Again, you&#x2019;ll see our messages application has sent our iMessage for us. This command is fairly basic but I wanted to highlight -l argument. This argument indicates that the script we&#x2019;re running is JavaScript, otherwise the command will think we&#x2019;re running code written in AppleScript and it will crash. </p>
<p>We now have everything in place to call this script from our Node.js application. Go back into&#xA0;index.js and add the following code to call JavaScript for Automation script:</p>
<pre><code><span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; handler: function (request, reply) {
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>;<span class="subst">&amp;</span><span class="variable">#xA0</span>;exec(<span class="subst">&amp;</span>quot;osascript <span class="attribute">-l</span> JavaScript <span class="subst">&amp;</span>quot;   __dirname   <span class="subst">&amp;</span>quot;/sendmessage<span class="built_in">.</span>scpt<span class="subst">&amp;</span>quot;, function(err, stdout, stderr) {
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>;console<span class="built_in">.</span><span class="keyword">log</span>(err);
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; });
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>;reply(<span class="subst">&amp;</span>apos;hello world<span class="subst">&amp;</span>apos;);
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; }
</code></pre><p>This route will get called by Twilio whenever someone sends an SMS message to our app. We want to respond to that message indicating that our SMS was received. We can do that usingTwiML. TwiML allows us to provide some basic instructions of what Twilio should do with an incoming message or phone call. We could use the <a href="https://github.com/twilio/twilio-node" target="_blank" rel="external">Twilio Node.js helper library</a> to generate our TwiML but since TwiML is actually XML we&#x2019;re going to just hardcode in our response to avoid adding another dependency: </p>
<pre><code><span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; path:<span class="subst">&amp;</span>apos;/incoming<span class="subst">&amp;</span>apos;,
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; handler: function (request, reply) {
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>;exec(<span class="subst">&amp;</span>quot;osascript <span class="attribute">-l</span> JavaScript <span class="subst">&amp;</span>quot;   __dirname   <span class="subst">&amp;</span>quot;/sendmessage<span class="built_in">.</span>scpt<span class="subst">&amp;</span>quot;, function(err, stdout, stderr) {
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; console<span class="built_in">.</span><span class="keyword">log</span>(err);
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>;});
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>;reply(<span class="subst">&amp;</span>apos;<span class="subst">&amp;</span><span class="literal">lt</span>;Response<span class="subst">&amp;</span><span class="literal">gt</span>;<span class="subst">&amp;</span><span class="literal">lt</span>;Message<span class="subst">&amp;</span><span class="literal">gt</span>;Thanks<span class="subst">!</span> Sending iMessage now<span class="subst">!&amp;</span><span class="literal">lt</span>;/Message<span class="subst">&amp;</span><span class="literal">gt</span>;<span class="subst">&amp;</span><span class="literal">lt</span>;/Response<span class="subst">&amp;</span><span class="literal">gt</span>;<span class="subst">&amp;</span>apos;);
<span class="subst">&amp;</span><span class="variable">#xA0</span>; <span class="subst">&amp;</span><span class="variable">#xA0</span>; }
</code></pre><p>Twilio needs to be able to access our application so we need to expose our local host to the outside world. Fortunately, we can use one of my favorite tools called <a href="https://ngrok.com" target="_blank" rel="external">ngrok</a> to make this happen. If you haven&#x2019;t used this tool before, <a href="https://ngrok.com/download" target="_blank" rel="external">download and install ngrok</a> . </p>
<p>With ngrok installed, we can run the following command to expose our localhost to the outside world:</p>
<p> Shell</p>
<pre><code>ngrok <span class="keyword">http</span> <span class="number">8000</span>
</code></pre><p>Make note of the url ngrok created for your application then head to yourTwilio dashboard. If you don&#x2019;t already have a phone number you&#x2019;d like to use for your application then <a href="https://www.twilio.com/user/account/phone-numbers/search" target="_blank" rel="external">buy a new phone number</a> . Once you have a phone number set the SMS Request URL to the /incoming route on our application: </p>
<p><img src="http://taojinke.github.io/img/20150703/2f6917b.png" alt=""></p>
<p>The moment of truth. Send an SMS message to your application and watch as your Messages app opens and sends an iMessage. Party time!</p>
<p>You can find the completed code for our application <a href="https://github.com/rickyrobinett/sms-automation" target="_blank" rel="external">on GitHub</a> . </p>
<p>Hackers Gonna Hack </p>
<p>You&#x2019;ve now&#xA0;built a basic example showing how you can automate your Mac via SMS. And we&#x2019;re doing it all using JavaScript! What will you build now that you have this ability? Here are a couple ideas:</p>
<ul>
<li>SMS to have your computer open Photobooth snap a picture and send back to you via MMS</li>
<li>SMS your computer and get it to say something (using terminal say) to scare people in your house</li>
</ul>
<p>Are you looking for a way to improve the iMessage application we built together today? Try replacing the hard coded text we&#x2019;re sending each time with the body of the SMS message you&#x2019;re sending in.</p>
<p>Have any questions or what to show me the latest project you&#x2019;ve hacked together? Drop a note in the comments below or holler at me on twitter ( <a href="http://twitter.com/rickyrobinett" target="_blank" rel="external">@rickyrobinett</a> ). </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/MacOS/">MacOS</a><a href="/tags/Node-js/">Node.js</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2f0091e/" title="nodejs爬虫数据抓取乱码问题总结 -" itemprop="url">nodejs爬虫数据抓取乱码问题总结 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:56.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="&#x4E00;&#x3001;&#x975E;UTF-8&#x9875;&#x9762;&#x5904;&#x7406;">&#x4E00;&#x3001;&#x975E;UTF-8&#x9875;&#x9762;&#x5904;&#x7406;</h2><h2 id="1-&#x80CC;&#x666F;">1.&#x80CC;&#x666F;</h2><p>windows-1251&#x7F16;&#x7801;</p>
<p>&#x6BD4;&#x5982;&#x4FC4;&#x8BED;&#x7F51;&#x7AD9;&#xFF1A; <a href="https://vk.com/cciinniikk" target="_blank" rel="external">https://vk.com/cciinniikk</a></p>
<p>&#x53EF;&#x803B;&#x5730;&#x53D1;&#x73B0;&#x662F;&#x8FD9;&#x79CD;&#x7F16;&#x7801;</p>
<p><img src="http://taojinke.github.io/img/20150703/2efee43.png" alt=""></p>
<p>&#x6240;&#x6709;&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x8BF4;&#x7684;&#x662F; Windows-1251&#xFF08;cp1251&#xFF09;&#x7F16;&#x7801;&#x4E0E;utf-8&#x7F16;&#x7801;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x5982; gbk&#x5C31;&#x5148;&#x4E0D;&#x8003;&#x8651;&#x5728;&#x5185;&#x4E86;~</p>
<h2 id="2-&#x89E3;&#x51B3;&#x65B9;&#x6848;">2.&#x89E3;&#x51B3;&#x65B9;&#x6848;</h2><h4 id="1-">1.</h4><h4 id="&#x4F7F;&#x7528;js&#x539F;&#x751F;&#x7F16;&#x7801;&#x8F6C;&#x6362;">&#x4F7F;&#x7528;js&#x539F;&#x751F;&#x7F16;&#x7801;&#x8F6C;&#x6362;</h4><p>&#x4F46;&#x662F;&#x6211;&#x73B0;&#x5728;&#x8FD8;&#x6CA1;&#x627E;&#x5230;&#x529E;&#x6CD5;&#x54C8;..</p>
<p>&#x5982;&#x679C;&#x662F;utf-8&#x8F6C;window-1251&#x8FD8;&#x53EF;&#x4EE5; <a href="http://stackoverflow.com/questions/2696481/encoding-conversation-utf-8-to-1251-in-javascript" target="_blank" rel="external">http://stackoverflow.com/questions/2696481/encoding-conversation-utf-8-to-1251-in-javascript</a></p>
<pre><code><span class="keyword">var</span> DMap = {<span class="number">0</span>: <span class="number">0</span>, <span class="number">1</span>: <span class="number">1</span>, <span class="number">2</span>: <span class="number">2</span>, <span class="number">3</span>: <span class="number">3</span>, <span class="number">4</span>: <span class="number">4</span>, <span class="number">5</span>: <span class="number">5</span>, <span class="number">6</span>: <span class="number">6</span>, <span class="number">7</span>: <span class="number">7</span>, <span class="number">8</span>: <span class="number">8</span>, <span class="number">9</span>: <span class="number">9</span>, <span class="number">10</span>: <span class="number">10</span>, <span class="number">11</span>: <span class="number">11</span>, <span class="number">12</span>: <span class="number">12</span>, <span class="number">13</span>: <span class="number">13</span>, <span class="number">14</span>: <span class="number">14</span>, <span class="number">15</span>: <span class="number">15</span>, <span class="number">16</span>: <span class="number">16</span>, <span class="number">17</span>: <span class="number">17</span>, <span class="number">18</span>: <span class="number">18</span>, <span class="number">19</span>: <span class="number">19</span>, <span class="number">20</span>: <span class="number">20</span>, <span class="number">21</span>: <span class="number">21</span>, <span class="number">22</span>: <span class="number">22</span>, <span class="number">23</span>: <span class="number">23</span>, <span class="number">24</span>: <span class="number">24</span>, <span class="number">25</span>: <span class="number">25</span>, <span class="number">26</span>: <span class="number">26</span>, <span class="number">27</span>: <span class="number">27</span>, <span class="number">28</span>: <span class="number">28</span>, <span class="number">29</span>: <span class="number">29</span>, <span class="number">30</span>: <span class="number">30</span>, <span class="number">31</span>: <span class="number">31</span>, <span class="number">32</span>: <span class="number">32</span>, <span class="number">33</span>: <span class="number">33</span>, <span class="number">34</span>: <span class="number">34</span>, <span class="number">35</span>: <span class="number">35</span>, <span class="number">36</span>: <span class="number">36</span>, <span class="number">37</span>: <span class="number">37</span>, <span class="number">38</span>: <span class="number">38</span>, <span class="number">39</span>: <span class="number">39</span>, <span class="number">40</span>: <span class="number">40</span>, <span class="number">41</span>: <span class="number">41</span>, <span class="number">42</span>: <span class="number">42</span>, <span class="number">43</span>: <span class="number">43</span>, <span class="number">44</span>: <span class="number">44</span>, <span class="number">45</span>: <span class="number">45</span>, <span class="number">46</span>: <span class="number">46</span>, <span class="number">47</span>: <span class="number">47</span>, <span class="number">48</span>: <span class="number">48</span>, <span class="number">49</span>: <span class="number">49</span>, <span class="number">50</span>: <span class="number">50</span>, <span class="number">51</span>: <span class="number">51</span>, <span class="number">52</span>: <span class="number">52</span>, <span class="number">53</span>: <span class="number">53</span>, <span class="number">54</span>: <span class="number">54</span>, <span class="number">55</span>: <span class="number">55</span>, <span class="number">56</span>: <span class="number">56</span>, <span class="number">57</span>: <span class="number">57</span>, <span class="number">58</span>: <span class="number">58</span>, <span class="number">59</span>: <span class="number">59</span>, <span class="number">60</span>: <span class="number">60</span>, <span class="number">61</span>: <span class="number">61</span>, <span class="number">62</span>: <span class="number">62</span>, <span class="number">63</span>: <span class="number">63</span>, <span class="number">64</span>: <span class="number">64</span>, <span class="number">65</span>: <span class="number">65</span>, <span class="number">66</span>: <span class="number">66</span>, <span class="number">67</span>: <span class="number">67</span>, <span class="number">68</span>: <span class="number">68</span>, <span class="number">69</span>: <span class="number">69</span>, <span class="number">70</span>: <span class="number">70</span>, <span class="number">71</span>: <span class="number">71</span>, <span class="number">72</span>: <span class="number">72</span>, <span class="number">73</span>: <span class="number">73</span>, <span class="number">74</span>: <span class="number">74</span>, <span class="number">75</span>: <span class="number">75</span>, <span class="number">76</span>: <span class="number">76</span>, <span class="number">77</span>: <span class="number">77</span>, <span class="number">78</span>: <span class="number">78</span>, <span class="number">79</span>: <span class="number">79</span>, <span class="number">80</span>: <span class="number">80</span>, <span class="number">81</span>: <span class="number">81</span>, <span class="number">82</span>: <span class="number">82</span>, <span class="number">83</span>: <span class="number">83</span>, <span class="number">84</span>: <span class="number">84</span>, <span class="number">85</span>: <span class="number">85</span>, <span class="number">86</span>: <span class="number">86</span>, <span class="number">87</span>: <span class="number">87</span>, <span class="number">88</span>: <span class="number">88</span>, <span class="number">89</span>: <span class="number">89</span>, <span class="number">90</span>: <span class="number">90</span>, <span class="number">91</span>: <span class="number">91</span>, <span class="number">92</span>: <span class="number">92</span>, <span class="number">93</span>: <span class="number">93</span>, <span class="number">94</span>: <span class="number">94</span>, <span class="number">95</span>: <span class="number">95</span>, <span class="number">96</span>: <span class="number">96</span>, <span class="number">97</span>: <span class="number">97</span>, <span class="number">98</span>: <span class="number">98</span>, <span class="number">99</span>: <span class="number">99</span>, <span class="number">100</span>: <span class="number">100</span>, <span class="number">101</span>: <span class="number">101</span>, <span class="number">102</span>: <span class="number">102</span>, <span class="number">103</span>: <span class="number">103</span>, <span class="number">104</span>: <span class="number">104</span>, <span class="number">105</span>: <span class="number">105</span>, <span class="number">106</span>: <span class="number">106</span>, <span class="number">107</span>: <span class="number">107</span>, <span class="number">108</span>: <span class="number">108</span>, <span class="number">109</span>: <span class="number">109</span>, <span class="number">110</span>: <span class="number">110</span>, <span class="number">111</span>: <span class="number">111</span>, <span class="number">112</span>: <span class="number">112</span>, <span class="number">113</span>: <span class="number">113</span>, <span class="number">114</span>: <span class="number">114</span>, <span class="number">115</span>: <span class="number">115</span>, <span class="number">116</span>: <span class="number">116</span>, <span class="number">117</span>: <span class="number">117</span>, <span class="number">118</span>: <span class="number">118</span>, <span class="number">119</span>: <span class="number">119</span>, <span class="number">120</span>: <span class="number">120</span>, <span class="number">121</span>: <span class="number">121</span>, <span class="number">122</span>: <span class="number">122</span>, <span class="number">123</span>: <span class="number">123</span>, <span class="number">124</span>: <span class="number">124</span>, <span class="number">125</span>: <span class="number">125</span>, <span class="number">126</span>: <span class="number">126</span>, <span class="number">127</span>: <span class="number">127</span>, <span class="number">1027</span>: <span class="number">129</span>, <span class="number">8225</span>: <span class="number">135</span>, <span class="number">1046</span>: <span class="number">198</span>, <span class="number">8222</span>: <span class="number">132</span>, <span class="number">1047</span>: <span class="number">199</span>, <span class="number">1168</span>: <span class="number">165</span>, <span class="number">1048</span>: <span class="number">200</span>, <span class="number">1113</span>: <span class="number">154</span>, <span class="number">1049</span>: <span class="number">201</span>, <span class="number">1045</span>: <span class="number">197</span>, <span class="number">1050</span>: <span class="number">202</span>, <span class="number">1028</span>: <span class="number">170</span>, <span class="number">160</span>: <span class="number">160</span>, <span class="number">1040</span>: <span class="number">192</span>, <span class="number">1051</span>: <span class="number">203</span>, <span class="number">164</span>: <span class="number">164</span>, <span class="number">166</span>: <span class="number">166</span>, <span class="number">167</span>: <span class="number">167</span>, <span class="number">169</span>: <span class="number">169</span>, <span class="number">171</span>: <span class="number">171</span>, <span class="number">172</span>: <span class="number">172</span>, <span class="number">173</span>: <span class="number">173</span>, <span class="number">174</span>: <span class="number">174</span>, <span class="number">1053</span>: <span class="number">205</span>, <span class="number">176</span>: <span class="number">176</span>, <span class="number">177</span>: <span class="number">177</span>, <span class="number">1114</span>: <span class="number">156</span>, <span class="number">181</span>: <span class="number">181</span>, <span class="number">182</span>: <span class="number">182</span>, <span class="number">183</span>: <span class="number">183</span>, <span class="number">8221</span>: <span class="number">148</span>, <span class="number">187</span>: <span class="number">187</span>, <span class="number">1029</span>: <span class="number">189</span>, <span class="number">1056</span>: <span class="number">208</span>, <span class="number">1057</span>: <span class="number">209</span>, <span class="number">1058</span>: <span class="number">210</span>, <span class="number">8364</span>: <span class="number">136</span>, <span class="number">1112</span>: <span class="number">188</span>, <span class="number">1115</span>: <span class="number">158</span>, <span class="number">1059</span>: <span class="number">211</span>, <span class="number">1060</span>: <span class="number">212</span>, <span class="number">1030</span>: <span class="number">178</span>, <span class="number">1061</span>: <span class="number">213</span>, <span class="number">1062</span>: <span class="number">214</span>, <span class="number">1063</span>: <span class="number">215</span>, <span class="number">1116</span>: <span class="number">157</span>, <span class="number">1064</span>: <span class="number">216</span>, <span class="number">1065</span>: <span class="number">217</span>, <span class="number">1031</span>: <span class="number">175</span>, <span class="number">1066</span>: <span class="number">218</span>, <span class="number">1067</span>: <span class="number">219</span>, <span class="number">1068</span>: <span class="number">220</span>, <span class="number">1069</span>: <span class="number">221</span>, <span class="number">1070</span>: <span class="number">222</span>, <span class="number">1032</span>: <span class="number">163</span>, <span class="number">8226</span>: <span class="number">149</span>, <span class="number">1071</span>: <span class="number">223</span>, <span class="number">1072</span>: <span class="number">224</span>, <span class="number">8482</span>: <span class="number">153</span>, <span class="number">1073</span>: <span class="number">225</span>, <span class="number">8240</span>: <span class="number">137</span>, <span class="number">1118</span>: <span class="number">162</span>, <span class="number">1074</span>: <span class="number">226</span>, <span class="number">1110</span>: <span class="number">179</span>, <span class="number">8230</span>: <span class="number">133</span>, <span class="number">1075</span>: <span class="number">227</span>, <span class="number">1033</span>: <span class="number">138</span>, <span class="number">1076</span>: <span class="number">228</span>, <span class="number">1077</span>: <span class="number">229</span>, <span class="number">8211</span>: <span class="number">150</span>, <span class="number">1078</span>: <span class="number">230</span>, <span class="number">1119</span>: <span class="number">159</span>, <span class="number">1079</span>: <span class="number">231</span>, <span class="number">1042</span>: <span class="number">194</span>, <span class="number">1080</span>: <span class="number">232</span>, <span class="number">1034</span>: <span class="number">140</span>, <span class="number">1025</span>: <span class="number">168</span>, <span class="number">1081</span>: <span class="number">233</span>, <span class="number">1082</span>: <span class="number">234</span>, <span class="number">8212</span>: <span class="number">151</span>, <span class="number">1083</span>: <span class="number">235</span>, <span class="number">1169</span>: <span class="number">180</span>, <span class="number">1084</span>: <span class="number">236</span>, <span class="number">1052</span>: <span class="number">204</span>, <span class="number">1085</span>: <span class="number">237</span>, <span class="number">1035</span>: <span class="number">142</span>, <span class="number">1086</span>: <span class="number">238</span>, <span class="number">1087</span>: <span class="number">239</span>, <span class="number">1088</span>: <span class="number">240</span>, <span class="number">1089</span>: <span class="number">241</span>, <span class="number">1090</span>: <span class="number">242</span>, <span class="number">1036</span>: <span class="number">141</span>, <span class="number">1041</span>: <span class="number">193</span>, <span class="number">1091</span>: <span class="number">243</span>, <span class="number">1092</span>: <span class="number">244</span>, <span class="number">8224</span>: <span class="number">134</span>, <span class="number">1093</span>: <span class="number">245</span>, <span class="number">8470</span>: <span class="number">185</span>, <span class="number">1094</span>: <span class="number">246</span>, <span class="number">1054</span>: <span class="number">206</span>, <span class="number">1095</span>: <span class="number">247</span>, <span class="number">1096</span>: <span class="number">248</span>, <span class="number">8249</span>: <span class="number">139</span>, <span class="number">1097</span>: <span class="number">249</span>, <span class="number">1098</span>: <span class="number">250</span>, <span class="number">1044</span>: <span class="number">196</span>, <span class="number">1099</span>: <span class="number">251</span>, <span class="number">1111</span>: <span class="number">191</span>, <span class="number">1055</span>: <span class="number">207</span>, <span class="number">1100</span>: <span class="number">252</span>, <span class="number">1038</span>: <span class="number">161</span>, <span class="number">8220</span>: <span class="number">147</span>, <span class="number">1101</span>: <span class="number">253</span>, <span class="number">8250</span>: <span class="number">155</span>, <span class="number">1102</span>: <span class="number">254</span>, <span class="number">8216</span>: <span class="number">145</span>, <span class="number">1103</span>: <span class="number">255</span>, <span class="number">1043</span>: <span class="number">195</span>, <span class="number">1105</span>: <span class="number">184</span>, <span class="number">1039</span>: <span class="number">143</span>, <span class="number">1026</span>: <span class="number">128</span>, <span class="number">1106</span>: <span class="number">144</span>, <span class="number">8218</span>: <span class="number">130</span>, <span class="number">1107</span>: <span class="number">131</span>, <span class="number">8217</span>: <span class="number">146</span>, <span class="number">1108</span>: <span class="number">186</span>, <span class="number">1109</span>: <span class="number">190</span>}
<span class="function"><span class="keyword">function</span> <span class="title">UnicodeToWin1251</span>(<span class="params">s</span>) </span>{
    <span class="keyword">var</span> L = []
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&amp;lt;s.length; i++) {
        <span class="keyword">var</span> ord = s.charCodeAt(i)
        <span class="keyword">if</span> (!(ord <span class="keyword">in</span> DMap))
            <span class="keyword">throw</span> &amp;quot;Character &amp;quot;+s.charAt(i)+&amp;quot; isn&amp;apos;t supported by win1251!&amp;quot;
        L.push(<span class="built_in">String</span>.fromCharCode(DMap[ord]))
    }
    <span class="keyword">return</span> L.join(&amp;apos;&amp;apos;)
}
</code></pre><p>&#x55EF;&#xFF0C;&#x8FD9;&#x662F;&#x4E2A;&#x597D;&#x529E;&#x6CD5;&#xFF0C;Dmap&#x50A8;&#x5B58;&#x7684;&#x5176;&#x5B9E;&#x5C31;&#x662F;window-1251&#x7F16;&#x7801;&#x548C;unicode&#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB; <a href="http://blog.csdn.net/yao_guet/article/details/7070364" target="_blank" rel="external">http://blog.csdn.net/yao_guet/article/details/7070364</a></p>
<p><img src="http://taojinke.github.io/img/20150703/2efee43.png" alt=""></p>
<p>&#x6240;&#x4EE5;&#x672C;&#x6253;&#x7B97;&#x53EA;&#x8981;&#x53CD;&#x7740;&#x6765;&#x5C31;&#x884C;</p>
<p>&#x4F46;&#x4E00;&#x53CD;&#xFF0C;&#x624D;&#x53D1;&#x73B0; charCodeAt &#x65B9;&#x6CD5;&#x53EA;&#x5BF9; unicode&#x6709;&#x6548;&#xFF0C;&#x5176;&#x4ED6;&#x7F16;&#x7801;&#x662F;&#x5982;&#x4F55;&#x6316;&#x6398;&#x51FA;&#x5176;&#x7801;&#x6BB5;&#xFF1F; &#x56E0;&#x4E3A;&#x7528;&#x7684;&#x662F;nodejs &#x6240;&#x4EE5;&#x8003;&#x8651;&#x4F7F;&#x7528;&#x76F8;&#x5E94;&#x6A21;&#x5757;</p>
<h4 id="2-">2.</h4><p>&#x5B89;&#x88C5;&#x4F7F;&#x7528;nodejs&#x6A21;&#x5757;iconv-lite&#x4F7F;&#x7528;&#x8BF4;&#x660E;&#x89C1;&#xA0; <a href="https://www.npmjs.com/package/iconv-lite" target="_blank" rel="external">https://www.npmjs.com/package/iconv-lite</a></p>
<p>&#x6309;&#x7167;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;&#x5E94;&#x8BE5;&#x662F;&#x7C7B;&#x4F3C;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x4F7F;&#x7528;</p>
<pre><code><span class="built_in">var</span> iconv <span class="subst">=</span> <span class="keyword">require</span>(<span class="subst">&amp;</span>apos;iconv<span class="attribute">-lite</span><span class="subst">&amp;</span>apos;);
<span class="built_in">var</span> Buffer <span class="subst">=</span> <span class="keyword">require</span>(<span class="subst">&amp;</span>apos;buffer<span class="subst">&amp;</span>apos;)<span class="built_in">.</span>Buffer;
<span class="comment">// Convert from an encoded windows-1251 to utf-8</span>
<span class="built_in">var</span> str1 <span class="subst">=</span> <span class="subst">&amp;</span>apos;<span class="subst">&amp;</span><span class="variable">#x446</span>;<span class="subst">&amp;</span><span class="variable">#x435</span>;<span class="subst">&amp;</span><span class="variable">#x43D</span>;<span class="subst">&amp;</span><span class="variable">#x43D</span>;<span class="subst">&amp;</span><span class="variable">#x43E</span>;<span class="subst">&amp;</span><span class="variable">#x441</span>;<span class="subst">&amp;</span><span class="variable">#x442</span>;<span class="subst">&amp;</span><span class="variable">#x438</span>; <span class="subst">&amp;</span><span class="variable">#x43D</span>;<span class="subst">&amp;</span><span class="variable">#x438</span>; <span class="subst">&amp;</span><span class="variable">#x432</span>; <span class="subst">&amp;</span>apos;;
<span class="built_in">var</span> buf <span class="subst">=</span> <span class="literal">new</span> Buffer(str1);
<span class="built_in">var</span> str2 <span class="subst">=</span> iconv<span class="built_in">.</span>decode(buf, <span class="subst">&amp;</span>apos;win1251<span class="subst">&amp;</span>apos;);

console<span class="built_in">.</span><span class="keyword">log</span>(str2);
</code></pre><p><img src="http://taojinke.github.io/img/20150703/2efee43.png" alt=""></p>
<p>&#x4F46;&#x51FA;&#x5947;&#x5730;&#x53D1;&#x73B0;&#xFF0C;&#x62A5;&#x9519;&#x65E0;win1251&#x7F16;&#x7801;&#xFF1F;&#x6539;&#x4E86;&#x7C7B;&#x4F3C;&#x7684;&#x51E0;&#x79CD;&#x4E5F;&#x4E0D;&#x884C;..&#x5B98;&#x65B9;&#x5E94;&#x8BE5;&#x6CA1;&#x9519;&#x5427;..&#x4E8E;&#x662F;&#x4F7F;&#x7528; iconv&#x6A21;&#x5757;</p>
<h4 id="3-">3.</h4><p>&#x5B89;&#x88C5;&#x4F7F;&#x7528;nodejs&#x6A21;&#x5757;iconv&#x4F7F;&#x7528;&#x8BF4;&#x660E;&#x89C1;&#xA0; <a href="https://github.com/bnoordhuis/node-iconv" target="_blank" rel="external">https://github.com/bnoordhuis/node-iconv</a></p>
<p>&#x4E00;&#x822C;&#x7B80;&#x5355;&#x4F7F;&#x7528;&#x540E;&#xFF0C;&#x8FD8;&#x662F;&#x4E71;&#x7801; &#x5F62;&#x5982;&#xFF1A; &#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405; &#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405; &#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;&#x43F;&#x457;&#x405;</p>
<p><a href="http://stackoverflow.com/questions/8693400/nodejs-convertinf-from-windows-1251-to-utf-8" target="_blank" rel="external">http://stackoverflow.com/questions/8693400/nodejs-convertinf-from-windows-1251-to-utf-8</a></p>
<p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#x4E3A;&#x8F6C;&#x6210;&#x4E8C;&#x8FDB;&#x5236;&#x8BFB;&#x53D6;&#x6570;&#x636E; encoding&#xFF1A;binary &#xA0;&#xFF08;&#x9ED8;&#x8BA4;&#x7684;encoding&#x662F;utf-8)</p>
<pre><code>request<span class="list">({ 
    uri: website_url,
    method: <span class="keyword">&amp;apos</span><span class="comment">;GET&amp;apos;,</span>
    encoding: <span class="keyword">&amp;apos</span><span class="comment">;binary&amp;apos;</span>
}, function <span class="list">(<span class="keyword">error</span>, response, body)</span> {
    body = new Buffer<span class="list">(<span class="keyword">body</span>, <span class="keyword">&amp;apos</span><span class="comment">;binary&amp;apos;);</span>
    conv = new iconv.Iconv<span class="list">(<span class="keyword">&amp;apos</span><span class="comment">;WINDOWS-1251&amp;apos;, &amp;apos;utf8&amp;apos;);</span>
    body = conv.convert<span class="list">(<span class="keyword">body</span>)</span>.toString<span class="list">()</span><span class="comment">;</span>
    }
})</span><span class="comment">;</span></span></span>
</code></pre><p>—&gt;&#x53E6;&#x5916;&#x8981;&#x8BF4;&#x7684;&#x662F;&#xFF0C;iconv&#x7684;&#x4F7F;&#x7528;&#x65F6;&#x9700;&#x8981;&#x4E00;&#x4E9B;&#x73AF;&#x5883;&#x4F9D;&#x8D56;&#x7684;&#xFF0C;&#x89C1;&#x5B98;&#x65B9;&#x8BF4;&#x660E;&#xFF1A; <a href="https://github.com/TooTallNate/node-gyp" target="_blank" rel="external">https://github.com/TooTallNate/node-gyp</a></p>
<p><img src="http://taojinke.github.io/img/20150703/2eff0b4.png" alt=""></p>
<p>&#x6240;&#x4EE5;&#xFF1A;</p>
<p>&#x7B2C;&#x4E00;&#x9700;&#x8981; <a href="https://www.python.org/downloads/" target="_blank" rel="external">python</a> &#x5BF9;&#x5E94;&#x7248;&#x672C;(&#x5982;2.7&#xFF09;&#x7684;&#x652F;&#x6301; &#xFF1B; </p>
<p>&#x7B2C;&#x4E8C;&#x9700;&#x8981;&#x7F16;&#x8BD1;&#x5DE5;&#x5177;&#x7684;&#x652F;&#x6301;&#xFF08;windows&#x4E0B;&#x51FA;&#x9519;&#x6700;&#x591A;&#xFF09;</p>
<p>&#x51FA;&#x9519;&#x7C7B;&#x4F3C;&#x8FD9;&#x79CD;</p>
<p><img src="http://taojinke.github.io/img/20150703/2eff0b4.gif" alt=""></p>
<p>node&#xFF0C;&#x5982;&#x65E0;&#x7279;&#x5B9A;&#x7248;&#x672C;&#x6216;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;vs2005&#x7F16;&#x8BD1;&#x5DE5;&#x5177;&#xFF08;&#x6240;&#x4EE5;&#x51FA;&#x9519;&#x63D0;&#x793A;&#x7684;&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#x4E00;&#x822C;&#x4E3A;&#x6309;&#x7167;vs2005&#x548C;framwork sdk2.0)</p>
<p>&#x95EE;&#x9898;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF1A;</p>
<p>1.&#x5B89;&#x88C5;visual stutio 2010</p>
<p>2.&#x6307;&#x5B9A;vs&#x7F16;&#x8BD1;&#x5DE5;&#x5177;&#x7248;&#x672C;&#xFF08;&#x5982;&#x679C;&#x662F;vs2012&#x5C31;&#x662F;2012&#xFF09;</p>
<p>&#xFF08;&#x6709;&#x4E9B;&#x65F6;&#x5019;&#x4F1A;&#x81EA;&#x52A8;&#x6307;&#x5B9A;&#xFF0C;&#x6240;&#x6709;&#x4E5F;&#x4E0D;&#x4E00;&#x5B9A;&#x9700;&#x8981;&#x8FD9;&#x4E2A;&#x547D;&#x4EE4; npm config set msvs_version 2010 —global&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/2eff596.pn" alt=""></p>
<p>3.&#x5982;&#x82E5;&#x8FD8;&#x662F;&#x63D0;&#x793A;&#x627E;&#x4E0D;&#x5230; framwork sdk&#xFF0C;&#x53EF;&#x5C06;&#x5176;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;&#x7CFB;&#x7EDF;&#x73AF;&#x5883;&#x53D8;&#x91CF;path&#x4E2D;</p>
<p>&#xFF08;2010&#x5BF9;&#x5E94;sdk4.0&#x7248;&#x672C;,&#x7C7B;&#x4F3C;&#x7684; 2008 sdj3.5 &#xA0;2012 sdk4.5?&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/2eff807.pn" alt=""></p>
<h2 id="&#x4E8C;&#x3001;gzip&#x9875;&#x9762;&#x5904;&#x7406;">&#x4E8C;&#x3001;gzip&#x9875;&#x9762;&#x5904;&#x7406;</h2><p>&#x6709;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x6D4F;&#x89C8;&#x5668;&#x8BBF;&#x95EE;&#x9875;&#x9762;&#x662F;&#x6B63;&#x5E38;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x6A21;&#x62DF;&#x8BF7;&#x6C42;&#x56DE;&#x6765;&#x5C31;&#x4E71;&#x7801;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x4E00;&#x4E0B;&#x6D4F;&#x89C8;&#x5668;&#x8BF7;&#x6C42;&#x7684;Response&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x679C;&#x6709;Content-Encoding:gzip&#xFF0C;&#x6781;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x56E0;&#x4E3A;&#x9875;&#x9762;&#x88AB;gzip&#x538B;&#x7F29;&#x4E86;&#xFF0C;&#x8FD9;&#x65F6;&#x8BF7;&#x6C42;&#x65F6;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x53C2;&#x6570;</p>
<p>gzip:true</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Node-js/">Node.js</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/13/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/61/">61</a><a class="extend next" rel="next" href="/page/15/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>606</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>10</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
