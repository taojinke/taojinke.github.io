
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/17/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23c1b1b/" title="Linux c 开发 - Memcached源码分析之HashTable（4） -" itemprop="url">Linux c 开发 - Memcached源码分析之HashTable（4） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x8BB2;&#x89E3;&#x4E86;Memcached&#x7684;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x673A;&#x5236;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF08;3&#xFF09;&#x300B;&#x3002;&#x4ECE;&#x8FD9;&#x4E00;&#x7AE0;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x6162;&#x6162;&#x8BB2;&#x89E3;Memcached&#x662F;&#x5982;&#x4F55;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x3002;</p>
<p>&#x8BB2;&#x89E3;&#x672C;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E2A;Memcached&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;item&#x7684;&#x57FA;&#x672C;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code><span class="xml">//item&amp;#x7684;&amp;#x5177;&amp;#x4F53;&amp;#x7ED3;&amp;#x6784;  
typedef struct _stritem </span><span class="expression">{  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;<span class="variable">HashTable</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">Item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;  
    //&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>1;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">set</span><span class="end-block">/add</span><span class="end-block">/replace</span>&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>66<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>57;&amp;<span class="begin-block">#x</span>6<span class="variable">BB</span>5;  
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">BD</span>4;&amp;<span class="begin-block">#x</span>8<span class="variable">F</span>83;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5931;&amp;<span class="begin-block">#x</span>6548;  
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* <span class="variable">least</span> <span class="variable">recent</span> <span class="variable">access</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>13;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>38;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>45;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>6548;&amp;<span class="begin-block">#x</span>3002;  
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">Memcached</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>6<span class="variable">DD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>70;  
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* <span class="variable">expire</span> <span class="variable">time</span> *<span class="end-block">/  </span>
    /<span class="end-block">/value</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* <span class="variable">size</span> <span class="variable">of</span> <span class="variable">data</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>3002;  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;<span class="variable">refcount</span>&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">refcount</span> <span class="variable">-</span>1 = 0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;  
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;  
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">length</span> <span class="variable">of</span> <span class="variable">flags-and-length</span> <span class="variable">string</span> *<span class="end-block">/  </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> *<span class="end-block">/  </span>
    /<span class="end-block">/slabs</span>_<span class="variable">class</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">ID</span>&amp;<span class="begin-block">#x</span>3002;  
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* <span class="variable">which</span> <span class="variable">slab</span> <span class="variable">class</span> <span class="variable">we</span>&amp;<span class="variable">apos</span>;<span class="variable">re</span> <span class="variable">in</span> *<span class="end-block">/  </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span> <span class="variable">length</span>, <span class="variable">w</span><span class="end-block">/terminating null and padding </span>*<span class="end-block">/  </span>
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span> 
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    <span class="variable">union</span> {  
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;  
        <span class="variable">char</span> <span class="variable">end</span>;  
    }</span><span class="xml"> data[];  
    /* if it_flags &amp;amp; ITEM_CAS we have 8 bytes CAS */  
    /* then null-terminated key */  
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
} item;</span>
</code></pre><p>&#x8BF4;&#x660E;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x4E0A;&#x5B58;&#x50A8;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;Item&#x7684;&#x7ED3;&#x6784;&#x3002;</p>
</li>
<li><p>Item&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x8BB0;&#x5F55;&#x4E0E;HashTable&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4EE5;&#x53CA;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;slabs_class&#xFF08;&#x540E;&#x9762;&#x51E0;&#x7AE0;&#x8282;&#x4F1A;&#x8BB2;&#x89E3;&#xFF09;&#x7684;&#x5173;&#x7CFB;&#x4EE5;&#x53CA;key&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x548C;&#x957F;&#x5EA6;&#x7B49;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>Item&#x5757;&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x5728;slabclass&#x4E0A;&#xFF0C;slabclass&#x4F1A;&#x5728;&#x4E0B;&#x4E0B;&#x7AE0;&#x8282;&#x4E2D;&#x8BE6;&#x7EC6;&#x8BB2;&#x89E3;&#x3002;</p>
</li>
<li><p>HashTable&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#xFF1A;&#x7528;&#x4E8E;&#x901A;&#x8FC7;key&#x5FEB;&#x901F;&#x67E5;&#x8BE2;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
</ol>
<p>Memcached&#x7684;HashTable&#x6E90;&#x7801;&#x5206;&#x6790;</p>
<p>HashTable&#x7ED3;&#x6784;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/23c0040.jpg" alt=""></p>
<p>&#x8BF4;&#x660E;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x9ED8;&#x8BA4;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;HashTable&#xFF0C;&#x8FD9;&#x4E2A;table&#x7684;&#x9ED8;&#x8BA4;&#x957F;&#x5EA6;&#x4E3A;65536&#x3002;</p>
</li>
<li><p>&#x6211;&#x4EEC;&#x5C06;&#x8FD9;&#x4E2A;HashTable&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x79F0;&#x4E3A;&#x6876;&#xFF0C;&#x6BCF;&#x4E2A;&#x6876;&#x5C31;&#x662F;&#x4E00;&#x4E2A;item&#x7ED3;&#x6784;&#x7684;&#x5355;&#x5411;&#x94FE;&#x8868;&#x3002;</p>
</li>
<li><p>Memcached&#x4F1A;&#x5C06;key&#x503C;hash&#x6210;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x540D;&#x79F0;&#x4E3A;hv&#x7684;uint32_t&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;hv&#x4E0E;&#x6876;&#x7684;&#x4E2A;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x6309;&#x4F4D;&#x4E0E;&#x8BA1;&#x7B97;&#xFF0C;hv &amp; hashmask(hashpower)&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x7684;key&#x4F1A;&#x843D;&#x5728;&#x54EA;&#x4E2A;&#x6876;&#x4E0A;&#x9762;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x4F1A;&#x5C06;item&#x6302;&#x5230;&#x8FD9;&#x4E2A;&#x6876;&#x7684;&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x3002;&#x94FE;&#x8868;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;item&#x7ED3;&#x6784;&#x4E2D;&#x7684;h_next&#x5B9E;&#x73B0;&#x3002;</p>
</li>
</ol>
<p>item_get - &#x7EE7;&#x7EED;&#x4ECE;get&#x65B9;&#x6CD5;&#x8BF4;&#x8D77;</p>
<p>&#x7ED3;&#x5408;&#x7B2C;&#x4E8C;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;Memcached get&#x7684;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;key &#x54C8;&#x5E0C;&#x6210;&#x4E00;&#x4E2A;uint32_t&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002;</p>
</li>
<li><p>&#x8C03;&#x7528;do_item_get&#x65B9;&#x6CD5;&#x3002;</p>
<p> //&#x8FD9;&#x8FB9;&#x7684;item_<em>&#x7CFB;&#x5217;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;Memcached&#x6838;&#x5FC3;&#x5B58;&#x50A8;&#x5757;&#x7684;&#x63A5;&#x53E3;<br> item </em>item_get(const char *key, const size_t nkey) {  </p>
<pre><code>item *it;  
uint32_t hv;  
hv = hash(key, nkey); //&amp;<span class="symbol">#x5BF9</span>;key&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;hash,&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;uint32_t&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
item_lock(hv); //&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4ED6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6027</span>;  
it = do_item_get(key, nkey, hv);  
item_unlock(hv);  
return it;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7EE7;&#x7EED;&#x770B;do_item_get&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x67E5;&#x8BE2;HashTable&#x4E0A;&#x7684;Item</p>
<pre><code><span class="comment">/** wrapper around assoc_find which does the lazy expiration logic */</span>  
item *do_item_get(<span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">size_t</span> nkey, <span class="keyword">const</span> <span class="keyword">uint32_t</span> hv) {  
    <span class="comment">//mutex_lock(&amp;amp;cache_lock);  </span>
    item *it = assoc_find(key, nkey, hv); <span class="comment">//hashTable&amp;#x4E0A;&amp;#x5B58;&amp;#x50A8;Item  </span>
    <span class="comment">//....more code  </span>
}
</code></pre><p>assoc.c - assoc_init &#x521D;&#x59CB;&#x5316;HashTable</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8FDB;&#x5165;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x540E;&#xFF0C;&#x53D1;&#x73B0;HashTable&#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x5728;assoc.c&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<ol>
<li><p>assoc_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3A;HashTable&#x521D;&#x59CB;&#x5316;&#xFF0C;assoc_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x5165;&#x53E3;&#x51FD;&#x6570;main&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x7684;&#x3002;</p>
</li>
<li><p>HashTable&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x4E3A;16&#xFF0C;1 &lt;&lt; 16&#x540E;&#x5F97;&#x5230;65536&#x4E2A;&#x6876;&#x3002;&#x5982;&#x679C;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x8BBE;&#x7F6E;&#xFF0C;&#x8BBE;&#x7F6E;&#x503C;&#x5728;12-64&#x4E4B;&#x95F4;&#x3002;</p>
</li>
<li><p>&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;memcached&#x7684;&#x6876;&#x7684;&#x4E2A;&#x6570;&#x8DB3;&#x591F;&#x4F7F;&#x7528;&#x4E86;&#x3002;</p>
<p> //&#x521D;&#x59CB;&#x5316;HahsTable&#x8868;<br> void assoc_init(const int hashtable_init) {  </p>
<pre><code>//&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>; hashtable_init&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">12</span> &amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">64</span>  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hashtable_init&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;hashpower&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">16</span>  
if (hashtable_init) {  
    hashpower = hashtable_init;  
}  
//primary_hashtable&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">HashTable</span>  
//hashsize&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hashpower=<span class="number">16</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">65536</span>  
primary_hashtable = calloc(hashsize(hashpower), sizeof(void *));  
if (! primary_hashtable) {  
    fprintf(stderr, &amp;quot;<span class="class">Failed</span> to init hashtable.\n&amp;quot;);  
    exit(<span class="class">EXIT_FAILURE</span>);  
}  
<span class="class">STATS_LOCK</span>();  
stats.hash_power_level = hashpower;  
stats.hash_bytes = hashsize(hashpower) * sizeof(void *);  
<span class="class">STATS_UNLOCK</span>();  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_find &#x67E5;&#x627E;&#x4E00;&#x4E2A;Item</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x904D;&#x5386;&#x6876;&#x7684;&#x5355;&#x94FE;&#x8868;&#xFF0C;&#x6BD4;&#x8F83;key&#x503C;&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;item</p>
<p> //&#x5BFB;&#x627E;&#x4E00;&#x4E2A;Item<br> item <em>assoc_find(const char </em>key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item *it;  
unsigned int oldbucket;  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;...  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    it = old_hashtable[oldbucket];  
} else {  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    it = primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
}  
item *ret = <span class="class">NULL</span>;  
int depth = <span class="number">0</span>; //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6DF1</span>;&amp;<span class="symbol">#x5EA6</span>;  
while (it) {  
    //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;list&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
    if ((nkey == it-&amp;gt;nkey) &amp;amp;&amp;amp; (memcmp(key, <span class="class">ITEM_key</span>(it), nkey) == <span class="number">0</span>)) {  
        ret = it;  
        break;  
    }  
    it = it-&amp;gt;h_next;  
    ++depth;  
}  
<span class="class">MEMCACHED_ASSOC_FIND</span>(key, nkey, depth);  
return ret;  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_insert &#x65B0;&#x589E;&#x4E00;&#x4E2A;Item</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x5C06;item&#x653E;&#x5230;&#x5BF9;&#x5E94;&#x6876;&#x7684;&#x5355;&#x94FE;&#x8868;&#x7684;&#x5934;&#x90E8;</p>
</li>
<li><p>&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x6269;&#x5BB9;&#xFF0C;&#x5982;&#x679C;&#x6269;&#x5BB9;&#xFF0C;&#x5219;&#x4F1A;&#x5728;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x3002;&#xFF08;&#x6876;&#x7684;&#x4E2A;&#x6570;(&#x9ED8;&#x8BA4;&#xFF1A;65536) * 3&#xFF09; / 2</p>
<p> //&#x65B0;&#x589E;Item&#x64CD;&#x4F5C;<br> int assoc_insert(item *it, const uint32_t hv) {  </p>
<pre><code>unsigned int oldbucket;  
assert(assoc_find(<span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) == <span class="number">0</span>);  /* shouldn&amp;apos;t have duplicately named things defined */  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5E8F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x65E7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    it-&amp;gt;h_next = old_hashtable[oldbucket];  
    old_hashtable[oldbucket] = it;  
} else {  
    //hv &amp;amp; hashmask(hashpower) &amp;<span class="symbol">#x6309</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E0E</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item-&amp;gt;h_next &amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;  
    it-&amp;gt;h_next = primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
    //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;hashtable&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x9875</span>;<span class="class">Item</span>&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x503C</span>;  
    primary_hashtable[hv &amp;amp; hashmask(hashpower)] = it;  
}  
hash_items++; //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hash_items&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;  &amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;(&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">65536</span>) * <span class="number">3</span>&amp;<span class="symbol">#xFF09</span>; / <span class="number">2</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
//&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x8EAB</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5FC5</span>;&amp;<span class="symbol">#x987B</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4F30</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x8017</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x957F</span>;  
if (! expanding &amp;amp;&amp;amp; hash_items &amp;gt; (hashsize(hashpower) * <span class="number">3</span>) / <span class="number">2</span>) {  
    assoc_start_expand();  
}  
<span class="class">MEMCACHED_ASSOC_INSERT</span>(<span class="class">ITEM_key</span>(it), it-&amp;gt;nkey, hash_items);  
return <span class="number">1</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_delete &#x5220;&#x9664;item&#x64CD;&#x4F5C;</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x627E;&#x5230;&#x6876;&#x5BF9;&#x5E94;&#x7684;&#x94FE;&#x8868;&#xFF0C;&#x904D;&#x5386;&#x5355;&#x94FE;&#x8868;&#xFF0C;&#x5220;&#x9664;&#x5BF9;&#x5E94;&#x7684;Item&#x3002;</p>
<p> //&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5BFB;&#x627E;<br> static item<em>* _hashitem_before (const char </em>key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item **pos;  
unsigned int oldbucket;  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    pos = &amp;amp;old_hashtable[oldbucket];  
} else {  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    pos = &amp;amp;primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
}  
//&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;list&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5339</span>;&amp;<span class="symbol">#x914D</span>;key&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">Item</span>  
while (*pos &amp;amp;&amp;amp; ((nkey != (*pos)-&amp;gt;nkey) || memcmp(key, <span class="class">ITEM_key</span>(*pos), nkey))) {  
    pos = &amp;amp;(*pos)-&amp;gt;h_next;  
}  
return pos;  
</code></pre><p> }<br> //&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x6876;&#x4E0A;&#x7684;Item<br> void assoc_delete(const char *key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item **before = _hashitem_before(key, nkey, hv); //&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;<span class="class">Item</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">Item</span>&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
if (*before) {  
    item *nxt;  
    hash_items--; //item&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>  
    /* <span class="class">The</span> <span class="class">DTrace</span> probe cannot be triggered as the last instruction 
     * due to possible tail-optimization by the compiler 
     */  
    <span class="class">MEMCACHED_ASSOC_DELETE</span>(key, nkey, hash_items);  
    nxt = (*before)-&amp;gt;h_next;  
    (*before)-&amp;gt;h_next = <span class="number">0</span>;   /* probably pointless, but whatever. */  
    *before = nxt;  
    return;  
}  
/* <span class="class">Note</span>:  we never actually get here.  the callers don&amp;apos;t delete things 
   they can&amp;apos;t find. */  
assert(*before != <span class="number">0</span>);  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - &#x5173;&#x4E8E;&#x6269;&#x5BB9;</p>
<p>Memcached&#x7684;&#x6269;&#x5BB9;&#x90FD;&#x662F;&#x5728;&#x5355;&#x72EC;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x7684;&#x3002;</p>
<p>&#xFF08;&#x6876;&#x7684;&#x4E2A;&#x6570;(&#x9ED8;&#x8BA4;&#xFF1A;65536) * 3&#xFF09; / 2&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x6269;&#x5BB9;&#x3002;&#x6269;&#x5BB9;&#x9700;&#x8981;&#x7684;&#x65F6;&#x95F4;&#x6BD4;&#x8F83;&#x4E45;&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#x8FDB;&#x884C;&#x81EA;&#x52A8;&#x6269;&#x5BB9;&#x5904;&#x7406;&#x3002;</p>
<pre><code>static void assoc_start_expand<span class="params">(void)</span> {  
    <span class="keyword">if</span> <span class="params">(started_expanding)</span>  
        return;  
    started_expanding = <span class="literal">true</span>;  
    <span class="comment">//&amp;#x5524;&amp;#x9192;&amp;#x7EBF;&amp;#x7A0B;  </span>
    pthread_cond_signal<span class="params">(&amp;amp;maintenance_cond)</span>;  
}  
<span class="comment">/* grows the hashtable to the next power of 2. */</span>  
<span class="comment">//&amp;#x6269;&amp;#x5BB9;&amp;#x65B9;&amp;#x6CD5;  </span>
static void assoc_expand<span class="params">(void)</span> {  
    old_hashtable = primary_hashtable;  
    primary_hashtable = calloc<span class="params">(hashsize<span class="params">(hashpower + <span class="number">1</span>)</span>, sizeof<span class="params">(void *)</span>)</span>;  
    <span class="keyword">if</span> <span class="params">(primary_hashtable)</span> {  
        <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">1</span>)</span>  
            fprintf<span class="params">(stderr, &amp;quot;Hash table expansion starting\n&amp;quot;)</span>;  
        hashpower++;  
        expanding = <span class="literal">true</span>;  
        expand_bucket = <span class="number">0</span>;  
        STATS_LOCK<span class="params">()</span>;  
        stats.hash_power_level = hashpower;  
        stats.hash_bytes += hashsize<span class="params">(hashpower)</span> <span class="built_in">*</span> sizeof<span class="params">(void *)</span>;  
        stats.hash_is_expanding = <span class="number">1</span>;  
        STATS_UNLOCK<span class="params">()</span>;  
    } <span class="keyword">else</span> {  
        primary_hashtable = old_hashtable;  
        <span class="comment">/* Bad news, but we can keep running. */</span>  
    }  
}  
static volatile int do_run_maintenance_thread = <span class="number">1</span>;  
<span class="built_in">#</span>define DEFAULT_HASH_BULK_MOVE <span class="number">1</span>  
int hash_bulk_move = DEFAULT_HASH_BULK_MOVE;  
static void <span class="built_in">*</span>assoc_maintenance_thread<span class="params">(void *arg)</span> {  
    while <span class="params">(do_run_maintenance_thread)</span> {  
        int ii = <span class="number">0</span>;  
        <span class="comment">/* Lock the cache, and bulk move multiple buckets to the new 
         * hash table. */</span>  
        item_lock_global<span class="params">()</span>;  
        mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="keyword">for</span> <span class="params">(ii = <span class="number">0</span>; ii &amp;lt; hash_bulk_move &amp;amp;&amp;amp; expanding; ++ii)</span> {  
            item <span class="built_in">*</span>it, <span class="built_in">*</span>next;  
            int bucket;  
            <span class="keyword">for</span> <span class="params">(it = old_hashtable[expand_bucket]; NULL != it; it = next)</span> {  
                next = it-&amp;gt;h_next;  
                bucket = hash<span class="params">(ITEM_key<span class="params">(it)</span>, it-&amp;gt;nkey)</span> &amp;amp; hashmask<span class="params">(hashpower)</span>;  
                it-&amp;gt;h_next = primary_hashtable[bucket];  
                primary_hashtable[bucket] = it;  
            }  
            old_hashtable[expand_bucket] = NULL;  
            expand_bucket++;  
            <span class="keyword">if</span> <span class="params">(expand_bucket == hashsize<span class="params">(hashpower - <span class="number">1</span>)</span>)</span> {  
                expanding = <span class="literal">false</span>;  
                free<span class="params">(old_hashtable)</span>;  
                STATS_LOCK<span class="params">()</span>;  
                stats.hash_bytes -= hashsize<span class="params">(hashpower - <span class="number">1</span>)</span> <span class="built_in">*</span> sizeof<span class="params">(void *)</span>;  
                stats.hash_is_expanding = <span class="number">0</span>;  
                STATS_UNLOCK<span class="params">()</span>;  
                <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">1</span>)</span>  
                    fprintf<span class="params">(stderr, &amp;quot;Hash table expansion done\n&amp;quot;)</span>;  
            }  
        }  
        mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        item_unlock_global<span class="params">()</span>;  
        <span class="keyword">if</span> <span class="params">(!expanding)</span> {  
            <span class="comment">/* finished expanding. tell all threads to use fine-grained locks */</span>  
            switch_item_lock_type<span class="params">(ITEM_LOCK_GRANULAR)</span>;  
            slabs_rebalancer_resume<span class="params">()</span>;  
            <span class="comment">/* We are done expanding.. just wait for next invocation */</span>  
            mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
            started_expanding = <span class="literal">false</span>;  
            pthread_cond_wait<span class="params">(&amp;amp;maintenance_cond, &amp;amp;cache_lock)</span>;  
            <span class="comment">/* Before doing anything, tell threads to use a global lock */</span>  
            mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            slabs_rebalancer_pause<span class="params">()</span>;  
            switch_item_lock_type<span class="params">(ITEM_LOCK_GLOBAL)</span>;  
            mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
            assoc_expand<span class="params">()</span>;  
            mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        }  
    }  
    return NULL;  
}  
static pthread_t maintenance_tid;  
int start_assoc_maintenance_thread<span class="params">()</span> {  
    int ret;  
    char <span class="built_in">*</span>env = getenv<span class="params">(&amp;quot;MEMCACHED_HASH_BULK_MOVE&amp;quot;)</span>;  
    <span class="keyword">if</span> <span class="params">(env != NULL)</span> {  
        hash_bulk_move = atoi<span class="params">(env)</span>;  
        <span class="keyword">if</span> <span class="params">(hash_bulk_move == <span class="number">0</span>)</span> {  
            hash_bulk_move = DEFAULT_HASH_BULK_MOVE;  
        }  
    }  
    <span class="keyword">if</span> <span class="params">(<span class="params">(ret = pthread_create<span class="params">(&amp;amp;maintenance_tid, NULL,  
                              assoc_maintenance_thread, NULL)</span>)</span> != <span class="number">0</span>)</span> {  
        fprintf<span class="params">(stderr, &amp;quot;Can&amp;apos;t create thread: %s\n&amp;quot;, strerror<span class="params">(ret)</span>)</span>;  
        return -<span class="number">1</span>;  
    }  
    return <span class="number">0</span>;  
}  
void stop_assoc_maintenance_thread<span class="params">()</span> {  
    mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
    do_run_maintenance_thread = <span class="number">0</span>;  
    pthread_cond_signal<span class="params">(&amp;amp;maintenance_cond)</span>;  
    mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
    <span class="comment">/* Wait for the maintenance thread to stop */</span>  
    pthread_join<span class="params">(maintenance_tid, NULL)</span>;  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23c66ca/" title="memcache（三）内存管理 -" itemprop="url">memcache（三）内存管理 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="memcached&#xFF08;&#x4E09;&#xFF09;&#x5185;&#x5B58;&#x7BA1;&#x7406;">memcached&#xFF08;&#x4E09;&#xFF09;&#x5185;&#x5B58;&#x7BA1;&#x7406;</h2><p>memcached&#x4F7F;&#x7528;&#x9884;&#x7533;&#x8BF7;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x7BA1;&#x7406;&#x5185;&#x5B58;&#x7684;&#x5206;&#x914D;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x5185;&#x5B58;&#x788E;&#x7247;&#x5316;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5982;&#x679C;&#x91C7;&#x7528;mallo&#x548C;free&#x6765;&#x52A8;&#x6001;&#x7684;&#x7533;&#x8BF7;&#x548C;&#x9500;&#x6BC1;&#x5185;&#x5B58;&#xFF0C;&#x5FC5;&#x7136;&#x4F1A;&#x4EA7;&#x751F;&#x5927;&#x91CF;&#x7684;&#x5185;&#x5B58;&#x788E;&#x7247;&#x3002;</p>
<h2 id="&#x57FA;&#x672C;&#x77E5;&#x8BC6;">&#x57FA;&#x672C;&#x77E5;&#x8BC6;</h2><p>slab&#xFF1A;&#x5185;&#x5B58;&#x5757;&#x662F;memcached&#x4E00;&#x6B21;&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x5143;&#xFF0C;&#x5728;memcached&#x4E2D;&#x4E00;&#x4E2A;slab&#x7684;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;1M&#xFF1B;</p>
<p>slabclass&#xFF1A;&#x7279;&#x5B9A;&#x5927;&#x5C0F;&#x7684;chunk&#x7684;&#x7EC4;&#x3002;</p>
<p>chunk&#xFF1A;&#x7F13;&#x5B58;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x4E00;&#x4E2A;slab&#x88AB;&#x5212;&#x5206;&#x4E3A;&#x82E5;&#x5E72;&#x4E2A;chunk&#xFF1B;</p>
<p>item&#xFF1A;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x5143;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;chunk&#x90FD;&#x4F1A;&#x5305;&#x542B;&#x4E00;&#x4E2A;item&#xFF1B;</p>
<p>factor:&#x589E;&#x957F;&#x56E0;&#x5B50;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;1.25&#xFF0C;&#x76F8;&#x90BB;slab&#x4E2D;&#x7684;item&#x5927;&#x5C0F;&#x4E0E;factor&#x6210;&#x6BD4;&#x4F8B;&#x5173;&#x7CFB;&#xFF1B;</p>
<h2 id="&#x57FA;&#x672C;&#x539F;&#x7406;">&#x57FA;&#x672C;&#x539F;&#x7406;</h2><p>memcached&#x4F7F;&#x7528;&#x9884;&#x5206;&#x914D;&#x65B9;&#x6CD5;&#xFF0C;&#x907F;&#x514D;&#x9891;&#x7E41;&#x7684;&#x8C03;&#x7528;malloc&#x548C;free&#xFF1B;</p>
<p>memcached&#x901A;&#x8FC7;&#x4E0D;&#x540C;&#x7684;slab&#x6765;&#x7BA1;&#x7406;&#x4E0D;&#x540C;chunk&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x4ECE;&#x800C;&#x6EE1;&#x8DB3;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>slab&#x7684;&#x7533;&#x8BF7;&#x662F;&#x901A;&#x8FC7;&#x5728;&#x4F7F;&#x7528;item&#x65F6;&#x7533;&#x8BF7;slab&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x628A;&#x5185;&#x5B58;&#x5207;&#x5272;&#x4E3A;&#x5927;&#x5C0F;&#x76F8;&#x540C;&#x7684;item&#xFF0C;&#x6302;&#x5728;&#x5230;slab&#x7684;&#x672A;&#x4F7F;&#x7528;&#x94FE;&#x8868;&#x4E0A;&#x3002;</p>
<p>&#x8FC7;&#x671F;&#x548C;&#x88AB;&#x5220;&#x9664;item&#x5E76;&#x4E0D;&#x4F1A;&#x88AB;free&#x6389;&#xFF0C;memcached&#x5E76;&#x4E0D;&#x4F1A;&#x5220;&#x9664;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF1B;</p>
<p>Memcached&#x4F1A;&#x4F18;&#x5148;&#x4F7F;&#x7528;&#x5DF2;&#x8D85;&#x65F6;&#x7684;&#x8BB0;&#x5F55;&#x7A7A;&#x95F4;&#xFF0C;&#x901A;&#x8FC7;LRU&#x7B97;&#x6CD5;&#xFF1B;</p>
<p>memcached&#x4F7F;&#x7528;lazy expiration&#xFFFD;&#xFFFD;&#xFFFD;&#x5224;&#x65AD;&#x5143;&#x7D20;&#x662F;&#x5426;&#x8FC7;&#x671F;&#xFF0C;&#x6240;&#x4EE5;&#x8FC7;&#x671F;&#x76D1;&#x89C6;&#x4E0A;&#x4E0D;&#x4F1A;&#x5360;&#x7528;cpu&#x65F6;&#x95F4;&#x3002;</p>
<h2 id="&#x6E90;&#x7801;&#x5206;&#x6790;">&#x6E90;&#x7801;&#x5206;&#x6790;</h2><p>&#x4E0B;&#x9762;&#x4E3B;&#x8981;&#x5206;&#x6790;memcached&#x7684;&#x5185;&#x5B58;&#x7533;&#x8BF7;&#x548C;&#x5B58;&#x50A8;&#x76F8;&#x5173;&#x4EE3;&#x7801;&#x3002;</p>
<h3 id="item">item</h3><p>item&#x662F;key/value&#x7684;&#x5B58;&#x50A8;&#x5355;&#x5143;&#x3002;</p>
<pre><code><span class="xml">typedef struct _stritem </span><span class="expression">{
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;      /* &amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;<span class="variable">slab-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>; */
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;    /* <span class="variable">hash</span> <span class="variable">chain</span> <span class="variable">next</span> */
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* &amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>540<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4; */
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* &amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4; */
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* &amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>; */
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;   /* &amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570; */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">suffix</span>&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6; */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* &amp;<span class="begin-block">#x</span>6240;&amp;<span class="begin-block">#x</span>6709;<span class="variable">slab</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">id</span> */
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span>&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6; */
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span>
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> */
    <span class="variable">union</span> {
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;
        <span class="variable">char</span> <span class="variable">end</span>;
    }</span><span class="xml"> data[]; /* cas|key|suffix|value */
} item;</span>
</code></pre><h3 id="slab&#x521D;&#x59CB;&#x5316;">slab&#x521D;&#x59CB;&#x5316;</h3><pre><code>void slabs_init(const size_t limit, const double factor, const bool prealloc) {
    int i = <span class="class">POWER_SMALLEST</span> - <span class="number">1</span>;
    unsigned int size = sizeof(item) + settings.chunk_size; /* &amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
    mem_limit = limit;
    if (prealloc) { /* &amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>; */
        ...
    }
    memset(slabclass, <span class="number">0</span>, sizeof(slabclass)); /* &amp;<span class="symbol">#x628A</span>;slabclass&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;slabclass&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;slab&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>; */
    while (++i &amp;lt; <span class="class">POWER_LARGEST</span> &amp;amp;&amp;amp; size &amp;lt;= settings.item_size_max / factor) {  /* &amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5BB9</span>;,&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;slab&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;max_size/factor */
        /* <span class="class">Make</span> sure items are always n-byte aligned */
        if (size % <span class="class">CHUNK_ALIGN_BYTES</span>)  /* &amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x9F50</span>; */
            size += <span class="class">CHUNK_ALIGN_BYTES</span> - (size % <span class="class">CHUNK_ALIGN_BYTES</span>);
        slabclass[i].size = size; /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;slabclass&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
        slabclass[i].perslab = settings.item_size_max / slabclass[i].size; /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x4E2D</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x91CF</span>; */
        size *= factor;  /* item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x968F</span>;factor&amp;<span class="symbol">#x9010</span>;&amp;<span class="symbol">#x6E10</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x5927</span>; */
        ...
    }
    /* &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab,&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;max_size&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item */
    power_largest = i;
    slabclass[power_largest].size = settings.item_size_max;
    slabclass[power_largest].perslab = <span class="number">1</span>;
    ...
}
</code></pre><p>&#x4ECE;&#x6E90;&#x7801;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#x540C;&#x4E00;&#x4E2A;slab&#x4E2D;&#x6240;&#x6709;&#x7684;item&#x7684;&#x5927;&#x5C0F;&#x90FD;&#x662F;&#x56FA;&#x5B9A;&#x7684;&#xFF0C;</p>
<h3 id="&#x7533;&#x8BF7;slab&#x5185;&#x5B58;">&#x7533;&#x8BF7;slab&#x5185;&#x5B58;</h3><pre><code><span class="xml">static void *do_slabs_alloc(const size_t size, unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;
    <span class="variable">void</span> *<span class="variable">ret</span> = <span class="variable">NULL</span>;
    <span class="variable">item</span> *<span class="variable">it</span> = <span class="variable">NULL</span>;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> || <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; <span class="variable">power</span>_<span class="variable">largest</span>) { /* &amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">id</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5408;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5; */
        <span class="variable">MEMCACHED</span>_<span class="variable">SLABS</span>_<span class="variable">ALLOCATE</span>_<span class="variable">FAILED</span>(<span class="variable">size</span>, 0);
        <span class="variable">return</span> <span class="variable">NULL</span>;
    }</span><span class="xml">
    p = &amp;amp;slabclass[id]; /* &amp;#x83B7;&amp;#x53D6;slab */
    assert(p-&amp;gt;sl_curr == 0 || ((item *)p-&amp;gt;slots)-&amp;gt;slabs_clsid == 0);
    /* fail unless we have space at the end of a recently allocated page,
       we have something on our freelist, or we could allocate a new page */
    if (! (p-&amp;gt;sl_curr != 0 || do_slabs_newslab(id) != 0)) </span><span class="expression">{ /*&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">sl</span>_<span class="variable">curr</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CA</span>1;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>5269;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>59;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">newslab</span>&amp;<span class="begin-block">#x</span>7533;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;*/
        /* <span class="variable">We</span> <span class="variable">don</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">have</span> <span class="variable">more</span> <span class="variable">memory</span> <span class="variable">available</span> */
        <span class="variable">ret</span> = <span class="variable">NULL</span>;
    }</span><span class="xml"> else if (p-&amp;gt;sl_curr != 0) </span><span class="expression">{ /* &amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>672<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>8<span class="variable">BE</span>5;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>76;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#x</span>8<span class="variable">BE</span>5;<span class="variable">item</span> */
        /* <span class="variable">return</span> <span class="variable">off</span> <span class="variable">our</span> <span class="variable">freelist</span> */
        <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;
        <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>;
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;
        <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr--</span>;
        <span class="variable">ret</span> = (<span class="variable">void</span> *)<span class="variable">it</span>;
    }</span><span class="xml">
    ...
    return ret;
}</span>
</code></pre><p>sl_curr&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5BB9;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x9700;&#x8981;&#x8C03;&#x7528;do_slabs_newslab&#x6765;&#x7533;&#x8BF7;slab&#x7A7A;&#x95F4;&#x3002;</p>
<pre><code>static int do_slabs_newslab(const unsigned int id) {
    slabclass_t *p = &amp;amp;slabclass[id];
    int len = settings.slab_reassign ? settings.item_size_max
        : p-&amp;gt;size * p-&amp;gt;perslab;
    char *ptr;
    /* <span class="number">1.</span> &amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x9650</span>;&amp;<span class="symbol">#x5236</span>;
         <span class="number">2.</span> &amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;
         <span class="number">3.</span> &amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;slab-&amp;gt;size*slab-&amp;gt;perslab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;
         <span class="number">4.</span>&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;grow_slab_list&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5927</span>;slab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; */
    if ((mem_limit &amp;amp;&amp;amp; mem_malloced + len &amp;gt; mem_limit &amp;amp;&amp;amp; p-&amp;gt;slabs &amp;gt; <span class="number">0</span>) ||
        (grow_slab_list(id) == <span class="number">0</span>) ||
        ((ptr = memory_allocate((size_t)len)) == <span class="number">0</span>)) {
        <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED</span>(id);
        return <span class="number">0</span>;
    }
    memset(ptr, <span class="number">0</span>, (size_t)len);
    split_slab_page_into_freelist(ptr, id); /* &amp;<span class="symbol">#x628A</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5230</span>;slots&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>; */
    p-&amp;gt;slab_list[p-&amp;gt;slabs++] = ptr;
    mem_malloced += len;
    <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE</span>(id);
    return <span class="number">1</span>;
}
</code></pre><p>&#x7533;&#x8BF7;&#x7A7A;&#x95F4;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;split_slab_page_into_freelist&#x51FD;&#x6570;&#x628A;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x5206;&#x914D;&#x5230;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x94FE;&#x8868;&#x4E2D;&#x3002;</p>
<pre><code><span class="xml">static void split_slab_page_into_freelist(char *ptr, const unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];
    <span class="variable">int</span> <span class="variable">x</span>;
    <span class="variable">for</span> (<span class="variable">x</span> = 0; <span class="variable">x</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">perslab</span>; <span class="variable">x</span>++) { /* &amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58; */
        <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, 0, <span class="variable">id</span>);
        <span class="variable">ptr</span> += <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>;
    }</span><span class="xml">
}
static void do_slabs_free(void *ptr, const size_t size, unsigned int id) </span><span class="expression">{
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;
    <span class="variable">item</span> *<span class="variable">it</span>;
    <span class="variable">...</span>
    <span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];
    /* &amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>628<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>6302;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>5230;<span class="variable">slots</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>589<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>0;<span class="variable">sl</span>_<span class="variable">curr</span> */
    <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">ptr</span>;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> |= <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span> = <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = <span class="variable">it</span>;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it</span>;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr</span>++;
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">requested</span> <span class="variable">-</span>= <span class="variable">size</span>;
    <span class="variable">return</span>;
}</span><span class="xml"></span>
</code></pre><h3 id="&#x83B7;&#x53D6;&#x9002;&#x5F53;&#x5927;&#x5C0F;&#x7684;item">&#x83B7;&#x53D6;&#x9002;&#x5F53;&#x5927;&#x5C0F;&#x7684;item</h3><p>&#x5728;do_item_alloc&#x4E2D;&#xFF0C;&#x8C03;&#x7528;&#x4E86;slabs_clsid&#x6765;&#x83B7;&#x53D6;&#x9002;&#x5408;&#x5B58;&#x50A8;&#x5F53;&#x524D;&#x5143;&#x7D20;&#x7684;slab id&#x3002;</p>
<pre><code>unsigned <span class="built_in">int</span> slabs_clsid(<span class="keyword">const</span> size_t <span class="built_in">size</span>) {
    <span class="built_in">int</span> res = POWER_SMALLEST;
    <span class="keyword">if</span> (<span class="built_in">size</span> == <span class="number">0</span>)
        <span class="keyword">return</span> <span class="number">0</span>;
    <span class="keyword">while</span> (<span class="built_in">size</span> &amp;gt; slabclass[res].<span class="built_in">size</span>)    <span class="comment">/* &amp;#x904D;&amp;#x5386;slabclass&amp;#x6765;&amp;#x627E;&amp;#x5230;&amp;#x9002;&amp;#x5408;size&amp;#x7684;item */</span>
        <span class="keyword">if</span> (res++ == power_largest)     <span class="comment">/* won&amp;apos;t fit in the biggest slab */</span>
            <span class="keyword">return</span> <span class="number">0</span>;
    <span class="keyword">return</span> res;
}
</code></pre><h2 id="&#x4F18;&#x7F3A;&#x70B9;">&#x4F18;&#x7F3A;&#x70B9;</h2><p>&#x5185;&#x5B58;&#x9884;&#x5206;&#x914D;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x5185;&#x5B58;&#x788E;&#x7247;&#x4EE5;&#x53CA;&#x907F;&#x514D;&#x52A8;&#x6001;&#x5206;&#x914D;&#x9020;&#x6210;&#x7684;&#x5F00;&#x9500;&#x3002;</p>
<p>&#x5185;&#x5B58;&#x5206;&#x914D;&#x662F;&#x7531;&#x5197;&#x4F59;&#x7684;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;slab&#x4E0D;&#x80FD;&#x88AB;&#x5B83;&#x6240;&#x62E5;&#x6709;&#x7684;chunk&#x5927;&#x5C0F;&#x6574;&#x9664;&#x65F6;&#xFF0C;slab&#x5C3E;&#x90E8;&#x5269;&#x4F59;&#x7684;&#x7A7A;&#x95F4;&#x5C31;&#x4F1A;&#x88AB;&#x4E22;&#x5F03;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x5206;&#x914D;&#x7684;&#x662F;&#x7279;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x6709;&#x6548;&#x5730;&#x5229;&#x7528;&#x6240;&#x6709;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4F8B;&#x5982;&#x5982;&#x679C;&#x5C06;100&#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5728;128&#x5B57;&#x8282;&#x7684;chunk&#x4E2D;&#xFF0C;&#x4F1A;&#x9020;&#x6210;28&#x5B57;&#x8282;&#x7684;&#x6D6A;&#x8D39;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a><a href="/tags/链表/">链表</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/234073c/" title="轻量的Memcached代理Twemproxy的部署 -" itemprop="url">轻量的Memcached代理Twemproxy的部署 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x8F7B;&#x91CF;&#x7684;Memcached&#x4EE3;&#x7406;Twemproxy&#x7684;&#x90E8;&#x7F72; </p>
<p>Twemproxy(&#x53C8;&#x79F0;&#x4E3A;nutcracker)&#x662F;&#x4E00;&#x4E2A;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;Redis&#x548C;Memcached&#x4EE3;&#x7406;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x51CF;&#x5C11;&#x5BF9;&#x540E;&#x7AEF;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x3002;&#x7531;Twitter&#x5F00;&#x6E90;&#x51FA;&#x6765;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7BA1;&#x7406;&#x5DE5;&#x5177;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5F25;&#x8865;Redis&#x548C;Memcached&#x5BF9;&#x96C6;&#x7FA4;(cluster)&#x7BA1;&#x7406;&#x6307;&#x51FA;&#x7684;&#x4E0D;&#x8DB3;&#x3002;</p>
<p>Twemproxy&#x662F;&#x4E00;&#x4E2A;&#x5FEB;&#x901F;&#x7684;&#x5355;&#x7EBF;&#x7A0B;&#x4EE3;&#x7406;&#x7A0B;&#x5E8F;&#xFF0C;&#x652F;&#x6301;Memcached ASCII&#x534F;&#x8BAE;&#x548C;&#x66F4;&#x65B0;&#x7684;Redis&#x534F;&#x8BAE;&#x3002;</p>
<p>Twemproxy&#x6700;&#x4E86;&#x4E0D;&#x8D77;&#x7684;&#x5730;&#x65B9;&#x5C31;&#x5728;&#x4E8E;&#x5B83;&#x80FD;&#x5728;&#x8282;&#x70B9;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#x5378;&#x8F7D;&#x5B83;&#xFF0C;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x4EE5;&#x540E;&#x91CD;&#x65B0;&#x5C1D;&#x8BD5;&#xFF08;&#x968F;&#x5373;&#xFF09;&#x8FDE;&#x63A5;&#xFF0C;&#x53C8;&#x6216;&#x8005;&#x53EF;&#x4EE5;&#x4E25;&#x683C;&#x6309;&#x7167;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5199;&#x7684;&#x952E;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#x3002;</p>
<h4 id="&#x5B89;&#x88C5;&#x90E8;&#x7F72;">&#x5B89;&#x88C5;&#x90E8;&#x7F72;</h4><p>&#x73B0;&#x6709;&#x6D4B;&#x8BD5;&#x673A;&#xFF1A;192.168.11.51/52/68</p>
<p>&#x5148;&#x5728;51&#x548C;52&#x6D4B;&#x8BD5;&#x673A;&#x4E0A;&#x5B89;&#x88C5;&#x597D;libevent&#x548C;memcached&#xFF0C;&#x5206;&#x522B;&#x542F;&#x52A8;&#x4E24;&#x4E2A;memcached&#x5B9E;&#x4F8B;&#xFF1B;</p>
<p>&#x7136;&#x540E;&#x5728;68&#x4E0A;&#x5B89;&#x88C5;&#x597D;twemproxy&#xFF0C;&#x914D;&#x7F6E;&#x597D;&#x53C2;&#x6570;&#xFF0C;&#x542F;&#x52A8;twemproxy&#x5B9E;&#x4F8B;&#x3002;</p>
<p>&#x5B89;&#x88C5;&#x548C;&#x542F;&#x52A8;memcached&#x5B9E;&#x4F8B; </p>
<p>&#x8BE6;&#x7EC6;&#x6B65;&#x9AA4;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;&#x4E4B;&#x524D;&#x7684;&#x535A;&#x6587; <a href="http://ultrasql.blog.51cto.com/9591438/1632179" target="_blank" rel="external">&#x300A;Memcached 1.4.22&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;&#x300B;</a> &#xFF0C;&#x5206;&#x522B;&#x542F;&#x52A8;&#x5982;&#x4E0B;&#x5B9E;&#x4F8B;&#xFF1A; </p>
<pre><code>/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.51 -p 11211 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached1.pid
/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.51 -p 11212 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached2.pid
/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.52 -p 11211 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached1.pid
/usr/<span class="keyword">local</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> 128 -<span class="keyword">u</span> memcached -<span class="keyword">l</span> 192.168.11.52 -p 11212 -c 1024 -P /<span class="keyword">var</span>/<span class="keyword">run</span>/memcached/memcached2.pid
</code></pre><p>&#x5B89;&#x88C5;&#x548C;&#x542F;&#x52A8;twemproxy&#x5B9E;&#x4F8B; </p>
<p>1 <strong>&#x3001;&#x5B89;&#x88C5;autoconf</strong></p>
<pre><code>cd /tmp
wget <span class="symbol">http:</span>/<span class="regexp">/ftp.gnu.org/gnu</span><span class="regexp">/autoconf/autoconf</span>-<span class="number">2.69</span>.tar.gz
tar zxvf autoconf-<span class="number">2.69</span>.tar.gz
cd autoconf-<span class="number">2.69</span>
./configure --prefix=<span class="regexp">/usr/</span>
make &amp;amp;&amp;amp; make install
</code></pre><p>2 <strong>&#x3001;&#x5B89;&#x88C5;twemproxy</strong></p>
<pre><code><span class="keyword">cd</span> /tmp
wget https:<span class="comment">//github.com/twitter/twemproxy/archive/master.zip</span>
unzip master.<span class="keyword">zip</span> -<span class="keyword">d</span> /usr/<span class="keyword">local</span>/
<span class="keyword">cd</span> /usr/<span class="keyword">local</span>
mv twemproxy-master twemproxy
<span class="keyword">cd</span> twemproxy
CFLAGS=&amp;quot;-ggdb3 -O0&amp;quot; autoreconf -fvi
./configure --prefix=/usr/<span class="keyword">local</span>/twemproxy --enable-debug=<span class="literal">log</span>
make &amp;amp;&amp;amp; make install
</code></pre><p>3 <strong>&#x3001;&#x67E5;&#x770B;&#x5E2E;&#x52A9;</strong></p>
<pre><code>[root@test01 twemproxy]# ./sbin/nutcracker -<span class="literal">h</span>

This is nutcracker-0.4.0
Usage: nutcracker [-?hVdDt] [-v verbosity level] [-o output <span class="keyword">file</span>]
[-c <span class="keyword">conf</span> <span class="keyword">file</span>] [-s stats port] [-a stats addr]
[-i stats interval] [-p pid <span class="keyword">file</span>] [-<span class="keyword">m</span> mbuf size]
Options:
-<span class="keyword">h</span>, --<span class="keyword">help</span> : this <span class="keyword">help</span>
-V, --<span class="keyword">version</span> : show <span class="keyword">version</span> and <span class="keyword">exit</span>
-t, --<span class="keyword">test</span>-<span class="keyword">conf</span> : <span class="keyword">test</span> configuration <span class="keyword">for</span> <span class="keyword">syntax</span> errors and <span class="keyword">exit</span>
-<span class="keyword">d</span>, --daemonize : <span class="keyword">run</span> <span class="keyword">as</span> a daemon
-<span class="keyword">D</span>, --<span class="keyword">describe</span>-stats : <span class="keyword">print</span> stats description and <span class="keyword">exit</span>
-v, --verbose=<span class="keyword">N</span> : <span class="keyword">set</span> logging level (default: 5, min: 0, max: 11)
-o, --output=S : <span class="keyword">set</span> logging <span class="keyword">file</span> (default: stderr)
-c, --<span class="keyword">conf</span>-<span class="keyword">file</span>=S : <span class="keyword">set</span> configuration <span class="keyword">file</span> (default: <span class="keyword">conf</span>/nutcracker.yml)
-s, --stats-port=<span class="keyword">N</span> : <span class="keyword">set</span> stats monitoring port (default: 22222)
-a, --stats-addr=S : <span class="keyword">set</span> stats monitoring ip (default: 0.0.0.0)
-i, --stats-interval=<span class="keyword">N</span> : <span class="keyword">set</span> stats aggregation interval <span class="keyword">in</span> msec (default: 30000 msec)
-p, --pid-<span class="keyword">file</span>=S : <span class="keyword">set</span> pid <span class="keyword">file</span> (default: off)
-<span class="keyword">m</span>, --mbuf-size=<span class="keyword">N</span> : <span class="keyword">set</span> size of mbuf chunk <span class="keyword">in</span> bytes (default: 16384 bytes)
</code></pre><p>4 <strong>&#x3001;&#x4FEE;&#x6539;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</strong></p>
<pre><code>mkdir <span class="regexp">/etc/</span>nutcracker
cp .<span class="regexp">/conf/</span>nutcracker.yml <span class="regexp">/etc/</span>nutcracker/
vi <span class="regexp">/etc/</span>nutcracker/nutcracker.yml
<span class="label">
memcached:</span>
<span class="string">listen:</span> <span class="number">192.168</span>.11.55:<span class="number">22121</span>
<span class="string">hash:</span> fnvla_64
<span class="string">distribution:</span> ketama
<span class="string">timeout:</span> <span class="number">400</span>
<span class="string">backlog:</span> <span class="number">1024</span>
<span class="string">preconnect:</span> <span class="literal">true</span>
<span class="string">auto_eject_hosts:</span> <span class="literal">true</span>
<span class="string">server_retry_timeout:</span> <span class="number">30000</span>
<span class="string">server_failure_limit:</span> <span class="number">3</span>
<span class="string">servers:</span>
- <span class="number">192.168</span>.11.51:<span class="number">11211</span>:<span class="number">1</span>
- <span class="number">192.168</span>.11.51:<span class="number">11212</span>:<span class="number">1</span>
- <span class="number">192.168</span>.11.52:<span class="number">11211</span>:<span class="number">1</span>
- <span class="number">192.168</span>.11.52:<span class="number">11212</span>:<span class="number">1</span>
</code></pre><p>&#x53C2;&#x6570;&#x89E3;&#x6790;&#xFF1A;</p>
<p>listen: &#x542F;&#x52A8;twemproxy&#x670D;&#x52A1;&#x7684;IP&#x548C;&#x7AEF;&#x53E3;</p>
<p>hash: &#x6307;&#x5B9A;&#x5177;&#x4F53;&#x7684;&#x54C8;&#x5E0C;&#x51FD;&#x6570;</p>
<p>distribution: &#x6307;&#x5B9A;&#x5177;&#x4F53;&#x7684;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;</p>
<p>preconnect: &#x4E00;&#x4E2A;&#x5E03;&#x5C14;&#x503C;&#xFF0C;&#x5982;&#x679C;&#x8BE5;&#x63A7;&#x4EF6;&#x7684;nutcracker&#x524D;&#x7AEF;&#x8FDE;&#x63A5;&#x5728;&#x8FD9;&#x4E2A;&#x6C60;&#x4E0A;&#x7684;&#x6240;&#x6709;&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x3002;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;&#x5047;</p>
<p>auto_eject_hosts: &#x662F;&#x5426;&#x5728;&#x7ED3;&#x70B9;&#x65E0;&#x6CD5;&#x54CD;&#x5E94;&#x7684;&#x65F6;&#x5019;&#x4E34;&#x65F6;&#x6458;&#x9664;&#x7ED3;&#x70B9;</p>
<p>server_retry_timeout: &#x91CD;&#x8BD5;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x6BEB;&#x79D2;&#xFF09;</p>
<p>server_failure_limit: &#x7ED3;&#x70B9;&#x6545;&#x969C;&#x591A;&#x5C11;&#x6B21;&#x5C31;&#x7B97;&#x6458;&#x9664;&#x6389;</p>
<p>servers: &#x4E0B;&#x9762;&#x8868;&#x793A;&#x6240;&#x6709;&#x7684;memcached&#x8282;&#x70B9;&#xFF08;IP:&#x7AEF;&#x53E3;&#x53F7;:&#x6743;&#x91CD;&#xFF09;</p>
<p>5 <strong>&#x3001;&#x914D;&#x7F6E;&#x4EE5;&#x670D;&#x52A1;&#x542F;&#x52A8;</strong></p>
<pre><code>cp .<span class="regexp">/scripts/</span>nutcracker.init <span class="regexp">/etc/</span>init.d/nutcracker
chmod <span class="number">755</span> <span class="regexp">/etc/</span>init.d/nutcracker
vi <span class="regexp">/etc/</span>init.d/nutcracker
</code></pre><ol>
<li><p>&#x65B0;&#x589E;&#x5B9A;&#x4E49;daemo</p>
<p> daemon=&quot;/usr/local/twemproxy/sbin/nutcracker&quot;</p>
</li>
<li><p>&#x66FF;&#x6362;&#x6240;&#x6709;</p>
<p> daemon —user ${USER} ${prog} $OPTIONS</p>
</li>
</ol>
<p>&#x4E3A;</p>
<pre><code><span class="label">${daemo}</span> <span class="label">$OPTIONS</span>

chkconfig --add nutcracker
chkconfig --level 35 nutcracker <span class="keyword">on</span>
chkconfig --<span class="keyword">list</span> nutcracker

vi /etc/profile
</code></pre><p>&#x5728;&#x91CC;&#x9762;&#x52A0;&#x5165;&#xFF1A;</p>
<pre><code>export <span class="constant">PATH=</span>&amp;quot;<span class="variable">$PATH</span><span class="symbol">:/usr/local/twemproxy/sbin&amp;quot</span>;

. /etc/profile
echo <span class="variable">$PATH</span>
</code></pre><p>6 <strong>&#x3001;&#x6D4B;&#x8BD5;&#x914D;&#x7F6E;&#x5E76;&#x542F;&#x52A8;&#x670D;&#x52A1;</strong></p>
<pre><code>nutcracker -t -c /etc/nutcracker/nutcracker.yml
<span class="keyword">service</span> nutcracker <span class="literal">start</span>
</code></pre><h4 id="&#x6570;&#x636E;&#x5199;&#x5165;&#x6D4B;&#x8BD5;">&#x6570;&#x636E;&#x5199;&#x5165;&#x6D4B;&#x8BD5;</h4><pre><code>[root@test01 init.d]# telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character is &amp;apos;^]&amp;apos;.
<span class="operator"><span class="keyword">set</span> key1 <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>
<span class="number">1</span>
STORED
<span class="keyword">set</span> key2 <span class="number">0</span> <span class="number">0</span> <span class="number">2</span>
<span class="number">22</span>
STORED
<span class="keyword">set</span> key3 <span class="number">0</span> <span class="number">0</span> <span class="number">3</span>
<span class="number">333</span>
STORED
<span class="keyword">set</span> key4 <span class="number">0</span> <span class="number">0</span> <span class="number">4</span>
<span class="number">4444</span>
STORED
<span class="keyword">set</span> key5 <span class="number">0</span> <span class="number">0</span> <span class="number">5</span>
<span class="number">55555</span>
STORED
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test01 ~]# telnet <span class="number">192.168</span>.11.51 <span class="number">11211</span>

Trying <span class="number">192.168</span>.11.51...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.51.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test01 ~]# telnet <span class="number">192.168</span>.11.51 <span class="number">11212</span>

Trying <span class="number">192.168</span>.11.51...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.51.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test02 ~]# telnet <span class="number">192.168</span>.11.52 <span class="number">11211</span>

Trying <span class="number">192.168</span>.11.52...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.52.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.

[root@test02 ~]# telnet <span class="number">192.168</span>.11.52 <span class="number">11212</span>

Trying <span class="number">192.168</span>.11.52...
Connected <span class="keyword">to</span> <span class="number">192.168</span>.11.52.
<span class="keyword">Escape</span> <span class="built_in">character</span> <span class="keyword">is</span> &amp;apos;</span>^]&amp;apos;.
get key1
VALUE key1 0 1
1
<span class="operator"><span class="keyword">END</span>
<span class="keyword">get</span> key2
<span class="keyword">VALUE</span> key2 <span class="number">0</span> <span class="number">2</span>
<span class="number">22</span>
<span class="keyword">END</span>
<span class="keyword">get</span> key3
<span class="keyword">VALUE</span> key3 <span class="number">0</span> <span class="number">3</span>
<span class="number">333</span>
<span class="keyword">END</span>
<span class="keyword">get</span> key4
<span class="keyword">VALUE</span> key4 <span class="number">0</span> <span class="number">4</span>
<span class="number">4444</span>
<span class="keyword">END</span>
<span class="keyword">get</span> key5
<span class="keyword">VALUE</span> key5 <span class="number">0</span> <span class="number">5</span>
<span class="number">55555</span>
<span class="keyword">END</span>
quit
<span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="keyword">foreign</span> host.</span>
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6570;&#x636E;&#x5168;&#x90E8;&#x4ECE;52&#x7684;11212&#x7AEF;&#x53E3;&#x83B7;&#x53D6;&#x5230;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x505C;&#x6389;52&#x7684;11212&#x7AEF;&#x53E3;&#x670D;&#x52A1;&#x3002;</p>
<p>&#x7EE7;&#x7EED;&#x5F80;&#x4EE3;&#x7406;&#x5199;&#x6570;&#x636E;&#x3002;</p>
<pre><code><span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
set username 0 0 6
ryanxu
STORED
set aa 0 0 2
aa
STORED
quit
Connection <span class="keyword">closed</span> by foreign host.

<span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
get key1
SERVER_ERROR Connection refused
Connection <span class="keyword">closed</span> by foreign host.

<span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
get key1
SERVER_ERROR Connection refused
Connection <span class="keyword">closed</span> by foreign host.

<span class="comment">[root@test03 init.d]</span># telnet 192.168.11.55 11211

Trying 192.168.11.55...
Connected to 192.168.11.55.
Escape character <span class="keyword">is</span> &amp;apos;^]&amp;apos;.
get key1
END
get key2
END
get key3
END
quit
Connection <span class="keyword">closed</span> by foreign host.
</code></pre><p>&#x4E00;&#x53F0;memcached &#x6302;&#x6389;&#x540E;&#xFF0C;twemproxy &#x80FD;&#x591F;&#x81EA;&#x52A8;&#x6458;&#x9664;&#x3002;&#x6062;&#x590D;&#x540E;&#xFF0C;twemproxy &#x80FD;&#x591F;&#x81EA;&#x52A8;&#x8BC6;&#x522B;&#x3001;&#x6062;&#x590D;&#x5E76;&#x91CD;&#x65B0;&#x52A0;&#x5165;&#x5230; memcached &#x7EC4;&#x4E2D;&#x91CD;&#x65B0;&#x4F7F;&#x7528;&#x3002;</p>
<h4 id="&#x95EE;&#x9898;&#x603B;&#x7ED3;">&#x95EE;&#x9898;&#x603B;&#x7ED3;</h4><p>1&#xFF09;.yml&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x503C;&#x5BF9;&#x5206;&#x9694;&#x7B26;&#x201D;:&#x201D;&#x540E;&#x9700;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x7A7A;&#x683C;&#x3002;</p>
<p>2&#xFF09;&#x4E0D;&#x540C;&#x5C42;&#x6B21;&#x7684;&#x53C2;&#x6570;&#x9700;&#x8981;&#x7F29;&#x8FDB;&#x533A;&#x5206;&#xFF0C;&#x6700;&#x597D;&#x4F7F;&#x7528;tab&#x952E;&#x7F29;&#x8FDB;&#xFF0C;&#x5426;&#x5219;nutcracker&#x8FDB;&#x7A0B;&#x4E0D;&#x80FD;&#x542F;&#x52A8;&#x3002;</p>
<p>3&#xFF09;&#x5728;auto_eject_hosts: true&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5173;&#x95ED;&#x4E00;&#x4E2A;memcached&#x5B9E;&#x4F8B;&#x540E;&#xFF0C;&#x5199;&#x5165;&#x6570;&#x636E;&#x8FD8;&#x662F;&#x63D0;&#x793A;&#x201C;(error) ERR Connection refused&#x201D;&#x3002;&#x8FD9;&#x4E2A;&#x4E0E;server_retry_timeout&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x592A;&#x5C0F;&#x6709;&#x5173;&#xFF0C;30000&#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x597D;&#x7684;&#x9009;&#x62E9;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2348d83/" title="memcache源代码研究 - 数据结构篇（上） -" itemprop="url">memcache源代码研究 - 数据结构篇（上） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="LIBEVENT_THREAD">LIBEVENT_THREAD</h4><p>&#x2003;&#x2003; LIBEVENT_THREAD &#x4EE3;&#x8868;&#x7684;&#x662F; memcache &#x91CC;&#x7684; worker thread&#xFF0C;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code>typedef struct {  
    pthread_t thread_id;        /<span class="keyword">*</span> unique ID of this thread <span class="keyword">*</span>/
    struct event_base <span class="keyword">*</span>base;    /<span class="keyword">*</span> libevent handle this thread uses <span class="keyword">*</span>/
    struct event notify_event;  /<span class="keyword">*</span> listen event for notify pipe <span class="keyword">*</span>/
    int notify_receive_fd;      /<span class="keyword">*</span> receiving end of notify pipe <span class="keyword">*</span>/
    int notify_send_fd;         /<span class="keyword">*</span> sending end of notify pipe <span class="keyword">*</span>/
    struct thread_stats stats;  /<span class="keyword">*</span> Stats generated by this thread <span class="keyword">*</span>/
    struct conn_queue <span class="keyword">*</span>new_conn_queue; /<span class="keyword">*</span> queue of new connections to handle <span class="keyword">*</span>/
    cache_t <span class="keyword">*</span>suffix_cache;      /<span class="keyword">*</span> suffix cache <span class="keyword">*</span>/
} LIBEVENT_THREAD;
</code></pre><p>&#x91CC;&#x9762;&#x7684;&#x6570;&#x636E;&#x6210;&#x5458;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E; main thread &#x4E0E; worker thread &#x4E4B;&#x95F4;&#x901A;&#x4FE1;&#x7684;&#x3002;&#x4E3B;&#x8FDB;&#x7A0B;&#x6BCF;&#x6B21;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; pipe&#xFF0C;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x91CC;&#x5BF9;&#x5E94;&#x7684;&#x662F; notify_send_fd &#x548C; notify_receive_fd &#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code><span class="atom">void</span> <span class="atom">memcached_thread_init</span>(...) {  
    ...
    <span class="atom">for</span> (<span class="atom">i</span> = <span class="number">0</span>; <span class="atom">i</span> &amp;<span class="atom">lt</span>; <span class="atom">nthreads</span>; <span class="atom">i</span>++) {
    <span class="atom">int</span> <span class="atom">fds</span>[<span class="number">2</span>];
    <span class="atom">if</span> (<span class="atom">pipe</span>(<span class="atom">fds</span>)) { // &amp;<span class="atom">lt</span>;-- &amp;#<span class="atom">x521B</span>;&amp;#<span class="atom">x5EFA</span>; <span class="atom">pipe</span>
        ...
    }
    <span class="atom">threads</span>[<span class="atom">i</span>].<span class="atom">notify_receive_fd</span> = <span class="atom">fds</span>[<span class="number">0</span>];
    <span class="atom">threads</span>[<span class="atom">i</span>].<span class="atom">notify_send_fd</span> = <span class="atom">fds</span>[<span class="number">1</span>];
    <span class="atom">setup_thread</span>(&amp;<span class="atom">amp</span>;<span class="atom">threads</span>[<span class="atom">i</span>]);
       ...
    }
    ...
}
</code></pre><p>&#x6BCF;&#x5F53;&#x6709;&#x65B0;&#x7684;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3B;&#x8FDB;&#x7A0B;&#x5C31;&#x4F1A;&#x5F80; notify_send_fd &#x91CC;&#x5199;&#x6570;&#x636E;&#x6765;&#x901A;&#x77E5;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF0C;&#x5B50;&#x7EBF;&#x7A0B;&#x63A5;&#x5230;&#x6D88;&#x606F;&#x4E4B;&#x540E;&#x4F1A;&#x521B;&#x5EFA;&#x65B0;&#x7684;connection&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code><span class="xml">void dispatch_conn_new(...) </span><span class="expression">{  
    <span class="variable">CQ</span>_<span class="variable">ITEM</span> *<span class="variable">item</span> = <span class="variable">cqi</span>_<span class="variable">new</span>(); /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> <span class="variable">CQ</span>_<span class="variable">ITEM</span> &amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>8;&amp;<span class="begin-block">#x</span>5173;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5404;&amp;<span class="begin-block">#x</span>79<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;
    <span class="variable">char</span> <span class="variable">buf</span>[1];
    <span class="variable">...</span>
    <span class="variable">int</span> <span class="variable">tid</span> = (<span class="variable">last</span>_<span class="variable">thread</span> + 1) % <span class="variable">settings.num</span>_<span class="variable">threads</span>;
    <span class="variable">LIBEVENT</span>_<span class="variable">THREAD</span> *<span class="variable">thread</span> = <span class="variable">threads</span> + <span class="variable">tid</span>; /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>9009;&amp;<span class="begin-block">#x</span>62<span class="variable">E</span>9;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>50;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;
    <span class="variable">last</span>_<span class="variable">thread</span> = <span class="variable">tid</span>;
    /<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>5404;&amp;<span class="begin-block">#x</span>79<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span> = <span class="variable">sfd</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">init</span>_<span class="variable">state</span> = <span class="variable">init</span>_<span class="variable">state</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">event</span>_<span class="variable">flags</span> = <span class="variable">event</span>_<span class="variable">flags</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span> = <span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>;
    <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span> = <span class="variable">transport</span>; 
    <span class="variable">cq</span>_<span class="variable">push</span>(<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">new</span>_<span class="variable">conn</span>_<span class="variable">queue</span>, <span class="variable">item</span>); /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>42;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>538<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5165;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7684; <span class="variable">connection</span> &amp;<span class="begin-block">#x</span>961<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;
    <span class="variable">...</span>
    <span class="variable">buf</span>[0] = &amp;<span class="variable">apos</span>;<span class="variable">c</span>&amp;<span class="variable">apos</span>;;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">write</span>(<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">notify</span>_<span class="variable">send</span>_<span class="variable">fd</span>, <span class="variable">buf</span>, 1) != 1) { /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7; <span class="variable">pipe</span> &amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>77<span class="variable">E</span>5; <span class="variable">worker</span> <span class="variable">thread</span>
        <span class="variable">perror</span>(&amp;<span class="variable">quot</span>;<span class="variable">Writing</span> <span class="variable">to</span> <span class="variable">thread</span> <span class="variable">notify</span> <span class="variable">pipe</span>&amp;<span class="variable">quot</span>;);
    }</span><span class="xml">
}



// &amp;#x5B50;&amp;#x7EBF;&amp;#x7A0B;&amp;#x63A5;&amp;#x6536;&amp;#x8BF7;&amp;#x6C42;&amp;#x901A;&amp;#x77E5;
static void thread_libevent_process(int fd, short which, void *arg) </span><span class="expression">{  
    <span class="variable">...</span>
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">read</span>(<span class="variable">fd</span>, <span class="variable">buf</span>, 1) != 1)
        <span class="variable">...</span>
    <span class="variable">switch</span> (<span class="variable">buf</span>[0]) {
    <span class="variable">case</span> &amp;<span class="variable">apos</span>;<span class="variable">c</span>&amp;<span class="variable">apos</span>;:
    <span class="variable">item</span> = <span class="variable">cq</span>_<span class="variable">pop</span>(<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">new</span>_<span class="variable">conn</span>_<span class="variable">queue</span>); /<span class="end-block">/ </span>&amp;<span class="variable"><span class="keyword">lt</span></span>;<span class="variable">--</span> &amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;&amp;<span class="begin-block">#x</span>961<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>91<span class="variable">CC</span>;&amp;<span class="begin-block">#x</span>9762;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>42;
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">NULL</span> != <span class="variable">item</span>) {
        /<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>521<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EFA</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;
        <span class="variable">conn</span> *<span class="variable">c</span> = <span class="variable">conn</span>_<span class="variable">new</span>(<span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">init</span>_<span class="variable">state</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">event</span>_<span class="variable">flags</span>,
                           <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>, <span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">base</span>);
       <span class="variable">...</span>
    }</span><span class="xml">
        break;
   ...
   }
}</span>
</code></pre><h4 id="connection">connection</h4><p>&#x2003;&#x2003; connection &#x4EE3;&#x8868;&#x7684;&#x662F;&#x670D;&#x52A1;&#x63A5;&#x6536;&#x7684;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x3002;&#x5982;&#x4E0A;&#x9762;&#x6CE8;&#x91CA;&#x91CC;&#x63D0;&#x5230;&#x7684;&#xFF0C;&#x662F;&#x5728;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x63A5;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#x521B;&#x5EFA;&#x7684;&#x3002; connection &#x5185;&#x90E8;&#x7ED3;&#x6784;&#x6BD4;&#x8F83;&#x5E9E;&#x5927;&#xFF0C;&#x58F0;&#x660E;&#x4E86;&#x4E0E;&#x8FDE;&#x63A5;&#x76F8;&#x5173;&#x7684;&#x5404;&#x79CD;&#x53D8;&#x91CF;&#x3002;&#x6BD4;&#x5982;&#x5176;&#x4E2D;&#x7684; rbuf &#x548C; rbytes &#xFF0C;&#x5B83;&#x4EEC;&#x662F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x4ECE; socket &#x8FDE;&#x63A5;&#x4E2D;&#x8BFB;&#x53D6;&#x7684;&#x5185;&#x5BB9;&#x7684;&#xFF0C;&#x8FD8;&#x6709; rcurr &#x5219;&#x662F;&#x7528;&#x6765;&#x6807;&#x8BB0; rbuf &#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x5230;&#x4E86;&#x54EA;&#x91CC;&#x3002; </p>
<p>memcached &#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x53EB;&#x505A; conns &#x7684;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x7528;&#x6765;&#x7F13;&#x5B58;&#x6240;&#x6709;&#x8FDE;&#x63A5;&#x3002;&#x5F53;&#x8C03;&#x7528; conn_new &#x51FD;&#x6570;&#x521B;&#x5EFA;&#x65B0;&#x7684; connection &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5148;&#x4ECE; conns &#x5F53;&#x4E2D;&#x67E5;&#x8BE2;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x4E86;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5219;&#x8FD4;&#x56DE;&#x73B0;&#x6709;&#x7684; connection &#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x624D;&#x521B;&#x5EFA;&#x65B0;&#x7684;&#xFF0C;&#x4EE3;&#x7801;&#x5927;&#x81F4;&#x5982;&#x4E0B;&#xFF1A; </p>
<pre><code>conn *conn_new(...) {  
    conn *<span class="built_in">c</span>;
    <span class="built_in">assert</span>(sfd &amp;gt;= <span class="number">0</span> &amp;amp;&amp;amp; sfd &amp;lt; max_fds);
    <span class="built_in">c</span> = conns[sfd];
    <span class="keyword">if</span> (<span class="type">NULL</span> == <span class="built_in">c</span>) {
        <span class="comment">// &amp;#x521B;&amp;#x5EFA;&amp;#x65B0;&amp;#x7684; connection</span>
        ...
        <span class="built_in">c</span>-&amp;gt;sfd = sfd;
        conns[sfd] = <span class="built_in">c</span>;
    }
    <span class="comment">// &amp;#x4F7F;&amp;#x7528;&amp;#x7F13;&amp;#x5B58;&amp;#x7684; connection</span>
    ...
    <span class="keyword">return</span> <span class="built_in">c</span>;
}
</code></pre><h4 id="slabclass_t_&amp;_item">slabclass_t &amp; item</h4><p>slabclass_t &#x548C; item &#x662F; memcache &#x91CC;&#x4E0E;&#x7F13;&#x5B58;&#x529F;&#x80FD;&#x548C;&#x5185;&#x5B58;&#x7BA1;&#x7406;&#x76F8;&#x5173;&#x8054;&#x7684;&#x5173;&#x952E;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002; </p>
<p>To be continued …</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/数据结构/">数据结构</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/234ccfd/" title="深入学习Memcached -" itemprop="url">深入学习Memcached -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x7531;&#x4E8E;&#x5B9E;&#x9A8C;&#x5BA4;&#x5728;&#x4E00;&#x4E2A;&#x9879;&#x76EE;&#x4E2D;&#x7528;&#x5230;&#x4E86;Memcached&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#xFF0C;&#x81EA;&#x5DF1;&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x4E5F;&#x5BF9;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x672C;&#x6587;&#x5C31;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x81EA;&#x5DF1;&#x7684;&#x6536;&#x83B7;&#xFF0C;&#x8FD8;&#x662F;&#x4ECE;Memcached&#x662F;&#x4EC0;&#x4E48;&#x8C08;&#x8D77;&#x5427;&#x3002;</p>
<h2 id="Memcached&#x662F;&#x4EC0;&#x4E48;">Memcached&#x662F;&#x4EC0;&#x4E48;</h2><p>Memcached&#x662F;&#x4E00;&#x6B3E;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x4F7F;&#x7528;&#x5B83;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;&#x5E94;&#x7528;&#x7CFB;&#x7EDF;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x7684;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#xFF0C;&#x51CF;&#x8F7B;&#x4E86;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#xFF0C;&#x5E76;&#x4E14;&#x63D0;&#x5347;&#x4E86;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x54CD;&#x5E94;&#x901F;&#x5EA6;&#x3002;&#x53EF;&#x4EE5;&#x5C06;Memcached&#x6BD4;&#x4F5C;&#x4E00;&#x4E2A;&#x5DE8;&#x5927;&#x7684;&#x3001;&#x5B58;&#x50A8;&#x4E86;&#x5F88;&#x591A; &#x5BF9;&#x7684;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x901A;&#x8FC7;key&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x6216;&#x67E5;&#x8BE2;&#x4EFB;&#x610F;&#x7684;&#x6570;&#x636E;&#x3002;&#x5B83;&#x7684;&#x5B9E;&#x73B0;&#x4F9D;&#x8D56;&#x4E8E;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;&#x4E0B;&#x9762;&#x5C31;&#x8BE6;&#x7EC6;&#x8BB2;&#x8BB2; <strong>&#x6700;&#x8FD1;&#x6700;&#x5C11;&#x4F7F;&#x7528;&#xFF08;LRU&#xFF09;&#x7B97;&#x6CD5;</strong> &#x548C; <strong>&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;</strong> &#x3002; </p>
<h2 id="LRU&#x7B97;&#x6CD5;">LRU&#x7B97;&#x6CD5;</h2><p>&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x4E2D;&#x4E5F;&#x5305;&#x62EC;&#x8BE5;&#x7B97;&#x6CD5;&#xFF0C;&#x8FD9;&#x79CD;&#x7B97;&#x6CD5;&#x975E;&#x5E38;&#x9002;&#x5408;&#x4E8E;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#x3002;&#x5B83;&#x57FA;&#x4E8E;&#x4E00;&#x79CD;&#x5047;&#x8BBE;&#xFF1A;&#x8FC7;&#x53BB;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x4F7F;&#x7528;&#x9891;&#x7387;&#x6700;&#x4F4E;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5C06;&#x6765;&#x4E5F;&#x4F1A;&#x5F88;&#x5C11;&#x4F7F;&#x7528;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x6211;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x7684;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;LRU&#x7B97;&#x6CD5;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x4E86;&#x57FA;&#x672C;&#x7684;&#x7F13;&#x5B58;&#x529F;&#x80FD;&#xFF0C;&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6539;&#x8FDB;&#x7684;&#x4E00;&#x70B9;&#x662F;&#x8BE5;&#x7F13;&#x5B58;&#x5E94;&#x8BE5;&#x662F;&#x5355;&#x4F8B;&#x7684;&#x3002; </p>
<pre><code><span class="package"><span class="keyword">package</span> <span class="title">colin</span>.<span class="title">cache</span>;  </span>
</code></pre><p>/**  </p>
<ul>
<li></li>
<li>@author Colin Wang  </li>
<li><p>Created on Apr 18, 2015<br>*/<br>public class LRUCache {<br> private static final int DEFAULT_MAX_SIZE = 10;<br> private Object[] elements;<br> private int size;  </p>
<p> public LRUCache(int maxSize) {  </p>
<pre><code>elements = <span class="keyword">new</span> <span class="built_in">Object</span>[maxSize];  
</code></pre><p> }  </p>
<p> public LRUCache() {  </p>
<pre><code>this<span class="list">(<span class="keyword">DEFAULT_MAX_SIZE</span>)</span><span class="comment">;  </span>
</code></pre><p> }  </p>
<p> public boolean isEmpty() {  </p>
<pre><code><span class="keyword">return</span> <span class="built_in">size</span> == <span class="number">0</span>;  
</code></pre><p> }  </p>
<p> public int size() {  </p>
<pre><code><span class="keyword">return</span> <span class="built_in">size</span>;  
</code></pre><p> }  </p>
<p> public boolean isFull() {  </p>
<pre><code><span class="keyword">return</span> <span class="built_in">size</span> == elements.<span class="built_in">length</span>;  
</code></pre><p> }  </p>
<p> /**  </p>
<ul>
<li>&#x8FD4;&#x56DE;&#x5143;&#x7D20;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;  </li>
<li></li>
<li>@param element  </li>
<li><p>@return<br>*/<br>public int indexOf(Object element) {<br> for (int i = 0; i &lt; size; i++) {  </p>
<pre><code><span class="keyword">if</span> (element.<span class="keyword">equals</span>(elements[i])) {  
<span class="command">    return</span> i;  
}  
</code></pre><p> }<br> return -1;<br>}  </p>
<p>public Object push(Object element) {<br> int index = -1;<br> if (!isFull() &amp;&amp; indexOf(element) == -1) {  </p>
<pre><code>// &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542B</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x63D2</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
elements[size++] = element;  
</code></pre><p> } else if (isFull() &amp;&amp; indexOf(element) == -1) {  </p>
<pre><code>// &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542B</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x63D2</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
for (int i = <span class="number">0</span>; i &amp;lt; size - <span class="number">1</span>; i++) {  
    elements[i] = elements[i + <span class="number">1</span>];  
}  
elements[size - <span class="number">1</span>] = element;  
</code></pre><p> } else {  </p>
<pre><code><span class="keyword">index</span> = indexOf(element);  
<span class="keyword">for</span> (int i = <span class="keyword">index</span>; i &amp;lt; size - <span class="number">1</span>; i++) <span class="comment">{  
    elements[i] = elements[i + 1];  
}</span>  
elements[size - <span class="number">1</span>] = element;  
</code></pre><p> }<br> return index == -1 ? null : elements[index];<br>}  </p>
<p>public void show() {<br> for (int i = 0; i &lt; size; i++) {  </p>
<pre><code><span class="tag">System</span><span class="class">.out</span><span class="class">.print</span>(<span class="tag">elements</span><span class="attr_selector">[i]</span><span class="class">.toString</span>() + &amp;<span class="tag">quot</span>; &amp;<span class="tag">quot</span>;);  
</code></pre><p> }<br>}<br>}</p>
</li>
</ul>
</li>
</ul>
<h2 id="&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;">&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;</h2><p>&#x8BE5;&#x7B97;&#x6CD5;&#x5728;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#x4E2D;&#x5E94;&#x7528;&#x5341;&#x5206;&#x5E7F;&#x6CDB;&#xFF0C;&#x5B83;&#x7684;&#x5173;&#x952E;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#x4F7F;&#x7528;&#x73AF;&#x5F62;&#x7684;&#x54C8;&#x5E0C;&#x7A7A;&#x95F4;&#x3002;&#x9996;&#x5148;&#x6211;&#x4EEC;&#x5148;&#x8003;&#x8651;&#x4E00;&#x4E0B;JDK&#x4E2D;HashMap&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;HashMap&#x6709;&#x4E00;&#x4E2A;&#x521D;&#x59CB;&#x5BB9;&#x91CF;&#x548C;&#x88C5;&#x8F7D;&#x56E0;&#x5B50;&#xFF0C;&#x5F53;HashMap&#x4E2D;&#x5143;&#x7D20;&#x7684;&#x6570;&#x91CF;&#x8FBE;&#x5230;&#x4E86; &#x521D;&#x59CB;&#x5BB9;&#x91CF;*&#x88C5;&#x8F7D;&#x56E0;&#x5B50; &#x8FD9;&#x4E48;&#x591A;&#x65F6;&#xFF0C;HashMap&#x5C31;&#x4F1A;&#x8FDB;&#x884C;&#x6269;&#x5BB9;&#xFF08;&#x53D8;&#x4E3A;&#x539F;&#x6765;&#x7684;2&#x500D;&#xFF09;&#x7136;&#x540E;&#x518D;&#x54C8;&#x5E0C;&#xFF0C;&#x5F53;&#x5143;&#x7D20;&#x5F88;&#x591A;&#x65F6;&#xFF0C;&#x8FD9;&#x79CD;&#x518D;&#x54C8;&#x5E0C;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5F88;&#x6D88;&#x8017;&#x8D44;&#x6E90;&#x7684;&#x3002;&#x5C3D;&#x7BA1;HashMap&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x79CD;&#x6BD4;&#x8F83;&#x4F18;&#x5316;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x6BD4;&#x5982;HashMap&#x7684;&#x5927;&#x5C0F;&#x603B;&#x662F;&#x4E3A;2&#x7684;n&#x6B21;&#x5E42;&#xFF08;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;16&#xFF09;&#xFF0C;&#x8FD9;&#x6837;&#x65E2;&#x51CF;&#x5C11;&#x4E86;&#x54C8;&#x5E0C;&#x78B0;&#x649E;&#x7684;&#x51E0;&#x7387;&#xFF08;&#x56E0;&#x4E3A; 2&#x7684;n&#x6B21;&#x5E42;-1 &#x8F6C;&#x5316;&#x4E3A;&#x4E8C;&#x8FDB;&#x5236;&#x65F6;&#x6240;&#x6709;&#x4F4D;&#x5747;&#x4E3A;1&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x907F;&#x514D;&#x4E86;&#x67D0;&#x4E9B;&#x4F4D;&#x4E0D;&#x80FD;&#x53D1;&#x6325;&#x4F5C;&#x7528;&#xFF09;&#xFF0C;&#x53C8;&#x589E;&#x52A0;&#x4E86;HashMap&#x5728;&#x5B9A;&#x4F4D;&#x5143;&#x7D20;&#x65F6;&#x7684;&#x6548;&#x7387;&#xFF0C;&#x6BD4;&#x5982;&#x65B9;&#x6CD5;&#xFF1A; </p>
<pre><code><span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>{  
<span class="keyword">return</span> h &amp;amp; (length-<span class="number">1</span>);  
</code></pre><p>}</p>
<p>&#x5F53;length&#x603B;&#x662F;2&#x7684;n&#x6B21;&#x65B9;&#x65F6;&#xFF0C; h &amp; (length - 1) &#x8FD0;&#x7B97;&#x7B49;&#x4EF7;&#x4E8E;&#x5BF9;length&#x53D6;&#x6A21;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x4E9B;&#x4ECD;&#x7136;&#x4E0D;&#x80FD;&#x5B8C;&#x5168;&#x5F25;&#x8865;&#x6240;&#x6709;&#x5143;&#x7D20;&#x5FC5;&#x987B;&#x5168;&#x90E8;&#x91CD;&#x65B0;&#x54C8;&#x5E0C;&#x7684;&#x5F31;&#x70B9;&#x3002;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x62E5;&#x6709;N&#x53F0;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x70ED;&#x6570;&#x636E;&#x5DF2;&#x7ECF;&#x901A;&#x8FC7;Hash&#x7B97;&#x6CD5;&#x6620;&#x5C04;&#x5230;&#x4E86;&#x8FD9;N&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x5F53;&#x5176;&#x4E2D;&#x4E00;&#x53F0;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x6302;&#x6389;&#xFF0C;&#xFFFD;&#xFFFD;&#xFFFD;&#x8005;&#x6211;&#x4EEC;&#x53C8;&#x65B0;&#x6DFB;&#x4E86;&#x51E0;&#x53F0;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x6765;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x5DF2;&#x7ECF;&#x6620;&#x5C04;&#x597D;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5C06;&#x5931;&#x6548;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x7684;&#x540E;&#x7AEF;&#x6570;&#x636E;&#x5E93;&#x5C06;&#x4F1A;&#x627F;&#x53D7;&#x8FD9;&#x4E00;&#x5207;&#xFF01;&#x6240;&#x4EE5;&#xFF0C;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x5C31;&#x6D3E;&#x4E0A;&#x7528;&#x573A;&#x4E86;&#xFF0C;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x63D0;&#x5230;&#xFF0C;&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x73AF;&#x5F62;&#x7684;&#x54C8;&#x5E0C;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/234a10b.jpg" alt=""></p>
<p>&#x5E38;&#x89C4;&#x7684;Hash&#x7B97;&#x6CD5;&#x4E3A;&#x5C06;&#x67D0;&#x4E2A;key&#x6620;&#x5C04;&#x4E3A;&#x4E00;&#x4E2A;32&#x4F4D;&#x6574;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x8FD9;0&#x81F3;2^32-1&#x7684;&#x6570;&#x503C;&#x7A7A;&#x95F4;&#x9996;&#x4F4D;&#x76F8;&#x63A5;&#x4FBF;&#x5F62;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x73AF;&#x3002;&#x7136;&#x540E;&#x628A;&#x6211;&#x4EEC;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x901A;&#x8FC7;&#x6563;&#x5217;&#xFF08;&#x5BF9;IP&#x6216;&#x673A;&#x5668;&#x540D;&#x7B49;&#x8FDB;&#x884C;&#x6563;&#x5217;&#xFF09;&#x6620;&#x5C04;&#x5230;&#x8FD9;&#x4E2A;&#x73AF;&#x4E0A;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;&#x6563;&#x5217;&#x5230;&#x67D0;&#x4E2A;&#x4F4D;&#x7F6E;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x628A;&#x8BE5;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x5230; <strong>&#x987A;&#x65F6;&#x9488;&#x65B9;&#x5411;</strong> &#x79BB;&#x5B83;&#x6700;&#x8FD1;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7ED3;&#x70B9;&#x4E0A;&#x3002;&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x5F53;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7ED3;&#x70B9;&#x5931;&#x6548;&#x65F6;&#xFF0C;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x6240;&#x6709;&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x90FD;&#x5931;&#x6548;&#xFF0C;&#x4E5F;&#x4EC5;&#x4EC5;&#x9700;&#x8981;&#x628A;&#x539F;&#x6765;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x8BE5;&#x7ED3;&#x70B9;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x7EE7;&#x7EED;&#x7F13;&#x5B58;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x987A;&#x65F6;&#x9488;&#x65B9;&#x5411;&#x79BB;&#x5B83;&#x6700;&#x8FD1;&#x7684;&#x7ED3;&#x70B9;&#x4E0A;&#x5373;&#x53EF;&#x3002;&#x5F53;&#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x65F6;&#xFF0C;&#x540C;&#x6837;&#x4E5F;&#x53EA;&#x9700;&#x8981;&#x5BF9;&#x5F88;&#x5C11;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x518D;&#x54C8;&#x5E0C;&#x5E76;&#x6620;&#x5C04;&#x5230;&#x65B0;&#x7684;&#x7ED3;&#x70B9;&#x4E0A;&#x5373;&#x53EF;&#x3002;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x51FA;&#x73B0;&#x6570;&#x636E;&#x5206;&#x914D;&#x4E0D;&#x5747;&#x5300;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6BD4;&#x5982;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x7684;&#x6570;&#x636E;&#x90FD;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x4E0A;&#xFF0C;&#x800C;&#x5176;&#x4ED6;&#x7684;&#x7ED3;&#x70B9;&#x5219;&#x7F13;&#x5B58;&#x5F88;&#x5C11;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#x8FD8;&#x63D0;&#x51FA;&#x4E86; <strong>&#x865A;&#x62DF;&#x7ED3;&#x70B9;</strong> &#x7684;&#x6982;&#x5FF5;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/234a37c.jpg" alt=""></p>
<p>A1&#x548C;A2&#x4E3A;&#x7ED3;&#x70B9;A&#x7684;&#x865A;&#x62DF;&#x7ED3;&#x70B9;&#xFF0C;&#x865A;&#x62DF;&#x7ED3;&#x70B9;&#x7684;hash&#x503C;&#x8BA1;&#x7B97;&#x53EF;&#x4EE5;&#x91C7;&#x7528;&#x5BF9;&#x5E94;&#x7ED3;&#x70B9;&#x7684;IP&#x5730;&#x5740;&#x52A0;&#x6570;&#x5B57;&#x540E;&#x7F00;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5982;&#x201C;192.168.1.1#1&#x201D;&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x88AB;&#x6563;&#x5217;&#x5230;A1&#x548C;A2&#x7684;&#x6570;&#x636E;&#x90FD;&#x7F13;&#x5B58;&#x8FDB;&#x7ED3;&#x70B9;A&#x4E2D;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x4E86;&#x6570;&#x636E;&#x5206;&#x5E03;&#x4E0D;&#x5E73;&#x8861;&#x7684;&#x73B0;&#x8C61;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2359a11/" title="论实现序列化的在云端的必要性 -" itemprop="url">论实现序列化的在云端的必要性 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5BF9;&#x4E8E;java&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x91CD;&#x8981;&#x6027;&#xFF0C;&#x5728;&#x5355;&#x673A;&#x7A0B;&#x5E8F;&#x5185;&#x662F;&#x4E0D;&#x592A;&#x5BB9;&#x6613;&#x88AB;&#x91CD;&#x89C6;&#x7684;&#xFF0C;&#x5728;&#x672C;&#x5730;&#x8C03;&#x8BD5;&#x4E2D;&#xFF0C;tomacat&#x81EA;&#x52A8;&#x4E3A;&#x4E3A;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x7A0B;&#x5E8F;&#x5B9E;&#x73B0;&#x4E86;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x800C;&#x4E14;bean(&#x7528;&#x6765;&#x5B9E;&#x73B0;&#x7F13;&#x5B58;&#x7684;java&#x7A0B;&#x5E8F;)&#x592A;&#x5C0F;&#xFF0C;&#x4E0D;&#x4F1A;&#x51FA;&#x73B0;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x4E00;&#x65E6;&#x90E8;&#x7F72;&#x5230;&#x4E91;&#x7AEF;&#xFF0C;&#x9EBB;&#x70E6;&#x5C31;&#x51FA;&#x73B0;&#x4E86;&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;session&#x4E3A;&#x4EC0;&#x4E48;&#x5B58;&#x4E0D;&#x8FDB;&#x503C;&#x5462;?&#x4E0D;&#x4E45;&#x524D;&#x6211;&#x5728;&#x65B0;&#x6D6A;&#x4E91;&#x4E91;&#x7AEF;&#x90E8;&#x7F72;session&#x5C31;&#x51FA;&#x73B0;&#x4E86;&#x672A;&#x80FD;&#x53D6;&#x4E0D;&#x5230;&#x503C;&#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/23577e3.jpg" alt=""></p>
<p>&#x9488;&#x5BF9;&#x65B0;&#x6D6A;&#x4E91;&#x670D;&#x52A1;&#x5668;&#xFF0C;session&#x7684;&#x4FE1;&#x606F;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5206;&#x5E03;&#x5F0F;Memcache&#x5B58;&#x50A8;&#x3002;</p>
<p>&#x800C;Memcache&#x5B58;&#x50A8;&#x5462;?</p>
<p>&#x4E0D;&#x5C11;&#x60F3;&#x6784;&#x5EFA;&#x5927;&#x8D1F;&#x8F7D;&#x7684;&#x7F51;&#x7AD9;&#x90FD;&#x91C7;&#x53D6;Memcache&#x6765;&#x5206;&#x62C5;&#x6570;&#x636E;&#x5E93;&#x7684;&#x538B;&#x529B;&#x3002;</p>
<p>Memcache&#x9996;&#x5148;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x5185;&#x5B58;&#x4E2D;&#x5F00;&#x8F9F;&#x4E00;&#x4E2A;&#x7A7A;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;hash&#x8868;&#x3002;</p>
<p>memcache &#x4EE5;&#x5B88;&#x62A4;&#x7A0B;&#x5E8F;&#x7684;&#x5F62;&#x5F0F;&#x8FD0;&#x884C;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7AEF;(&#x4E00;&#x4E2A;&#x6216;&#x8005;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x5668;)&#xFF0C;&#x968F;&#x65F6;&#x63A5;&#x53D7;&#x6765;&#x81EA;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x5B58;&#x53D6;&#x6570;&#x636E;&#xFF0C;Memcache&#x662F;&#x4E00;&#x6B3E;nosql&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x3002;&#x91C7;&#x7528;&#x7684;&#x662F;&#x952E;&#x503C;&#x5B58;&#x50A8;&#xFF0C;&#x6BCF;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x5B58;&#x5165;&#x7684;&#x5BF9;&#x8C61;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;key&#x3002;&#x4F46;&#x662F;&#x5BF9;&#x8C61;&#x662F;&#x6CA1;&#x529E;&#x6CD5;&#x6301;&#x4E45;&#x5316;&#x7684;&#xFF0C;&#x8DDF;memcache&#x5F88;&#x76F8;&#x4F3C;&#x7684;redis&#x662F;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x6301;&#x4E45;&#x5316;&#x5230;&#x786C;&#x76D8;&#x7684;&#x3002;&#x7136;&#x540E;&#x628A;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;&#x4EE5;key-value&#x7684;&#x5F62;&#x5F0F;&#x4FDD;&#x5B58;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#xFF0C;value&#x503C;&#x5B58;&#x5165;key&#x503C;hash&#x8F6C;&#x5316;&#x540E;&#x7684;&#x5BF9;&#x5E94;&#x7684;&#x67D0;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;&#x53D6;&#x503C;&#x7684;&#x65F6;&#x5019;&#x901A;&#x8FC7;&#x540C;&#x6837;&#x7684;&#x8F6C;&#x5316;&#x540E;&#x5BF9;&#x54CD;&#x5E94;&#xFFFD;&#xFFFD;&#xFFFD;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x4ED8;&#x51FA;&#x8BF7;&#x6C42;&#x5373;&#x53EF;&#x3002;</p>
<p>&#x800C;&#x5728;&#x5E8F;&#x5217;&#x5316;&#x5728;&#x5728;&#x5176;&#x4E2D;&#x8D77;&#x5230;&#x4EC0;&#x4E48;&#x4F5C;&#x7528;&#x5462;?</p>
<p>&#x5728;memcache&#x7F13;&#x5B58;&#x5230;&#x5185;&#x5B58;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5230;&#x5E8F;&#x5217;&#x5316;&#x5B58;&#x50A8;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5982;&#x679C;&#x4F60;&#x7684;bean&#x5305;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x6CA1;&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x63A5;&#x53E3;&#xFF0C;&#x5728;&#x7F13;&#x5B58;&#x7684;&#x65F6;&#x5019;&#x662F;&#x4E0D;&#x4F1A;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x9020;&#x6210;&#x4E86;session&#x5E76;&#x6CA1;&#x6709;&#x5B58;&#x503C;&#x7684;&#x95EE;&#x9898;&#x53D1;&#x751F;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x5728;&#x90E8;&#x7F72;&#x5230;&#x65B0;&#x6D6A;&#x4E91;&#x7684;&#x7A0B;&#x5E8F;&#x5B58;&#x50A8;&#x5230;session&#x4E2D;&#x7684;&#x5BF9;&#x8C61;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x63A5;&#x53E3;&#x624D;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;session&#x5B58;&#x50A8;&#x7684;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/235b9ce/" title="memcached 1.4.23 发布，集中式缓存系统 -" itemprop="url">memcached 1.4.23 发布，集中式缓存系统 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><a href="http://www.oschina.net/news/61534/oschina-opensource-collection-plan-for-it-companies" target="_blank" rel="external">&#x5F00;&#x6E90;&#x4E2D;&#x56FD;&#x7684; IT &#x516C;&#x53F8;&#x5F00;&#x6E90;&#x8F6F;&#x4EF6;&#x6574;&#x7406;&#x8BA1;&#x5212;&#x4ECB;&#x7ECD;</a></p>
<p>memcached 1.4.23 &#x53D1;&#x5E03;&#xFF0C;&#x6B64;&#x7248;&#x672C;&#x73B0;&#x5DF2;&#x63D0;&#x4F9B;&#x4E0B;&#x8F7D;&#xFF1A; <a href="http://www.memcached.org/files/memcached-1.4.23.tar.gz" target="_blank" rel="external">http://www.memcached.org/files/memcached-1.4.23.tar.gz</a> &#x3002; </p>
<p>&#x6B64;&#x7248;&#x672C;&#x66F4;&#x65B0;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<h3 id="Bug_&#x4FEE;&#x590D;">Bug &#x4FEE;&#x590D;</h3><ul>
<li>spinlocks removed since they never seem to improve performance.</li>
<li>flush_all was not thread safe.</li>
<li>better handle items refcounted in tail by unlinking them from the LRU&apos;s</li>
</ul>
<h3 id="&#x65B0;&#x7279;&#x6027;">&#x65B0;&#x7279;&#x6027;</h3><p>&#x91CD;&#x5199;&#x4E86; memcached &#x7684;&#x6838;&#x5FC3; LRU &#x7B97;&#x6CD5;&#xFF1A;</p>
<ul>
<li>global cache_lock is gone, LRU&apos;s are now independently locked.</li>
<li>LRU&apos;s are now split between HOT, WARM, and COLD LRU&apos;s. New items enter the HOT LRU.</li>
<li>LRU updates only happen as items reach the bottom of an LRU. If active in HOT, stay in HOT, if active in WARM, stay in WARM. If active in COLD, move to WARM.</li>
<li>HOT/WARM each capped at 32% of memory available for that slab class. COLD is uncapped.</li>
<li>Items flow from HOT/WARM into COLD.</li>
<li>A background thread exists which shuffles items between/within the LRU&apos;s as capacities are reached.</li>
</ul>
<p>&#x4E3B;&#x8981;&#x76EE;&#x6807;&#x662F;&#x4FDD;&#x62A4;&#x201C;scanning&#x201D;&#x7684; active items&#xFF0C;&#x5176;&#x6B21;&#x662F;&#x4E3A;&#x4E86;&#x6539;&#x8FDB;&#x5EF6;&#x8FDF;&#x3002;</p>
<p>&#x66F4;&#x591A;&#x6539;&#x8FDB;&#x5185;&#x5BB9;&#x8BF7;&#x770B; <a href="https://code.google.com/p/memcached/wiki/ReleaseNotes1423" target="_blank" rel="external">&#x53D1;&#x884C;&#x8BF4;&#x660E;</a> &#x3002; </p>
<p>memcached&#x662F;&#x4E00;&#x5957;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x5FEB;&#x53D6;&#x7CFB;&#x7EDF;&#xFF0C;&#x5F53;&#x521D;&#x662F;Danga Interactive&#x4E3A;&#x4E86;LiveJournal&#x6240;&#x53D1;&#x5C55;&#x7684;&#xFF0C;&#x4F46;&#x76EE;&#x524D;&#x88AB;&#x8BB8;&#x591A;&#x8F6F;&#x4EF6;&#xFF08;&#x5982;MediaWiki&#xFF09;&#x6240;&#x4F7F;&#x7528;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x5957;&#x5F00;&#x653E;&#x6E90;&#x4EE3;&#x7801;&#x8F6F;&#x4EF6;&#xFF0C;&#x4EE5;BSD license&#x6388;&#x6743;&#x91CA;&#x51FA;&#x3002; </p>
<p>memcached&#x7F3A;&#x4E4F;&#x8BA4;&#x8BC1;&#x4EE5;&#x53CA;&#x5B89;&#x5168;&#x7BA1;&#x5236;&#xFF0C;&#x8FD9;&#x4EE3;&#x8868;&#x5E94;&#x8BE5;&#x5C06;memcached&#x670D;&#x52A1;&#x5668;&#x653E;&#x7F6E;&#x5728;&#x9632;&#x706B;&#x5899;&#x540E;&#x3002;</p>
<p>memcached &#x7684;API&#x4F7F;&#x7528;&#x4E09;&#x5341;&#x4E8C;&#x4F4D;&#x5143;&#x7684;&#x5FAA;&#x73AF;&#x5197;&#x4F59;&#x6821;&#x9A8C;&#xFF08;CRC-32&#xFF09;&#x8BA1;&#x7B97;&#x952E;&#x503C;&#x540E;&#xFF0C;&#x5C06;&#x8D44;&#x6599;&#x5206;&#x6563;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x3002;&#x5F53;&#x8868;&#x683C;&#x6EE1;&#x4E86;&#x4EE5;&#x540E;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x65B0;&#x589E;&#x7684;&#x8D44;&#x6599;&#x4F1A;&#x4EE5;LRU&#x673A;&#x5236;&#x66FF;&#x6362;&#x6389;&#x3002; &#x7531;&#x4E8E;memcached&#x901A;&#x5E38;&#x53EA;&#x662F;&#x5F53;&#x4F5C;&#x5FEB;&#x53D6;&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;memcached&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5F0F;&#x5728;&#x5199;&#x56DE;&#x8F83;&#x6162;&#x7684;&#x7CFB;&#x7EDF;&#x65F6;&#xFF08;&#x50CF;&#x662F;&#x540E;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF09;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x7A0B;&#x5F0F;&#x7801;&#x66F4;&#x65B0; memcached&#x5185;&#x7684;&#x8D44;&#x6599;&#x3002;</p>
<p>memcached&#x5177;&#x6709;&#x591A;&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x5F00;&#x53D1;&#x5305;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;Perl/PHP/JAVA/C/Python/Ruby/C#/MySQL/</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x5305;&#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#x662F;&#xFF1A; <a href="http://code.google.com/p/memcached/wiki/Clients" target="_blank" rel="external">http://code.google.com/p/memcached/wiki/Clients</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/238d0d2/" title="Linux c 开发 - Memcached源码分析之存储机制Slabs（7） -" itemprop="url">Linux c 开发 - Memcached源码分析之存储机制Slabs（7） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x524D;&#x51E0;&#x7AE0;&#x8282;&#x6211;&#x4EEC;&#x4ECB;&#x7ECD;&#x4E86;Memcached&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#xFF0C;&#x547D;&#x4EE4;&#x884C;&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF0C;HashTable&#xFF0C;Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x4EE5;&#x53CA;LRU&#x7B97;&#x6CD5;&#x6A21;&#x5757;&#x3002;</p>
<p>&#x8FD9;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x8BB2;&#x89E3;Memcached&#x7684;&#x5B58;&#x50A8;&#x673A;&#x5236;Slabs&#x3002;Memcached&#x5B58;&#x50A8;Item&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x662F;&#x5728;slabs.c&#x4E2D;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x5728;&#x89E3;&#x8BFB;&#x8FD9;&#x4E00;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x5148;&#x4E86;&#x89E3;&#x51E0;&#x4E2A;&#x6982;&#x5FF5;&#x3002;</p>
<p>Item &#x7F13;&#x5B58;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7684;&#x57FA;&#x672C;&#x5355;&#x5143;</p>
<ol>
<li><p>Item&#x662F;Memcached&#x5B58;&#x50A8;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x4F4D;</p>
</li>
<li><p>&#x6BCF;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;Item&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
</li>
<li><p>Item&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x7F13;&#x5B58;&#x7684;key&#x3001;value&#x3001;key&#x7684;&#x957F;&#x5EA6;&#x3001;value&#x7684;&#x957F;&#x5EA6;&#x3001;&#x7F13;&#x5B58;&#x7684;&#x65F6;&#x95F4;&#x7B49;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>HashTable&#x548C;LRU&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x90FD;&#x662F;&#x4F9D;&#x8D56;Item&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#x7684;&#x3002;</p>
</li>
<li><p>&#x5728;Memcached&#x4E2D;&#xFF0C;Item&#x626E;&#x6F14;&#x7740;&#x91CD;&#x8981;&#x7684;&#x89D2;&#x8272;&#x3002;</p>
<p> //item&#x7684;&#x5177;&#x4F53;&#x7ED3;&#x6784;<br> typedef struct _stritem {  </p>
<pre><code>//&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;,&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;freelist&amp;<span class="symbol">#x94FE</span>;  
struct _stritem *next;  
//&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;,&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;freelist&amp;<span class="symbol">#x94FE</span>;  
struct _stritem *prev;  
//&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;<span class="class">HashTable</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
struct _stritem *h_next;  
//&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;set/add/replace&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x6BB5</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;  
rel_time_t      time;       /* least recent access */  
//&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x6C38</span>;&amp;<span class="symbol">#x4E45</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x88AB</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;  
rel_time_t      exptime;    /* expire time */  
//value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
int             nbytes;     /* size of data */  
//&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x5B83</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;refcount&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;refcount -<span class="number">1</span> = <span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
unsigned short  refcount;  
uint8_t         nsuffix;    /* length of flags-and-length string */  
uint8_t         it_flags;   /* <span class="class">ITEM_</span>* above */  
//slabs_class&amp;<span class="symbol">#x7684</span>;<span class="class">ID</span>&amp;<span class="symbol">#x3002</span>;  
uint8_t         slabs_clsid;/* which slab class we&amp;apos;re in */  
uint8_t         nkey;       /* key length, w/terminating null and padding */  
/* this odd type prevents type-punning issues when we do 
 * the little shuffle to save space when not using <span class="class">CAS</span>. */  
//&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
union {  
    uint64_t cas;  
    char end;  
} data[];  
/* if it_flags &amp;amp; <span class="class">ITEM_CAS</span> we have <span class="number">8</span> bytes <span class="class">CAS</span> */  
/* then null-terminated key */  
/* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
/* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
</code></pre><p> } item;</p>
</li>
</ol>
<p>slabclass &#x5212;&#x5206;&#x6570;&#x636E;&#x7A7A;&#x95F4;</p>
<ol>
<li><p>Memcached&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;slabclass&#x6570;&#x7EC4;&#xFF0C;&#x8BE5;&#x6570;&#x7EC4;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6700;&#x5927;201&#x4E2A;slabclass_t&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4F53;&#x3002;</p>
</li>
<li><p>Memcached&#x5E76;&#x4E0D;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;&#x90FD;&#x4F1A;&#x653E;&#x7F6E;&#x5728;&#x4E00;&#x8D77;&#xFF0C;&#x800C;&#x662F;&#x9884;&#x5148;&#x5C06;&#x6570;&#x636E;&#x7A7A;&#x95F4;&#x5212;&#x5206;&#x4E3A;&#x4E00;&#x7CFB;&#x5217;&#x7684;slabclass_t&#x3002;</p>
</li>
<li><p>&#x6BCF;&#x4E2A;slabclass_t&#xFF0C;&#x90FD;&#x53EA;&#x5B58;&#x50A8;&#x4E00;&#x5B9A;&#x5927;&#x5C0F;&#x8303;&#x56F4;&#x7684;&#x6570;&#x636E;&#x3002;slabclass&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;&#x524D;&#x4E00;&#x4E2A;slabclass_t&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x8981;&#x5C0F;&#x4E8E;&#x4E0B;&#x4E00;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x3002;</p>
</li>
<li><p>&#x4F8B;&#x5982;&#xFF1A;slabclass[3]&#x53EA;&#x5B58;&#x50A8;&#x5927;&#x5C0F;&#x4ECB;&#x4E8E;120 &#xFF08;slabclass[2]&#x7684;&#x6700;&#x5927;&#x503C;&#xFF09;&#x5230; 150 bytes&#x7684;&#x6570;&#x636E;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x4E3A;134byte&#x5C06;&#x88AB;&#x5206;&#x914D;&#x5230;slabclass[3]&#x4E2D;&#x3002;</p>
</li>
<li><p>memcached&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0B;&#x4E00;&#x4E2A;slabclass_t&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x6700;&#x5927;&#x503C;&#x4E3A;&#x524D;&#x4E00;&#x4E2A;&#x7684;1.25&#x500D;&#xFF08;settings.factor&#xFF09;&#xFF0C;&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4FEE; &#x6539;-f&#x53C2;&#x6570;&#x6765;&#x4FEE;&#x6539;&#x589E;&#x957F;&#x6BD4;&#x4F8B;&#x3002;</p>
<p> //slabclass&#x7684;&#x7ED3;&#x6784;<br> typedef struct {  </p>
<pre><code>//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;slabclass&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item  
unsigned int size;  
//&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;item.&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>; &amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;size&amp;<span class="symbol">#x51B3</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x3002</span>;  
unsigned int perslab;  

//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;slabclass&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;item&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF09</span>;freelist &amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
//freelist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x7CFB</span>;  
void *slots;           /* list of item ptrs */  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item  
//&amp;<span class="symbol">#x5F53</span>;sl_curr=<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x6210</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF09</span>;  
unsigned int sl_curr;   /* total free items in list */  

//&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;slabs  
unsigned int slabs;     /* how many slabs were allocated for this class */  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;  
void **slab_list;       /* array of slab pointers */  
unsigned int list_size; /* size of prev array */  

unsigned int killing;  /* index+<span class="number">1</span> of dying slab, or zero if none */  
//&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;bytes  
size_t requested; /* <span class="class">The</span> number of requested bytes */  
</code></pre><p> } slabclass_t;<br> //&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;slabclass&#x6570;&#x7EC4;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6700;&#x5927;200&#x4E2A;&#x7684;slabclass_t&#x7684;&#x7ED3;&#x6784;&#x3002;<br> static slabclass_t slabclass[MAX_NUMBER_OF_SLAB_CLASSES];</p>
</li>
</ol>
<p>slab &#x5185;&#x5B58;&#x5206;&#x914D;&#x5355;&#x4F4D;</p>
<ol>
<li><p>Memcached&#x7684;&#x5185;&#x5B58;&#x5206;&#x914D;&#x662F;&#x4EE5;slab&#x4E3A;&#x5355;&#x4F4D;&#x7684;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6BCF;&#x4E2A;slab&#x5927;&#x5C0F;&#x4E3A;1M&#x3002;</p>
</li>
<li><p>slabclass&#x6570;&#x7EC4;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6BCF;&#x4E2A;slabclass_t&#x90FD;&#x4F1A;&#x5206;&#x914D;&#x4E00;&#x4E2A;1M&#x5927;&#x5C0F;&#x7684;slab&#x3002;</p>
</li>
<li><p>&#x5F53;&#x67D0;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x4E0A;&#x7684;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x7684;&#x65F6;&#x5019;&#xFF08;freelist&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E3A;&#x7A7A;&#xFF09;&#xFF0C;&#x5219;&#x4F1A;&#x5206;&#x914D;&#x4E00;&#x4E2A;slab&#x7ED9;&#x8FD9;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x3002;</p>
</li>
<li><p>&#x4E00;&#x65E6;slab&#x5206;&#x914D;&#x540E;&#xFF0C;&#x4E0D;&#x53EF;&#x56DE;&#x6536;&#x3002;</p>
</li>
<li><p>slab&#x4F1A;&#x88AB;&#x5207;&#x5206;&#x4E3A;N&#x4E2A;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#x7684;&#x5927;&#x5C0F;&#x53D6;&#x51B3;&#x4E8E;slabclass_t&#x7ED3;&#x6784;&#x4E0A;&#x7684;size&#x7684;&#x5927;&#x5C0F;&#x3002;&#x4F8B;&#x5982;slabclass<a href="http://taojinke.github.io/img/20150703/2389d8d.jpg">0</a>&#x4E0A;&#x7684;size&#x4E3A;103&#xFF0C;&#x5219;&#x6BCF;&#x4E2A;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#x5927;&#x5C0F;&#x4E3A;103byte&#x3002;</p>
</li>
<li><p>&#x8FD9;&#x4E9B;&#x88AB;&#x5207;&#x5272;&#x7684;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5B58;&#x50A8;item&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x5B58;&#x50A8;&#x7684;item&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x6BD4;&#x5207;&#x5272;&#x51FA;&#x6765;&#x7684;&#x5185;&#x5B58;&#x5757;&#x4F1A;&#x5C0F;&#x3002;&#x56E0;&#x4E3A;&#x8FD9;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x5185;&#x5B58;&#x788E;&#x7247;&#xFF0C;&#x867D;&#x7136;&#x6709;&#x4E00;&#x4E9B;&#x5185;&#x5B58;&#x7684;&#x6D6A;&#x8D39;&#x3002;</p>
</li>
</ol>
<p>slabclass&#x548C;slab&#x3001;item&#x4EE5;&#x53CA;free list&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/2389d8d.jpg" alt=""></p>
<p>&#x901A;&#x8FC7;item&#x7684;size&#x6765;&#x9009;&#x62E9;slab_class&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2389ffe.jpg" alt=""></p>
<p>&#x5B58;&#x50A8;&#x673A;&#x5236;&#x7684;&#x6E90;&#x7801;&#x5206;&#x6790;</p>
<p>slabs_clsid - &#x67E5;&#x8BE2;slabclass&#x7684;ID</p>
<p>slabs_clsid&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x901A;&#x8FC7;item&#x7684;&#x957F;&#x5EA6;&#x6765;&#x67E5;&#x8BE2;&#x5E94;&#x8BE5;&#x9002;&#x5408;&#x5B58;&#x653E;&#x5230;&#x54EA;&#x4E2A;slabsclass_t&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9009</span>;&amp;<span class="symbol">#x62E9</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x9002</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E2D</span>;  
unsigned int slabs_clsid(const size_t size) {  
    int res = <span class="class">POWER_SMALLEST</span>; //&amp;<span class="symbol">#x4ECE</span>;id = <span class="number">1</span>&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;  

    //slabclass&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8BE5</span>;class&amp;<span class="symbol">#x9002</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;  
    //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;  
    //slabclass[<span class="number">0</span>] &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">96</span>byte  
    //slabclass[<span class="number">1</span>] &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">120</span>byte  
    //slabclass[<span class="number">2</span>] &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">150</span>byte  
    //&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">109</span>byte&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;slabclass[<span class="number">1</span>]&amp;<span class="symbol">#x4E0A</span>;  
    if (size == <span class="number">0</span>)  
        return <span class="number">0</span>;  
    while (size &amp;gt; slabclass[res].size)  
        if (res++ == power_largest)     /* won&amp;apos;t fit in the biggest slab */  
            return <span class="number">0</span>;  
    return res;  
}
</code></pre><p>slabs_init - slabclass&#x7684;&#x521D;&#x59CB;&#x5316;</p>
<p>slabs_init&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x521D;&#x59CB;&#x5316;slabclass&#x6570;&#x7EC4;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code>//slabclass&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;  
void slabs_init(const size_t limit, const double factor, const bool prealloc) {  
    int i = <span class="class">POWER_SMALLEST</span> - <span class="number">1</span>;  
    unsigned int size = sizeof(item) + settings.chunk_size;  
    mem_limit = limit;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass_t&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
    //&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;  
    if (prealloc) {  
        /* <span class="class">Allocate</span> everything in a big chunk with malloc */  
        mem_base = malloc(mem_limit);  
        if (mem_base != <span class="class">NULL</span>) {  
            mem_current = mem_base;  
            mem_avail = mem_limit;  
        } else {  
            fprintf(stderr, &amp;quot;<span class="class">Warning</span>: <span class="class">Failed</span> to allocate requested memory in&amp;quot;  
                    &amp;quot; one large chunk.\nWill allocate in smaller chunks\n&amp;quot;);  
        }  
    }  
    memset(slabclass, <span class="number">0</span>, sizeof(slabclass));  
    //factor &amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">1.25</span> &amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">96</span>byte&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;  
    //&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">120</span>byte  
    while (++i &amp;lt; <span class="class">POWER_LARGEST</span> &amp;amp;&amp;amp; size &amp;lt;= settings.item_size_max / factor) {  
        /* <span class="class">Make</span> sure items are always n-byte aligned */  
        if (size % <span class="class">CHUNK_ALIGN_BYTES</span>)  
            size += <span class="class">CHUNK_ALIGN_BYTES</span> - (size % <span class="class">CHUNK_ALIGN_BYTES</span>);  
        //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass[i]&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item  
        slabclass[i].size = size;  
        slabclass[i].perslab = settings.item_size_max / slabclass[i].size;  
        size *= factor;  
        if (settings.verbose &amp;gt; <span class="number">1</span>) {  
            fprintf(stderr, &amp;quot;slab class %<span class="number">3</span><span class="method">d:</span> chunk size %<span class="number">9</span>u perslab %<span class="number">7</span>u\n&amp;quot;,  
                    i, slabclass[i].size, slabclass[i].perslab);  
        }  
    }  
    power_largest = i;  
    slabclass[power_largest].size = settings.item_size_max;  
    slabclass[power_largest].perslab = <span class="number">1</span>;  
    if (settings.verbose &amp;gt; <span class="number">1</span>) {  
        fprintf(stderr, &amp;quot;slab class %<span class="number">3</span><span class="method">d:</span> chunk size %<span class="number">9</span>u perslab %<span class="number">7</span>u\n&amp;quot;,  
                i, slabclass[i].size, slabclass[i].perslab);  
    }  
    /* for the test <span class="method">suite:</span>  faking of how much we&amp;apos;ve already malloc&amp;apos;d */  
    {  
        char *t_initial_malloc = getenv(&amp;quot;<span class="class">T_MEMD_INITIAL_MALLOC</span>&amp;quot;);  
        if (t_initial_malloc) {  
            mem_malloced = (size_t)atol(t_initial_malloc);  
        }  
    }  
    if (prealloc) {  
        slabs_preallocate(power_largest);  
    }  
}


//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
static void slabs_preallocate (const unsigned int maxslabs) {  
    int i;  
    unsigned int prealloc = <span class="number">0</span>;  
    /* pre-allocate a <span class="number">1</span>MB slab in every size class so people don&amp;apos;t get 
       confused by non-intuitive &amp;quot;<span class="class">SERVER_ERROR</span> out of memory&amp;quot; 
       messages.  this is the most common question on the mailing 
       list.  if you really don&amp;apos;t want this, you can rebuild without 
       these three lines.  */  
    //&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass_t&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x7684</span>;slab  
    for (i = <span class="class">POWER_SMALLEST</span>; i &amp;lt;= <span class="class">POWER_LARGEST</span>; i++) {  
        if (++prealloc &amp;gt; maxslabs)  
            return;  
        if (do_slabs_newslab(i) == <span class="number">0</span>) {  
            fprintf(stderr, &amp;quot;<span class="class">Error</span> while preallocating slab memory!\n&amp;quot;  
                &amp;quot;<span class="class">If</span> using -<span class="class">L</span> or other prealloc options, max memory must be &amp;quot;  
                &amp;quot;at least %d megabytes.\n&amp;quot;, power_largest);  
            exit(<span class="number">1</span>);  
        }  
    }  
}
</code></pre><p>do_slabs_alloc - &#x5206;&#x914D;&#x4E00;&#x4E2A;item</p>
<ol>
<li><p>Memcached&#x5206;&#x914D;&#x4E00;&#x4E2A;item&#xFF0C;&#x4F1A;&#x5148;&#x68C0;&#x67E5;freelist&#x7A7A;&#x95F2;&#x7684;&#x5217;&#x8868;&#x4E2D;&#x662F;&#x5426;&#x6709;&#x7A7A;&#x95F2;&#x7684;item&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7684;&#x8BDD;&#x5C31;&#x7528;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E2D;&#x7684;item&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x6CA1;&#x6709;&#x7A7A;&#x95F2;&#x7684;item&#x53EF;&#x4EE5;&#x5206;&#x914D;&#xFF0C;&#x5219;Memcached&#x4F1A;&#x53BB;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;slab&#xFF08;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;1M&#xFF09;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x5982;&#x679C;&#x7533;&#x8BF7;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;NULL&#xFF0C;&#x8868;&#x660E;&#x5206;&#x914D;&#x5931;&#x8D25;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x7533;&#x8BF7;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x53BB;&#x5C06;&#x8FD9;&#x4E2A;1M&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x6839;&#x636E;slabclass_t&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x7684;&#x6700;&#x5927;&#x7684;item&#x7684;size&#xFF0C;&#x5C06;slab&#x5207;&#x5272;&#x6210;N&#x4E2A;item&#xFF0C;&#x7136;&#x540E;&#x653E;&#x8FDB;freelist&#xFF08;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E2D;&#xFF09;</p>
</li>
<li><p>&#x7136;&#x540E;&#x53BB;freelist&#xFF08;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#xFF09;&#x4E2D;&#x53D6;&#x51FA;&#x4E00;&#x4E2A;item&#x6765;&#x4F7F;&#x7528;&#x3002;</p>
<p> //&#x5206;&#x914D;&#x4E00;&#x4E2A;Item<br> void *slabs_alloc(size_t size, unsigned int id) {  </p>
<pre><code>void *ret;  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;<span class="class">Item</span>&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;  
pthread_mutex_lock(&amp;amp;slabs_lock);  
//size&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//id&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
ret = do_slabs_alloc(size, id);  
pthread_mutex_unlock(&amp;amp;slabs_lock);  
return ret;  
</code></pre><p> }</p>
</li>
</ol>
<pre><code>//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
static void *do_slabs_alloc(const size_t size, unsigned int id) {  
    slabclass_t *p;  
    void *ret = <span class="class">NULL</span>;  
    item *it = <span class="class">NULL</span>;  
    if (id &amp;lt; <span class="class">POWER_SMALLEST</span> || id &amp;gt; power_largest) {  
        <span class="class">MEMCACHED_SLABS_ALLOCATE_FAILED</span>(size, <span class="number">0</span>);  
        return <span class="class">NULL</span>;  
    }  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;slabclass  
    p = &amp;amp;slabclass[id];  
    assert(p-&amp;gt;sl_curr == <span class="number">0</span> || ((item *)p-&amp;gt;slots)-&amp;gt;slabs_clsid == <span class="number">0</span>);  
    /* fail unless we have space at the end of a recently allocated page, 
       we have something on our freelist, or we could allocate a new page */  
    //p-&amp;gt;sl_curr &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item list  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item list&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NULL</span>  
    if (! (p-&amp;gt;sl_curr != <span class="number">0</span> || do_slabs_newslab(id) != <span class="number">0</span>)) {  
        /* <span class="class">We</span> don&amp;apos;t have more memory available */  
        ret = <span class="class">NULL</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;free item lits&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
    } else if (p-&amp;gt;sl_curr != <span class="number">0</span>) {  
        /* return off our freelist */  
        it = (item *)p-&amp;gt;slots;  
        p-&amp;gt;slots = it-&amp;gt;next;  
        if (it-&amp;gt;next) it-&amp;gt;next-&amp;gt;prev = <span class="number">0</span>;  
        p-&amp;gt;sl_curr--;  
        ret = (void *)it;  
    }  
    if (ret) {  
        p-&amp;gt;requested += size;  
        <span class="class">MEMCACHED_SLABS_ALLOCATE</span>(size, id, p-&amp;gt;size, ret);  
    } else {  
        <span class="class">MEMCACHED_SLABS_ALLOCATE_FAILED</span>(size, id);  
    }  
    return ret;  
}
</code></pre><p>&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;slab&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5757</span>;  
static int do_slabs_newslab(const unsigned int id) {  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;slabclass  
    slabclass_t *p = &amp;amp;slabclass[id];  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x662F</span>;<span class="number">1</span>M  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>; &amp;<span class="symbol">#x8BE5</span>;slabclass&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; * &amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>; &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    int len = settings.slab_reassign ? settings.item_size_max  
        : p-&amp;gt;size * p-&amp;gt;perslab;  
    char *ptr;  

    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;slab&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
    if ((mem_limit &amp;amp;&amp;amp; mem_malloced + len &amp;gt; mem_limit &amp;amp;&amp;amp; p-&amp;gt;slabs &amp;gt; <span class="number">0</span>) ||  
        (grow_slab_list(id) == <span class="number">0</span>) ||  
        ((ptr = memory_allocate((size_t)len)) == <span class="number">0</span>)) {  

        <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED</span>(id);  
        return <span class="number">0</span>;  
    }  

    //&amp;<span class="symbol">#x5C06</span>;slab&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x6210</span>;<span class="class">N</span>&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;freelist&amp;<span class="symbol">#x4E2D</span>;  
    memset(ptr, <span class="number">0</span>, (size_t)len);  
    split_slab_page_into_freelist(ptr, id);  

    p-&amp;gt;slab_list[p-&amp;gt;slabs++] = ptr;  
    mem_malloced += len;  
    <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE</span>(id);  

    return <span class="number">1</span>;  
}
</code></pre><p>&#x5C06;slab&#x5185;&#x5B58;&#x5757;&#x8FDB;&#x884C;&#x5207;&#x5272;&#xFF1A;</p>
<pre><code><span class="xml">//&amp;#x5C06;slab &amp;#x5207;&amp;#x5272;&amp;#x6210;N&amp;#x4E2A;item  
static void split_slab_page_into_freelist(char *ptr, const unsigned int id) </span><span class="expression">{  
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];  
    <span class="variable">int</span> <span class="variable">x</span>;  
    <span class="variable">for</span> (<span class="variable">x</span> = 0; <span class="variable">x</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">perslab</span>; <span class="variable">x</span>++) {  
        //&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>20;&amp;<span class="begin-block">#x</span>9012;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>9;<span class="variable">ptr</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;<span class="variable">free</span>&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>76;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>771<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>63;&amp;<span class="begin-block">#x</span>610<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>49;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>91<span class="variable">CA</span>;&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5230;<span class="variable">free</span> <span class="variable">list</span>&amp;<span class="begin-block">#xFF</span>08;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>2;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9762;&amp;<span class="begin-block">#xFF</span>09;  
        <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, 0, <span class="variable">id</span>);  
        //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
        //&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>9<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>9645;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">size</span>&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>  
        <span class="variable">ptr</span> += <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>;  
    }</span><span class="xml">  
}</span>
</code></pre><p>slabs_free - &#x91CA;&#x653E;&#x4E00;&#x4E2A;item</p>
<p>&#x91CA;&#x653E;item&#x540E;&#xFF0C;&#x4F1A;&#x5C06;item&#x653E;&#x8FDB;free list&#xFF08;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E2D;&#xFF09;&#x3002;</p>
<pre><code><span class="xml">//&amp;#x91CA;&amp;#x653E;&amp;#x4E00;&amp;#x4E2A;Item  
void slabs_free(void *ptr, size_t size, unsigned int id) </span><span class="expression">{  
    <span class="variable">pthread</span>_<span class="variable">mutex</span>_<span class="variable">lock</span>(&amp;<span class="variable">amp</span>;<span class="variable">slabs</span>_<span class="variable">lock</span>);  
    /<span class="end-block">/ptr</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;  
    /<span class="end-block">/size</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
    /<span class="end-block">/id</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>54<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">slab</span> <span class="variable">class</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9762;  
    <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, <span class="variable">size</span>, <span class="variable">id</span>);  
    <span class="variable">pthread</span>_<span class="variable">mutex</span>_<span class="variable">unlock</span>(&amp;<span class="variable">amp</span>;<span class="variable">slabs</span>_<span class="variable">lock</span>);  
}</span><span class="xml">


//&amp;#x91CA;&amp;#x653E;&amp;#x4E00;&amp;#x4E2A;item  
static void do_slabs_free(void *ptr, const size_t size, unsigned int id) </span><span class="expression">{  
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;  
    <span class="variable">item</span> *<span class="variable">it</span>;  

    <span class="variable">assert</span>(((<span class="variable">item</span> *)<span class="variable">ptr</span>)<span class="variable">-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slabs</span>_<span class="variable">clsid</span> == 0);  
    <span class="variable">assert</span>(<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>;= <span class="variable">power</span>_<span class="variable">largest</span>);  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> || <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; <span class="variable">power</span>_<span class="variable">largest</span>)  
        <span class="variable">return</span>;  

    <span class="variable">MEMCACHED</span>_<span class="variable">SLABS</span>_<span class="variable">FREE</span>(<span class="variable">size</span>, <span class="variable">id</span>, <span class="variable">ptr</span>);  
    <span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];  

    <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">ptr</span>;  
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> |= <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>;  
    //&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDB</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>2;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>8868;  <span class="variable">freelist</span>  
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;  
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span> = <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = <span class="variable">it</span>;  
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it</span>;  

    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr</span>++;  
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">requested</span> <span class="variable">-</span>= <span class="variable">size</span>;  
    <span class="variable">return</span>;  
}</span><span class="xml"></span>
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2321c83/" title="实践Ok" itemprop="url">实践Ok</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:36.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x80CC;&#x666F;&#xFF1A;&#x5176;&#x5B9E;&#x4E4B;&#x524D;&#x6CA1;&#x6709;&#x7814;&#x7A76;&#x8FC7;c&#x7684;&#x9759;&#x6001;&#x7F16;&#x8BD1;&#xFF0C;&#x5305;&#x62EC;&#x5BF9;Linux&#x4E0B;&#x7684;make&#x4F9D;&#x8D56;&#x5565;&#x7684;&#x4E5F;&#x4E0D;&#x592A;&#x61C2;&#xFF0C;&#x4E8E;&#x662F;&#x8BD5;&#x7740;&#x7528;c&#x7684;&#x5934;&#x6587;&#x4EF6;&#x7EC4;&#x7EC7;&#x6587;&#x4EF6;&#x76F8;&#x4E92;&#x8C03;&#x7528;&#x540C;&#x65F6;&#xFF0C;&#x89C9;&#x5F97;&#x628A;&#x751F;&#x6210;&#x7684;&#x9879;&#x76EE;&#x505A;&#x6210;&#x4E00;&#x4E2A;&#x9759;&#x6001;&#x94FE;&#x63A5;&#x7248;&#x672C;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x4EE5;&#x4FBF;&#x4E8E;&#x5728;&#x5404;&#x79CD;&#x5565;&#x90FD;&#x4E0D;&#x88C5;&#x7684;linux&#x5E73;&#x53F0;&#x4E0A;&#x8FD0;&#x884C;&#xFF08;One file &#xFF0C;run as server ok&#x7684;&#x4E2A;&#x4EBA;&#x7406;&#x60F3;&#x4E3B;&#x4E49;&#x601D;&#x60F3;&#x3002;&#xFF09;&#xFF0C;&#x6709;&#x70B9;&#x50CF;&#x50CF;&#x5C71;&#x5BE8;&#x5D4C;&#x5165;&#x5F0F;&#x5F00;&#x53D1;&#x3002;&#x6211;&#x60F3;&#x7B80;&#x5355;&#xFF0C;&#x94FE;&#x63A5;&#x53C2;&#x6570;&#x52A0;&#x4E00;&#x4E2A;-static&#x4E0D;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x4F46;&#x63A5;&#x4E0B;&#x6765;&#x89E3;&#x51B3;&#x4E00;&#x7CFB;&#x5217;&#x95EE;&#x9898;&#x7684;&#x65F6;&#x95F4;&#x8FDC;&#x8FDC;&#x8D85;&#x51FA;&#x6211;&#x7684;&#x610F;&#x6599;linux &#x9759;&#x6001;&#x94FE;&#x63A5; mysql glibc &#x5E93;&#x7684;&#x60B2;&#x50AC;&#x8FC7;&#x7A0B;&#xFF0C;&#x8FB9;&#x5B66;&#x4E60;&#x8FB9;&#x626F;&#x6DE1;&#xFF0C;&#x8FB9;&#x8BB0;&#x5F55;&#xFF0C;&#x6700;&#x540E;&#x8FD8;&#x662F;&#x786C;&#x7ED9;&#x626F;&#x5230;&#x6700;&#x540E;&#x4E00;&#x6B65;&#x4E86;&#x7ED9;glibc&#x7684;dlopen&#x7ED9;&#x6321;&#x4F4F;&#x4E86;&#xFF0C;&#x6211;&#x770B;&#x7F51;&#x4E0A;&#x4E5F;&#x6709;&#x5144;&#x5F1F;&#x9047;&#x5230;&#x7C7B;&#x4F3C;&#x7684;&#xFF0C;&#x4F46;&#x90FD;&#x6700;&#x540E;&#x59A5;&#x534F;&#x6210;&#x52A8;&#x6001;&#x7F16;&#x8BD1;&#x8FD9;&#x4E2A;glibc&#xFF0C;&#x52A0;&#x4E0A;&#x53C2;&#x6570;&#xFF1A;-ldl&#xFF0C;&#x6211;&#x662F;&#x5B66;&#x4E60;&#x5B9E;&#x8DF5;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x7528;&#x4E86;&#xFF0C;&#x4F46;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x603B;&#x662F;&#x597D;&#x4E8B;&#x60C5;&#x3002;</p>
<p>&#x4E00;&#xFF09;&#x5173;&#x4E8E;Makefile&#x7684;&#x4E09;&#x4E2A;&#x7279;&#x70B9;&#xFF1A;</p>
<p>multipepollserver:multipepollserver.o memcachedclient.o writeFile.o memorypool.o readconf.o&#xA0;&#xA0;multipepollserver.h readconf.h memorypool.h readconf.h memcachedclient.h</p>
<p>/usr/bin/gcc44 -Wall&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread -lmemcached</p>
<p>&#xFF08;1&#xFF09;&#x628A;&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x540E;&#x9762;&#x7684;.h&#x53BB;&#x4E86;&#x4E5F;&#x80FD;&#x7F16;&#x8BD1;&#x8FC7;&#xFF0C;&#x90A3;&#x8FD9;&#x4E9B;.h&#x5728;Makefile&#x91CC;&#x662F;&#x4E0D;&#x662F;&#x6CA1;&#x6709;&#x7528;&#xFF1F;</p>
<p>&#x56DE;&#x7B54;&#xFF1A;.h&#x7528;&#x4E8E;&#x7B26;&#x53F7;&#x94FE;&#x63A5; &#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5305;&#x8FDB;&#x53BB;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6216;&#x52A8;&#x6001;&#x5E93;&#x52A0;&#x8F7D;&#x65F6;&#x4F1A;&#x4EA7;&#x751F;&#x7B26;&#x53F7;&#x8868;&#x627E;&#x4E0D;&#x5230;&#x3002;&#x53BB;&#x6389;&#x662F;&#x6CA1;&#x95EE;&#x9898;&#xFF0C;&#x6211;&#x4E5F;&#x6CA1;&#x52A0;&#x5934;&#x6587;&#x4EF6;&#x3002;&#x52A0;&#x4E0A;&#x5934;&#x6587;&#x4EF6;&#x4F9D;&#x8D56;&#xFF0C;&#x4FEE;&#x6539;&#x5934;&#x6587;&#x4EF6;&#x540E;&#xFF0C;&#x4E5F;&#x4F1A;&#x5F15;&#x8D77;&#x91CD;&#x65B0;&#x7F16;&#x8BD1;&#x3002;</p>
<p>&#xFF08;2&#xFF09;memcachedClientGet&#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x5728;&#x4EE3;&#x7801;&#x91CC;&#x90FD;&#x5305;&#x542B;&#x4E86;&#xFF0C;&#x4F46;&#x662F;make&#x65F6;&#x8BF4;&#x627E;&#x4E0D;&#x5230;&#x3002;</p>
<p>&#x4F60;&#x4E5F;&#x8981;&#x4F9D;&#x8D56;memcachedclient.o&#x5440;&#xFF0C;&#x4F60;&#x7684;&#x5B9E;&#x73B0;&#x5728;&#x8FD9;&#x91CC;&#x9762;&#xFF0C;&#x4F60;&#x4E0D;&#x52A0;&#x8FDB;&#x53BB;&#xFF0C;&#x5F53;&#x7136;&#x627E;&#x4E0D;&#x5230;&#x3002;&#xFF08;&#x8FD9;&#x513F;&#x662F;&#x6838;&#x5FC3;&#xFF1A;&#x5C31;&#x662F;&#x4E0A;&#x9762;&#x7B2C;&#x4E8C;&#x884C;&#xFF0C;&#x8BF4;&#x627E;&#x4E0D;&#x5230;&#xFF1A;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x7B2C;&#x4E8C;&#x884C;&#x624D;&#x662F;&#x771F;&#x6B63;&#x7F16;&#x8BD1;&#x65F6;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x884C;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4EE5;&#x6765;&#x4E4B;&#x7528;&#xFF0C;&#x6CA1;&#x6709;&#x7B2C;&#x4E00;&#x884C;&#x7684;.o&#xFF0C;&#x90A3;&#x4E48;&#xFF0C;&#x540E;&#x9762;&#x5199;&#x7684;&#x8FD9;&#x4E9B;.oMakefile&#x89C4;&#x5219;&#x662F;&#x4E0D;&#x4F1A;&#x53BB;&#x7F16;&#x8BD1;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x5F97;&#x5199;&#x4E0A;&#x6D89;&#x53CA;&#x5230;&#x7684;.o&#x3002;&#xFF09;</p>
<p>&#x662F;&#x7684;&#xFF0C;&#x5982;&#x4E0B;&#xFF0C;&#x5C45;&#x7136;&#x8BF4;&#x627E;&#x4E0D;&#x5230;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;</p>
<p>vi multipepollserver.h</p>
<h1 id="include_&quot;memcachedclient-h&quot;">include &quot;memcachedclient.h&quot;</h1><p>&#x8FD9;&#x4E2A;&#x6211;&#x6709;&#x5305;&#x542B;&#x7684;&#x5440;&#xFF0C;</p>
<p>vim memcachedclient.c</p>
<h1 id="include_&quot;memcachedclient-h&quot;&#xA0;&#xA0;">include &quot;memcachedclient.h&quot;&#xA0;&#xA0;</h1><p>ls&#xA0;&#xA0;memcachedclient.h</p>
<p>memcachedclient.h</p>
<p>cat memcachedclient.c|grep memcachedClientGet</p>
<p>int memcachedClientGet(char <em>getKey,char </em>value){</p>
<p>&#x4E8C;&#xFF09;&#x5173;&#x4E8E;&#x9759;&#x6001;&#x7F16;&#x8BD1;&#xFF1A;</p>
<p>&#x95EE;:&#x5982;&#x4F55;&#x628A;memcached&#x7531;&#x52A8;&#x6001;&#x7F16;&#x8BD1;&#x53D8;&#x4E3A;&#x9759;&#x6001;&#x7F16;&#x8BD1;&#xFF1A;</p>
<p>&#x7B54;&#xFF1A;&#x628A; -lmemcached &#x6539;&#x6210; /…/libmemcached.a</p>
<p>&#x5B83;&#x4E0D;&#x662F;.a&#xFF0C;&#x662F;.la&#xFF0C;&#x8981;.a&#x7684;&#xFF0C;.la&#x4E3A;libtool&#x81EA;&#x52A8;&#x751F;&#x6210;&#x7684;&#x4E00;&#x4E9B;&#x5171;&#x4EAB;&#x5E93;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;vi&#x7F16;&#x8F91;&#x67E5;&#x770B;&#xFF0C;&#x4E3B;&#x8981;&#x8BB0;&#x5F55;&#x4E86;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x5B83;&#x4E3A;&#x4F55;&#x4E0D;&#x5728;&#xFF1A;/usr/local/libmemcached/&#x4E0B;&#x9762;&#xFF0C;&#x800C;&#x662F;&#x5728;&#xFF0C;&#x4E3A;&#x4F55;&#x4E0D;&#x653E;&#x4E00;&#x5757;&#x513F;&#xFF1F;</p>
<p>&#x51FA;&#x73B0;&#xFF1A;undefined reference to `sasl_done&apos;</p>
<p>&#x7248;&#x672C;&#x5BF9;&#x4E0D;&#x5BF9;&#xFF1F;&#xFF1F;</p>
<p>&#x4F30;&#x8BA1;&#x8FD9;&#x4E9B;&#x63A5;&#x53E3;&#x662F;&#x5728;&#x65B0;&#x7248;&#x672C;&#x4E2D;&#x65B0;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x4F60;&#x94FE;&#x63A5;&#x7684;&#x53EF;&#x80FD;&#x662F;&#x65E7;&#x7248;&#x672C;&#x3002;</p>
<p>&#x6211;&#x5BF9;memcached&#x6CA1;&#x7814;&#x7A76;&#xFF0C;&#x4E0D;&#x6E05;&#x695A;&#x3002;</p>
<p>&#x9759;&#x6001;&#x5E93;&#x7248;&#x672C;&#x4F30;&#x8BA1;&#x770B;&#x4E0D;&#x51FA;&#xFF0C;&#x9664;&#x975E;&#x5B83;&#x6E90;&#x4EE3;&#x7801;&#x91CC;&#x6709;&#x7248;&#x672C;&#x4FE1;&#x606F;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x53EF;&#x4EE5;&#x6293;&#x4E00;&#x6293;&#x3002;</p>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x6267;&#x884C;</p>
<p>strings libmemcached.a | grep &#x627E;&#x4E0D;&#x5230;&#x7684;&#x63A5;&#x53E3;&#x540D;&#x79F0;</p>
<p>&#x770B;&#x6709;&#x6CA1;&#x6709;&#x6253;&#x5370;&#xFF0C;&#x6CA1;&#x6253;&#x5370;&#x4EC0;&#x4E48;&#x5185;&#x5BB9;&#xFF0C;&#x90A3;&#x5C31;&#x8BF4;&#x660E;&#x8BE5;&#x9759;&#x6001;&#x5E93;&#x91CC;&#x9762;&#x6CA1;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x3002;</p>
<p>&#x5144;&#x5F1F;&#x6240;&#x8BF4;&#x7684;&#x4E5F;&#x5C31;&#x662F;.h&#x7684;&#x5B9A;&#x4E49;&#x548C;&#x8FD9;&#x4E2A;.a&#x4E0D;&#x5339;&#x914D;&#x662F;&#x5427;&#xFF1A;</p>
<p>1&#xFF09;libmemcached/memcached.h&#xA0;&#xA0;&#xFF08;/usr/local/libmemcached/&#xFF09;</p>
<p>2&#xFF09;/usr/local/lib/libmemcached.a</p>
<p>&#x4F60;&#x8FD9;&#x4E2A;&#x9759;&#x6001;&#x5E93;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;&#x662F;&#x4E0D;&#x662F;&#x6CA1;&#x6709;&#x5F00;&#x542F;sasl&#x652F;&#x6301;&#xFF1F;&#x5BFC;&#x81F4;&#x7F16;&#x8BD1;&#x51FA;&#x6765;&#x7684;&#x662F;&#x6CA1;&#x5E26;sasl&#x3002;</p>
<p>[root@test libmemcached-1.0.18]# ./configure —prefix=/usr/local/libmemcached —enable-sasl</p>
<p>[root@test libmemcached-1.0.18]# make clean &amp; make &amp; make install</p>
<p>./libmemcached-1.0/memcached.h:46:23: error: cinttypes: No such file or directory //&#x6839;&#x636E;&#x7ECF;&#x9A8C;&#xFF0C;&#x53C8;&#x662F;gcc&#x7684;&#x7248;&#x672C;&#x4E0D;&#x591F;&#x4E86;&#x3002;</p>
<p>export CC=/usr/bin/gcc44</p>
<p>export CXX=/usr/bin/g++44</p>
<p>&#x4E00;&#x5B9A;&#x8981;&#x786E;&#x8BA4;&#x662F;&#x5426;&#x52A0;&#x6210;&#x529F;&#x4E86;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>[root@test libmemcached-1.0.18]# echo $CC</p>
<p>/usr/bin/gcc44</p>
<p>[root@test libmemcached-1.0.18]#&#xA0;&#xA0;echo $CXX</p>
<p>/usr/bin/g++44</p>
<p>&#x4E8E;&#x662F;&#x7F16;&#x8BD1;&#x901A;&#x8FC7;&#x4E86;&#xFF0C; &#x7F16;&#x8BD1;&#x518D;&#x6B21;&#x987A;&#x5229;&#x901A;&#x8FC7;&#xFF0C;&#x6765;&#x81EA;&#xFF1A;<a href="https://justwinit.cn/post/7693/" target="_blank" rel="external">https://justwinit.cn/post/7693/</a></p>
<p>&#x95EE;&#x9898;&#x8FD8;&#x6709;&#xFF1A;</p>
<p>/usr/local/libmemcached/lib/libmemcached.a(libmemcached_libmemcached_la-delete.o):(.data.DW.ref.<strong>gxx_personality_v0[DW.ref.</strong>gxx_personality_v0]+0x0): undefined reference to `__gxx_personality_v0&apos;</p>
<p>/usr/local/libmemcached/lib/libmemcached.a(libmemcached_libmemcached_la-hosts.o): In function `update_continuum&apos;:</p>
<p>/opt/libmemcached-1.0.18/libmemcached/hosts.cc:222: undefined reference to `floorf&apos;</p>
<p>/usr/local/libmemcached/lib/libmemcached.a(libmemcached_libmemcached_la-sasl.o): In function `sasl_startup_function&apos;:</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:126: undefined reference to `sasl_client_init&apos;</p>
<p>/usr/local/libmemcached/lib/libmemcached.a(libmemcached_libmemcached_la-sasl.o): In function `memcached_sasl_authenticate_connection(memcached_instance_st*)&apos;:</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:210: undefined reference to `sasl_errstring&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:218: undefined reference to `sasl_client_new&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:220: undefined reference to `sasl_errstring&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:222: undefined reference to `sasl_dispose&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:231: undefined reference to `sasl_client_start&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:234: undefined reference to `sasl_errstring&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:236: undefined reference to `sasl_dispose&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:276: undefined reference to `sasl_client_step&apos;</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:289: undefined reference to `sasl_dispose&apos;</p>
<p>/usr/local/libmemcached/lib/libmemcached.a(libmemcached_libmemcached_la-sasl.o): In function `sasl_shutdown_function&apos;:</p>
<p>/opt/libmemcached-1.0.18/libmemcached/sasl.cc:117: undefined reference to `sasl_done&apos;</p>
<p>&#x4F30;&#x8BA1;&#x662F;&#x5F15;&#x5165;&#x7684;memcached.h&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x627E;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x6211;&#x662F;&#x5B89;&#x88C5;&#x5728;/usr/local/libmemcached&#x4E0B;&#xFF0C;&#x800C;&#x6211;&#x770B;&#x5176;&#x5B83;&#x5730;&#x65B9;&#x8FD8;&#x6709;&#xFF0C;&#x4E8E;&#x662F;&#x76F4;&#x63A5;&#x628A;/usr/local/include/libmemcached-1.0/&#x5934;&#x6587;&#x4EF6;&#x8986;&#x76D6;&#x5F97;&#x4E86;&#xFF1A;</p>
<p>[root@test /]# find . -name &quot;memcached.h&quot;</p>
<p>./home/xiangdong/software/gearmand-1.1.12/libtest/memcached.h</p>
<p>./usr/local/libmemcached2/include/libmemcached/memcached.h</p>
<p>./usr/local/libmemcached/include/libmemcached-1.0/struct/memcached.h</p>
<p>./usr/local/libmemcached/include/libmemcached-1.0/memcached.h</p>
<p>./usr/local/libmemcached/include/libmemcached/memcached.h</p>
<p>./usr/local/include/libmemcached-1.0/struct/memcached.h</p>
<p>./usr/local/include/libmemcached-1.0/memcached.h</p>
<p>./usr/local/include/libmemcached/memcached.h</p>
<hr>
<p>rm -Rf /usr/local/include/libmemcached/*</p>
<p>rm -Rf /usr/local/include/libmemcachedutil-1.0/*</p>
<p>cp -Rf /usr/local/libmemcached/include/libmemcachedutil-1.0/* /usr/local/include/libmemcachedutil-1.0/.</p>
<p>cp -Rf /usr/local/libmemcached/include/libmemcached/*&#xA0;&#xA0;/usr/local/include/libmemcached/.</p>
<hr>
<p>[root@test multepoolserver]# make clean;make</p>
<p>rm -f memcachedclient.o memorypool.o&#xA0;&#xA0;multipepollserver.o multipepollserver writeFile.o readconf.o</p>
<p>/usr/bin/gcc44&#xA0;&#xA0;-Wall&#xA0;&#xA0;-O0 -g3 -gdwarf-2 -c -g multipepollserver.c</p>
<p>In file included from multipepollserver.h:27,</p>
<p>from multipepollserver.c:6:</p>
<p>/usr/local/include/libmemcached/memcached.h:39:40: error: libmemcached-1.0/memcached.h: No such file or directory</p>
<p>&#x679C;&#x7136;&#x662F;&#x8FD9;&#x513F;&#x8BFB;&#x53D6;&#xFF0C;/usr/local/include/libmemcached-1.0 &#x7ED9;&#x6211;&#x5220;&#x9664;&#x4E86;&#xFF0C;&#x8FD8;&#x662F;&#x62F7;&#x8D1D;&#x8FC7;&#x53BB;&#x5427;&#xFF1A;</p>
<pre><code>cp -Rf  <span class="regexp">/usr/</span>local<span class="regexp">/libmemcached/i</span>nclude<span class="regexp">/libmemcached-1.0 /u</span>sr<span class="regexp">/local/i</span>nclude<span class="regexp">/.</span>
</code></pre><p>&#x95EE;&#x9898;&#x8FD8;&#x4F9D;&#x65E7;&#xFF0C;&#x600E;&#x4E48;&#x529E;&#xFF1A;</p>
<p>[root@test /]# find . -name &quot;libmemcached.a&quot;</p>
<p>./usr/local/lib/libmemcached.a</p>
<p>./usr/local/libmemcached/lib/libmemcached.a</p>
<p>md5&#x5BF9;&#x6BD4;&#x4E0B;&#x662F;&#x5426;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x8FD8;&#x771F;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x4E24;&#x4E2A;&#x540C;&#x6837;&#x7684;&#x6587;&#x4EF6;&#xFF1A;</p>
<p>[root@test lib]# md5sum /usr/local/lib/libmemcached.a</p>
<p>d1f93fcf34649c5d72b19e636b2c1b2e&#xA0;&#xA0;/usr/local/lib/libmemcached.a</p>
<p>[root@test lib]# md5sum /usr/local/libmemcached/lib/libmemcached.a</p>
<p>4026e0e061d0692b3a3b7016ee4a6066&#xA0;&#xA0;/usr/local/libmemcached/lib/libmemcached.a</p>
<p>&#x8FD9;&#x4E2A;.a&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x5F97;&#x4ECE;&#x6211;&#x521A;&#x7F16;&#x8BD1;&#x7684;&#x8DEF;&#x5F84;&#x7ED9;&#x8986;&#x76D6;&#x5230;/usr/local/lib/&#xFF0C;&#x6BD4;&#x5BF9;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x76F4;&#x63A5;&#x62F7;&#x8D1D;&#x8FC7;&#x53BB;&#x5F97;&#x4E86;&#xFF1A;</p>
<p>cp -Rf /usr/local/libmemcached/lib/* /usr/local/lib/.</p>
<p>yes|cp -Rf /usr/local/libmemcached/lib/* /usr/local/lib/.</p>
<p>&#x4F9D;&#x65E7;&#x4E0D;Ok&#xFF0C;&#x7F16;&#x8BD1;&#x8FD8;&#x662F;&#x9047;&#x5230;&#x95EE;&#x9898;&#xFF0C;&#x663E;&#x793A;&#x65E0;&#x6CD5;&#x94FE;&#x63A5;&#x5230;sasl&#x7684;&#x4E00;&#x4E9B;&#x6587;&#x4EF6;&#x3002;&#x95EE;&#x9898;&#x663E;&#x793A;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>undefined reference to `sasl_client_step&apos;</p>
<p>undefined reference to `sasl_dispose&apos;</p>
<p>undefined reference to `sasl_client_start&apos;</p>
<p>undefined reference to `sasl_client_new&apos;</p>
<p>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x4E0D;&#x884C;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</p>
<p>/usr/bin/gcc44 -Wall&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memcachedclient.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread&#xA0;&#xA0; /usr/local/lib/libmemcached.a</p>
<p>/usr/local/lib/libmemcached.a(libmemcached_libmemcached_la-delete.o):(.data.DW.ref.<strong>gxx_personality_v0[DW.ref.</strong>gxx_personality_v0]+0x0): undefined reference to `__gxx_personality_v0&apos;</p>
<p>&#x6700;&#x540E;&#x52A0;&#x4E0A;&#xFFFD;&#xFFFD;&#xFFFD;-lstdc++</p>
<p>multipepollserver:multipepollserver.o memcachedclient.o writeFile.o memorypool.o readconf.o</p>
<p>/usr/bin/gcc44 -Wall&#xA0;&#xA0;-lstdc++&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memcachedclient.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread&#xA0;&#xA0; /usr/local/lib/libmemcached.a</p>
<p>&#x597D;&#x4E86;&#x3002;</p>
<p>&#x5907;&#x6848;&#x5728;&#xFF1A;<a href="http://justwinit.cn/post/7981/" target="_blank" rel="external">http://justwinit.cn/post/7981/</a></p>
<p>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</p>
<p>&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#x662F;&#x91CD;&#x65B0;&#x6267;&#x884C;configure&#x547D;&#x4EE4;&#xFF0C;&#x589E;&#x52A0;&#x76F8;&#x5E94;&#x7684;&#x53C2;&#x6570;&#x3002;sudo&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF1A;sudo ./configure —prefix=/usr/local/libmemcached&#xA0;&#xA0;—enable-sasl —without-memcached LDFLAGS=-Wl,—as-neede &#xFF1B;make&#xFF1B; make install</p>
<p>&#x9047;&#x5230;&#x95EE;&#x9898;&#xFF1A;fatal error: sasl/sasl.h: No such file or directory. &#x5728;&#x7F51;&#x4E0A;&#x641C;&#x5230;&#x7684;&#x89E3;&#x51B3;&#x529E;&#x6CD5;&#x662F;&#xFF1A;</p>
<p>Depending on your operating system, you&apos;ll need to install the cyrus-sasl development package.</p>
<p>That would be cyrus-sasl-devel on RedHat based distros and libsasl2-dev on Debian based distros IIRC.</p>
<p>&#x6211;&#x5728;ubuntu&#x4E0B;&#x76F4;&#x63A5;&#x7528;sudo apt-get install libsasl2-dev &#x5B89;&#x88C5;&#x4E86;&#x3002;</p>
<p>&#x8BF4;&#x660E;&#x679C;&#x7136;&#x662F;&#x6709;&#x8FD9;&#x4E2A;libsal2-dev&#x7684;&#x5B89;&#x88C5;&#x5305;&#x7684;,CentOS&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x4F46;&#x4E5F;&#x7C7B;&#x4F3C;&#xFF0C;&#x4E8E;&#x662F;ls&#x4E0B;&#xFF1A;</p>
<p>[root@test multepoolserver]# ls /usr/lib/libsasl2*</p>
<p>/usr/lib/libsasl2.a&#xA0;&#xA0;/usr/lib/libsasl2.so&#xA0;&#xA0;/usr/lib/libsasl2.so.2&#xA0;&#xA0;/usr/lib/libsasl2.so.2.0.22</p>
<p>/usr/bin/gcc44 -Wall&#xA0;&#xA0;-lstdc++&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memcachedclient.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread&#xA0;&#xA0; /usr/local/lib/libmemcached.a /usr/lib/libsasl2.a&#xA0;&#xA0;</p>
<p>&#x4E8E;&#x662F;&#x628A;&#xFF1A;/usr/lib/libsasl2.a &#x653E;&#x5230;makefile&#x91CC;&#xFF0C;&#x518D;&#x7F16;&#x8BD1;&#x51FA;&#x73B0; incompatible with i386:x86-64 output&#xFF1A;</p>
<p>rpm -ql cyrus-sasl-devel-2.1.22-5.el5_4.3 &#x53D1;&#x73B0;&#x4F4D;&#x7F6E;&#x5728;&#x8FD9;&#x513F;&#xFF1A;</p>
<p>/usr/lib/libsasl2.a&#xA0;&#xA0; &#x4E0D;&#x5BF9;&#xFF0C;64&#x4F4D;&#x7684;&#x4F4D;&#x7F6E;&#x5728;&#x8FD9;&#x513F;&#xFF1A;/usr/lib64/libsasl2.a</p>
<p>/usr/include/sasl/sasl.h</p>
<p>/usr/include/sasl/saslplug.h</p>
<p>/usr/include/sasl/saslutil.h</p>
<p>/usr/lib/libsasl2.a</p>
<p>/usr/lib/libsasl2.so</p>
<p>/usr/include/sasl/prop.h</p>
<p>/usr/include/sasl/sasl.h</p>
<p>/usr/include/sasl/saslplug.h</p>
<p>/usr/include/sasl/saslutil.h</p>
<p>/usr/lib64/libsasl2.a</p>
<p>/usr/lib64/libsasl2.so</p>
<p>&#x4FEE;&#x6539;&#x540E;&#xFF0C;&#x8FD8;&#x6709;&#x9519;&#xFF0C;&#x542C;&#x8BF4;&#x662F;&#x548C;openssl&#x6709;&#x5173;&#xFF1A;</p>
<p>/usr/lib64/libsasl2.a(digestmd5.o): In function `dec_3des&apos;:</p>
<p>(.text+0x6c0): undefined reference to `DES_ede3_cbc_encrypt&apos;</p>
<p>/usr/lib64/libsasl2.a(digestmd5.o): In function `init_3des&apos;:</p>
<p>(.text+0x3bf2): undefined reference to `DES_key_sched&apos;</p>
<p>/usr/lib64/libsasl2.a(digestmd5.o): In function `init_3des&apos;:</p>
<p>[root@test multepoolserver]# rpm -ql openssl-devel-0.9.8e-12.el5_4.6|grep .so</p>
<p>/usr/include/openssl/dso.h</p>
<p>/usr/lib64/libcrypto.so</p>
<p>/usr/lib64/libssl.so</p>
<p>[root@test multepoolserver]# ls /usr/lib64/libssl.a</p>
<p>/usr/lib64/libssl.a</p>
<p>[root@test multepoolserver]# rpm -ql openssl-devel-0.9.8e-12.el5_4.6|grep &quot;ssl.h&quot;</p>
<p>/usr/include/openssl/hmac.h</p>
<p>/usr/include/openssl/kssl.h</p>
<p>/usr/include/openssl/ssl.h</p>
<p>/usr/include/openssl/hmac.h</p>
<p>/usr/include/openssl/kssl.h</p>
<p>/usr/include/openssl/ssl.h</p>
<p>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</p>
<p>&#x52A0;&#x4E0A;&#xFF1A;</p>
<p>/usr/lib64/libssl.so</p>
<p>/usr/include/openssl/ssl.h</p>
<p>/usr/include/openssl/ssl.h</p>
<p>/usr/include/sasl/sasl.h</p>
<p>vi memcachedclient.h</p>
<h1 id="include_&lt;sasl/sasl-h&gt;">include &lt;sasl/sasl.h&gt;</h1><h1 id="include_&lt;openssl/ssl-h&gt;&#xA0;&#xA0;">include &lt;openssl/ssl.h&gt;&#xA0;&#xA0;</h1><p>Makefile&#x91CC;&#x52A0;&#x4E0A;&#xFF1A;</p>
<p>multipepollserver:multipepollserver.o memcachedclient.o writeFile.o memorypool.o readconf.o</p>
<p>/usr/bin/gcc44 -Wall&#xA0;&#xA0;-lstdc++&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memcachedclient.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread&#xA0;&#xA0; /usr/local/lib/libmemcached.a /usr/lib64/libsasl2.a /usr/lib64/libssl.a</p>
<p>&#x62A5;&#x9519;&#xFF1A;</p>
<p>/usr/lib64/libsasl2.a(gssapi.o): In function `gssapi_client_mech_step&apos;:</p>
<p>(.text+0x1263): undefined reference to `GSS_C_NT_HOSTBASED_SERVICE&apos;</p>
<p>&#x4E8E;&#x662F;&#x518D;&#x67E5;&#xFF0C;&#x53D1;&#x73B0;&#x8FD9;&#x73A9;&#x610F;&#x6709;&#x5173;&#xFF1A;</p>
<p>libgssapi-0.10-2.i386.rpm</p>
<p>/usr/lib/libgssapi_krb5.so</p>
<p>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;yum search libgssapi&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</p>
<p>libgssapi.i386 : Generic Security Services Application Programming Interface Library</p>
<p>libgssapi.x86_64 : Generic Security Services Application Programming Interface Library</p>
<p>libgssapi-devel.i386 : Development files for the gssapi library</p>
<p>libgssapi-devel.x86_64 : Development files for the gssapi library</p>
<p>&#x4E8E;&#x662F;64&#x4F4D;&#x673A;&#x5668;&#x5C31;&#x5B89;&#x88C5;&#xFF1A;libgssapi-devel.x86_64 &#x5427; &#xFF1A;yum install libgssapi-devel.x86_64</p>
<p>rpm -ql libgssapi-devel.x86_64</p>
<p>/usr/include/gssglue/gssapi/gssapi.h</p>
<p>/usr/lib64/libgssapi.a</p>
<p>/usr/lib64/libgssapi.so</p>
<p>/usr/lib64/pkgconfig/libgssapi.pc</p>
<p>&#x4E8E;&#x662F;&#x6709;&#x4E86;&#xFF0C;&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x9519;&#x4E0D;&#x62A5;&#x4E86;&#xFF0C;&#x6709;&#x65B0;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>/usr/bin/gcc44 -Wall&#xA0;&#xA0;-lstdc++&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memcachedclient.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread&#xA0;&#xA0; /usr/local/lib/libmemcached.a /usr/lib64/libsasl2.a /usr/lib64/libssl.a /usr/lib64/libcrypto.a /usr/lib64/libgssapi.a</p>
<p>/usr/lib64/libcrypto.a(fips.o): In function `FIPSCHECK_verify&apos;:</p>
<p>(.text+0x7fa): undefined reference to `dlopen&apos;</p>
<p>/usr/lib64/libcrypto.a(fips.o): In function `FIPSCHECK_verify&apos;:</p>
<p>(.text+0x80f): undefined reference to `dlsym&apos;</p>
<p>/usr/lib64/libcrypto.a(fips.o): In function `FIPSCHECK_verify&apos;:</p>
<p>&#x7F16;&#x8BD1;&#x9519;&#x8BEF;undefined reference to `dlsym&apos; &#xFF0C;&#x4ECA;&#x5929;&#x7F16;&#x8BD1;&#x78B0;&#x5230;&#x4E86;&#x95EE;&#x9898;&#xFF0C;&#x52A0;&#x4E86;-ldl&#x5C31;ok&#x4E86;&#x3002;</p>
<p>[c-sharp] view plaincopy</p>
<p>dso_dlfcn.c:(.text+0x325): undefined reference to `dlsym&apos;&#xA0;&#xA0;</p>
<p>dso_dlfcn.c:(.text+0x408): undefined reference to `dlerror&apos;&#xA0;&#xA0;&#x5C31;Ok&#x4E86;&#xFF0C;From:<a href="http://blog.csdn.net/shareyao/article/details/5362642" target="_blank" rel="external">http://blog.csdn.net/shareyao/article/details/5362642</a></p>
<p>&#x7EE7;&#x7EED;&#x67E5;&#xFF0C;&#x8FD9;&#x4E2A;&#x662F;glibc&#x5E93;&#x7684;&#xFF1A; rpm -ql glibc-devel-2.5-42&#xA0;&#xA0;</p>
<p>rpm -ql glibc-devel-2.5-42|grep &quot;libdl.so&quot;</p>
<p>/usr/lib/libdl.so</p>
<p>/usr/lib64/libdl.so</p>
<p>&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#xFFFD;&#xFFFD;&#xFFFD;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;&#x2014;</p>
<p>ls /usr/lib64/libdl.so</p>
<p>/usr/lib64/libdl.so</p>
<p>ls /usr/lib64/libdl.a</p>
<p>/usr/lib64/libdl.a</p>
<p>&#x53EA;&#x52A0;&#xFF1A;/usr/lib64/libdl.a &#x8FD8;&#x662F;&#x4F1A;&#x7EE7;&#x7EED;&#x62A5;&#x540C;&#x6837;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x5728;&#x8FD9;&#x513F;&#x770B;&#x5230;&#x4E86;&#xFF0C;&#x8FD8;&#x5F97;&#x52A0;&#xFF1A;/usr/lib64/libc.a&#xA0;&#xA0;</p>
<p>&#x81EA;&#x5DF1;&#x6298;&#x817E;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x9759;&#x6001;&#x94FE;&#x63A5;libdl.a&#x7684;&#x540C;&#x65F6;&#x628A;libc.a&#x4E5F;&#x94FE;&#x63A5;&#x8FC7;&#x53BB;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x89E3;&#x51B3;&#x201C;undefined reference&#x201D;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4ECE;&#x800C;&#x5F97;&#x5230;&#x53EF;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#x3002;&#x8FD9;&#x91CC;&#x5F88;&#x5947;&#x602A;&#xFF0C;dlopen&#x662F;&#x5728;libdl.a&#x91CC;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x7684;&#x5B9E;&#x73B0;—__dlopen&#x5374;&#x662F;&#x5728;libc.a&#x91CC;&#x3002;&#x3002;&#x3002;</p>
<p><a href="http://www.newsmth.net/nForum/#!article/CProgramming/113004" target="_blank" rel="external">http://www.newsmth.net/nForum/#!article/CProgramming/113004</a></p>
<p>&#x6700;&#x7EC8;&#x5927;&#x529F;&#x544A;&#x6210;&#xFF0C;&#x5176;&#x4E2D;&#x8001;&#x7F57;&#x6700;&#x591A;&#x7684;&#x4E5F;&#x662F;&#x52A8;&#x6001;&#xFF0C;&#x5BF9;&#x9759;&#x6001;&#x4E5F;&#x4E0D;&#x662F;&#x592A;&#x660E;&#x767D;&#xFF0C;&#x4F46;&#x4E0D;&#x7BA1;&#x600E;&#x4E48;&#x6837;&#x7ECF;&#x8FC7;&#x8FD9;&#x4E00;&#x4E2A;&#x8FC7;&#x7A0B;&#x6216;&#x5F97;&#x4E86;&#x9759;&#x6001;&#x7684;&#x7ECF;&#x9A8C;&#xFF1A;</p>
<p>[root@test multepoolserver]# /usr/bin/gcc44 -Wall&#xA0;&#xA0;-lstdc++&#xA0;&#xA0;-O0 -g -o multipepollserver&#xA0;&#xA0;multipepollserver.o memcachedclient.o memorypool.o readconf.o&#xA0;&#xA0;writeFile.o -lrt -lpthread&#xA0;&#xA0; /usr/local/lib/libmemcached.a /usr/lib64/libsasl2.a /usr/lib64/libssl.a /usr/lib64/libcrypto.a /usr/lib64/libgssapi.a /usr/lib64/libdl.a /usr/lib64/libc.a</p>
<p>/usr/lib64/libcrypto.a(fips.o): In function `FIPSCHECK_verify&apos;:</p>
<p>(.text+0x7fa): warning: Using &apos;dlopen&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</p>
<p>/usr/local/lib/libmemcached.a(libmemcached_libmemcached_la-connect.o): In function `set_hostinfo&apos;:</p>
<p>/opt/libmemcached-1.0.18/libmemcached/connect.cc:217: warning: Using &apos;getaddrinfo&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking</p>
<p>[root@test multepoolserver]# ls multipepollserver</p>
<p>multipepollserver&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; EOF</p>
<p>glibc —static&#x7F16;&#x8BD1;&#x53EF;&#x80FD;&#x4F1A;&#x4EA7;&#x751F;&#x4E0B;&#x9762;&#x7684;warning:warning: Using &apos;getservbyport_r&apos; in statically linked applications requires at runtime the shared libraries from the glibc version used for linking&#x8FD9;&#x4E2A;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x662F;&#x7531;&#x4E8E;getservbyport_r &#x8FD9;&#x6837;&#x7684;&#x63A5;&#x53E3;&#x8FD8;&#x662F;&#x9700;&#x8981;&#x52A8;&#x6001;&#x5E93;&#x7684;&#x652F;&#x6301;&#x624D;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#xFF0C;&#x8BB8;&#x591A;glibc&#x7684;&#x51FD;&#x6570;&#x90FD;&#x5B58;&#x5728;&#x8FD9;&#x6837;&#x7684;&#x95EE;&#x9898;, &#x7279;&#x522B;&#x662F;&#x7F51;&#x7EDC;&#x7F16;&#x7A0B;&#x7684;&#x63A5;&#x53E3;&#x4E2D;&#x662F;&#x5F88;&#x5E38;&#x89C1;&#x7684;&#xFF0E;&#x5BF9;&#x4E00;&#x4E9B;&#x7B2C;&#x4E09;&#x65B9;&#x5DE5;&#x5177;&#x4E0D;&#x53CB;&#x597D;&#xFF0C;&#x7C7B;&#x4F3C;valgrind&#x68C0;&#x67E5;&#x5185;&#x5B58;&#x6CC4;&#x9732;&#x4E3A;&#x4E86;&#x4E0D;&#x5728;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8BEF;&#x62A5;, &#x5B83;&#x9700;&#x8981;&#x7528;&#x52A8;&#x6001;&#x5E93;&#x7684;&#x65B9;&#x5F0F;&#x66FF;&#x6362;glibc&#x4E2D;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x9759;&#x6001;&#x7F16;&#x8BD1;&#x90A3;&#x4E48;valgrind&#x5C31;&#x65E0;&#x6CD5;&#x66FF;&#x6362;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#xFF0C;&#x4EA7;&#x751F;&#x8BEF;&#x62A5;&#x751A;&#x81F3;&#x65E0;&#x6CD5;&#x62A5;&#x9519;&#xFF0E;</p>
<p>linux &#x9759;&#x6001;&#x94FE;&#x63A5; mysql glibc &#x5E93;&#x7684;&#x60B2;&#x50AC;&#x8FC7;&#x7A0B; :<a href="http://renshuming8231.blog.163.com/blog/static/1294837652012112954619545/" target="_blank" rel="external">http://renshuming8231.blog.163.com/blog/static/1294837652012112954619545/</a></p>
<p>&#x94FE;&#x63A5;&#x5DF2;&#x7ECF;&#x6210;&#x529F;&#x4E86;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x4E0D;&#x5EFA;&#x8BAE;&#x7528; -static&#xFF0C;&#x5B83;&#x8BF4;&#x7684;&#x610F;&#x601D;getaddrinfo&#x5728;&#x52A8;&#x6001;&#x5E93;&#x4E2D;,&#x5374;&#x7528;static&#x7684;&#x65B9;&#x5F0F;&#x94FE;&#x63A5;&#x4E86;&#x3002;&#x6CA1;&#x4E8B;&#x5427;&#xFF1F;</p>
<p>/usr/lib64/libc.a</p>
<p>grep getaddrinfo /usr/lib/*.a</p>
<p>Binary file /usr/lib/libc.a matches</p>
<p>&#x5F53;&#x8BE5;a.out&#x5728;&#x672C;&#x673A;&#x8DD1;&#x7684;&#x65F6;&#x5019;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x4E3A;dlopen&#x548C;&#x76F8;&#x5E94;&#x7684;&#x52A8;&#x6001;&#x5E93;&#x683C;&#x5F0F;&#x662F;&#x76F8;&#x4E92;&#x4E86;&#x89E3;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x679C;&#x5728;&#x4E00;&#x4E2A;&#x522B;&#x7684;&#x7CFB;&#x7EDF;&#x4E0A;</p>
<p>&#x6267;&#x884C;dlopen&#x65F6;,&#x5F88;&#x53EF;&#x80FD;&#x51FA;&#x9519;</p>
<p>&#x5C31;&#x662F;&#x8BF4;&#x672C;&#x6765;static&#x662F;&#x4E3A;&#x4E86;&#x968F;&#x4FBF;&#x62FF;&#x5230;&#x522B;&#x7684;&#x673A;&#x5668;&#x8DD1;&#xFF0C;&#x800C;&#x53EF;&#x80FD;&#x53D1;&#x751F;&#x9519;&#x8BEF;&#xFF08;&#x751A;&#x81F3;&#x83AB;&#x540D;&#x5947;&#x5999;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x6211;&#x73B0;&#x5B9E;&#x4E2D;&#x9047;&#x5230;&#x8FC7;&#xFF0C;&#x51E0;&#x4E4E;&#x6CA1;&#x6CD5;&#x8C03;&#x8BD5;&#xFF0C;&#x4EE5;&#x524D;&#x8FD8;&#x4E0D;&#x77E5;&#x9053;&#x539F;&#x56E0;&#xFF09;</p>
<p>&#x6240;&#x4EE5;&#x6709;&#x4E2A;&#x8B66;&#x544A;,&#x5982;&#x679C;&#x9759;&#x6001;&#x7F16;&#x8BD1;&#x7684;&#x8BDD;&#xFF0C;&#x5FFD;&#x7565;&#x8FD9;&#x4E2A;&#x8B66;&#x544A;&#x4F7F;&#x7528;&#x4E2D;&#x4F1A;&#x6709;&#x95EE;&#x9898;&#x5417;&#xFF1F;&#x53EA;&#x662F;&#x8B66;&#x544A;&#x4F60;&#x6709;&#xFFFD;&#xFFFD;&#xFFFD;&#x80FD;&#x51FA;&#x9519;&#x800C;&#x5DF2;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Makefile/">Makefile</a><a href="/tags/libmemcached/">libmemcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2335292/" title="memcache源代码研究 - overview -" itemprop="url">memcache源代码研究 - overview -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:36.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="&#x7EBF;&#x7A0B;&#x6A21;&#x578B;">&#x7EBF;&#x7A0B;&#x6A21;&#x578B;</h4><p>&#x9996;&#x5148;&#xFF0C;memcache &#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x7EC4; worker &#x7EBF;&#x7A0B;&#xFF0C;&#x4E3B;&#x7EBF;&#x7A0B;&#x63A5;&#x6536;&#x5230;&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x4F1A;&#x8F6C;&#x7ED9; worker &#x7EBF;&#x7A0B;&#x53BB;&#x5904;&#x7406;&#x3002;&#x9700;&#x8981;&#x591A;&#x63D0;&#x4E00;&#x53E5;&#x7684;&#x662F;&#xFF0C;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E0E;&#x5404; worker &#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x662F;&#x901A;&#x8FC7; <a href="https://github.com/nmathewson/Libevent" target="_blank" rel="external">libevent</a> &#x901A;&#x4FE1;&#x7684;, memcache &#x5904;&#x7406;&#x5404;&#x79CD; IO &#x64CD;&#x4F5C;&#x90FD;&#x57FA;&#x4E8E;&#x7684; libevent&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/23343ec.png" alt=""></p>
<h4 id="&#x5904;&#x7406;&#x6D41;&#x7A0B;">&#x5904;&#x7406;&#x6D41;&#x7A0B;</h4><p>&#x5F53;&#x4E3B;&#x7EBF;&#x7A0B;&#x63A5;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x8FDE;&#x63A5;(connection)&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5C06;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9; worker &#x7EBF;&#x7A0B;&#x3002;&#x8BF7;&#x6C42;&#x7684;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#x96C6;&#x4E2D;&#x5728; memcache.c &#x6587;&#x4EF6;&#x91CC;&#x7684; drive_machine &#x65B9;&#x6CD5;&#x5F53;&#x4E2D;&#x3002; drive_machine &#x5176;&#x5B9E;&#x662F;&#x4E00;&#x4E2A;&#x5927;&#x53F7;&#x7684;&#x72B6;&#x6001;&#x673A;&#xFF0C;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#x7ECF;&#x5386;&#x7684;&#x72B6;&#x6001;&#x5982;&#x4E00;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF1A; </p>
<pre><code><span class="comment">/**
 * Possible states of a connection.
 */</span>
<span class="class"><span class="keyword">enum</span> <span class="title">conn_states</span> </span>{  
    conn_listening, 
    conn_new_cmd, 
    conn_waiting, 
    conn_read, 
    conn_parse_cmd,
    conn_write,
    conn_nread,
    conn_swallow,
    conn_closing,
    conn_mwrite,
    conn_closed,
    conn_max_state
};
</code></pre><p>&#x5176;&#x4E2D;&#x89E3;&#x6790;&#x3001;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x662F;&#x5728; conn_parse_cmd &#x5F00;&#x59CB;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x4E3B;&#x8981;&#x7684;&#x903B;&#x8F91;&#x662F;&#x5728; process_command &#x51FD;&#x6570;&#x5F53;&#x4E2D;&#xFF0C;&#x91CC;&#x9762;&#x542B;&#x6709;&#x5BF9;&#x4E0D;&#x540C;&#x547D;&#x4EE4;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF0C;&#x51FD;&#x6570;&#x540D;&#x4E00;&#x822C;&#x53EB; process_xxx_command &#x3002; </p>
<h4 id="&#x5173;&#x8054;&#x6570;&#x7EC4;">&#x5173;&#x8054;&#x6570;&#x7EC4;</h4><p>memache &#x4F7F;&#x7528; <a href="http://en.wikipedia.org/wiki/Associative_array" target="_blank" rel="external">Associative Array</a> &#x6765;&#x5B9E;&#x73B0;&#x7684;&#x7F13;&#x5B58;&#x529F;&#x80FD;&#x3002;&#x4E3B;&#x8981;&#x7684;&#x903B;&#x8F91;&#x5728; assoc.h &#x548C; assoc.c &#x4EE3;&#x7801;&#x6587;&#x4EF6;&#x4E2D;&#x3002;worker &#x7EBF;&#x7A0B;&#x63A5;&#x5230;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x6839;&#x636E;&#x547D;&#x4EE4;&#x7C7B;&#x578B;&#xFF08; set , get etc&#xFF09;&#x5BF9;&#x5173;&#x8054;&#x6570;&#x7EC4;&#x505A;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x3002; </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/16/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/18/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>587</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>32</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>23</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>9</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
