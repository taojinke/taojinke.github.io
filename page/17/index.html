
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/17/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/271dd50/" title="Memcached使用手册 -" itemprop="url">Memcached使用手册 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="memcached&#x7B80;&#x4ECB;">memcached&#x7B80;&#x4ECB;</h2><p>1 <strong>&#x3001;**</strong>memcached<strong> &#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x91CC;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x7EDF;&#xFFFD;&#xFFFD;&#xFFFD;&#x7684;&#x5DE8;&#x5927;&#x7684; </strong>hash** &#x8868;&#xFF0C;&#x5B83;&#x80FD;&#x591F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x5404;&#x79CD;&#x683C;&#x5F0F;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5305;&#x62EC;&#x56FE;&#x50CF;&#x3001;&#x89C6;&#x9891;&#x3001;&#x6587;&#x4EF6;&#x4EE5;&#x53CA;&#x6570;&#x636E;&#x5E93;&#x68C0;&#x7D22;&#x7684;&#x7ED3;&#x679C;&#x7B49;&#x3002;</p>
<p>2 &#x3001;&#x5B83;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x548C;&#x5BF9;&#x8C61;&#x6765;&#x51CF;&#x5C11;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x52A8;&#x6001;&#x3001;&#x6570;&#x636E;&#x5E93;&#x9A71;&#x52A8;&#x7F51;&#x7AD9;&#x7684;&#x901F;&#x5EA6;&#x3002; <strong>3**</strong>&#x3001;<strong><strong>Memcached</strong></strong>&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;<strong><strong>/</strong></strong>&#x503C;&#x5BF9;&#x7684;<strong><strong>hashmap</strong></strong>&#x3002;<strong><strong>4</strong></strong>&#x3001;&#x5176;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF08;<strong><strong>daemon</strong></strong>&#xFF09;&#x662F;&#x7528;<strong><strong>C</strong></strong>&#x5199;&#x7684;&#xFF0C;<strong><strong>5</strong></strong>&#x3001;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x7528;&#x4EFB;&#x4F55;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;<strong><strong>memcached</strong></strong>&#x534F;&#x8BAE;&#x4E0E;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x3002;**</p>
<h2 id="memcached&#x5B89;&#x88C5;&#x8BF4;&#x660E;">memcached&#x5B89;&#x88C5;&#x8BF4;&#x660E;</h2><p>1 <strong>&#x3001;windows&#x5B89;&#x88C5;&#xFF1A;&#x53C2;&#x7167;</strong> <a href="http://www.cnblogs.com/wucg/archive/2011/03/01/1968185.html" target="_blank" rel="external">http://www.cnblogs.com/wucg/archive/2011/03/01/1968185.html</a></p>
<p>2 &#x3001;liunx&#x5B89;&#x88C5;&#xFF1A;&#x53C2;&#x7167;<a href="http://chenzhou123520.iteye.com/blog/1933489" target="_blank" rel="external">http://chenzhou123520.iteye.com/blog/1933489</a></p>
<h2 id="memcached&#x4F7F;&#x7528;&#x65B9;&#x6CD5;">memcached&#x4F7F;&#x7528;&#x65B9;&#x6CD5;</h2><p>1&#x3001;&#xA0; &#x5B89;&#x88C5;&#x5B8C;memcached&#x540E;&#xFF0C;&#x5982;&#x4F55;&#x8FDE;&#x63A5;memached&#x5462;&#xFF1F;</p>
<p>&#x4F7F;&#x7528;telnet&#x547D;&#x4EE4;&#x8FDE;&#x63A5;memcached&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5728;windows&#x4E0B;&#x6709;&#x53EF;&#x80FD;&#x63D0;&#x793A;telnet&#x547D;&#x4EE4;&#x65E0;&#x6548;&#xFF0C;&#x662F;&#x7531;&#x4E8E;telnet&#x5BA2;&#x6237;&#x7AEF;&#x6CA1;&#x6709;&#x5B89;&#x88C5;&#xFF0C;&#x5B89;&#x88C5;&#x65B9;&#x6CD5;&#x53C2;&#x89C1;&#xFF08; <a href="http://jingyan.baidu.com/article/925f8cb839ca6bc0dce05666.html" target="_blank" rel="external">http://jingyan.baidu.com/article/925f8cb839ca6bc0dce05666.html</a> &#xFF09;&#x3002; </p>
<p>telnet&#x8FDE;&#x63A5;memcached&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/271bb22.jpg" alt=""></p>
<p>&#x5F00;&#x59CB;&#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x663E;&#x793A;&#xFF0C;&#x56DE;&#x8F66;&#x540E;&#x8F93;&#x5165;&#x547D;&#x4EE4; stats &#x67E5;&#x770B;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#xFF0C;&#x8BF4;&#x660E;&#x670D;&#x52A1;&#x5668;&#x8FD0;&#x4F5C;&#x6B63;&#x5E38;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c004.jpg" alt=""></p>
<p>&#x770B;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x4FE1;&#x606F;&#x8868;&#x793A;memcached&#x5B89;&#x88C5;&#x8FD0;&#x884C;&#x6B63;&#x5E38;&#xFF0C;&#x4F7F;&#x7528;telnet&#x8FDE;&#x63A5;memcached&#x6210;&#x529F;&#x3002;</p>
<h2 id="&#x5E38;&#x7528;memcached&#x547D;&#x4EE4;&#x8BE6;&#x89E3;">&#x5E38;&#x7528;memcached&#x547D;&#x4EE4;&#x8BE6;&#x89E3;</h2><p>Memcached&#x4F5C;&#x4E3A;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5BF9;&#x5176;&#x64CD;&#x4F5C;&#x7684;&#x547D;&#x4EE4;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x4E09;&#x7C7B;&#xFF1A;</p>
<p>1&#x3001;&#xA0; &#x670D;&#x52A1;&#x5668;&#x72B6;&#x6001;&#x547D;&#x4EE4;&#xFF1A;&#x53EF;&#x4EE5;&#x67E5;&#x770B;memcahced&#x670D;&#x52A1;&#x7684;&#x5F53;&#x524D;&#x72B6;&#x6001;</p>
<p>2&#x3001;&#xA0; &#x6570;&#x636E;&#x5B58;&#x50A8;&#x547D;&#x4EE4;&#xFF1A;&#x5982;&#x4F55;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x5230;memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;</p>
<p>3&#x3001;&#xA0; &#x6570;&#x636E;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;&#xFF1A;&#x83B7;&#x53D6;memacahed&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x7684;&#x6570;&#x636E;</p>
<p>4&#x3001;&#xA0; &#x6570;&#x636E;&#x5220;&#x9664;&#x547D;&#x4EE4;&#xFF1A;&#x5220;&#x9664;memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x7684;&#x6570;&#x636E;</p>
<p>&#x4E00;&#x3001;&#x670D;&#x52A1;&#x5668;&#x72B6;&#x6001;&#x547D;&#x4EE4;</p>
<p>1&#x3001;stats&#xFF1A; memcached &#x5B9E;&#x4F8B;&#x7684;&#x5F53;&#x524D;&#x7EDF;&#x8BA1;&#x6570;&#x636E;&#x3002; </p>
<p>STAT pid 22459&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8FDB;&#x7A0B;ID</p>
<p>STAT uptime 1027046&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x8FD0;&#x884C;&#x79D2;&#x6570;&#xA0;</p>
<p>STAT time 1273043062&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x5F53;&#x524D;unix&#x65F6;&#x95F4;&#x6233;&#xA0;</p>
<p>STAT version 1.4.4&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x7248;&#x672C;&#xA0;</p>
<p>STAT pointer_size 64&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5B57;&#x5927;&#x5C0F;(&#x8FD9;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x662F;64&#x4F4D;&#x7684;)&#xA0;</p>
<p>STAT rusage_user 0.040000&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8FDB;&#x7A0B;&#x7D2F;&#x8BA1;&#x7528;&#x6237;&#x65F6;&#x95F4;&#xA0;</p>
<p>STAT rusage_system 0.260000&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8FDB;&#x7A0B;&#x7D2F;&#x8BA1;&#x7CFB;&#x7EDF;&#x65F6;&#x95F4;&#xA0;</p>
<p>STAT curr_connections 10&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5F53;&#x524D;&#x6253;&#x5F00;&#x8FDE;&#x63A5;&#x6570;&#xA0;</p>
<p>STAT total_connections 82&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x66FE;&#x6253;&#x5F00;&#x7684;&#x8FDE;&#x63A5;&#x603B;&#x6570;&#xA0;</p>
<p>STAT connection_structures 13&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x670D;&#x52A1;&#x5668;&#x5206;&#x914D;&#x7684;&#x8FDE;&#x63A5;&#x7ED3;&#x6784;&#x6570;&#xA0;</p>
<p>STAT cmd_get 54&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x6267;&#x884C;get&#x547D;&#x4EE4;&#x603B;&#x6570;&#xA0;</p>
<p>STAT cmd_set 34&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x6267;&#x884C;set&#x547D;&#x4EE4;&#x603B;&#x6570;&#xA0;</p>
<p>STAT cmd_flush 3&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x6307;&#x5411;flush_all&#x547D;&#x4EE4;&#x603B;&#x6570;&#xA0;</p>
<p>STAT get_hits 9&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT get_misses 45&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT delete_misses 5&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; delete&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT delete_hits 1&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; delete&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT incr_misses 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; incr&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT incr_hits 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; incr&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT decr_misses 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; decr&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT decr_hits 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; decr&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT cas_misses 0&#xA0;&#xA0;&#xA0; cas&#x672A;&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT cas_hits 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cas&#x547D;&#x4E2D;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT cas_badval 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x4F7F;&#x7528;&#x64E6;&#x62ED;&#x6B21;&#x6570;&#xA0;</p>
<p>STAT auth_cmds 0&#xA0;</p>
<p>STAT auth_errors 0&#xA0;</p>
<p>STAT bytes_read 15785&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x8BFB;&#x53D6;&#x5B57;&#x8282;&#x603B;&#x6570;&#xA0;</p>
<p>STAT bytes_written 15222&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5199;&#x5165;&#x5B57;&#x8282;&#x603B;&#x6570;&#xA0;</p>
<p>STAT limit_maxbytes 1048576&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x6570;&#xFF08;&#x5B57;&#x8282;&#xFF09;&#xA0;</p>
<p>STAT accepting_conns 1&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x76EE;&#x524D;&#x63A5;&#x53D7;&#x7684;&#x94FE;&#x63A5;&#x6570;&#xA0;</p>
<p>STAT listen_disabled_num 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;</p>
<p>STAT threads 4&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x7EBF;&#x7A0B;&#x6570;&#xA0;</p>
<p>STAT conn_yields 0&#xA0;</p>
<p>STAT bytes 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x5B58;&#x50A8;item&#x5B57;&#x8282;&#x6570;&#xA0;</p>
<p>STAT curr_items 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; item&#x4E2A;&#x6570;&#xA0;</p>
<p>STAT total_items 34&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; item&#x603B;&#x6570;&#xA0;</p>
<p>STAT evictions 0&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#x4E3A;&#x83B7;&#x53D6;&#x7A7A;&#x95F4;&#x5220;&#x9664;item&#x7684;&#x603B;&#x6570;</p>
<p>&#x4E8C;&#x3001;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x547D;&#x4EE4;</p>
<p>1&#x3001;&#xA0; set &#x547D;&#x4EE4;</p>
<p>set&#x7684;&#x547D;&#x4EE4;&#x5728;memcached&#x4E2D;&#x7684;&#x4F7F;&#x7528;&#x9891;&#x7387;&#x6781;&#x9AD8;&#x3002;set&#x547D;&#x4EE4;&#x4E0D;&#x4F46;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x6DFB;&#x52A0;&#xFF0C;&#x5982;&#x679C;set&#x7684;key&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x8BE5;&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x66F4;&#x65B0;&#x8BE5;key&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x539F;&#x6765;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#xFFFD;&#xFFFD;&#xFFFD;&#x73B0;&#x66F4;&#x65B0;&#x7684;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x5B9E;&#x4F8B;&#xFF1A;set username&#xA0; 0&#xA0; 0&#xA0; 8&#x3002;</p>
<p>&#x6CE8;&#x610F;&#x4E00;&#x70B9;&#x5C31;&#x662F;&#xFF1A;&#x5982;&#x679C;&#x8BBE;&#x5B9A;&#x5B58;&#x50A8;&#x5B57;&#x8282;&#x6570;&#x4E3A;8&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x8F93;&#x5165;&#x7684;&#x5B58;&#x5728;&#x5185;&#x5BB9;&#x65F6;&#xFF0C;&#x5185;&#x5BB9;&#x5927;&#x5C0F;&#x5FC5;&#x987B;&#x662F;8&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5426;&#x5219;&#x5B58;&#x50A8;&#x4E0D;&#x6210;&#x529F;&#x3002;</p>
<p>2&#x3001;&#xA0; &#xA0;add &#x547D;&#x4EE4;</p>
<p>add&#x547D;&#x4EE4;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E0E;set&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#xFF0C;&#x533A;&#x522B;&#x662F;&#x53EA;&#x6709;&#x6570;&#x636E;&#x4E0D;&#x5B58;&#x5728;&#x65F6;&#x8FDB;&#x884C;&#x6DFB;&#x52A0;&#x7684;add&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x4E00;&#x4E2A;key&#x4E3A;username&#x7684;&#x6570;&#x636E;&#xFF0C;add&#x4E0D;&#x6210;&#x529F;&#x3002;</p>
<p>3&#x3001;&#xA0; replace &#x547D;&#x4EE4;</p>
<p>replace&#x547D;&#x4EE4;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x4E0E;set&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#xFF0C;&#x533A;&#x522B;&#x662F;&#x53EA;&#x6709;&#x6570;&#x636E;&#x5B58;&#x5728;&#x65F6;&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x66F4;&#x65B0;&#xFF0C;&#x5982;&#x679C;replace&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;key&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5219;replace&#x4E0D;&#x6210;&#x529F;&#x3002;&#x4E0E;add&#x547D;&#x4EE4;&#x76F8;&#x53CD;&#x3002;</p>
<p>&#x4E09;&#x3001;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;</p>
<p>1&#x3001;&#xA0; get&#x547D;&#x4EE4;</p>
<p>get&#x7A7A;&#x683C;key &#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x6307;&#x5B9A;key&#x7684;&#x6570;&#x636E;&#x3002;&#x591A;&#x4E2A;key&#x53EF;&#x4EE5;&#x7528;&#x7A7A;&#x683C;&#x9694;&#x5F00;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c004.jpg" alt=""></p>
<p>2&#x3001;&#xA0; gets&#x547D;&#x4EE4;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c275.jpg" alt=""></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;gets&#x547D;&#x4EE4;&#x6BD4;&#x666E;&#x901A;&#x7684;get&#x547D;&#x4EE4;&#x591A;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x6570;&#x5B57;&#xFF08;&#x4E0A;&#x56FE;&#x4E2D;&#x4E3A;13&#xFF09;&#x3002;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x53EF;&#x4EE5;&#x68C0;&#x67E5;&#x6570;&#x636E;&#x662F;&#x5426;&#x53D1;&#x751F;&#x6539;&#x53D8;&#x3002;&#x5F53;key&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x6539;&#x53D8;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x591A;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x5B57;&#x4E5F;&#x4F1A;&#x6539;&#x53D8;&#x3002;&#x8FD9;&#x4E2A;&#x6570;&#x5B57;&#x7C7B;&#x4F3C;&#x4E8E;svn&#x4E2D;&#x7684;&#x7248;&#x672C;&#x53F7;&#x3002;</p>
<p>&#x56DB;&#x3001;&#x6570;&#x636E;&#x5220;&#x9664;&#x547D;&#x4EE4;</p>
<p>1&#x3001;&#xA0; delete&#x547D;&#x4EE4;</p>
<p><img src="http://taojinke.github.io/img/20150703/271c275.jpg" alt=""></p>
<p>&#x5220;&#x9664;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x952E;&#x503C;&#x548C;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x8BB0;&#x5F55;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E0D;&#x540C;&#x7684;&#x7ED3;&#x679C;&#x3002;</p>
<h2 id="java&#x64CD;&#x4F5C;memcached&#x5DE5;&#x5177;&#x4ECB;&#x7ECD;">java&#x64CD;&#x4F5C;memcached&#x5DE5;&#x5177;&#x4ECB;&#x7ECD;</h2><p>java&#x5BA2;&#x6237;&#x7AEF;&#x64CD;&#x4F5C;memcached&#x670D;&#x52A1;&#x5668;&#x7684;&#x5E38;&#x7528;&#x5DE5;&#x5177;&#x6709;&#xFF1A;memcached client for java &#x548C;spymemcached&#x3002;&#x6BD4;&#x8F83;&#x5E38;&#x7528;&#x7684;&#x5C31;&#x662F;memcached client for java&#x3002;&#x76EE;&#x524D;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x662F;memcached client for java&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/26f6ec1/" title="Redis、Memcached、Guava、Ehcache中的算法 -" itemprop="url">Redis、Memcached、Guava、Ehcache中的算法 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x7F13;&#x5B58;&#x90A3;&#x4E9B;&#x4E8B;&#xFF0C;&#x4E00;&#x662F;&#x5185;&#x5B58;&#x7206;&#x4E86;&#x8981;&#x7528;LRU(&#x6700;&#x8FD1;&#x6700;&#x5C11;&#x4F7F;&#x7528;)&#x3001;LFU(&#x6700;&#x5C11;&#x8BBF;&#x95EE;&#x6B21;&#x6570;)&#x3001;FIFO&#x7684;&#x7B97;&#x6CD5;&#x6E05;&#x7406;&#x4E00;&#x4E9B;&#xFF1B;&#x4E8C;&#x662F;&#x8BBE;&#x7F6E;&#x4E86;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x7684;&#x952E;&#x8FC7;&#x671F;&#x4FBF;&#x8981;&#x5220;&#x9664;&#xFF0C;&#x7528;&#x4E3B;&#x52A8;&#x6216;&#x60F0;&#x6027;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<h3 id="1-_LRU">1. LRU</h3><h4 id="&#x7B80;&#x5355;&#x7C97;&#x66B4;&#x7684;Redis">&#x7B80;&#x5355;&#x7C97;&#x66B4;&#x7684;Redis</h4><p>&#x4ECA;&#x5929;&#x770B; <a href="https://raw.githubusercontent.com/antirez/redis/3.0/00-RELEASENOTES" target="_blank" rel="external">Redis3.0&#x7684;&#x53D1;&#x884C;&#x901A;&#x544A;</a> &#x91CC;&#x8BF4;&#xFF0C;LRU&#x7B97;&#x6CD5;&#x5927;&#x5E45;&#x63D0;&#x5347;&#x4E86;&#xFF0C;&#x5C31;&#x7FFB;&#x5F00;&#x6E90;&#x7801;&#x6765;&#x516B;&#x5366;&#x4E00;&#x4E0B;&#xFF0C;&#x7ED3;&#x679C;&#x54ED;&#x7B11;&#x4E0D;&#x5F97;&#xFF0C;&#x8FD9;&#x65E7;&#x7248;&#x7684;&quot;&#x8FD1;&#x4F3C;LRU&quot;&#x7B97;&#x6CD5;&#xFF0C;&#x5B9E;&#x5728;&#x592A;&#x7B80;&#x5355;&#xFF0C;&#x592A;&#x5077;&#x61D2;&#xFF0C;&#x592A;Redis&#x4E86;&#x3002; </p>
<p>&#x5728; <a href="https://github.com/antirez/redis" target="_blank" rel="external">Github&#x7684;Redis&#x9879;&#x76EE;</a> &#x91CC;&#x641C;&#x7D22;lru&#xFF0C;&#x627E;&#x5230;&#x4EE3;&#x7801;&#x5728;redis.c&#x7684;freeMemoryIfNeeded()&#x51FD;&#x6570;&#x91CC;&#x3002; </p>
<p>&#x5148;&#x770B; <a href="https://github.com/huangz1990/annotated_redis_source/blob/unstable/src/redis.c#L2717" target="_blank" rel="external">2.6&#x7248;&#x7684;&#x4EE3;&#x7801;</a> &#xFF1A; &#x7ADF;&#x7136;&#x5C31;&#x662F;&#x968F;&#x673A;&#x627E;&#x4E09;&#x6761;&#x8BB0;&#x5F55;&#x51FA;&#x6765;&#xFF0C;&#x6BD4;&#x8F83;&#x54EA;&#x6761;&#x7A7A;&#x95F2;&#x65F6;&#x95F4;&#x6700;&#x957F;&#x5C31;&#x5220;&#x54EA;&#x6761;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x968F;&#x673A;&#x4E09;&#x6761;&#x51FA;&#x6765;&#xFF0C;&#x4E00;&#x76F4;&#x5220;&#x5230;&#x5185;&#x5B58;&#x8DB3;&#x591F;&#x653E;&#x4E0B;&#x65B0;&#x8BB0;&#x5F55;&#x4E3A;&#x6B62;…….&#x53EF;&#x601C;&#x6211;&#x770B; <a href="https://github.com/antirez/redis/blob/unstable/redis.conf#L481" target="_blank" rel="external">&#x914D;&#x7F6E;&#x6587;&#x6863;</a> &#x540E;&#x7684;&#x60F3;&#x8C61;&#xFF0C;&#x4E00;&#x76F4;&#x4EE5;&#x4E3A;&#x5B83;&#x4F1A;&#x5E2E;&#x6211;&#xFFFD;&#xFFFD;&#xFFFD;&#x6574;&#x4E2A;Redis&#x91CC;&#x627E;&#x7A7A;&#x95F2;&#x65F6;&#x95F4;&#x6700;&#x957F;&#x7684;&#xFF0C;&#x54EA;&#x60F3;&#x5230;&#x6211;&#x6709;&#x4E00;&#x767E;&#x4E07;&#x6761;&#x8BB0;&#x5F55;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x968F;&#x4FBF;&#x627E;&#x4E09;&#x6761;&#x5C31;&#x5F00;&#x59CB;&#x5220;&#x4E86;&#x3002; </p>
<p>&#x597D;&#xFF0C;&#x6536;&#x62FE;&#x5FC3;&#x60C5;&#x518D;&#x770B; <a href="https://github.com/huangz1990/redis-3.0-annotated/blob/unstable/src/redis.c#L3447" target="_blank" rel="external">3.0&#x7248;&#x7684;&#x6539;&#x8FDB;</a> &#xFF1A;&#x73B0;&#x5728;&#x6BCF;&#x6B21;&#x968F;&#x673A;&#x4E94;&#x6761;&#x8BB0;&#x5F55;&#x51FA;&#x6765;&#xFF0C;&#x63D2;&#x5165;&#x5230;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x4E3A;&#x5341;&#x516D;&#x7684;&#x6309;&#x7A7A;&#x95F2;&#x65F6;&#x95F4;&#x6392;&#x5E8F;&#x7684;&#x961F;&#x5217;&#x91CC;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x6392;&#x5934;&#x7684;&#x90A3;&#x6761;&#x5220;&#x6389;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x627E;&#x4E94;&#x6761;&#x51FA;&#x6765;&#xFF0C;&#x7EE7;&#x7EED;&#x5C1D;&#x8BD5;&#x63D2;&#x5165;&#x961F;&#x5217;………&#x55EF;&#xFF0C;&#x597D;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5427;&#xFF0C;&#x8D77;&#x7801;&#x6BCF;&#x6B21;&#x968F;&#x673A;&#x591A;&#x4E86;&#x4E24;&#x6761;&#xFF0C;&#x8D77;&#x7801;&#x4E0D;&#x53EA;&#x5728;&#x4E00;&#x6B21;&#x968F;&#x673A;&#x7684;&#x4E94;&#x6761;&#x91CC;&#x9762;&#x627E;&#x6700;&#x4E45;&#x90A3;&#x6761;&#xFF0C;&#x4F1A;&#x8FDE;&#x540C;&#x4E4B;&#x524D;&#x7684;&#x4E00;&#x8D77;&#x505A;&#x6BD4;&#x8F83;…… </p>
<h4 id="&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Memcached">&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Memcached</h4><p>&#x76F8;&#x6BD4;&#x4E4B;&#x4E0B;&#xFF0C;Memcached&#x5B9E;&#x73B0;&#x7684;&#x662F;&#x518D;&#x6807;&#x51C6;&#x4E0D;&#x8FC7;&#x7684;LRU&#x7B97;&#x6CD5;&#xFF0C;&#x4E13;&#x95E8;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;&#x6559;&#x79D1;&#x4E66;&#x5F0F;&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x6765;&#x5B58;&#x50A8;slab&#x5185;&#x7684;LRU&#x5173;&#x7CFB;&#xFF0C;&#x4EE3;&#x7801;&#x5728; <a href="https://github.com/memcached/memcached/blob/c5530027c8ea28674358327ab8212ebaf014c848/items.c" target="_blank" rel="external">item.c</a> &#x91CC;&#xFF0C;&#x8BE6;&#x89C1; <a href="http://blog.csdn.net/luotuo44/article/details/42869325" target="_blank" rel="external">memcached&#x6E90;&#x7801;&#x5206;&#x6790;——-LRU&#x961F;&#x5217;&#x4E0E;item&#x7ED3;&#x6784;&#x4F53;</a> &#xFF0C;&#x5143;&#x7D20;&#x63D2;&#x5165;&#x65F6;&#x628A;&#x81EA;&#x5DF1;&#x653E;&#x5230;&#x5217;&#x5934;&#xFF0C;&#x5220;&#x9664;&#x65F6;&#x628A;&#x81EA;&#x5DF1;&#x7684;&#x524D;&#x540E;&#x4E24;&#x4E2A;&#x5143;&#x7D20;&#x5BF9;&#x63A5;&#x8D77;&#x6765;&#xFF0C;&#x66F4;&#x65B0;&#x65F6;&#x5148;&#x505A;&#x5220;&#x9664;&#x518D;&#x505A;&#x63D2;&#x5165;&#x3002; </p>
<p>&#x5206;&#x914D;&#x5185;&#x5B58;&#x8D85;&#x9650;&#x65F6;&#xFF0C;&#x5F88;&#x81EA;&#x7136;&#x5C31;&#x4F1A;&#x4ECE;LRU&#x7684;&#x961F;&#x5C3E;&#x5F00;&#x59CB;&#x6E05;&#x7406;&#x3002;</p>
<h4 id="&#x540C;&#x6837;&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Guava_Cache">&#x540C;&#x6837;&#x4E2D;&#x89C4;&#x4E2D;&#x77E9;&#x7684;Guava Cache</h4><p>Guava Cache&#x540C;&#x6837;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x7684;Queue&#xFF0C;&#x89C1; <a href="https://github.com/google/guava/blob/56456cb58c0cb71d7c0f05047e13718ad202b748/guava/src/com/google/common/cache/LocalCache.java#L3743" target="_blank" rel="external">LocalCache&#x4E2D;&#x7684;AccessQueue</a> &#x7C7B;&#xFF0C;&#x4E5F;&#x4F1A;&#x5728;&#x8D85;&#x9650;&#x65F6;&#x4ECE;Queue&#x7684;&#x961F;&#x5C3E;&#x6E05;&#x7406;&#xFF0C;&#x89C1; <a href="https://github.com/google/guava/blob/56456cb58c0cb71d7c0f05047e13718ad202b748/guava/src/com/google/common/cache/LocalCache.java#L2663" target="_blank" rel="external">evictEntries()&#x51FD;&#x6570;</a> &#x3002; </p>
<h4 id="&#x548C;Redis&#x65E7;&#x7248;&#x4E00;&#x6837;&#x7684;Ehcache/Hazelcast">&#x548C;Redis&#x65E7;&#x7248;&#x4E00;&#x6837;&#x7684;Ehcache/Hazelcast</h4><p>&#x770B; <a href="http://ehcache.org/documentation/2.8/apis/cache-eviction-algorithms#least-recently-used-lru" target="_blank" rel="external">&#x6587;&#x6863;</a> &#xFF0C;&#x5C45;&#x7136;&#x548C;Redis2.6&#x4E00;&#x6837;&#xFF0C;&#x76F4;&#x63A5;&#x968F;&#x673A;8&#x6761;&#x8BB0;&#x5F55;&#xFF0C;&#x627E;&#x51FA;&#x6700;&#x65E7;&#x90A3;&#x6761;&#xFF0C;&#x5237;&#x5230;&#x78C1;&#x76D8;&#x91CC;&#xFF0C;&#x518D;&#x770B;&#x4EE3;&#x7801;&#xFF0C; <a href="https://github.com/ehcache/ehcache3/blob/16a12914afcfc89f2cb8a3c069fd295074f81ee5/api/src/main/java/org/ehcache/config/Eviction.java#L66" target="_blank" rel="external">Eviction&#x7C7B;</a> &#x548C; <a href="https://github.com/ehcache/ehcache3/blob/5a3884871eadaf6a3e23908e1497ba0b591cbfa9/impl/src/main/java/org/ehcache/internal/store/heap/OnHeapStore.java#L892" target="_blank" rel="external">OnHeapStore&#x7684;evict()&#x51FD;&#x6570;</a> &#x3002; </p>
<p>&#x518D;&#x770B;Hazelcast&#xFF0C;&#x51E0;&#x4E4E;&#x4E00;&#x6837;&#xFF0C;&#x968F;&#x673A;&#x53D6;25&#x6761;&#x3002; &#x8FD9;&#x79CD;&#x7B97;&#x6CD5;&#xFF0C;&#x5207;&#x6362;&#x5230;LFU&#x4E5F;&#x975E;&#x5E38;&#x7B80;&#x5355;&#x3002;</p>
<h4 id="&#x5C0F;&#x7ED3;">&#x5C0F;&#x7ED3;</h4><p>&#x4E0D;&#x8FC7;&#x540E;&#x6765;&#x518D;&#x60F3;&#x60F3;&#xFF0C;&#x4E5F;&#x8BB8;Redis&#x672C;&#x6765;&#x5C31;&#x4E0D;&#x662F;&#x4E3B;&#x6253;&#x505A;Cache&#x7684;&#xFF0C;&#x8FD9;&#x79CD;&#x5185;&#x5B58;&#x7206;&#x4E86;&#x9700;&#x8981;&#x901A;&#x8FC7;LRU&#x5220;&#x6389;&#x4E00;&#x4E9B;&#x5143;&#x7D20;&#x4E0D;&#x662F;&#x5B83;&#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#xFF0C;&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x90FD;&#x662F;noeviction&#x2014;&#x2014;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x76F4;&#x63A5;&#x62A5;&#x9519;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x61D2;&#x5F97;&#x5EFA;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#xFF0C;&#x800C;&#x4E14;&#x6BCF;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x90FD;&#x8981;&#x66F4;&#x65B0;&#x5B83;&#x4E86;&#xFF0C;&#x770B;Google Group&#x91CC;&#x957F;&#x957F;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x65B0;&#x7248;&#x7B97;&#x6CD5;&#x4E5F;&#x662F;&#x793E;&#x533A;&#x667A;&#x6167;&#x7684;&#x7ED3;&#x6676;&#x3002;&#x4F55;&#x51B5;&#xFF0C;Ehcache&#x548C;Hazelcast&#x4E5F;&#x662F;&#x548C;&#x5B83;&#x7684;&#x65E7;&#x7248;&#x4E00;&#x6837;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;Redis&#x7684;&#x65B0;&#x7248;&#x8FD8;&#x6BD4;&#x8FD9;&#x4E24;&#x8005;&#x5F3A;&#x4E86;&#x3002;</p>
<p>&#x540E;&#x6765;&#xFF0C;&#x6839;&#x636E;@&#x5218;&#x5C11;&#x58EE;&#x540C;&#x5B66;&#x7684;&#x63D0;&#x793A;&#xFF0C;JBoss&#x7684;InfiniSpan&#x91CC;&#x8FD8;&#x5B9E;&#x73B0;&#x4E86;&#x6BD4;LRU&#x66F4;&#x9AD8;&#x7EA7;&#x7684; <a href="http://www.thinkingyu.com/articles/LIRS/" target="_blank" rel="external">LIRS&#x7B97;&#x6CD5;</a> &#xFF0C;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x4E00;&#x4E9B;&#x51B7;&#x6570;&#x636E;&#x56E0;&#x4E3A;&#x67D0;&#x4E2A;&#x539F;&#x56E0;&#x88AB;&#x5927;&#x91CF;&#x8BBF;&#x95EE;&#x540E;&#xFF0C;&#x628A;&#x70ED;&#x6570;&#x636E;&#x6324;&#x5360;&#x6389;&#x3002; </p>
<h3 id="2-_&#x8FC7;&#x671F;&#x952E;&#x5220;&#x9664;">2. &#x8FC7;&#x671F;&#x952E;&#x5220;&#x9664;</h3><p>&#x5982;&#x679C;&#x80FD;&#x4E3A;&#x6BCF;&#x4E00;&#x4E2A;&#x8BBE;&#x7F6E;&#x4E86;&#x8FC7;&#x671F;&#x7684;&#x5143;&#x7D20;&#x542F;&#x52A8;&#x4E00;&#x4E2A;Timer&#xFF0C;&#x4E00;&#x5230;&#x65F6;&#x95F4;&#x5C31;&#x89E6;&#x53D1;&#x628A;&#x5B83;&#x5220;&#x6389;&#xFF0C;&#x90A3;&#x65E0;&#x7591;&#x662F;&#x80FD;&#x6700;&#x5FEB;&#x5220;&#x9664;&#x8FC7;&#x671F;&#x952E;&#x6700;&#x7701;&#x7A7A;&#x95F4;&#x7684;&#xFF0C;&#x5728;Java&#x91CC;&#x7528;&#x4E00;&#x6761; <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/DelayQueue.html" target="_blank" rel="external">DeplayQueue</a> &#x5B58;&#x7740;&#xFF0C;&#x5F00;&#x6761;&#x7EBF;&#x7A0B;&#x4E0D;&#x65AD;&#x7684;&#x8BFB;&#x53D6;&#x5C31;&#x80FD;&#x505A;&#x5230;&#x3002;&#x4F46;&#x56E0;&#x4E3A;&#x8BE5;&#x7EBF;&#x7A0B;&#x6D88;&#x8017;CPU&#x8F83;&#x591A;&#xFF0C;&#x5728;&#x5185;&#x5B58;&#x4E0D;&#x7D27;&#x5F20;&#x65F6;&#x6709;&#x70B9;&#x6D6A;&#x8D39;&#xFF0C;&#x4F3C;&#x4E4E;&#x5927;&#x5BB6;&#x90FD;&#x4E0D;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002; </p>
<p>&#x6240;&#x4EE5;&#x6709;&#x4E86;&#x60F0;&#x6027;&#x68C0;&#x67E5;&#xFF0C;&#x5C31;&#x662F;&#x6BCF;&#x6B21;&#x5143;&#x7D20;&#x88AB;&#x8BBF;&#x95EE;&#x65F6;&#xFF0C;&#x624D;&#x53BB;&#x68C0;&#x67E5;&#x5B83;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8D85;&#x65F6;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x5404;&#x5BB6;&#x90FD;&#x4E00;&#x6837;&#x3002;&#x4F46;&#x5982;&#x679C;&#x90A3;&#x4E2A;&#x5143;&#x7D20;&#x540E;&#x6765;&#x90FD;&#x6CA1;&#x518D;&#x88AB;&#x8BBF;&#x95EE;&#x5462;&#xFF0C;&#x4F1A;&#x6C38;&#x8FDC;&#x5360;&#x7740;&#x4F4D;&#x5B50;&#x5417;&#xFF1F;&#x6240;&#x4EE5;&#x5404;&#x5BB6;&#x90FD;&#x518D;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x5B9A;&#x671F;&#x4E3B;&#x52A8;&#x5220;&#x9664;&#x7684;&#x65B9;&#x5F0F;&#x3002;</p>
<h4 id="Redis">Redis</h4><p>&#x4EE3;&#x7801;&#x5728; <a href="https://github.com/huangz1990/redis-3.0-annotated/blob/unstable/src/redis.c#L857" target="_blank" rel="external">redis.c&#x7684;activeExpireCycle()</a> &#x91CC;&#xFF0C;&#x770B;&#x8FC7;&#x6587;&#x6863;&#x7684;&#x4EBA;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x5B83;&#x4F1A;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x91CC;&#xFF0C;&#x6BCF;100&#x6BEB;&#x79D2;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x6BCF;&#x6B21;&#x968F;&#x673A;&#x62BD;20&#x6761;Key&#x68C0;&#x67E5;&#xFF0C;&#x5982;&#x679C;&#x6709;1/4&#x7684;&#x952E;&#x8FC7;&#x671F;&#x4E86;&#xFF0C;&#x8BC1;&#x660E;&#x6B64;&#x65F6;&#x8FC7;&#x671F;&#x7684;&#x952E;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x5C31;&#x4E0D;&#x7B49;100&#x6BEB;&#x79D2;&#xFF0C;&#x7ACB;&#x523B;&#x5F00;&#x59CB;&#x4E0B;&#x4E00;&#x8F6E;&#x7684;&#x68C0;&#x67E5;&#x3002;&#x4E0D;&#x8FC7;&#x4E3A;&#x514D;&#x628A;CPU&#x65F6;&#x95F4;&#x90FD;&#x5360;&#x4E86;&#xFF0C;&#x53C8;&#x9650;&#x5B9A;&#x6BCF;&#x8F6E;&#x7684;&#x603B;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x4E0D;&#x8D85;&#x8FC7;1&#x6BEB;&#x79D2;&#x3002; </p>
<h4 id="Memcached">Memcached</h4><p>Memcached&#x91CC;&#x6709;&#x4E2A;&#x6587;&#x4E0D;&#x5BF9;&#x9898;&#x7684; <a href="http://blog.csdn.net/luotuo44/article/details/42963793" target="_blank" rel="external">LRU&#x722C;&#x866B;&#x7EBF;&#x7A0B;</a> &#xFF0C;&#x5229;&#x7528;&#x4E86;&#x4E4B;&#x524D;&#x90A3;&#x6761;LRU&#x7684;&#x961F;&#x5217;&#xFF0C;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x591A;&#x4E45;&#x8DD1;&#x4E00;&#x6B21;(&#x9ED8;&#x8BA4;&#x4E5F;&#x662F;100&#x6BEB;&#x79D2;)&#xFF0C;&#x6CBF;&#x7740;&#x5217;&#x5C3E;&#x4E00;&#x76F4;&#x68C0;&#x67E5;&#x8FC7;&#x53BB;&#xFF0C;&#x6BCF;&#x6B21;&#x68C0;&#x67E5;LRU&#x961F;&#x5217;&#x4E2D;&#x7684;N&#x6761;&#x6570;&#x636E;&#x3002;&#x867D;&#x7136;&#x6BCF;&#x6761;Key&#x8BBE;&#x7F6E;&#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x53EF;&#x80FD;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x4F46;&#x600E;&#x4E48;&#x8BF4;&#x547D;&#x4E2D;&#x7387;&#x4E5F;&#x6BD4;Redis&#x7684;&#x968F;&#x673A;&#x9009;&#x62E9;N&#x6761;&#x6570;&#x636E;&#x597D;&#x4E00;&#x70B9;&#xFF0C;&#x4F46;&#x5B83;&#x6CA1;&#x6709;Redis&#x90A3;&#x79CD;&#x8FC7;&#x671F;&#x7684;&#x591A;&#x4E86;&#x7ACB;&#x9A6C;&#x5C55;&#x5F00;&#x4E0B;&#x4E00;&#x8F6E;&#x68C0;&#x67E5;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6240;&#x4EE5;&#x6BCF;&#x79D2;&#x6700;&#x591A;&#x53EA;&#x80FD;&#x68C0;&#x67E5;10N&#x6761;&#x6570;&#x636E;&#xFF0C;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x81EA;&#x5DF1;&#x6743;&#x8861;N&#x7684;&#x8BBE;&#x7F6E;&#x3002; </p>
<h4 id="Guava_Cache">Guava Cache</h4><p>&#x5728;Guava Cache&#x91CC;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;Cache&#x91CC;&#x6240;&#x6709;&#x5143;&#x7D20;&#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x6BD4;Memached&#x66F4;&#x65B9;&#x4FBF;&#xFF0C;&#x987A;&#x7740;&#x4E4B;&#x524D;&#x90A3;&#x6761;LRU&#x7684;Queue&#x68C0;&#x67E5;&#x8D85;&#x65F6;&#xFF0C;&#x4E0D;&#x9650;&#x5B9A;&#x4E2A;&#x6570;&#xFF0C;&#x76F4;&#x5230;&#x4E0D;&#x8D85;&#x65F6;&#x4E3A;&#x6B62;&#x3002;&#x800C;&#x4E14;&#x5B83;&#x8FD9;&#x4E2A;&#x68C0;&#x67E5;&#x7684;&#x8C03;&#x7528;&#x65F6;&#x673A;&#x5E76;&#x4E0D;&#x662F;100&#x6BEB;&#x79D2;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x6BCF;&#x6B21;&#x5404;&#x79CD;&#x5199;&#x5165;&#x6570;&#x636E;&#x65F6;&#x7684; <a href="https://github.com/google/guava/blob/56456cb58c0cb71d7c0f05047e13718ad202b748/guava/src/com/google/common/cache/LocalCache.java#L3439" target="_blank" rel="external">preWriteCleanup()</a> &#x65B9;&#x6CD5;&#x4E2D;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#x3002; </p>
<p>&#x5410;&#x69FD;&#x4E00;&#x53E5;&#xFF0C;Guava&#x7684;Localcache&#x7C7B;&#x91CC;&#x9762;&#x5DF2;&#x7ECF;4872&#x884C;&#x4E86;&#xFF0C;&#x4E00;&#x70B9;&#x90FD;&#x4E0D;&#x8F7B;&#x91CF;&#x4E86;&#x3002;</p>
<h4 id="Ehcache">Ehcache</h4><p>Ehcache&#x66F4;&#x4E71;&#xFF0C;&#x9996;&#x5148;&#x5B83;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x4E2D;&#x53EA;&#x6709;&#x60F0;&#x6027;&#x68C0;&#x67E5;&#xFF0C;&#x6CA1;&#x6709;&#x4E3B;&#x52A8;&#x68C0;&#x67E5;&#x8FC7;&#x671F;&#x7684;&#xFF0C;&#x53EA;&#x4F1A;&#x5728;&#x5185;&#x5B58;&#x8D85;&#x9650;&#x65F6;&#x4E0D;&#x65AD;&#x7528;&#x8FD1;&#x4F3C;LRU&#x7B97;&#x6CD5;(&#x89C1;&#x4E0A;)&#x628A;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#x5237;&#x5230;&#x78C1;&#x76D8;&#x4E2D;&#xFF0C;&#x5728;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x4E2D;&#x624D;&#x6709;&#x8D85;&#x65F6;&#x68C0;&#x67E5;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C; <a href="http://ehcache.org/documentation/2.8/faq#why-is-there-an-expiry-thread-for-the-diskstore-but-not-for-the-memorystore" target="_blank" rel="external">FAQ</a> &#x91CC;&#x4E13;&#x95E8;&#x89E3;&#x91CA;&#x4E86;&#x539F;&#x56E0;&#x3002; </p>
<p>&#x7136;&#x540E;&#x78C1;&#x76D8;&#x5B58;&#x50A8;&#x90A3;&#x6709;&#x4E00;&#x6761;8&#x5C0F;&#x65F6;&#x5DE6;&#x53F3;&#x8DD1;&#x4E00;&#x6B21;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x6B21;&#x904D;&#x5386;&#x6240;&#x6709;&#x5143;&#x7D20;…..&#x89C1; <a href="https://github.com/ehcache/ehcache3/blob/9c7d83ce4e2a59e15be7cb167ea886fdc47b496e/impl/src/main/java/org/ehcache/internal/store/disk/DiskStorageFactory.java#L860" target="_blank" rel="external">DiskStorageFactory&#x91CC;&#x7684;DiskExpiryTask</a> &#x3002; &#x4E00;&#x5708;&#x770B;&#x4E0B;&#x6765;&#xFF0C;Ehcache&#x7684;&#x5B9E;&#x73B0;&#x6700;&#x5F31;&#x3002; </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Ehcache/">Ehcache</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Redis/">Redis</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2732958/" title="MemCached缓存知识知多少？ -" itemprop="url">MemCached缓存知识知多少？ -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li>MemCached&#x662F;&#x795E;&#x9A6C;&#xFF1F;</li>
</ol>
<p>Memcached&#xA0; &#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x7528;&#x4E8E;&#x52A8;&#x6001;Web&#x5E94;&#x7528;&#x4EE5;&#x51CF;&#x8F7B;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#x3002;&#x5B83;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x548C;&#x5BF9;&#x8C61;&#x6765;&#x51CF;&#x5C11;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x52A8;&#x6001;&#x3001;&#x6570;&#x636E;&#x5E93;&#x9A71;&#x52A8;&#x7F51;&#x7AD9;&#x7684;&#x901F;&#x5EA6;&#x3002;Memcached&#x57FA;&#x4E8E;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;&#x952E;/&#x503C;&#x5BF9;&#x7684;hashmap&#x3002;&#x5176;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF08;daemon &#xFF09;&#x662F;&#x7528;C&#x5199;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x7528;&#x4EFB;&#x4F55;&#x8BED;&#x8A00;&#x6765;&#x7F16;&#x5199;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;memcached&#x534F;&#x8BAE;&#x4E0E;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x901A;&#x4FE1;&#x3002;</p>
<p>MemCached&#x6700;&#x65E9;&#x662F;&#x7531; Brad Fitzpatrick &#x5728;2003&#x5E74;&#x4E3A;LiveJournal&#x800C;&#x5F00;&#x53D1;&#x7684;&#x7F13;&#x5B58;&#x7A0B;&#x5E8F;&#x3002;&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7684;&#x7248;&#x672C;&#x4E3A;v1.4.22.</p>
<ol>
<li>MemCached&#x7684;&#x7279;&#x70B9;&#xFF1F;</li>
</ol>
<p>&#x534F;&#x8BAE;&#x7B80;&#x5355;&#xFF1A;memcached&#x7684;&#x670D;&#x52A1;&#x5668;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x4FE1;&#x5E76;&#x4E0D;&#x4F7F;&#x7528;&#x590D;&#x6742;&#x7684;MXL&#x7B49;&#x683C;&#x5F0F;&#xFF0C;&#x800C;&#x662F;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;&#x57FA;&#x4E8E;&#x6587;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x3002;</p>
<p>&#x57FA;&#x4E8E;libevent&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#xFF1A;libevent&#x662F;&#x4E2A;&#x7A0B;&#x5E8F;&#x5E93;&#xFF0C;&#x4ED6;&#x5C06;Linux &#x7684;epoll&#x3001;BSD&#x7C7B;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;kqueue&#x7B49;&#x65F6;&#x95F4;&#x5904;&#x7406;&#x529F;&#x80FD;&#x5C01;&#x88C5;&#x6210;&#x7EDF;&#x4E00;&#x7684;&#x63A5;&#x53E3;&#x3002;&#xA0; &#xA0; memcached&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;libevent&#x5E93;&#xFF0C;&#x56E0;&#x6B64;&#x80FD;&#x5728;Linux&#x3001;BSD&#x3001;Solaris&#x7B49;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#x53D1;&#x6325;&#x5176;&#x9AD8;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x5185;&#x7F6E;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF1A;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x91CD;&#x542F;memcached&#xFF0C;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x503C;&#x4E4B;&#x540E;memcached&#x56DE;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x9002;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;</p>
<p>&#x4E0D;&#x4E92;&#x901A;&#x4FE1;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#xFF1A;memcached&#x5C3D;&#x7BA1;&#x662F;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F46;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x529F;&#x80FD;&#x3002;&#x5404;&#x4E2A;memcached&#x4E0D;&#x4F1A;&#x4E92;&#x76F8;&#x901A;&#x4FE1;&#x4EE5;&#x5171;&#x4EAB;&#x4FE1;&#x606F;&#x3002;&#x4ED6;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<ol>
<li>MemCached&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#xFF1F;</li>
</ol>
<p>&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x4E2D;&#x3002;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64;&#x91CD;&#x542F;memcached&#x3001;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x503C;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x57FA;&#x4E8E;LRU(Least Recently Used)&#x7B97;&#x6CD5;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x4F7F;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;memcached&#x672C;&#x8EAB;&#x662F;&#x4E3A;&#x7F13;&#x5B58;&#x800C;&#x8BBE;&#x8BA1;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x8003;&#x8651;&#x6570;&#x636E;&#x7684;&#x6C38;&#x4E45;&#x6027;&#x95EE;&#x9898;&#x3002;</p>
<ol>
<li>MemCached&#x4E0E;Redis&#x7684;PK&#xFF1F;</li>
</ol>
<p>&#x6BCF;&#x79D2;&#x5904;&#x7406;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x4E0D;&#x662F;&#x74F6;&#x9888;&#xFF1A;Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;&#xFF0C;&#x800C;Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF0C;&#x6240;&#x4EE5;&#x4E8C;&#x8005;&#x6BD4;&#x8F83;&#x8D77;&#x6765;&#xFF0C;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;&#xFF0C;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#x3002;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77;Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;</p>
<p>&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#xFF1A;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x548C;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#x548C;&#x6570;&#x636E;&#x7279;&#x6027;&#x6709;&#x5173;&#x3002;</p>
<p>&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x4E0E;&#x6570;&#x636E;&#x540C;&#x6B65;&#xFF1A;Redis&#x652F;&#x6301;&#xFF0C;MemCached&#x4E0D;&#x652F;&#x6301;&#x3002;</p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;Redis&#x76F8;&#x6BD4;Memcached&#x6765;&#x8BF4;&#xFF0C;&#x62E5;&#x6709;&#x66F4;&#x591A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x652F;&#x6301;&#x66F4;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#x3002;&#x901A;&#x5E38;&#x5728;Memcached&#x91CC;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x62FF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8FDB;&#x884C;&#x7C7B;&#x4F3C;&#x7684;&#x4FEE;&#x6539;&#x518D;set&#x56DE;&#x53BB;&#x3002;&#x8FD9;&#x5927;&#x5927;&#x589E;&#x52A0;&#x4E86;&#x7F51;&#x7EDC;IO&#x7684;&#x6B21;&#x6570;&#x548C;&#x6570;&#x636E;&#x4F53;&#x79EF;&#x3002;&#x5728;Redis&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x7684;&#x64CD;&#x4F5C;&#x901A;&#x5E38;&#x548C;&#x4E00;&#x822C;&#x7684;GET/SET&#x4E00;&#x6837;&#x9AD8;&#x6548;&#x3002;</p>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2015-04/115642.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-04/115642.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23f2d3d/" title="Linux c 开发 - Memcached源码分析之增删改查操作（5） -" itemprop="url">Linux c 开发 - Memcached源码分析之增删改查操作（5） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:38.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x5728;&#x7B2C;&#x4E8C;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B; &#x548C;&#x7B2C;&#x4E09;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF08;3&#xFF09;&#x300B; &#x4E2D;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x901A;&#x8FC7;Memcached&#x7684;get&#x547D;&#x4EE4;&#xFF0C;&#x5206;&#x6790;&#x4E86;Memcached&#x7684;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x548C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x7684;&#x6A21;&#x5757;&#x529F;&#x80FD;&#x3002;&#x8FD9;&#x4E00;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x6765;&#x8BE6;&#x7EC6;&#x770B;&#x4E00;&#x4E0B;Memcached&#x5E38;&#x7528;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x5728;&#x770B;Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;process_command&#x65B9;&#x6CD5;&#x3002;Memcached&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x901A;&#x8FC7;process_command&#x65B9;&#x6CD5;&#x5C06;&#x4E0D;&#x540C;&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#x7684;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x5206;&#x53D1;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;rbuf&amp;<span class="symbol">#x4E2D</span>;\n&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x6210</span>;\<span class="number">0</span>  
static void process_command(conn *c, char *command) {  

    //tokens&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#xFF08</span>;command&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x683C</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x9694</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#xFF1A</span>;set username zhuli,&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">3</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x522B</span>;&amp;<span class="symbol">#x662F</span>;set&amp;<span class="symbol">#x548C</span>;username&amp;<span class="symbol">#x548C</span>;zhuli  
    //<span class="class">MAX_TOKENS</span>&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">8</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;memcached&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    token_t tokens[<span class="class">MAX_TOKENS</span>];  
    size_t ntokens;  
    int comm;  

    assert(c != <span class="class">NULL</span>);  

    <span class="class">MEMCACHED_PROCESS_COMMAND_START</span>(c-&amp;gt;sfd, c-&amp;gt;rcurr, c-&amp;gt;rbytes);  

    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;lt;%d %s\n&amp;quot;, c-&amp;gt;sfd, command);  

    /* 
     * for commands set/add/replace, we build an item and read the data 
     * directly into it, then continue in nread_complete(). 
     */  

    c-&amp;gt;msgcurr = <span class="number">0</span>;  
    c-&amp;gt;msgused = <span class="number">0</span>;  
    c-&amp;gt;iovused = <span class="number">0</span>;  
    if (add_msghdr(c) != <span class="number">0</span>) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory preparing response&amp;quot;);  
        return;  
    }  

    //tokenize_command&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;tokens&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;:command&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    ntokens = tokenize_command(command, tokens, <span class="class">MAX_TOKENS</span>);  

    //tokens[<span class="class">COMMAND_TOKEN</span>] <span class="class">COMMAND_TOKEN</span>=<span class="number">0</span>  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;get&amp;quot;) == <span class="number">0</span>)  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;bget&amp;quot;) == <span class="number">0</span>))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;get&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_get_command(c, tokens, ntokens, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">6</span> || ntokens == <span class="number">7</span>)  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;add&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_ADD</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;set&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_SET</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;replace&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_REPLACE</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;prepend&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_PREPEND</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;append&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_APPEND</span>)))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; add/set/replace/prepend/append  
        process_update_command(c, tokens, ntokens, comm, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">7</span> || ntokens == <span class="number">8</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;cas&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_CAS</span>))) {  

        process_update_command(c, tokens, ntokens, comm, <span class="keyword">true</span>);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;incr&amp;quot;) == <span class="number">0</span>)) {  

        process_arithmetic_command(c, tokens, ntokens, <span class="number">1</span>);  

    } else if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;gets&amp;quot;) == <span class="number">0</span>)) {  

        process_get_command(c, tokens, ntokens, <span class="keyword">true</span>);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;decr&amp;quot;) == <span class="number">0</span>)) {  

        process_arithmetic_command(c, tokens, ntokens, <span class="number">0</span>);  

    } else if (ntokens &amp;gt;= <span class="number">3</span> &amp;amp;&amp;amp; ntokens &amp;lt;= <span class="number">5</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;delete&amp;quot;) == <span class="number">0</span>)) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; delete  
        process_delete_command(c, tokens, ntokens);  

    } else if ((ntokens == <span class="number">4</span> || ntokens == <span class="number">5</span>)  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;touch&amp;quot;) == <span class="number">0</span>)) {  

        process_touch_command(c, tokens, ntokens);  

    } else if (ntokens &amp;gt;= <span class="number">2</span>  
            &amp;amp;&amp;amp; (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;stats&amp;quot;) == <span class="number">0</span>)) {  

        //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_stat(c, tokens, ntokens);  
//.....more code  
}
</code></pre><p>Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x6E90;&#x7801;&#x5206;&#x6790; </p>
<p>&#x589E;/&#x6539; set add replace &#x64CD;&#x4F5C;</p>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E2A;Memcached&#x7684;&#x547D;&#x4EE4;&#x884C;&#x7684;set&#x64CD;&#x4F5C;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code><span class="built_in">set</span> <span class="built_in">key</span> flags exptime vlen  
<span class="built_in">value</span>
</code></pre><p>set&#xFF1A;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#x540D;&#x79F0;</p>
<p>key&#xFF1A;&#x7F13;&#x5B58;&#x7684;key</p>
<p>flags&#xFF1A;&#x7F13;&#x5B58;&#x6807;&#x8BC6;</p>
<p>exptime&#xFF1A;&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;0 - &#x4E0D;&#x8FC7;&#x671F;</p>
<p>vlen&#xFF1A;&#x7F13;&#x5B58;value&#x7684;&#x957F;&#x5EA6;</p>
<p>value&#xFF1A;&#x7F13;&#x5B58;&#x7684;&#x503C;&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x5728;&#x7B2C;&#x4E8C;&#x884C;&#x3002;</p>
<p>&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code><span class="keyword">set</span> username <span class="number">0</span> <span class="number">10</span> <span class="number">9</span>  
woshishen
</code></pre><p>&#x6211;&#x4EEC;&#x5728;&#x7B2C;&#x4E8C;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B;&#x4E2D;&#x8BB2;&#x89E3;&#x5230;&#x4E86;&#x5982;&#x4F55;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x7684;&#x3002;Memcached&#x4E00;&#x822C;&#x4F1A;&#x901A;&#x8FC7;\n&#x7B26;&#x53F7;&#x53BB;&#x5206;&#x9694;&#x6BCF;&#x4E2A;&#x547D;&#x4EE4;&#x884C;&#x8BED;&#x53E5;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x5C06;&#x4E00;&#x884C;&#x547D;&#x4EE4;&#x5207;&#x5272;&#x6210;N&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x5143;&#x7D20;&#x4F1A;&#x653E;&#x8FDB;&#x4E00;&#x4E2A;tokens&#x7684;&#x6570;&#x7EC4;&#x4E2D;&#x3002;</p>
<p>&#x8FD9;&#x8FB9;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;set&#x547D;&#x4EE4;&#x4F1A;&#x5206;&#x5C42;&#x4E24;&#x90E8;&#x5206;&#xFF1A;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x548C;Value&#x503C;&#x90E8;&#x5206;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x4F1A;&#x5148;&#x53BB;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x4E14;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x4E2D;&#x5E26;&#x4E0A;&#x4E86;vlen&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;value&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x4F1A;&#x53BB;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x653E;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;&#x89E3;&#x6790;&#x5B8C;&#x6BD5;&#xFF0C;Memcached&#x4F1A;&#x53BB;&#x7EE7;&#x7EED;&#x8BFB;&#x53D6;Socket&#x4E2D;&#x7684;&#x5269;&#x4F59;&#x6570;&#x636E;&#x62A5;&#x6587;&#xFF0C;&#x8FB9;&#x8BFB;&#x53D6;&#x8FB9;&#x590D;&#x5236;&#x5230;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E2D;&#xFF0C;&#x76F4;&#x5230;&#x8BFB;&#x53D6;&#x5230;&#x7684;Value&#x6570;&#x636E;&#x957F;&#x5EA6;&#x548C;&#x547D;&#x4EE4;&#x884C;&#x4E2D;&#x7684;vlen&#x957F;&#x5EA6;&#x4E00;&#x81F4;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x7ED3;&#x675F;&#x3002;&#x7136;&#x540E;&#x4F1A;&#x53BB;&#x5B58;&#x50A8;item&#xFF0C;&#x5982;&#x679C;item&#x5B58;&#x50A8;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;item&#x6302;&#x5230;HashTable&#x548C;LRU&#x94FE;&#x4E0A;&#x9762;&#xFF1B;&#x5982;&#x679C;&#x5B58;&#x50A8;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x4F1A;&#x5220;&#x9664;item&#x3002;</p>
</li>
</ol>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;process_update_command&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<p>1.&#xA0; &#x5E2E;&#x52A9;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x884C;&#x90E8;&#x5206;</p>
<p>2.&#xA0; &#x5206;&#x914D;&#x4E00;&#x4E2A;Item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x3002;</p>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;&#x72B6;&#x6001;&#x673A;drive_machine&#x4E2D;conn_nread&#x7684;&#x4EE3;&#x7801;&#x5757;&#x3002;conn_nread&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;value&#x6570;&#x636E;&#x3002;</p>
<pre><code>/********************************* 
&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x3001</span>;&amp;<span class="symbol">#x7F16</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>; 
&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;set&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; 

&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>; 
set key flags exptime vlen 
value 

&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;vlen&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>; 
flages &amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>; 
exptime&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="number">0</span> &amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>; 
value &amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;value&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E8C</span>;&amp;<span class="symbol">#x884C</span>; 

&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>; 
set username <span class="number">0</span> <span class="number">10</span> <span class="number">9</span> 
woshishen 
**************************************/  
static void process_update_command(conn *c, token_t *tokens,  
        const size_t ntokens, int comm, bool handle_cas) {  
    char *key; //key  
    size_t nkey; //key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    unsigned int flags; //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;  
    int32_t exptime_int = <span class="number">0</span>;  
    time_t exptime; //&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;  
    int vlen; //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    uint64_t req_cas_id = <span class="number">0</span>;  
    //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;key/value&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabclass&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;  
    item *it;  

    assert(c != <span class="class">NULL</span>);  

    set_noreply_maybe(c, tokens, ntokens);  
    //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>; key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;<span class="number">250</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;  
    if (tokens[<span class="class">KEY_TOKEN</span>].length &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x548C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //tokens[<span class="number">0</span>]&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    key = tokens[<span class="class">KEY_TOKEN</span>].value; //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
    nkey = tokens[<span class="class">KEY_TOKEN</span>].length; //key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  

    //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6027</span>;  
    if (!(safe_strtoul(tokens[<span class="number">2</span>].value, (uint32_t *) &amp;amp;flags)  
            &amp;amp;&amp;amp; safe_strtol(tokens[<span class="number">3</span>].value, &amp;amp;exptime_int)  
            &amp;amp;&amp;amp; safe_strtol(tokens[<span class="number">4</span>].value, (int32_t *) &amp;amp;vlen))) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    /* <span class="class">Ubuntu</span> <span class="number">8.04</span> breaks when <span class="class">I</span> pass exptime to safe_strtol */  
    exptime = exptime_int;  

    /* <span class="class">Negative</span> exptimes can underflow and end up immortal. realtime() will 
     immediately expire values that are greater than <span class="class">REALTIME_MAXDELTA</span>, but less 
     than process_started, so lets aim for that. */  
    if (exptime &amp;lt; <span class="number">0</span>)  
        exptime = <span class="class">REALTIME_MAXDELTA</span> + <span class="number">1</span>;  

    // does cas value exist?  
    if (handle_cas) {  
        if (!safe_strtoull(tokens[<span class="number">5</span>].value, &amp;amp;req_cas_id)) {  
            out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
            return;  
        }  
    }  

    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;vlen&amp;<span class="symbol">#x8981</span>;+<span class="number">2</span>&amp;<span class="symbol">#x5462</span>;&amp;<span class="symbol">#xFF1F</span>;  
    //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;/r/n  
    //&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;/r/n&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;\r\n&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>; &amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
    vlen += <span class="number">2</span>;  
    if (vlen &amp;lt; <span class="number">0</span> || vlen - <span class="number">2</span> &amp;lt; <span class="number">0</span>) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
        return;  
    }  

    if (settings.detail_enabled) {  
        stats_prefix_record_set(key, nkey);  
    }  

    //item_alloc&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x6838</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;item_alloc&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item  
    //&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;  
    //key&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;key  
    //nkey&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //<span class="method">flags:</span>&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x8BC6</span>;  
    //exptime&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    //vlen&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7591</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF1F</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x4E86</span>;vlen&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x5462</span>;&amp;<span class="symbol">#xFF1F</span>;  
    //<span class="number">1.</span> &amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;set/add/replace&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E9B</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x8F93</span>;  
    //<span class="number">2.</span> &amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x9009</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x62EC</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;  
    //<span class="number">3.</span> &amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7C98</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;  
    //&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9884</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5B8C</span>;  
    //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x5373</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x3002</span>;  
    //<span class="number">4.</span> &amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF1A</span>;conn_set_state(c, conn_nread); &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_nread&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;conn_nread  
    //&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;  
    it = item_alloc(key, nkey, flags, realtime(exptime), vlen);  

    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
    if (it == <span class="number">0</span>) {  
        if (!item_size_ok(nkey, flags, vlen))  
            out_string(c, &amp;quot;<span class="class">SERVER_ERROR</span> object too large for cache&amp;quot;);  
        else  
            out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory storing object&amp;quot;);  
        /* swallow the data line */  
        c-&amp;gt;write_and_go = conn_swallow;  
        c-&amp;gt;sbytes = vlen;  

        /* <span class="class">Avoid</span> stale data persisting in cache because we failed alloc. 
         * <span class="class">Unacceptable</span> for <span class="class">SET</span>. <span class="class">Anywhere</span> else too? */  
        if (comm == <span class="class">NREAD_SET</span>) {  
            it = item_get(key, nkey);  
            if (it) {  
                item_unlink(it);  
                item_remove(it);  
            }  
        }  

        return;  
    }  
    <span class="class">ITEM_set_cas</span>(it, req_cas_id);  

    c-&amp;gt;item = it;  
    c-&amp;gt;ritem = <span class="class">ITEM_data</span>(it); //value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    c-&amp;gt;rlbytes = it-&amp;gt;nbytes; //value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    c-&amp;gt;cmd = comm;  
    //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_nread&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    conn_set_state(c, conn_nread);  
}
</code></pre><p>&#x770B;&#x4E00;&#x4E0B;item_alloc&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5206;&#x914D;&#x4E00;&#x5757;&#x53EF;&#x4EE5;&#x7528;&#x7684;Item&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>Memcached&#x662F;&#x901A;&#x8FC7;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x957F;&#x5EA6;&#x9009;&#x62E9;&#x5408;&#x9002;&#x7684;slab class&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8BE5;slabs class&#x4E0A;&#x5206;&#x914D;&#x4E00;&#x5757;item&#x3002;</p>
</li>
</ol>
<p>&#x5148;&#x770B;&#x4E00;&#x4E0B;Item&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code>//item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
typedef struct _stritem {  
    //&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *next;  //&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *prev;  //&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    struct _stritem *h_next; //hashtable&amp;<span class="symbol">#x7684</span>;list   /* hash chain next */  
    //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    rel_time_t      time;       /* least recent access */  
    //&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
    rel_time_t      exptime;    /* expire time */  
    //value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
    int             nbytes;     /* size of data */  
    unsigned short  refcount;  
    uint8_t         nsuffix;    /* length of flags-and-length string */  
    uint8_t         it_flags;   /* <span class="class">ITEM_</span>* above */  
    //slab class&amp;<span class="symbol">#x7684</span>;<span class="class">ID</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E0A</span>;  
    uint8_t         slabs_clsid;/* which slab class we&amp;apos;re in */  
    uint8_t         nkey;       /* key length, w/terminating null and padding */  
    /* this odd type prevents type-punning issues when we do 
     * the little shuffle to save space when not using <span class="class">CAS</span>. */  
    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;  
    union {  
        uint64_t cas;  
        char end;  
    } data[];  
    /* if it_flags &amp;amp; <span class="class">ITEM_CAS</span> we have <span class="number">8</span> bytes <span class="class">CAS</span> */  
    /* then null-terminated key */  
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
} item;


/* 
 * <span class="class">Allocates</span> a new item. 
 */  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
item *item_alloc(char *key, size_t nkey, int flags, rel_time_t exptime, int nbytes) {  
    item *it;  
    /* do_item_alloc handles its own locks */  
    it = do_item_alloc(key, nkey, flags, exptime, nbytes, <span class="number">0</span>);  
    return it;  
}


//&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
item *do_item_alloc(char *key, const size_t nkey, const int flags,  
                    const rel_time_t exptime, const int nbytes,  
                    const uint32_t cur_hv) {  
    uint8_t nsuffix;  
    item *it = <span class="class">NULL</span>; //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    char suffix[<span class="number">40</span>];  
    //item_make_header &amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    size_t ntotal = item_make_header(nkey + <span class="number">1</span>, flags, nbytes, suffix, &amp;amp;nsuffix);  
    if (settings.use_cas) {  
        ntotal += sizeof(uint64_t);  
    }  
    //&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;ntotal &amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    //<span class="class">Memcached</span>&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class  
    //&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#xFF0C</span>;slabs&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabs&amp;<span class="symbol">#x4E0A</span>;  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;chunk  
    //  
    //&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>; &amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">200</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x3002</span>;  
    //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;slabs_class&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;item&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
    //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;slabs&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;chunk&amp;<span class="symbol">#x5757</span>;  
    //&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;chunk&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    unsigned int id = slabs_clsid(ntotal);  
    if (id == <span class="number">0</span>)  
        return <span class="number">0</span>;  
    mutex_lock(&amp;amp;cache_lock);  
    /* do a quick check if we have any expired items in the tail.. */  
    int tries = <span class="number">5</span>;  
    /* <span class="class">Avoid</span> hangs if a slab has nothing but refcounted stuff in it. */  
    int tries_lrutail_reflocked = <span class="number">1000</span>;  
    int tried_alloc = <span class="number">0</span>;  
    item *search;  
    item *next_it;  
    void *hold_lock = <span class="class">NULL</span>;  
    rel_time_t oldest_live = settings.oldest_live;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    //item&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    search = tails[id];  
    /* <span class="class">We</span> walk up *only* for locked items. <span class="class">Never</span> searching for expired. 
     * <span class="class">Waste</span> of <span class="class">CPU</span> for almost all deployments */  
    for (; tries &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; search != <span class="class">NULL</span>; tries--, search=next_it) {  
        /* we might relink search mid-loop, so search-&amp;gt;prev isn&amp;apos;t reliable */  
        next_it = search-&amp;gt;prev;  
        if (search-&amp;gt;nbytes == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;nkey == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;it_flags == <span class="number">1</span>) {  
            /* <span class="class">We</span> are a crawler, ignore it. */  
            tries++;  
            continue;  
        }  
        uint32_t hv = hash(<span class="class">ITEM_key</span>(search), search-&amp;gt;nkey);  
        /* <span class="class">Attempt</span> to hash item lock the &amp;quot;search&amp;quot; item. <span class="class">If</span> locked, no 
         * other callers can incr the refcount 
         */  
        /* <span class="class">Don</span>&amp;apos;t accidentally grab ourselves, or bail if we can&amp;apos;t quicklock */  
        if (hv == cur_hv || (hold_lock = item_trylock(hv)) == <span class="class">NULL</span>)  
            continue;  
        /* <span class="class">Now</span> see if the item is refcount locked */  
        if (refcount_incr(&amp;amp;search-&amp;gt;refcount) != <span class="number">2</span>) {  
            /* <span class="class">Avoid</span> pathological case with ref&amp;apos;ed items in tail */  
            do_item_update_nolock(search);  
            tries_lrutail_reflocked--;  
            tries++;  
            refcount_decr(&amp;amp;search-&amp;gt;refcount);  
            itemstats[id].lrutail_reflocked++;  
            /* <span class="class">Old</span> rare bug could cause a refcount leak. <span class="class">We</span> haven&amp;apos;t seen 
             * it in years, but we leave this code in to prevent failures 
             * just in case */  
            if (settings.tail_repair_time &amp;amp;&amp;amp;  
                    search-&amp;gt;time + settings.tail_repair_time &amp;lt; current_time) {  
                itemstats[id].tailrepairs++;  
                search-&amp;gt;refcount = <span class="number">1</span>;  
                do_item_unlink_nolock(search, hv);  
            }  
            if (hold_lock)  
                item_trylock_unlock(hold_lock);  
            if (tries_lrutail_reflocked &amp;lt; <span class="number">1</span>)  
                break;  
            continue;  
        }  
        /* <span class="class">Expired</span> or flushed */  
        if ((search-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;exptime &amp;lt; current_time)  
            || (search-&amp;gt;time &amp;lt;= oldest_live &amp;amp;&amp;amp; oldest_live &amp;lt;= current_time)) {  
            itemstats[id].reclaimed++;  
            if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                itemstats[id].expired_unfetched++;  
            }  
            it = search;  
            slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
            do_item_unlink_nolock(it, hv);  
            /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
            it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
        //slabs_alloc&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
        } else if ((it = slabs_alloc(ntotal, id)) == <span class="class">NULL</span>) {  
            tried_alloc = <span class="number">1</span>;  
            if (settings.evict_to_free == <span class="number">0</span>) {  
                itemstats[id].outofmemory++;  
            } else {  
                itemstats[id].evicted++;  
                itemstats[id].evicted_time = current_time - search-&amp;gt;time;  
                if (search-&amp;gt;exptime != <span class="number">0</span>)  
                    itemstats[id].evicted_nonzero++;  
                if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                    itemstats[id].evicted_unfetched++;  
                }  
                it = search;  
                slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
                do_item_unlink_nolock(it, hv);  
                /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
                it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
                /* <span class="class">If</span> we&amp;apos;ve just evicted an item, and the automover is set to 
                 * angry bird mode, attempt to rip memory into this slab class. 
                 * <span class="class">TODO</span>: <span class="class">Move</span> valid object detection into a function, and on a 
                 * &amp;quot;successful&amp;quot; memory pull, look behind and see if the next alloc 
                 * would be an eviction. <span class="class">Then</span> kick off the slab mover before the 
                 * eviction happens. 
                 */  
                if (settings.slab_automove == <span class="number">2</span>)  
                    slabs_reassign(-<span class="number">1</span>, id);  
            }  
        }  
        refcount_decr(&amp;amp;search-&amp;gt;refcount);  
        /* <span class="class">If</span> hash values were equal, we don&amp;apos;t grab a second lock */  
        if (hold_lock)  
            item_trylock_unlock(hold_lock);  
        break;  
    }  
    if (!tried_alloc &amp;amp;&amp;amp; (tries == <span class="number">0</span> || search == <span class="class">NULL</span>))  
        it = slabs_alloc(ntotal, id);  
    if (it == <span class="class">NULL</span>) {  
        itemstats[id].outofmemory++;  
        mutex_unlock(&amp;amp;cache_lock);  
        return <span class="class">NULL</span>;  
    }  
    assert(it-&amp;gt;slabs_clsid == <span class="number">0</span>);  
    assert(it != heads[id]);  
    /* <span class="class">Item</span> initialization can happen outside of the lock; the item&amp;apos;s already 
     * been removed from the slab <span class="class">LRU</span>. 
     */  
    it-&amp;gt;refcount = <span class="number">1</span>;     /* the caller will have a reference */  
    mutex_unlock(&amp;amp;cache_lock);  
    it-&amp;gt;next = it-&amp;gt;prev = it-&amp;gt;h_next = <span class="number">0</span>;  
    it-&amp;gt;slabs_clsid = id;  
    <span class="class">DEBUG_REFCNT</span>(it, &amp;apos;*&amp;apos;);  
    it-&amp;gt;it_flags = settings.use_cas ? <span class="class">ITEM_CAS</span> : <span class="number">0</span>;  
    it-&amp;gt;nkey = nkey;  
    it-&amp;gt;nbytes = nbytes;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;  
    memcpy(<span class="class">ITEM_key</span>(it), key, nkey);  
    it-&amp;gt;exptime = exptime;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;  
    memcpy(<span class="class">ITEM_suffix</span>(it), suffix, (size_t)nsuffix);  
    it-&amp;gt;nsuffix = nsuffix;  
    return it;  
}
</code></pre><p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x72B6;&#x6001;&#x673A;drive_machine&#x4E2D;conn_nread&#x7684;&#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x8BFB;&#x53D6;&#x7F13;&#x5B58;&#x7684;value&#x503C;</p>
</li>
<li><p>&#x5C06;&#x6570;&#x636E;&#x62F7;&#x8D1D;&#x5230;item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<p> //conn_nread &#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x8BFB;&#x53D6;&#x7F13;&#x5B58;&#x7684;value&#x6570;&#x636E;&#x62A5;&#x6587;<br> case conn_nread:  </p>
<pre><code>//&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>; value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E86</span>;  
if (c-&amp;gt;rlbytes == <span class="number">0</span>) {  
    complete_nread(c);  
    break;  
}  
/* <span class="class">Check</span> if rbytes &amp;lt; <span class="number">0</span>, to prevent crash */  
//&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
if (c-&amp;gt;rlbytes &amp;lt; <span class="number">0</span>) {  
    if (settings.verbose) {  
        fprintf(stderr, &amp;quot;<span class="class">Invalid</span> rlbytes to <span class="method">read:</span> len %d\n&amp;quot;,  
                c-&amp;gt;rlbytes);  
    }  
    conn_set_state(c, conn_closing);  
    break;  
}  
/* first check if we have leftovers in the conn_read buffer */  
//c-&amp;gt;rbytes &amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//c-&amp;gt;rlbytes &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
    //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76EE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;c-&amp;gt;rlbytes&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes &amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>; c-&amp;gt;rlbytes &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes &amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>; c-&amp;gt;rlbytes &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53E6</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8DEF</span>;&amp;<span class="symbol">#x4E0A</span>;  
    int tocopy = c-&amp;gt;rbytes &amp;gt; c-&amp;gt;rlbytes ? c-&amp;gt;rlbytes : c-&amp;gt;rbytes;  
    //c-&amp;gt;ritem &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6B21</span>;set/add/replace&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    if (c-&amp;gt;ritem != c-&amp;gt;rcurr) {  
        memmove(c-&amp;gt;ritem, c-&amp;gt;rcurr, tocopy);  
    }  
    c-&amp;gt;ritem += tocopy; //&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x52A0</span>;  
    c-&amp;gt;rlbytes -= tocopy; //&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7684</span>;value&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>; &amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    c-&amp;gt;rcurr += tocopy; //&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    c-&amp;gt;rbytes -= tocopy; //&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>; &amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>; &amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rlbytes&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;value&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x51FA</span>;  
    if (c-&amp;gt;rlbytes == <span class="number">0</span>) {  
        break;  
    }  
}  
/*  now try reading from the socket */  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;<span class="symbol">#x4ECE</span>;socket&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;c-&amp;gt;ritem&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;value&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;c-&amp;gt;rlbytes  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5230</span>;value&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6B62</span>;  
res = read(c-&amp;gt;sfd, c-&amp;gt;ritem, c-&amp;gt;rlbytes);  
if (res &amp;gt; <span class="number">0</span>) {  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.bytes_read += res;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    if (c-&amp;gt;rcurr == c-&amp;gt;ritem) {  
        c-&amp;gt;rcurr += res;  
    }  
    c-&amp;gt;ritem += res;  
    c-&amp;gt;rlbytes -= res;  
    break;  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6D41</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
if (res == <span class="number">0</span>) { /* end of stream */  
    conn_set_state(c, conn_closing);  
    break;  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;  
if (res == -<span class="number">1</span> &amp;amp;&amp;amp; (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>)) {  
    if (!update_event(c, <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>)) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    stop = <span class="keyword">true</span>;  
    break;  
}  
/* otherwise we have a real error, on which we close the connection */  
if (settings.verbose &amp;gt; <span class="number">0</span>) {  
    fprintf(stderr, &amp;quot;<span class="class">Failed</span> to read, and not due to <span class="method">blocking:</span>\n&amp;quot;  
            &amp;quot;<span class="method">errno:</span> %d %s \n&amp;quot;  
            &amp;quot;rcurr=%lx ritem=%lx rbuf=%lx rlbytes=%d rsize=%d\n&amp;quot;, errno,  
            strerror(errno), (long) c-&amp;gt;rcurr, (long) c-&amp;gt;ritem,  
            (long) c-&amp;gt;rbuf, (int) c-&amp;gt;rlbytes, (int) c-&amp;gt;rsize);  
}  
//&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;  
conn_set_state(c, conn_closing);  
break;
</code></pre></li>
</ol>
<p>&#x8FD9;&#x8FB9;&#x5982;&#x679C;&#x8BFB;&#x53D6;&#x5B8C;&#x6210;&#x4E86;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;complete_nread(c)&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5F80;&#x4E0B;&#x4E00;&#x76F4;&#x770B;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x5230;complete_nread_ascii&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x8C03;&#x7528;&#x5B58;&#x50A8;&#x6570;&#x636E;store_item&#x7684;&#x65B9;&#x6CD5;</p>
</li>
<li><p>&#x8C03;&#x7528;item_remove&#x5220;&#x9664;item&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p> static void complete_nread_ascii(conn *c) {  </p>
<pre><code>assert(c != NULL);  

item *it = c-&amp;<span class="keyword">gt</span>;item;  
<span class="keyword">int</span> comm = c-&amp;<span class="keyword">gt</span>;cmd;  
enum store_item_type ret;  

pthread_mutex_lock(&amp;amp;c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.mutex);  
c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.slab_stats[it-&amp;<span class="keyword">gt</span>;slabs_clsid].set_cmds++;  
pthread_mutex_unlock(&amp;amp;c-&amp;<span class="keyword">gt</span>;thread-&amp;<span class="keyword">gt</span>;stats.mutex);  

<span class="keyword">if</span> (strncmp(ITEM_data(it) + it-&amp;<span class="keyword">gt</span>;nbytes - <span class="number">2</span>, &amp;quot;\r\n&amp;quot;, <span class="number">2</span>) != <span class="number">0</span>) {  
    out_string(c, &amp;quot;CLIENT_ERROR bad data chunk&amp;quot;);  
} <span class="keyword">else</span> {  
    <span class="regexp">//</span>&amp;<span class="comment">#x8FD9;&amp;#x8FB9;&amp;#x8C03;&amp;#x7528;&amp;#x5B58;&amp;#x50A8;Item&amp;#x7684;&amp;#x65B9;&amp;#x6CD5;  </span>
    ret = store_item(it, comm, c);  
</code></pre><p> //….  </p>
<pre><code>    switch (ret) {  
    case <span class="class">STORED</span>:  
        out_string(c, &amp;quot;<span class="class">STORED</span>&amp;quot;);  
        break;  
    case <span class="class">EXISTS</span>:  
        out_string(c, &amp;quot;<span class="class">EXISTS</span>&amp;quot;);  
        break;  
    case <span class="class">NOT_FOUND</span>:  
        out_string(c, &amp;quot;<span class="class">NOT_FOUND</span>&amp;quot;);  
        break;  
    case <span class="class">NOT_STORED</span>:  
        out_string(c, &amp;quot;<span class="class">NOT_STORED</span>&amp;quot;);  
        break;  
    <span class="method">default:</span>  
        out_string(c, &amp;quot;<span class="class">SERVER_ERROR</span> <span class="class">Unhandled</span> storage type.&amp;quot;);  
    }  

}  

//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7ADF</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#xFF1F</span>;&amp;<span class="symbol">#x4F60</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x89C9</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5947</span>;&amp;<span class="symbol">#x602A</span>;&amp;<span class="symbol">#x4E48</span>;&amp;<span class="symbol">#xFF1F</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;item-&amp;gt;refcount,&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;alloc&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;refcount&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>  
//  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;store_item&amp;<span class="symbol">#xFF0C</span>;add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_link  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;refcount&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;  
//if (refcount_decr(&amp;amp;it-&amp;gt;refcount) == <span class="number">0</span>) &amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
//  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;store_item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x786E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item  
//  
//&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x7ED5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x903B</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F46</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x5DE7</span>;&amp;<span class="symbol">#x5999</span>;  
item_remove(c-&amp;gt;item); /* release the c-&amp;gt;item reference */  
c-&amp;gt;item = <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;do_store_item&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x3002;&#x57FA;&#x672C;&#x5305;&#x62EC;&#x4E24;&#x79CD;&#x72B6;&#x6001;&#xFF1A;&#x5B58;&#x50A8;&#x6210;&#x529F;&#x548C;&#x5B58;&#x50A8;&#x5931;&#x8D25;&#x3002;</p>
<ol>
<li><p>add/replace&#x547D;&#x4EE4;&#xFF0C;&#x4F1A;&#x5224;&#x65AD;item&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x5219;add&#x547D;&#x4EE4;&#x64CD;&#x4F5C;&#x5931;&#x8D25;</p>
</li>
<li><p>set&#x547D;&#x4EE4;&#xFF0C;item&#x5B58;&#x5728;&#x6216;&#x8005;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x90FD;&#x4F1A;&#x521B;&#x5EFA;&#x65B0;&#x7684;item&#xFF0C;&#x66FF;&#x6362;&#x8001;&#x7684;item&#x3002;</p>
<p> //&#x5B58;&#x50A8;Item&#x64CD;&#x4F5C;<br> enum store_item_type do_store_item(item <em>it, int comm, conn </em>c,  </p>
<pre><code>    const uint32_t hv) {  
char *key = <span class="class">ITEM_key</span>(it);  
//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;<span class="class">KEY</span>&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x65E7</span>;&amp;<span class="symbol">#x7684</span>;item  
//add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item  
item *old_it = do_item_get(key, it-&amp;gt;nkey, hv);  
enum store_item_type stored = <span class="class">NOT_STORED</span>;  
item *new_it = <span class="class">NULL</span>;  
int flags;  
//<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT_STORED</span>  
if (old_it != <span class="class">NULL</span> &amp;amp;&amp;amp; comm == <span class="class">NREAD_ADD</span>) {  
    /* add only adds a nonexistent item, but promote to head of <span class="class">LRU</span> */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //<span class="number">1.</span>&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;item&amp;<span class="symbol">#x7684</span>;it-&amp;gt;time&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x987A</span>;&amp;<span class="symbol">#x5E8F</span>;  
    //<span class="number">2.</span>&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;refcount  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;it-&amp;gt;refcount=<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;old_it&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    do_item_update(old_it);  
//replace/prepend/append &amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x505A</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;item&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT_STORED</span>  
} else if (!old_it  
        &amp;amp;&amp;amp; (comm == <span class="class">NREAD_REPLACE</span> || comm == <span class="class">NREAD_APPEND</span>  
                || comm == <span class="class">NREAD_PREPEND</span>)) {  
    /* replace only replaces an existing value; don&amp;apos;t store */  
} else if (comm == <span class="class">NREAD_CAS</span>) {  
    /* validate cas operation */  
    if (old_it == <span class="class">NULL</span>) {  
        // <span class="class">LRU</span> expired  
        stored = <span class="class">NOT_FOUND</span>;  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.cas_misses++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    } else if (<span class="class">ITEM_get_cas</span>(it) == <span class="class">ITEM_get_cas</span>(old_it)) {  
        // cas validates  
        // it and old_it may belong to different classes.  
        // <span class="class">I</span>&amp;apos;m updating the stats for the one that&amp;apos;s getting pushed out  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.slab_stats[old_it-&amp;gt;slabs_clsid].cas_hits++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        item_replace(old_it, it, hv);  
        stored = <span class="class">STORED</span>;  
    } else {  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.slab_stats[old_it-&amp;gt;slabs_clsid].cas_badval++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        if (settings.verbose &amp;gt; <span class="number">1</span>) {  
            fprintf(stderr, &amp;quot;<span class="class">CAS</span>:  <span class="method">failure:</span> expected %llu, got %llu\n&amp;quot;,  
                    (unsigned long long) <span class="class">ITEM_get_cas</span>(old_it),  
                    (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
        }  
        stored = <span class="class">EXISTS</span>;  
    }  
} else {  
    /* 
     * <span class="class">Append</span> - combine new and old record into single one. <span class="class">Here</span> it&amp;apos;s 
     * atomic and thread-safe. 
     */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8001</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x8FFD</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>; append&amp;<span class="symbol">#x548C</span>;prepend&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (comm == <span class="class">NREAD_APPEND</span> || comm == <span class="class">NREAD_PREPEND</span>) {  
        /* 
         * <span class="class">Validate</span> <span class="class">CAS</span> 
         */  
        if (<span class="class">ITEM_get_cas</span>(it) != <span class="number">0</span>) {  
            // <span class="class">CAS</span> much be equal  
            if (<span class="class">ITEM_get_cas</span>(it) != <span class="class">ITEM_get_cas</span>(old_it)) {  
                stored = <span class="class">EXISTS</span>;  
            }  
        }  
        if (stored == <span class="class">NOT_STORED</span>) {  
            /* we have it and old_it here - alloc memory to hold both */  
            /* flags was already lost - so recover them from <span class="class">ITEM_suffix</span>(it) */  
            flags = (int) strtol(<span class="class">ITEM_suffix</span>(old_it), (char **) <span class="class">NULL</span>, <span class="number">10</span>);  
            new_it = do_item_alloc(key, it-&amp;gt;nkey, flags, old_it-&amp;gt;exptime,  
                    it-&amp;gt;nbytes + old_it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */, hv);  
            if (new_it == <span class="class">NULL</span>) {  
                /* <span class="class">SERVER_ERROR</span> out of memory */  
                if (old_it != <span class="class">NULL</span>)  
                    do_item_remove(old_it);  
                return <span class="class">NOT_STORED</span>;  
            }  
            /* copy data from it and old_it to new_it */  
            if (comm == <span class="class">NREAD_APPEND</span>) {  
                memcpy(<span class="class">ITEM_data</span>(new_it), <span class="class">ITEM_data</span>(old_it),  
                        old_it-&amp;gt;nbytes);  
                memcpy(<span class="class">ITEM_data</span>(new_it) + old_it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */,  
                        <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes);  
            } else {  
                /* <span class="class">NREAD_PREPEND</span> */  
                memcpy(<span class="class">ITEM_data</span>(new_it), <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes);  
                memcpy(<span class="class">ITEM_data</span>(new_it) + it-&amp;gt;nbytes - <span class="number">2</span> /* <span class="class">CRLF</span> */,  
                        <span class="class">ITEM_data</span>(old_it), old_it-&amp;gt;nbytes);  
            }  
            it = new_it;  
        }  
    }  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;add/set/replace/prepend/append&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (stored == <span class="class">NOT_STORED</span>) {  
        if (old_it != <span class="class">NULL</span>)  
            //&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;old_it&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
            //it&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;it-&amp;gt;refcount=<span class="number">2</span>  
            item_replace(old_it, it, hv);  
        else  
            //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#xFF0C</span>;it-&amp;gt;refcount=<span class="number">2</span>  
            do_item_link(it, hv);  
        c-&amp;gt;cas = <span class="class">ITEM_get_cas</span>(it);  
        stored = <span class="class">STORED</span>;  
    }  
    //&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#xFF1A</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x63D0</span>;&amp;<span class="symbol">#x5230</span>;it-&amp;gt;refcount?  
    //<span class="number">1.</span> &amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;it-&amp;gt;refcount&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9632</span>;&amp;<span class="symbol">#x6B62</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;item  
    //<span class="number">2.</span> do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;refcount&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">ITEM</span>  
    //  
    //&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_store_item&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;memcached&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_remove(it);&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x3002</span>;  
    //do_item_remove&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5C06</span>;item&amp;<span class="symbol">#x751F</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">SET</span>/<span class="class">ADD</span>&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x597D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">SET</span>&amp;<span class="symbol">#x548C</span>;<span class="class">ADD</span>&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_link&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;item&amp;<span class="symbol">#x7684</span>;refcount&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;  
    //&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;do_item_remove(it);&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">0</span>&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x7ED5</span>;.....  
}  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8001</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
if (old_it != <span class="class">NULL</span>)  
    do_item_remove(old_it); /* release our reference */  
//new_it&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;prepend/append&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
if (new_it != <span class="class">NULL</span>)  
    do_item_remove(new_it);  
if (stored == <span class="class">STORED</span>) {  
    c-&amp;gt;cas = <span class="class">ITEM_get_cas</span>(it);  
}  
return stored;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x5728;do_store_item&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x7EC8;&#x4F1A;&#x627E;&#x5230;do_item_link&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;item&#x6302;&#x5230;Hashtable&#x4E0A;&#x9762;</p>
</li>
<li><p>&#x5C06;item&#x6302;&#x5230;LRU&#x94FE;&#x4E0A;&#x9762;</p>
</li>
</ol>
<p>HashTable&#xFF1A;&#x628A;Item&#x6302;&#x5230;HashTable&#x4E0A;&#x53BB;&#x540E;&#xFF0C;&#x7528;&#x6237;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F13;&#x5B58;&#x7684;key&#x5230;HashTable&#x4E0A;&#x67E5;&#x8BE2;&#x8FD9;&#x4E2A;Item&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>LRU&#xFF1A;&#x662F;&#x4E00;&#x4E2A;&#x6E05;&#x9664;&#x7F13;&#x5B58;&#x7684;&#x7B56;&#x7565;&#xFF0C;&#x4E00;&#x822C;&#x4F1A;&#x6E05;&#x7406;&#x6700;&#x4E0D;&#x5E38;&#x7528;&#x7684;&#x5143;&#x7D20;&#x3002;LRU&#x7684;&#x94FE;&#xFF0C;&#x4F1A;&#x653E;&#x5728;&#x4E0B;&#x9762;&#x4E24;&#x4E2A;Item&#x6307;&#x9488;&#x5730;&#x5740;&#x7684;&#x6570;&#x7EC4;&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>static item *heads[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
static item *tails[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;
</code></pre><p>v</p>
<pre><code><span class="comment">//&amp;#x65B0;&amp;#x589E;&amp;#x4E00;&amp;#x4E2A;Item&amp;#x7684;&amp;#x8FDE;&amp;#x63A5;&amp;#x5173;&amp;#x7CFB;  </span>
int do_item_link<span class="params">(item *it, const uint32_t hv)</span> {  
    MEMCACHED_ITEM_LINK<span class="params">(ITEM_key<span class="params">(it)</span>, it-&amp;gt;nkey, it-&amp;gt;nbytes)</span>;  
    assert<span class="params">(<span class="params">(it-&amp;gt;it_flags &amp;amp; <span class="params">(ITEM_LINKED|ITEM_SLABBED)</span>)</span> == <span class="number">0</span>)</span>;  
    mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
    it-&amp;gt;it_flags |= ITEM_LINKED;  
    it-&amp;gt;time = current_time;  

    STATS_LOCK<span class="params">()</span>;  
    stats.curr_bytes += ITEM_ntotal<span class="params">(it)</span>;  
    stats.curr_items += <span class="number">1</span>;  
    stats.total_items += <span class="number">1</span>;  
    STATS_UNLOCK<span class="params">()</span>;  

    <span class="comment">/* Allocate a new CAS ID on link. */</span>  
    ITEM_set_cas<span class="params">(it, <span class="params">(settings.use_cas)</span> ? get_cas_id<span class="params">()</span> : <span class="number">0</span>)</span>;  
    <span class="comment">//&amp;#x5206;&amp;#x914D;&amp;#x5230;HashTable&amp;#x7684;&amp;#x6876;&amp;#x4E0A;  </span>
    assoc_insert<span class="params">(it, hv)</span>;  
    <span class="comment">//LRU&amp;#x94FE;  </span>
    item_link_q<span class="params">(it)</span>;  
    refcount_incr<span class="params">(&amp;amp;it-&amp;gt;refcount)</span>; <span class="comment">//&amp;#x5F15;&amp;#x7528;&amp;#x6B21;&amp;#x6570;+1  </span>
    mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  

    return <span class="number">1</span>;  
}
</code></pre><p>&#x67E5;&#x8BE2; get &#x64CD;&#x4F5C;</p>
<p>&#x67E5;&#x8BE2;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x770B;&#x4E0B;process_get_command&#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5206;&#x89E3;get&#x547D;&#x4EE4;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;key&#x53BB;HashTable&#x4E0A;&#x627E;&#x5230;item&#x7684;&#x5730;&#x5740;&#x503C;&#x3002;</p>
</li>
<li><p>&#x8FD4;&#x56DE;&#x627E;&#x5230;&#x7684;item&#x6570;&#x636E;&#x503C;&#x3002;</p>
<p> /<em> ntokens is overwritten here… shrug.. </em>/<br> //&#x5904;&#x7406;GET&#x8BF7;&#x6C42;&#x7684;&#x547D;&#x4EE4;<br> static inline void process_get_command(conn <em>c, token_t </em>tokens, size_t ntokens,  </p>
<pre><code>    bool return_cas) {  
//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
char *key;  
size_t nkey;  
int i = <span class="number">0</span>;  
item *it;  
//&amp;amp;tokens[<span class="number">0</span>] &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;amp;tokens[<span class="number">1</span>] &amp;<span class="symbol">#x4E3A</span>;key  
//token_t &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E86</span>;value&amp;<span class="symbol">#x548C</span>;length  
token_t *key_token = &amp;amp;tokens[<span class="class">KEY_TOKEN</span>];  
char *suffix;  
assert(c != <span class="class">NULL</span>);  
do {  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
    while (key_token-&amp;gt;length != <span class="number">0</span>) {  
        key = key_token-&amp;gt;value;  
        nkey = key_token-&amp;gt;length;  
        //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;memcache key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">250</span>  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;  
        if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
            //out_string &amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
            while (i-- &amp;gt; <span class="number">0</span>) {  
                item_remove(*(c-&amp;gt;ilist + i));  
            }  
            return;  
        }  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5FEB</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        it = item_get(key, nkey);  
        if (settings.detail_enabled) {  
            //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
            stats_prefix_record_get(key, nkey, <span class="class">NULL</span> != it);  
        }  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        if (it) {  
            //c-&amp;gt;ilist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;buf  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;ilist&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
            if (i &amp;gt;= c-&amp;gt;isize) {  
                item **new_list = realloc(c-&amp;gt;ilist,  
                        sizeof(item *) * c-&amp;gt;isize * <span class="number">2</span>);  
                if (new_list) {  
                    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
                    c-&amp;gt;isize *= <span class="number">2</span>;  
                    //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x652F</span>;&amp;<span class="symbol">#x6301</span>;  
                    c-&amp;gt;ilist = new_list;  
                } else {  
                    <span class="class">STATS_LOCK</span>();  
                    stats.malloc_fails++;  
                    <span class="class">STATS_UNLOCK</span>();  
                    item_remove(it);  
                    break;  
                }  
            }  
            /* 
             * <span class="class">Construct</span> the response. <span class="class">Each</span> hit adds three elements to the 
             * outgoing data <span class="method">list:</span> 
             *   &amp;quot;<span class="class">VALUE</span> &amp;quot; 
             *   key 
             *   &amp;quot; &amp;quot; + flags + &amp;quot; &amp;quot; + data length + &amp;quot;\r\n&amp;quot; + data (with \r\n) 
             */  
            //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
            if (return_cas) {  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                        it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                /* <span class="class">Goofy</span> mid-flight realloc. */  
                if (i &amp;gt;= c-&amp;gt;suffixsize) {  
                    char **new_suffix_list = realloc(c-&amp;gt;suffixlist,  
                            sizeof(char *) * c-&amp;gt;suffixsize * <span class="number">2</span>);  
                    if (new_suffix_list) {  
                        c-&amp;gt;suffixsize *= <span class="number">2</span>;  
                        c-&amp;gt;suffixlist = new_suffix_list;  
                    } else {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        item_remove(it);  
                        break;  
                    }  
                }  
                suffix = cache_alloc(c-&amp;gt;thread-&amp;gt;suffix_cache);  
                if (suffix == <span class="class">NULL</span>) {  
                    <span class="class">STATS_LOCK</span>();  
                    stats.malloc_fails++;  
                    <span class="class">STATS_UNLOCK</span>();  
                    out_of_memory(c,  
                            &amp;quot;<span class="class">SERVER_ERROR</span> out of memory making <span class="class">CAS</span> suffix&amp;quot;);  
                    item_remove(it);  
                    while (i-- &amp;gt; <span class="number">0</span>) {  
                        item_remove(*(c-&amp;gt;ilist + i));  
                    }  
                    return;  
                }  
                *(c-&amp;gt;suffixlist + i) = suffix;  
                int suffix_len = snprintf(suffix, <span class="class">SUFFIX_SIZE</span>, &amp;quot; %llu\r\n&amp;quot;,  
                        (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
                if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_suffix</span>(it), it-&amp;gt;nsuffix - <span class="number">2</span>) != <span class="number">0</span>  
                        || add_iov(c, suffix, suffix_len) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                    item_remove(it);  
                    break;  
                }  
            } else {  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                        it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
                //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>;get userId  
                //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;  
                //<span class="class">VALUE</span> userId <span class="number">0</span> <span class="number">5</span>  
                //<span class="number">55555</span>  
                //<span class="class">END</span>  
                if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                        || add_iov(c, <span class="class">ITEM_suffix</span>(it),  
                                it-&amp;gt;nsuffix + it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                    item_remove(it);  
                    break;  
                }  
            }  
            if (settings.verbose &amp;gt; <span class="number">1</span>) {  
                int ii;  
                fprintf(stderr, &amp;quot;&amp;gt;%d sending key &amp;quot;, c-&amp;gt;sfd);  
                for (ii = <span class="number">0</span>; ii &amp;lt; it-&amp;gt;nkey; ++ii) {  
                    fprintf(stderr, &amp;quot;%c&amp;quot;, key[ii]);  
                }  
                fprintf(stderr, &amp;quot;\n&amp;quot;);  
            }  
            /* item_get() has incremented it-&amp;gt;refcount for us */  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].get_hits++;  
            c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            item_update(it);  
            *(c-&amp;gt;ilist + i) = it;  
            i++;  
        } else {  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.get_misses++;  
            c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, key, nkey, -<span class="number">1</span>, <span class="number">0</span>);  
        }  
        key_token++;  
    }  
    /* 
     * <span class="class">If</span> the command string hasn&amp;apos;t been fully processed, get the next set 
     * of tokens. 
     */  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;get&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    if (key_token-&amp;gt;value != <span class="class">NULL</span>) {  
        ntokens = tokenize_command(key_token-&amp;gt;value, tokens, <span class="class">MAX_TOKENS</span>);  
        key_token = tokens;  
    }  
} while (key_token-&amp;gt;value != <span class="class">NULL</span>);  
c-&amp;gt;icurr = c-&amp;gt;ilist;  
c-&amp;gt;ileft = i;  
if (return_cas) {  
    c-&amp;gt;suffixcurr = c-&amp;gt;suffixlist;  
    c-&amp;gt;suffixleft = i;  
}  
if (settings.verbose &amp;gt; <span class="number">1</span>)  
    fprintf(stderr, &amp;quot;&amp;gt;%d <span class="class">END</span>\n&amp;quot;, c-&amp;gt;sfd);  
/* 
 <span class="class">If</span> the loop was terminated because of out-of-memory, it is not 
 reliable to add <span class="class">END</span>\r\n to the buffer, because it might not end 
 in \r\n. <span class="class">So</span> we send <span class="class">SERVER_ERROR</span> instead. 
 */  
//&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x675F</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;  
if (key_token-&amp;gt;value != <span class="class">NULL</span> || add_iov(c, &amp;quot;<span class="class">END</span>\r\n&amp;quot;, <span class="number">5</span>) != <span class="number">0</span>  
        || (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>)) {  
    out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory writing get response&amp;quot;);  
} else {  
    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x3002</span>;  
    conn_set_state(c, conn_mwrite);  
    c-&amp;gt;msgcurr = <span class="number">0</span>;  
}  
</code></pre><p> }</p>
</li>
</ol>
<p>Memcached&#x7684;&#x67E5;&#x8BE2;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;HashTable&#x6765;&#x67E5;&#x8BE2;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x3002;</p>
<p>HashTable&#x6211;&#x4EEC;&#x5728;&#x4E0A;&#x4E00;&#x7AE0;&#x5DF2;&#x7ECF;&#x8BB2;&#x8FC7;&#x3002;&#x524D;&#x9762;&#x4E5F;&#x8BB2;&#x8FC7;&#xFF0C;&#x5F53;&#x7F13;&#x5B58;&#x6570;&#x636E;SET&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#xFF0C;Memcached&#x4F1A;&#x5C06;item&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5173;&#x8054;&#x5230;HashTable&#x548C;&#x5B83;&#x7684;LRU&#x7684;&#x94FE;&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;item_*&amp;<span class="symbol">#x7CFB</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x6838</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53E3</span>;  
item *item_get(const char *key, const size_t nkey) {  
    item *it;  
    uint32_t hv;  
    hv = hash(key, nkey); //&amp;<span class="symbol">#x5BF9</span>;key&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;hash,&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;uint32_t&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
    item_lock(hv); //&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4ED6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6027</span>;  
    it = do_item_get(key, nkey, hv);  
    item_unlock(hv);  
    return it;  
}
</code></pre><p>&#x8FD9;&#x8FB9;&#x7740;&#x91CD;&#x770B;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;&#x4ECE;HashTable&#x4E0A;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;Item&#x5730;&#x5740;&#x503C;&#x3002;</p>
<pre><code><span class="comment">/** wrapper around assoc_find which does the lazy expiration logic */</span>  
<span class="keyword">item</span> *do_item_get(const <span class="keyword">char</span> *key, const size_t nkey, const uint32_t hv) {  
   <span class="comment"> //mutex_lock(&amp;amp;cache_lock);  </span>
   <span class="comment"> //&amp;#x5728;HashTable&amp;#x4E0A;&amp;#x627E;Item  </span>
    <span class="keyword">item</span> *<span class="keyword">it</span> = assoc_find(key, nkey, hv);  
    <span class="keyword">if</span> (<span class="keyword">it</span> != <span class="constant">NULL</span>) {  
        refcount_incr(&amp;amp;<span class="keyword">it</span>-&amp;gt;refcount);  
        <span class="comment">/* Optimization for slab reassignment. prevents popular items from 
         * jamming in busy wait. Can only do this here to satisfy lock order 
         * of item_lock, cache_lock, slabs_lock. */</span>  
        <span class="keyword">if</span> (slab_rebalance_signal &amp;amp;&amp;amp;  
            ((void *)<span class="keyword">it</span> &amp;gt;= slab_rebal.slab_start &amp;amp;&amp;amp; (void *)<span class="keyword">it</span> &amp;lt; slab_rebal.slab_end)) {  
            do_item_unlink_nolock(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
        }  
    }  
   <span class="comment"> //mutex_unlock(&amp;amp;cache_lock);  </span>
    int was_found = <span class="number">0</span>;  
    <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">2</span>) {  
        int ii;  
        <span class="keyword">if</span> (<span class="keyword">it</span> == <span class="constant">NULL</span>) {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;&amp;gt; NOT FOUND &amp;quot;);  
        } <span class="keyword">else</span> {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;&amp;gt; FOUND KEY &amp;quot;);  
            was_found++;  
        }  
        <span class="keyword">for</span> (ii = <span class="number">0</span>; ii &amp;lt; nkey; ++ii) {  
            fprintf(<span class="keyword">stderr</span>, &amp;quot;%c&amp;quot;, key[ii]);  
        }  
    }  
    <span class="keyword">if</span> (<span class="keyword">it</span> != <span class="constant">NULL</span>) {  
        <span class="keyword">if</span> (settings.oldest_live != <span class="number">0</span> &amp;amp;&amp;amp; settings.oldest_live &amp;lt;= current_time &amp;amp;&amp;amp;  
            <span class="keyword">it</span>-&amp;gt;<span class="built_in">time</span> &amp;lt;= settings.oldest_live) {  
            do_item_unlink(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
            <span class="keyword">if</span> (was_found) {  
                fprintf(<span class="keyword">stderr</span>, &amp;quot; -nuked <span class="keyword">by</span> flush&amp;quot;);  
            }  
       <span class="comment"> //&amp;#x68C0;&amp;#x67E5;&amp;#x662F;&amp;#x5426;&amp;#x8FC7;&amp;#x671F;  </span>
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">it</span>-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; <span class="keyword">it</span>-&amp;gt;exptime &amp;lt;= current_time) {  
            do_item_unlink(<span class="keyword">it</span>, hv);  
            do_item_remove(<span class="keyword">it</span>);  
            <span class="keyword">it</span> = <span class="constant">NULL</span>;  
            <span class="keyword">if</span> (was_found) {  
                fprintf(<span class="keyword">stderr</span>, &amp;quot; -nuked <span class="keyword">by</span> expire&amp;quot;);  
            }  
        } <span class="keyword">else</span> {  
            <span class="keyword">it</span>-&amp;gt;it_flags |= ITEM_FETCHED;  
            DEBUG_REFCNT(<span class="keyword">it</span>, &amp;apos;+&amp;apos;);  
        }  
    }  
    <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">2</span>)  
        fprintf(<span class="keyword">stderr</span>, &amp;quot;\n&amp;quot;);  
    <span class="constant">return</span> <span class="keyword">it</span>;  
}
</code></pre><p>&#x5220;&#x9664; delete &#x64CD;&#x4F5C;</p>
<p>&#x5220;&#x9664;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x770B;process_delete_command&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li><p>&#x5148;&#x67E5;&#x8BE2;item&#x662F;&#x5426;&#x5B58;&#x5728;</p>
</li>
<li><p>&#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#x5220;&#x9664;item&#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;NOT FOUND</p>
<p> static void process_delete_command(conn <em>c, token_t </em>tokens,  </p>
<pre><code>    const size_t ntokens) {  
char *key;  
size_t nkey;  
item *it;  
assert(c != <span class="class">NULL</span>);  
//&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6027</span>;  
if (ntokens &amp;gt; <span class="number">3</span>) {  
    bool hold_is_zero = strcmp(tokens[<span class="class">KEY_TOKEN</span> + <span class="number">1</span>].value, &amp;quot;<span class="number">0</span>&amp;quot;) == <span class="number">0</span>;  
    bool sets_noreply = set_noreply_maybe(c, tokens, ntokens);  
    bool valid = (ntokens == <span class="number">4</span> &amp;amp;&amp;amp; (hold_is_zero || sets_noreply))  
            || (ntokens == <span class="number">5</span> &amp;amp;&amp;amp; hold_is_zero &amp;amp;&amp;amp; sets_noreply);  
    if (!valid) {  
        out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format.  &amp;quot;  
                &amp;quot;<span class="class">Usage</span>: delete &amp;lt;key&amp;gt; [noreply]&amp;quot;);  
        return;  
    }  
}  
//&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
key = tokens[<span class="class">KEY_TOKEN</span>].value;  
nkey = tokens[<span class="class">KEY_TOKEN</span>].length;  
if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
    out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
    return;  
}  
if (settings.detail_enabled) {  
    stats_prefix_record_delete(key, nkey);  
}  
//&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NOT</span> <span class="class">FOUND</span>  
it = item_get(key, nkey);  
if (it) {  
    <span class="class">MEMCACHED_COMMAND_DELETE</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey);  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].delete_hits++;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;<span class="class">Item</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;<span class="class">Item</span>  
    item_unlink(it);  
    item_remove(it); /* release our reference */  
    out_string(c, &amp;quot;<span class="class">DELETED</span>&amp;quot;);  
} else {  
    //&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;  
    pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    c-&amp;gt;thread-&amp;gt;stats.delete_misses++;  
    pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
    out_string(c, &amp;quot;<span class="class">NOT_FOUND</span>&amp;quot;);  
}  
</code></pre><p> }</p>
</li>
</ol>
<p>item_unlink&#x548C;do_item_unlink&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4E24;&#x4E2A;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x4ECE;HashTable&#x4E0A;&#x5C06;Item&#x7684;&#x5730;&#x5740;&#x503C;&#x5220;&#x9664;</p>
</li>
<li><p>&#x4ECE;LRU&#x7684;&#x94FE;&#x8868;&#x4E0A;&#xFF0C;&#x5C06;Item&#x7684;&#x5730;&#x5740;&#x503C;&#x5220;&#x9664;&#xFF08;LRU&#x94FE;&#x8868;&#x53EA;&#x8981;&#x5904;&#x7406;&#x5934;&#x90E8;&#x548C;&#x5C3E;&#x90E8;&#x5C31;&#x884C;&#x4E86;&#xFF09;</p>
<p> //&#x4ECE;LRU&#x548C;HashTable&#x89E3;&#x7ED1;<br> void item_unlink(item *item) {  </p>
<pre><code>uint32_t hv<span class="comment">;  </span>
hv = hash<span class="list">(<span class="keyword">ITEM_key</span><span class="list">(<span class="keyword">item</span>)</span>, item-&amp;gt<span class="comment">;nkey);  </span>
item_lock<span class="list">(<span class="keyword">hv</span>)</span><span class="comment">;  </span>
do_item_unlink<span class="list">(<span class="keyword">item</span>, hv)</span><span class="comment">;  </span>
item_unlock<span class="list">(<span class="keyword">hv</span>)</span><span class="comment">;  </span></span>
</code></pre><p> }</p>
</li>
</ol>
<p>item_remove&#x4E3B;&#x8981;&#x662F;&#x91CA;&#x653E;item</p>
<pre><code><span class="comment">//&amp;#x5220;&amp;#x9664;Item  </span>
void item_remove<span class="params">(item *item)</span> {  
    uint32_t hv;  
    hv = hash<span class="params">(ITEM_key<span class="params">(item)</span>, item-&amp;gt;nkey)</span>; <span class="comment">//Hash&amp;#x503C;  </span>

    item_lock<span class="params">(hv)</span>;  
    do_item_remove<span class="params">(item)</span>;  
    item_unlock<span class="params">(hv)</span>;  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23ed2e8/" title="Linux c 开发 - Memcached源码分析之LRU算法（6） -" itemprop="url">Linux c 开发 - Memcached源码分析之LRU算法（6） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:38.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x524D;&#x8A00;</p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#xFF08;5&#xFF09; &#x300B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8BB2;&#x5230;&#x4E86;SET&#x547D;&#x4EE4;&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x5411;Memcached&#x670D;&#x52A1;&#x7AEF;SET&#x4E00;&#x6761;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5C06;&#x751F;&#x6210;&#x7684;Item&#x5730;&#x5740;&#x6302;&#x5230;LRU&#x7684;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x4E0A;&#x3002;&#x8FD9;&#x4E00;&#x7AE0;&#x8282;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x8BB2;&#x4E00;&#x4E0B;Memcached&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528;LRU&#x7B97;&#x6CD5;&#x7684;&#x3002;</p>
<p>LRU&#xFF1A;&#x662F;Least Recently Used &#x8FD1;&#x671F;&#x6700;&#x5C11;&#x4F7F;&#x7528;&#x7B97;&#x6CD5;&#x3002;</p>
<p>Memcached&#x7684;LRU&#x7B97;&#x6CD5;&#x5206;&#x6790;</p>
<p>Memcached&#x7684;LRU&#x51E0;&#x79CD;&#x7B56;&#x7565;</p>
<ol>
<li><p>&#x60F0;&#x6027;&#x5220;&#x9664;&#x3002;memcached&#x4E00;&#x822C;&#x4E0D;&#x4F1A;&#x4E3B;&#x52A8;&#x53BB;&#x6E05;&#x9664;&#x5DF2;&#x7ECF;&#x8FC7;&#x671F;&#x6216;&#x8005;&#x5931;&#x6548;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x5F53;get&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;item&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;item&#x662F;&#x5426;&#x5931;&#x6548;&#x3002;</p>
</li>
<li><p>flush&#x547D;&#x4EE4;&#x3002;flush&#x547D;&#x4EE4;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x7684;item&#x8BBE;&#x7F6E;&#x4E3A;&#x5931;&#x6548;&#x3002;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x68C0;&#x67E5;&#x3002;Memcached&#x4F1A;&#x5728;&#x521B;&#x5EFA;ITEM&#x7684;&#x65F6;&#x5019;&#x53BB;LRU&#x7684;&#x94FE;&#x8868;&#x5C3E;&#x90E8;&#x5F00;&#x59CB;&#x68C0;&#x67E5;&#xFF0C;&#x662F;&#x5426;&#x6709;&#x5931;&#x6548;&#x7684;ITEM&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7684;&#x8BDD;&#x5C31;&#x91CD;&#x65B0;&#x521B;&#x5EFA;&#x3002;</p>
</li>
<li><p>LRU&#x722C;&#x866B;&#x3002;memcached&#x9ED8;&#x8BA4;&#x662F;&#x5173;&#x95ED;LRU&#x722C;&#x866B;&#x7684;&#x3002;LRU&#x722C;&#x866B;&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x4F1A;&#x53BB;&#x6E05;&#x7406;&#x5931;&#x6548;&#x7684;ITEM&#x3002;</p>
</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/23e8257.jpg" alt=""></p>
<p>LRU&#x7684;&#x57FA;&#x672C;&#x64CD;&#x4F5C;&#x548C;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<p>Mecached&#x7684;LRU&#x7684;&#x94FE;&#x8868;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x5728;item.c&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E0A;&#x7684;&#x3002;&#x5176;&#x4E2D;&#x6570;&#x7EC4;heads&#x548C;tails&#x5206;&#x522B;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x7684;LRU&#x7684;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7684;&#x5934;&#x5730;&#x5740;&#x548C;&#x5C3E;&#x90E8;&#x5730;&#x5740;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;slabs class&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;&#x53CC;&#x5411;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x3002;&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x901A;&#x8FC7;item&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x4E24;&#x4E2A;&#x6307;&#x9488;&#x5730;&#x5740;&#x6765;&#x8BB0;&#x5F55;item&#x5728;&#x94FE;&#x8868;&#x4E0A;&#x5DE6;&#x53F3;&#x4E24;&#x8FB9;&#x4F4D;&#x7F6E;&#x7684;item&#x5730;&#x5740;&#x503C;&#x3002;</p>
<pre><code>//item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
typedef struct _stritem {  
    //&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x53CC</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *next;  //&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x53CC</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    struct _stritem *prev;  //&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    //....more code  
} item;


static item *heads[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
static item *tails[<span class="class">LARGEST_ID</span>]; //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;
</code></pre><p>item_link_q&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x4E00;&#x4E2A;item&#x6DFB;&#x52A0;&#x5230;LRU&#x94FE;&#x8868;&#x4E0A;&#x9762;&#xFF1A;</p>
<pre><code>//&amp;<span class="comment">#x4ECE;LRU&amp;#x94FE;&amp;#x8868;&amp;#x4E0A;&amp;#x65B0;&amp;#x589E;&amp;#x4E00;&amp;#x4E2A;Item  </span>
//LRU&amp;<span class="comment">#x94FE;&amp;#x8868;&amp;#x662F;&amp;#x4E00;&amp;#x4E2A;&amp;#x53CC;&amp;#x5411;&amp;#x94FE;&amp;#x8868;&amp;#x7ED3;&amp;#x6784;  </span>
static void item_link_<span class="string">q(item *it)</span> { <span class="regexp">/* item is the new head */</span>  
    item **head, **tail;  
    assert(it-&amp;<span class="keyword">gt</span>;slabs_clsid &amp;<span class="keyword">lt</span>; LARGEST_ID);  
    assert((it-&amp;<span class="keyword">gt</span>;it_flags &amp;amp; ITEM_SLABBED) == <span class="number">0</span>);  

    head = &amp;amp;heads[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    tail = &amp;amp;tails[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    assert(it != *head);  
    assert((*head &amp;amp;&amp;amp; *tail) || (*head == <span class="number">0</span> &amp;amp;&amp;amp; *tail == <span class="number">0</span>));  
    it-&amp;<span class="keyword">gt</span>;prev = <span class="number">0</span>;  
    it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> = *head;  
    <span class="keyword">if</span> (it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>) it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>-&amp;<span class="keyword">gt</span>;prev = it;  
    *head = it;  
    <span class="keyword">if</span> (*tail == <span class="number">0</span>) *tail = it;  
    sizes[it-&amp;<span class="keyword">gt</span>;slabs_clsid]++;  
    <span class="keyword">return</span>;  
}
</code></pre><p>item_unlink_q&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x4E00;&#x4E2A;item&#x4ECE;LRU&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x89E3;&#x9664;&#xFF1A;</p>
<pre><code>//&amp;<span class="comment">#x4ECE;LRU&amp;#x94FE;&amp;#x8868;&amp;#x4E0A;&amp;#x89E3;&amp;#x9664;Item  </span>
static void item_unlink_<span class="string">q(item *it)</span> {  
    item **head, **tail;  
    assert(it-&amp;<span class="keyword">gt</span>;slabs_clsid &amp;<span class="keyword">lt</span>; LARGEST_ID);  
    head = &amp;amp;heads[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    tail = &amp;amp;tails[it-&amp;<span class="keyword">gt</span>;slabs_clsid];  
    <span class="keyword">if</span> (*head == it) {  
        assert(it-&amp;<span class="keyword">gt</span>;prev == <span class="number">0</span>);  
        *head = it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>;  
    }  
    <span class="keyword">if</span> (*tail == it) {  
        assert(it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> == <span class="number">0</span>);  
        *tail = it-&amp;<span class="keyword">gt</span>;prev;  
    }  
    assert(it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> != it);  
    assert(it-&amp;<span class="keyword">gt</span>;prev != it);  
    <span class="keyword">if</span> (it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>) it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>-&amp;<span class="keyword">gt</span>;prev = it-&amp;<span class="keyword">gt</span>;prev;  
    <span class="keyword">if</span> (it-&amp;<span class="keyword">gt</span>;prev) it-&amp;<span class="keyword">gt</span>;prev-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span> = it-&amp;<span class="keyword">gt</span>;<span class="keyword">next</span>;  
    sizes[it-&amp;<span class="keyword">gt</span>;slabs_clsid]--;  
    <span class="keyword">return</span>;  
}
</code></pre><p>&#x7B56;&#x7565;1 - &#x60F0;&#x6027;&#x5220;&#x9664;</p>
<p>Memcached&#x7684;&#x7F13;&#x5B58;&#x6E05;&#x9664;&#x7B56;&#x7565;&#x662F;&#x60F0;&#x6027;&#x7684;&#x3002;&#x8FD9;&#x4E2A;&#x5982;&#x4F55;&#x6765;&#x7406;&#x89E3;&#xFF1F;&#x5F53;&#x7528;&#x6237;&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x7F13;&#x5B58;&#x6709;&#x6548;&#x671F;&#x4E3A;5&#x5206;&#x949F;&#x3002;&#x5F53;5&#x5206;&#x949F;&#x65F6;&#x95F4;&#x8FC7;&#x540E;&#xFF0C;&#x7F13;&#x5B58;&#x5931;&#x6548;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;Memcached&#x5E76;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x53BB;&#x68C0;&#x67E5;&#x5F53;&#x524D;&#x7684;Item&#x662F;&#x5426;&#x8FC7;&#x671F;&#x3002;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x518D;&#x6B21;&#x6765;&#x8BF7;&#x6C42;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;&#x7F13;&#x5B58;&#x662F;&#x5426;&#x5931;&#x6548;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x5931;&#x6548;&#x5219;&#x4F1A;&#x53BB;&#x6E05;&#x9664;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x3002;</p>
<p>&#x770B;&#x4E00;&#x4E0B;do_item_get&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5224;&#x65AD;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x662F;&#x5426;&#x5931;&#x6548;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code>/** wrapper around assoc_find which does the lazy expiration logic */  
item *do_item_get(const char *key, const size_t nkey, const uint32_t hv) {  
//...code  
    if (it != <span class="class">NULL</span>) {  
        //settings.oldest_live&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
        //it-&amp;gt;time&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;item&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;set/add/replce&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF08</span>;get&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x53D8</span>;&amp;<span class="symbol">#xFF09</span>;  
        //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;it-&amp;gt;time&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x8BE5</span>;item&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;  
        if (settings.oldest_live != <span class="number">0</span> &amp;amp;&amp;amp; settings.oldest_live &amp;lt;= current_time &amp;amp;&amp;amp;  
            it-&amp;gt;time &amp;lt;= settings.oldest_live) {  
            //<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x7ED1</span>;&amp;<span class="symbol">#x5B9A</span>;  
            do_item_unlink(it, hv);  
            //&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8BE5</span>;<span class="class">Item</span>  
            do_item_remove(it);  
            it = <span class="class">NULL</span>; //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NULL</span>  
            if (was_found) {  
                fprintf(stderr, &amp;quot; -nuked by flush&amp;quot;);  
            }  
        //&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6E05</span>;&amp;<span class="symbol">#x9664</span>;  
        } else if (it-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; it-&amp;gt;exptime &amp;lt;= current_time) {  
            //<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;<span class="class">HASHTABLE</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x7ED1</span>;&amp;<span class="symbol">#x5B9A</span>;  
            do_item_unlink(it, hv);  
            //&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x8BE5</span>;<span class="class">Item</span>  
            do_item_remove(it);  
            it = <span class="class">NULL</span>;  
            if (was_found) {  
                fprintf(stderr, &amp;quot; -nuked by expire&amp;quot;);  
            }  
        } else {  
            it-&amp;gt;it_flags |= <span class="class">ITEM_FETCHED</span>;  
            <span class="class">DEBUG_REFCNT</span>(it, &amp;apos;+&amp;apos;);  
        }  
    }  
//...code  
}
</code></pre><p>&#x7B56;&#x7565;2 - flush&#x547D;&#x4EE4;</p>
<p>&#x5F53;&#x7528;&#x6237;&#x53D1;&#x9001;&#x4E00;&#x4E2A;flush&#x547D;&#x4EE4;&#x7684;&#x65F6;&#x5019;&#xFF0C;Memcached&#x4F1A;&#x5C06;&#x547D;&#x4EE4;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x7684;&#x7F13;&#x5B58;&#x90FD;&#x8BBE;&#x7F6E;&#x4E3A;&#x5931;&#x6548;&#x3002;</p>
<p>Memcached&#x4E0D;&#x4F1A;&#x4E3B;&#x52A8;&#x53BB;&#x6E05;&#x9664;&#x8FD9;&#x4E9B;item&#x3002;&#x4E3B;&#x8981;&#x901A;&#x8FC7;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</p>
<ol>
<li>do_item_flush_expired&#x65B9;&#x6CD5;&#x3002;</li>
</ol>
<p>Memcached&#x4F1A;&#x5728;&#x63A5;&#x53D7;&#x5230;flush&#x547D;&#x4EE4;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C06;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x53C2;&#x6570;settings.oldest_live =current_time - 1&#x3002;&#x7136;&#x540E;&#x53BB;&#x8C03;&#x7528;item_flush_expired&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x56E0;&#x4E3A;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x53C2;&#x6570;item_flush_expired&#x5230;&#x8C03;&#x7528;&#x7F13;&#x5B58;&#x9501;&#x65B9;&#x6CD5;&#x4E4B;&#x95F4;&#x4F1A;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x5DEE;&#xFF0C;&#x6709;&#x53EF;&#x80FD;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F1A;&#x6709;&#x65B0;&#x7684;item&#x5728;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x7136;&#x540E;Memcached&#x8C03;&#x7528;do_item_flush_expired&#x65B9;&#x6CD5;&#xFF0C;&#x53BB;&#x904D;&#x5386;&#x6240;&#x6709;&#x7684;LRU&#x94FE;&#x8868;&#x3002;do_item_flush_expired&#x4E0D;&#x4F1A;&#x5C06;&#x6BCF;&#x4E00;&#x4E2A;&#x5728;flush&#x547D;&#x4EE4;&#x524D;&#x7684;Item&#x5220;&#x9664;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x6837;&#x4F1A;&#x975E;&#x5E38;&#x8017;&#x65F6;&#xFF0C;&#x800C;&#x662F;&#x5220;&#x9664;&#x5728;&#x8BBE;&#x7F6E;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x5230;&#x52A0;&#x4E0A;&#x7F13;&#x5B58;&#x9501;&#x8FD9;&#x4E4B;&#x95F4;&#x64CD;&#x4F5C;&#x7684;item&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x52A0;&#x5FEB;flush&#x7684;&#x901F;&#x5EA6;&#x3002;</p>
<ol>
<li>&#x60F0;&#x6027;&#x5220;&#x9664;&#x65B9;&#x6CD5;&#x3002;</li>
</ol>
<p>Memcached&#x4F1A;&#x5728;get&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x53BB;&#x5224;&#x65AD;it-&gt;time&#x662F;&#x5426;&#x5C0F;&#x4E8E;settings.oldest_live&#xFF0C;&#x5982;&#x679C;&#x5C0F;&#x4E8E;&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;item&#x5C31;&#x662F;&#x8FC7;&#x671F;&#x7684;&#x3002;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x60F0;&#x6027;&#x5220;&#x9664;&#x5927;&#x6279;&#x91CF;&#x7684;item&#x6570;&#x636E;&#x3002;</p>
<pre><code><span class="xml">/* 
 * Flushes expired items after a flush_all call 
 */  
void item_flush_expired() </span><span class="expression">{  
    <span class="variable">mutex</span>_<span class="variable">lock</span>(&amp;<span class="variable">amp</span>;<span class="variable">cache</span>_<span class="variable">lock</span>);  
    <span class="variable">do</span>_<span class="variable">item</span>_<span class="variable">flush</span>_<span class="variable">expired</span>();  
    <span class="variable">mutex</span>_<span class="variable">unlock</span>(&amp;<span class="variable">amp</span>;<span class="variable">cache</span>_<span class="variable">lock</span>);  
}</span><span class="xml">


/* expires items that are more recent than the oldest_live setting. */  
void do_item_flush_expired(void) </span><span class="expression">{  
    <span class="variable">int</span> <span class="variable">i</span>;  
    <span class="variable">item</span> *<span class="variable">iter</span>, *<span class="variable">next</span>;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.oldest</span>_<span class="variable">live</span> == 0)  
        <span class="variable">return</span>;  
    <span class="variable">for</span> (<span class="variable">i</span> = 0; <span class="variable">i</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">LARGEST</span>_<span class="variable">ID</span>; <span class="variable">i</span>++) {  
        /* <span class="variable">The</span> <span class="variable">LRU</span> <span class="variable">is</span> <span class="variable">sorted</span> <span class="variable">in</span> <span class="variable">decreasing</span> <span class="variable">time</span> <span class="variable">order</span>, <span class="variable">and</span> <span class="variable">an</span> <span class="variable">item</span>&amp;<span class="variable">apos</span>;<span class="variable">s</span> <span class="variable">timestamp</span> 
         * <span class="variable">is</span> <span class="variable">never</span> <span class="variable">newer</span> <span class="variable">than</span> <span class="variable">its</span> <span class="variable">last</span> <span class="variable">access</span> <span class="variable">time</span>, <span class="variable">so</span> <span class="variable">we</span> <span class="variable">only</span> <span class="variable">need</span> <span class="variable">to</span> <span class="variable">walk</span> 
         * <span class="variable">back</span> <span class="variable">until</span> <span class="variable">we</span> <span class="variable">hit</span> <span class="variable">an</span> <span class="variable">item</span> <span class="variable">older</span> <span class="variable">than</span> <span class="variable">the</span> <span class="variable">oldest</span>_<span class="variable">live</span> <span class="variable">time.</span> 
         * <span class="variable">The</span> <span class="variable">oldest</span>_<span class="variable">live</span> <span class="variable">checking</span> <span class="variable">will</span> <span class="variable">auto-expire</span> <span class="variable">the</span> <span class="variable">remaining</span> <span class="variable">items.</span> 
         *<span class="end-block">/  </span>
        <span class="variable">for</span> (<span class="variable">iter</span> = <span class="variable">heads</span>[<span class="variable">i</span>]; <span class="variable">iter</span> != <span class="variable">NULL</span>; <span class="variable">iter</span> = <span class="variable">next</span>) {  
            /* <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> <span class="variable">of</span> 0 <span class="variable">are</span> <span class="variable">magic</span> <span class="variable">objects.</span> *<span class="end-block">/  </span>
            /<span class="end-block">/iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>1;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;  
            //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">settings.oldest</span>_<span class="variable">live</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">F</span>;  
            //&amp;<span class="begin-block">#x</span>56<span class="variable">E</span>0;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">do</span>_<span class="variable">item</span>_<span class="variable">flush</span>_<span class="variable">expired</span>&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>2;&amp;<span class="begin-block">#x</span>7<span class="variable">ECF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;<span class="variable">cache</span>&amp;<span class="begin-block">#x</span>9501;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;<span class="variable">worker</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7684;  
            //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>904<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5386;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">Item</span>&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">BB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>904<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5386;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>975<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>38;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>13;&amp;<span class="begin-block">#x</span>6162;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">BFC</span>;&amp;<span class="begin-block">#x</span>81<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>5<span class="variable">BA</span>2;&amp;<span class="begin-block">#x</span>6237;&amp;<span class="begin-block">#x</span>7<span class="variable">AEF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>85;&amp;<span class="begin-block">#x</span>3002;  
            /<span class="end-block">/  </span>
            /<span class="end-block">/Memcached</span>&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>60<span class="variable">F</span>3;&amp;<span class="begin-block">#x</span>51<span class="variable">FA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>806<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>660<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>529<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;<span class="variable">settings.oldest</span>_<span class="variable">live</span>&amp;<span class="begin-block">#x</span>5230;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9501;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>4<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>8;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;&amp;<span class="begin-block">#x</span>5<span class="variable">BA</span>2;&amp;<span class="begin-block">#x</span>6237;&amp;<span class="begin-block">#x</span>7<span class="variable">AEF</span>;  
            //&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>48;<span class="variable">Memcache</span>&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>90<span class="variable">E</span>8;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5148;&amp;<span class="begin-block">#x</span>6<span class="variable">E</span>05;&amp;<span class="begin-block">#x</span>7406;&amp;<span class="begin-block">#xFF</span>08;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>90<span class="variable">E</span>8;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>975<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>38;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>11;&amp;<span class="begin-block">#x</span>91<span class="variable">CF</span>;&amp;<span class="begin-block">#xFF</span>09;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>6837;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>31;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">FEB</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>901<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;  
            //&amp;<span class="begin-block">#x</span>800<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5269;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>59;<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">settings.oldest</span>_<span class="variable">live</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>6279;&amp;<span class="begin-block">#x</span>91<span class="variable">CF</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>60<span class="variable">F</span>0;&amp;<span class="begin-block">#x</span>6027;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>0<span class="variable">F</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5728;<span class="variable">get</span>&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>42;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">BB</span>;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;  
            <span class="variable"><span class="keyword">if</span></span> (<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> != 0 &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">time</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">settings.oldest</span>_<span class="variable">live</span>) {  
                <span class="variable">next</span> = <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>;  
                <span class="variable"><span class="keyword">if</span></span> ((<span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> &amp;<span class="variable">amp</span>; <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>) == 0) {  
                    <span class="variable">do</span>_<span class="variable">item</span>_<span class="variable">unlink</span>_<span class="variable">nolock</span>(<span class="variable">iter</span>, <span class="variable">hash</span>(<span class="variable">ITEM</span>_<span class="variable">key</span>(<span class="variable">iter</span>), <span class="variable">iter-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">nkey</span>));  
                }</span><span class="xml">  
            } else </span><span class="expression">{  
                /* <span class="variable">We</span>&amp;<span class="variable">apos</span>;<span class="variable">ve</span> <span class="variable">hit</span> <span class="variable">the</span> <span class="variable">first</span> <span class="variable">old</span> <span class="variable">item.</span> <span class="variable">Continue</span> <span class="variable">to</span> <span class="variable">the</span> <span class="variable">next</span> <span class="variable">queue.</span> *<span class="end-block">/  </span>
                <span class="variable">break</span>;  
            }</span><span class="xml">  
        }  
    }  
}</span>
</code></pre><p>&#x7B56;&#x7565;3 - &#x5206;&#x914D;Item&#x7684;&#x65F6;&#x5019;&#x53BB;&#x68C0;&#x67E5;</p>
<p>Memcached&#x5728;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Item&#x3002;&#xFF08;&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x6709;&#x70B9;&#x7ED5;&#xFF0C;&#x9700;&#x8981;&#x770B;N&#x904D;&#xFF0C;&#x624D;&#x80FD;&#x660E;&#x767D;&#xFF09;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x5148;&#x68C0;&#x67E5;&#x7F13;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#x3002;&#x524D;&#x51E0;&#x7AE0;&#x6211;&#x4EEC;&#x8BB2;&#x5230;&#xFF0C;memcached&#x7684;&#x547D;&#x4EE4;&#x4E2D;&#x4F1A;&#x5C06;key&#x7684;&#x957F;&#x5EA6;&#x548C;value&#x7684;&#x957F;&#x5EA6;&#x5E26;&#x4E0A;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x8BA1;&#x7B97;&#x51FA;item&#x603B;&#x7684;&#x5360;&#x7528;&#x7A7A;&#x95F4;&#x7684;&#x5927;&#x5C0F;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;&#x7F13;&#x5B58;item&#x7684;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x627E;&#x5230;slabs class&#x548C;slabs class&#x7684;LRU&#x53CC;&#x5411;&#x94FE;&#x8868;&#x3002;</p>
</li>
<li><p>&#x5F00;&#x59CB;&#x5C1D;&#x8BD5;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x5C1D;&#x8BD5;&#x6B21;&#x6570;&#x4E3A;5&#x6B21;&#x3002;</p>
</li>
<li><p>&#x5C1D;&#x8BD5;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F1A;&#x4ECE;LRU&#x94FE;&#x8868;&#x7684;&#x5C3E;&#x90E8;&#x5F00;&#x59CB;&#x641C;&#x7D22;&#xFF0C;&#x68C0;&#x67E5;ITEM&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;item&#x5185;&#x5BB9;&#x4E3A;&#x7A7A;&#x6216;&#x8005;item&#x88AB;&#x5176;&#x5B83;worker&#x5F15;&#x7528;&#x9501;&#x5B9A;&#x7B49;&#x60C5;&#x51B5;&#xFF0C;&#x5219;&#x7EE7;&#x7EED;&#x5F80;LRU&#x5217;&#x8868;&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x5C1D;&#x8BD5;&#x4E86;5&#x6B21;&#xFF0C;&#x4ECE;LRU&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x90FD;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x7B26;&#xFFFD;&#xFFFD;&#xFFFD;&#x9884;&#x671F;&#x7684;ITEM&#xFF0C;&#x5219;&#x4F1A;slabs_alloc&#x65B9;&#x6CD5;&#xFF0C;&#x7533;&#x8BF7;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5185;&#x5B58;&#x5757;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x4ECE;LRU&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x627E;&#x5230;&#x7B26;&#x5408;&#x9884;&#x671F;&#x7684;ITEM&#xFF08;&#x6CA1;&#x6709;&#x9501;&#x5B9A;&#x548C;&#x6709;&#x6570;&#x636E;&#xFF09;&#xFF0C;&#x9996;&#x5148;&#x4F1A;&#x68C0;&#x67E5;ITEM&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8FC7;&#x4E86;&#x6709;&#x6548;&#x671F;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x8FC7;&#x4E86;&#x6709;&#x6548;&#x671F;&#xFF0C;&#x5219;&#x5C06;&#x8FD9;&#x4E2A;ITEM&#x6DD8;&#x6C70;&#xFF0C;&#x5360;&#x7528;&#x8BE5;ITEM&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;ITEM&#x8FD8;&#x662F;&#x6709;&#x6548;&#x7684;&#xFF0C;&#x5219;&#x4F7F;&#x7528;slabs_alloc&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;ITEM&#xFF0C;&#x5206;&#x914D;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x5C31;&#x7528;&#x6700;&#x65B0;&#x5206;&#x914D;&#x7684;ITEM</p>
</li>
<li><p>&#x5982;&#x679C;&#x4F7F;&#x7528;slabs_alloc&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;ITEM&#xFF0C;&#x5206;&#x914D;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x5F00;&#x542F;&#x4E86;&#x4E0D;&#x4F7F;&#x7528;LRU&#x5F3A;&#x5236;&#x6DD8;&#x6C70;&#xFF0C;&#x8FD4;&#x56DE;ERROR&#xFF1B;&#x5982;&#x679C;&#x5F00;&#x542F;&#x4E86;&#x5F3A;&#x5236;&#x6DD8;&#x6C70;&#xFF0C;&#x4F1A;&#x5C06;&#x5F53;&#x524D;LRU&#x94FE;&#x8868;&#x5C3E;&#x90E8;&#x641C;&#x7D22;&#x5230;&#x7684;ITEM&#x5F3A;&#x5236;&#x8FDB;&#x884C;&#x6DD8;&#x6C70;&#xFF08;&#x5982;&#x679C;ITEM&#x6709;&#x6548;&#x671F;&#x8FD8;&#x5728;&#x6216;&#x8005;&#x8BBE;&#x7F6E;&#x4E86;&#x6C38;&#x4E45;&#x7684;&#x4E5F;&#x4F1A;&#x88AB;&#x6DD8;&#x6C70;&#xFF09;</p>
<p> //&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Item<br> item <em>do_item_alloc(char </em>key, const size_t nkey, const int flags,  </p>
<pre><code>                const rel_time_t exptime, const int nbytes,  
                const uint32_t cur_hv) {  
uint8_t nsuffix;  
item *it = <span class="class">NULL</span>; //item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
char suffix[<span class="number">40</span>];  
//item_make_header &amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
size_t ntotal = item_make_header(nkey + <span class="number">1</span>, flags, nbytes, suffix, &amp;amp;nsuffix);  
if (settings.use_cas) {  
    ntotal += sizeof(uint64_t);  
}  
//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;ntotal &amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
//<span class="class">Memcached</span>&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class  
//&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs_class&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#xFF0C</span>;slabs&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;slabs&amp;<span class="symbol">#x4E0A</span>;  
//&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabs&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;chunk  
//  
//&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#xFF1A</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>; &amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">200</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5230</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x8005</span>;slabs_class&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;slabs_class&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#x7684</span>;slabs&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;item&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
//&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;id=<span class="number">1</span>&amp;<span class="symbol">#x7684</span>;slabs_class&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">224</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;slabs&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFA</span>;&amp;<span class="symbol">#x5E72</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">224</span>&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x7684</span>;chunk&amp;<span class="symbol">#x5757</span>;  
//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;chunk&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
unsigned int id = slabs_clsid(ntotal);  
if (id == <span class="number">0</span>)  
    return <span class="number">0</span>;  
mutex_lock(&amp;amp;cache_lock);  
/* do a quick check if we have any expired items in the tail.. */  
int tries = <span class="number">5</span>;  
/* <span class="class">Avoid</span> hangs if a slab has nothing but refcounted stuff in it. */  
int tries_lrutail_reflocked = <span class="number">1000</span>;  
int tried_alloc = <span class="number">0</span>;  
item *search;  
item *next_it;  
void *hold_lock = <span class="class">NULL</span>;  
rel_time_t oldest_live = settings.oldest_live;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;slabs_class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
//item&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5BFB</span>;&amp;<span class="symbol">#x627E</span>;<span class="class">LRU</span> &amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
search = tails[id];  
/* <span class="class">We</span> walk up *only* for locked items. <span class="class">Never</span> searching for expired. 
 * <span class="class">Waste</span> of <span class="class">CPU</span> for almost all deployments */  
//tries = <span class="number">5</span> &amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x5C1D</span>;&amp;<span class="symbol">#x8BD5</span>;<span class="number">5</span>&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x641C</span>;&amp;<span class="symbol">#x7D22</span>;  
//search = tails[id] &amp;<span class="symbol">#x641C</span>;&amp;<span class="symbol">#x7D22</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>; &amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;  
for (; tries &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; search != <span class="class">NULL</span>; tries--, search=next_it) {  
    /* we might relink search mid-loop, so search-&amp;gt;prev isn&amp;apos;t reliable */  
    next_it = search-&amp;gt;prev;  
    if (search-&amp;gt;nbytes == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;nkey == <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;it_flags == <span class="number">1</span>) {  
        /* <span class="class">We</span> are a crawler, ignore it. */  
        tries++;  
        continue;  
    }  
    uint32_t hv = hash(<span class="class">ITEM_key</span>(search), search-&amp;gt;nkey);  
    /* <span class="class">Attempt</span> to hash item lock the &amp;quot;search&amp;quot; item. <span class="class">If</span> locked, no 
     * other callers can incr the refcount 
     */  
    /* <span class="class">Don</span>&amp;apos;t accidentally grab ourselves, or bail if we can&amp;apos;t quicklock */  
    if (hv == cur_hv || (hold_lock = item_trylock(hv)) == <span class="class">NULL</span>)  
        continue;  
    /* <span class="class">Now</span> see if the item is refcount locked */  
    //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;search-&amp;gt;refcount&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E86</span>;refcount&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;item&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x5B83</span>;&amp;<span class="symbol">#x7684</span>;worker&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;  
    //refcount&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x52A0</span>;<span class="number">1</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;  
    if (refcount_incr(&amp;amp;search-&amp;gt;refcount) != <span class="number">2</span>) {  
        /* <span class="class">Avoid</span> pathological case with ref&amp;apos;ed items in tail */  
        do_item_update_nolock(search);  
        tries_lrutail_reflocked--;  
        tries++; //try&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;+<span class="number">1</span>  
        refcount_decr(&amp;amp;search-&amp;gt;refcount); //&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>  
        itemstats[id].lrutail_reflocked++;  
        /* <span class="class">Old</span> rare bug could cause a refcount leak. <span class="class">We</span> haven&amp;apos;t seen 
         * it in years, but we leave this code in to prevent failures 
         * just in case */  
        if (settings.tail_repair_time &amp;amp;&amp;amp;  
                search-&amp;gt;time + settings.tail_repair_time &amp;lt; current_time) {  
            itemstats[id].tailrepairs++;  
            search-&amp;gt;refcount = <span class="number">1</span>;  
            do_item_unlink_nolock(search, hv);  
        }  
        if (hold_lock)  
            item_trylock_unlock(hold_lock);  
        if (tries_lrutail_reflocked &amp;lt; <span class="number">1</span>)  
            break;  
        continue;  
    }  
    /* <span class="class">Expired</span> or flushed */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;  
    if ((search-&amp;gt;exptime != <span class="number">0</span> &amp;amp;&amp;amp; search-&amp;gt;exptime &amp;lt; current_time)  
        || (search-&amp;gt;time &amp;lt;= oldest_live &amp;amp;&amp;amp; oldest_live &amp;lt;= current_time)) {  
        itemstats[id].reclaimed++;  
        if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
            itemstats[id].expired_unfetched++;  
        }  
        it = search;  
        slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
        do_item_unlink_nolock(it, hv);  
        /* <span class="class">Iniialize</span> the item <span class="method">block:</span> */  
        it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
    //slabs_alloc&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
    } else if ((it = slabs_alloc(ntotal, id)) == <span class="class">NULL</span>) {  
        tried_alloc = <span class="number">1</span>;  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">ERROR</span>  
        if (settings.evict_to_free == <span class="number">0</span>) {  
            itemstats[id].outofmemory++;  
        } else {  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E86</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;  
            itemstats[id].evicted++;  
            itemstats[id].evicted_time = current_time - search-&amp;gt;time;  
            if (search-&amp;gt;exptime != <span class="number">0</span>)  
                itemstats[id].evicted_nonzero++;  
            if ((search-&amp;gt;it_flags &amp;amp; <span class="class">ITEM_FETCHED</span>) == <span class="number">0</span>) {  
                itemstats[id].evicted_unfetched++;  
            }  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5C06</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">ITEM</span>&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;  
            it = search;  
            //&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass_t&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
            //&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x9738</span>;&amp;<span class="symbol">#x5360</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;  
            slabs_adjust_mem_requested(it-&amp;gt;slabs_clsid, <span class="class">ITEM_ntotal</span>(it), ntotal);  
            //&amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x54C8</span>;&amp;<span class="symbol">#x5E0C</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x548C</span>;lru&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
            //it-&amp;gt;refcount&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">2</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;item&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">HashTable</span>&amp;<span class="symbol">#x548C</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x7CFB</span>;  
            do_item_unlink_nolock(it, hv);  
            /* <span class="class">Initialize</span> the item <span class="method">block:</span> */  
            it-&amp;gt;slabs_clsid = <span class="number">0</span>;  
            /* <span class="class">If</span> we&amp;apos;ve just evicted an item, and the automover is set to 
             * angry bird mode, attempt to rip memory into this slab class. 
             * <span class="class">TODO</span>: <span class="class">Move</span> valid object detection into a function, and on a 
             * &amp;quot;successful&amp;quot; memory pull, look behind and see if the next alloc 
             * would be an eviction. <span class="class">Then</span> kick off the slab mover before the 
             * eviction happens. 
             */  
            if (settings.slab_automove == <span class="number">2</span>)  
                slabs_reassign(-<span class="number">1</span>, id);  
        }  
    }  
    //&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;  
    refcount_decr(&amp;amp;search-&amp;gt;refcount);  
    /* <span class="class">If</span> hash values were equal, we don&amp;apos;t grab a second lock */  
    if (hold_lock)  
        item_trylock_unlock(hold_lock);  
    break;  
}  
/* &amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E86</span>;<span class="number">5</span>&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5C3E</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item */  
if (!tried_alloc &amp;amp;&amp;amp; (tries == <span class="number">0</span> || search == <span class="class">NULL</span>))  
    it = slabs_alloc(ntotal, id);  
if (it == <span class="class">NULL</span>) {  
    itemstats[id].outofmemory++;  
    mutex_unlock(&amp;amp;cache_lock);  
    return <span class="class">NULL</span>;  
}  
assert(it-&amp;gt;slabs_clsid == <span class="number">0</span>);  
assert(it != heads[id]);  
/* <span class="class">Item</span> initialization can happen outside of the lock; the item&amp;apos;s already 
 * been removed from the slab <span class="class">LRU</span>. 
 */  
it-&amp;gt;refcount = <span class="number">1</span>; //&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>; &amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>   /* the caller will have a reference */  
mutex_unlock(&amp;amp;cache_lock);  
it-&amp;gt;next = it-&amp;gt;prev = it-&amp;gt;h_next = <span class="number">0</span>;  
it-&amp;gt;slabs_clsid = id;  
<span class="class">DEBUG_REFCNT</span>(it, &amp;apos;*&amp;apos;);  
it-&amp;gt;it_flags = settings.use_cas ? <span class="class">ITEM_CAS</span> : <span class="number">0</span>;  
it-&amp;gt;nkey = nkey;  
it-&amp;gt;nbytes = nbytes;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;  
memcpy(<span class="class">ITEM_key</span>(it), key, nkey);  
it-&amp;gt;exptime = exptime;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;  
memcpy(<span class="class">ITEM_suffix</span>(it), suffix, (size_t)nsuffix);  
it-&amp;gt;nsuffix = nsuffix;  
return it;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7B56;&#x7565;4 - LRU&#x722C;&#x866B;</p>
<ol>
<li><p>Memcached&#x7684;LRU&#x722C;&#x866B;&#x9ED8;&#x8BA4;&#x662F;&#x5173;&#x95ED;&#x7684;&#x3002;</p>
</li>
<li><p>Memcached&#x4F1A;&#x5F00;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x5BF9;&#x5931;&#x6548;&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;</p>
</li>
<li><p>&#x722C;&#x866B;&#x4EE3;&#x7801;&#x4E3B;&#x8981;&#x5728;item.c&#x4E2D;&#xFF0C;&#x8FD9;&#x8FB9;&#x53EA;&#x770B;&#x4E24;&#x4E2A;&#x6700;&#x91CD;&#x8981;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p> //LRU&#x722C;&#x866B;<br> static void <em>item_crawler_thread(void </em>arg) {  </p>
<pre><code>int i;  
pthread_mutex_lock<span class="params">(&amp;amp;lru_crawler_lock)</span>;  
<span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
    fprintf<span class="params">(stderr, &amp;quot;Starting LRU crawler background thread\n&amp;quot;)</span>;  
while <span class="params">(do_run_lru_crawler_thread)</span> {  
pthread_cond_wait<span class="params">(&amp;amp;lru_crawler_cond, &amp;amp;lru_crawler_lock)</span>;  
while <span class="params">(crawler_count)</span> {  
    item <span class="built_in">*</span><span class="built_in">search</span> = NULL;  
    void <span class="built_in">*</span>hold_lock = NULL;  
    <span class="keyword">for</span> <span class="params">(i = <span class="number">0</span>; i &amp;lt; LARGEST_ID; i++)</span> {  
        <span class="keyword">if</span> <span class="params">(crawlers[i].it_flags != <span class="number">1</span>)</span> {  
            continue;  
        }  
        pthread_mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="built_in">search</span> = crawler_crawl_q<span class="params">(<span class="params">(item *)</span>&amp;amp;crawlers[i])</span>;  
        <span class="keyword">if</span> <span class="params">(search == NULL ||  
            <span class="params">(crawlers[i].remaining &amp;amp;&amp;amp; --crawlers[i].remaining &amp;lt; <span class="number">1</span>)</span>)</span> {  
            <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
                fprintf<span class="params">(stderr, &amp;quot;Nothing left to crawl for %d\n&amp;quot;, i)</span>;  
            crawlers[i].it_flags = <span class="number">0</span>;  
            crawler_count--;  
            crawler_unlink_q<span class="params">(<span class="params">(item *)</span>&amp;amp;crawlers[i])</span>;  
            pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            continue;  
        }  
        uint32_t hv = hash<span class="params">(ITEM_key<span class="params">(search)</span>, search-&amp;gt;nkey)</span>;  
        <span class="comment">/* Attempt to hash item lock the &amp;quot;search&amp;quot; item. If locked, no 
         * other callers can incr the refcount 
         */</span>  
        <span class="keyword">if</span> <span class="params">(<span class="params">(hold_lock = item_trylock<span class="params">(hv)</span>)</span> == NULL)</span> {  
            pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            continue;  
        }  
        <span class="comment">/* Now see if the item is refcount locked */</span>  
        <span class="keyword">if</span> <span class="params">(refcount_incr<span class="params">(&amp;amp;search-&amp;gt;refcount)</span> != <span class="number">2</span>)</span> {  
            refcount_decr<span class="params">(&amp;amp;search-&amp;gt;refcount)</span>;  
            <span class="keyword">if</span> <span class="params">(hold_lock)</span>  
                item_trylock_unlock<span class="params">(hold_lock)</span>;  
            pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            continue;  
        }  
        <span class="comment">/* Frees the item or decrements the refcount. */</span>  
        <span class="comment">/* Interface for this could improve: do the free/decr here 
         * instead? */</span>  
        item_crawler_evaluate<span class="params">(search, hv, i)</span>;  
        <span class="keyword">if</span> <span class="params">(hold_lock)</span>  
            item_trylock_unlock<span class="params">(hold_lock)</span>;  
        pthread_mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="keyword">if</span> <span class="params">(settings.lru_crawler_sleep)</span>  
            usleep<span class="params">(settings.lru_crawler_sleep)</span>;  
    }  
}  
<span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
    fprintf<span class="params">(stderr, &amp;quot;LRU crawler thread sleeping\n&amp;quot;)</span>;  
STATS_LOCK<span class="params">()</span>;  
stats.lru_crawler_running = <span class="literal">false</span>;  
STATS_UNLOCK<span class="params">()</span>;  
}  
pthread_mutex_unlock<span class="params">(&amp;amp;lru_crawler_lock)</span>;  
<span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">2</span>)</span>  
    fprintf<span class="params">(stderr, &amp;quot;LRU crawler thread stopping\n&amp;quot;)</span>;  
return NULL;  
</code></pre><p> }<br> int start_item_crawler_thread(void) {  </p>
<pre><code>int ret<span class="comment">;  </span>
if <span class="list">(<span class="keyword">settings</span>.lru_crawler)</span>  
    return <span class="number">-1</span><span class="comment">;  </span>
pthread_mutex_lock<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;lru_crawler_lock);  </span>
do_run_lru_crawler_thread = <span class="number">1</span><span class="comment">;  </span>
settings.lru_crawler = true<span class="comment">;  </span>
if <span class="list">(<span class="list">(<span class="keyword">ret</span> = pthread_create<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;item_crawler_tid, NULL,  </span>
    item_crawler_thread, NULL)</span>)</span> != <span class="number">0</span>)</span> {  
    fprintf<span class="list">(<span class="keyword">stderr</span>, <span class="keyword">&amp;quot</span><span class="comment">;Can&amp;apos;t create LRU crawler thread: %s\n&amp;quot;,  </span>
        strerror<span class="list">(<span class="keyword">ret</span>)</span>)</span><span class="comment">;  </span>
    pthread_mutex_unlock<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;lru_crawler_lock);  </span>
    return <span class="number">-1</span><span class="comment">;  </span>
}  
pthread_mutex_unlock<span class="list">(<span class="keyword">&amp;amp</span><span class="comment">;lru_crawler_lock);  </span>
return <span class="number">0</span><span class="comment">;  </span></span></span></span>
</code></pre><p> }</p>
</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a><a href="/tags/链表/">链表</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/234ccfd/" title="深入学习Memcached -" itemprop="url">深入学习Memcached -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x7531;&#x4E8E;&#x5B9E;&#x9A8C;&#x5BA4;&#x5728;&#x4E00;&#x4E2A;&#x9879;&#x76EE;&#x4E2D;&#x7528;&#x5230;&#x4E86;Memcached&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#xFF0C;&#x81EA;&#x5DF1;&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x4E5F;&#x5BF9;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x672C;&#x6587;&#x5C31;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x81EA;&#x5DF1;&#x7684;&#x6536;&#x83B7;&#xFF0C;&#x8FD8;&#x662F;&#x4ECE;Memcached&#x662F;&#x4EC0;&#x4E48;&#x8C08;&#x8D77;&#x5427;&#x3002;</p>
<h2 id="Memcached&#x662F;&#x4EC0;&#x4E48;">Memcached&#x662F;&#x4EC0;&#x4E48;</h2><p>Memcached&#x662F;&#x4E00;&#x6B3E;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x4F7F;&#x7528;&#x5B83;&#x53EF;&#x4EE5;&#x51CF;&#x5C11;&#x5E94;&#x7528;&#x7CFB;&#x7EDF;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x7684;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#xFF0C;&#x51CF;&#x8F7B;&#x4E86;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#xFF0C;&#x5E76;&#x4E14;&#x63D0;&#x5347;&#x4E86;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x54CD;&#x5E94;&#x901F;&#x5EA6;&#x3002;&#x53EF;&#x4EE5;&#x5C06;Memcached&#x6BD4;&#x4F5C;&#x4E00;&#x4E2A;&#x5DE8;&#x5927;&#x7684;&#x3001;&#x5B58;&#x50A8;&#x4E86;&#x5F88;&#x591A; &#x5BF9;&#x7684;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x901A;&#x8FC7;key&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x6216;&#x67E5;&#x8BE2;&#x4EFB;&#x610F;&#x7684;&#x6570;&#x636E;&#x3002;&#x5B83;&#x7684;&#x5B9E;&#x73B0;&#x4F9D;&#x8D56;&#x4E8E;&#x51E0;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x7B97;&#x6CD5;&#xFF0C;&#x4E0B;&#x9762;&#x5C31;&#x8BE6;&#x7EC6;&#x8BB2;&#x8BB2; <strong>&#x6700;&#x8FD1;&#x6700;&#x5C11;&#x4F7F;&#x7528;&#xFF08;LRU&#xFF09;&#x7B97;&#x6CD5;</strong> &#x548C; <strong>&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;</strong> &#x3002; </p>
<h2 id="LRU&#x7B97;&#x6CD5;">LRU&#x7B97;&#x6CD5;</h2><p>&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x9875;&#x9762;&#x7F6E;&#x6362;&#x7B97;&#x6CD5;&#x4E2D;&#x4E5F;&#x5305;&#x62EC;&#x8BE5;&#x7B97;&#x6CD5;&#xFF0C;&#x8FD9;&#x79CD;&#x7B97;&#x6CD5;&#x975E;&#x5E38;&#x9002;&#x5408;&#x4E8E;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#x3002;&#x5B83;&#x57FA;&#x4E8E;&#x4E00;&#x79CD;&#x5047;&#x8BBE;&#xFF1A;&#x8FC7;&#x53BB;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x4F7F;&#x7528;&#x9891;&#x7387;&#x6700;&#x4F4E;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5C06;&#x6765;&#x4E5F;&#x4F1A;&#x5F88;&#x5C11;&#x4F7F;&#x7528;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x6211;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x7684;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;LRU&#x7B97;&#x6CD5;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x4E86;&#x57FA;&#x672C;&#x7684;&#x7F13;&#x5B58;&#x529F;&#x80FD;&#xFF0C;&#x4E0D;&#x8FC7;&#x9700;&#x8981;&#x6539;&#x8FDB;&#x7684;&#x4E00;&#x70B9;&#x662F;&#x8BE5;&#x7F13;&#x5B58;&#x5E94;&#x8BE5;&#x662F;&#x5355;&#x4F8B;&#x7684;&#x3002; </p>
<pre><code><span class="package"><span class="keyword">package</span> <span class="title">colin</span>.<span class="title">cache</span>;  </span>
</code></pre><p>/**  </p>
<ul>
<li></li>
<li>@author Colin Wang  </li>
<li><p>Created on Apr 18, 2015<br>*/<br>public class LRUCache {<br> private static final int DEFAULT_MAX_SIZE = 10;<br> private Object[] elements;<br> private int size;  </p>
<p> public LRUCache(int maxSize) {  </p>
<pre><code>elements = <span class="keyword">new</span> <span class="built_in">Object</span>[maxSize];  
</code></pre><p> }  </p>
<p> public LRUCache() {  </p>
<pre><code>this<span class="list">(<span class="keyword">DEFAULT_MAX_SIZE</span>)</span><span class="comment">;  </span>
</code></pre><p> }  </p>
<p> public boolean isEmpty() {  </p>
<pre><code><span class="keyword">return</span> <span class="built_in">size</span> == <span class="number">0</span>;  
</code></pre><p> }  </p>
<p> public int size() {  </p>
<pre><code><span class="keyword">return</span> <span class="built_in">size</span>;  
</code></pre><p> }  </p>
<p> public boolean isFull() {  </p>
<pre><code><span class="keyword">return</span> <span class="built_in">size</span> == elements.<span class="built_in">length</span>;  
</code></pre><p> }  </p>
<p> /**  </p>
<ul>
<li>&#x8FD4;&#x56DE;&#x5143;&#x7D20;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x4F4D;&#x7F6E;  </li>
<li></li>
<li>@param element  </li>
<li><p>@return<br>*/<br>public int indexOf(Object element) {<br> for (int i = 0; i &lt; size; i++) {  </p>
<pre><code><span class="keyword">if</span> (element.<span class="keyword">equals</span>(elements[i])) {  
<span class="command">    return</span> i;  
}  
</code></pre><p> }<br> return -1;<br>}  </p>
<p>public Object push(Object element) {<br> int index = -1;<br> if (!isFull() &amp;&amp; indexOf(element) == -1) {  </p>
<pre><code>// &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542B</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x63D2</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
elements[size++] = element;  
</code></pre><p> } else if (isFull() &amp;&amp; indexOf(element) == -1) {  </p>
<pre><code>// &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542B</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x63D2</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
for (int i = <span class="number">0</span>; i &amp;lt; size - <span class="number">1</span>; i++) {  
    elements[i] = elements[i + <span class="number">1</span>];  
}  
elements[size - <span class="number">1</span>] = element;  
</code></pre><p> } else {  </p>
<pre><code><span class="keyword">index</span> = indexOf(element);  
<span class="keyword">for</span> (int i = <span class="keyword">index</span>; i &amp;lt; size - <span class="number">1</span>; i++) <span class="comment">{  
    elements[i] = elements[i + 1];  
}</span>  
elements[size - <span class="number">1</span>] = element;  
</code></pre><p> }<br> return index == -1 ? null : elements[index];<br>}  </p>
<p>public void show() {<br> for (int i = 0; i &lt; size; i++) {  </p>
<pre><code><span class="tag">System</span><span class="class">.out</span><span class="class">.print</span>(<span class="tag">elements</span><span class="attr_selector">[i]</span><span class="class">.toString</span>() + &amp;<span class="tag">quot</span>; &amp;<span class="tag">quot</span>;);  
</code></pre><p> }<br>}<br>}</p>
</li>
</ul>
</li>
</ul>
<h2 id="&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;">&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;</h2><p>&#x8BE5;&#x7B97;&#x6CD5;&#x5728;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#x4E2D;&#x5E94;&#x7528;&#x5341;&#x5206;&#x5E7F;&#x6CDB;&#xFF0C;&#x5B83;&#x7684;&#x5173;&#x952E;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#x4F7F;&#x7528;&#x73AF;&#x5F62;&#x7684;&#x54C8;&#x5E0C;&#x7A7A;&#x95F4;&#x3002;&#x9996;&#x5148;&#x6211;&#x4EEC;&#x5148;&#x8003;&#x8651;&#x4E00;&#x4E0B;JDK&#x4E2D;HashMap&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;HashMap&#x6709;&#x4E00;&#x4E2A;&#x521D;&#x59CB;&#x5BB9;&#x91CF;&#x548C;&#x88C5;&#x8F7D;&#x56E0;&#x5B50;&#xFF0C;&#x5F53;HashMap&#x4E2D;&#x5143;&#x7D20;&#x7684;&#x6570;&#x91CF;&#x8FBE;&#x5230;&#x4E86; &#x521D;&#x59CB;&#x5BB9;&#x91CF;*&#x88C5;&#x8F7D;&#x56E0;&#x5B50; &#x8FD9;&#x4E48;&#x591A;&#x65F6;&#xFF0C;HashMap&#x5C31;&#x4F1A;&#x8FDB;&#x884C;&#x6269;&#x5BB9;&#xFF08;&#x53D8;&#x4E3A;&#x539F;&#x6765;&#x7684;2&#x500D;&#xFF09;&#x7136;&#x540E;&#x518D;&#x54C8;&#x5E0C;&#xFF0C;&#x5F53;&#x5143;&#x7D20;&#x5F88;&#x591A;&#x65F6;&#xFF0C;&#x8FD9;&#x79CD;&#x518D;&#x54C8;&#x5E0C;&#x64CD;&#x4F5C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x5F88;&#x6D88;&#x8017;&#x8D44;&#x6E90;&#x7684;&#x3002;&#x5C3D;&#x7BA1;HashMap&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x79CD;&#x6BD4;&#x8F83;&#x4F18;&#x5316;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x6BD4;&#x5982;HashMap&#x7684;&#x5927;&#x5C0F;&#x603B;&#x662F;&#x4E3A;2&#x7684;n&#x6B21;&#x5E42;&#xFF08;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;16&#xFF09;&#xFF0C;&#x8FD9;&#x6837;&#x65E2;&#x51CF;&#x5C11;&#x4E86;&#x54C8;&#x5E0C;&#x78B0;&#x649E;&#x7684;&#x51E0;&#x7387;&#xFF08;&#x56E0;&#x4E3A; 2&#x7684;n&#x6B21;&#x5E42;-1 &#x8F6C;&#x5316;&#x4E3A;&#x4E8C;&#x8FDB;&#x5236;&#x65F6;&#x6240;&#x6709;&#x4F4D;&#x5747;&#x4E3A;1&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x907F;&#x514D;&#x4E86;&#x67D0;&#x4E9B;&#x4F4D;&#x4E0D;&#x80FD;&#x53D1;&#x6325;&#x4F5C;&#x7528;&#xFF09;&#xFF0C;&#x53C8;&#x589E;&#x52A0;&#x4E86;HashMap&#x5728;&#x5B9A;&#x4F4D;&#x5143;&#x7D20;&#x65F6;&#x7684;&#x6548;&#x7387;&#xFF0C;&#x6BD4;&#x5982;&#x65B9;&#x6CD5;&#xFF1A; </p>
<pre><code><span class="keyword">static</span> <span class="function"><span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>{  
<span class="keyword">return</span> h &amp;amp; (length-<span class="number">1</span>);  
</code></pre><p>}</p>
<p>&#x5F53;length&#x603B;&#x662F;2&#x7684;n&#x6B21;&#x65B9;&#x65F6;&#xFF0C; h &amp; (length - 1) &#x8FD0;&#x7B97;&#x7B49;&#x4EF7;&#x4E8E;&#x5BF9;length&#x53D6;&#x6A21;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x4E9B;&#x4ECD;&#x7136;&#x4E0D;&#x80FD;&#x5B8C;&#x5168;&#x5F25;&#x8865;&#x6240;&#x6709;&#x5143;&#x7D20;&#x5FC5;&#x987B;&#x5168;&#x90E8;&#x91CD;&#x65B0;&#x54C8;&#x5E0C;&#x7684;&#x5F31;&#x70B9;&#x3002;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x62E5;&#x6709;N&#x53F0;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x70ED;&#x6570;&#x636E;&#x5DF2;&#x7ECF;&#x901A;&#x8FC7;Hash&#x7B97;&#x6CD5;&#x6620;&#x5C04;&#x5230;&#x4E86;&#x8FD9;N&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x5F53;&#x5176;&#x4E2D;&#x4E00;&#x53F0;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x6302;&#x6389;&#xFF0C;&#xFFFD;&#xFFFD;&#xFFFD;&#x8005;&#x6211;&#x4EEC;&#x53C8;&#x65B0;&#x6DFB;&#x4E86;&#x51E0;&#x53F0;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x6765;&#x65F6;&#xFF0C;&#x6240;&#x6709;&#x5DF2;&#x7ECF;&#x6620;&#x5C04;&#x597D;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5C06;&#x5931;&#x6548;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x7684;&#x540E;&#x7AEF;&#x6570;&#x636E;&#x5E93;&#x5C06;&#x4F1A;&#x627F;&#x53D7;&#x8FD9;&#x4E00;&#x5207;&#xFF01;&#x6240;&#x4EE5;&#xFF0C;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x5C31;&#x6D3E;&#x4E0A;&#x7528;&#x573A;&#x4E86;&#xFF0C;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x63D0;&#x5230;&#xFF0C;&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x73AF;&#x5F62;&#x7684;&#x54C8;&#x5E0C;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/234a10b.jpg" alt=""></p>
<p>&#x5E38;&#x89C4;&#x7684;Hash&#x7B97;&#x6CD5;&#x4E3A;&#x5C06;&#x67D0;&#x4E2A;key&#x6620;&#x5C04;&#x4E3A;&#x4E00;&#x4E2A;32&#x4F4D;&#x6574;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x8FD9;0&#x81F3;2^32-1&#x7684;&#x6570;&#x503C;&#x7A7A;&#x95F4;&#x9996;&#x4F4D;&#x76F8;&#x63A5;&#x4FBF;&#x5F62;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x73AF;&#x3002;&#x7136;&#x540E;&#x628A;&#x6211;&#x4EEC;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x901A;&#x8FC7;&#x6563;&#x5217;&#xFF08;&#x5BF9;IP&#x6216;&#x673A;&#x5668;&#x540D;&#x7B49;&#x8FDB;&#x884C;&#x6563;&#x5217;&#xFF09;&#x6620;&#x5C04;&#x5230;&#x8FD9;&#x4E2A;&#x73AF;&#x4E0A;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;&#x6563;&#x5217;&#x5230;&#x67D0;&#x4E2A;&#x4F4D;&#x7F6E;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x628A;&#x8BE5;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x5230; <strong>&#x987A;&#x65F6;&#x9488;&#x65B9;&#x5411;</strong> &#x79BB;&#x5B83;&#x6700;&#x8FD1;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7ED3;&#x70B9;&#x4E0A;&#x3002;&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x5F53;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7ED3;&#x70B9;&#x5931;&#x6548;&#x65F6;&#xFF0C;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x6240;&#x6709;&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x90FD;&#x5931;&#x6548;&#xFF0C;&#x4E5F;&#x4EC5;&#x4EC5;&#x9700;&#x8981;&#x628A;&#x539F;&#x6765;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x8BE5;&#x7ED3;&#x70B9;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x7EE7;&#x7EED;&#x7F13;&#x5B58;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x987A;&#x65F6;&#x9488;&#x65B9;&#x5411;&#x79BB;&#x5B83;&#x6700;&#x8FD1;&#x7684;&#x7ED3;&#x70B9;&#x4E0A;&#x5373;&#x53EF;&#x3002;&#x5F53;&#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x65F6;&#xFF0C;&#x540C;&#x6837;&#x4E5F;&#x53EA;&#x9700;&#x8981;&#x5BF9;&#x5F88;&#x5C11;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x518D;&#x54C8;&#x5E0C;&#x5E76;&#x6620;&#x5C04;&#x5230;&#x65B0;&#x7684;&#x7ED3;&#x70B9;&#x4E0A;&#x5373;&#x53EF;&#x3002;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x51FA;&#x73B0;&#x6570;&#x636E;&#x5206;&#x914D;&#x4E0D;&#x5747;&#x5300;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6BD4;&#x5982;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x7684;&#x6570;&#x636E;&#x90FD;&#x88AB;&#x7F13;&#x5B58;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x7ED3;&#x70B9;&#x4E0A;&#xFF0C;&#x800C;&#x5176;&#x4ED6;&#x7684;&#x7ED3;&#x70B9;&#x5219;&#x7F13;&#x5B58;&#x5F88;&#x5C11;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#x8FD8;&#x63D0;&#x51FA;&#x4E86; <strong>&#x865A;&#x62DF;&#x7ED3;&#x70B9;</strong> &#x7684;&#x6982;&#x5FF5;&#x3002;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/234a37c.jpg" alt=""></p>
<p>A1&#x548C;A2&#x4E3A;&#x7ED3;&#x70B9;A&#x7684;&#x865A;&#x62DF;&#x7ED3;&#x70B9;&#xFF0C;&#x865A;&#x62DF;&#x7ED3;&#x70B9;&#x7684;hash&#x503C;&#x8BA1;&#x7B97;&#x53EF;&#x4EE5;&#x91C7;&#x7528;&#x5BF9;&#x5E94;&#x7ED3;&#x70B9;&#x7684;IP&#x5730;&#x5740;&#x52A0;&#x6570;&#x5B57;&#x540E;&#x7F00;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5982;&#x201C;192.168.1.1#1&#x201D;&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x88AB;&#x6563;&#x5217;&#x5230;A1&#x548C;A2&#x7684;&#x6570;&#x636E;&#x90FD;&#x7F13;&#x5B58;&#x8FDB;&#x7ED3;&#x70B9;A&#x4E2D;&#xFF0C;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x4E86;&#x6570;&#x636E;&#x5206;&#x5E03;&#x4E0D;&#x5E73;&#x8861;&#x7684;&#x73B0;&#x8C61;&#x3002;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/238d0d2/" title="Linux c 开发 - Memcached源码分析之存储机制Slabs（7） -" itemprop="url">Linux c 开发 - Memcached源码分析之存储机制Slabs（7） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x524D;&#x51E0;&#x7AE0;&#x8282;&#x6211;&#x4EEC;&#x4ECB;&#x7ECD;&#x4E86;Memcached&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#xFF0C;&#x547D;&#x4EE4;&#x884C;&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF0C;HashTable&#xFF0C;Memcached&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x64CD;&#x4F5C;&#x4EE5;&#x53CA;LRU&#x7B97;&#x6CD5;&#x6A21;&#x5757;&#x3002;</p>
<p>&#x8FD9;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x8BB2;&#x89E3;Memcached&#x7684;&#x5B58;&#x50A8;&#x673A;&#x5236;Slabs&#x3002;Memcached&#x5B58;&#x50A8;Item&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x662F;&#x5728;slabs.c&#x4E2D;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>
<p>&#x5728;&#x89E3;&#x8BFB;&#x8FD9;&#x4E00;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x5148;&#x4E86;&#x89E3;&#x51E0;&#x4E2A;&#x6982;&#x5FF5;&#x3002;</p>
<p>Item &#x7F13;&#x5B58;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7684;&#x57FA;&#x672C;&#x5355;&#x5143;</p>
<ol>
<li><p>Item&#x662F;Memcached&#x5B58;&#x50A8;&#x7684;&#x6700;&#x5C0F;&#x5355;&#x4F4D;</p>
</li>
<li><p>&#x6BCF;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;Item&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
</li>
<li><p>Item&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x7F13;&#x5B58;&#x7684;key&#x3001;value&#x3001;key&#x7684;&#x957F;&#x5EA6;&#x3001;value&#x7684;&#x957F;&#x5EA6;&#x3001;&#x7F13;&#x5B58;&#x7684;&#x65F6;&#x95F4;&#x7B49;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>HashTable&#x548C;LRU&#x94FE;&#x8868;&#x7ED3;&#x6784;&#x90FD;&#x662F;&#x4F9D;&#x8D56;Item&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#x7684;&#x3002;</p>
</li>
<li><p>&#x5728;Memcached&#x4E2D;&#xFF0C;Item&#x626E;&#x6F14;&#x7740;&#x91CD;&#x8981;&#x7684;&#x89D2;&#x8272;&#x3002;</p>
<p> //item&#x7684;&#x5177;&#x4F53;&#x7ED3;&#x6784;<br> typedef struct _stritem {  </p>
<pre><code>//&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;,&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;freelist&amp;<span class="symbol">#x94FE</span>;  
struct _stritem *next;  
//&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;,&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x548C</span>;freelist&amp;<span class="symbol">#x94FE</span>;  
struct _stritem *prev;  
//&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;<span class="class">HashTable</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
struct _stritem *h_next;  
//&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x8FD1</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;set/add/replace&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x6BB5</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;flush&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x6548</span>;  
rel_time_t      time;       /* least recent access */  
//&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x6C38</span>;&amp;<span class="symbol">#x4E45</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x88AB</span>;<span class="class">LRU</span>&amp;<span class="symbol">#x6DD8</span>;&amp;<span class="symbol">#x6C70</span>;  
rel_time_t      exptime;    /* expire time */  
//value&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
int             nbytes;     /* size of data */  
//&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5F15</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x5B83</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x3002</span>;  
//&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;refcount&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6709</span>;refcount -<span class="number">1</span> = <span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x624D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;  
unsigned short  refcount;  
uint8_t         nsuffix;    /* length of flags-and-length string */  
uint8_t         it_flags;   /* <span class="class">ITEM_</span>* above */  
//slabs_class&amp;<span class="symbol">#x7684</span>;<span class="class">ID</span>&amp;<span class="symbol">#x3002</span>;  
uint8_t         slabs_clsid;/* which slab class we&amp;apos;re in */  
uint8_t         nkey;       /* key length, w/terminating null and padding */  
/* this odd type prevents type-punning issues when we do 
 * the little shuffle to save space when not using <span class="class">CAS</span>. */  
//&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
union {  
    uint64_t cas;  
    char end;  
} data[];  
/* if it_flags &amp;amp; <span class="class">ITEM_CAS</span> we have <span class="number">8</span> bytes <span class="class">CAS</span> */  
/* then null-terminated key */  
/* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
/* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
</code></pre><p> } item;</p>
</li>
</ol>
<p>slabclass &#x5212;&#x5206;&#x6570;&#x636E;&#x7A7A;&#x95F4;</p>
<ol>
<li><p>Memcached&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;slabclass&#x6570;&#x7EC4;&#xFF0C;&#x8BE5;&#x6570;&#x7EC4;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6700;&#x5927;201&#x4E2A;slabclass_t&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4F53;&#x3002;</p>
</li>
<li><p>Memcached&#x5E76;&#x4E0D;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;&#x90FD;&#x4F1A;&#x653E;&#x7F6E;&#x5728;&#x4E00;&#x8D77;&#xFF0C;&#x800C;&#x662F;&#x9884;&#x5148;&#x5C06;&#x6570;&#x636E;&#x7A7A;&#x95F4;&#x5212;&#x5206;&#x4E3A;&#x4E00;&#x7CFB;&#x5217;&#x7684;slabclass_t&#x3002;</p>
</li>
<li><p>&#x6BCF;&#x4E2A;slabclass_t&#xFF0C;&#x90FD;&#x53EA;&#x5B58;&#x50A8;&#x4E00;&#x5B9A;&#x5927;&#x5C0F;&#x8303;&#x56F4;&#x7684;&#x6570;&#x636E;&#x3002;slabclass&#x6570;&#x7EC4;&#x4E2D;&#xFF0C;&#x524D;&#x4E00;&#x4E2A;slabclass_t&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x8981;&#x5C0F;&#x4E8E;&#x4E0B;&#x4E00;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x3002;</p>
</li>
<li><p>&#x4F8B;&#x5982;&#xFF1A;slabclass[3]&#x53EA;&#x5B58;&#x50A8;&#x5927;&#x5C0F;&#x4ECB;&#x4E8E;120 &#xFF08;slabclass[2]&#x7684;&#x6700;&#x5927;&#x503C;&#xFF09;&#x5230; 150 bytes&#x7684;&#x6570;&#x636E;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5927;&#x5C0F;&#x4E3A;134byte&#x5C06;&#x88AB;&#x5206;&#x914D;&#x5230;slabclass[3]&#x4E2D;&#x3002;</p>
</li>
<li><p>memcached&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0B;&#x4E00;&#x4E2A;slabclass_t&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x6700;&#x5927;&#x503C;&#x4E3A;&#x524D;&#x4E00;&#x4E2A;&#x7684;1.25&#x500D;&#xFF08;settings.factor&#xFF09;&#xFF0C;&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4FEE; &#x6539;-f&#x53C2;&#x6570;&#x6765;&#x4FEE;&#x6539;&#x589E;&#x957F;&#x6BD4;&#x4F8B;&#x3002;</p>
<p> //slabclass&#x7684;&#x7ED3;&#x6784;<br> typedef struct {  </p>
<pre><code>//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;slabclass&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item  
unsigned int size;  
//&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;item.&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>; &amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;size&amp;<span class="symbol">#x51B3</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x3002</span>;  
unsigned int perslab;  

//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;slabclass&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;item&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF09</span>;freelist &amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
//freelist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;item-&amp;gt;next&amp;<span class="symbol">#x548C</span>;item-&amp;gt;prev&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x7CFB</span>;  
void *slots;           /* list of item ptrs */  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item  
//&amp;<span class="symbol">#x5F53</span>;sl_curr=<span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="number">1</span>M&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x6210</span>;<span class="class">N</span>&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF09</span>;  
unsigned int sl_curr;   /* total free items in list */  

//&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x4E2A</span>;slabs  
unsigned int slabs;     /* how many slabs were allocated for this class */  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x8868</span>;  
void **slab_list;       /* array of slab pointers */  
unsigned int list_size; /* size of prev array */  

unsigned int killing;  /* index+<span class="number">1</span> of dying slab, or zero if none */  
//&amp;<span class="symbol">#x603B</span>;&amp;<span class="symbol">#x5171</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x603B</span>;bytes  
size_t requested; /* <span class="class">The</span> number of requested bytes */  
</code></pre><p> } slabclass_t;<br> //&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;slabclass&#x6570;&#x7EC4;&#xFF0C;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x6700;&#x5927;200&#x4E2A;&#x7684;slabclass_t&#x7684;&#x7ED3;&#x6784;&#x3002;<br> static slabclass_t slabclass[MAX_NUMBER_OF_SLAB_CLASSES];</p>
</li>
</ol>
<p>slab &#x5185;&#x5B58;&#x5206;&#x914D;&#x5355;&#x4F4D;</p>
<ol>
<li><p>Memcached&#x7684;&#x5185;&#x5B58;&#x5206;&#x914D;&#x662F;&#x4EE5;slab&#x4E3A;&#x5355;&#x4F4D;&#x7684;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6BCF;&#x4E2A;slab&#x5927;&#x5C0F;&#x4E3A;1M&#x3002;</p>
</li>
<li><p>slabclass&#x6570;&#x7EC4;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6BCF;&#x4E2A;slabclass_t&#x90FD;&#x4F1A;&#x5206;&#x914D;&#x4E00;&#x4E2A;1M&#x5927;&#x5C0F;&#x7684;slab&#x3002;</p>
</li>
<li><p>&#x5F53;&#x67D0;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x4E0A;&#x7684;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x7684;&#x65F6;&#x5019;&#xFF08;freelist&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E3A;&#x7A7A;&#xFF09;&#xFF0C;&#x5219;&#x4F1A;&#x5206;&#x914D;&#x4E00;&#x4E2A;slab&#x7ED9;&#x8FD9;&#x4E2A;slabclass_t&#x7ED3;&#x6784;&#x3002;</p>
</li>
<li><p>&#x4E00;&#x65E6;slab&#x5206;&#x914D;&#x540E;&#xFF0C;&#x4E0D;&#x53EF;&#x56DE;&#x6536;&#x3002;</p>
</li>
<li><p>slab&#x4F1A;&#x88AB;&#x5207;&#x5206;&#x4E3A;N&#x4E2A;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#x7684;&#x5927;&#x5C0F;&#x53D6;&#x51B3;&#x4E8E;slabclass_t&#x7ED3;&#x6784;&#x4E0A;&#x7684;size&#x7684;&#x5927;&#x5C0F;&#x3002;&#x4F8B;&#x5982;slabclass<a href="http://taojinke.github.io/img/20150703/2389d8d.jpg">0</a>&#x4E0A;&#x7684;size&#x4E3A;103&#xFF0C;&#x5219;&#x6BCF;&#x4E2A;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#x5927;&#x5C0F;&#x4E3A;103byte&#x3002;</p>
</li>
<li><p>&#x8FD9;&#x4E9B;&#x88AB;&#x5207;&#x5272;&#x7684;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5B58;&#x50A8;item&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x5B58;&#x50A8;&#x7684;item&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x6BD4;&#x5207;&#x5272;&#x51FA;&#x6765;&#x7684;&#x5185;&#x5B58;&#x5757;&#x4F1A;&#x5C0F;&#x3002;&#x56E0;&#x4E3A;&#x8FD9;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x5185;&#x5B58;&#x788E;&#x7247;&#xFF0C;&#x867D;&#x7136;&#x6709;&#x4E00;&#x4E9B;&#x5185;&#x5B58;&#x7684;&#x6D6A;&#x8D39;&#x3002;</p>
</li>
</ol>
<p>slabclass&#x548C;slab&#x3001;item&#x4EE5;&#x53CA;free list&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF1A; </p>
<p><img src="http://taojinke.github.io/img/20150703/2389d8d.jpg" alt=""></p>
<p>&#x901A;&#x8FC7;item&#x7684;size&#x6765;&#x9009;&#x62E9;slab_class&#x7684;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2389ffe.jpg" alt=""></p>
<p>&#x5B58;&#x50A8;&#x673A;&#x5236;&#x7684;&#x6E90;&#x7801;&#x5206;&#x6790;</p>
<p>slabs_clsid - &#x67E5;&#x8BE2;slabclass&#x7684;ID</p>
<p>slabs_clsid&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x901A;&#x8FC7;item&#x7684;&#x957F;&#x5EA6;&#x6765;&#x67E5;&#x8BE2;&#x5E94;&#x8BE5;&#x9002;&#x5408;&#x5B58;&#x653E;&#x5230;&#x54EA;&#x4E2A;slabsclass_t&#x4E0A;&#x9762;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;item&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9009</span>;&amp;<span class="symbol">#x62E9</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x9002</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E2D</span>;  
unsigned int slabs_clsid(const size_t size) {  
    int res = <span class="class">POWER_SMALLEST</span>; //&amp;<span class="symbol">#x4ECE</span>;id = <span class="number">1</span>&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;  

    //slabclass&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8BE5</span>;class&amp;<span class="symbol">#x9002</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;  
    //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;  
    //slabclass[<span class="number">0</span>] &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">96</span>byte  
    //slabclass[<span class="number">1</span>] &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">120</span>byte  
    //slabclass[<span class="number">2</span>] &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">150</span>byte  
    //&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">109</span>byte&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5728</span>;slabclass[<span class="number">1</span>]&amp;<span class="symbol">#x4E0A</span>;  
    if (size == <span class="number">0</span>)  
        return <span class="number">0</span>;  
    while (size &amp;gt; slabclass[res].size)  
        if (res++ == power_largest)     /* won&amp;apos;t fit in the biggest slab */  
            return <span class="number">0</span>;  
    return res;  
}
</code></pre><p>slabs_init - slabclass&#x7684;&#x521D;&#x59CB;&#x5316;</p>
<p>slabs_init&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x521D;&#x59CB;&#x5316;slabclass&#x6570;&#x7EC4;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code>//slabclass&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;  
void slabs_init(const size_t limit, const double factor, const bool prealloc) {  
    int i = <span class="class">POWER_SMALLEST</span> - <span class="number">1</span>;  
    unsigned int size = sizeof(item) + settings.chunk_size;  
    mem_limit = limit;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass_t&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
    //&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;  
    if (prealloc) {  
        /* <span class="class">Allocate</span> everything in a big chunk with malloc */  
        mem_base = malloc(mem_limit);  
        if (mem_base != <span class="class">NULL</span>) {  
            mem_current = mem_base;  
            mem_avail = mem_limit;  
        } else {  
            fprintf(stderr, &amp;quot;<span class="class">Warning</span>: <span class="class">Failed</span> to allocate requested memory in&amp;quot;  
                    &amp;quot; one large chunk.\nWill allocate in smaller chunks\n&amp;quot;);  
        }  
    }  
    memset(slabclass, <span class="number">0</span>, sizeof(slabclass));  
    //factor &amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">1.25</span> &amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">96</span>byte&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;  
    //&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;<span class="number">120</span>byte  
    while (++i &amp;lt; <span class="class">POWER_LARGEST</span> &amp;amp;&amp;amp; size &amp;lt;= settings.item_size_max / factor) {  
        /* <span class="class">Make</span> sure items are always n-byte aligned */  
        if (size % <span class="class">CHUNK_ALIGN_BYTES</span>)  
            size += <span class="class">CHUNK_ALIGN_BYTES</span> - (size % <span class="class">CHUNK_ALIGN_BYTES</span>);  
        //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass[i]&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;item  
        slabclass[i].size = size;  
        slabclass[i].perslab = settings.item_size_max / slabclass[i].size;  
        size *= factor;  
        if (settings.verbose &amp;gt; <span class="number">1</span>) {  
            fprintf(stderr, &amp;quot;slab class %<span class="number">3</span><span class="method">d:</span> chunk size %<span class="number">9</span>u perslab %<span class="number">7</span>u\n&amp;quot;,  
                    i, slabclass[i].size, slabclass[i].perslab);  
        }  
    }  
    power_largest = i;  
    slabclass[power_largest].size = settings.item_size_max;  
    slabclass[power_largest].perslab = <span class="number">1</span>;  
    if (settings.verbose &amp;gt; <span class="number">1</span>) {  
        fprintf(stderr, &amp;quot;slab class %<span class="number">3</span><span class="method">d:</span> chunk size %<span class="number">9</span>u perslab %<span class="number">7</span>u\n&amp;quot;,  
                i, slabclass[i].size, slabclass[i].perslab);  
    }  
    /* for the test <span class="method">suite:</span>  faking of how much we&amp;apos;ve already malloc&amp;apos;d */  
    {  
        char *t_initial_malloc = getenv(&amp;quot;<span class="class">T_MEMD_INITIAL_MALLOC</span>&amp;quot;);  
        if (t_initial_malloc) {  
            mem_malloced = (size_t)atol(t_initial_malloc);  
        }  
    }  
    if (prealloc) {  
        slabs_preallocate(power_largest);  
    }  
}


//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
static void slabs_preallocate (const unsigned int maxslabs) {  
    int i;  
    unsigned int prealloc = <span class="number">0</span>;  
    /* pre-allocate a <span class="number">1</span>MB slab in every size class so people don&amp;apos;t get 
       confused by non-intuitive &amp;quot;<span class="class">SERVER_ERROR</span> out of memory&amp;quot; 
       messages.  this is the most common question on the mailing 
       list.  if you really don&amp;apos;t want this, you can rebuild without 
       these three lines.  */  
    //&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slabclass_t&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x7684</span>;slab  
    for (i = <span class="class">POWER_SMALLEST</span>; i &amp;lt;= <span class="class">POWER_LARGEST</span>; i++) {  
        if (++prealloc &amp;gt; maxslabs)  
            return;  
        if (do_slabs_newslab(i) == <span class="number">0</span>) {  
            fprintf(stderr, &amp;quot;<span class="class">Error</span> while preallocating slab memory!\n&amp;quot;  
                &amp;quot;<span class="class">If</span> using -<span class="class">L</span> or other prealloc options, max memory must be &amp;quot;  
                &amp;quot;at least %d megabytes.\n&amp;quot;, power_largest);  
            exit(<span class="number">1</span>);  
        }  
    }  
}
</code></pre><p>do_slabs_alloc - &#x5206;&#x914D;&#x4E00;&#x4E2A;item</p>
<ol>
<li><p>Memcached&#x5206;&#x914D;&#x4E00;&#x4E2A;item&#xFF0C;&#x4F1A;&#x5148;&#x68C0;&#x67E5;freelist&#x7A7A;&#x95F2;&#x7684;&#x5217;&#x8868;&#x4E2D;&#x662F;&#x5426;&#x6709;&#x7A7A;&#x95F2;&#x7684;item&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7684;&#x8BDD;&#x5C31;&#x7528;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E2D;&#x7684;item&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x6CA1;&#x6709;&#x7A7A;&#x95F2;&#x7684;item&#x53EF;&#x4EE5;&#x5206;&#x914D;&#xFF0C;&#x5219;Memcached&#x4F1A;&#x53BB;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;slab&#xFF08;&#x9ED8;&#x8BA4;&#x5927;&#x5C0F;&#x4E3A;1M&#xFF09;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x5982;&#x679C;&#x7533;&#x8BF7;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;NULL&#xFF0C;&#x8868;&#x660E;&#x5206;&#x914D;&#x5931;&#x8D25;&#x3002;</p>
</li>
<li><p>&#x5982;&#x679C;&#x7533;&#x8BF7;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x53BB;&#x5C06;&#x8FD9;&#x4E2A;1M&#x5927;&#x5C0F;&#x7684;&#x5185;&#x5B58;&#x5757;&#xFF0C;&#x6839;&#x636E;slabclass_t&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x7684;&#x6700;&#x5927;&#x7684;item&#x7684;size&#xFF0C;&#x5C06;slab&#x5207;&#x5272;&#x6210;N&#x4E2A;item&#xFF0C;&#x7136;&#x540E;&#x653E;&#x8FDB;freelist&#xFF08;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E2D;&#xFF09;</p>
</li>
<li><p>&#x7136;&#x540E;&#x53BB;freelist&#xFF08;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#xFF09;&#x4E2D;&#x53D6;&#x51FA;&#x4E00;&#x4E2A;item&#x6765;&#x4F7F;&#x7528;&#x3002;</p>
<p> //&#x5206;&#x914D;&#x4E00;&#x4E2A;Item<br> void *slabs_alloc(size_t size, unsigned int id) {  </p>
<pre><code>void *ret;  
//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;<span class="class">Item</span>&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;  
pthread_mutex_lock(&amp;amp;slabs_lock);  
//size&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
//id&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;slab class&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
ret = do_slabs_alloc(size, id);  
pthread_mutex_unlock(&amp;amp;slabs_lock);  
return ret;  
</code></pre><p> }</p>
</li>
</ol>
<pre><code>//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
static void *do_slabs_alloc(const size_t size, unsigned int id) {  
    slabclass_t *p;  
    void *ret = <span class="class">NULL</span>;  
    item *it = <span class="class">NULL</span>;  
    if (id &amp;lt; <span class="class">POWER_SMALLEST</span> || id &amp;gt; power_largest) {  
        <span class="class">MEMCACHED_SLABS_ALLOCATE_FAILED</span>(size, <span class="number">0</span>);  
        return <span class="class">NULL</span>;  
    }  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;slabclass  
    p = &amp;amp;slabclass[id];  
    assert(p-&amp;gt;sl_curr == <span class="number">0</span> || ((item *)p-&amp;gt;slots)-&amp;gt;slabs_clsid == <span class="number">0</span>);  
    /* fail unless we have space at the end of a recently allocated page, 
       we have something on our freelist, or we could allocate a new page */  
    //p-&amp;gt;sl_curr &amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item list  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;item list&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NULL</span>  
    if (! (p-&amp;gt;sl_curr != <span class="number">0</span> || do_slabs_newslab(id) != <span class="number">0</span>)) {  
        /* <span class="class">We</span> don&amp;apos;t have more memory available */  
        ret = <span class="class">NULL</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;free item lits&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
    } else if (p-&amp;gt;sl_curr != <span class="number">0</span>) {  
        /* return off our freelist */  
        it = (item *)p-&amp;gt;slots;  
        p-&amp;gt;slots = it-&amp;gt;next;  
        if (it-&amp;gt;next) it-&amp;gt;next-&amp;gt;prev = <span class="number">0</span>;  
        p-&amp;gt;sl_curr--;  
        ret = (void *)it;  
    }  
    if (ret) {  
        p-&amp;gt;requested += size;  
        <span class="class">MEMCACHED_SLABS_ALLOCATE</span>(size, id, p-&amp;gt;size, ret);  
    } else {  
        <span class="class">MEMCACHED_SLABS_ALLOCATE_FAILED</span>(size, id);  
    }  
    return ret;  
}
</code></pre><p>&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;slab&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x5757</span>;  
static int do_slabs_newslab(const unsigned int id) {  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;slabclass  
    slabclass_t *p = &amp;amp;slabclass[id];  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;slab&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x662F</span>;<span class="number">1</span>M  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x7684</span>;slab&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>; &amp;<span class="symbol">#x8BE5</span>;slabclass&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>; * &amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>; &amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    int len = settings.slab_reassign ? settings.item_size_max  
        : p-&amp;gt;size * p-&amp;gt;perslab;  
    char *ptr;  

    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;slab&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;  
    if ((mem_limit &amp;amp;&amp;amp; mem_malloced + len &amp;gt; mem_limit &amp;amp;&amp;amp; p-&amp;gt;slabs &amp;gt; <span class="number">0</span>) ||  
        (grow_slab_list(id) == <span class="number">0</span>) ||  
        ((ptr = memory_allocate((size_t)len)) == <span class="number">0</span>)) {  

        <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED</span>(id);  
        return <span class="number">0</span>;  
    }  

    //&amp;<span class="symbol">#x5C06</span>;slab&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x6210</span>;<span class="class">N</span>&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;freelist&amp;<span class="symbol">#x4E2D</span>;  
    memset(ptr, <span class="number">0</span>, (size_t)len);  
    split_slab_page_into_freelist(ptr, id);  

    p-&amp;gt;slab_list[p-&amp;gt;slabs++] = ptr;  
    mem_malloced += len;  
    <span class="class">MEMCACHED_SLABS_SLABCLASS_ALLOCATE</span>(id);  

    return <span class="number">1</span>;  
}
</code></pre><p>&#x5C06;slab&#x5185;&#x5B58;&#x5757;&#x8FDB;&#x884C;&#x5207;&#x5272;&#xFF1A;</p>
<pre><code><span class="xml">//&amp;#x5C06;slab &amp;#x5207;&amp;#x5272;&amp;#x6210;N&amp;#x4E2A;item  
static void split_slab_page_into_freelist(char *ptr, const unsigned int id) </span><span class="expression">{  
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];  
    <span class="variable">int</span> <span class="variable">x</span>;  
    <span class="variable">for</span> (<span class="variable">x</span> = 0; <span class="variable">x</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">perslab</span>; <span class="variable">x</span>++) {  
        //&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>20;&amp;<span class="begin-block">#x</span>9012;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>9;<span class="variable">ptr</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;<span class="variable">free</span>&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>76;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>771<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>63;&amp;<span class="begin-block">#x</span>610<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>49;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>91<span class="variable">CA</span>;&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>06;&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5230;<span class="variable">free</span> <span class="variable">list</span>&amp;<span class="begin-block">#xFF</span>08;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>2;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9762;&amp;<span class="begin-block">#xFF</span>09;  
        <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, 0, <span class="variable">id</span>);  
        //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
        //&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>9<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>9645;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">size</span>&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>  
        <span class="variable">ptr</span> += <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">size</span>;  
    }</span><span class="xml">  
}</span>
</code></pre><p>slabs_free - &#x91CA;&#x653E;&#x4E00;&#x4E2A;item</p>
<p>&#x91CA;&#x653E;item&#x540E;&#xFF0C;&#x4F1A;&#x5C06;item&#x653E;&#x8FDB;free list&#xFF08;&#x7A7A;&#x95F2;&#x5217;&#x8868;&#x4E2D;&#xFF09;&#x3002;</p>
<pre><code><span class="xml">//&amp;#x91CA;&amp;#x653E;&amp;#x4E00;&amp;#x4E2A;Item  
void slabs_free(void *ptr, size_t size, unsigned int id) </span><span class="expression">{  
    <span class="variable">pthread</span>_<span class="variable">mutex</span>_<span class="variable">lock</span>(&amp;<span class="variable">amp</span>;<span class="variable">slabs</span>_<span class="variable">lock</span>);  
    /<span class="end-block">/ptr</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>9488;  
    /<span class="end-block">/size</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
    /<span class="end-block">/id</span>&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>54<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">slab</span> <span class="variable">class</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9762;  
    <span class="variable">do</span>_<span class="variable">slabs</span>_<span class="variable">free</span>(<span class="variable">ptr</span>, <span class="variable">size</span>, <span class="variable">id</span>);  
    <span class="variable">pthread</span>_<span class="variable">mutex</span>_<span class="variable">unlock</span>(&amp;<span class="variable">amp</span>;<span class="variable">slabs</span>_<span class="variable">lock</span>);  
}</span><span class="xml">


//&amp;#x91CA;&amp;#x653E;&amp;#x4E00;&amp;#x4E2A;item  
static void do_slabs_free(void *ptr, const size_t size, unsigned int id) </span><span class="expression">{  
    <span class="variable">slabclass</span>_<span class="variable">t</span> *<span class="variable">p</span>;  
    <span class="variable">item</span> *<span class="variable">it</span>;  

    <span class="variable">assert</span>(((<span class="variable">item</span> *)<span class="variable">ptr</span>)<span class="variable">-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slabs</span>_<span class="variable">clsid</span> == 0);  
    <span class="variable">assert</span>(<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>;= <span class="variable">power</span>_<span class="variable">largest</span>);  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">id</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">POWER</span>_<span class="variable">SMALLEST</span> || <span class="variable">id</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; <span class="variable">power</span>_<span class="variable">largest</span>)  
        <span class="variable">return</span>;  

    <span class="variable">MEMCACHED</span>_<span class="variable">SLABS</span>_<span class="variable">FREE</span>(<span class="variable">size</span>, <span class="variable">id</span>, <span class="variable">ptr</span>);  
    <span class="variable">p</span> = &amp;<span class="variable">amp</span>;<span class="variable">slabclass</span>[<span class="variable">id</span>];  

    <span class="variable">it</span> = (<span class="variable">item</span> *)<span class="variable">ptr</span>;  
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">it</span>_<span class="variable">flags</span> |= <span class="variable">ITEM</span>_<span class="variable">SLABBED</span>;  
    //&amp;<span class="begin-block">#x</span>653<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDB</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>2;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>8868;  <span class="variable">freelist</span>  
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = 0;  
    <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span> = <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span>;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next</span>) <span class="variable">it-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">next-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">prev</span> = <span class="variable">it</span>;  
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">slots</span> = <span class="variable">it</span>;  

    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sl</span>_<span class="variable">curr</span>++;  
    <span class="variable">p-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">requested</span> <span class="variable">-</span>= <span class="variable">size</span>;  
    <span class="variable">return</span>;  
}</span><span class="xml"></span>
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2391c81/" title="libmc - 一个高效轻便的 C++/Python Memcached 客户端库 -" itemprop="url">libmc - 一个高效轻便的 C++/Python Memcached 客户端库 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><img src="http://taojinke.github.io/img/20150703/238e1e9.png" alt=""></p>
<p>libmc is a memcached client library for Python without any other dependencies in runtime. It&apos;s mainly written in C++ and Cython. libmc can be considered as a drop in replacement for <strong>libmemcached andpython-libmemcached</strong> . </p>
<p>libmc is developing and maintaining by Douban Inc. Currently, It is working in production environment, powering all web traffics in douban.com. Realtime <a href="https://travis-ci.org/douban/libmc/builds/57124335#L1611" target="_blank" rel="external">benchmark result</a> is available on travis. </p>
<h2 id="Build_and_Installation">Build and Installation</h2><p>For users:</p>
<pre><code>pip <span class="keyword">install</span> libmc
</code></pre><p>Usage:</p>
<pre><code><span class="preprocessor"><span class="keyword">import</span> libmc

mc = libmc.Client([&amp;apos;</span>localhost:<span class="number">11211</span>&amp;apos;, &amp;apos;localhost:<span class="number">11212</span>&amp;apos;])
mc.<span class="keyword">set</span>(&amp;apos;foo&amp;apos;, &amp;apos;bar&amp;apos;)
assert mc.<span class="keyword">get</span>(&amp;apos;foo&amp;apos;) == &amp;apos;bar&amp;apos;
</code></pre><h2 id="Under_the_hood">Under the hood</h2><p>Under the hood, libmc consists of 2 parts: an internal fully-functional memcached client implementation in C++ and a Cython wrapper around that implementation. Dynamic memory allocation and memory-copy are slow, so we tried our best to avoid them. The set_multi command is not natively supported by thememcached protocol. Some techniques are applied to make set_multi command extremely fast in libmc (compared to some other similiar libraries). </p>
<h2 id="Configuration">Configuration</h2><pre><code><span class="built_in">import</span> libmc
from libmc <span class="built_in">import</span> (
    MC_HASH_MD5, MC_POLL_TIMEOUT, MC_CONNECT_TIMEOUT, MC_RETRY_TIMEOUT
)
<span class="variable">mc =</span> libmc.Client(
    [&amp;apos;localhost:<span class="number">11211</span>&amp;apos;, &amp;apos;localhost:<span class="number">11212</span>&amp;apos;], <span class="variable">do_split=</span>True,
    <span class="variable">comp_threshold=</span><span class="number">0</span>, <span class="variable">noreply=</span>False, <span class="variable">prefix=</span>None,
    <span class="variable">hash_fn=</span>MC_HASH_MD5, <span class="variable">failover=</span>False
)
mc.config(MC_POLL_TIMEOUT, <span class="number">100</span>)  <span class="comment"># 100 ms</span>
mc.config(MC_CONNECT_TIMEOUT, <span class="number">300</span>)  <span class="comment"># 300 ms</span>
mc.config(MC_RETRY_TIMEOUT, <span class="number">5</span>)  <span class="comment"># 5 s</span>
</code></pre><ul>
<li>do_split : Memcached server will refuse to store value if size &gt;= 1MB, if do_split is enabled, large value (&lt; 10 MB) will be splitted into several blocks. If the value is too large (&gt;= 10 MB), it will not be stored. default: True</li>
<li>comp_threshold : All kinds of values will be encoded into string buffer. If buffer length &gt; comp_threshold &gt; 0 , it will be compressed using zlib. If comp_threshold = 0 , string buffer will never be compressed using zlib. default:</li>
<li>noreply : Whether to enable memcached&apos;s noreply behaviour. default: False</li>
<li>prefix : The key prefix. default: &apos;&apos;</li>
<li>hash_fn : hashing function for keys. possible values: </li>
</ul>
<ul>
<li>MC_HASH_MD5</li>
<li>MC_HASH_FNV1_32</li>
<li>MC_HASH_FNV1A_32</li>
<li>MC_HASH_CRC_32</li>
</ul>
<p>default: MC_HASH_MD5</p>
<p>NOTE:fnv1_32, fnv1a_32, crc_32 implementations in libmc are per each spec, but they&apos;re not compatible with corresponding implementions in libmemcached.</p>
<ul>
<li>failover : Whether to failover to next server when current server is not available. default: False</li>
<li>MC_POLL_TIMEOUT Timeout parameter used during set/get procedure. (default:ms)</li>
<li>MC_CONNECT_TIMEOUT Timeout parameter used when connecting to memcached server on initial phase. (default:ms)</li>
<li>MC_RETRY_TIMEOUT When a server is not available dur to server-end error. libmc will try to establish the broken connection in every MC_RETRY_TIMEOUT s until the connection is back to live.(default:s)</li>
</ul>
<p>NOTE:The hashing algorithm for host mapping on continuum is always md5. </p>
<h2 id="Contributing_to_libmc">Contributing to libmc</h2><p>Feel free to send a <strong>Pull Request</strong> . For feature requests or any questions, please open an <strong>Issue</strong> . </p>
<p>For <strong>SECURITY DISCLOSURE</strong> , please disclose the information responsibly by sending an email to <a href="mailto:security@douban.com" target="_blank" rel="external">security@douban.com</a> directly instead of creating a GitHub issue. </p>
<h4 id="Does_libmc_support_PHP?">Does libmc support PHP?</h4><p>No. But if you like, you can write a wrapper for PHP based on the C++ implementation.</p>
<h4 id="Is_Memcached_binary_protocol_supported_?">Is Memcached binary protocol supported ?</h4><p>No. Only Memcached ASCII protocol is supported currently.</p>
<h4 id="Why_reinventing_the_wheel?">Why reinventing the wheel?</h4><p>Before libmc, we&apos;re usingpython-libmemcached, which is a python extention for <a href="http://libmemcached.org/libMemcached.html" target="_blank" rel="external">libmemcached</a> . libmemcached is quite weird and buggy. After nearly one decade, there&apos;re still some unsolved bugs. </p>
<h4 id="Is_libmc_thread-safe_?">Is libmc thread-safe ?</h4><p>libmc is a single-threaded memcached client. If you initialize a libmc client in one thread but reuse that in another thread, a Python Exception ThreadUnsafe will raise in Python. </p>
<h4 id="Is_libmc_compatible_with_gevent?">Is libmc compatible with gevent?</h4><p>Yes, with the help ofgreenify, libmc is friendly to gevent. Read tests/shabby/gevent_issue.py for details. </p>
<h2 id="Acknowledgments">Acknowledgments</h2><ul>
<li>Thanks to@fahrenheit2539 and the llvm project for the standalone. <a href="http://fahrenheit2539.blogspot.com/2012/06/introduction-in-depths-look-at.html" target="_blank" rel="external">SmallVector</a> implementation.</li>
<li>Thanks to@miloyip for the high performancei64toa implementation.</li>
<li>Thanks to <a href="https://twitter.com/d0znpp" target="_blank" rel="external">Ivan Novikov</a> for the research in <a href="https://www.blackhat.com/us-14/briefings.html#the-new-page-of-injections-book-memcached-injections" target="_blank" rel="external">THE NEW PAGE OF INJECTIONS BOOK: MEMCACHED INJECTIONS</a> .</li>
<li>Thanks to the PolarSSL project for the md5 implementation.</li>
<li>Thanks to@lericson for the <a href="https://github.com/lericson/pylibmc/blob/master/bin/runbench.py" target="_blank" rel="external">benchmark script in pylibmc</a> .</li>
<li>Thanks to the libmemcached project and some other projects possibly not mentioned here.</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/C/">C++</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23bc0c6/" title="memcached Java客户端spymemcached的一致性Hash算法 -" itemprop="url">memcached Java客户端spymemcached的一致性Hash算法 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x6700;&#x8FD1;&#x770B;&#x5230;&#x4E24;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x6C5F;&#x5357;&#x767D;&#x8863;&#x7684; <a href="http://calvin1978.blogcn.com/articles/murmur.html" target="_blank" rel="external">&#x964C;&#x751F;&#x4F46;&#x9ED8;&#x9ED8;&#x4E00;&#x7EDF;&#x6C5F;&#x6E56;&#x7684;MurmurHash</a> ,&#x53E6;&#x5916;&#x4E00;&#x7BC7;&#x662F;&#x5F20;&#x6D0B;&#x7684; <a href="http://blog.codinglabs.org/articles/consistent-hashing.html" target="_blank" rel="external">&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#x53CA;&#x5176;&#x5728;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x5E94;&#x7528;</a> &#x3002;&#x867D;&#x7136;&#x6211;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;memcached&#x7684;java&#x5BA2;&#x6237;&#x7AEF;spymemcached&#x597D;&#x51E0;&#x5E74;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x5B83;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#x7684;&#x7EC6;&#x8282;&#x4ECE;&#x6765;&#x6CA1;&#x6709;&#x4ED4;&#x7EC6;&#x7814;&#x7A76;&#x8FC7;&#x3002;&#x8D81;&#x6B64;&#x673A;&#x4F1A;&#xFF0C;&#x7279;&#x522B;&#x7684;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#x5B83;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x3002; </p>
<p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;Memcached&#x672C;&#x8EAB;&#x6CA1;&#x6709;&#x63D0;&#x4F9B;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4E00;&#x822C;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x5B9E;&#x73B0;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#xFF0C;&#x6839;&#x636E;Key&#x503C;&#x8BA1;&#x7B97;&#x51FA;&#x5E94;&#x8BE5;&#x5728;&#x54EA;&#x4E2A;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x5B58;&#x53D6;&#x3002;</p>
<h2 id="Ketama_Hash&#x7684;&#x5B9E;&#x73B0;">Ketama Hash&#x7684;&#x5B9E;&#x73B0;</h2><p>spymemcached&#x5B9E;&#x73B0;&#x4E86;&#x51E0;&#x79CD;Hash&#x7B97;&#x6CD5;&#xFF1A;NATIVE_HASH,CRC_HASH,FNV1_64_HASH,FNV1A_64_HASH,FNV1_32_HASH,FNV1A_32_HASH,KETAMA_HASH&#x3002;</p>
<p>&#x76F8;&#x6BD4;&#x8F83;&#x524D;&#x51E0;&#x4E2A;hash&#x7B97;&#x6CD5;&#xFF0C;KETAMA HASH&#x7B97;&#x6CD5;&#x53EF;&#x4EE5;&#x5C06;&#x670D;&#x52A1;&#x5668;&#x7684;&#x865A;&#x62DF;&#x8282;&#x70B9;&#x76F8;&#x5BF9;&#x5747;&#x5300;&#x7684;&#x5206;&#x5E03;&#x5230;&#x73AF;&#x4E0A;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;MD5&#x6563;&#x5217;&#x7684;Hash&#x7B97;&#x6CD5;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x7C7B;&#x662F;&#x6211;&#x7CBE;&#x7B80;&#x7684;spymemcached&#x7684;KetamaNodeLocator&#x7C7B;&#xFF0C;&#x7528;&#x6765;&#x6D4B;&#x8BD5;&#x751F;&#x6210;&#x7684;&#x865A;&#x62DF;&#x8282;&#x70B9;&#x7684;&#x5206;&#x5E03;&#x60C5;&#x51B5;,&#x5B83;&#x4F1A;&#x6253;&#x5370;&#x51FA;&#x4E24;&#x4E2A;&#x865A;&#x62DF;&#x8282;&#x70B9;&#x4E4B;&#x95F4;&#x7684;&#x95F4;&#x9694;&#x3002; &#x5982;&#x679C;&#x95F4;&#x9694;&#x6BD4;&#x8F83;&#x5747;&#x5300;&#xFF0C;&#x6211;&#x4EEC;&#x76F8;&#x4FE1;&#x4F7F;&#x7528;&#x540C;&#x6837;&#x7684;Hash&#x7B97;&#x6CD5;&#x8BA1;&#x7B97;&#x7684;key&#x503C;&#x5E94;&#x8BE5;&#x53EF;&#x4EE5;&#x5747;&#x5300;&#x7684;&#x843D;&#x5728;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x4E0A;&#x3002;</p>
<p>spymemcached&#x4E3A;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x8BA1;&#x7B97;&#x865A;&#x62DF;&#x8282;&#x70B9;&#x65F6;&#x4F7F;&#x7528; &#x8282;&#x70B9;&#x5730;&#x5740; + &quot;-i&quot;&#x683C;&#x5F0F;&#xFF0C; i&#x6700;&#x5927;&#x7684;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x865A;&#x62DF;&#x8282;&#x70B9;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;160&#x4E2A;&#x3002; </p>
<p> package com.colobu.consistenthashing; </p>
<p> import java.util.List; </p>
<p> import java.util.TreeMap; </p>
<p> public   class  Ketama  { </p>
<p> public TreeMap&lt;Long, Node&gt; hashNodes; </p>
<p> public HashAlgorithm hashAlgorithm; </p>
<p> protected  void  setKetamaNodes (List&lt;Node&gt; nodes) { </p>
<p>TreeMap&lt;Long, Node&gt; newNodeMap = new TreeMap&lt;Long, Node&gt;(); </p>
<p> int numReps = 160 ; </p>
<p> for (Node node : nodes) { </p>
<p> if (hashAlgorithm == HashAlgorithm.KETAMA_HASH) { </p>
<p> for ( int i = 0 ; i &lt; numReps / 4 ; i++) { </p>
<p> byte [] digest = HashAlgorithm.computeMd5(node.getName() + &quot;-&quot; + i); </p>
<p> for ( int h = 0 ; h &lt; 4 ; h++) { </p>
<p>Long k = (( long ) (digest[ 3 + h * 4 ] &amp; 0xFF ) &lt;&lt; 24 ) </p>
<p>| (( long ) (digest[ 2 + h * 4 ] &amp; 0xFF ) &lt;&lt; 16 ) </p>
<p>| (( long ) (digest[ 1 + h * 4 ] &amp; 0xFF ) &lt;&lt; 8 ) </p>
<p>| (digest[h * 4 ] &amp; 0xFF ); </p>
<p>newNodeMap.put(k, node);</p>
<p>}</p>
<p>}</p>
<p>} else { </p>
<p> for ( int i = 0 ; i &lt; numReps; i++) { </p>
<p>newNodeMap.put(hashAlgorithm.hash(node + &quot;-&quot; + i), node); </p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>hashNodes = newNodeMap;</p>
<p>}</p>
<p>}</p>
<p>&#x5199;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x7C7B;&#xFF0C;&#x770B;&#x770B;&#x865A;&#x62DF;&#x8282;&#x70B9;&#x7684;&#x5206;&#x5E03;&#x60C5;&#x51B5;&#xFF1A;</p>
<p> package com.colobu.consistenthashing; </p>
<p> import java.util.ArrayList; </p>
<p> import java.util.Iterator; </p>
<p> import java.util.List; </p>
<p> import java.util.Map.Entry; </p>
<p> public   class  Main  { </p>
<p> public  static  void  main (String[] args) { </p>
<p> //System.out.println(&quot;&#x6D4B;&#x8BD5; ketama hash&quot;);</p>
<p> //testKetama();</p>
<p> //System.out.println(&quot;\r\n\r\n&#x6D4B;&#x8BD5; native hash&quot;);</p>
<p> //testHash(HashAlgorithm.NATIVE_HASH);</p>
<p> //System.out.println(&quot;\r\n\r\n&#x6D4B;&#x8BD5; CRC hash&quot;); //max=32767</p>
<p> //testHash(HashAlgorithm.CRC_HASH);</p>
<p> //System.out.println(&quot;\r\n\r\n&#x6D4B;&#x8BD5; FNV1_64_HASH&quot;);</p>
<p> //testHash(HashAlgorithm.FNV1_64_HASH);</p>
<p> //System.out.println(&quot;\r\n\r\n&#x6D4B;&#x8BD5; FNV1A_64_HASH&quot;);</p>
<p> //testHash(HashAlgorithm.FNV1A_64_HASH);</p>
<p> //System.out.println(&quot;\r\n\r\n&#x6D4B;&#x8BD5; MurmurHash 32&quot;);</p>
<p> //testHash(HashAlgorithm.MurmurHash_32);</p>
<p>System.out.println( &quot;\r\n\r\n&#x6D4B;&#x8BD5; MurmurHash 64&quot; ); </p>
<p>testHash(HashAlgorithm.MurmurHash_64);</p>
<p>}</p>
<p> private  static  void  testHash (HashAlgorithm hash) { </p>
<p>Ketama ketama = new Ketama(); </p>
<p>ketama.hashAlgorithm = hash;</p>
<p>List&lt;Node&gt; nodes = new ArrayList&lt;&gt;(); </p>
<p> for ( int i= 0 ; i&lt; 10 ; i++) { </p>
<p>nodes.add( new Node( &quot;name-&quot; + i)); </p>
<p>}</p>
<p>ketama.setKetamaNodes(nodes);</p>
<p>Iterator&lt;Entry&lt;Long, Node&gt;&gt; it = ketama.hashNodes.entrySet().iterator();</p>
<p>Entry&lt;Long, Node&gt; prior = it.next();</p>
<p> while (it.hasNext()) { </p>
<p>Entry&lt;Long, Node&gt; current = it.next();</p>
<p>System.out.println( &quot;&#x95F4;&#x9694;&#xFF1A;&quot; + (current.getKey() - prior.getKey()) + &quot;=&quot; + current.getKey() + &quot;-&quot; + prior.getKey()); </p>
<p>prior = current;</p>
<p>}</p>
<p>}</p>
<p> private  static  void  testKetama () { </p>
<p>Ketama ketama = new Ketama(); </p>
<p>ketama.hashAlgorithm = HashAlgorithm.KETAMA_HASH;</p>
<p>List&lt;Node&gt; nodes = new ArrayList&lt;&gt;(); </p>
<p> for ( int i= 0 ; i&lt; 10 ; i++) { </p>
<p>nodes.add( new Node( &quot;name-&quot; + i)); </p>
<p>}</p>
<p>ketama.setKetamaNodes(nodes);</p>
<p>Iterator&lt;Entry&lt;Long, Node&gt;&gt; it = ketama.hashNodes.entrySet().iterator();</p>
<p>Entry&lt;Long, Node&gt; prior = it.next();</p>
<p> while (it.hasNext()) { </p>
<p>Entry&lt;Long, Node&gt; current = it.next();</p>
<p>System.out.println( &quot;&#x95F4;&#x9694;&#xFF1A;&quot; + (current.getKey() - prior.getKey())); </p>
<p>prior = current;</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>&#x5B9E;&#x9645;&#x7ED3;&#x679C;&#x770B;&#x5230;ketama&#x7B97;&#x6CD5;&#x8FD8;&#x662F;&#x4E0D;&#x9519;&#x7684;&#x3002;</p>
<h2 id="&#x52A0;&#x5165;MurmurHash&#x7B97;&#x6CD5;">&#x52A0;&#x5165;MurmurHash&#x7B97;&#x6CD5;</h2><p>&#x6C5F;&#x5357;&#x767D;&#x8863;&#x7684;&#x90A3;&#x7BC7;&#x6587;&#x7AE0;&#x4ECB;&#x7ECD;&#x4E86;MurmurHash&#x7B97;&#x6CD5;&#xFF0C;&#x5F00;&#x6E90;&#x4E2D;&#x56FD;&#x793E;&#x533A;&#x4E5F;&#x7FFB;&#x8BD1;&#x4E86;&#x4E00;&#x7BC7; <a href="http://www.oschina.net/translate/state-of-hash-functions" target="_blank" rel="external">Hash &#x51FD;&#x6570;&#x6982;&#x89C8;</a> &#x7684;&#x79D1;&#x666E;&#x6587;&#x7AE0;&#x3002; </p>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5C06;MurmurHash&#x7B97;&#x6CD5;&#x52A0;&#x5165;&#x5230;spymemcached&#x4F1A;&#x600E;&#x4E48;&#x6837;&#x5462;&#x3002;&#x6211;&#x6CA1;&#x6709;&#x6D4B;&#x8BD5;&#x5B83;&#x7684;&#x6027;&#x80FD;&#xFF0C;&#x4F46;&#x662F;&#x4ECE;&#x5206;&#x5E03;&#x4E0A;&#x6765;&#x770B;&#x8FD8;&#x662F;&#x4E0D;&#x9519;&#x7684;&#x3002;</p>
<p>&#x7F51;&#x4E0A;&#x6709;&#x51E0;&#x4E2A;MurmurHash&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5982; <a href="https://github.com/google/guava/blob/master/guava/src/com/google/common/hash/Murmur3_32HashFunction.java" target="_blank" rel="external">Guava</a> , <a href="https://github.com/apache/cassandra/blob/aa7c7362a94dd3da81ff521589cd2e6f998ae4c1/src/java/org/apache/cassandra/utils/MurmurHash.java" target="_blank" rel="external">Cassandra</a> &#x7B49;&#x3002;&#x6211;&#x4E0D;&#x60F3;&#x989D;&#x5916;&#x5F15;&#x5165;&#x7B2C;&#x4E09;&#x65B9;&#x7684;&#x5305;&#xFF0C;&#x6240;&#x4EE5;&#x76F4;&#x63A5;&#x590D;&#x5236;&#x4E86; <a href="http://d3s.mff.cuni.cz/~holub/sw/javamurmurhash/" target="_blank" rel="external">Viliam Holub&#x7684;&#x5B9E;&#x73B0;</a> &#x3002; </p>
<p>&#x5728;HashAlgorithm&#x7B97;&#x6CD5;&#x4E2D;&#x52A0;&#x5165;MurmurHash&#x679A;&#x4E3E;&#x7C7B;&#x578B;&#x3002;</p>
<p> package com.colobu.consistenthashing; </p>
<p> import java.security.MessageDigest; </p>
<p> import java.security.NoSuchAlgorithmException; </p>
<p> import java.util.zip.CRC32; </p>
<p> public  enum HashAlgorithm { </p>
<p> /**</p>
<ul>
<li>Native hash (String.hashCode()).</li>
</ul>
<p>*/</p>
<p>NATIVE_HASH,</p>
<p> /**</p>
<ul>
<li><p>CRC_HASH as used by the perl API. This will be more consistent both</p>
</li>
<li><p>across multiple API users as well as java versions, but is mostly likely</p>
</li>
<li><p>significantly slower.</p>
</li>
</ul>
<p>*/</p>
<p>CRC_HASH,</p>
<p> /**</p>
<ul>
<li><p>FNV hashes are designed to be fast while maintaining a low collision rate.</p>
</li>
<li><p>The FNV speed allows one to quickly hash lots of data while maintaining a</p>
</li>
<li><p>reasonable collision rate.</p>
</li>
</ul>
<p>*</p>
<ul>
<li><p>@see &lt;a href=&quot;<a href="http://www.isthe.com/chongo/tech/comp/fnv/&quot;&gt;fnv" target="_blank" rel="external">http://www.isthe.com/chongo/tech/comp/fnv/&quot;&gt;fnv</a> </p>
</li>
<li><p>comparisons&lt;/a&gt;</p>
</li>
<li><p>@see &lt;a href=&quot;<a href="http://en.wikipedia.org/wiki/Fowler_Noll_Vo_hash&quot;&gt;fnv" target="_blank" rel="external">http://en.wikipedia.org/wiki/Fowler_Noll_Vo_hash&quot;&gt;fnv</a> at </p>
</li>
<li><p>wikipedia&lt;/a&gt;</p>
</li>
</ul>
<p>*/</p>
<p>FNV1_64_HASH,</p>
<p> /**</p>
<ul>
<li>Variation of FNV.</li>
</ul>
<p>*/</p>
<p>FNV1A_64_HASH,</p>
<p> /**</p>
<ul>
<li>32-bit FNV1.</li>
</ul>
<p>*/</p>
<p>FNV1_32_HASH,</p>
<p> /**</p>
<ul>
<li>32-bit FNV1a.</li>
</ul>
<p>*/</p>
<p>FNV1A_32_HASH,</p>
<p>MurmurHash_32,</p>
<p>MurmurHash_64,</p>
<p> /**</p>
<ul>
<li>MD5-based hash algorithm used by ketama.</li>
</ul>
<p>*/</p>
<p>KETAMA_HASH;</p>
<p> private  static  final  long FNV_64_INIT = 0xcbf29ce484222325 L; </p>
<p> private  static  final  long FNV_64_PRIME = 0x100000001b3 L; </p>
<p> private  static  final  long FNV_32_INIT = 2166136261 L; </p>
<p> private  static  final  long FNV_32_PRIME = 16777619 ; </p>
<p> private  static MessageDigest md5Digest = null ; </p>
<p> static { </p>
<p> try { </p>
<p>md5Digest = MessageDigest.getInstance( &quot;MD5&quot; ); </p>
<p>} catch (NoSuchAlgorithmException e) { </p>
<p> throw  new RuntimeException( &quot;MD5 not supported&quot; , e); </p>
<p>}</p>
<p>}</p>
<p> /**</p>
<ul>
<li>Compute the hash for the given key.</li>
</ul>
<p>*</p>
<ul>
<li>@return a positive integer hash </li>
</ul>
<p>*/</p>
<p> public  long  hash ( final String k) { </p>
<p> long rv = 0 ; </p>
<p> int len = k.length(); </p>
<p> switch ( this ) { </p>
<p> case NATIVE_HASH: </p>
<p>rv = k.hashCode();</p>
<p> break ; </p>
<p> case CRC_HASH: </p>
<p> // return (crc32(shift) &gt;&gt; 16) &amp; 0x7fff;</p>
<p>CRC32 crc32 = new CRC32(); </p>
<p>crc32.update(k.getBytes());</p>
<p>rv = (crc32.getValue() &gt;&gt; 16 ) &amp; 0x7fff ; </p>
<p> break ; </p>
<p> case FNV1_64_HASH: </p>
<p> // Thanks to pierre@demartines.com for the pointer</p>
<p>rv = FNV_64_INIT;</p>
<p> for ( int i = 0 ; i &lt; len; i++) { </p>
<p>rv *= FNV_64_PRIME;</p>
<p>rv ^= k.charAt(i);</p>
<p>}</p>
<p> break ; </p>
<p> case FNV1A_64_HASH: </p>
<p>rv = FNV_64_INIT;</p>
<p> for ( int i = 0 ; i &lt; len; i++) { </p>
<p>rv ^= k.charAt(i);</p>
<p>rv *= FNV_64_PRIME;</p>
<p>}</p>
<p> break ; </p>
<p> case FNV1_32_HASH: </p>
<p>rv = FNV_32_INIT;</p>
<p> for ( int i = 0 ; i &lt; len; i++) { </p>
<p>rv *= FNV_32_PRIME;</p>
<p>rv ^= k.charAt(i);</p>
<p>}</p>
<p> break ; </p>
<p> case FNV1A_32_HASH: </p>
<p>rv = FNV_32_INIT;</p>
<p> for ( int i = 0 ; i &lt; len; i++) { </p>
<p>rv ^= k.charAt(i);</p>
<p>rv *= FNV_32_PRIME;</p>
<p>}</p>
<p> break ; </p>
<p> case MurmurHash_32: </p>
<p>rv = MurmurHash.hash32(k);</p>
<p> break ; </p>
<p> case MurmurHash_64: </p>
<p>rv = MurmurHash.hash64(k);</p>
<p> break ; </p>
<p> case KETAMA_HASH: </p>
<p> byte [] bKey = computeMd5(k); </p>
<p>rv = (( long ) (bKey[ 3 ] &amp; 0xFF ) &lt;&lt; 24 ) </p>
<p>| (( long ) (bKey[ 2 ] &amp; 0xFF ) &lt;&lt; 16 ) </p>
<p>| (( long ) (bKey[ 1 ] &amp; 0xFF ) &lt;&lt; 8 ) </p>
<p>| (bKey[ 0 ] &amp; 0xFF ); </p>
<p> break ; </p>
<p> default : </p>
<p> assert  false ; </p>
<p>}</p>
<p> return rv &amp; 0xffffffff L; /<em> Truncate to 32-bits </em>/</p>
<p>}</p>
<p> /**</p>
<ul>
<li>Get the md5 of the given key.</li>
</ul>
<p>*/</p>
<p> public  static  byte [] computeMd5 (String k) { </p>
<p>MessageDigest md5;</p>
<p> try { </p>
<p>md5 = (MessageDigest) md5Digest.clone();</p>
<p>} catch (CloneNotSupportedException e) { </p>
<p> throw  new RuntimeException( &quot;clone of MD5 not supported&quot; , e); </p>
<p>}</p>
<p>md5.update(k.getBytes());</p>
<p> return md5.digest(); </p>
<p>}</p>
<p>}</p>
<p>&#x5B9E;&#x9645;&#x7ED3;&#x679C;&#x770B;MurmurHash&#x4E5F;&#x662F;&#x76F8;&#x5F53;&#x7684;&#x5747;&#x5300;&#x3002;</p>
<h2 id="xmemcached&#x7684;&#x5B9E;&#x73B0;">xmemcached&#x7684;&#x5B9E;&#x73B0;</h2><p>xmemcached&#x662F;&#x53E6;&#x5916;&#x4E00;&#x4E2A;memcached java&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x4E86;&#x7C7B;&#x4F3C;spymemcached&#x7684;hash&#x7B97;&#x6CD5;&#x3002;&#x53EA;&#x4E0D;&#x8FC7;&#x589E;&#x52A0;&#x4E86;&#x51E0;&#x79CD;&#x65B0;&#x7684;hash&#x7B97;&#x6CD5;&#xFF1A;MYSQL_HASH,ELF_HASH,RS_HASH,LUA_HASH,ONE_AT_A_TIME&#x3002;</p>
<h2 id="Twemproxy">Twemproxy</h2><p>&#x662F;&#x4E00;&#x4E2A;Memcahced&#x7684;&#x7F51;&#x5173;&#x7A0B;&#x5E8F;&#x3002; &#x5B83;&#x5B9E;&#x73B0;&#x4E86;&#x4E0B;&#x9762;&#x51E0;&#x79CD;Hash&#x7B97;&#x6CD5;&#x3002;</p>
<ul>
<li>one_at_a_time</li>
<li>md5</li>
<li>crc16</li>
<li>crc32 (crc32 implementation compatible with libmemcached)</li>
<li>crc32a (correct crc32 implementation as per the spec)</li>
<li>fnv1_64</li>
<li>fnv1a_64</li>
<li>fnv1_32</li>
<li>fnv1a_32</li>
<li>hsieh</li>
<li>murmur</li>
<li>jenkins</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Java/">Java</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/算法/">算法</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/23c1b1b/" title="Linux c 开发 - Memcached源码分析之HashTable（4） -" itemprop="url">Linux c 开发 - Memcached源码分析之HashTable（4） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:37.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x8BB2;&#x89E3;&#x4E86;Memcached&#x7684;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x673A;&#x5236;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x6D88;&#x606F;&#x56DE;&#x5E94;&#xFF08;3&#xFF09;&#x300B;&#x3002;&#x4ECE;&#x8FD9;&#x4E00;&#x7AE0;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x6162;&#x6162;&#x8BB2;&#x89E3;Memcached&#x662F;&#x5982;&#x4F55;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x3002;</p>
<p>&#x8BB2;&#x89E3;&#x672C;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E2A;Memcached&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;item&#x7684;&#x57FA;&#x672C;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code><span class="xml">//item&amp;#x7684;&amp;#x5177;&amp;#x4F53;&amp;#x7ED3;&amp;#x6784;  
typedef struct _stritem </span><span class="expression">{  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">next</span>;  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;,&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;<span class="variable">freelist</span>&amp;<span class="begin-block">#x</span>94<span class="variable">FE</span>;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">prev</span>;  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;<span class="variable">HashTable</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">Item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;  
    <span class="variable">struct</span> _<span class="variable">stritem</span> *<span class="variable">h</span>_<span class="variable">next</span>;  
    //&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>1;&amp;<span class="begin-block">#x</span>8<span class="variable">BBF</span>;&amp;<span class="begin-block">#x</span>95<span class="variable">EE</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">set</span><span class="end-block">/add</span><span class="end-block">/replace</span>&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>66<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>57;&amp;<span class="begin-block">#x</span>6<span class="variable">BB</span>5;  
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6267;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;<span class="variable">flush</span>&amp;<span class="begin-block">#x</span>547<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>4;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>76<span class="variable">F</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">BD</span>4;&amp;<span class="begin-block">#x</span>8<span class="variable">F</span>83;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>5931;&amp;<span class="begin-block">#x</span>6548;  
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">time</span>;       /* <span class="variable">least</span> <span class="variable">recent</span> <span class="variable">access</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>13;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>671<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>95<span class="variable">F</span>4;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>38;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>45;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>6548;&amp;<span class="begin-block">#x</span>3002;  
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">Memcached</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BBE</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">F</span>6<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;0&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;<span class="variable">LRU</span>&amp;<span class="begin-block">#x</span>6<span class="variable">DD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>70;  
    <span class="variable">rel</span>_<span class="variable">time</span>_<span class="variable">t</span>      <span class="variable">exptime</span>;    /* <span class="variable">expire</span> <span class="variable">time</span> *<span class="end-block">/  </span>
    /<span class="end-block">/value</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>0<span class="variable">F</span>;  
    <span class="variable">int</span>             <span class="variable">nbytes</span>;     /* <span class="variable">size</span> <span class="variable">of</span> <span class="variable">data</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>3002;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>15;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#xFFFD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>83;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>3002;  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;<span class="variable">refcount</span>&amp;<span class="begin-block">#x</span>6765;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>53;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5426;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>6709;<span class="variable">refcount</span> <span class="variable">-</span>1 = 0&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>624<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>88<span class="variable">AB</span>;&amp;<span class="begin-block">#x</span>5220;&amp;<span class="begin-block">#x</span>9664;  
    <span class="variable">unsigned</span> <span class="variable">short</span>  <span class="variable">refcount</span>;  
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nsuffix</span>;    /* <span class="variable">length</span> <span class="variable">of</span> <span class="variable">flags-and-length</span> <span class="variable">string</span> *<span class="end-block">/  </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">it</span>_<span class="variable">flags</span>;   /* <span class="variable">ITEM</span>_* <span class="variable">above</span> *<span class="end-block">/  </span>
    /<span class="end-block">/slabs</span>_<span class="variable">class</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">ID</span>&amp;<span class="begin-block">#x</span>3002;  
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">slabs</span>_<span class="variable">clsid</span>;/* <span class="variable">which</span> <span class="variable">slab</span> <span class="variable">class</span> <span class="variable">we</span>&amp;<span class="variable">apos</span>;<span class="variable">re</span> <span class="variable">in</span> *<span class="end-block">/  </span>
    <span class="variable">uint</span>8_<span class="variable">t</span>         <span class="variable">nkey</span>;       /* <span class="variable">key</span> <span class="variable">length</span>, <span class="variable">w</span><span class="end-block">/terminating null and padding </span>*<span class="end-block">/  </span>
    /* <span class="variable">this</span> <span class="variable">odd</span> <span class="variable">type</span> <span class="variable">prevents</span> <span class="variable">type-punning</span> <span class="variable">issues</span> <span class="variable">when</span> <span class="variable">we</span> <span class="variable">do</span> 
     * <span class="variable">the</span> <span class="variable">little</span> <span class="variable">shuffle</span> <span class="variable">to</span> <span class="variable">save</span> <span class="variable">space</span> <span class="variable">when</span> <span class="variable">not</span> <span class="variable">using</span> <span class="variable">CAS.</span> *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    <span class="variable">union</span> {  
        <span class="variable">uint</span>64_<span class="variable">t</span> <span class="variable">cas</span>;  
        <span class="variable">char</span> <span class="variable">end</span>;  
    }</span><span class="xml"> data[];  
    /* if it_flags &amp;amp; ITEM_CAS we have 8 bytes CAS */  
    /* then null-terminated key */  
    /* then &amp;quot; flags length\r\n&amp;quot; (no terminating null) */  
    /* then data with terminating \r\n (no terminating null; it&amp;apos;s binary!) */  
} item;</span>
</code></pre><p>&#x8BF4;&#x660E;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x4E0A;&#x5B58;&#x50A8;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x90FD;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;Item&#x7684;&#x7ED3;&#x6784;&#x3002;</p>
</li>
<li><p>Item&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x8BB0;&#x5F55;&#x4E0E;HashTable&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4EE5;&#x53CA;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;slabs_class&#xFF08;&#x540E;&#x9762;&#x51E0;&#x7AE0;&#x8282;&#x4F1A;&#x8BB2;&#x89E3;&#xFF09;&#x7684;&#x5173;&#x7CFB;&#x4EE5;&#x53CA;key&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x548C;&#x957F;&#x5EA6;&#x7B49;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>Item&#x5757;&#x4F1A;&#x88AB;&#x5206;&#x914D;&#x5728;slabclass&#x4E0A;&#xFF0C;slabclass&#x4F1A;&#x5728;&#x4E0B;&#x4E0B;&#x7AE0;&#x8282;&#x4E2D;&#x8BE6;&#x7EC6;&#x8BB2;&#x89E3;&#x3002;</p>
</li>
<li><p>HashTable&#x7684;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#xFF1A;&#x7528;&#x4E8E;&#x901A;&#x8FC7;key&#x5FEB;&#x901F;&#x67E5;&#x8BE2;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</p>
</li>
</ol>
<p>Memcached&#x7684;HashTable&#x6E90;&#x7801;&#x5206;&#x6790;</p>
<p>HashTable&#x7ED3;&#x6784;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/23c0040.jpg" alt=""></p>
<p>&#x8BF4;&#x660E;&#xFF1A;</p>
<ol>
<li><p>Memcached&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x9ED8;&#x8BA4;&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;HashTable&#xFF0C;&#x8FD9;&#x4E2A;table&#x7684;&#x9ED8;&#x8BA4;&#x957F;&#x5EA6;&#x4E3A;65536&#x3002;</p>
</li>
<li><p>&#x6211;&#x4EEC;&#x5C06;&#x8FD9;&#x4E2A;HashTable&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x79F0;&#x4E3A;&#x6876;&#xFF0C;&#x6BCF;&#x4E2A;&#x6876;&#x5C31;&#x662F;&#x4E00;&#x4E2A;item&#x7ED3;&#x6784;&#x7684;&#x5355;&#x5411;&#x94FE;&#x8868;&#x3002;</p>
</li>
<li><p>Memcached&#x4F1A;&#x5C06;key&#x503C;hash&#x6210;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x540D;&#x79F0;&#x4E3A;hv&#x7684;uint32_t&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;hv&#x4E0E;&#x6876;&#x7684;&#x4E2A;&#x6570;&#x4E4B;&#x95F4;&#x7684;&#x6309;&#x4F4D;&#x4E0E;&#x8BA1;&#x7B97;&#xFF0C;hv &amp; hashmask(hashpower)&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x7684;key&#x4F1A;&#x843D;&#x5728;&#x54EA;&#x4E2A;&#x6876;&#x4E0A;&#x9762;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x4F1A;&#x5C06;item&#x6302;&#x5230;&#x8FD9;&#x4E2A;&#x6876;&#x7684;&#x94FE;&#x8868;&#x4E0A;&#x9762;&#x3002;&#x94FE;&#x8868;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;item&#x7ED3;&#x6784;&#x4E2D;&#x7684;h_next&#x5B9E;&#x73B0;&#x3002;</p>
</li>
</ol>
<p>item_get - &#x7EE7;&#x7EED;&#x4ECE;get&#x65B9;&#x6CD5;&#x8BF4;&#x8D77;</p>
<p>&#x7ED3;&#x5408;&#x7B2C;&#x4E8C;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;Memcached get&#x7684;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;key &#x54C8;&#x5E0C;&#x6210;&#x4E00;&#x4E2A;uint32_t&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002;</p>
</li>
<li><p>&#x8C03;&#x7528;do_item_get&#x65B9;&#x6CD5;&#x3002;</p>
<p> //&#x8FD9;&#x8FB9;&#x7684;item_<em>&#x7CFB;&#x5217;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x662F;Memcached&#x6838;&#x5FC3;&#x5B58;&#x50A8;&#x5757;&#x7684;&#x63A5;&#x53E3;<br> item </em>item_get(const char *key, const size_t nkey) {  </p>
<pre><code>item *it;  
uint32_t hv;  
hv = hash(key, nkey); //&amp;<span class="symbol">#x5BF9</span>;key&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;hash,&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;uint32_t&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;  
item_lock(hv); //&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x9501</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5141</span>;&amp;<span class="symbol">#x8BB8</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x4ED6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x5B50</span>;&amp;<span class="symbol">#x6027</span>;  
it = do_item_get(key, nkey, hv);  
item_unlock(hv);  
return it;  
</code></pre><p> }</p>
</li>
</ol>
<p>&#x7EE7;&#x7EED;&#x770B;do_item_get&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x67E5;&#x8BE2;HashTable&#x4E0A;&#x7684;Item</p>
<pre><code><span class="comment">/** wrapper around assoc_find which does the lazy expiration logic */</span>  
item *do_item_get(<span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">size_t</span> nkey, <span class="keyword">const</span> <span class="keyword">uint32_t</span> hv) {  
    <span class="comment">//mutex_lock(&amp;amp;cache_lock);  </span>
    item *it = assoc_find(key, nkey, hv); <span class="comment">//hashTable&amp;#x4E0A;&amp;#x5B58;&amp;#x50A8;Item  </span>
    <span class="comment">//....more code  </span>
}
</code></pre><p>assoc.c - assoc_init &#x521D;&#x59CB;&#x5316;HashTable</p>
<p>&#x5F53;&#x6211;&#x4EEC;&#x8FDB;&#x5165;assoc_find&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x540E;&#xFF0C;&#x53D1;&#x73B0;HashTable&#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x5728;assoc.c&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<ol>
<li><p>assoc_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3A;HashTable&#x521D;&#x59CB;&#x5316;&#xFF0C;assoc_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x5165;&#x53E3;&#x51FD;&#x6570;main&#x4E2D;&#x521D;&#x59CB;&#x5316;&#x7684;&#x3002;</p>
</li>
<li><p>HashTable&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x4E3A;16&#xFF0C;1 &lt;&lt; 16&#x540E;&#x5F97;&#x5230;65536&#x4E2A;&#x6876;&#x3002;&#x5982;&#x679C;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x8BBE;&#x7F6E;&#xFF0C;&#x8BBE;&#x7F6E;&#x503C;&#x5728;12-64&#x4E4B;&#x95F4;&#x3002;</p>
</li>
<li><p>&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;memcached&#x7684;&#x6876;&#x7684;&#x4E2A;&#x6570;&#x8DB3;&#x591F;&#x4F7F;&#x7528;&#x4E86;&#x3002;</p>
<p> //&#x521D;&#x59CB;&#x5316;HahsTable&#x8868;<br> void assoc_init(const int hashtable_init) {  </p>
<pre><code>//&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>; hashtable_init&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">12</span> &amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">64</span>  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hashtable_init&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;hashpower&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">16</span>  
if (hashtable_init) {  
    hashpower = hashtable_init;  
}  
//primary_hashtable&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">HashTable</span>  
//hashsize&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hashpower=<span class="number">16</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">65536</span>  
primary_hashtable = calloc(hashsize(hashpower), sizeof(void *));  
if (! primary_hashtable) {  
    fprintf(stderr, &amp;quot;<span class="class">Failed</span> to init hashtable.\n&amp;quot;);  
    exit(<span class="class">EXIT_FAILURE</span>);  
}  
<span class="class">STATS_LOCK</span>();  
stats.hash_power_level = hashpower;  
stats.hash_bytes = hashsize(hashpower) * sizeof(void *);  
<span class="class">STATS_UNLOCK</span>();  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_find &#x67E5;&#x627E;&#x4E00;&#x4E2A;Item</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x904D;&#x5386;&#x6876;&#x7684;&#x5355;&#x94FE;&#x8868;&#xFF0C;&#x6BD4;&#x8F83;key&#x503C;&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;item</p>
<p> //&#x5BFB;&#x627E;&#x4E00;&#x4E2A;Item<br> item <em>assoc_find(const char </em>key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item *it;  
unsigned int oldbucket;  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;...  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    it = old_hashtable[oldbucket];  
} else {  
    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    it = primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
}  
item *ret = <span class="class">NULL</span>;  
int depth = <span class="number">0</span>; //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6DF1</span>;&amp;<span class="symbol">#x5EA6</span>;  
while (it) {  
    //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;list&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>  
    if ((nkey == it-&amp;gt;nkey) &amp;amp;&amp;amp; (memcmp(key, <span class="class">ITEM_key</span>(it), nkey) == <span class="number">0</span>)) {  
        ret = it;  
        break;  
    }  
    it = it-&amp;gt;h_next;  
    ++depth;  
}  
<span class="class">MEMCACHED_ASSOC_FIND</span>(key, nkey, depth);  
return ret;  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_insert &#x65B0;&#x589E;&#x4E00;&#x4E2A;Item</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x7136;&#x540E;&#x5C06;item&#x653E;&#x5230;&#x5BF9;&#x5E94;&#x6876;&#x7684;&#x5355;&#x94FE;&#x8868;&#x7684;&#x5934;&#x90E8;</p>
</li>
<li><p>&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x6269;&#x5BB9;&#xFF0C;&#x5982;&#x679C;&#x6269;&#x5BB9;&#xFF0C;&#x5219;&#x4F1A;&#x5728;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x3002;&#xFF08;&#x6876;&#x7684;&#x4E2A;&#x6570;(&#x9ED8;&#x8BA4;&#xFF1A;65536) * 3&#xFF09; / 2</p>
<p> //&#x65B0;&#x589E;Item&#x64CD;&#x4F5C;<br> int assoc_insert(item *it, const uint32_t hv) {  </p>
<pre><code>unsigned int oldbucket;  
assert(assoc_find(<span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) == <span class="number">0</span>);  /* shouldn&amp;apos;t have duplicately named things defined */  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5E8F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x65E7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    it-&amp;gt;h_next = old_hashtable[oldbucket];  
    old_hashtable[oldbucket] = it;  
} else {  
    //hv &amp;amp; hashmask(hashpower) &amp;<span class="symbol">#x6309</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E0E</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x9762</span>;  
    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;item-&amp;gt;h_next &amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;  
    it-&amp;gt;h_next = primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
    //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;hashtable&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9996</span>;&amp;<span class="symbol">#x9875</span>;<span class="class">Item</span>&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x503C</span>;  
    primary_hashtable[hv &amp;amp; hashmask(hashpower)] = it;  
}  
hash_items++; //&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;hash_items&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;  &amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;(&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">65536</span>) * <span class="number">3</span>&amp;<span class="symbol">#xFF09</span>; / <span class="number">2</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
//&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x8EAB</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5FC5</span>;&amp;<span class="symbol">#x987B</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4F30</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x8017</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x957F</span>;  
if (! expanding &amp;amp;&amp;amp; hash_items &amp;gt; (hashsize(hashpower) * <span class="number">3</span>) / <span class="number">2</span>) {  
    assoc_start_expand();  
}  
<span class="class">MEMCACHED_ASSOC_INSERT</span>(<span class="class">ITEM_key</span>(it), it-&amp;gt;nkey, hash_items);  
return <span class="number">1</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - assoc_delete &#x5220;&#x9664;item&#x64CD;&#x4F5C;</p>
<ol>
<li><p>&#x9996;&#x5148;&#x901A;&#x8FC7;key&#x7684;hash&#x503C;hv&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6876;&#x3002;</p>
</li>
<li><p>&#x627E;&#x5230;&#x6876;&#x5BF9;&#x5E94;&#x7684;&#x94FE;&#x8868;&#xFF0C;&#x904D;&#x5386;&#x5355;&#x94FE;&#x8868;&#xFF0C;&#x5220;&#x9664;&#x5BF9;&#x5E94;&#x7684;Item&#x3002;</p>
<p> //&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5BFB;&#x627E;<br> static item<em>* _hashitem_before (const char </em>key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item **pos;  
unsigned int oldbucket;  
//&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (expanding &amp;amp;&amp;amp;  
    (oldbucket = (hv &amp;amp; hashmask(hashpower - <span class="number">1</span>))) &amp;gt;= expand_bucket)  
{  
    pos = &amp;amp;old_hashtable[oldbucket];  
} else {  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
    pos = &amp;amp;primary_hashtable[hv &amp;amp; hashmask(hashpower)];  
}  
//&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x6876</span>;&amp;<span class="symbol">#x7684</span>;list&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5339</span>;&amp;<span class="symbol">#x914D</span>;key&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">Item</span>  
while (*pos &amp;amp;&amp;amp; ((nkey != (*pos)-&amp;gt;nkey) || memcmp(key, <span class="class">ITEM_key</span>(*pos), nkey))) {  
    pos = &amp;amp;(*pos)-&amp;gt;h_next;  
}  
return pos;  
</code></pre><p> }<br> //&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x6876;&#x4E0A;&#x7684;Item<br> void assoc_delete(const char *key, const size_t nkey, const uint32_t hv) {  </p>
<pre><code>item **before = _hashitem_before(key, nkey, hv); //&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x8BE2</span>;<span class="class">Item</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">Item</span>&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Item</span>&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">Item</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
if (*before) {  
    item *nxt;  
    hash_items--; //item&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x51CF</span>;&amp;<span class="symbol">#x53BB</span>;<span class="number">1</span>  
    /* <span class="class">The</span> <span class="class">DTrace</span> probe cannot be triggered as the last instruction 
     * due to possible tail-optimization by the compiler 
     */  
    <span class="class">MEMCACHED_ASSOC_DELETE</span>(key, nkey, hash_items);  
    nxt = (*before)-&amp;gt;h_next;  
    (*before)-&amp;gt;h_next = <span class="number">0</span>;   /* probably pointless, but whatever. */  
    *before = nxt;  
    return;  
}  
/* <span class="class">Note</span>:  we never actually get here.  the callers don&amp;apos;t delete things 
   they can&amp;apos;t find. */  
assert(*before != <span class="number">0</span>);  
</code></pre><p> }</p>
</li>
</ol>
<p>assoc.c - &#x5173;&#x4E8E;&#x6269;&#x5BB9;</p>
<p>Memcached&#x7684;&#x6269;&#x5BB9;&#x90FD;&#x662F;&#x5728;&#x5355;&#x72EC;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x7684;&#x3002;</p>
<p>&#xFF08;&#x6876;&#x7684;&#x4E2A;&#x6570;(&#x9ED8;&#x8BA4;&#xFF1A;65536) * 3&#xFF09; / 2&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x6269;&#x5BB9;&#x3002;&#x6269;&#x5BB9;&#x9700;&#x8981;&#x7684;&#x65F6;&#x95F4;&#x6BD4;&#x8F83;&#x4E45;&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x7EBF;&#x7A0B;&#x8FDB;&#x884C;&#x81EA;&#x52A8;&#x6269;&#x5BB9;&#x5904;&#x7406;&#x3002;</p>
<pre><code>static void assoc_start_expand<span class="params">(void)</span> {  
    <span class="keyword">if</span> <span class="params">(started_expanding)</span>  
        return;  
    started_expanding = <span class="literal">true</span>;  
    <span class="comment">//&amp;#x5524;&amp;#x9192;&amp;#x7EBF;&amp;#x7A0B;  </span>
    pthread_cond_signal<span class="params">(&amp;amp;maintenance_cond)</span>;  
}  
<span class="comment">/* grows the hashtable to the next power of 2. */</span>  
<span class="comment">//&amp;#x6269;&amp;#x5BB9;&amp;#x65B9;&amp;#x6CD5;  </span>
static void assoc_expand<span class="params">(void)</span> {  
    old_hashtable = primary_hashtable;  
    primary_hashtable = calloc<span class="params">(hashsize<span class="params">(hashpower + <span class="number">1</span>)</span>, sizeof<span class="params">(void *)</span>)</span>;  
    <span class="keyword">if</span> <span class="params">(primary_hashtable)</span> {  
        <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">1</span>)</span>  
            fprintf<span class="params">(stderr, &amp;quot;Hash table expansion starting\n&amp;quot;)</span>;  
        hashpower++;  
        expanding = <span class="literal">true</span>;  
        expand_bucket = <span class="number">0</span>;  
        STATS_LOCK<span class="params">()</span>;  
        stats.hash_power_level = hashpower;  
        stats.hash_bytes += hashsize<span class="params">(hashpower)</span> <span class="built_in">*</span> sizeof<span class="params">(void *)</span>;  
        stats.hash_is_expanding = <span class="number">1</span>;  
        STATS_UNLOCK<span class="params">()</span>;  
    } <span class="keyword">else</span> {  
        primary_hashtable = old_hashtable;  
        <span class="comment">/* Bad news, but we can keep running. */</span>  
    }  
}  
static volatile int do_run_maintenance_thread = <span class="number">1</span>;  
<span class="built_in">#</span>define DEFAULT_HASH_BULK_MOVE <span class="number">1</span>  
int hash_bulk_move = DEFAULT_HASH_BULK_MOVE;  
static void <span class="built_in">*</span>assoc_maintenance_thread<span class="params">(void *arg)</span> {  
    while <span class="params">(do_run_maintenance_thread)</span> {  
        int ii = <span class="number">0</span>;  
        <span class="comment">/* Lock the cache, and bulk move multiple buckets to the new 
         * hash table. */</span>  
        item_lock_global<span class="params">()</span>;  
        mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
        <span class="keyword">for</span> <span class="params">(ii = <span class="number">0</span>; ii &amp;lt; hash_bulk_move &amp;amp;&amp;amp; expanding; ++ii)</span> {  
            item <span class="built_in">*</span>it, <span class="built_in">*</span>next;  
            int bucket;  
            <span class="keyword">for</span> <span class="params">(it = old_hashtable[expand_bucket]; NULL != it; it = next)</span> {  
                next = it-&amp;gt;h_next;  
                bucket = hash<span class="params">(ITEM_key<span class="params">(it)</span>, it-&amp;gt;nkey)</span> &amp;amp; hashmask<span class="params">(hashpower)</span>;  
                it-&amp;gt;h_next = primary_hashtable[bucket];  
                primary_hashtable[bucket] = it;  
            }  
            old_hashtable[expand_bucket] = NULL;  
            expand_bucket++;  
            <span class="keyword">if</span> <span class="params">(expand_bucket == hashsize<span class="params">(hashpower - <span class="number">1</span>)</span>)</span> {  
                expanding = <span class="literal">false</span>;  
                free<span class="params">(old_hashtable)</span>;  
                STATS_LOCK<span class="params">()</span>;  
                stats.hash_bytes -= hashsize<span class="params">(hashpower - <span class="number">1</span>)</span> <span class="built_in">*</span> sizeof<span class="params">(void *)</span>;  
                stats.hash_is_expanding = <span class="number">0</span>;  
                STATS_UNLOCK<span class="params">()</span>;  
                <span class="keyword">if</span> <span class="params">(settings.verbose &amp;gt; <span class="number">1</span>)</span>  
                    fprintf<span class="params">(stderr, &amp;quot;Hash table expansion done\n&amp;quot;)</span>;  
            }  
        }  
        mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        item_unlock_global<span class="params">()</span>;  
        <span class="keyword">if</span> <span class="params">(!expanding)</span> {  
            <span class="comment">/* finished expanding. tell all threads to use fine-grained locks */</span>  
            switch_item_lock_type<span class="params">(ITEM_LOCK_GRANULAR)</span>;  
            slabs_rebalancer_resume<span class="params">()</span>;  
            <span class="comment">/* We are done expanding.. just wait for next invocation */</span>  
            mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
            started_expanding = <span class="literal">false</span>;  
            pthread_cond_wait<span class="params">(&amp;amp;maintenance_cond, &amp;amp;cache_lock)</span>;  
            <span class="comment">/* Before doing anything, tell threads to use a global lock */</span>  
            mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
            slabs_rebalancer_pause<span class="params">()</span>;  
            switch_item_lock_type<span class="params">(ITEM_LOCK_GLOBAL)</span>;  
            mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
            assoc_expand<span class="params">()</span>;  
            mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
        }  
    }  
    return NULL;  
}  
static pthread_t maintenance_tid;  
int start_assoc_maintenance_thread<span class="params">()</span> {  
    int ret;  
    char <span class="built_in">*</span>env = getenv<span class="params">(&amp;quot;MEMCACHED_HASH_BULK_MOVE&amp;quot;)</span>;  
    <span class="keyword">if</span> <span class="params">(env != NULL)</span> {  
        hash_bulk_move = atoi<span class="params">(env)</span>;  
        <span class="keyword">if</span> <span class="params">(hash_bulk_move == <span class="number">0</span>)</span> {  
            hash_bulk_move = DEFAULT_HASH_BULK_MOVE;  
        }  
    }  
    <span class="keyword">if</span> <span class="params">(<span class="params">(ret = pthread_create<span class="params">(&amp;amp;maintenance_tid, NULL,  
                              assoc_maintenance_thread, NULL)</span>)</span> != <span class="number">0</span>)</span> {  
        fprintf<span class="params">(stderr, &amp;quot;Can&amp;apos;t create thread: %s\n&amp;quot;, strerror<span class="params">(ret)</span>)</span>;  
        return -<span class="number">1</span>;  
    }  
    return <span class="number">0</span>;  
}  
void stop_assoc_maintenance_thread<span class="params">()</span> {  
    mutex_lock<span class="params">(&amp;amp;cache_lock)</span>;  
    do_run_maintenance_thread = <span class="number">0</span>;  
    pthread_cond_signal<span class="params">(&amp;amp;maintenance_cond)</span>;  
    mutex_unlock<span class="params">(&amp;amp;cache_lock)</span>;  
    <span class="comment">/* Wait for the maintenance thread to stop */</span>  
    pthread_join<span class="params">(maintenance_tid, NULL)</span>;  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/16/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/61/">61</a><a class="extend next" rel="next" href="/page/18/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>606</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>10</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
