
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="edwin jin dianzi blog">
<meta property="og:type" content="website">
<meta property="og:title" content="dianzi blog">
<meta property="og:url" content="http://taojinke.github.io/page/16/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="edwin jin dianzi blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dianzi blog">
<meta name="twitter:description" content="edwin jin dianzi blog">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/279241b/" title="【转】 Key/Value之王Memcached初探：三、Memcached解决Session的分布式存储场景的应用 -" itemprop="url">【转】 Key/Value之王Memcached初探：三、Memcached解决Session的分布式存储场景的应用 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:44.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="&#x4E00;&#x3001;&#x9AD8;&#x53EF;&#x7528;&#x7684;Session&#x670D;&#x52A1;&#x5668;&#x573A;&#x666F;&#x7B80;&#x4ECB;">&#x4E00;&#x3001;&#x9AD8;&#x53EF;&#x7528;&#x7684;Session&#x670D;&#x52A1;&#x5668;&#x573A;&#x666F;&#x7B80;&#x4ECB;</h2><h2 id="1-1_&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x7684;&#x65E0;&#x72B6;&#x6001;&#x7279;&#x6027;">1.1 &#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x7684;&#x65E0;&#x72B6;&#x6001;&#x7279;&#x6027;</h2><p>&#x5E94;&#x7528;&#x5C42;&#x670D;&#x52A1;&#x5668;&#xFF08;&#x8FD9;&#x91CC;&#x4E00;&#x822C;&#x6307;Web&#x670D;&#x52A1;&#x5668;&#xFF09;&#x5904;&#x7406;&#x7F51;&#x7AD9;&#x5E94;&#x7528;&#x7684;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#xFF0C;&#x5E94;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x6700;&#x663E;&#x8457;&#x7684;&#x7279;&#x70B9;&#x662F;&#xFF1A; <strong>&#x5E94;&#x7528;&#x7684;&#x65E0;&#x72B6;&#x6001;&#x6027;</strong> &#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2781c6f.png" alt=""></p>
<p>PS&#xFF1A;&#x63D0;&#x5230;&#x65E0;&#x72B6;&#x6001;&#x7279;&#x6027;&#xFF0C;&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#x4E0B; <strong>Http&#x534F;&#x8BAE;</strong> &#x3002;&#x6211;&#x4EEC;&#x5E38;&#x5E38;&#x542C;&#x5230;&#x8BF4;&#xFF0C;Http&#x662F;&#x4E00;&#x4E2A;&#x65E0;&#x72B6;&#x6001;&#x534F;&#x8BAE;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x7684;&#x8FDE;&#x7EED;&#x4E24;&#x4E2A;&#x8BF7;&#x6C42;&#x4E92;&#x76F8;&#x4E0D;&#x4E86;&#x89E3;&#xFF0C;&#x4ED6;&#x4EEC;&#x7531;&#x6700;&#x65B0;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x73AF;&#x5883;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x9664;&#x4E86;&#x5E94;&#x7528;&#x672C;&#x8EAB;&#x53EF;&#x80FD;&#x5DF2;&#x7ECF;&#x5B58;&#x50A8;&#x5728;&#x5168;&#x5C40;&#x5BF9;&#x8C61;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x4FE1;&#x606F;&#x5916;&#xFF0C;&#x8BE5;&#x73AF;&#x5883;&#x4E0D;&#x4FDD;&#x5B58;&#x4E0E;&#x4F1A;&#x8BDD;&#x6709;&#x5173;&#x7684;&#x4EFB;&#x4F55;&#x4FE1;&#x606F;&#x3002;&#x4E4B;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5728;&#x4F7F;&#x7528;ASP.NET WebForm&#x5F00;&#x53D1;&#x4E2D;&#x4F1A;&#x611F;&#x89C9;&#x4E0D;&#x5230;Http&#x7684;&#x65E0;&#x72B6;&#x6001;&#x7279;&#x6027;&#xFF0C;&#x5B8C;&#x5168;&#x662F;&#x56E0;&#x4E3A;Microsoft&#x5E2E;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86; <strong>ViewState</strong> &#xFF0C;&#x5B83;&#x662F;ASP.NET WebForm&#x4E2D;&#x4FDD;&#x5B58;&#x9875;&#x9762;&#x4FE1;&#x606F;&#x7684;&#x57FA;&#x672C;&#x5355;&#x4F4D;&#xFF0C;&#x672C;&#x8D28;&#x662F;&#x4E00;&#x4E2A;HTML&#x4E2D;&#x7684;&#x9690;&#x85CF;&#x57DF;&#xFF0C;&#x56DE;&#x8C03;&#x65F6;&#x4F1A;&#x5C06;&#x8FD9;&#x4E2A;&#x9690;&#x85CF;&#x57DF;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x63D0;&#x4EA4;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x3002;&#xA0; </p>
<p>&#x5728;&#x5F88;&#x591A;&#x573A;&#x666F;&#x4E2D;&#xFF0C;&#x7528;&#x6237;&#x90FD;&#x9700;&#x8981;&#x548C;&#x6211;&#x4EEC;&#x7684;&#x7F51;&#x7AD9;&#x7CFB;&#x7EDF;&#x8FDB;&#x884C;&#x591A;&#x6B21;&#x7684;&#x4FE1;&#x606F;&#x4EA4;&#x4E92;&#xFF0C;&#x8FD9;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFFFD;&#xFFFD;&#xFFFD;&#x514B;&#x670D;&#x65E0;&#x72B6;&#x6001;&#x7279;&#x6027;&#x6240;&#x5E26;&#x6765;&#x7684;&#x56F0;&#x5883;&#x3002;&#x8FD8;&#x597D;&#xFF0C;&#x5728;&#x5DE8;&#x4EBA;&#x7684;&#x80A9;&#x8180;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x5F88;&#x597D;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x90A3;&#x5C31;&#x662F; <strong>&#x6D4F;&#x89C8;&#x5668;&#x7AEF;&#x7684;Cookie</strong> &#x548C; <strong>&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;Session</strong> &#x3002;&#x5728;&#x4E00;&#x822C;&#x7684;&#x5355;&#x673A;&#x5F00;&#x53D1;&#x4E2D;&#xFF08;&#x8FD9;&#x91CC;&#x4E00;&#x822C;&#x662F;&#x6307;&#x53EA;&#x6709;&#x4E00;&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x7684;&#x60C5;&#x51B5;&#xFF09;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x6211;&#x4EEC;&#x901A;&#x5E38;&#x4F7F;&#x7528;Session&#x6765;&#x5B58;&#x50A8;&#x7528;&#x6237;&#x767B;&#x5F55;&#x72B6;&#x6001;&#xFF08;&#x4E00;&#x822C;&#x662F;&#x4E00;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#xFF09;&#xFF0C;&#x5728;&#x591A;&#x6570;&#x7684;&#x7BA1;&#x7406;&#x4FE1;&#x606F;&#x7CFB;&#x7EDF;&#x5F00;&#x53D1;&#x4E2D;&#xFF08;&#x6BD5;&#x7ADF;&#x5185;&#x90E8;&#x7CFB;&#x7EDF;&#x7528;&#x6237;&#x91CF;&#x4E0D;&#x591A;&#xFF0C;&#x4E00;&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x65E2;&#x63D0;&#x4F9B;Web&#x670D;&#x52A1;&#x53C8;&#x5B58;&#x50A8;Session&#x5BF9;&#x8C61;&#x5185;&#x5B58;&#x8FD8;&#x7B97;&#x662F;&#x591F;&#x7528;&#x7684;&#xFF09;&#x8FD9;&#x662F;&#x5F88;&#x5E38;&#x89C1;&#x7684;&#x3002; </p>
<p>&#x4F46;&#x662F;&#xFF0C;&#x5728;&#x5927;&#x7528;&#x6237;&#x91CF;&#x4E0B;&#xFF0C;&#x5355;&#x673A;&#x7248;&#x7684;Session&#x5C31;&#x4F1A;&#x663E;&#x5F97;&#x6548;&#x7387;&#x4F4E;&#x4E0B;&#xFF0C;&#x751A;&#x81F3;&#x4F1A;&#x62D6;&#x7D2F;Web&#x670D;&#x52A1;&#x5668;&#x7684;&#x6027;&#x80FD;&#x3002;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#xFF1A;&#x6BCF;&#x4E2A;&#x7528;&#x6237;&#x7684;Http&#x8BF7;&#x6C42;&#x53D1;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x540E;&#xFF0C;&#x6BCF;&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x7684;&#x670D;&#x52A1;&#x5668;&#x8F6F;&#x4EF6;&#xFF08;&#x4F8B;&#x5982;&#xFF1A;IIS&#x3001;Tomcat&#x7B49;&#xFF09;&#x90FD;&#x4F1A;&#x4E3A;&#x8BE5;&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6765;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x548C;&#x54CD;&#x5E94;&#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x6BD5;&#x7ADF;&#x662F;&#x6709;&#x9650;&#x7684;&#xFF08;&#x8FD9;&#x4E2A;&#x6839;&#x636E;&#x670D;&#x52A1;&#x5668;&#x7684;&#x914D;&#x7F6E;&#x800C;&#x5B9A;&#xFF0C;&#x4F8B;&#x5982;CPU&#x4E2D;i3&#x3001;i5&#x548C;i7&#x7C7B;&#x578B;&#x5206;&#x522B;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x7684;&#x7EBF;&#x7A0B;&#x6570;&#x90FD;&#x5404;&#x4E0D;&#x76F8;&#x540C;&#xFF09;&#xFF0C;&#x5F53;&#x67D0;&#x4E2A;&#x65F6;&#x95F4;&#x6BB5;&#x51FA;&#x73B0;&#x9AD8;&#x5E76;&#x53D1;&#x8BF7;&#x6C42;&#x6570;&#x7684;&#x65F6;&#x5019;&#xFF08;&#x6BD4;&#x5982;&#xFF1A;&#x7F51;&#x8D2D;&#x79D2;&#x6740;&#x7CFB;&#x7EDF;&#x4E2D;&#x7ECF;&#x5E38;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x4F1A;&#x51FA;&#x73B0;&#x6D77;&#x91CF;&#x7684;&#x5E76;&#x53D1;&#x6570;&#xFF09;&#xFF0C;&#x90A3;&#x8FD9;&#x53F0;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x5C06;&#x4F1A;&#x63A5;&#x6536;&#x524D;&#x6240;&#x672A;&#x6709;&#x7684;&#x8BF7;&#x6C42;&#x8D1F;&#x8F7D;&#xFF0C;&#x6700;&#x7EC8;&#x53EF;&#x80FD;&#x4F1A;&#x56E0;&#x4E3A;&#x627F;&#x53D7;&#x4E0D;&#x4E86;&#x9AD8;&#x8D1F;&#x8F7D;&#x800C;&#x5BFC;&#x81F4;&#x5B95;&#x673A;&#xFF0C;&#x7F51;&#x7AD9;&#x4E0D;&#x5F97;&#x4E0D;&#x505C;&#x6B62;&#x670D;&#x52A1;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/2781ee0.jpg" alt=""></p>
<p>&#x8FD9;&#x65F6;&#xFF0C;&#x53C8;&#x60F3;&#x8D77;&#x4E86;&#x90A3;&#x53E5;&#x8BDD;&#xFF1A; &#x5F53;&#x4E00;&#x5934;&#x725B;&#x62C9;&#x4E0D;&#x52A8;&#x8F66;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x8981;&#x53BB;&#x5BFB;&#x627E;&#x4E00;&#x5934;&#x66F4;&#x5F3A;&#x58EE;&#x7684;&#x725B;&#xFF0C;&#x800C;&#x662F;&#x7528;&#x4E24;&#x5934;&#x725B;&#x6765;&#x62C9;&#x8F66; &#x3002;&#x4E8E;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x91C7;&#x7528;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;&#x6280;&#x672F;&#x6765;&#x5BF9;Web&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x6539;&#x8FDB;&#xFF0C;&#x589E;&#x52A0;N&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x90E8;&#x7F72;&#x76F8;&#x540C;&#x7684;Web&#x5E94;&#x7528;&#x6784;&#x6210;Web&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x6765;&#x5BF9;&#x5916;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF0C;&#x901A;&#x8FC7;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x8BBE;&#x5907;&#x6216;&#x8F6F;&#x4EF6;&#x5C06;&#x6D77;&#x91CF;&#x7684;&#x5E76;&#x53D1;&#x8BF7;&#x6C42;&#x6570;&#x5E73;&#x5747;&#x5730;&#x5206;&#x644A;&#x5230;&#x6BCF;&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;&#x5047;&#x8BBE;&#x67D0;&#x7CFB;&#x7EDF;&#x5728;&#x4FC3;&#x9500;&#x6D3B;&#x52A8;&#x671F;&#x95F4;&#x540C;&#x4E00;&#x65F6;&#x523B;&#x6D8C;&#x5165;&#x4E86;10&#x4E07;&#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x800C;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x4E2D;&#x6709;5&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x540C;&#x65F6;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#xFF0C;&#x8FD9;&#x65F6;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x8BBE;&#x5907;&#x5C31;&#x5C06;&#x8FD9;&#x4E2A;10&#x4E07;&#x8BF7;&#x6C42;&#x901A;&#x8FC7;&#x67D0;&#x79CD;&#x7B97;&#x6CD5;&#x8F83;&#x4E3A;&#x5747;&#x8861;&#x5730;&#x5206;&#x914D;&#x7ED9;&#x5176;&#xFFFD;&#xFFFD;&#xFFFD;&#x7684;Web&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5E73;&#x5747;&#x4E0B;&#x6765;&#x6BCF;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x6700;&#x591A;&#x5C31;&#x53EA;&#x627F;&#x62C5;2&#x4E07;&#x4E2A;&#x8BF7;&#x6C42;&#x3002; </p>
<p>&#x901A;&#x8FC7;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#xFF0C;&#x5DF2;&#x7ECF;&#x8F83;&#x597D;&#x5730;&#x89E3;&#x51B3;&#x4E86;&#x8BF7;&#x6C42;&#x8D1F;&#x8F7D;&#x95EE;&#x9898;&#xFF0C;&#x8FD9;&#x65F6;&#x65B0;&#x7684;&#x95EE;&#x9898;&#x53C8;&#x6765;&#x4E86;&#xFF1A;&#x7531;&#x4E8E;Session&#x9ED8;&#x8BA4;&#x662F;&#x5C5E;&#x4E8E;&#x8FDB;&#x7A0B;&#x5185;&#xFF08;InProc&#xFF09;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5B83;&#x662F;&#x5B58;&#x50A8;&#x5728;Web&#x670D;&#x52A1;&#x5668;&#x7684;&#x5185;&#x5B58;&#x91CC;&#x8FB9;&#x7684;&#x3002;&#x5F53;&#x6784;&#x5EFA;&#x597D;&#x96C6;&#x7FA4;&#x4E4B;&#x540E;&#xFF0C;&#x7528;&#x6237;&#x7684;Session&#x4F1A;&#x5EFA;&#x7ACB;&#x5728;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x8BBE;&#x5907;&#x6240;&#x5206;&#x914D;&#x7684;&#x5176;&#x4E2D;&#x4E00;&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x91CC;&#x8FB9;&#x3002;&#x4F46;&#x662F;&#x5F53;&#x7528;&#x6237;&#x4E0B;&#x4E00;&#x6B21;&#x8BBF;&#x95EE;&#x6216;&#x8005;&#x8BBF;&#x95EE;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x5176;&#x4ED6;&#x5B50;&#x7CFB;&#x7EDF;&#xFF08;&#x6BD4;&#x5982;&#xFF1A;&#x6211;&#x9996;&#x5148;&#x5728;&#x767E;&#x5EA6;&#x767E;&#x79D1;&#x8FDB;&#x884C;&#x767B;&#x5F55;&#x4E86;&#xFF0C;&#x7136;&#x540E;&#x8BBF;&#x95EE;&#x767E;&#x5EA6;&#x8D34;&#x5427;&#xFF09;&#xFF0C;&#x7531;&#x4E8E;Session&#x4F1A;&#x8BDD;&#x8FD8;&#x5B58;&#x50A8;&#x5728;&#x4E0A;&#x4E00;&#x6B21;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;Web&#x670D;&#x52A1;&#x5668;&#x91CC;&#x8FB9;&#xFF0C;&#x7CFB;&#x7EDF;&#x6821;&#x9A8C;&#x89C4;&#x5219;&#xFF08;&#x73B0;&#x5728;&#x8FD9;&#x53F0;Web&#x670D;&#x52A1;&#x5668;&#x91CC;&#x8FB9;&#x68C0;&#x6D4B;&#x5230;&#x6CA1;&#x6709;&#x8BE5;&#x7528;&#x6237;&#x7684;Session&#xFF09;&#x4F1A;&#x9020;&#x6210;&#x7528;&#x6237;&#x7684;&#x91CD;&#x590D;&#x767B;&#x5F55;&#xFF08;&#x6BD4;&#x5982;&#xFF1A;&#x90FD;&#x662F;&#x5728;&#x767E;&#x5EA6;&#x7684;&#x7F51;&#x9875;&#xFF0C;&#x5B83;&#x5374;&#x8BA9;&#x4F60;&#x767B;&#x5F55;&#x597D;&#x51E0;&#x6B21;&#xFF0C;&#x4F60;&#x723D;&#x5417;&#xFF1F;&#x5F88;&#x660E;&#x663E;&#xFF0C;&#x4E0D;&#x723D;&#x5427;&#xFF09;&#x3002;&#x8FD9;&#x65F6;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x89E3;&#x51B3;Web&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;Session&#x7BA1;&#x7406;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x770B;&#x770B;&#x5982;&#x4F55;&#x8FDB;&#x884C;Web&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;Session&#x7BA1;&#x7406;&#x3002;</p>
<h2 id="1-2_&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;Session&#x7BA1;&#x7406;">1.2 &#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;Session&#x7BA1;&#x7406;</h2><p>&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x6765;&#x770B;&#x770B;&#x5728;&#x96C6;&#x7FA4;&#x73AF;&#x5883;&#x4E2D;&#xFF0C;Session&#x7BA1;&#x7406;&#x7684;&#x51E0;&#x79CD;&#x5E38;&#x89C1;&#x624B;&#x6BB5;&#xFF1A;</p>
<p>&#x2460;Session&#x590D;&#x5236;&#xFF1A;&#x8BE5;&#x65B9;&#x6848;&#x7B80;&#x5355;&#x6613;&#x884C;&#xFF0C;&#x96C6;&#x7FA4;&#x4E2D;&#x7684;&#x51E0;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x540C;&#x6B65;Session&#x5BF9;&#x8C61;&#xFF0C;&#x4EFB;&#x4F55;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x5B95;&#x673A;&#x90FD;&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;Session&#x5BF9;&#x8C61;&#x7684;&#x4E22;&#x5931;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4E5F;&#x53EA;&#x9700;&#x8981;&#x4ECE;&#x672C;&#x673A;&#x83B7;&#x53D6;&#x5373;&#x53EF;&#x3002;&#x4F46;&#x662F;&#xFF0C; &#x8BE5;&#x65B9;&#x6848;&#x53EA;&#x9002;&#x5408;&#x96C6;&#x7FA4;&#x89C4;&#x6A21;&#x8F83;&#x5C0F;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x3002;&#x5F53;&#x89C4;&#x6A21;&#x8F83;&#x5927;&#x65F6;&#xFF0C;&#x5927;&#x91CF;&#x7684;Session&#x590D;&#x5236;&#x64CD;&#x4F5C;&#x4F1A;&#x5360;&#x7528;&#x670D;&#x52A1;&#x5668;&#x548C;&#x7F51;&#x7EDC;&#x7684;&#x5927;&#x91CF;&#x8D44;&#x6E90;&#xFF0C;&#x7CFB;&#x7EDF;&#x4E0D;&#x582A;&#x91CD;&#x8D1F; &#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2781ee0.jpg" alt=""></p>
<p>&#x2461;Session&#x7ED1;&#x5B9A;&#xFF1A;&#x5229;&#x7528;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684; <strong>&#x6E90;&#x5730;&#x5740;Hash</strong> &#x7B97;&#x6CD5;&#xFF0C;&#x603B;&#x662F;&#x5C06;&#x6E90;&#x4E8E;&#x540C;&#x4E00;IP&#x5730;&#x5740;&#x7684;&#x8BF7;&#x6C42;&#x5206;&#x53D1;&#x5230;&#x540C;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;&#x8FD9;&#x6837;&#x7684;&#x8BDD;&#xFF0C;&#x5728;&#x6574;&#x4E2A;&#x4F1A;&#x8BDD;&#x671F;&#x95F4;&#xFF0C;&#x7528;&#x6237;&#x6240;&#x6709;&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x5728;&#x540C;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x5373;Session&#x7ED1;&#x5B9A;&#x5728;&#x67D0;&#x53F0;&#x7279;&#x5B9A;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF0C;&#x4FDD;&#x8BC1;Session&#x603B;&#x80FD;&#x5728;&#x8FD9;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x83B7;&#x53D6;&#x3002;&#xFF08;&#x8FD9;&#x79CD;&#x65B9;&#x6848;&#x53C8;&#x53EB;&#x505A; <strong>&#x4F1A;&#x8BDD;&#x7C98;&#x6EDE;</strong> &#xFF09;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2782151.jpg" alt=""></p>
<p>&#x4F46;&#x662F;&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x6848; <strong><em>&#x4E0D;&#x7B26;&#x5408;&#x9AD8;&#x53EF;&#x7528;&#x7684;&#x9700;&#x6C42;</em></strong> &#x3002;&#x56E0;&#x4E3A;&#x4E00;&#x65E6;&#x67D0;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x5B95;&#x673A;&#xFF0C;&#x90A3;&#x4E48;&#x8BE5;&#x673A;&#x5668;&#x4E0A;&#x5F97;Session&#x4E5F;&#x5C31;&#x4E0D;&#x590D;&#x5B58;&#x5728;&#x4E86;&#xFF0C;&#x7528;&#x6237;&#x8BF7;&#x6C42;&#x5207;&#x6362;&#x5230;&#x5176;&#x4ED6;&#x673A;&#x5668;&#x540E;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;Session&#x800C;&#x65E0;&#x6CD5;&#x5B8C;&#x6210;&#x4E1A;&#x52A1;&#x5904;&#x7406;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x5F88;&#x5C11;&#x6709;&#x7F51;&#x7AD9;&#x91C7;&#x7528;&#x6B64;&#x65B9;&#x6848;&#x8FDB;&#x884C;Session&#x7BA1;&#x7406;&#x3002; </p>
<p>&#x2462;Cookie&#x8BB0;&#x5F55;Session&#xFF1A;&#x5229;&#x7528;&#x6D4F;&#x89C8;&#x5668;&#x652F;&#x6301;&#x7684;Cookie&#x8BB0;&#x5F55;Session&#x7B80;&#x5355;&#x6613;&#x884C;&#xFF0C;&#x53EF;&#x7528;&#x6027;&#x9AD8;&#xFF0C;&#x5E76;&#x4E14;&#x652F;&#x6301;&#x670D;&#x52A1;&#x5668;&#x7684;&#x7EBF;&#x6027;&#x4F38;&#x7F29;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x8BB8;&#x591A;&#x7F51;&#x7AD9;&#x90FD;&#x6216;&#x591A;&#x6216;&#x5C11;&#x5730;&#x4F7F;&#x7528;&#x4E86;Cookie&#x6765;&#x8BB0;&#x5F55;Session&#x3002;&#x4F46;&#x662F;Cookie&#x8BB0;&#x5F55;Session&#x6709;&#x7F3A;&#x70B9;&#xFF1A;&#x6BD4;&#x5982;&#x53D7;Cookie&#x5927;&#x5C0F;&#x9650;&#x5236;&#x3001;&#x6BCF;&#x6B21;&#x8BF7;&#x6C42;&#x54CD;&#x5E94;&#x90FD;&#x8981;&#x4F20;&#x8F93;Cookie&#x5F71;&#x54CD;&#x6027;&#x80FD;&#x3001;&#x7528;&#x6237;&#x5173;&#x95ED;&#x4E86;Cookie&#x4F1A;&#x9020;&#x6210;&#x8BBF;&#x95EE;&#x4E0D;&#x6B63;&#x5E38;&#x7B49;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/27823c2.jpg" alt=""></p>
<p>&#x2463; <strong>Session&#x670D;&#x52A1;&#x5668;</strong> &#xFF1A;&#x5229;&#x7528;&#x72EC;&#x7ACB;&#x90E8;&#x7F72;&#x7684;Session&#x670D;&#x52A1;&#x5668;&#xFF08;&#x96C6;&#x7FA4;&#xFF09;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;Session&#xFF0C;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x6BCF;&#x6B21;&#x8BFB;&#x5199;Session&#x65F6;&#xFF0C;&#x90FD;&#x8BBF;&#x95EE;Session&#x670D;&#x52A1;&#x5668;&#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x6848; <strong>&#x5B9E;&#x9645;&#x4E0A;&#x662F; &#x5C06;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x7684;&#x72B6;&#x6001;&#x5206;&#x79BB;</strong> &#xFF0C;&#x5206;&#x4E3A; <strong>&#x65E0;&#x72B6;&#x6001;&#x7684;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;</strong> &#x548C; <strong>&#x6709;&#x72B6;&#x6001;&#x7684;Session&#x670D;&#x52A1;&#x5668;</strong> &#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2782633.jpg" alt=""></p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;&#x51E0;&#x79CD;&#x65B9;&#x5F0F;&#x6765;&#x770B;&#xFF0C;&#x5404;&#x6709;&#x5229;&#x5F0A;&#xFF0C;&#x4F46;Session&#x670D;&#x52A1;&#x5668;&#x662F;&#x6700;&#x7B26;&#x5408;&#x9AD8;&#x53EF;&#x7528;&#x9700;&#x6C42;&#x7684;&#x65B9;&#x6848;&#xFF0C;&#x4E5F;&#x662F;&#x4F01;&#x4E1A;&#x4E2D;&#x7ECF;&#x5E38;&#x7528;&#x5230;&#x7684;&#x65B9;&#x6848;&#x3002;&#x90A3;&#x4E48;&#xFF0C;&#x5BF9;&#x4E8E;&#x6709;&#x72B6;&#x6001;&#x7684;Session&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4E00;&#x79CD;&#x8F83;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5229;&#x7528; <strong>&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;</strong> &#xFF08;&#x5982;Memcached&#x3001;Redis&#x7B49;&#xFF0C;&#x6709;&#x5173;Redis&#x7684;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x53EF;&#x4EE5;&#x9605;&#x8BFB;&#x6211;&#x7684;&#x535A;&#x6587;&#xFF1A; <a href="http://www.cnblogs.com/edisonchou/p/3821228.html" target="_blank" rel="external">NoSQL&#x521D;&#x63A2;&#x4E4B;&#x4EBA;&#x4EBA;&#x90FD;&#x7231;Redis</a> &#xFF09;&#x3001; <strong>&#x6570;&#x636E;&#x5E93;</strong> &#x7B49;&#xFF0C;&#x5728;&#x8FD9;&#x4E9B;&#x4EA7;&#x54C1;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x8FDB;&#x884C;&#x5C01;&#x88C5;&#xFF0C;&#x4F7F;&#x5176;&#x7B26;&#x5408;Session&#x7684;&#x5B58;&#x50A8;&#x548C;&#x8BBF;&#x95EE;&#x8981;&#x6C42;&#x3002;&#x7EFC;&#x5408;&#x4E0A;&#x8FF0;&#x4ECB;&#x7ECD;&#xFF0C;&#x6211;&#x4EEC;&#x4ECA;&#x5929;&#x5C31;&#x91C7;&#x7528;Memcached&#x6765;&#x6784;&#x5EFA;&#x6211;&#x4EEC;&#x7684;Session&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x89E3;&#x51B3;Web&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x7684;Session&#x7684;&#x5171;&#x4EAB;&#x8BBF;&#x95EE;&#x3002; </p>
<p>PS&#xFF1A;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x91C7;&#x7528;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x65B9;&#x6848;&#x800C;&#x4E0D;&#x91C7;&#x7528;&#x6570;&#x636E;&#x5E93;&#x6765;&#x5B58;&#x50A8;Session&#xFF1F;&#x8FD9;&#x4E2A;&#x5C31;&#x5F97;&#x8981;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x7684;&#x6027;&#x80FD;&#x74F6;&#x9888;&#x4E86;&#xFF0C;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;&#x78C1;&#x76D8;IO&#x8BFB;&#x5199;&#x7684;&#x901F;&#x5EA6;&#x662F;&#x6700;&#x6162;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x6570;&#x636E;&#x5E93;&#x6570;&#x636E;&#x5176;&#x5B9E;&#x662F;&#x5B58;&#x50A8;&#x5728;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#xFF0C;&#x867D;&#x7136;&#x76EE;&#x524D;&#x5927;&#x591A;&#x6570;&#x7684;&#x6570;&#x636E;&#x5E93;&#x90FD;&#x91C7;&#x7528;&#x4E86;B+&#x6811;&#x7ED3;&#x6784;&#xFF0C;&#x8BFB;&#x53D6;&#x4E00;&#x6761;&#x6570;&#x636E;&#x6700;&#x591A;&#x90FD;&#x8FD8;&#x662F;&#x9700;&#x8981;4&#x6B21;&#x7684;&#x6570;&#x636E;&#x8BFB;&#x5199;&#xFF08;&#x4E09;&#x6B21;&#x78C1;&#x76D8;&#x8BBF;&#x95EE;&#x83B7;&#x5F97;&#x6570;&#x636E;&#x7D22;&#x5F15;&#x53CA;&#x884C;ID&#xFF0C;&#x4E00;&#x6B21;&#x6570;&#x636E;&#x6587;&#x4EF6;&#x8BFB;&#x64CD;&#x4F5C;&#xFF0C;&#x7EC8;&#x4E8E;&#x77E5;&#x9053;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x591A;&#x9EBB;&#x70E6;&#x4E86;&#xFF09;&#x3002;&#x800C;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x4F8B;&#x5982;Memcached&#x662F;&#x4EE5;Key/Value&#x8FD9;&#x79CD;&#x7B80;&#x5355;&#x7684;&#x5F62;&#x5F0F;&#x5B58;&#x50A8;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5185;&#x5B58;&#x91CC;&#x8FB9;&#x7684;&#xFF0C;&#x5185;&#x5B58;&#x7684;&#x968F;&#x673A;&#x8BFB;&#x5199;&#x901F;&#x5EA6;&#x662F;&#x5B8C;&#x7206;&#x78C1;&#x76D8;IO&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5185;&#x7F51;+&#x5185;&#x5B58;&#x7684;&#x53CC;&#x5185;&#x6A21;&#x5F0F;&#x662F;&#x6BD4;&#x8F83;&#x5B8C;&#x7F8E;&#x7684;&#x65B9;&#x6848;&#x3002; </p>
<p>&#x78C1;&#x76D8;&#x53C8;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF1A;</p>
<p>&#x2460;&#x673A;&#x68B0;&#x786C;&#x76D8;&#xFF1A; &#x901A;&#x8FC7;&#x9A6C;&#x8FBE;&#x9A71;&#x52A8;&#x78C1;&#x5934;&#x81C2;&#xFF0C;&#x5E26;&#x52A8;&#x78C1;&#x5934;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x78C1;&#x76D8;&#x4F4D;&#x7F6E;&#x8BBF;&#x95EE;&#x6570;&#x636E; &#x3002;&#x5B83;&#x80FD;&#x591F;&#x5B9E;&#x73B0; <strong>&#x5FEB;&#x901F;&#x987A;&#x5E8F;&#x8BFB;&#x5199;&#xFF0C;&#x6162;&#x901F;&#x968F;&#x673A;&#x8BFB;&#x5199;</strong> &#x3002; </p>
<p>&#x2461;&#x56FA;&#x6001;&#x786C;&#x76D8;&#xFF08;&#x53C8;&#x79F0;SSD&#xFF09;&#xFF1A; <strong>&#x65E0;&#x673A;&#x68B0;&#x88C5;&#x7F6E;&#xFF0C;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5728;&#x53EF;&#x6301;&#x4E45;&#x8BB0;&#x5FC6;&#x7684;&#x7845;&#x6676;&#x4F53;&#x4E0A;</strong> &#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x50CF;&#x5185;&#x5B58;&#x4E00;&#x6837; <strong>&#x5FEB;&#x901F;&#x968F;&#x673A;&#x8BBF;&#x95EE;</strong> &#x3002; </p>
<p>&#x5728;&#x76EE;&#x524D;&#x7684;&#x7F51;&#x7AD9;&#x5E94;&#x7528;&#x4E2D;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x5E94;&#x7528;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x90FD;&#x662F;&#x968F;&#x673A;&#x7684;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;SSD&#x5177;&#x6709;&#x66F4;&#x597D;&#x7684;&#x6027;&#x80FD;&#x8868;&#x73B0;&#xFF0C;&#x4F46;&#x662F;&#x6027;&#x4EF7;&#x6BD4;&#x6709;&#x5F85;&#x63D0;&#x5347;&#xFF08;&#x86EE;&#x8D35;&#x7684;&#xFF0C;&#x4E48;&#x4E48;&#x55D2;&#xFF09;&#x3002;</p>
<h2 id="&#x4E8C;&#x3001;Memcached&#x5B9E;&#x73B0;Session&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5B58;&#x50A8;">&#x4E8C;&#x3001;Memcached&#x5B9E;&#x73B0;Session&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5B58;&#x50A8;</h2><h2 id="2-0_&#x6848;&#x4F8B;&#x603B;&#x4F53;&#x9884;&#x89C8;">2.0 &#x6848;&#x4F8B;&#x603B;&#x4F53;&#x9884;&#x89C8;</h2><p>&#xFF08;1&#xFF09;&#x6A21;&#x62DF;&#x7684;&#x767B;&#x5F55;&#x6848;&#x4F8B;&#x573A;&#x666F;</p>
<p>&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;ASP.NET&#x7684;&#x4FE1;&#x606F;&#x7CFB;&#x7EDF;&#xFF0C;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x7CFB;&#x7EDF;&#x767B;&#x5F55;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x7528;&#x6237;&#x767B;&#x5F55;&#xFF0C;&#x767B;&#x9646;&#x540E;&#x9ED8;&#x8BA4;&#x8DF3;&#x8F6C;&#x5230;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x4E3B;&#x9875;&#xFF0C;&#x5E76;&#x663E;&#x793A;&#xFF1A;&#x6B22;&#x8FCE;&#x60A8;&#xFF0C;{&#x7528;&#x6237;&#x8D26;&#x53F7;&#x540D;&#x79F0;}&#x3002;</p>
<p>&#x2460;&#x7CFB;&#x7EDF;&#x767B;&#x5F55;&#x9875;&#x9762;&#x6548;&#x679C;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2782ff7.jpg" alt=""></p>
<p>&#x2461;&#x7528;&#x6237;&#x4E3B;&#x9875;&#x6548;&#x679C;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2783268.jpg" alt=""></p>
<p>&#xFF08;2&#xFF09;&#x6A21;&#x62DF;&#x7684;&#x6280;&#x672F;&#x4F53;&#x7CFB;&#x9009;&#x62E9;</p>
<p>ASP.Net MVC+EF Code First+MySQL+Memcached</p>
<h2 id="2-1_&#x521D;&#x59CB;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;">2.1 &#x521D;&#x59CB;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;</h2><p>&#xFF08;1&#xFF09;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;ASP.NET MVC4&#x7684;&#x7A7A;&#x9879;&#x76EE;&#xFF0C;&#x89C6;&#x56FE;&#x5F15;&#x64CE;&#x9009;&#x62E9;&#x4E3A;&#x201C;Razor&#x201D;&#x5373;&#x53EF;&#xFF1B;</p>
<p>&#xFF08;2&#xFF09;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#x201C;Lib&#x201D;&#xFF0C;&#x4E3B;&#x8981;&#x5B58;&#x653E;&#x4E00;&#x4E9B;&#x5FC5;&#x8981;&#x7684;DLL&#x6587;&#x4EF6;&#xFF1B;</p>
<p><img src="http://taojinke.github.io/img/20150703/2783268.jpg" alt=""></p>
<p>&#xFF08;3&#xFF09;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x6DFB;&#x52A0;&#x5BF9;&#x8FD9;&#x51E0;&#x4E2A;DLL&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x5F15;&#x5165;EntityFramework.dll&#x662F;&#x4E3A;&#x4E86;&#x652F;&#x6301;&#x540E;&#x9762;&#x7684;CodeFirst&#x5F00;&#x53D1;&#x65B9;&#x5F0F;&#xFF0C;EF&#x7248;&#x672C;&#x5FC5;&#x987B;&#x5728;4.1&#x53CA;&#x4EE5;&#x4E0A;&#x3002;PS&#xFF1A;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Package Manager&#x6765;&#x5B89;&#x88C5;EntityFramework&#x3002;&#x5230;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x5C31;&#x505A;&#x597D;&#x4E86;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x6B63;&#x5F0F;&#x7684;&#x5DE5;&#x4F5C;&#x4E86;&#x3002;</p>
<h2 id="2-2_&#x501F;&#x52A9;EF_CodeFirst&#xFFFD;&#xFFFD;&#xFFFD;&#x6210;MySQL&#x6570;&#x636E;&#x5E93;">2.2 &#x501F;&#x52A9;EF CodeFirst&#xFFFD;&#xFFFD;&#xFFFD;&#x6210;MySQL&#x6570;&#x636E;&#x5E93;</h2><p>&#x9996;&#x5148;&#xFF0C;EF&#x662F;&#x4E00;&#x79CD; <strong>ORM</strong> &#xFF08;Object-relational mapping&#xFF09;&#x6846;&#x67B6;&#xFF0C;&#x5B83;&#x80FD;&#x628A;&#x6211;&#x4EEC;&#x5728;&#x7F16;&#x7A0B;&#x65F6;&#x4F7F;&#x7528;&#x5BF9;&#x8C61;&#x6620;&#x5C04;&#x5230;&#x5E95;&#x5C42;&#x7684;&#x6570;&#x636E;&#x5E93;&#x7ED3;&#x6784;&#x3002;ORM&#x6846;&#x67B6;&#x8D1F;&#x8D23;&#x628A;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x4F20;&#x56DE;&#x7684;&#x8BB0;&#x5F55;&#x96C6;&#x8F6C;&#x6362;&#x4E3A;&#x5BF9;&#x8C61;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F9D;&#x636E;&#x5BF9;&#x8C61;&#x5F53;&#x524D;&#x6240;&#x5904;&#x7684;&#x5177;&#x4F53;&#x72B6;&#x6001;&#x751F;&#x6210;&#x76F8;&#x5E94;&#x7684;SQL&#x547D;&#x4EE4;&#x53D1;&#x7ED9;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5B8C;&#x6210;&#x6570;&#x636E;&#x7684;&#x5B58;&#x53D6;&#x5DE5;&#x4F5C;&#xFF08;&#x5E38;&#x89C1;&#x7684;&#x6570;&#x636E;&#x5B58;&#x53D6;&#x64CD;&#x4F5C;&#x53EF;&#x7B80;&#x79F0;&#x4E3A;CRUD&#xFF1A;Create&#x3001;Read&#x3001;Update&#x3001;Delete&#xFF09;&#x3002; </p>
<p>EF&#x7ED9;&#x6570;&#x636E;&#x5E93;&#x5E94;&#x7528;&#x7CFB;&#x7EDF;&#x5F00;&#x53D1;&#x5E26;&#x6765;&#x4E86; <strong>&#x66F4;&#x9AD8;&#x7684;&#x6548;&#x7387;</strong> &#xFF0C;&#x4F7F;&#x7528;&#x5B83;&#x80FD;&#x66F4;&#x5BB9;&#x6613;&#x5730;&#x5199;&#x51FA;&#x6613;&#x7EF4;&#x62A4;&#x3001;&#x6613;&#x6269;&#x5C55;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x800C;&#x4E14; <strong>&#x6027;&#x80FD;&#x867D;&#x7136;&#x6BD4;&#x4E0D;&#x4E0A;ADO.NET</strong> &#xFF0C;&#x4F46;&#x4E5F;&#x8DB3;&#x591F;&#x597D;&#xFF0C;&#x80FD;&#x6EE1;&#x8DB3;&#x5927;&#x591A;&#x6570;&#x5F00;&#x53D1;&#x573A;&#x666F;&#x7684;&#x9700;&#x6C42;&#x3002;&#x4E0E;ADO.NET&#x4E0D;&#x4E00;&#x6837;&#xFF0C; <strong>EF&#x7684;&#x62BD;&#x8C61;&#x5C42;&#x6B21;&#x8F83;&#x9AD8;</strong> &#xFF1A;  &#x5B83;&#x628A;&#x6570;&#x636E;&#x5E93;&#x6620;&#x5C04;&#x4E3A;DbContext&#xFF0C;&#x628A;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x5B58;&#x53D6;&#x7684;&#x6570;&#x636E;&#x76F4;&#x63A5;&#x6620;&#x5C04;&#x4E3A;&#x5B9E;&#x4F53;&#xFF08;Entity&#xFF09;&#x5BF9;&#x8C61;  &#xFF0C;&#x5C4F;&#x853D;&#x4E86;&#x5E95;&#x5C42;&#x7684;&#x6570;&#x636E;&#x5E93;&#x5185;&#x90E8;&#x7ED3;&#x6784;&#xFF0C;&#x65E0;&#x9700;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x4E0B;&#x5C42;&#x6570;&#x636E;&#x5B58;&#x53D6;&#x5F15;&#x64CE;&#x6240;&#x63D0;&#x4F9B;&#x7684;&#x5E95;&#x5C42;&#x5BF9;&#x8C61;&#xFF08;&#x6BD4;&#x5982;ADO.NET&#x6240;&#x63D0;&#x4F9B;&#x7684;DbConnection&#xFF0C;DbCommands&#x7B49;&#xFF09;&#x5B8C;&#x6210;CRUD&#x3002; </p>
<p>EF&#x652F;&#x6301;&#x4E09;&#x79CD;&#x5F00;&#x53D1;&#x6A21;&#x5F0F;&#xFF1A;Code First&#x3001;Database First&#x548C;Model First&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;Code First&#x6A21;&#x5F0F;&#xFF0C;&#x5B83;&#x80FD;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x5FEB;&#x901F;&#x5F00;&#x53D1;&#x8FED;&#x4EE3;&#x7684;&#x76EE;&#x6807;&#x3002;&#x6700;&#x540E;&#xFF0C;EF&#x4E0D;&#x662F;&#x672C;&#x6587;&#x7684;&#x91CD;&#x70B9;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x8FD8;&#x4E0D;&#x4E86;&#x89E3;EF&#x6216;&#x8005;Code First&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x9605;&#x91D1;&#x65ED;&#x4EAE;&#x8001;&#x5E08;&#x7684;&#x300A; <a href="http://blog.csdn.net/bitfan/article/details/12887007" target="_blank" rel="external">EF&#x8D70;&#x9A6C;&#x89C2;&#x82B1;</a> &#x300B;&#x7CFB;&#x5217;&#x6587;&#x7AE0;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x4E86;&#x3002; </p>
<p>&#xFF08;1&#xFF09;&#x5728;Models&#x6587;&#x4EF6;&#x5939;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#x201C;UserInfo&#x201D;&#x3002;&#x5B83;&#x4F5C;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x5B9E;&#x4F53;&#x7C7B;&#xFF0C;&#x6620;&#x5C04;&#x5230;MySQL&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;UserInfo&#x8868;&#xFF08;&#x8FD9;&#x91CC;MySQL&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x8FD8;&#x672A;&#x521B;&#x5EFA;&#x8FD9;&#x6837;&#x7684;&#x6570;&#x636E;&#x8868;&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/27834d9.gif" alt=""></p>
<pre><code>    [Serializable]
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfo</span>
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    <span class="keyword">public</span> <span class="keyword">int</span> UserId { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    [Required]
    [MaxLength(<span class="number">128</span>)]
    <span class="keyword">public</span> <span class="keyword">string</span> UserName { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    [Required]
    [MaxLength(<span class="number">32</span>)]
    <span class="keyword">public</span> <span class="keyword">string</span> UserPwd { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}
</code></pre><p> View Code</p>
<p>&#xFF08;2&#xFF09;&#x518D;&#x5728;Models&#x6587;&#x4EF6;&#x5939;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#x201C;MyDbContext&#x201D;&#xFF0C;&#x4F7F;&#x5176;&#x7EE7;&#x627F;&#x4E8E;DbContext&#xFF0C;&#x4F5C;&#x4E3A;EF&#x64CD;&#x4F5C;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E0A;&#x4E0B;&#x6587;&#x4F7F;&#x7528;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;&#x8FD9;&#x91CC;&#x7684;name=MySqlDemo&#xFF0C;MySqlDemo&#x4E3A;&#x6570;&#x636E;&#x5E93;&#x7684;&#x540D;&#x5B57;&#x3002;&#x800C;&#x8FD9;&#x91CC;this.Database.CreateIfNotExists()&#x65B9;&#x6CD5;&#x5219;&#x7528;&#x4E8E;&#x5224;&#x65AD;MySqlDemo&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x662F;&#x5426;&#x5DF2;&#x5B58;&#x5728;&#xFF1F;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/27834d9.gif" alt=""></p>
<pre><code><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span> : <span class="title">DbContext</span>
    {
        <span class="function"><span class="keyword">public</span> <span class="title">MyDbContext</span>(<span class="params"></span>)
            : <span class="title">base</span>(<span class="params">&amp;quot;name=MySqlDemo&amp;quot;</span>)
        </span>{
            <span class="keyword">this</span>.Database.CreateIfNotExists();
        }

        <span class="keyword">public</span> <span class="keyword">virtual</span> DbSet&amp;lt;UserInfo&amp;gt; UserInfo { <span class="keyword">get</span>; <span class="keyword">set</span>; }
    }
</code></pre><p> View Code</p>
<p>&#xFF08;3&#xFF09;&#x5728;Web.config&#x4E2D;&#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;database&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;MySqlDemo&#x201D;&#xFF0C;&#x4E0E;&#x4E0A;&#x9762;&#x7684;MyDbContext&#x4E2D;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x4E2D;&#x7684;name&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/278374a.gif" alt=""></p>
<pre><code><span class="subst">&amp;</span><span class="literal">lt</span>;connectionStrings<span class="subst">&amp;</span><span class="literal">gt</span>;
    <span class="subst">&amp;</span><span class="literal">lt</span>;<span class="subst">!--&amp;</span><span class="variable">#x8BBE</span>;<span class="subst">&amp;</span><span class="variable">#x7F6E</span>;<span class="subst">&amp;</span><span class="variable">#x5BF9</span>;MySql<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x94FE</span>;<span class="subst">&amp;</span><span class="variable">#x63A5</span>;<span class="subst">&amp;</span><span class="variable">#x5B57</span>;<span class="subst">&amp;</span><span class="variable">#x7B26</span>;<span class="subst">&amp;</span><span class="variable">#x4E32</span>;<span class="subst">&amp;</span><span class="variable">#xFF08</span>;<span class="subst">&amp;</span><span class="variable">#x6CE8</span>;<span class="subst">&amp;</span><span class="variable">#x610F</span>;<span class="subst">&amp;</span><span class="variable">#xFF1A</span>;charset<span class="subst">=</span>utf8<span class="subst">&amp;</span><span class="variable">#x662F</span>;<span class="subst">&amp;</span><span class="variable">#x4E3A</span>;<span class="subst">&amp;</span><span class="variable">#x4E86</span>;<span class="subst">&amp;</span><span class="variable">#x89E3</span>;<span class="subst">&amp;</span><span class="variable">#x51B3</span>;MySql<span class="subst">&amp;</span><span class="variable">#x4E2D</span>;<span class="subst">&amp;</span><span class="variable">#x4FDD</span>;<span class="subst">&amp;</span><span class="variable">#x5B58</span>;<span class="subst">&amp;</span><span class="variable">#x4E2D</span>;<span class="subst">&amp;</span><span class="variable">#x6587</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x65F6</span>;<span class="subst">&amp;</span><span class="variable">#x5019</span>;<span class="subst">&amp;</span><span class="variable">#x51FA</span>;<span class="subst">&amp;</span><span class="variable">#x73B0</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x4E71</span>;<span class="subst">&amp;</span><span class="variable">#x7801</span>;<span class="subst">&amp;</span><span class="variable">#x7684</span>;<span class="subst">&amp;</span><span class="variable">#x95EE</span>;<span class="subst">&amp;</span><span class="variable">#x9898</span>;<span class="subst">&amp;</span><span class="variable">#xFF09</span>; <span class="subst">--&amp;</span><span class="literal">gt</span>;
    <span class="subst">&amp;</span><span class="literal">lt</span>;add name<span class="subst">=&amp;</span>quot;MySqlDemo<span class="subst">&amp;</span>quot; connectionString<span class="subst">=&amp;</span>quot;server<span class="subst">=</span><span class="number">127.0</span><span class="built_in">.0</span><span class="built_in">.1</span>;user id<span class="subst">=</span>root;password<span class="subst">=</span><span class="number">1234</span>;persist security info<span class="subst">=</span><span class="literal">True</span>;database<span class="subst">=</span>MySqlDemo;charset<span class="subst">=</span>utf8;<span class="subst">&amp;</span>quot; providerName<span class="subst">=&amp;</span>quot;MySql<span class="built_in">.</span><span class="built_in">Data</span><span class="built_in">.</span>MySqlClient<span class="subst">&amp;</span>quot; <span class="subst">/</span><span class="subst">&amp;</span><span class="literal">gt</span>;
  <span class="subst">&amp;</span><span class="literal">lt</span>;/connectionStrings<span class="subst">&amp;</span><span class="literal">gt</span>;
</code></pre><p> View Code</p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x53EA;&#x7528;&#x5230;UserInfo&#x8FD9;&#x4E00;&#x4E2A;&#x8868;&#xFF0C;&#x6240;&#x4EE5;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x6709;&#x5173;&#x6570;&#x636E;&#x5E93;&#x4E0E;EF&#x7684;&#x4EE3;&#x7801;&#x5C31;&#x5230;&#x6B64;&#x7ED3;&#x675F;&#x3002;</p>
<h2 id="2-3_&#x81EA;&#x5DF1;&#x5C01;&#x88C5;Memcached&#x5E2E;&#x52A9;&#x7C7B;&#x5BF9;&#x5916;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x63A5;&#x53E3;">2.3 &#x81EA;&#x5DF1;&#x5C01;&#x88C5;Memcached&#x5E2E;&#x52A9;&#x7C7B;&#x5BF9;&#x5916;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x63A5;&#x53E3;</h2><p>&#xFF08;1&#xFF09;&#x5728;Web.config&#x4E2D;&#x65B0;&#x589E;&#x4E00;&#x4E2A;AppSetting&#xFF0C;&#x4FDD;&#x5B58;Memcached&#x670D;&#x52A1;&#x5668;&#x7684;&#x5730;&#x5740;&#x5217;&#x8868;&#xFF1A;</p>
<pre><code>&amp;<span class="keyword">lt</span>;!-- &amp;<span class="title">#x8</span>BBE;&amp;<span class="title">#x7</span>F<span class="number">6</span>E;Memcached&amp;<span class="title">#x670</span>D;&amp;<span class="title">#x52</span>A<span class="number">1</span>;&amp;<span class="title">#x5668</span>;&amp;<span class="title">#x96</span>C<span class="number">6</span>;&amp;<span class="title">#x7</span>FA<span class="number">4</span>;&amp;<span class="title">#x5217</span>;&amp;<span class="title">#x8868</span>; --&amp;<span class="keyword">gt</span>;
    &amp;<span class="keyword">lt</span>;add key=&amp;quot;MemcachedServers&amp;quot; value=&amp;quot;<span class="number">192.168.</span><span class="number">80.10</span>:<span class="number">11211</span>,<span class="number">192.168.</span><span class="number">80.11</span>:<span class="number">11211</span>&amp;quot;/&amp;<span class="keyword">gt</span>;
</code></pre><p>&#xFF08;2&#xFF09;&#x5728;Models&#x4E2D;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#x201C;MemcachedHelper&#x201D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;&#x9759;&#x6001;&#x7C7B;&#xFF0C;&#x6240;&#x4EE5;&#x65B9;&#x6CD5;&#x5168;&#x662F;&#x9759;&#x6001;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x65E0;&#x9700;&#x5B9E;&#x4F8B;&#x5316;&#x4FBF;&#x53EF;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;&#x9759;&#x6001;&#x6784;&#x9020;&#x51FD;&#x6570;&#x6765;&#x521D;&#x59CB;&#x5316;&#x5168;&#x5C40;&#x9759;&#x6001;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x4E0D;&#x5C5E;&#x4E8E;&#x4EFB;&#x4F55;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x6784;&#x9020;&#x51FD;&#x6570;&#x53EA;&#x4F1A;&#x88AB;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x800C;&#x4E14;&#x662F;&#x5728;&#x521B;&#x5EFA;&#x6B64;&#x7C7B;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#x6216;&#x5F15;&#x7528;&#x4EFB;&#x4F55;&#x9759;&#x6001;&#x6210;&#x5458;&#x4E4B;&#x524D;&#xFF0C;&#x7531;.NET&#x81EA;&#x52A8;&#x8C03;&#x7528;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/278374a.gif" alt=""></p>
<pre><code>/// &amp;lt;summary&amp;gt;
/// &amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;&amp;<span class="symbol">#x5C01</span>;&amp;<span class="symbol">#x88C5</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5E2E</span>;&amp;<span class="symbol">#x52A9</span>;&amp;<span class="symbol">#x7C7B</span>;
/// &amp;lt;/summary&amp;gt;
public static class <span class="class">MemcacheHelper</span>
{
    <span class="symbol">#region</span> &amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x5C40</span>;&amp;<span class="symbol">#x9759</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
    // &amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x5C40</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
    private readonly static <span class="class">SockIOPool</span> sockIOPool;
    public static <span class="class">SockIOPool</span> <span class="class">CurrentPool</span>
    {
        get
        {
            return sockIOPool;
        }
    }
    // &amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x5C40</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
    private static <span class="class">MemcachedClient</span> mc; 
    <span class="symbol">#endregion</span>
    <span class="symbol">#region</span> &amp;<span class="symbol">#x9759</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;
    /// &amp;lt;summary&amp;gt;
    /// &amp;<span class="symbol">#x9759</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;
    /// &amp;lt;/summary&amp;gt;
    static <span class="class">MemcacheHelper</span>()
    {
        // &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;
        string[] serverList = <span class="class">ConfigurationManager</span>.<span class="class">AppSettings</span>[&amp;quot;<span class="class">MemcachedServers</span>&amp;quot;].<span class="class">Split</span>(&amp;apos;,&amp;apos;);
        // &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;
        sockIOPool = <span class="class">SockIOPool</span>.<span class="class">GetInstance</span>(&amp;quot;<span class="class">MemPool</span>&amp;quot;);
        sockIOPool.<span class="class">SetServers</span>(serverList);
        sockIOPool.<span class="class">Initialize</span>();
        // &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;
        mc = new <span class="class">MemcachedClient</span>();
        mc.<span class="class">PoolName</span> = &amp;quot;<span class="class">MemPool</span>&amp;quot;;
        mc.<span class="class">EnableCompression</span> = <span class="keyword">false</span>;
    } 
    <span class="symbol">#endregion</span>
    <span class="symbol">#region</span> &amp;<span class="symbol">#x5C01</span>;&amp;<span class="symbol">#x88C5</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;
    /// &amp;lt;summary&amp;gt;
    /// <span class="class">Set</span>-&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;
    /// &amp;lt;/summary&amp;gt;
    /// &amp;lt;param name=&amp;quot;key&amp;quot;&amp;gt;&amp;<span class="symbol">#x952E</span>;&amp;lt;/param&amp;gt;
    /// &amp;lt;param name=&amp;quot;value&amp;quot;&amp;gt;&amp;<span class="symbol">#x503C</span>;&amp;lt;/param&amp;gt;
    /// &amp;lt;returns&amp;gt;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;lt;/returns&amp;gt;
    public static bool <span class="class">Set</span>(string key, object value)
    {
        if (!mc.<span class="class">KeyExists</span>(key))
        {
            return mc.<span class="class">Add</span>(key, value);
        }
        else
        {
            return mc.<span class="class">Set</span>(key, value);
        }
    }
    /// &amp;lt;summary&amp;gt;
    /// <span class="class">Set</span>-&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x6216</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;
    /// &amp;lt;/summary&amp;gt;
    /// &amp;lt;param name=&amp;quot;key&amp;quot;&amp;gt;&amp;<span class="symbol">#x952E</span>;&amp;lt;/param&amp;gt;
    /// &amp;lt;param name=&amp;quot;value&amp;quot;&amp;gt;&amp;<span class="symbol">#x503C</span>;&amp;lt;/param&amp;gt;
    /// &amp;lt;param name=&amp;quot;expiry&amp;quot;&amp;gt;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;lt;/param&amp;gt;
    /// &amp;lt;returns&amp;gt;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;lt;/returns&amp;gt;
    public static bool <span class="class">Set</span>(string key, object value, <span class="class">DateTime</span> expiry)
    {
        if (!mc.<span class="class">KeyExists</span>(key))
        {
            return mc.<span class="class">Add</span>(key, value, expiry);
        }
        else
        {
            return mc.<span class="class">Set</span>(key, value, expiry);
        }
    }
    /// &amp;lt;summary&amp;gt;
    /// <span class="class">Get</span>-&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;
    /// &amp;lt;/summary&amp;gt;
    /// &amp;lt;param name=&amp;quot;key&amp;quot;&amp;gt;&amp;<span class="symbol">#x952E</span>;&amp;lt;/param&amp;gt;
    /// &amp;lt;returns&amp;gt;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;lt;/returns&amp;gt;
    public static object <span class="class">Get</span>(string key)
    {
        if (!mc.<span class="class">KeyExists</span>(key))
        {
            return null;
        }
        else
        {
            return mc.<span class="class">Get</span>(key);
        }
    } 
    <span class="symbol">#endregion</span>
}
</code></pre><p> View Code</p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x5BF9;SockIOPool&#x8FDB;&#x884C;&#x4E00;&#x5217;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x91C7;&#x7528;&#x5176;&#x9ED8;&#x8BA4;&#x7684;&#x914D;&#x7F6E;&#x5373;&#x53EF;&#x3002;&#x4F46;&#x662F;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;SockIOPool&#x7684;PoolName&#x548C;MemcacheClient&#x7684;PoolName&#x5FC5;&#x987B;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x3002;</p>
<h2 id="2-4_&#x7528;&#x6237;&#x767B;&#x5F55;&#x65F6;&#x8C03;&#x7528;Memcached&#x5E2E;&#x52A9;&#x7C7B;&#x63A5;&#x53E3;&#x5B58;&#x50A8;&#x7528;&#x6237;&#x767B;&#x5F55;&#x72B6;&#x6001;">2.4 &#x7528;&#x6237;&#x767B;&#x5F55;&#x65F6;&#x8C03;&#x7528;Memcached&#x5E2E;&#x52A9;&#x7C7B;&#x63A5;&#x53E3;&#x5B58;&#x50A8;&#x7528;&#x6237;&#x767B;&#x5F55;&#x72B6;&#x6001;</h2><p>&#xFF08;1&#xFF09;&#x5728;Controller&#x4E2D;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x63A7;&#x5236;&#x5668;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#x201C;LogonController&#x201D;&#x3002;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x663E;&#x793A;&#x7CFB;&#x7EDF;&#x767B;&#x9646;&#x9875;&#x548C;&#x8FDB;&#x884C;&#x7528;&#x6237;&#x9A8C;&#x8BC1;&#x7684;AJAX&#x64CD;&#x4F5C;&#xFF08;&#x5C06;&#x7528;&#x6237;Session&#x5B58;&#x5165;Memcached&#x4E5F;&#x5728;&#x6B64;&#x64CD;&#x4F5C;&#x4E2D;&#xFF09;&#x3002;&#x81F3;&#x4E8E;&#x767B;&#x5F55;&#x9875;&#x9762;&#x7684;HTML&#x548C;JS&#x811A;&#x672C;&#x5728;&#x6B64;&#x5C31;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#xFF0C;&#x8BF7;&#x81EA;&#x884C;&#x4E0B;&#x8F7D;Demo&#x6587;&#x4EF6;&#x67E5;&#x770B;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/27839bb.gif" alt=""></p>
<pre><code>public class <span class="class">LogonController</span> : <span class="class">Controller</span>
{
    //
    // <span class="class">GET</span>: /<span class="class">Logon</span>/
    public <span class="class">ActionResult</span> <span class="class">Index</span>()
    {
        return <span class="class">View</span>();
    }
    [<span class="class">HttpPost</span>]
    public <span class="class">JsonResult</span> <span class="class">ValidateUserInfo</span>(string userName, string userPwd)
    {
        <span class="class">MyDbContext</span> dbContext = new <span class="class">MyDbContext</span>();
        var loginUser = dbContext.<span class="class">UserInfo</span>.<span class="class">Where</span>(u =&amp;gt; u.<span class="class">UserName</span>.<span class="class">Equals</span>(userName)).<span class="class">FirstOrDefault</span>();
        <span class="class">JsonObject</span> jsonReturn = new <span class="class">JsonObject</span>();
        if (loginUser == null)
        {
            jsonReturn.success = <span class="keyword">false</span>;
            jsonReturn.msg = &amp;quot;&amp;<span class="symbol">#x60A8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x540D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#xFF01</span>;&amp;quot;;
        }
        else
        {
            if (!loginUser.<span class="class">UserPwd</span>.<span class="class">Equals</span>(userPwd))
            {
                jsonReturn.success = <span class="keyword">false</span>;
                jsonReturn.msg = &amp;quot;&amp;<span class="symbol">#x60A8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5BC6</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;&amp;<span class="symbol">#xFF01</span>;&amp;quot;;
                return <span class="class">Json</span>(jsonReturn, <span class="class">JsonRequestBehavior</span>.<span class="class">DenyGet</span>);
            }
            // &amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6A21</span>;&amp;<span class="symbol">#x62DF</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">Guid</span>&amp;<span class="symbol">#xFF1A</span>;<span class="class">SessionId</span>
            <span class="class">Guid</span> sessionId = <span class="class">Guid</span>.<span class="class">NewGuid</span>();
            // &amp;<span class="symbol">#x628A</span>;sessionid&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x6D4F</span>;&amp;<span class="symbol">#x89C8</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7D2F</span>;
            <span class="class">Response</span>.<span class="class">Cookies</span>[&amp;quot;sessionId&amp;quot;].<span class="class">Value</span> = sessionId.<span class="class">ToString</span>();
            // &amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">Memcache</span>&amp;<span class="symbol">#x4E2D</span>;
            <span class="class">MemcacheHelper</span>.<span class="class">Set</span>(sessionId.<span class="class">ToString</span>(), loginUser, <span class="class">DateTime</span>.<span class="class">Now</span>.<span class="class">AddMinutes</span>(<span class="number">20</span>));
            // &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x54CD</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x6D88</span>;&amp;<span class="symbol">#x606F</span>;
            jsonReturn.success = <span class="keyword">true</span>;
            jsonReturn.msg = &amp;quot;&amp;<span class="symbol">#x606D</span>;&amp;<span class="symbol">#x559C</span>;&amp;<span class="symbol">#x60A8</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x767B</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF01</span>;&amp;quot;;
        }
        return <span class="class">Json</span>(jsonReturn, <span class="class">JsonRequestBehavior</span>.<span class="class">DenyGet</span>);
    }
}
</code></pre><p> View Code</p>
<p>&#x73B0;&#x5728;&#x6765;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x63A7;&#x5236;&#x5668;&#x7684;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#xFF1A;</p>
<p>&#x2460;Index&#x8FD9;&#x4E2A;Action&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x663E;&#x793A;&#x767B;&#x5F55;&#x89C6;&#x56FE;&#xFF0C;&#x9875;&#x9762;&#x4EE3;&#x7801;&#x4E0D;&#x518D;&#x8D34;&#x51FA;&#x6765;&#xFF0C;&#x53EA;&#x770B;&#x770B;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;AJAX&#x8BF7;&#x6C42;&#x4EE3;&#x7801;&#xFF1A;&#x501F;&#x52A9;JQuery AJAX&#x5411;ValidateUserInfo&#x8FD9;&#x4E2A;Action&#x63D0;&#x4EA4;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#xFF0C;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x6821;&#x9A8C;&#x6210;&#x529F;&#x5219;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;JSON&#x5BF9;&#x8C61;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x7AEF;&#x5224;&#x65AD;success&#x5C5E;&#x6027;&#x662F;&#x5426;&#x4E3A;true&#xFF0C;&#x5982;&#x679C;&#x4E3A;true&#x5219;&#x8DF3;&#x8F6C;&#x5230;&#x7CFB;&#x7EDF;&#x4E3B;&#x9875;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/27839bb.gif" alt=""></p>
<pre><code><span class="xml">    $.ajax(</span><span class="expression">{
    <span class="variable">type</span>: &amp;<span class="variable">quot</span>;<span class="variable">POST</span>&amp;<span class="variable">quot</span>;,
    <span class="variable">contentType</span>: &amp;<span class="variable">quot</span>;<span class="variable">application</span><span class="end-block">/json</span>;<span class="variable">charset</span>=<span class="variable">utf-</span>8&amp;<span class="variable">quot</span>;,
    <span class="variable">url</span>: &amp;<span class="variable">quot</span>;<span class="end-block">/Logon</span><span class="end-block">/ValidateUserInfo</span>&amp;<span class="variable">quot</span>;,
    <span class="variable">data</span>: &amp;<span class="variable">quot</span>;{ <span class="variable">userName</span>:&amp;<span class="variable">apos</span>;&amp;<span class="variable">quot</span>; + <span class="variable">txtUserName</span> + &amp;<span class="variable">quot</span>;&amp;<span class="variable">apos</span>;,<span class="variable">userPwd</span>:&amp;<span class="variable">apos</span>;&amp;<span class="variable">quot</span>; + <span class="variable">txtUserPwd</span> + &amp;<span class="variable">quot</span>;&amp;<span class="variable">apos</span>; }</span><span class="xml">&amp;quot;,
    dataType: &amp;quot;json&amp;quot;,
    beforeSend: function () </span><span class="expression">{
        <span class="variable">showMsg</span>(&amp;<span class="variable">quot</span>;&amp;<span class="begin-block">#x</span>64<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">D</span>0;&amp;<span class="begin-block">#x</span>793<span class="variable">A</span>;&amp;<span class="variable">quot</span>;, &amp;<span class="variable">quot</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>63;&amp;<span class="begin-block">#x</span>5728;&amp;<span class="begin-block">#x</span>9<span class="variable">A</span>8<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BC</span>1;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>7;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5019;<span class="variable">...</span>&amp;<span class="variable">quot</span>;);
    }</span><span class="xml">,
    success: function (resultInfo) </span><span class="expression">{
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">resultInfo</span> != <span class="variable">null</span> &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">resultInfo.success</span>) {
            <span class="variable">window.location.href</span> = &amp;<span class="variable">quot</span>;<span class="end-block">/Home</span><span class="end-block">/Index</span>&amp;<span class="variable">quot</span>;;
        }</span><span class="xml">
        else </span><span class="expression">{
            <span class="variable">showMsg</span>(&amp;<span class="variable">quot</span>;&amp;<span class="begin-block">#x</span>767<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>5931;&amp;<span class="begin-block">#x</span>8<span class="variable">D</span>25;&amp;<span class="variable">quot</span>;, <span class="variable">resultInfo.msg</span>);
        }</span><span class="xml">
    },
    error: function () </span><span class="expression">{
        <span class="variable">showMsg</span>(&amp;<span class="variable">apos</span>;&amp;<span class="begin-block">#x</span>9519;&amp;<span class="begin-block">#x</span>8<span class="variable">BEF</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">D</span>0;&amp;<span class="begin-block">#x</span>793<span class="variable">A</span>;&amp;<span class="variable">apos</span>;, &amp;<span class="variable">apos</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>751<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>672<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>77<span class="variable">E</span>5;&amp;<span class="begin-block">#x</span>9519;&amp;<span class="begin-block">#x</span>8<span class="variable">BEF</span>;&amp;<span class="variable">apos</span>;);
    }</span><span class="xml">
});</span>
</code></pre><p> View Code</p>
<p>&#x2461;ValidateUserInfo&#x8FD9;&#x4E2A;Action&#x5219;&#x662F;&#x6839;&#x636E;&#x6D4F;&#x89C8;&#x5668;&#x63D0;&#x4EA4;&#x8FC7;&#x6765;&#x7684;AJAX&#x8BF7;&#x6C42;&#xFF0C;&#x5224;&#x65AD;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#x662F;&#x5426;&#x6B63;&#x786E;&#x3002;&#x8FD9;&#x91CC;&#x7528;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x5199;&#x7684;MyDbContext&#xFF0C;&#x9996;&#x5148;&#x5BF9;&#x5B83;&#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x3002;&#xFF08;&#x8FD9;&#x4E00;&#x6B65;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x7684;MySQL&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x8FD8;&#x6728;&#x6709;MySqlDemo&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5F53;&#x7B2C;&#x4E00;&#x6B21;&#x5B9E;&#x4F8B;&#x5316;MyDbContext&#x65F6;&#xFF0C;EF&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;&#x5728;MySQL&#x4E2D;&#x521B;&#x5EFA;MySqlDemo&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5176;&#x672C;&#x8D28;&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x5E2E;&#x6211;&#x4EEC;&#x751F;&#x6210;&#x4E00;&#x4E32;&#xFF1A;crate database mysqldemo;&#x4E4B;&#x7C7B;&#x7684;SQL&#x8BED;&#x53E5;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;Lambda&#x8868;&#x8FBE;&#x5F0F;&#x8FD9;&#x79CD;&#x4F18;&#x7F8E;&#x7684;&#x8BED;&#x6CD5;&#x53BB;&#x8FDB;&#x884C;&#x6821;&#x9A8C;&#x3002;&#x5982;&#x679C;&#x4F60;&#x5BF9;Lambda&#x8868;&#x8FBE;&#x5F0F;&#x4E0D;&#x719F;&#x6089;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x9605;MSDN&#x7684;&#x300A; <a href="http://msdn.microsoft.com/zh-cn/library/bb397687.aspx" target="_blank" rel="external">Lambda&#x8868;&#x8FBE;&#x5F0F;&#xFF08;C#&#x7F16;&#x7A0B;&#x6307;&#x5357;&#xFF09;</a> &#x300B;&#x4E00;&#x6587;&#x6765;&#x5B66;&#x4E60;&#x4E0B;&#x3002; </p>
<p>&#x2462;&#x5C31;&#x662F;&#x6700;&#x6838;&#x5FC3;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x6211;&#x4EEC;&#x91C7;&#x7528;Guid&#xFF08;&#x4FDD;&#x8BC1;&#x4F5C;&#x4E3A;Key&#x7684;&#x552F;&#x4E00;&#x6027;&#xFF09;&#x4F5C;&#x4E3A; <strong>SessionId</strong> &#x5199;&#x5165;&#x6D4F;&#x89C8;&#x5668;&#x7AEF;&#x7684;Cookie&#x4E2D;&#xFF0C;&#x5E76;&#x4EE5;&#x6B64;&#x4F5C;&#x4E3A; <strong>Key</strong> &#x5B58;&#x5165;Memcached&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD8;&#x7ED9;&#x5B83;&#x8BBE;&#x7F6E;&#x4E86;&#x9ED8;&#x8BA4;&#x5931;&#x6548;&#x65F6;&#x95F4;&#xFF08;&#x8FD9;&#x91CC;&#x4E3A;20&#x5206;&#x949F;&#xFF09;&#x3002;&#x4E4B;&#x540E;&#xFF0C;&#x6BCF;&#x6B21;&#x6D4F;&#x89C8;&#x5668;&#x5411;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x63D0;&#x4EA4;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x5728;HTTP&#x62A5;&#x6587;&#x4E2D;&#x90FD;&#x4F1A;&#x9644;&#x5E26;&#x4E0A;&#x8FD9;&#x4E2A;Cookie&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;Cookie&#x4F5C;&#x4E3A;Key&#x53BB;Memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x67E5;&#x627E;Session&#x5BF9;&#x8C61;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2783c2c.jpg" alt=""></p>
<p>PS&#xFF1A;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;Memcached&#x7684;&#x6570;&#x636E;Key&#x7684;&#x547D;&#x540D;&#x662F;&#x6709;&#x8BB2;&#x7A76;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x4F20;&#x667A;&#x7684;&#x8001;&#x9A6C;&#x63A8;&#x8350;&#x4E86;&#x4E00;&#x4E2A;&#x547D;&#x540D;&#x89C4;&#x5219;&#xFF1A;{&#x547D;&#x540D;&#x7A7A;&#x95F4;}-{&#x90E8;&#x95E8;&#x540D;&#x79F0;}-{&#x9879;&#x76EE;&#x540D;&#x79F0;}&#x3002;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5C31;&#x7B80;&#x5355;&#x4E00;&#x70B9;&#xFF0C;&#x4F7F;&#x7528;Guid&#x6765;&#x4F5C;&#x4E3A;Key&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x6B21;&#x751F;&#x6210;&#x7684;Guid&#x662F;&#x552F;&#x4E00;&#x7684;&#x3002; </p>
<h2 id="2-5_&#x5C01;&#x88C5;BaseController&#x89E3;&#x51B3;Action&#x89E6;&#x53D1;&#x524D;&#x7684;&#x6821;&#x9A8C;&#x89C4;&#x5219;">2.5 &#x5C01;&#x88C5;BaseController&#x89E3;&#x51B3;Action&#x89E6;&#x53D1;&#x524D;&#x7684;&#x6821;&#x9A8C;&#x89C4;&#x5219;</h2><p>&#xFF08;1&#xFF09;&#x5728;&#x4EE5;&#x5F80;&#x7684;&#x4FE1;&#x606F;&#x7CFB;&#x7EDF;&#x9879;&#x76EE;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x7CFB;&#x7EDF;&#x91CC;&#x8FB9;&#x4F1A;&#x505A;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x7684;&#x6821;&#x9A8C;&#x5668;&#xFF0C;&#x5224;&#x65AD;&#x7528;&#x6237;&#x7684;&#x6BCF;&#x6B21;&#x64CD;&#x4F5C;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x5177;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x6743;&#x9650;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x662F;&#x6821;&#x9A8C;&#x7528;&#x6237;&#x662F;&#x5426;&#x767B;&#x5F55;&#xFF0C;&#x4EE5;&#x4FBF;&#x6211;&#x4EEC;&#x5728;&#x5177;&#x4F53;&#x7684;&#x6A21;&#x5757;&#x4E2D;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x7684;Session&#x5BF9;&#x8C61;&#x3002;&#x5355;&#x673A;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x822C;&#x5C31;&#x5B58;&#x5165;&#x672C;&#x673A;&#x8FDB;&#x7A0B;&#x5185;&#x7684;Session&#xFF0C;&#x56E0;&#x6B64;&#x5C31;&#x4E3B;&#x8981;&#x5224;&#x65AD;Session&#x4E2D;&#x662F;&#x5426;&#x5B58;&#x5728;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;Memcached&#x6765;&#x5B58;&#x50A8;Session&#x5BF9;&#x8C61;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x5728;&#x6BCF;&#x4E2A;Action&#x6267;&#x884C;&#x524D;&#x52A0;&#x4E00;&#x6BB5;&#x89C4;&#x5219;&#xFF1A; &#x5224;&#x65AD;Memcached&#x4E2D;&#x662F;&#x5426;&#x6709;&#x5F53;&#x524D;&#x7528;&#x6237;&#x7684;&#x767B;&#x5F55;&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;&#x6709;&#xFF0C;&#x5219;&#x7EE7;&#x7EED;&#x6267;&#x884C;Action&#x3002;&#x5982;&#x679C;&#x6728;&#x6709;&#xFF0C;&#x90A3;&#x4E48;&#x5BF9;&#x4E0D;&#x8D77;&#xFF0C;&#x8BF7;&#x8FDB;&#x884C;&#x767B;&#x5F55; &#x3002; </p>
<p>&#xFF08;2&#xFF09;&#x5728;WebForm&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5199;&#x4E00;&#x4E2A;BasePage&#xFF0C;&#x4F7F;&#x5176;&#x7EE7;&#x627F;&#x4E8E;Page&#xFF0C;&#x91CD;&#x5199;OnLoad&#x4E8B;&#x4EF6;&#xFF0C;&#x518D;&#x8BA9;&#x5176;&#x4ED6;&#x9875;&#x9762;&#x7EE7;&#x627F;&#x4E8E;BasePage&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5BF9;&#x7528;&#x6237;&#x662F;&#x5426;&#x767B;&#x5F55;&#x8FD9;&#x4E2A;&#x6821;&#x9A8C;&#x5E94;&#x7528;&#x5230;&#x6240;&#x6709;&#x7EE7;&#x627F;&#x4E86;BasePage&#x7684;Page&#x7C7B;&#x4E2D;&#x3002;&#x90A3;&#x4E48;&#xFF0C;&#x5728;MVC&#x6A21;&#x5F0F;&#x4E2D;&#xFF0C;&#x8BF7;&#x6C42;&#x5BF9;&#x8C61;&#x4E0D;&#x518D;&#x662F;xxx.aspx&#x9875;&#x9762;&#x7C7B;&#x578B;&#xFF0C;&#x800C;&#x662F;/ControllerName/ActionName&#x7684;&#x8DEF;&#x7531;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5BFB;&#x627E;&#x4E00;&#x79CD;&#x9488;&#x5BF9;Action&#x7684;&#x5168;&#x5C40;&#x8FC7;&#x6EE4;&#x65B9;&#x6CD5;&#x3002;&#x989D;&#xFF0C;&#x5728;&#x6B64;&#x6211;&#x4EEC;&#x4E0D;&#x7981;&#x60F3;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x9AD8;&#x5927;&#x4E0A;&#x7684;&#x82F1;&#x6587;&#xFF1A; <strong>AoP&#xFF08;Aspect Oriented Programming&#xFF09;</strong> &#xFF0C;&#x5B83;&#x662F;&#x8F6F;&#x4EF6;&#x5F00;&#x53D1;&#x4E2D;&#x4E00;&#x4E2A;&#x8F83;&#x4E3A;&#x70ED;&#x95E8;&#x7684;&#x8BDD;&#x9898;&#xFF0C;&#x5229;&#x7528;AOP&#x53EF;&#x4EE5; <strong>&#x5BF9;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x7684;&#x5404;&#x4E2A;&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x9694;&#x79BB;</strong> &#xFF0C;&#x4ECE;&#x800C;&#x4F7F;&#x5F97;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x5404;&#x90E8;&#x5206;&#x4E4B;&#x95F4;&#x7684;&#x8026;&#x5408;&#x5EA6;&#x964D;&#x4F4E;&#xFF0C;&#x63D0;&#x9AD8;&#x7A0B;&#x5E8F;&#x7684;&#x53EF;&#x91CD;&#x7528;&#x6027;&#xFF0C;&#x540C;&#x65F6;&#x63D0;&#x9AD8;&#x4E86;&#x5F00;&#x53D1;&#x7684;&#x6548;&#x7387;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;Action&#x589E;&#x52A0;&#x5168;&#x5C40;&#x6821;&#x9A8C;&#x89C4;&#x5219;&#x5C31;&#x662F;&#x5C06;Action&#x7684;&#x6821;&#x9A8C;&#x65B9;&#x6CD5;&#x4E0E;Action&#x7684;&#x4E1A;&#x52A1;&#x5904;&#x7406;&#x76F8;&#x5206;&#x79BB;&#xFF0C;&#x4F7F;&#x5176;&#x8026;&#x5408;&#x5EA6;&#x964D;&#x4F4E;&#xFF0C;&#x4E5F;&#x63D0;&#x9AD8;&#x4E86;Action&#x7684;&#x6821;&#x9A8C;&#x65B9;&#x6CD5;&#x7684;&#x91CD;&#x7528;&#x6027;&#xFF0C;&#x7B26;&#x5408;&#x4E86;AoP&#x7684;&#x601D;&#x60F3;&#x3002;&#x90A3;&#x4E48;&#xFF0C;&#x626F;&#x4E86;&#x5927;&#x534A;&#x5929;&#xFF0C;&#x5728;ASP.NET MVC&#x4E2D;&#x5230;&#x5E95;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x5462;&#xFF1F;&#x522B;&#x62C5;&#x5FC3;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x50CF;&#x5199;BasePage&#x4E00;&#x6837;&#xFF0C;&#x5199;&#x4E00;&#x4E2A;BaseController&#x6765;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x4F7F;&#x5176;&#x7EE7;&#x627F;&#x4E8E;Controller&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x5176;&#x4ED6;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x7528;&#x6237;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x6821;&#x9A8C;&#x7684;Controller&#x90FD;&#x7EE7;&#x627F;&#x4E8E;BaseController&#x5373;&#x53EF;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/2783c2c.gif" alt=""></p>
<pre><code>public class <span class="class">BaseController</span> : <span class="class">Controller</span>
{
    // &amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x5C40</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
    protected <span class="class">UserInfo</span> <span class="class">CurrentUser</span> { get; private set; }
    // &amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x5C40</span>;<span class="class">Action</span>&amp;<span class="symbol">#x6267</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x9A8C</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x4F3C</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">AoP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x601D</span>;&amp;<span class="symbol">#x60F3</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x7F16</span>;&amp;<span class="symbol">#x7A0B</span>;
    protected override void <span class="class">OnActionExecuting</span>(<span class="class">ActionExecutingContext</span> filterContext)
    {
        base.<span class="class">OnActionExecuting</span>(filterContext);
        // &amp;<span class="symbol">#x4ECE</span>;cookie&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x767B</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x7684</span>;sessionId
        string sessionId = <span class="class">Request</span>[&amp;quot;sessionId&amp;quot;];
        if (string.<span class="class">IsNullOrEmpty</span>(sessionId))
        {
            filterContext.<span class="class">Result</span> = new <span class="class">RedirectResult</span>(&amp;quot;/<span class="class">Logon</span>/<span class="class">Index</span>&amp;quot;);
        }
        else
        {
            object obj = <span class="class">MemcacheHelper</span>.<span class="class">Get</span>(sessionId);
            <span class="class">CurrentUser</span> = obj as <span class="class">UserInfo</span>;
            if (<span class="class">CurrentUser</span> == null)
            {
                filterContext.<span class="class">Result</span> = new <span class="class">RedirectResult</span>(&amp;quot;/<span class="class">Logon</span>/<span class="class">Index</span>&amp;quot;);
            }
            // &amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">Memcache</span>&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5E03</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x73B0</span>;<span class="class">Session</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6ED1</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x7A97</span>;&amp;<span class="symbol">#x53E3</span>;&amp;<span class="symbol">#x673A</span>;&amp;<span class="symbol">#x5236</span>;
            <span class="class">MemcacheHelper</span>.<span class="class">Set</span>(sessionId, <span class="class">CurrentUser</span>, <span class="class">DateTime</span>.<span class="class">Now</span>.<span class="class">AddMinutes</span>(<span class="number">20</span>));
        }
    }
}
</code></pre><p> View Code</p>
<p>&#xFF08;3&#xFF09;&#x73B0;&#x5728;&#x6765;&#x770B;&#x770B;&#x4E0A;&#x9762;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#xFF1A;</p>
<p>&#x2460;&#x4ECE;&#x6D4F;&#x89C8;&#x5668;&#x63D0;&#x4EA4;&#x8FC7;&#x6765;&#x7684;HTTP&#x8BF7;&#x6C42;&#x62A5;&#x6587;&#x4E2D;&#x53D6;&#x5F97;Cookie&#xFF08;&#x4E5F;&#x5C31;&#x662F;SessionId&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;Cookie&#x90A3;&#x4E48;&#x80AF;&#x5B9A;&#x8FD8;&#x6CA1;&#x6709;&#x767B;&#x5F55;&#xFF0C;&#x5C06;&#x8FDB;&#x884C;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x9646;&#x9875;&#x9762;&#xFF1B;</p>
<p>&#x2461;&#x5982;&#x679C;&#x6709;Cookie&#x90A3;&#x4E48;&#x5C31;&#x53BB;Memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x67E5;&#x8BE2;&#x662F;&#x5426;&#x6709;&#x8FD9;&#x4E2A;Key&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6CA1;&#x6709;&#x5185;&#x5BB9;&#xFF0C;&#x90A3;&#x4E48;&#x8FD8;&#x662F;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x9646;&#x9875;&#x9762;&#xFF1B;&#x5982;&#x679C;&#x6709;&#x5185;&#x5BB9;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x7531;&#x4E8E;&#x8FD4;&#x56DE;&#x7684;&#x662F;Object&#x7C7B;&#x578B;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x8F6C;&#x6362;&#x4E00;&#x4E0B;&#x8D4B;&#x7ED9;&#x5168;&#x5C40;&#x7684;&#x7528;&#x6237;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;&#x3002;</p>
<p>&#x2462;&#x83B7;&#x53D6;&#x5230;UserInfo&#x5BF9;&#x8C61;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x5C06;&#x5176;&#x91CD;&#x65B0;&#x5B58;&#x50A8;&#x5230;Memcached&#x4E2D;&#xFF0C;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x662F;&#x5C06;Session&#x5EF6;&#x957F;&#x5931;&#x6548;&#x65F6;&#x95F4;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;Session&#x7684; <strong>&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x673A;&#x5236;</strong> &#x7684;&#x6548;&#x679C;&#x3002; </p>
<p>PS&#xFF1A;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5728;&#x767B;&#x5F55;&#x9A8C;&#x8BC1;&#x7684;Action&#x91CC;&#x9762;&#x7ED9;&#x8FD9;&#x4E2A;&#x7F13;&#x5B58;&#x8BBE;&#x7F6E;&#x7684;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x662F;&#x4E00;&#x4E2A;&#x7EDD;&#x5BF9;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x800C;&#x975E;&#x6ED1;&#x52A8;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x3002;&#x6240;&#x8C13; <strong>&#x7EDD;&#x5BF9;&#x65F6;&#x95F4;&#x662F;&#x6307;&#x5230;&#x4E86;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x4EE5;&#x540E;&#x4FBF;&#x4F1A;&#x5931;&#x6548;</strong> &#xFF0C;&#x800C; <strong>&#x6ED1;&#x52A8;&#x65F6;&#x95F4;&#x662F;&#x6307;&#x5728;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x5185;&#x65E0;&#x8BBF;&#x95EE;&#x8BF7;&#x6C42;&#x4FBF;&#x5931;&#x6548;</strong> &#x3002; </p>
<h2 id="2-6_&#x6D4B;&#x8BD5;&#x8FD0;&#x884C;&#x7528;&#x6237;&#x767B;&#x5F55;&#x4E0E;Session&#x5B58;&#x50A8;">2.6 &#x6D4B;&#x8BD5;&#x8FD0;&#x884C;&#x7528;&#x6237;&#x767B;&#x5F55;&#x4E0E;Session&#x5B58;&#x50A8;</h2><p>&#xFF08;1&#xFF09;&#x5230;&#x6B64;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x7684;&#x4EE3;&#x7801;&#x90FD;&#x5DF2;&#x5B8C;&#x6BD5;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x5C0F;&#x6D4B;&#x8BD5;&#xFF0C;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;Controller&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#x201C;HomeController&#x201D;&#xFF0C;&#x5C06;Index&#x9875;&#x9762;&#x7528;&#x4F5C;&#x767B;&#x9646;&#x540E;&#x7684;&#x4E3B;&#x9875;&#xFF0C;&#x663E;&#x793A;Session&#x5BF9;&#x8C61;&#x4E2D;&#x7684;UserName&#x5C5E;&#x6027;&#x3002;&#x4EE3;&#x7801;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x53EA;&#x6709;&#x4E24;&#x884C;&#xFF1A;</p>
<pre><code><span class="xml">public ActionResult Index()
        </span><span class="expression">{
            /<span class="end-block">/ </span>&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;<span class="variable">Memcached</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;<span class="variable">Session</span>&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>76;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>20;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>9;<span class="variable">View</span>
            <span class="variable">ViewBag.UserName</span> = <span class="variable">CurrentUser.UserName</span>;
            <span class="variable">return</span> <span class="variable">View</span>();
        }</span><span class="xml">    </span>
</code></pre><p>&#x81F3;&#x4E8E;View&#xFF0C;&#x8BF7;&#x53C2;&#x8003;Demo&#x6587;&#x4EF6;&#xFF0C;&#x6B64;&#x5904;&#x5C31;&#x4E0D;&#x5728;&#x8D58;&#x8FF0;&#x4E86;&#xFF0C;&#x5C31;&#x4E00;&#x5806;HTML&#x800C;&#x5DF2;&#x3002;</p>
<p>&#xFF08;2&#xFF09;&#x2460;&#x5F00;&#x542F;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x7684;&#x4E24;&#x53F0;Windows Server&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x786E;&#x4FDD;Memcached&#x670D;&#x52A1;&#x90FD;&#x5DF2;&#x6210;&#x529F;&#x5F00;&#x542F;&#x3002;&#xFF08;&#x5982;&#x679C;&#x4F60;&#x662F;&#x88C5;&#x5728;&#x672C;&#x673A;&#x7684;&#xFF0C;&#x76F4;&#x63A5;&#x5F00;&#x542F;&#x670D;&#x52A1;&#x5373;&#x53EF;&#xFF09;</p>
<p>&#x2461;&#x5F00;&#x542F;MySQL&#x6570;&#x636E;&#x5E93;&#x670D;&#x52A1;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x7684;MySQL&#x662F;&#x88C5;&#x5728;&#x672C;&#x673A;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x9700;&#x8981;&#x5F00;&#x542F;&#x670D;&#x52A1;&#x5373;&#x53EF;&#x3002;</p>
<p>&#xFF08;3&#xFF09;&#x70B9;&#x51FB;&#x8C03;&#x8BD5;&#xFF0C;&#x5F00;&#x59CB;&#x8FD0;&#x884C;IIS Express&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x5427;&#x9A9A;&#x5E74;&#xFF08;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x8BF4;&#x660E;&#x7684;&#xFFFD;&#xFFFD;&#xFFFD;&#xFF1A;&#x4F60;&#x9700;&#x8981;&#x9996;&#x5148;&#x968F;&#x4FBF;&#x8F93;&#x5165;&#x4E00;&#x4E2A;&#x8D26;&#x53F7;&#x548C;&#x5BC6;&#x7801;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x5E93;&#x7684;&#x521B;&#x5EFA;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x91C7;&#x7528;&#x7684;&#x662F;Code First&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8FDB;&#x5165;MySQL&#x6DFB;&#x52A0;&#x51E0;&#x884C;&#x6D4B;&#x8BD5;&#x7528;&#x6237;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x5DF2;&#x7ECF;&#x6DFB;&#x52A0;&#x4E86;&#x51E0;&#x884C;&#xFF0C;&#x5F00;&#x59CB;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x3002;&#xFF09;&#x6211;&#x5728;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x8FB9;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x884C;{&#x8D26;&#x53F7;&#xFF1A;edisonchou&#xFF0C;&#x5BC6;&#x7801;&#xFF1A;123456}&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x8F93;&#x5165;&#x8D26;&#x53F7;&#x548C;&#x5BC6;&#x7801;&#xFF0C;&#x70B9;&#x51FB;&#x767B;&#x5F55;&#xFF0C;&#x4F1A;&#x51FA;&#x73B0;&#x4E00;&#x4E2A;&#x53CB;&#x597D;&#x7684;&#x63D0;&#x793A;&#xFF1A;&#x201C;&#x6B63;&#x5728;&#x9A8C;&#x8BC1;&#x4E2D;&#xFF0C;&#x8BF7;&#x7A0D;&#x5019;…&#x201D;&#xFF08;&#x5982;&#x679C;&#x4F60;&#x662F;&#x7B2C;&#x4E00;&#x6B21;&#x8FD0;&#x884C;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x4F1A;&#x6BD4;&#x8F83;&#x957F;&#xFF0C;&#x4E0D;&#x8981;&#x62C5;&#x5FC3;&#xFF09;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/2783e9d.jpg" alt=""></p>
<p>&#xFF08;4&#xFF09;&#x7B49;&#x5F85;&#x7CFB;&#x7EDF;&#x9A8C;&#x8BC1;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x4FBF;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;&#x7CFB;&#x7EDF;&#x4E3B;&#x9875;&#xFF0C;&#x663E;&#x793A;&#x6B22;&#x8FCE;&#x754C;&#x9762;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x4E0B;&#x56FE;&#x4E2D;&#x7684;&#x4E24;&#x5904;&#x662F;&#x6839;&#x636E;Session&#x7684;UserName&#x6765;&#x663E;&#x793A;&#x7684;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/2783e9d.jpg" alt=""></p>
<p>&#xFF08;5&#xFF09;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x4FEE;&#x6539;URL&#xFF0C;&#x8F93;&#x5165;/Logon/Index&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x767B;&#x9646;&#x9875;&#x9762;&#x3002;&#x7136;&#x540E;&#xFF0C;&#x518D;&#x4FEE;&#x6539;URL&#x4E3A;/Home/Index&#xFF0C;&#x770B;&#x770B;&#x662F;&#x5426;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x767B;&#x5F55;&#xFF0C;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5C06;Session&#x5B58;&#x5165;&#x4E86;Memcached&#xFF0C;&#x6240;&#x4EE5;&#x518D;&#x6B21;&#x8FDB;&#x5165;/Home/Index&#x8FD9;&#x4E2A;Action&#x65F6;&#x4F1A;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#xFF0C;&#x901A;&#x8FC7;&#x6D4F;&#x89C8;&#x5668;&#x7AEF;&#x4F20;&#x8FC7;&#x53BB;&#x7684;Cookie&#x53BB;Memcached&#x4E2D;&#x53D6;Session&#xFF0C;&#x5982;&#x5B58;&#x5728;&#x5219;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;&#x8FD9;&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x767B;&#x5F55;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x767B;&#x5F55;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x518D;&#x6B21;&#x8DF3;&#x8F6C;/Home/Index&#x7684;HTTP&#x62A5;&#x6587;&#x4FE1;&#x606F;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x767B;&#x5F55;&#x4E4B;&#x540E;&#x5DF2;&#x7ECF;&#x5199;&#x5165;&#x4E86;Cookie&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x8BF7;&#x6C42;&#x90FD;&#x4F1A;&#x5E26;&#x4E0A;Cookie&#x4F20;&#x9012;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4E5F;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Cookie&#x4F5C;&#x4E3A;Key&#x83B7;&#x53D6;Session&#x5BF9;&#x8C61;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/2783e9d.jpg" alt=""></p>
<p>&#xFF08;6&#xFF09;&#x65B0;&#x5F00;&#x4E00;&#x4E2A;&#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x518D;&#x4F7F;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x767B;&#x5F55;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2783e9d.jpg" alt=""></p>
<p>&#xFF08;7&#xFF09;&#x767B;&#x9646;&#x540E;&#xFF0C;&#x67E5;&#x770B;HTTP&#x62A5;&#x6587;&#xFF0C;&#x83B7;&#x53D6;Cookie&#x4E2D;&#x7684;sessionId&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/278410e.jpg" alt=""></p>
<p>&#xFF08;8&#xFF09;&#x6839;&#x636E;&#x4E24;&#x4E2A;&#x7528;&#x6237;&#x7684;sessionId&#x4F5C;&#x4E3A;Key&#xFF0C;&#x5728;Memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x67E5;&#x770B;&#x5B58;&#x50A8;&#x60C5;&#x51B5;&#xFF1A;&#x7ECF;&#x67E5;&#x770B;&#xFF0C;&#x4E24;&#x4E2A;Session&#x90FD;&#x5B58;&#x50A8;&#x5230;&#x4E86;192.168.80.11&#x8FD9;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x91CC;&#x8FB9;&#x3002;&#x4E3A;&#x4F55;&#x6CA1;&#x6709;&#x5E73;&#x5747;&#x5206;&#x914D;&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x7B97;&#x6CD5;&#x662F;&#x6839;&#x636E;&#x8BA1;&#x7B97;Hash&#x503C;&#x6765;&#x7684;&#xFF0C;&#x521A;&#x597D;&#x8FD9;&#x4E24;&#x4E2A;sessionId&#x8BA1;&#x7B97;&#x540E;&#x7684;Hash&#x503C;&#x90FD;&#x662F;&#x8981;&#x5206;&#x914D;&#x5230;192.168.80.11&#x8FD9;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x91CC;&#x8FB9;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x90FD;&#x5B58;&#x5230;&#x4E86;&#x8FD9;&#x91CC;&#x8FB9;&#x3002;&#xFF08;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;&#x8FD9;&#x91CC;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x6211;&#x7684;&#x673A;&#x5668;&#x4E0A;&#x8DD1;&#x7684;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#xFF0C;&#x7F51;&#x53CB;&#x4EEC;&#x7684;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#x53EF;&#x80FD;&#x4F1A;&#x8DDF;&#x6211;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x8FD9;&#x662F;&#x6B63;&#x5E38;&#x7684;&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/278410e.jpg" alt=""></p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x5C0F;&#x6D4B;&#x8BD5;&#x5230;&#x6B64;&#x7ED3;&#x675F;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x6848;&#x4F8B;&#x4E5F;&#x5230;&#x6B64;&#x4E3A;&#x6B62;&#x3002;</p>
<h2 id="&#x4E09;&#x3001;&#x5B66;&#x4E60;&#x5C0F;&#x7ED3;">&#x4E09;&#x3001;&#x5B66;&#x4E60;&#x5C0F;&#x7ED3;</h2><p>&#x672C;&#x7BC7;&#x6211;&#x9996;&#x5148;&#x901A;&#x8FC7;&#x82B1;&#x5927;&#x529B;&#x6C14;&#x5BF9;Session&#x670D;&#x52A1;&#x5668;&#x573A;&#x666F;&#x7684;&#x7B80;&#x4ECB;&#x5F15;&#x51FA;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x5BF9;&#x4E8E;&#x6784;&#x5EFA;Session&#x670D;&#x52A1;&#x5668;&#x7684;&#x53EF;&#x884C;&#x6027;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;ASP.NET MVC+EF Code First+MySQL+Memcached&#x6765;&#x6A21;&#x62DF;&#x4E86;&#x4E00;&#x4E2A;&#x4FE1;&#x606F;&#x7CFB;&#x7EDF;&#x767B;&#x5F55;&#x573A;&#x666F;&#xFF0C;&#x5176;&#x4E2D;&#x501F;&#x52A9;&#x4E86;Memcached&#x6765;&#x5B58;&#x50A8;Session&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;Action&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x6765;&#x5B9E;&#x73B0;&#x5BF9;&#x7528;&#x6237;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x7684;&#x6821;&#x9A8C;&#x3002;&#x6700;&#x540E;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x5C0F;&#x6D4B;&#x8BD5;&#xFF0C;&#x6765;&#x9A8C;&#x8BC1;Memcached&#x662F;&#x5426;&#x5B58;&#x50A8;&#x4E86;&#x6211;&#x4EEC;&#x7684;Session&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x6B64;&#x6848;&#x4F8B;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x73A9;&#x5177;&#x7EA7;&#x522B;&#x7684;Demo&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x7ECF;&#x8FC7;&#x5F88;&#x591A;&#x6B21;&#x6027;&#x80FD;&#x6D4B;&#x8BD5;&#x548C;&#x4F18;&#x5316;&#x624D;&#x80FD;&#x5E94;&#x7528;&#x5230;&#x5B9E;&#x9645;&#x5F00;&#x53D1;&#x4E2D;&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x4E2D;&#x4E86;&#x89E3;&#x5230;&#x4E00;&#x4E9B;&#x6709;&#x76CA;&#x7684;&#x601D;&#x60F3;&#xFF0C;&#x7406;&#x89E3;&#x8FD9;&#x4E9B;&#x601D;&#x60F3;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x7684;&#x5B9E;&#x9645;&#x5F00;&#x53D1;&#x80FD;&#x529B;&#x6709;&#x6240;&#x88E8;&#x76CA;&#x7684;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x5E0C;&#x671B;&#x6211;&#x7684;&#x6587;&#x7AE0;&#x80FD;&#x591F;&#x7ED9;&#x66F4;&#x591A;&#x7684;&#x50CF;&#x6211;&#x4E00;&#x6837;&#x7684;&#x83DC;&#x9E1F;&#x5F00;&#x53D1;&#x8005;&#x5E26;&#x6765;&#x4E00;&#x70B9;&#x5149;&#x660E;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x89C9;&#x5F97;&#x6709;&#x7528;&#xFF0C;&#x90A3;&#x5C31;&#x9EBB;&#x70E6;&#x70B9;&#x4E00;&#x4E0B;&#x201C;&#x63A8;&#x8350;&#x201D;&#x5427;&#xFF0C;&#x8C22;&#x8C22;&#xFF01;</p>
<h2 id="&#x53C2;&#x8003;&#x6587;&#x732E;">&#x53C2;&#x8003;&#x6587;&#x732E;</h2><p>&#xFF08;1&#xFF09;&#x674E;&#x667A;&#x6167;&#xFF0C;&#x300A;&#x5927;&#x578B;&#x7F51;&#x7AD9;&#x6280;&#x672F;&#x67B6;&#x6784;-&#x6838;&#x5FC3;&#x539F;&#x7406;&#x4E0E;&#x6848;&#x4F8B;&#x5206;&#x6790;&#x300B;&#xFF0C;<a href="http://item.jd.com/11322972.html" target="_blank" rel="external">http://item.jd.com/11322972.html</a></p>
<p>&#xFF08;2&#xFF09;&#x9A6C;&#x4F26;&#xFF0C;&#x300A;Memcached&#x516C;&#x5F00;&#x8BFE;&#x300B;&#xFF0C;<a href="http://bbs.itcast.cn/thread-14836-1-1.html" target="_blank" rel="external">http://bbs.itcast.cn/thread-14836-1-1.html</a></p>
<p>&#xFF08;3&#xFF09;&#x65CB;&#x98CE;&#xFF0C;&#x300A;Memcached&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x66FF;&#x4EE3;Session&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x300B;&#xFF0C;<a href="http://www.cnblogs.com/xuanfeng/archive/2009/06/04/1494735.html" target="_blank" rel="external">http://www.cnblogs.com/xuanfeng/archive/2009/06/04/1494735.html</a></p>
<p>&#xFF08;4&#xFF09;&#x91D1;&#x65ED;&#x4EAE;&#xFF0C;&#x300A;Entity Framework&#x8D70;&#x9A6C;&#x89C2;&#x82B1;&#x300B;&#xFF0C;<a href="http://blog.csdn.net/bitfan/article/details/12779517" target="_blank" rel="external">http://blog.csdn.net/bitfan/article/details/12779517</a></p>
<p>&#xFF08;5&#xFF09;MSDN&#xFF0C;&#x300A;&#x9759;&#x6001;&#x7C7B;&#x548C;&#x9759;&#x6001;&#x6210;&#x5458;&#xFF08;C#&#x7F16;&#x7A0B;&#x6307;&#x5357;&#xFF09;&#x300B;&#xFF0C;<a href="http://msdn.microsoft.com/zh-cn/library/79b3xss3.aspx" target="_blank" rel="external">http://msdn.microsoft.com/zh-cn/library/79b3xss3.aspx</a></p>
<p>&#xFF08;6&#xFF09;&#x75DE;&#x5B50;&#x4E00;&#x6BDB;&#xFF0C;&#x300A;Memcached+Cookie&#x66FF;&#x4EE3;Session&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF08;MVC&#x7248;&#xFF09;&#x300B;&#xFF0C;<a href="http://www.cnblogs.com/piziyimao/archive/2013/01/29/2882236.html" target="_blank" rel="external">http://www.cnblogs.com/piziyimao/archive/2013/01/29/2882236.html</a></p>
<p>&#xFF08;7&#xFF09;&#x778C;&#x7761;&#x9F99;&#x98DE;&#xFF0C;&#x300A;.NET&#x4E2D;Cache&#x7684;&#x7528;&#x6CD5;&#x300B;&#xFF0C;<a href="http://blog.csdn.net/ttotcs/article/details/7476234" target="_blank" rel="external">http://blog.csdn.net/ttotcs/article/details/7476234</a></p>
<p>&#xFF08;8&#xFF09;lulu Studio&#xFF0C;&#x300A;ASP.NET MVC:Action&#x8FC7;&#x6EE4;&#x5668;&#xFF08;Filtering&#xFF09;&#x300B;&#xFF0C;<a href="http://www.cnblogs.com/QLeelulu/archive/2008/03/21/1117092.html" target="_blank" rel="external">http://www.cnblogs.com/QLeelulu/archive/2008/03/21/1117092.html</a></p>
<h2 id="&#x9644;&#x4EF6;&#x4E0B;&#x8F7D;">&#x9644;&#x4EF6;&#x4E0B;&#x8F7D;</h2><p>&#xFF08;1&#xFF09;MemcachedMvcDemo&#xFF1A; <a href="http://pan.baidu.com/s/1gd3RvKB" target="_blank" rel="external">http://pan.baidu.com/s/1gd3RvKB</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/数据库/">数据库</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/276b7fd/" title="【转】Key/Value之王Memcached初探：一、掀起Memcached的盖头来 -" itemprop="url">【转】Key/Value之王Memcached初探：一、掀起Memcached的盖头来 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:44.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="&#x4E00;&#x3001;Memcached&#x662F;&#x4F55;&#x65B9;&#x795E;&#x5723;&#xFF1F;">&#x4E00;&#x3001;Memcached&#x662F;&#x4F55;&#x65B9;&#x795E;&#x5723;&#xFF1F;</h2><p><img src="http://taojinke.github.io/img/20150703/2768e7c.jpg" alt=""></p>
<p>&#x5728;&#x6570;&#x636E;&#x9A71;&#x52A8;&#x7684;Web&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x7ECF;&#x5E38;&#x8981;&#x91CD;&#x590D;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x53D6;&#x51FA;&#x76F8;&#x540C;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x79CD;&#x91CD;&#x590D;&#x6781;&#x5927;&#x7684;&#x589E;&#x52A0;&#x4E86;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#x3002;&#x7F13;&#x5B58;&#x662F;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x597D;&#x529E;&#x6CD5;&#x3002;&#x4F46;&#x662F;ASP.NET&#x4E2D;&#x7684;HttpRuntime.Cache&#x867D;&#x7136;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x5BF9;&#x9875;&#x9762;&#x5C40;&#x90E8;&#x8FDB;&#x884C;&#x7F13;&#x5B58;&#xFF0C;&#x4F46;&#x8FD8;&#x662F;&#x4E0D;&#x591F;&#x7075;&#x6D3B;&#xFF0C;&#x6B64;&#x65F6;Memcached&#x6216;&#x8BB8;&#x662F;&#x4F60;&#x60F3;&#x8981;&#x7684;&#x3002;</p>
<p>Memcached &#x662F;&#x4E00;&#x4E2A; <strong>&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;</strong> &#xFF0C;&#x7528;&#x4E8E;&#x52A8;&#x6001;Web&#x5E94;&#x7528;&#x4EE5;&#x51CF;&#x8F7B;&#x6570;&#x636E;&#x5E93;&#x8D1F;&#x8F7D;&#x3002;&#x5B83;&#x901A;&#x8FC7;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x548C;&#x5BF9;&#x8C61;&#x6765;&#x51CF;&#x5C11;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5E93;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x63D0;&#x9AD8;&#x52A8;&#x6001;&#x3001;&#x6570;&#x636E;&#x5E93;&#x9A71;&#x52A8;&#x7F51;&#x7AD9;&#x7684;&#x901F;&#x5EA6;&#x3002;&#x7ECF;&#x8FC7;&#x591A;&#x5E74;&#x7684;&#x53D1;&#x5C55;&#xFF0C;&#x76EE;&#x524D;&#x5DF2;&#x7ECF;&#x6709;&#x5F88;&#x591A;&#x77E5;&#x540D;&#x7684;&#x4E92;&#x8054;&#x7F51;&#x5E94;&#x7528;&#x4F7F;&#x7528;&#x5230;&#x4E86;Memcached&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;Wikipedia&#x3001;Flickr&#x3001;Youtube&#x3001;Wordpress&#x7B49;&#x7B49;&#x3002; </p>
<h2 id="&#x4E8C;&#x3001;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4F7F;&#x7528;Memcached&#xFF1F;">&#x4E8C;&#x3001;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4F7F;&#x7528;Memcached&#xFF1F;</h2><p><img src="http://taojinke.github.io/img/20150703/27690ed.png" alt=""></p>
<p>&#x4E0A;&#x56FE;&#x5C55;&#x793A;&#x4E86;Memcached&#x7684;&#x4E00;&#x822C;&#x6027;&#x7528;&#x9014;&#xFF1A; <strong>&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;</strong> &#x3002;&#x5F53;&#x6D4F;&#x89C8;&#x5668;&#x9996;&#x6B21;&#x8BF7;&#x6C42;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x5148;&#x4ECE;&#x6570;&#x636E;&#x5E93;&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x53D6;&#x5F97;&#x8FD4;&#x56DE;&#x7ED9;&#x7528;&#x6237;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x4EE5;Key/Value&#x952E;&#x503C;&#x5BF9;&#x7684;&#x5F62;&#x5F0F;&#x5B58;&#x5165;Memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x3002;&#x5F53;&#x7528;&#x6237;&#x7B2C;&#x4E8C;&#x6B21;&#x8BBF;&#x95EE;&#x4E0A;&#x6B21;&#x8BF7;&#x6C42;&#xFFFD;&#xFFFD;&#xFFFD;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x901A;&#x8FC7;&#x5728;Memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x67E5;&#x627E;&#x662F;&#x5426;&#x6709;&#x7F13;&#x5B58;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5219;&#x76F4;&#x63A5;&#x4ECE;Memcached&#x4E2D;&#x8BFB;&#x53D6;&#x3002;&#x7531;&#x4E8E;Memcached&#x670D;&#x52A1;&#x5668;&#x662F;&#x90E8;&#x7F72;&#x5728;&#x7F51;&#x7AD9;&#x673A;&#x623F;&#x5185;&#x7F51;&#x4E2D;&#x7684;&#xFF0C;&#x800C;&#x4E14;&#x6570;&#x636E;&#x65F6;&#x5B58;&#x50A8;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x4E2D;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8BBF;&#x95EE;&#x901F;&#x5EA6;&#x6BD4;&#x6570;&#x636E;&#x5E93;&#x7684;&#x78C1;&#x76D8;IO&#x8981;&#x5FEB;&#x4E00;&#x4E9B;&#xFF0C;&#x4E5F;&#x5C31;&#x63D0;&#x9AD8;&#x4E86;&#x670D;&#x52A1;&#x54CD;&#x5E94;&#x901F;&#x5EA6;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x9AD8;&#x5CF0;&#x65F6;&#x95F4;&#x51CF;&#x8F7B;&#x4E86;&#x6570;&#x636E;&#x5E93;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8D1F;&#x8F7D;&#x538B;&#x529B;&#x3002; </p>
<p>&#xFF08;1&#xFF09;Memcached&#x4F5C;&#x4E3A;&#x9AD8;&#x901F;&#x8FD0;&#x884C;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5177;&#x6709;&#x4EE5;&#x4E0B;&#x7684;&#x7279;&#x70B9;&#xFF1A;</p>
<ul>
<li><strong>&#x534F;&#x8BAE;&#x7B80;&#x5355;</strong> &#xFF1A;&#x4F7F;&#x7528; <strong>&#x7B80;&#x5355;&#x7684;&#x57FA;&#x4E8E;&#x6587;&#x672C;&#x884C;</strong> &#x7684;&#x534F;&#x8BAE;&#xFF0C;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x590D;&#x6742;&#x7684;XML&#x534F;&#x8BAE;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x901A;&#x8FC7;telnet&#x4E5F;&#x80FD;&#x5728;memcached&#x4E0A;&#x4FDD;&#x5B58;&#x6570;&#x636E;&#x3001;&#x53D6;&#x5F97;&#x6570;&#x636E;&#xFF1B;</li>
<li><strong>&#x57FA;&#x4E8E;libevent&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;</strong> &#xFF1A;memcached&#x4F7F;&#x7528;&#x8FD9;&#x4E2A; <strong>libevent</strong> &#x5E93;&#xFF0C;&#x56E0;&#x6B64;&#x80FD;&#x5728;Linux&#x3001;BSD&#x3001;Solaris&#x7B49;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#x53D1;&#x6325;&#x5176;&#x9AD8;&#x6027;&#x80FD;&#xFF1B;</li>
</ul>
<p><strong>libevent</strong> &#x662F;&#x4E2A;&#x7A0B;&#x5E8F;&#x5E93;&#xFF0C;&#x5B83;&#x5C06;Linux&#x7684;epoll&#x3001;BSD&#x7C7B;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;kqueue&#x7B49;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x529F;&#x80FD; &#x5C01;&#x88C5;&#x6210;&#x7EDF;&#x4E00;&#x7684;&#x63A5;&#x53E3;&#x3002;&#x5373;&#x4F7F;&#x5BF9;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x589E;&#x52A0;&#xFF0C;&#x4E5F;&#x80FD;&#x53D1;&#x6325;O(1)&#x7684;&#x6027;&#x80FD;&#x3002; </p>
<p>libevent: <a href="http://www.monkey.org/~provos/libevent/" target="_blank" rel="external">http://www.monkey.org/~provos/libevent/</a></p>
<ul>
<li><strong>&#x5185;&#x7F6E;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;</strong> &#xFF1A;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;memcached&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x6570;&#x636E;&#x90FD;&#x5B58;&#x50A8;&#x5728;memcached <strong>&#x5185;&#x7F6E;&#x7684;&#x5185;&#x5B58;&#x5B58;&#x50A8;&#x7A7A;&#x95F4;</strong> &#x4E2D;&#xFF1B;</li>
</ul>
<p>&#x7531;&#x4E8E;&#x6570;&#x636E;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x56E0;&#x6B64; <strong>&#x91CD;&#x542F;memcached&#x3001;&#x91CD;&#x542F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4F1A;&#x5BFC;&#x81F4;&#x5168;&#x90E8;&#x6570;&#x636E;&#x6D88;&#x5931;</strong> &#x3002; &#x53E6;&#x5916;&#xFF0C;&#x5185;&#x5BB9;&#x5BB9;&#x91CF;&#x8FBE;&#x5230;&#x6307;&#x5B9A;&#x503C;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x57FA;&#x4E8E;LRU(Least Recently Used)&#x7B97;&#x6CD5;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x4E0D;&#x4F7F;&#x7528;&#x7684;&#x7F13;&#x5B58;&#x3002;memcached&#x672C;&#x8EAB;&#x662F;&#x4E3A;&#x7F13;&#x5B58;&#x800C;&#x8BBE;&#x8BA1;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x56E0;&#x6B64; <strong>&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x591A;&#x8003;&#x8651;&#x6570;&#x636E;&#x7684;&#x6C38;&#x4E45;&#x6027;&#x95EE;&#x9898;</strong> &#x3002; </p>
<p>NoSQL&#x4E2D;&#x6BD4;&#x8F83;&#x4F18;&#x79C0;&#x7684;&#x4E00;&#x6B3E;&#x4EA7;&#x54C1;&#xFF1A; <strong>Redis</strong> &#xFF0C;&#x6BD4;&#x8F83;&#x597D;&#x5730;&#x89E3;&#x51B3;&#x4E86;&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x7684;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x91CD;&#x542F;Redis&#x4E0D;&#x4F1A;&#x5BFC;&#x81F4;&#x6570;&#x636E;&#x4E22;&#x5931;&#x3002; </p>
<ul>
<li><strong>&#x4E0D;&#x4E92;&#x76F8;&#x901A;&#x4FE1;&#x7684;&#x5206;&#x5E03;&#x5F0F;</strong> &#xFF1A;&#x5C3D;&#x7BA1;&#x662F;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F46;&#x670D;&#x52A1;&#x5668;&#xFFFD;&#xFFFD;&#xFFFD;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x529F;&#x80FD;&#xFF0C;&#x8FD9; <strong>&#x5B8C;&#x5168;&#x53D6;&#x51B3;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;</strong> &#x7684;&#x5B9E;&#x73B0;&#x3002;&#x6211;&#x4EEC;&#x4F1A;&#x5F88;&#x60CA;&#x5947;&#x7684;&#x53D1;&#x73B0;memcached&#x7684;&#x96C6;&#x7FA4;&#x975E;&#x5E38;easy&#xFF0C;&#x7B80;&#x5355;&#x5F97;&#x751A;&#x81F3;&#x53EA;&#x9700;&#x8981;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6DFB;&#x52A0;&#x670D;&#x52A1;&#x5668;IP&#x4E0E;&#x7AEF;&#x53E3;&#x53F7;&#xFF1B;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x8BF7;&#x6C42;&#x7ED9;memcached&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5728;memcached&#x5BA2;&#x6237;&#x7AEF;&#x4E2D;&#x4F1A;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#xFF08;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#xFF09;&#x4ECE;memcached&#x670D;&#x52A1;&#x5668;&#x5217;&#x8868;&#x4E2D;&#x8BA1;&#x7B97;&#x4E00;&#x4E2A;memcached&#x670D;&#x52A1;&#x5668;&#x7684;&#x5730;&#x5740;&#xFF08;&#x5982;&#x679C;&#x662F;&#x8BFB;&#x8BF7;&#x6C42;&#xFF0C;&#x5219;&#x6839;&#x636E;Key&#x5728;&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x4E2D;&#x5F97;&#x5230;&#x7F13;&#x5B58;&#x6709;&#x8BE5;Key&#x7684;memcached&#x670D;&#x52A1;&#x5668;&#x4FE1;&#x606F;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x6570;&#x636E;&#xFF08;Key/Value&#x5BF9;&#xFF09;&#x4F20;&#x9012;&#x7ED9;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;memcached&#x670D;&#x52A1;&#x5668;&#xFF08;&#x5982;&#x679C;&#x662F;&#x8BFB;&#x8BF7;&#x6C42;&#xFF0C;&#x5219;&#x4ECE;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;memcached&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x8BFB;&#x53D6;&#x542B;&#x6709;&#x6307;&#x5B9A;Key&#x7684;&#x6570;&#x636E;&#xFF09;&#xFF1B;</li>
</ul>
<p><img src="http://taojinke.github.io/img/20150703/276935e.png" alt=""></p>
<p>PS&#xFF1A;&#x6B63;&#x56E0;&#x4E3A;memcached&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x4E92;&#x4E0D;&#x901A;&#x4FE1;&#xFF0C;&#x56E0;&#x800C;&#x96C6;&#x7FA4;&#x89C4;&#x6A21;&#x53EF;&#x4EE5;&#x8F7B;&#x6613;&#x5730;&#x6269;&#x5BB9;&#xFF0C;&#x5177;&#x6709;&#x826F;&#x597D;&#x7684; <strong>&#x4F38;&#x7F29;&#x6027;</strong> &#x3002; </p>
<p>&#xFF08;2&#xFF09;Memcached&#x4E0E;Redis&#x7684;&#x5BF9;&#x6BD4;</p>
<p>&#x2460;&#x6CA1;&#x6709;&#x5FC5;&#x8981;&#x8FC7;&#x591A;&#x7684;&#x5173;&#x5FC3;&#x6027;&#x80FD;&#xFF0C;&#x56E0;&#x4E3A; <strong>&#x4E8C;&#x8005;&#x7684;&#x6027;&#x80FD;&#x90FD;&#x5DF2;&#x7ECF;&#x8DB3;&#x591F;&#x9AD8;</strong> &#x4E86;&#x3002;&#x7531;&#x4E8E; <strong>Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;</strong> &#xFF0C;&#x800C; <strong>Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;</strong> &#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x6BD4;&#x8F83;&#x4E0A;&#xFF0C;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#xFF0C;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77;Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;&#x8BF4;&#x4E86;&#x8FD9;&#x4E48;&#x591A;&#xFF0C;&#x7ED3;&#x8BBA;&#x662F;&#xFF0C;&#x65E0;&#x8BBA;&#x4F60;&#x4F7F;&#x7528;&#x54EA;&#x4E00;&#x4E2A;&#xFF0C;&#x6BCF;&#x79D2;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x7684;&#x6B21;&#x6570;&#x90FD;&#x4E0D;&#x4F1A;&#x6210;&#x4E3A;&#x74F6;&#x9888;&#x3002;&#xFF08;&#x6BD4;&#x5982;&#x74F6;&#x9888;&#x53EF;&#x80FD;&#x4F1A;&#x5728;&#x7F51;&#x5361;&#xFF09; </p>
<p>&#x2461;&#x5982;&#x679C;&#x8981;&#x8BF4;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#xFF0C; &#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#x7684;&#x8BDD;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8; &#xFF0C;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x548C;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#x548C;&#x6570;&#x636E;&#x7279;&#x6027;&#x6709;&#x5173;&#x3002; </p>
<p>&#x2462;&#x5982;&#x679C;&#x4F60; &#x5BF9;&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x548C;&#x6570;&#x636E;&#x540C;&#x6B65;&#x6709;&#x6240;&#x8981;&#x6C42;&#xFF0C;&#x90A3;&#x4E48;&#x63A8;&#x8350;&#x4F60;&#x9009;&#x62E9;Redis &#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E24;&#x4E2A;&#x7279;&#x6027;Memcached&#x90FD;&#x4E0D;&#x5177;&#x5907;&#x3002;&#x5373;&#x4F7F;&#x4F60;&#x53EA;&#x662F;&#x5E0C;&#x671B;&#x5728;&#x5347;&#x7EA7;&#x6216;&#x8005;&#x91CD;&#x542F;&#x7CFB;&#x7EDF;&#x540E;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x4E0D;&#x4F1A;&#x4E22;&#x5931;&#xFF0C;&#x9009;&#x62E9;Redis&#x4E5F;&#x662F;&#x660E;&#x667A;&#x7684;&#x3002; </p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x51FA;&#x4E00;&#x4E2A;&#x7ED3;&#x8BBA;&#xFF1A;&#x5728;&#x7B80;&#x5355;&#x7684;Key/Value&#x5E94;&#x7528;&#x573A;&#x666F;&#xFF08;&#x4F8B;&#x5982;&#x7F13;&#x5B58;&#xFF09;&#xFF0C;Memcached&#x62E5;&#x6709;&#x66F4;&#x9AD8;&#x7684;&#x8BFB;&#x5199;&#x6027;&#x80FD;&#xFF1B;&#x800C;&#x5728;&#x6570;&#x636E;&#x6301;&#x4E45;&#x5316;&#x548C;&#x6570;&#x636E;&#x540C;&#x6B65;&#x573A;&#x666F;&#xFF0C;Redis&#x62E5;&#x6709;&#x66F4;&#x52A0;&#x5F3A;&#x5927;&#x7684;&#x529F;&#x80FD;&#x548C;&#x66F4;&#x4E3A;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1B;</p>
<h2 id="&#x4E09;&#x3001;Memcached&#x7684;&#x5B89;&#x88C5;&#x4E0E;&#x7B80;&#x5355;&#x64CD;&#x4F5C;">&#x4E09;&#x3001;Memcached&#x7684;&#x5B89;&#x88C5;&#x4E0E;&#x7B80;&#x5355;&#x64CD;&#x4F5C;</h2><p>Memcached&#x7684;&#x5B89;&#x88C5;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x800C;&#x4E14;&#x652F;&#x6301;&#x591A;&#x5E73;&#x53F0;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;&#x6700;&#x7ECF;&#x5178;&#x7684;Linux&#x3001;FreeBSD&#x3001;Solaris (memcached 1.2.5&#x4EE5;&#x4E0A;&#x7248;&#x672C;)&#x3001;Mac OS X&#x4EE5;&#x53CA;&#x6211;&#x4EEC;&#x6700;&#x719F;&#x6089;&#x7684;Windows&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x6211;&#x4EEC;&#x65E5;&#x5E38;&#x6700;&#x719F;&#x6089;&#x7684;Windows&#x5E73;&#x53F0;&#x6765;&#x5B89;&#x88C5;Memcached&#x670D;&#x52A1;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x7B80;&#x5355;&#x7684;&#x914D;&#x7F6E;&#x548C;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#xFF08;1&#xFF09;&#x4E0B;&#x8F7D;Memcached For Windows</p>
<p>URL&#xFF1A; <a href="http://code.jellycan.com/files/memcached-1.2.6-win32-bin.zip" target="_blank" rel="external">http://code.jellycan.com/files/memcached-1.2.6-win32-bin.zip</a></p>
<p>&#x5176;&#x5BF9;&#x5E94;&#x7684;&#x6E90;&#x7801;&#x5730;&#x5740;&#xFF1A; <a href="http://code.jellycan.com/files/memcached-1.2.6-win32-src.zip" target="_blank" rel="external">http://code.jellycan.com/files/memcached-1.2.6-win32-src.zip</a></p>
<p>&#xFF08;2&#xFF09;&#x5728;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x5B89;&#x88C5;Windows Server 2003 Enterprise Edition&#xFF08; <strong>&#x975E;&#x5FC5;&#x8981;&#x6B65;&#x51D1;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x672C;&#x673A;&#x8FDB;&#x884C;</strong> &#xFF09;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#xFF1A;MemcachedServer&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x8FD8;&#x8981;&#x7ED9;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x7684;Windows Server&#x8BBE;&#x7F6E;&#x597D;IP&#x5730;&#x5740;&#xFF0C;&#x786E;&#x4FDD;&#x5BBF;&#x4E3B;&#x673A;&#x548C;&#x865A;&#x62DF;&#x673A;&#x80FD;&#x591F;&#x4E92;&#x76F8;ping&#x901A;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/276935e.jpg" alt=""></p>
<p>&#xFF08;3&#xFF09;&#x5C06;&#x4E0B;&#x8F7D;&#x7684;Memcached&#x5305;&#x62F7;&#x8D1D;&#x5230;Windows&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6307;&#x5B9A;&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x7684;Windows Server&#x4E2D;&#x7684;C:/MemcachedServer/</p>
<p><img src="http://taojinke.github.io/img/20150703/27695cf.jpg" alt=""></p>
<p>&#xFF08;4&#xFF09;&#x2460;&#x5728;Windows&#x4E2D;&#x5B89;&#x88C5;Memcached&#x670D;&#x52A1;&#xFF1A; <strong>memcached.exe -d install</strong> &#xFF08;&#x90A3;&#x4E48;&#xFF0C;&#x5BF9;&#x5E94;&#x5378;&#x8F7D;&#x547D;&#x4EE4;&#x4E3A;&#xFF1A; <strong>memcached.exe -d uninstall</strong> &#xFF09; </p>
<p><img src="http://taojinke.github.io/img/20150703/2769840.jpg" alt=""></p>
<p>&#x2461;&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x540E;&#x5373;&#x53EF;&#x5728;Windows&#x670D;&#x52A1;&#x5217;&#x8868;&#x4E2D;&#x67E5;&#x770B;&#x5230;Memcached Server&#x7684;&#x670D;&#x52A1;&#xFF0C;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x6211;&#x4EEC;&#x8981;&#x5C06;&#x5176;&#x8BBE;&#x4E3A;&#x5F00;&#x673A;&#x542F;&#x52A8;&#x9879;&#xFF1A;&#x5728;&#x5C5E;&#x6027;&#x4E2D;&#x8BBE;&#x7F6E;&#x542F;&#x52A8;&#x7C7B;&#x578B;&#x4E3A;&#x81EA;&#x52A8;&#x5373;&#x53EF;</p>
<p><img src="http://taojinke.github.io/img/20150703/2769840.jpg" alt=""></p>
<p>&#x2462;&#x5B89;&#x88C5;&#x597D;&#x670D;&#x52A1;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x542F;&#x52A8;Memcached&#x670D;&#x52A1;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#x6765;&#x542F;&#x52A8;&#xFF1A;&#x4E00;&#x662F;&#x76F4;&#x63A5;&#x5728;Windows&#x670D;&#x52A1;&#x5217;&#x8868;&#x91CC;&#x9009;&#x4E2D;Memcached&#x670D;&#x52A1;&#x70B9;&#x51FB;&#x542F;&#x52A8;&#xFF1B;&#x4E8C;&#x662F;&#x5728;&#x547D;&#x4EE4;&#x884C;&#x4E2D;&#x8F93;&#x5165;&#xFF1A; <strong>memcached -d start</strong> &#xFF08;&#x5BF9;&#x5E94;&#x7684;&#x505C;&#x6B62;&#x670D;&#x52A1;&#x547D;&#x4EE4;&#x4E3A;&#xFF1A; <strong>memcached -d stop</strong> &#xFF09; </p>
<p>&#xFF08;5&#xFF09;&#x68C0;&#x6D4B;Memcached&#x670D;&#x52A1;&#x662F;&#x5426;&#x6210;&#x529F;&#x542F;&#x52A8;&#xFF1A;</p>
<p>&#x2460;&#x4F7F;&#x7528;telnet&#x547D;&#x4EE4;&#x8FDE;&#x63A5;&#x5230;&#x767B;&#x5F55;&#x53F0;&#xFF1A;telnet &#x670D;&#x52A1;&#x5668;IP&#x5730;&#x5740; 11211&#xFF08;11211&#x662F;&#x9ED8;&#x8BA4;&#x7684;Memcached&#x670D;&#x52A1;&#x7AEF;&#x53E3;&#x53F7;&#xFF09;&#xFF0C;&#x6211;&#x8FD9;&#x91CC;&#x8F93;&#x5165;&#xFF1A; <strong>telnet 192.168.80.10 11211</strong> &#xFF08;192.168.80.10&#x662F;&#x6211;&#x7684;Windows Server&#x865A;&#x62DF;&#x673A;&#x7684;IP&#x5730;&#x5740;&#xFF09; </p>
<p><img src="http://taojinke.github.io/img/20150703/2769ab1.jpg" alt=""></p>
<p>&#x2461;&#x6253;&#x5370;&#x5F53;&#x524D;Memcache&#x670D;&#x52A1;&#x5668;&#x72B6;&#x6001;&#xFF1A; <strong>stats</strong></p>
<p><img src="http://taojinke.github.io/img/20150703/2769ab1.jpg" alt=""></p>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x901A;&#x8FC7;stats&#x547D;&#x4EE4;&#x5217;&#x51FA;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x7684;Memcached&#x670D;&#x52A1;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x53C8;&#x4EE3;&#x8868;&#x4EC0;&#x4E48;&#x610F;&#x601D;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E0B;&#x56FE;&#x6765;&#x77E5;&#x9053;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2769ab1.png" alt=""></p>
<p>&#xFF08;6&#xFF09;&#x521D;&#x6B65;&#x5B66;&#x4E60;Memcached&#x7684;&#x6570;&#x636E;&#x8BFB;&#x5199;&#x547D;&#x4EE4;&#x64CD;&#x4F5C;&#xFF1A;</p>
<p>&#x2460;&#x6DFB;&#x52A0;&#x6216;&#x66F4;&#x6539;&#x547D;&#x4EE4;&#xFF1A; <strong>set</strong> KeyName &#x989D;&#x5916;&#x4FE1;&#x606F; &#x5B58;&#x6D3B;&#x65F6;&#x95F4; &#x5B58;&#x50A8;&#x5B57;&#x8282;&#x6570; [&#x56DE;&#x8F66;] &#x5177;&#x4F53;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5757; </p>
<p><img src="http://taojinke.github.io/img/20150703/2769d22.jpg" alt=""></p>
<p>&#x8FD9;&#x91CC;&#x989D;&#x5916;&#x4FE1;&#x606F;&#x4E3A;0&#xFF0C;&#x4EE3;&#x8868;&#x65E0;&#xFF1B;&#x5B58;&#x6D3B;&#x65F6;&#x95F4;&#x4E3A;0&#xFF0C;&#x4EE3;&#x8868;&#x6C38;&#x4E45;&#xFF1B;&#x800C;&#x5177;&#x4F53;&#x7684;&#x6570;&#x636E;&#x5757;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6240;&#x8BF4;&#x7684;Key/Value&#x4E2D;&#x7684;Value&#xFF1B;</p>
<p>PS&#xFF1A;&#x8FD9;&#x91CC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <strong>add</strong> KeyName &#x989D;&#x5916;&#x4FE1;&#x606F; &#x5B58;&#x6D3B;&#x65F6;&#x95F4; &#x5B58;&#x50A8;&#x5B57;&#x8282;&#x6570; [&#x56DE;&#x8F66;] &#x5177;&#x4F53;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5757;&#x3002;&#x4E0D;&#x8FC7;set&#x663E;&#x7136;&#x66F4;&#x4E3A;&#x5F3A;&#x5927;&#xFF0C;&#x5B83;&#x4F1A;&#x5224;&#x65AD;keyname&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#x5219;&#x65B0;&#x589E;&#xFF0C;&#x5B58;&#x5728;&#x5219;&#x4FEE;&#x6539;&#xFF1B; </p>
<p>&#x2461;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;&#xFF1A; <strong>get</strong> KeyName&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;key1&#x7684;&#x6570;&#x636E;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#xFF1A;get key1&#x4FBF;&#x83B7;&#x53D6;&#x4E86;key1&#x8FD9;&#x4E2A;key&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x4FE1;&#x606F;&#xFF1B; </p>
<p>&#x2462;&#x66F4;&#x65B0;&#x547D;&#x4EE4;&#xFF1A; <strong>replace</strong> KeyName &#x989D;&#x5916;&#x4FE1;&#x606F; &#x5B58;&#x6D3B;&#x65F6;&#x95F4; &#x5B58;&#x50A8;&#x5B57;&#x8282;&#x6570; [&#x56DE;&#x8F66;] &#x5177;&#x4F53;&#x5B58;&#x50A8;&#x7684;&#x6570;&#x636E;&#x5757; </p>
<p><img src="http://taojinke.github.io/img/20150703/2769d22.jpg" alt=""></p>
<p>&#x2463;&#x5220;&#x9664;&#x547D;&#x4EE4;&#xFF1A; <strong>delete</strong> KeyName </p>
<p><img src="http://taojinke.github.io/img/20150703/2769f93.jpg" alt=""></p>
<h2 id="&#x56DB;&#x3001;&#x5B66;&#x4E60;&#x5C0F;&#x7ED3;">&#x56DB;&#x3001;&#x5B66;&#x4E60;&#x5C0F;&#x7ED3;</h2><p>&#x672C;&#x7BC7;&#x6211;&#x4EEC;&#x521D;&#x6B65;&#x4E86;&#x89E3;&#x4E86;&#x4EC0;&#x4E48;&#x662F;Memcached&#xFF0C;&#x4E0B;&#x8F7D;&#x5E76;&#x5B89;&#x88C5;&#x4E86;Memcached&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x5176;&#x8BBE;&#x4E3A;Windows&#x81EA;&#x542F;&#x52A8;&#x670D;&#x52A1;&#xFF0C;&#x901A;&#x8FC7;telnet&#x8FDE;&#x63A5;&#x5230;Memcached&#x767B;&#x5F55;&#x53F0;&#x4F7F;&#x7528;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x3002;&#x603B;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;Memcached&#x662F;&#x4E00;&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;Key/Value&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;&#xFF0C;&#x901A;&#x8FC7;&#x6784;&#x5EFA;Memcached&#x96C6;&#x7FA4;&#xFF0C;&#x80FD;&#x591F;&#x9002;&#x5E94;&#x5927;&#x578B;&#x7F51;&#x7AD9;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x9700;&#x8981;&#x3002;&#x4E0B;&#x4E00;&#x7BC7;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5728;.Net&#x4E2D;&#x8FDE;&#x63A5;&#x5E76;&#x64CD;&#x4F5C;Memcached&#xFF0C;&#x6700;&#x540E;&#x4EE5;&#x4E00;&#x4E2A;&#x7EFC;&#x5408;&#x6848;&#x4F8B;&#x6765;&#x4F53;&#x73B0;Memcached&#x4F5C;&#x4E3A;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x7684;&#x91CD;&#x8981;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x5982;&#x679C;&#x4EB2;&#x89C9;&#x5F97;&#x6211;&#x7684;&#x6587;&#x7AE0;&#x4E0D;&#x9519;&#x6216;&#x8005;&#x5BF9;&#x4F60;&#x6709;&#x7528;&#xFF0C;&#x9EBB;&#x70E6;&#x5E2E;&#x6211;&#x70B9;&#x4E2A;&#x201C;&#x63A8;&#x8350;&#x201D;&#xFF0C;&#x8BA9;&#x6211;&#x66F4;&#x6709;&#x52A8;&#x529B;&#x7EE7;&#x7EED;&#x5199;&#x4E0B;&#x53BB;&#xFF0C;&#x8C22;&#x8C22;&#xFF01;</p>
<h2 id="&#x53C2;&#x8003;&#x6587;&#x732E;">&#x53C2;&#x8003;&#x6587;&#x732E;</h2><p>&#xFF08;1&#xFF09;&#x4F20;&#x667A;&#x64AD;&#x5BA2;&#x9A6C;&#x4F26;&#xFF0C;&#x300A;Memcached&#x516C;&#x5F00;&#x8BFE;&#x300B;&#xFF0C;<a href="http://bbs.itcast.cn/thread-14836-1-1.html" target="_blank" rel="external">http://bbs.itcast.cn/thread-14836-1-1.html</a></p>
<p>&#xFF08;2&#xFF09;charlee&#xFF0C;&#x300A;Memcached&#x5B8C;&#x5168;&#x5256;&#x6790;&#x300B;&#xFF0C;<a href="http://kb.cnblogs.com/page/42731/" target="_blank" rel="external">http://kb.cnblogs.com/page/42731/</a></p>
<p>&#xFF08;3&#xFF09;&#x5F20;&#x948A;&#xFF0C;&#x300A;Memcached&#x4ECB;&#x7ECD;&#x300B;&#xFF0C;<a href="http://blog.csdn.net/zz198808/article/details/8032571" target="_blank" rel="external">http://blog.csdn.net/zz198808/article/details/8032571</a></p>
<p>&#xFF08;4&#xFF09;toxic&#xFF0C;&#x300A;memcached&#x300B;&#xFF0C;<a href="http://www.cnblogs.com/lost-1987/articles/3069460.html" target="_blank" rel="external">http://www.cnblogs.com/lost-1987/articles/3069460.html</a></p>
<p>&#x8F6C;&#x81EA;&#xFF1A;<a href="http://www.cnblogs.com/edisonchou/p/3855517.html" target="_blank" rel="external">http://www.cnblogs.com/edisonchou/p/3855517.html</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2776554/" title="【转】 Key/Value之王Memcached初探：二、Memcached在.Net中的基本操作 -" itemprop="url">【转】 Key/Value之王Memcached初探：二、Memcached在.Net中的基本操作 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:44.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="&#x4E00;&#x3001;Memcached_ClientLib_For_-Net">&#x4E00;&#x3001;Memcached ClientLib For .Net</h2><p>&#x9996;&#x5148;&#xFF0C;&#x4E0D;&#x5F97;&#x4E0D;&#x8BF4;&#xFF0C;&#x8BB8;&#x591A;&#x8BED;&#x8A00;&#x90FD;&#x5B9E;&#x73B0;&#x4E86;&#x8FDE;&#x63A5;Memcached&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5176;&#x4E2D;&#x4EE5;Perl&#x3001;PHP&#x4E3A;&#x4E3B;&#x3002; &#x4EC5;&#x4EC5;memcached&#x7F51;&#x7AD9;&#x4E0A;&#x5217;&#x51FA;&#x7684;&#x8BED;&#x8A00;&#x5C31;&#x6709;&#xFF1A;Perl&#x3001;PHP&#x3001;Python&#x3001;Ruby&#x3001; <strong>C#&#x3001;</strong> C/C++&#x4EE5;&#x53CA;Lua&#x7B49;&#x3002; </p>
<p>&#x90A3;&#x4E48;&#xFF0C;&#x6211;&#x4EEC;&#x4F5C;&#x4E3A;.Net&#x7801;&#x519C;&#xFF0C;&#x81EA;&#x7136;&#x662F;&#x4F7F;&#x7528;C#&#x3002;&#x65E2;&#x7136;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x6709;.Net&#x7248;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x5C31;&#x53BB;&#x4E0B;&#x8F7D;&#x4E00;&#x4E2A;&#x6765;&#x8BD5;&#x8BD5;&#x3002;</p>
<p>&#x4E0B;&#x8F7D;&#x6587;&#x4EF6;&#xFF1A; <a href="http://pan.baidu.com/s/1w9Q8I" target="_blank" rel="external">http://pan.baidu.com/s/1w9Q8I</a></p>
<p>memcached clientlib&#x9879;&#x76EE;&#x5730;&#x5740;&#xFF1A; <a href="http://sourceforge.net/projects/memcacheddotnet/" target="_blank" rel="external">http://sourceforge.net/projects/memcacheddotnet/</a></p>
<p>&#x89E3;&#x538B;&#x8BE5;&#x5305;&#xFF0C;&#x91CC;&#x9762;&#x6709;1.1&#x548C;2.0&#x4E24;&#x4E2A;&#x7248;&#x672C;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;2.0&#x7248;&#x672C;&#x7684;&#x3002;&#xFF08;&#x5728;&#x538B;&#x7F29;&#x5305;&#x4E2D;&#x7684;&#x76EE;&#x5F55;&#x5730;&#x5740;&#x4E3A;&#xFF1A;\memcacheddotnet_clientlib-1.1.5\memcacheddotnet\trunk\clientlib\src\clientlib\bin\2.0\Release&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/276d067.jpg" alt=""></p>
<p>&#x4E0A;&#x9762;&#x7684;&#x8FD9;&#x56DB;&#x4E2A;dll&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5F15;&#x5165;&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x7A0B;&#x5E8F;&#x96C6;&#xFF0C;&#x6709;&#x4E86;&#x4ED6;&#x4EEC;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x548C;Memcached&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x4E86;&#xFF0C;&#x723D;&#x6B6A;&#x6B6A;&#x554A;&#x3002;</p>
<h2 id="&#x4E8C;&#x3001;&#x5728;-Net&#x4E2D;&#x8FDB;&#x884C;Memcached&#x57FA;&#x672C;&#x64CD;&#x4F5C;">&#x4E8C;&#x3001;&#x5728;.Net&#x4E2D;&#x8FDB;&#x884C;Memcached&#x57FA;&#x672C;&#x64CD;&#x4F5C;</h2><h2 id="2-1_&#x57FA;&#x672C;&#x7684;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x64CD;&#x4F5C;">2.1 &#x57FA;&#x672C;&#x7684;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x64CD;&#x4F5C;</h2><p>&#xFF08;1&#xFF09;&#x9996;&#x5148;&#xFF0C;&#x6253;&#x5F00;Windows Server 2003&#x865A;&#x62DF;&#x673A;&#xFF0C;&#x5F00;&#x542F;Memcached&#x670D;&#x52A1;&#xFF1B;&#xFF08;&#x975E;&#x5FC5;&#x8981;&#x64CD;&#x4F5C;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x662F;&#x5728;&#x672C;&#x673A;&#xFF0C;&#x5219;&#x53EF;&#x8DF3;&#x8FC7;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;&#x53EA;&#x9700;&#x5F00;&#x542F;Memcached&#x670D;&#x52A1;&#x5373;&#x53EF;&#xFF09;</p>
<p><img src="http://taojinke.github.io/img/20150703/276d067.jpg" alt=""></p>
<p>&#xFF08;2&#xFF09;&#x2460;&#x6253;&#x5F00;VS&#xFF0C;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;C#&#x7684;&#x63A7;&#x5236;&#x53F0;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;&#xFF1A;MemcachedClientDemo&#x3002;</p>
<p>&#x2461;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x53D6;&#x540D;&#x4E3A;Lib&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x4E0A;&#x9762;&#x4E0B;&#x8F7D;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#x96C6;dll&#x62F7;&#x8D1D;&#x5230;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#xFF0C;&#x5E76;&#x6DFB;&#x52A0;&#x5BF9;&#x8FD9;&#x51E0;&#x4E2A;dll&#x7684;&#x5F15;&#x7528;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/276d2d8.jpg" alt=""></p>
<p>&#xFF08;3&#xFF09;&#x5F00;&#x59CB;&#x5199;&#x4EE3;&#x7801;&#xFF0C;&#x901A;&#x8FC7;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p> <img src="http://taojinke.github.io/img/20150703/276d2d8.gif" alt=""></p>
<pre><code>    [<span class="class">STAThread</span>]
    static void <span class="class">Main</span>(string[] args)
    {
// <span class="class">Memcached</span>&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;
// &amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53F0</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x9017</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x9694</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;quot;<span class="number">192.168</span>.80.10:<span class="number">11211</span>&amp;quot;,&amp;quot;<span class="number">192.168</span>.80.11:<span class="number">11211</span>&amp;quot;
string[] serverList = { &amp;quot;<span class="number">192.168</span>.80.10:<span class="number">11211</span>&amp;quot; };
// &amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;<span class="class">SocketIO</span>&amp;<span class="symbol">#x6C60</span>;
string poolName = &amp;quot;<span class="class">MyPool</span>&amp;quot;;
<span class="class">SockIOPool</span> sockIOPool = <span class="class">SockIOPool</span>.<span class="class">GetInstance</span>(poolName);
// &amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;
sockIOPool.<span class="class">SetServers</span>(serverList);
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x76EE</span>;
sockIOPool.<span class="class">InitConnections</span> = <span class="number">3</span>;
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x76EE</span>;
sockIOPool.<span class="class">MinConnections</span> = <span class="number">3</span>;
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x76EE</span>;
sockIOPool.<span class="class">MaxConnections</span> = <span class="number">5</span>;
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5957</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x6BEB</span>;&amp;<span class="symbol">#x79D2</span>;&amp;<span class="symbol">#xFF09</span>;
sockIOPool.<span class="class">SocketConnectTimeout</span> = <span class="number">1000</span>;
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5957</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x6BEB</span>;&amp;<span class="symbol">#x79D2</span>;&amp;<span class="symbol">#xFF09</span>;
sockIOPool.<span class="class">SocketTimeout</span> = <span class="number">3000</span>;
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x8FD0</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7761</span>;&amp;<span class="symbol">#x7720</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x90A3</span>;&amp;<span class="symbol">#x4E48</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x52A8</span>;
sockIOPool.<span class="class">MaintenanceSleep</span> = <span class="number">30</span>;
// &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;<span class="class">SockIO</span>&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6545</span>;&amp;<span class="symbol">#x969C</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;
sockIOPool.<span class="class">Failover</span> = <span class="keyword">true</span>;
// &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x7528</span>;nagle&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x52A8</span>;
sockIOPool.<span class="class">Nagle</span> = <span class="keyword">false</span>;
// &amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;
sockIOPool.<span class="class">Initialize</span>();
// &amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x4F8B</span>;
<span class="class">MemcachedClient</span> memClient = new <span class="class">MemcachedClient</span>();
// &amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x8BBF</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x7684</span>;<span class="class">SockIO</span>&amp;<span class="symbol">#x6C60</span>;
memClient.<span class="class">PoolName</span> = poolName;
// &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x538B</span>;&amp;<span class="symbol">#x7F29</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x538B</span>;&amp;<span class="symbol">#x7F29</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x538B</span>;&amp;<span class="symbol">#x7F29</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x95E8</span>;&amp;<span class="symbol">#x69DB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x538B</span>;&amp;<span class="symbol">#x7F29</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5F62</span>;&amp;<span class="symbol">#x5F0F</span>;
memClient.<span class="class">EnableCompression</span> = <span class="keyword">false</span>;
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;----------------------------&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x8BD5</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;----------------------------&amp;quot;);
// <span class="number">01.</span>&amp;<span class="symbol">#x7B80</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E0E</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;
memClient.<span class="class">Set</span>(&amp;quot;test1&amp;quot;, &amp;quot;edisonchou&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">test1:</span>{<span class="number">0</span>}&amp;quot;, memClient.<span class="class">Get</span>(&amp;quot;test1&amp;quot;));
// <span class="number">02.</span>&amp;<span class="symbol">#x5148</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x518D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;
memClient.<span class="class">Set</span>(&amp;quot;test2&amp;quot;, &amp;quot;jacky&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">test2:</span>{<span class="number">0</span>}&amp;quot;, memClient.<span class="class">Get</span>(&amp;quot;test2&amp;quot;));
memClient.<span class="class">Set</span>(&amp;quot;test2&amp;quot;, &amp;quot;edwin&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">test2:</span>{<span class="number">0</span>}&amp;quot;, memClient.<span class="class">Get</span>(&amp;quot;test2&amp;quot;));
memClient.<span class="class">Replace</span>(&amp;quot;test2&amp;quot;, &amp;quot;lousie&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">test2:</span>{<span class="number">0</span>}&amp;quot;, memClient.<span class="class">Get</span>(&amp;quot;test2&amp;quot;));
// <span class="number">03.</span>&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;<span class="class">Key</span>&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5728</span>;
if (memClient.<span class="class">KeyExists</span>(&amp;quot;test2&amp;quot;))
{
    <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="class">Key</span>:test2 is existed&amp;quot;);
}
// <span class="number">04.</span>&amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5B9A</span>;<span class="class">Key</span>&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;
memClient.<span class="class">Add</span>(&amp;quot;test3&amp;quot;, &amp;quot;memcached&amp;quot;);
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">test3:</span>{<span class="number">0</span>}&amp;quot;, memClient.<span class="class">Get</span>(&amp;quot;test3&amp;quot;));
memClient.<span class="class">Delete</span>(&amp;quot;test3&amp;quot;);
if (!memClient.<span class="class">KeyExists</span>(&amp;quot;test3&amp;quot;))
{
    <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="class">Key</span>:test3 is not existed&amp;quot;);
}
// <span class="number">05.</span>&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">5</span>&amp;<span class="symbol">#x79D2</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x671F</span>;
memClient.<span class="class">Add</span>(&amp;quot;test4&amp;quot;, &amp;quot;expired&amp;quot;, <span class="class">DateTime</span>.<span class="class">Now</span>.<span class="class">AddSeconds</span>(<span class="number">5</span>));
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="method">test4:</span>{<span class="number">0</span>}&amp;quot;, memClient.<span class="class">Get</span>(&amp;quot;test4&amp;quot;));
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="class">Please</span> waiting the sleeping time&amp;quot;);
<span class="class">System</span>.<span class="class">Threading</span>.<span class="class">Thread</span>.<span class="class">Sleep</span>(<span class="number">6000</span>);
if(!memClient.<span class="class">KeyExists</span>(&amp;quot;test4&amp;quot;))
{
    <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;test4 is expired&amp;quot;);
}
<span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;----------------------------&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x8BD5</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;----------------------------&amp;quot;);
// &amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;<span class="class">SockIO</span>&amp;<span class="symbol">#x6C60</span>;
sockIOPool.<span class="class">Shutdown</span>();
<span class="class">Console</span>.<span class="class">ReadKey</span>();
    }
</code></pre><p> <img src="http://taojinke.github.io/img/20150703/276d549.gif" alt=""></p>
<p>&#x8FD9;&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x7EC6;&#x7EC6;&#x5206;&#x6790;&#x4E0B;&#x8FD9;&#x6BB5;&#x795E;&#x5947;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p>&#x2460;&#x9996;&#x5148;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;string&#x7C7B;&#x578B;&#x7684;&#x6570;&#x7EC4;&#x6765;&#x8BB0;&#x5F55; <strong>Memcached&#x670D;&#x52A1;&#x5668;&#x7684;IP&#x4E0E;&#x7AEF;&#x53E3;&#x4FE1;&#x606F;</strong> &#xFFFD;&#xFFFD;&#xFFFD;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x5982;&#x679C;&#x6709;&#x591A;&#x53F0;Memcached&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x9017;&#x53F7;&#x5206;&#x9694;&#x5F00;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;&quot;192.168.80.10:11211&quot;,&quot;192.168.80.11:11211&quot;,&quot;192.168.80.12:11211&quot;&#xFF1B; </p>
<p>&#x2461;SockIOPool&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;Socket&#xFF08;&#x5957;&#x63A5;&#x5B57;&#xFF09;&#x7684;&#x8FDE;&#x63A5;&#x6C60;&#xFF0C;&#x6362;&#x4E2A;&#x65B9;&#x5F0F;&#x7406;&#x89E3;&#xFF1A;Memcached&#x5176;&#x5B9E;&#x5C31;&#x662F;&#x4E00;&#x4E2A; <strong>Socket&#x7684;&#x670D;&#x52A1;&#x5668;&#x7AEF;</strong> &#xFF0C;&#x5B83;&#x4E0D;&#x505C;&#x5730;&#x63A5;&#x6536;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x6765;&#x7684;&#x8BFB;&#x5199;&#x8BF7;&#x6C42;&#x547D;&#x4EE4;&#x3002;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;SockIOPool.GetInstance(&quot;MyPool&quot;)&#x6765;&#x83B7;&#x53D6;&#x4E00;&#x4E2A;&#x540D;&#x4E3A;MyPool&#x7684;&#x8FDE;&#x63A5;&#x6C60;&#x5B9E;&#x4F8B;&#xFF0C;&#x770B;&#x5230;GetInstance()&#x8FD9;&#x4E2A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x4FBF;&#x77E5;&#x9053;&#x8FD9;&#x662F;&#x91C7;&#x7528;&#x4E86;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#x3002;&#x540E;&#x9762;&#x6211;&#x4EEC;&#x4E3A;&#x5176;&#x914D;&#x7F6E;&#x4E86;&#x53EF;&#x8BBF;&#x95EE;&#x7684;Memcached&#x670D;&#x52A1;&#x5668;&#x5217;&#x8868;&#x3001;&#x8FDE;&#x63A5;&#x6570;&#x3001;&#x5957;&#x63A5;&#x5B57;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x7B49;&#x914D;&#x7F6E;&#xFF0C;&#x6700;&#x540E;&#x8C03;&#x7528;Initialize()&#x65B9;&#x6CD5;&#x6B63;&#x5F0F;&#x5730;&#x521D;&#x59CB;&#x5316;&#x8FDE;&#x63A5;&#x6C60;&#xFF0C;&#x7B49;&#x5F85;&#x540E;&#x9762;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#xFF1B; </p>
<p>PS&#xFF1A;&#x795E;&#x9A6C;&#x662F; <strong>Socket</strong> &#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x751F;&#x6D3B;&#x4E2D;&#x7684;&#x573A;&#x666F;&#x6765;&#x7406;&#x89E3;&#xFF1A;&#x5047;&#x5982;&#x4F60;&#x8981;&#x6253;&#x7535;&#x8BDD;&#x7ED9;&#x4E00;&#x4E2A;&#x670B;&#x53CB;&#xFF0C;&#x62FF;&#x8D77;&#x7535;&#x8BDD;&#x5148;&#x62E8;&#x53F7;&#xFF0C;&#x670B;&#x53CB;&#x542C;&#x5230;&#x7535;&#x8BDD;&#x94C3;&#x58F0;&#x540E;&#x63D0;&#x8D77;&#x7535;&#x8BDD;&#xFF0C;&#x8FD9;&#x65F6;&#x4F60;&#x548C;&#x4F60;&#x7684;&#x670B;&#x53CB;&#x5C31;&#x5EFA;&#x7ACB;&#x8D77;&#x4E86;&#x8FDE;&#x63A5;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8BB2;&#x8BDD;&#x4E86;&#x3002;&#x7B49;&#x5230;&#x4F60;&#x4EEC;&#x7684;&#x4EA4;&#x6D41;&#x7ED3;&#x675F;&#xFF0C;&#x6302;&#x65AD;&#x7535;&#x8BDD;&#x4EE5;&#x7ED3;&#x675F;&#x6B64;&#x6B21;&#x4EA4;&#x8C08;&#x3002;So&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x7535;&#x8BDD;&#x5C31;&#x662F;&#x4E00;&#x4E2A;Socket&#xFF0C;&#x4F60;&#x6253;&#x7535;&#x8BDD;&#x76F8;&#x5F53;&#x4E8E;&#x7533;&#x8BF7;&#x4E86;&#x4E00;&#x4E2A;Socket&#xFF0C;&#x544A;&#x8BC9;&#x4E86;Socket&#x4F60;&#x8981;&#x6253;&#x7ED9;&#x8C01;&#xFF08;&#x5BF9;&#x65B9;&#x7684;&#x7535;&#x8BDD;&#x53F7;&#x7801;&#x4F60;&#x4E8B;&#x5148;&#x77E5;&#x9053;&#xFF09;&#x3002;&#x7136;&#x540E;&#xFF0C;&#x4F60;&#x548C;&#x5BF9;&#x65B9;&#x8FDB;&#x884C;&#x804A;&#x5929;&#x901A;&#x8BDD;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x5728;&#x5411;Socket&#x53D1;&#x9001;&#x6570;&#x636E;&#x548C;&#x4ECE;Socket&#x63A5;&#x6536;&#x6570;&#x636E;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x901A;&#x8BDD;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x4E00;&#x65B9;&#x6302;&#x6389;&#x7535;&#x8BDD;&#x5219;&#x76F8;&#x5F53;&#x4E8E;&#x5173;&#x95ED;Socket&#xFF0C;&#x64A4;&#x9500;&#x8FDE;&#x63A5;&#x3002; </p>
<p>&#x5728;&#x8BA1;&#x7B97;&#x673A;&#x7F51;&#x7EDC;&#x7684;&#x8FDE;&#x63A5;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;Socket&#x4E00;&#x822C;&#x4F1A;&#x8BB0;&#x5F55;&#x670D;&#x52A1;&#x5668;&#x4E3B;&#x673A;&#x7684;IP&#x5730;&#x5740;&#x3001;&#x7AEF;&#x53E3;&#x53F7;&#xFF0C;&#x7136;&#x540E;&#x5411;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#x5E76;&#x53D1;&#x9001;&#x548C;&#x63A5;&#x53D7;&#x6570;&#x636E;&#x3002;&#x800C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5F00;&#x542F;&#x4E00;&#x4E2A;&#x76D1;&#x542C;&#x7684;&#x670D;&#x52A1;&#xFF0C;&#x5219;&#x662F;&#x76F8;&#x5F53;&#x4E8E;&#x4F7F;&#x7528;Socket&#x6307;&#x5B9A;&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x7136;&#x540E;&#x7B49;&#x5F85;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x540E;&#x5219;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x3002;&#x4F1A;&#x8BDD;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x5219;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002;</p>
<p>&#x2462;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;MemcachedClient&#xFF08;Memcached&#x5BA2;&#x6237;&#x7AEF;&#xFF09;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x6307;&#x5B9A;&#x8981;&#x8FDE;&#x63A5;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x8BBE;&#x7F6E;&#x662F;&#x5426;&#x542F;&#x7528;&#x538B;&#x7F29;&#xFF08;&#x8FD9;&#x91CC;&#x8BBE;&#x7F6E;&#x4E3A;false&#xFF09;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x8BBE;&#x7F6E;&#x662F;&#x5426;&#x8D77;&#x7528;&#x538B;&#x7F29;&#xFF1A; &#x5728;Memcached&#x4E2D;&#xFF0C;&#x6570;&#x636E;&#x662F;&#x4EE5;Key/Value&#x5BF9;&#x7684;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x5B58;&#x50A8;&#xFF0C;Key&#x7684;&#x957F;&#x5EA6;&#x662F;&#x6709;&#x9650;&#x5236;&#x7684;&#xFF0C;Memcached&#x670D;&#x52A1;&#x7AEF;&#x5185;&#x90E8;&#x9650;&#x5236;Key&#x4E3A;250&#x5B57;&#x7B26;&#xFF0C;&#x8FD9;&#x4E2A;&#x957F;&#x5EA6;&#x7EDD;&#x5BF9;&#x662F;&#x591F;&#x7528;&#x4E86;&#xFF0C;&#x5EFA;&#x8BAE;&#x4E0D;&#x8981;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x957F;&#x5EA6;&#xFF0C;&#x5C3D;&#x91CF;&#x63A7;&#x5236;&#x5728;200&#x4E2A;&#x5B57;&#x7B26;&#x4EE5;&#x4E0B;&#x3002;&#x5176;&#x5B9E;&#xFF0C;&#x6211;&#x4EEC;&#x6700;&#x5173;&#x5FC3;&#x7684;&#x8FD8;&#x662F;Value&#x7684;&#x9650;&#x5236;&#x957F;&#x5EA6;&#xFF0C;Value&#x7684;&#x9650;&#x5236;&#x5927;&#x5C0F;&#x4E3A;1MB&#xFF0C;&#x90A3;&#x4E48;&#x5982;&#x679C;&#x6709;&#x65F6;&#x5019;&#x8D85;&#x8FC7;&#x4E86;1MB&#x600E;&#x4E48;&#x529E;&#x5462;&#xFF1F;&#x8FD9;&#x65F6;&#x5019;&#x4E5F;&#x8BB8;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x538B;&#x7F29;&#x4E86;&#xFF0C;&#x4F7F;&#x7528;&#x538B;&#x7F29;&#x540E;&#x5982;&#x679C;&#x5C0F;&#x4E8E;1Mb&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5230;&#x8BE5;Key&#x4E2D;&#x3002;&#x4F46;&#x5982;&#x679C;&#x5373;&#x4F7F;&#x538B;&#x7F29;&#x540E;&#x8FD8;&#x662F;&#x8D85;&#x8FC7;1Mb&#xFF0C;&#x90A3;&#x53EF;&#x80FD;&#x4F1A;&#x62C6;&#x5206;&#x5230;&#x591A;&#x4E2A;Key&#x4E2D;&#x53BB;&#x4E86;&#x3002;</p>
<p>PS&#xFF1A;Key&#x4E0D;&#x80FD;&#x6709;&#x7A7A;&#x683C;&#x548C;&#x63A7;&#x5236;&#x5B57;&#x7B26;&#x3002;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x8F83;&#x77ED;&#x7684;Key&#xFF0C;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#x670D;&#x52A1;&#x5668;&#x5185;&#x5B58;&#x548C;&#x7F51;&#x7EDC;&#x5E26;&#x5BBD;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x6700;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x70B9;&#x662F;&#xFF1A;Key&#x4E0D;&#x80FD;&#x91CD;&#x590D;&#xFF01; </p>
<p>&#x2463;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x7684;&#x5404;&#x79CD;&#x8BFB;&#x5199;API&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x6D4B;&#x8BD5;&#xFF0C;&#x5982;Set&#x3001;Get&#x3001;Replace&#x3001;Add&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x7684;&#x6DFB;&#x52A0;&#x548C;&#x4FEE;&#x6539;&#xFF0C;&#x800C;KeyExists&#x5219;&#x53EF;&#x4EE5;&#x5224;&#x65AD;&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x662F;&#x5426;&#x542B;&#x6709;&#x6307;&#x5B9A;Key&#x7684;&#x6570;&#x636E;&#xFF0C;Delete&#x5219;&#x63D0;&#x4F9B;&#x4E86;&#x5220;&#x9664;&#x6307;&#x5B9A;Key&#x7684;&#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x91CC;&#xFF0C;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x770B;&#x4EE3;&#x7801;&#x5C31;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#xFF0C;&#x6211;&#x5C31;&#x4E0D;&#x591A;&#x5E9F;&#x8BDD;&#x4E86;&#x3002;&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x6CE8;&#x610F;&#x5230;&#x6709;&#x4E2A;&#x6570;&#x636E;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x7684;&#x53EF;&#x9009;&#x53C2;&#x6570;&#xFF0C;&#x5F53;&#x6570;&#x636E;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x5B58;&#x50A8;&#x4E86;&#x4E00;&#x5B9A;&#x65F6;&#x95F4;&#x540E;&#x5C31;&#x4F1A;&#x5931;&#x6548;&#xFF0C;&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x76F8;&#x5F53;&#x6709;&#x7528;&#x3002;</p>
<p>&#xFF08;4&#xFF09;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x8C03;&#x8BD5;&#xFF0C;&#xFFFD;&#xFFFD;&#xFFFD;&#x770B;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/276da2b.jpg" alt=""></p>
<h2 id="2-2_&#x8FDB;&#x9636;&#x7684;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x64CD;&#x4F5C;">2.2 &#x8FDB;&#x9636;&#x7684;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x64CD;&#x4F5C;</h2><p>&#xFF08;1&#xFF09;&#x5728;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x514B;&#x9686;&#x5DF2;&#x5B58;&#x5728;&#x7684;Windows Server&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E24;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x540D;&#x79F0;&#x4E3A;&#xFF1A;MemcacheServer1&#x548C;MemcachedServer2&#xFF0C;IP&#x5730;&#x5740;&#x8BBE;&#x7F6E;&#x4E3A;&#xFF1A;192.168.80.10&#x4E0E;192.168.80.11&#xFF0C;&#x6D4B;&#x8BD5;&#x4E24;&#x53F0;&#x865A;&#x62DF;&#x673A;&#x4E0E;&#x5BBF;&#x4E3B;&#x673A;&#x662F;&#x5426;&#x80FD;&#x591F;&#x4E92;&#x76F8;Ping&#x901A;&#xFF0C;&#x4E3A;&#x6784;&#x5EFA;Memcached&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x505A;&#x4E00;&#x4E2A;&#x6700;&#x5C0F;&#x5316;&#x7684;&#x51C6;&#x5907;&#xFF1B;</p>
<p><img src="http://taojinke.github.io/img/20150703/276dc9c.jpg" alt=""></p>
<p>&#xFF08;2&#xFF09;&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x6709;&#x4E86;&#x4E24;&#x53F0;Memcached&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x5F97;&#x8BD5;&#x8BD5;Memcached&#x96C6;&#x7FA4;&#x554A;&#xFF0C;&#x7531;&#x4E8E;Memcached&#x7684;&#x96C6;&#x7FA4;&#x662F;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x670D;&#x52A1;&#x5668;&#x7684;IP&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#x52A0;&#x5165;&#x670D;&#x52A1;&#x5668;&#x5217;&#x8868;&#x7684;string&#x6570;&#x7EC4;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;&#x4E8E;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x4FEE;&#x6539;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p>&#x2460;&#x9996;&#x5148;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;App.config&#x6587;&#x4EF6;&#xFF0C;&#x65B0;&#x589E;&#x4E00;&#x4E2A;AppSetting&#x9879;&#x5982;&#x4E0B;&#xFF1A;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5730;&#x5740;&#x4FE1;&#x606F;&#x90FD;&#x662F;&#x5199;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#xFF0C;&#x4E3A;&#x4E86;&#x8FFD;&#x6C42;&#x6807;&#x51C6;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x5199;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x91CC;&#x8FB9;</p>
<p><img src="http://taojinke.github.io/img/20150703/276dc9c.jpg" alt=""></p>
<p>&#x2461;&#x5C06;serverList&#x91CD;&#x65B0;&#x5B9A;&#x4E49;&#xFF1A;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x91CC;&#x8FB9;&#x7684;Value&#xFF1B;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;  &#x8981;&#x4F7F;&#x7528;ConfigurationManager&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x5F15;&#x7528;&#x4E2D;&#x6DFB;&#x52A0;&#x5BF9;System.Configuration&#x8FD9;&#x4E2A;dll&#x7684;&#x5F15;&#x7528;  &#xFF1B; </p>
<pre><code>string<span class="comment">[]</span> serverList = ConfigurationManager.AppSettings<span class="comment">[&amp;quot;MemcachedServers&amp;quot;]</span>.Split(&amp;apos;,&amp;apos;);
</code></pre><p>&#xFF08;3&#xFF09;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5148;&#x91CD;&#x542F;Memcached1&#xFF08;192.168.80.10&#xFF09;&#x7684;Memcached&#x670D;&#x52A1;&#xFF0C;&#x6E05;&#x7A7A;&#x5DF2;&#x7ECF;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;&#x5185;&#x5BB9;&#xFF0C;&#x786E;&#x4FDD;&#x4E24;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x73B0;&#x5728;&#x90FD;&#x6CA1;&#x6709;&#x6570;&#x636E;&#xFF1B;&#x7136;&#x540E;&#xFF0C;&#x91CD;&#x65B0;&#x8FD0;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x518D;&#x6B21;&#x5B8C;&#x6210;&#x4EE3;&#x7801;&#x6D4B;&#x8BD5;&#xFF0C;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#x8FD8;&#x662F;&#x5982;&#x4E0B;&#x56FE;&#xFF0C;&#x8BF4;&#x660E;&#x6211;&#x4EEC;&#x914D;&#x7F6E;&#x7684;&#x4E24;&#x53F0;Memcached&#x96C6;&#x7FA4;&#x5DF2;&#x7ECF;&#x914D;&#x7F6E;&#x6210;&#x529F;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/276df0d.jpg" alt=""></p>
<p>&#xFF08;4&#xFF09;&#x5728;&#x865A;&#x62DF;&#x673A;&#x4E2D;&#x4F7F;&#x7528;telnet&#x67E5;&#x770B;&#x6BCF;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x5177;&#x4F53;&#x4FDD;&#x5B58;&#x4E86;&#x54EA;&#x4E2A;Key/Value&#x5BF9;&#xFF0C;&#x8FD9;&#x91CC;&#x7531;&#x4E8E;test3&#x548C;test4&#x5747;&#x88AB;&#x5220;&#x9664;&#x6216;&#x5DF2;&#x5931;&#x6548;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x9700;&#x67E5;&#x770B;&#x524D;&#x4E24;&#x4E2A;Key/Value&#x5BF9;&#xFF1A;</p>
<p>&#x2460;MemcacheServer1(192.168.80.10)&#xFF1A;&#x4FDD;&#x5B58;&#x4E86;&#x7B2C;&#x4E8C;&#x4E2A;Key/Value&#x5BF9;&#xFF0C;&lt;test2:lousie&gt;</p>
<p><img src="http://taojinke.github.io/img/20150703/276e17e.jpg" alt=""></p>
<p>&#x2461;MemcacheServer2(192.168.80.11)&#xFF1A;&#x4FDD;&#x5B58;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A;Key/Value&#x5BF9;&#xFF0C;&lt;test1:edisonchou&gt;</p>
<p><img src="http://taojinke.github.io/img/20150703/276e17e.jpg" alt=""></p>
<p>&#xFF08;5&#xFF09;&#x5230;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x6700;&#x5C0F;&#x5316;&#x7684;memcached&#x96C6;&#x7FA4;&#x8BFB;&#x5199;&#x6D4B;&#x8BD5;Demo&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x5728;&#x5B9E;&#x9645;&#x7684;&#x5F00;&#x53D1;&#x573A;&#x666F;&#x4E2D;&#xFF0C;&#x8FDC;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x5B58;&#x50A8;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x662F;&#x5B58;&#x50A8;&#x4E00;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;&#x3002;&#x8FD9;&#x5C31;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5230;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x65B0;&#x52A0;&#x4E00;&#x4E2A;&#x7C7B;MyObject&#xFF0C;&#x8BA9;&#x5176;&#x4F5C;&#x4E3A;&#x53EF;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x6765;&#x5B58;&#x50A8;&#x8FDB;Memcached&#x4E2D;&#x3002;&#x6CE8;&#x610F;&#xFF1A;&#x9700;&#x8981;&#x4E3A;&#x8BE5;&#x7C7B;&#x52A0;&#x4E0A;[Serializable]&#x7684;&#x7279;&#x6027;&#xFF01;</p>
<p> <img src="http://taojinke.github.io/img/20150703/276e17e.gif" alt=""></p>
<pre><code>    [Serializable]
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyObject</span>
{
    <span class="keyword">public</span> <span class="keyword">int</span> ID
    {
        <span class="keyword">get</span>;
        <span class="keyword">set</span>;
    }
    <span class="keyword">public</span> <span class="keyword">string</span> Name
    {
        <span class="keyword">get</span>;
        <span class="keyword">set</span>;
    }
}
</code></pre><p> <img src="http://taojinke.github.io/img/20150703/276e3ef.gif" alt=""></p>
<p>&#x7136;&#x540E;&#xFF0C;&#x5728;&#x4E3B;&#x4EE3;&#x7801;&#x4E2D;&#x6DFB;&#x52A0;&#x4EE5;&#x4E0B;&#x51E0;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x589E;&#x52A0;&#x5BF9;&#x81EA;&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x7684;&#x8BFB;&#x5199;&#x6D4B;&#x8BD5;&#xFF1A;</p>
<p> <img src="http://taojinke.github.io/img/20150703/276e3ef.gif" alt=""></p>
<pre><code>// <span class="number">06.</span>&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x4E49</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;
            <span class="class">MyObject</span> myObj = new <span class="class">MyObject</span>();
            myObj.<span class="class">ID</span> = <span class="number">12138</span>;
            myObj.<span class="class">Name</span> = &amp;quot;&amp;<span class="symbol">#x7231</span>;&amp;<span class="symbol">#x8FEA</span>;&amp;<span class="symbol">#x751F</span>;&amp;<span class="symbol">#x5468</span>;&amp;quot;;
            memClient.<span class="class">Set</span>(&amp;quot;test5&amp;quot;, myObj);
            <span class="class">MyObject</span> newMyObj = memClient.<span class="class">Get</span>(&amp;quot;test5&amp;quot;) as <span class="class">MyObject</span>;
            <span class="class">Console</span>.<span class="class">WriteLine</span>(&amp;quot;<span class="class">Hello</span>,<span class="class">My</span> <span class="class">ID</span> is {<span class="number">0</span>} and <span class="class">Name</span> is {<span class="number">1</span>}&amp;quot;, newMyObj.<span class="class">ID</span>, newMyObj.<span class="class">Name</span>);
</code></pre><p> <img src="http://taojinke.github.io/img/20150703/276e3ef.gif" alt=""></p>
<p>&#x6700;&#x540E;&#xFF0C;&#x8FD0;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x67E5;&#x770B;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/276e660.jpg" alt=""></p>
<p>&#xFF08;6&#xFF09;&#x600E;&#x4E48;&#x6837;&#xFF0C;&#x5706;&#x6EE1;&#x5B8C;&#x6210;&#x5BF9;&#x81EA;&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x7684;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x5427;&#xFF1F;&#x73B0;&#x5728;&#xFF0C;&#x6211;&#x4EEC;&#x518D;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x81EA;&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x662F;&#x5B58;&#x5230;&#x4E86;&#x54EA;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#xFF1A;&#x7ECF;&#x67E5;&#x8BE2;&#xFF0C;test5&#x662F;&#x5B58;&#x50A8;&#x5230;&#x4E86;MemcacheServer2&#xFF08;192.168.80.11&#xFF09;&#x4E0A;&#x3002;</p>
<h2 id="&#x4E09;&#x3001;&#x56DE;&#x5934;&#x518D;&#x770B;Memcached&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x6A21;&#x578B;">&#x4E09;&#x3001;&#x56DE;&#x5934;&#x518D;&#x770B;Memcached&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x6A21;&#x578B;</h2><p>&#x7ECF;&#x8FC7;&#x4E86;&#x521A;&#x521A;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x5B9E;&#x8DF5;&#x64CD;&#x4F5C;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x4E00;&#x4E2A;&#x6700;&#x5C0F;&#x5316;&#x7684;&#x7531;&#x4E24;&#x53F0;Windows Server&#x642D;&#x5EFA;&#x7684;Memcached&#x96C6;&#x7FA4;&#x4E0A;&#x8FDB;&#x884C;&#x4E86;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x6D4B;&#x8BD5;&#x3002;&#x90A3;&#x4E48;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x7531;&#x5F97;&#x60F3;&#x8981;&#x53BB;&#x770B;&#x770B;&#x5230;&#x5E95;Memcached&#x662F;&#x600E;&#x6837;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x7684;&#x5462;&#xFF1F;&#x522B;&#x6025;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x770B;&#x770B;&#xFF0C;&#x7531;&#x5B9E;&#x8DF5;&#x5230;&#x7406;&#x8BBA;&#xFF0C;&#x6DF1;&#x5165;&#x7406;&#x89E3;&#x4E00;&#x4E0B;&#x3002;</p>
<p>&#xFF08;1&#xFF09;&#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x6570;&#x636E;</p>
<p><img src="http://taojinke.github.io/img/20150703/276e8d1.png" alt=""></p>
<p>&#x4ECE;&#x56FE;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;Memcached&#x867D;&#x7136;&#x79F0;&#x4E3A;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4F46;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E76;&#x6CA1;&#x6709;&#x201C;&#x5206;&#x5E03;&#x5F0F;&#x201D;&#x529F;&#x80FD;&#xFF0C;&#x800C;&#x662F;&#x5B8C;&#x5168;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#x5E93;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x670D;&#x52A1;&#x7AEF;&#x4E4B;&#x95F4;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x8054;&#x7CFB;&#xFF0C;&#x6570;&#x636E;&#x5B58;&#x53D6;&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7B97;&#x6CD5;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x5B58;&#x53D6;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x4F1A;&#x901A;&#x8FC7;&#x7B97;&#x6CD5;&#x67E5;&#x627E;&#x81EA;&#x5DF1;&#x7EF4;&#xFFFD;&#xFFFD;&#xFFFD;&#x7684;&#x670D;&#x52A1;&#x5668;&#x54C8;&#x5E0C;&#x5217;&#x8868;&#xFF0C;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x670D;&#x52A1;&#x5668;&#x540E;&#xFF0C;&#x518D;&#x5C06;&#x6570;&#x636E;&#x5B58;&#x5F80;&#x6307;&#x5B9A;&#x670D;&#x52A1;&#x5668;&#x3002;&#x4F8B;&#x5982;&#xFF1A;&#x4E0A;&#x56FE;&#x4E2D;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8981;&#x65B0;&#x589E;&#x4E00;&#x4E2A;&lt;&apos;tokyo&apos;,data&gt;&#x7684;&#x952E;&#x503C;&#x5BF9;&#xFF0C;&#x5B83;&#x540C;&#x8FC7;set&#x64CD;&#x4F5C;&#x63D0;&#x4EA4;&#x7ED9;Memcached&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x8FC7;&#x4E00;&#x5B9A;&#x7684;&#x54C8;&#x5E0C;&#x7B97;&#x6CD5;&#xFF08;&#x6BD4;&#x5982;&#xFF1A;&#x4E00;&#x822C;&#x7684;&#x6C42;&#x4F59;&#x51FD;&#x6570;&#x6216;&#x8005;&#x5F3A;&#x5927;&#x7684;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#xFF09;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x5217;&#x8868;&#x4E2D;&#x8BA1;&#x7B97;&#x51FA;&#x4E00;&#x4E2A;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x670D;&#x52A1;&#x5668;&#x5730;&#x5740;&#xFF0C;&#x6700;&#x540E;&#x5C06;&#x8BE5;&#x952E;&#x503C;&#x5BF9;&#x5B58;&#x50A8;&#x5230;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;&#x670D;&#x52A1;&#x5668;&#x91CC;&#x8FB9;&#x3002;</p>
<p>&#xFF08;2&#xFF09;&#x83B7;&#x53D6;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x6570;&#x636E;</p>
<p><img src="http://taojinke.github.io/img/20150703/276e8d1.png" alt=""></p>
<p>&#x4E0A;&#x56FE;&#x4E2D;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x60F3;&#x8981;&#x83B7;&#x53D6;Key&#x4E3A;&#x2018;tokyo&#x2019;&#xFF08;&#x4E1C;&#x4EAC;&#x8FD9;&#x4E48;&#x70ED;&#xFF0C;&#x8FD8;&#x8981;&#x53D6;&#x5B83;&#x7684;&#x503C;&#x662F;&#x5E72;&#x795E;&#x9A6C;&#x5462;&#xFF1F;&#xFF09;&#x7684;Value&#xFF0C;&#x4E8E;&#x662F;&#x5B83;&#x5411;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x63D0;&#x4EA4;&#x4E86;&#x4E00;&#x4E2A;Get&#x8BF7;&#x6C42;&#xFF0C;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x8FD8;&#x662F;&#x901A;&#x8FC7;&#x7B97;&#x6CD5;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x5217;&#x8868;&#x67E5;&#x8BE2;&#x54EA;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x5B58;&#x6709;Key&#x4E3A;&#x2018;tokyo&#x2019;&#x7684;Value&#xFF08;&#x5373;&#x9009;&#x62E9;&#x521A;&#x521A;Set&#x5230;&#x4E86;&#x54EA;&#x53F0;&#x670D;&#x52A1;&#x5668;&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x67E5;&#x5230;&#xFF0C;&#x5219;&#x5411;&#x67E5;&#x5230;&#x7684;&#x670D;&#x52A1;&#x5668;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;Key&#x4E3A;&#x2018;tokyo&#x2019;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>&#xFF08;3&#xFF09;Memcached&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x6838;&#x5FC3;&#x2014; <strong>&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;</strong></p>
<p>&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x7684;&#x6838;&#x5FC3;&#x7406;&#x8BBA;&#xFF0C;&#x6211;&#x4E5F;&#x5B66;&#x4E60;&#x5F97;&#x4E0D;&#x6DF1;&#x5165;&#xFF0C;&#x4E5F;&#x53EA;&#x662F;&#x521A;&#x521A;&#x4E86;&#x89E3;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x540E;&#x9762;&#x6211;&#x6709;&#x7A7A;&#x6DF1;&#x5165;&#x5B66;&#x4E60;&#x4E00;&#x4E0B;&#xFF0C;&#x518D;&#x5355;&#x72EC;&#x5199;&#x4E00;&#x7BC7;&#x535A;&#x6587;&#x6765;&#x4ECB;&#x7ECD;&#x5B83;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;C#&#x6765;&#x7C97;&#x7565;&#x5730;&#x5B9E;&#x73B0;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x7B97;&#x6CD5;&#x3002;&#x73B0;&#x5728;&#x6211;&#x5C31;&#x7B80;&#x5355;&#x5730;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#xFF0C;&#x5176;&#x5B9E;&#x8FD9;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x6211;&#x4E4B;&#x524D;&#x5199;&#x5165;&#x4E86;&#x6211;&#x7684;&#x53E6;&#x4E00;&#x7BC7;&#x535A;&#x6587;&#x300A; <a href="http://www.cnblogs.com/edisonchou/p/3851333.html" target="_blank" rel="external">&#x5927;&#x578B;&#x7F51;&#x7AD9;&#x6280;&#x672F;&#x67B6;&#x6784;&#x8BFB;&#x4E66;&#x7B14;&#x8BB0;&#x4E4B;&#x7F51;&#x7AD9;&#x7684;&#x53EF;&#x4F38;&#xFFFD;&#xFFFD;&#xFFFD;&#x67B6;&#x6784;</a> &#x300B;&#x4E2D;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x670B;&#x53CB;&#x4E5F;&#x53EF;&#x4EE5;&#x53BB;&#x770B;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002; </p>
<p>&#x9996;&#x5148;&#xFF0C;&#x7B80;&#x5355;&#x7684;&#x8DEF;&#x7531;&#x7B97;&#x6CD5;&#xFF08;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x4F59;&#x6570;Hash&#xFF09;&#x65E0;&#x6CD5;&#x6EE1;&#x8DB3;&#x4E1A;&#x52A1;&#x53D1;&#x5C55;&#x65F6;&#x670D;&#x52A1;&#x5668;&#x6269;&#x5BB9;&#x7684;&#x9700;&#x8981;&#xFF1A; <strong>&#x7F13;&#x5B58;&#x547D;&#x4E2D;&#x7387;&#x4E0B;&#x964D;</strong> &#x3002;&#x4F8B;&#x5982;&#xFF1A;&#x5F53;3&#x53F0;&#x670D;&#x52A1;&#x5668;&#x6269;&#x5BB9;&#x81F3;4&#x53F0;&#x65F6;&#xFF0C;&#x91C7;&#x7528;&#x666E;&#x901A;&#x7684;&#x4F59;&#x6570;Hash&#x7B97;&#x6CD5;&#x4F1A;&#x5BFC;&#x81F4;&#x5927;&#x7EA6;75%&#xFF08;3/4&#xFF09;&#x88AB;&#x7F13;&#x5B58;&#x4E86;&#x7684;&#x6570;&#x636E;&#x65E0;&#x6CD5;&#x6B63;&#x786E;&#x547D;&#x4E2D;&#xFF0C;&#x968F;&#x7740;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x89C4;&#x6A21;&#x7684;&#x589E;&#x5927;&#xFF0C;&#x8FD9;&#x4E2A;&#x6BD4;&#x4F8B;&#x4F1A;&#x7EBF;&#x6027;&#x5730;&#x4E0A;&#x5347;&#x3002;&#x90A3;&#x4E48;&#xFF0C;&#x53EF;&#x4EE5;&#x60F3;&#x8C61;&#xFF0C;&#x5F53;100&#x53F0;&#x670D;&#x52A1;&#x5668;&#x7684;&#x96C6;&#x7FA4;&#x4E2D;&#x52A0;&#x5165;&#x4E00;&#x53F0;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4E0D;&#x80FD;&#x547D;&#x4E2D;&#x7684;&#x6982;&#x7387;&#x5927;&#x6982;&#x662F;99%&#xFF08;N/N+1&#xFF09;&#xFF0C;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x663E;&#x7136;&#x662F;&#x65E0;&#x6CD5;&#x63A5;&#x53D7;&#x7684;&#x3002;&#x90A3;&#x4E48;&#xFF0C;&#x80FD;&#x5426;&#x901A;&#x8FC7;&#x6539;&#x8FDB;&#x8DEF;&#x7531;&#x7B97;&#x6CD5;&#xFF0C;&#x4F7F;&#x5F97;&#x65B0;&#x52A0;&#x5165;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x5F71;&#x54CD;&#x5927;&#x90E8;&#x5206;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x6B63;&#x786E;&#x6027;&#x5462;&#xFF1F;&#x8BF7;&#x770B;&#x4E0B;&#x9762;&#x7684;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x3002; </p>
<p>&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x53EB;&#x505A;&#x4E00;&#x81F4;&#x6027;Hash&#x73AF;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5B9E;&#x73B0;KEY&#x5230;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x7684;Hash&#x6620;&#x5C04;&#xFF0C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/276eb42.png" alt=""></p>
<p>&#x5177;&#x4F53;&#x7B97;&#x6CD5;&#x8FC7;&#x7A0B;&#x662F;&#xFF1A;</p>
<p>&#x2460;&#x5148;&#x6784;&#x9020;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x4E3A;0~2^32&#xFF08;2&#x7684;32&#x6B21;&#x5E42;&#xFF09;&#x4E2A;&#x7684;&#x6574;&#x6570;&#x73AF;&#xFF08;&#x53C8;&#x79F0;&#xFF1A;&#x4E00;&#x81F4;&#x6027;Hash&#x73AF;&#xFF09;&#xFF0C;&#x6839;&#x636E;&#x8282;&#x70B9;&#x540D;&#x79F0;&#x7684;Hash&#x503C;&#x5C06;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x8282;&#x70B9;&#x653E;&#x7F6E;&#x5728;&#x8FD9;&#x4E2A;Hash&#x73AF;&#x4E2D;&#xFF0C;&#x5982;&#x4E0A;&#x56FE;&#x4E2D;&#x7684;node1&#xFF0C;node2&#x7B49;&#xFF1B;</p>
<p>&#x2461;&#x6839;&#x636E;&#x9700;&#x8981;&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;&#x7684;KEY&#x503C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x5176;Hash&#x503C;&#xFF0C;&#x5982;&#x4E0A;&#x56FE;&#x4E2D;&#x53F3;&#x534A;&#x90E8;&#x5206;&#x7684;&#x201C;&#x952E;&#x201D;&#xFF0C;&#x8BA1;&#x7B97;&#x5176;Hash&#x503C;&#x540E;&#x79BB;node2&#x5F88;&#x8FD1;&#xFF1B;</p>
<p>&#x2462;&#x5728;Hash&#x73AF;&#x4E0A;&#x987A;&#x65F6;&#x9488;&#x67E5;&#x627E;&#x8DDD;&#x79BB;&#x8FD9;&#x4E2A;KEY&#x7684;Hash&#x503C;&#x6700;&#x8FD1;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x8282;&#x70B9;&#xFF0C;&#x5B8C;&#x6210;KEY&#x5230;&#x670D;&#x52A1;&#x5668;&#x7684;Hash&#x6620;&#x5C04;&#x67E5;&#x627E;&#xFF0C;&#x5982;&#x4E0A;&#x56FE;&#x4E2D;&#x79BB;&#x53F3;&#x8FB9;&#x8FD9;&#x4E2A;&#x952E;&#x7684;Hash&#x503C;&#x6700;&#x8FD1;&#x7684;&#x987A;&#x65F6;&#x9488;&#x65B9;&#x5411;&#x7684;&#x670D;&#x52A1;&#x5668;&#x8282;&#x70B9;&#x662F;node2&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x4E2A;KEY&#x4F1A;&#x5230;node2&#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#xFF1B;</p>
<p>&#x5F53;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x9700;&#x8981;&#x6269;&#x5BB9;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5C06;&#x65B0;&#x52A0;&#x5165;&#x7684;&#x8282;&#x70B9;&#x540D;&#x79F0;&#xFF08;&#x5982;node5&#xFF09;&#x7684;Hash&#x503C;&#x653E;&#x5165;&#x4E00;&#x81F4;&#x6027;Hash&#x73AF;&#x4E2D;&#xFF0C; &#x7531;&#x4E8E;KEY&#x603B;&#x662F;&#x987A;&#x65F6;&#x9488;&#x67E5;&#x627E;&#x8DDD;&#x79BB;&#x5176;&#x6700;&#x8FD1;&#x7684;&#x8282;&#x70B9;&#xFF0C;&#x56E0;&#x6B64;&#x65B0;&#x52A0;&#x5165;&#x7684;&#x8282;&#x70B9;&#x53EA;&#x5F71;&#x54CD;&#x6574;&#x4E2A;&#x73AF;&#x4E2D;&#x7684;&#x4E00;&#x90E8;&#x5206; &#x3002;&#x5982;&#x4E0B;&#x56FE;&#x4E2D;&#x6240;&#x793A;&#xFF0C;&#x6DFB;&#x52A0;node5&#x540E;&#xFF0C;&#x53EA;&#x5F71;&#x54CD;&#x53F3;&#x8FB9;&#x9006;&#x65F6;&#x9488;&#x65B9;&#x5411;&#x7684;&#x4E09;&#x4E2A;Key/Value&#x5BF9;&#x6570;&#x636E;&#xFF0C;&#x53EA;&#x5360;&#x6574;&#x4E2A;Hash&#x73AF;&#x4E2D;&#x7684;&#x4E00;&#x5C0F;&#x90E8;&#x5206;&#x3002; </p>
<p><img src="http://taojinke.github.io/img/20150703/276eb42.png" alt=""></p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4E0E;&#x4E4B;&#x524D;&#x7684;&#x666E;&#x901A;&#x4F59;&#x6570;Hash&#x4F5C;&#x5BF9;&#x6BD4;&#xFF1A;&#x91C7;&#x7528;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x65F6;&#xFF0C;&#x5F53;3&#x53F0;&#x670D;&#x52A1;&#x5668;&#x6269;&#x5BB9;&#x5230;4&#x53F0;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x547D;&#x4E2D;&#x539F;&#x6709;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x6982;&#x7387;&#x4E3A;75%&#xFF0C;&#x8FDC;&#x9AD8;&#x4E8E;&#x666E;&#x901A;&#x4F59;&#x6570;Hash&#x7684;25%&#xFF0C;&#x800C;&#x4E14;&#x968F;&#x7740;&#x96C6;&#x7FA4;&#x89C4;&#x6A21;&#x8D8A;&#x5927;&#xFF0C;&#x7EE7;&#x7EED;&#x547D;&#x4E2D;&#x539F;&#x6709;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x7684;&#x6982;&#x7387;&#x4E5F;&#x4F1A;&#x968F;&#x4E4B;&#x589E;&#x5927;&#x3002;&#x5F53;100&#x53F0;&#x670D;&#x52A1;&#x5668;&#x589E;&#x52A0;1&#x53F0;&#x65F6;&#xFF0C;&#x7EE7;&#x7EED;&#x547D;&#x4E2D;&#x7684;&#x6982;&#x7387;&#x662F;99%&#x3002; &#x867D;&#x7136;&#xFF0C;&#x4ECD;&#x6709;&#x5C0F;&#x90E8;&#x5206;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x5728;&#x670D;&#x52A1;&#x5668;&#x4E2D;&#x65E0;&#x6CD5;&#x88AB;&#x8BFB;&#x53D6;&#x5230;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x6BD4;&#x4F8B;&#x8DB3;&#x591F;&#x5C0F;&#xFF0C;&#x901A;&#x8FC7;&#x8BBF;&#x95EE;&#x6570;&#x636E;&#x5E93;&#x4E5F;&#x4E0D;&#x4F1A;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x9020;&#x6210;&#x81F4;&#x547D;&#x7684;&#x8D1F;&#x8F7D;&#x538B;&#x529B; &#x3002; </p>
<h2 id="&#x56DB;&#x3001;&#x5B66;&#x4E60;&#x5C0F;&#x7ED3;">&#x56DB;&#x3001;&#x5B66;&#x4E60;&#x5C0F;&#x7ED3;</h2><p>&#x5728;&#x672C;&#x7BC7;&#x6211;&#x9996;&#x5148;&#x82B1;&#x4E86;&#x5927;&#x529B;&#x6C14;&#x6765;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x4F7F;&#x7528;Memcached&#x5BA2;&#x6237;&#x7AEF;&#x5728;.Net&#x4E2D;&#x8FDB;&#x884C;&#x5E38;&#x7528;&#x7684;&#x57FA;&#x7840;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;VMWare Workstation&#x6784;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x7531;&#x4E24;&#x53F0;Windows Server&#x7EC4;&#x6210;&#x7684;&#x6700;&#x5C0F;&#x5316;&#x7684;Memcached&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x3002;&#x5176;&#x6B21;&#xFF0C;&#x6211;&#x901A;&#x8FC7;&#x4F7F;&#x7528;C#&#x8C03;&#x7528;Memcached&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5C06;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x5230;Memcached&#x670D;&#x52A1;&#x5668;&#x96C6;&#x7FA4;&#x4E2D;&#xFF0C;&#x5E76;&#x9A8C;&#x8BC1;&#x4E86;&#x662F;&#x5426;&#x4FDD;&#x5B58;&#x4E8E;&#x96C6;&#x7FA4;&#x4E2D;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x8FD4;&#x56DE;&#x5230;Memcached&#x7684;&#x6570;&#x636E;&#x8BBF;&#x95EE;&#x6A21;&#x578B;&#x4E0A;&#xFF0C;&#x4ECE;&#x7406;&#x8BBA;&#x5230;&#x5B9E;&#x8DF5;&#xFF0C;&#x518D;&#x4ECE;&#x5B9E;&#x8DF5;&#x8FD4;&#x56DE;&#x5230;&#x7406;&#x8BBA;&#xFF0C;&#x7406;&#x89E3;Memcached&#x7684;&#x4E92;&#x4E0D;&#x901A;&#x4FE1;&#x7684;&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#x4E0E;&#x6570;&#x636E;&#x8BFB;&#x5199;&#x6D41;&#x7A0B;&#xFF0C;&#x5E76;&#x7B80;&#x5355;&#x4E86;&#x89E3;&#x4E86;&#x4E00;&#x4E0B;&#x5206;&#x5E03;&#x5F0F;&#x6280;&#x672F;&#x4E2D;&#x6700;&#x6838;&#x5FC3;&#x7684;&#x7B97;&#x6CD5;&#xFF1A;&#x4E00;&#x81F4;&#x6027;Hash&#x7B97;&#x6CD5;&#x3002;</p>
<p>&#x4E0D;&#x77E5;&#x4E0D;&#x89C9;&#x90FD;&#x5FEB;1:20&#x4E86;&#xFF0C;&#x4ECA;&#x5929;&#x5C31;&#x5230;&#x6B64;&#x505C;&#x7B14;&#x5173;&#x673A;&#xFF0C;&#x6D17;&#x6D17;&#x7761;&#x4E86;&#x3002;&#x540E;&#x9762;&#xFF0C;&#x6211;&#x4F1A;&#x4ECB;&#x7ECD;&#x5728;ASP.NET MVC&#x4E2D;&#x5E94;&#x7528;Memcached&#x6765;&#x89E3;&#x51B3;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x7684;&#x6848;&#x4F8B;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;Session&#x4F1A;&#x8BDD;&#x5BF9;&#x8C61;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x5B58;&#x50A8;&#x3002;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x89C9;&#x5F97;&#x6709;&#x7528;&#x6216;&#x8005;&#x6709;&#x5174;&#x8DA3;&#xFF0C;&#x90A3;&#x5C31;&#x656C;&#x8BF7;&#x671F;&#x5F85;&#x4E86;&#xFF0C;&#x4E5F;&#x8BF7;&#x9EBB;&#x70E6;&#x70B9;&#x4E2A;&#x201C;&#x63A8;&#x8350;&#x201D;&#xFF0C;&#x8BA9;&#x6211;&#x66F4;&#x6709;&#x52A8;&#x529B;&#x5199;&#x4E0B;&#x53BB;&#xFF0C;&#x8C22;&#x8C22;&#xFF01;</p>
<h2 id="&#x53C2;&#x8003;&#x6587;&#x732E;">&#x53C2;&#x8003;&#x6587;&#x732E;</h2><p>&#xFF08;1&#xFF09;&#x4F20;&#x667A;&#x64AD;&#x5BA2;&#x9A6C;&#x4F26;&#xFF0C;&#x300A;Memcached&#x516C;&#x5F00;&#x8BFE;&#x300B;&#xFF0C;<a href="http://bbs.itcast.cn/thread-14836-1-1.html" target="_blank" rel="external">http://bbs.itcast.cn/thread-14836-1-1.html</a></p>
<p>&#xFF08;2&#xFF09;charlee&#xFF0C;&#x300A;Memcached&#x5B8C;&#x5168;&#x5256;&#x6790;&#x300B;&#xFF0C;<a href="http://kb.cnblogs.com/page/42731/" target="_blank" rel="external">http://kb.cnblogs.com/page/42731/</a></p>
<p>&#xFF08;3&#xFF09;&#x5C0F;&#x57CE;&#x5C81;&#x6708;&#xFF0C;&#x300A;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;Memcached&#x5165;&#x95E8;&#x300B;&#xFF0C;<a href="http://www.cnblogs.com/mecity/archive/2011/06/13/Memcached.html" target="_blank" rel="external">http://www.cnblogs.com/mecity/archive/2011/06/13/Memcached.html</a></p>
<p>&#xFF08;4&#xFF09;&#x5438;&#x6C34;&#x7684;&#x6280;&#x672F;&#x70B9;&#x70B9;&#xFF0C;&#x300A;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x7CFB;&#x7EDF;Memcached&#x7B80;&#x4ECB;&#x4E0E;&#x5B9E;&#x8DF5;&#x300B;&#xFF0C;<a href="http://www.cnblogs.com/zjneter/archive/2007/07/19/822780.html" target="_blank" rel="external">http://www.cnblogs.com/zjneter/archive/2007/07/19/822780.html</a></p>
<p>&#xFF08;5&#xFF09;&#x6E90;&#x7801;&#x5DE5;&#x4F5C;&#x5BA4;&#xFF0C;&#x300A;&#x63ED;&#x5F00;Socket&#x7F16;&#x7A0B;&#x7684;&#x9762;&#x7EB1;&#x300B;&#xFF0C;<a href="http://goodcandle.cnblogs.com/archive/2005/12/10/294652.aspx" target="_blank" rel="external">http://goodcandle.cnblogs.com/archive/2005/12/10/294652.aspx</a></p>
<h2 id="&#x9644;&#x4EF6;&#x4E0B;&#x8F7D;">&#x9644;&#x4EF6;&#x4E0B;&#x8F7D;</h2><p>&#xFF08;1&#xFF09;Memcached ClientLib&#xFF1A; <a href="http://pan.baidu.com/s/1w9Q8I" target="_blank" rel="external">http://pan.baidu.com/s/1w9Q8I</a></p>
<p>&#xFF08;2&#xFF09;MemcachedClientDemo&#xFF1A; <a href="http://pan.baidu.com/s/1hqrDUss" target="_blank" rel="external">http://pan.baidu.com/s/1hqrDUss</a></p>
<p>&#x8F6C;&#x81EA;&#xFF1A;<a href="http://www.cnblogs.com/edisonchou/p/3855969.html" target="_blank" rel="external">http://www.cnblogs.com/edisonchou/p/3855969.html</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Net/">.Net</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/Nosql/">Nosql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2727e72/" title="zabbix monitor redis memcached with python script -" itemprop="url">zabbix monitor redis memcached with python script -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>zabbix &#x76D1;&#x63A7;memcached&#x548C;redis&#xFF0C;&#x4EE5;&#x524D;&#x90FD;&#x662F;&#x7528;shell&#x5199;&#x811A;&#x672C;&#xFF0C;&#x4ECA;&#x5929;&#x4E0D;&#x662F;&#x592A;&#x5FD9;&#xFF0C;&#x6240;&#x4EE5;&#x7528;python&#x4EE3;&#x66FF;shell,&#x6765;&#x8BA9;zabbix&#x8C03;&#x7528;&#x53D6;&#x6570;&#x636E;</p>
<p>1&#x3001;&#x76D1;&#x63A7;memcached&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p> Python</p>
<pre><code><span class="comment"># cat get_memcached_status.py </span>
<span class="comment">#!/usr/bin/env python</span>
<span class="comment">#coding=utf8</span>
<span class="keyword">import</span> sys
<span class="keyword">import</span> os
<span class="class"><span class="keyword">class</span> <span class="title">GetMemStatus</span><span class="params">()</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>
        self.val = {}
    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span>
        <span class="keyword">try</span>:
            <span class="keyword">import</span> memcache
            self.mc = memcache.Client([&amp;apos;<span class="number">127.0</span>.0.1:<span class="number">11211</span>&amp;apos;], debug=<span class="number">0</span>)
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;Plugin needs the memcache module&amp;apos;
    <span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(self, key)</span>:</span>
        stats = self.mc.get_stats()
        <span class="keyword">try</span>:
            <span class="keyword">if</span> key <span class="keyword">in</span> stats[<span class="number">0</span>][<span class="number">1</span>]:
                self.val[key] = stats[<span class="number">0</span>][<span class="number">1</span>][key]
            <span class="keyword">return</span> self.val[key]
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;ERROR: key <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!&amp;apos;
<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:
        <span class="keyword">print</span> &amp;quot;ERROR! Please enter a key&amp;quot;
    <span class="keyword">elif</span> len(sys.argv) == <span class="number">2</span>:
        key = sys.argv[<span class="number">1</span>]
        a = GetMemStatus()
        a.check()
        <span class="keyword">print</span> a.extract(key)
<span class="keyword">if</span> __name__ == &amp;quot;__main__&amp;quot;:
    main()
</code></pre><p>&#x6267;&#x884C;&#x6D4B;&#x8BD5;&#xFF1A;</p>
<p> Shell</p>
<pre><code>[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py</span>
<span class="keyword">ERROR</span>! Please enter a <span class="keyword">key</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py pointer_size</span>
<span class="number">64</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py get_misses</span>
<span class="number">2</span>
[root@jize_db_master_redis ~]<span class="preprocessor"># ./get_memcached_status.py get_hits</span>
<span class="number">1</span>
<span class="preprocessor"># ./get_memcached_status.py aaa</span>
Traceback (most recent <span class="keyword">call</span> last):
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">36</span>, <span class="keyword">in</span> 


    main()
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">33</span>, <span class="keyword">in</span> main
    print a.extract(<span class="keyword">key</span>)
  File &amp;quot;./get_memcached_status.py&amp;quot;, line <span class="number">24</span>, <span class="keyword">in</span> extract
    raise Exception, &amp;apos;<span class="keyword">ERROR</span>: <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!&amp;apos;
Exception: <span class="keyword">ERROR</span>: <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> stats!!!
</code></pre><p>&#x5F53;&#x811A;&#x672C;&#x540E;&#x9762;&#x4E0D;&#x8DDF;key&#x65F6;&#x63D0;&#x793A;error&#xFF0C;&#x5F53;&#x811A;&#x672C;&#x540E;&#x9762;&#x8DDF;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x7684;key&#x65F6;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;</p>
<p>2&#x3001;redis&#x811A;&#x672C;&#x5982;&#x4E0B;&#xFF1A;</p>
<p> Python</p>
<pre><code><span class="comment"># cat get_redis_status.py </span>
<span class="comment">#!/usr/bin/env python</span>
<span class="comment">#coding=utf8</span>
<span class="keyword">import</span> sys
<span class="keyword">import</span> os
<span class="class"><span class="keyword">class</span> <span class="title">GetRedisStatus</span><span class="params">()</span>:</span>
    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span>
        self.val = {}
    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span>
        <span class="keyword">try</span>:
            <span class="keyword">import</span> redis
            self.redis = redis.Redis(&amp;apos;<span class="number">127.0</span>.0.1&amp;apos;, port=<span class="number">6379</span>, password=<span class="keyword">None</span>)
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;Plugin needs the redis module&amp;apos;
    <span class="function"><span class="keyword">def</span> <span class="title">extract</span><span class="params">(self, key)</span>:</span>
        info = self.redis.info()
        <span class="keyword">try</span>:
            <span class="keyword">if</span> key <span class="keyword">in</span> info:
                self.val[key] = info[key]
            <span class="keyword">return</span> self.val[key]
        <span class="keyword">except</span>:
            <span class="keyword">raise</span> Exception, &amp;apos;ERROR info <span class="keyword">not</span> include this key!&amp;apos;
<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>
    <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:
        <span class="keyword">print</span> &amp;quot;ERROR! Please enter a key&amp;quot;
    <span class="keyword">elif</span> len(sys.argv) == <span class="number">2</span>:
        key = sys.argv[<span class="number">1</span>]
        a = GetRedisStatus()
        a.check()
        <span class="keyword">print</span> a.extract(key)
<span class="keyword">if</span> __name__ == &amp;quot;__main__&amp;quot;:
    main()
</code></pre><p>&#x6267;&#x884C;:</p>
<p> Shell</p>
<pre><code>[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># python get_redis_status.py </span>
ERROR! Please enter a key
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py db11 </span>
Traceback (most recent call last):
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">40</span>, <span class="keyword">in</span> 


    main()
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">37</span>, <span class="keyword">in</span> main
    <span class="built_in">print</span> a.extract(key)
  File &amp;quot;./get_redis_status.py&amp;quot;, line <span class="number">27</span>, <span class="keyword">in</span> extract
    raise Exception, &amp;apos;ERROR info <span class="keyword">not</span> include <span class="keyword">this</span> key!&amp;apos;
<span class="attribute">Exception</span>: ERROR info <span class="keyword">not</span> include <span class="keyword">this</span> key!
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_memory</span>
<span class="number">844384</span>
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_cpu_sys</span>
<span class="number">5422.29</span>
[root<span class="property">@jize_db_master_redis</span> ~]<span class="comment"># ./get_redis_status.py used_memory_human</span>
<span class="number">824.59</span>K
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Python/">Python</a><a href="/tags/zabbix/">zabbix</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/275ba15/" title="Linux c 开发 - Memcached源码分析之基于Libevent的网络模型（1） -" itemprop="url">Linux c 开发 - Memcached源码分析之基于Libevent的网络模型（1） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x5173;&#x4E8E;Memcached&#xFF1A;</p>
<p>memcached&#x662F;&#x4E00;&#x6B3E;&#x975E;&#x5E38;&#x666E;&#x53CA;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7F13;&#x5B58;&#x8F6F;&#x4EF6;&#xFF0C;memcached&#x4E3B;&#x8981;&#x662F;&#x57FA;&#x4E8E;Libevent&#x5E93;&#x8FDB;&#x884C;&#x5F00;&#x53D1;&#x7684;&#x3002;Memcached&#x5206;&#x6790;</p>
<p>1.&#xA0; &#x7F51;&#x7EDC;&#x6A21;&#x578B;&#x6D41;&#x7A0B;&#x5206;&#x6790;</p>
<p>Memcached&#x4E3B;&#x8981;&#x662F;&#x57FA;&#x4E8E;Libevent&#x7684;&#x4E8B;&#x4EF6;&#x5E93;&#x6765;&#x5B9E;&#x73B0;&#x7F51;&#x7EDC;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x5148;&#x9700;&#x8981;&#x4E0B;&#x8F7D;memcached&#x7684;&#x6E90;&#x7801;&#x5305;&#xFF0C;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x7ED9;&#x51FA;&#x4E86;&#x6E90;&#x7801;&#x5305;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#x3002;</p>
<p>Memcached&#x7684;&#x7F51;&#x7EDC;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x4E3B;&#x8981;&#x6D89;&#x53CA;&#x4E24;&#x4E2A;&#x4E3B;&#x8981;&#x6587;&#x4EF6;&#xFF1A;memcached.c &#x548C;thread.c&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x8FD9;&#x8FB9;&#x4E3B;&#x8981;&#x5206;&#x6790;tcp&#x7684;&#x6A21;&#x578B;&#x3002;memcached&#x4E5F;&#x652F;&#x6301;udp&#x3002;</p>
<p>&#x6D41;&#x7A0B; </p>
<ol>
<li><p>memcached&#x9996;&#x5148;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#x4F1A;&#x521B;&#x5EFA;main_base&#xFF0C;memcached&#x7684;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x76D1;&#x542C;&#x548C;&#x63A5;&#x6536;listen&#x548C;accpet&#x65B0;&#x8FDB;&#x5165;&#x7684;&#x8FDE;&#x63A5;&#x3002;</p>
</li>
<li><p>&#x5F53;memcached&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x521D;&#x59CB;&#x5316;N&#x4E2A;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;LIBEVENT_THREAD&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6765;&#x5B58;&#x50A8;&#x7EBF;&#x7A0B;&#x7684;&#x4FE1;&#x606F;&#xFF08;&#x7EBF;&#x7A0B;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3001;&#x7EBF;&#x7A0B;&#x961F;&#x5217;&#x3001;pipe&#x4FE1;&#x606F;&#xFF09;&#x3002;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x548C;main thread&#x4E3B;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x4E3B;&#x8981;&#x901A;&#x8FC7;pipe&#x6765;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x3002;</p>
</li>
<li><p>&#x5F53;&#x7528;&#x6237;&#x6709;&#x8FDE;&#x63A5;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;main thread&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x901A;&#x8FC7;&#x6C42;&#x4F59;&#x7684;&#x65B9;&#x5F0F;&#x9009;&#x62E9;&#x4E00;&#x4E2A;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;</p>
</li>
<li><p>main thread&#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x7528;&#x6237;&#x7684;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x653E;&#x5165;&#x4E00;&#x4E2A;CQ_ITEM&#xFF0C;&#x5E76;&#x4E14;&#x5C06;CQ_ITEM&#x653E;&#x5165;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;conn_queue&#x5904;&#x7406;&#x961F;&#x5217;&#xFF0C;&#x7136;&#x540E;&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x901A;&#x8FC7;&#x5199;&#x5165;pipe&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x901A;&#x77E5;worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;</p>
</li>
<li><p>&#x5F53;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5F97;&#x5230;&#x4E3B;&#x7EBF;&#x7A0B;main thread&#x7684;&#x901A;&#x77E5;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x53BB;&#x81EA;&#x5DF1;&#x7684;conn_queue&#x961F;&#x5217;&#x4E2D;&#x53D6;&#x5F97;&#x4E00;&#x6761;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x521B;&#x5EFA;libevent&#x7684;socket&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#x3002;</p>
</li>
<li><p>&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4F1A;&#x76D1;&#x542C;&#x7528;&#x6237;&#x7684;socket&#xFF0C;&#x5982;&#x679C;&#x7528;&#x6237;&#x6709;&#x6D88;&#x606F;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#xFF0C;&#x5219;&#x4F1A;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x89E3;&#x6790;&#x548C;&#x5904;&#x7406;&#xFF0C;&#x8FD4;&#x56DE;&#x76F8;&#x5E94;&#x7684;&#x7ED3;&#x679C;&#x3002;</p>
</li>
</ol>
<p>&#x6D41;&#x7A0B;&#x56FE;</p>
<p><img src="http://taojinke.github.io/img/20150703/275a1ab.jpg" alt=""></p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;</p>
<ol>
<li>CQ_ITEM&#xFF1A;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x7528;&#x6237;socket&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</li>
</ol>
<p>&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x5C06;&#x7528;&#x6237;&#x7684;socket&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x5C01;&#x88C5;&#x6210;CQ_ITEM&#xFF0C;&#x5E76;&#x653E;&#x5165;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x5904;&#x7406;&#x961F;&#x5217;&#x4E2D;&#x3002;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5F97;&#x5230;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;pipe&#x901A;&#x77E5;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06;&#x961F;&#x5217;&#x4E2D;&#x7684;ITEM&#x53D6;&#x51FA;&#x6765;&#xFF0C;&#x521B;&#x5EFA;libevent&#x7684;socket&#x8BFB;&#x4E8B;&#x4EF6;&#x3002;</p>
<pre><code><span class="xml">/* An item in the connection queue. */  
typedef struct conn_queue_item CQ_ITEM;  
struct conn_queue_item </span><span class="expression">{  
    <span class="variable">int</span>               <span class="variable">sfd</span>;   /<span class="end-block">/socket</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">fd</span>  
    <span class="variable">enum</span> <span class="variable">conn</span>_<span class="variable">states</span>  <span class="variable">init</span>_<span class="variable">state</span>; //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;  
    <span class="variable">int</span>               <span class="variable">event</span>_<span class="variable">flags</span>; /<span class="end-block">/libevent</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">flags</span>  
    <span class="variable">int</span>               <span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>; //&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>7684;<span class="variable">buffer</span>&amp;<span class="begin-block">#x</span>7684;<span class="variable">size</span>  
    <span class="variable">enum</span> <span class="variable">network</span>_<span class="variable">transport</span>     <span class="variable">transport</span>;   
    <span class="variable">CQ</span>_<span class="variable">ITEM</span>          *<span class="variable">next</span>; //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5730;&amp;<span class="begin-block">#x</span>5740;  
}</span><span class="xml">;</span>
</code></pre><ol>
<li><p>CQ&#xFF1A;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x5904;&#x7406;&#x961F;&#x5217;&#x7ED3;&#x6784;&#x3002;</p>
<p> /<em> A connection queue. </em>/<br> typedef struct conn_queue CQ;<br> struct conn_queue {  </p>
<pre><code>CQ_ITEM *head<span class="comment">;  </span>
CQ_ITEM *tail<span class="comment">;  </span>
pthread_mutex_t lock<span class="comment">;  </span>
</code></pre><p> };</p>
</li>
<li><p>LIBEVENT_THREAD&#xFF1A;&#x6BCF;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
</li>
</ol>
<p>&#x6BCF;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x90FD;&#x6709;&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x81EA;&#x5DF1;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x7EBF;&#x7A0B;&#x4FE1;&#x606F;&#x3001;&#x5904;&#x7406;&#x961F;&#x5217;&#x3001;pipe&#x4FE1;&#x606F;&#x7B49;&#x3002;</p>
<pre><code><span class="keyword">typedef</span> <span class="keyword">struct</span> {  
    <span class="keyword">pthread_t</span> thread_id;        <span class="comment">/* unique ID of this thread */</span>  
    <span class="keyword">struct</span> event_base *base;    <span class="comment">/* libevent handle this thread uses */</span>  
    <span class="keyword">struct</span> event notify_event;  <span class="comment">/* listen event for notify pipe */</span>  
    <span class="keyword">int</span> notify_receive_fd;      <span class="comment">/* receiving end of notify pipe */</span>  
    <span class="keyword">int</span> notify_send_fd;         <span class="comment">/* sending end of notify pipe */</span>  
    <span class="keyword">struct</span> thread_stats stats;  <span class="comment">/* Stats generated by this thread */</span>  
    <span class="keyword">struct</span> conn_queue *new_conn_queue; <span class="comment">/* queue of new connections to handle */</span>  
    <span class="keyword">cache_t</span> *suffix_cache;      <span class="comment">/* suffix cache */</span>  
    <span class="keyword">uint8_t</span> <span class="keyword">item_lock_t</span>ype;     <span class="comment">/* use fine-grained or global item lock */</span>  
} LIBEVENT_THREAD;
</code></pre><ol>
<li>main&#x542F;&#x52A8;&#x5165;&#x53E3;</li>
</ol>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x627E;&#x5230;memcached.c&#x4E2D;&#x7684;main()&#x65B9;&#x6CD5;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x53EA;&#x5217;&#x51FA;&#x4E86;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x91CD;&#x8981;&#x90E8;&#x5206;&#x3002;</p>
<pre><code>int main (int argc, char **argv) {  
    //...&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
    /* initialize main thread libevent instance */  
    //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;event_base  
    main_base = event_init();  
    /* initialize other stuff */  
    stats_init();  
    assoc_init(settings.hashpower_init);  
    conn_init();  
    slabs_init(settings.maxbytes, settings.factor, preallocate);  
    /* 
     * ignore <span class="class">SIGPIPE</span> signals; we can use errno == <span class="class">EPIPE</span> if we 
     * need that information 
     */  
    if (sigignore(<span class="class">SIGPIPE</span>) == -<span class="number">1</span>) {  
        perror(&amp;quot;failed to ignore <span class="class">SIGPIPE</span>; sigaction&amp;quot;);  
        exit(<span class="class">EX_OSERR</span>);  
    }  
    /* start up worker threads if <span class="class">MT</span> mode */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    thread_init(settings.num_threads, main_base);  
    if (start_assoc_maintenance_thread() == -<span class="number">1</span>) {  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    if (settings.slab_reassign &amp;amp;&amp;amp;  
        start_slab_maintenance_thread() == -<span class="number">1</span>) {  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    /* <span class="class">Run</span> regardless of initializing it later */  
    init_lru_crawler();  
    /* initialise clock event */  
    clock_handler(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);  
    /* create unix mode sockets after dropping privileges */  
    if (settings.socketpath != <span class="class">NULL</span>) {  
        errno = <span class="number">0</span>;  
        if (server_socket_unix(settings.socketpath,settings.access)) {  
            vperror(&amp;quot;failed to listen on <span class="class">UNIX</span> <span class="method">socket:</span> %s&amp;quot;, settings.socketpath);  
            exit(<span class="class">EX_OSERR</span>);  
        }  
    }  
    /* create the listening socket, bind it, and init */  
    if (settings.socketpath == <span class="class">NULL</span>) {  
        const char *portnumber_filename = getenv(&amp;quot;<span class="class">MEMCACHED_PORT_FILENAME</span>&amp;quot;);  
        char temp_portnumber_filename[<span class="class">PATH_MAX</span>];  
        <span class="class">FILE</span> *portnumber_file = <span class="class">NULL</span>;  
        if (portnumber_filename != <span class="class">NULL</span>) {  
            snprintf(temp_portnumber_filename,  
                     sizeof(temp_portnumber_filename),  
                     &amp;quot;%s.lck&amp;quot;, portnumber_filename);  
            portnumber_file = fopen(temp_portnumber_filename, &amp;quot;a&amp;quot;);  
            if (portnumber_file == <span class="class">NULL</span>) {  
                fprintf(stderr, &amp;quot;<span class="class">Failed</span> to open \&amp;quot;%s\&amp;quot;: %s\n&amp;quot;,  
                        temp_portnumber_filename, strerror(errno));  
            }  
        }  
        errno = <span class="number">0</span>;  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;server_sockets&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;socket&amp;<span class="symbol">#x7684</span>;bind&amp;<span class="symbol">#x3001</span>;listen&amp;<span class="symbol">#x3001</span>;accept&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
        //&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4EA4</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x3002</span>;  
        if (settings.port &amp;amp;&amp;amp; server_sockets(settings.port, tcp_transport,  
                                           portnumber_file)) {  
            vperror(&amp;quot;failed to listen on <span class="class">TCP</span> port %d&amp;quot;, settings.port);  
            exit(<span class="class">EX_OSERR</span>);  
        }  
    }  
    /* enter the event loop */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;  
    if (event_base_loop(main_base, <span class="number">0</span>) != <span class="number">0</span>) {  
        retval = <span class="class">EXIT_FAILURE</span>;  
    }  
 //...&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
}
</code></pre><p>&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;thread_init&#x65B9;&#x6CD5;&#x53BB;&#x521B;&#x5EFA;N&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#xFF1A;</p>
<pre><code>thread_init<span class="list">(<span class="keyword">settings</span>.num_threads, main_base)</span><span class="comment">;</span>
</code></pre><p>&#x901A;&#x8FC7;server_sockets&#x65B9;&#x6CD5;&#x53BB;&#x521B;&#x5EFA;socket server&#xFF1A;</p>
<pre><code>errno = <span class="number">0</span>;  
if (settings.<span class="keyword">port</span> &amp;amp;&amp;amp; server_sockets(settings.<span class="keyword">port</span>, tcp_transport,  
                                   portnumber_file)) {  
    vperror(&amp;quot;failed <span class="keyword">to</span> listen <span class="keyword">on</span> TCP <span class="keyword">port</span> %d&amp;quot;, settings.<span class="keyword">port</span>);  
    exit(EX_OSERR);  
}
</code></pre><ol>
<li>worker thread&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x6E90;&#x7801;&#x5206;&#x6790;</li>
</ol>
<p>&#x6211;&#x4EEC;&#x5728;thread.c&#x6587;&#x4EF6;&#x4E2D;&#x627E;&#x5230;thread_init&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>void thread_init(int nthreads, struct event_base *main_base) {  
    //...&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;nthreads&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    //nthreads&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x7684</span>;  
    for (i = <span class="number">0</span>; i &amp;lt; nthreads; i++) {  
        int fds[<span class="number">2</span>];  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;pipe&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x4FE1</span>;  
        if (pipe(fds)) {  
            perror(&amp;quot;<span class="class">Can</span>&amp;apos;t create notify pipe&amp;quot;);  
            exit(<span class="number">1</span>);  
        }  
        //threads&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="class">LIBEVENT_THREAD</span>  
        //&amp;<span class="symbol">#x5C06</span>;pipe&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x4E2D</span>;  
        threads[i].notify_receive_fd = fds[<span class="number">0</span>]; //&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x7AEF</span>;  
        threads[i].notify_send_fd = fds[<span class="number">1</span>]; //&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x7AEF</span>;  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;&amp;<span class="symbol">#x7684</span>;libevent&amp;<span class="symbol">#x7684</span>;event_base  
        setup_thread(&amp;amp;threads[i]);  
        /* <span class="class">Reserve</span> three fds for the libevent base, and two for the pipe */  
        stats.reserved_fds += <span class="number">5</span>;  
    }  
    /* <span class="class">Create</span> threads after we&amp;apos;ve done all the libevent setup. */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    //&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x662F</span>;worker_libevent  
    for (i = <span class="number">0</span>; i &amp;lt; nthreads; i++) {  
        create_worker(worker_libevent, &amp;amp;threads[i]);  
    }  
    /* <span class="class">Wait</span> for all the threads to set themselves up before returning. */  
    pthread_mutex_lock(&amp;amp;init_lock);  
    wait_for_thread_registration(nthreads);  
    pthread_mutex_unlock(&amp;amp;init_lock);  
}
</code></pre><p>setup_thread&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>/* 
 * <span class="class">Set</span> up a thread&amp;apos;s information. 
 */  
static void setup_thread(<span class="class">LIBEVENT_THREAD</span> *me) {  
    //&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;event_base  
    //&amp;<span class="symbol">#x6839</span>;&amp;<span class="symbol">#x636E</span>;libevent&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x6863</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x822C</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x5DF1</span>;&amp;<span class="symbol">#x72EC</span>;&amp;<span class="symbol">#x7ACB</span>;&amp;<span class="symbol">#x7684</span>;event_base  
    me-&amp;gt;base = event_init();  
    if (! me-&amp;gt;base) {  
        fprintf(stderr, &amp;quot;<span class="class">Can</span>&amp;apos;t allocate event base\n&amp;quot;);  
        exit(<span class="number">1</span>);  
    }  
    /* <span class="class">Listen</span> for notifications from other threads */  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;pipe&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;<span class="class">EV_READ</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;  
    //&amp;<span class="symbol">#x5F53</span>;pipe&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;libevent&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;thread_libevent_process&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    event_set(&amp;amp;me-&amp;gt;notify_event, me-&amp;gt;notify_receive_fd,  
              <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>, thread_libevent_process, me);  
    event_base_set(me-&amp;gt;base, &amp;amp;me-&amp;gt;notify_event);  
    //&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (event_add(&amp;amp;me-&amp;gt;notify_event, <span class="number">0</span>) == -<span class="number">1</span>) {  
        fprintf(stderr, &amp;quot;<span class="class">Can</span>&amp;apos;t monitor libevent notify pipe\n&amp;quot;);  
        exit(<span class="number">1</span>);  
    }  
    //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x961F</span>;&amp;<span class="symbol">#x5217</span>;  
    me-&amp;gt;new_conn_queue = malloc(sizeof(struct conn_queue));  
    if (me-&amp;gt;new_conn_queue == <span class="class">NULL</span>) {  
        perror(&amp;quot;<span class="class">Failed</span> to allocate memory for connection queue&amp;quot;);  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    cq_init(me-&amp;gt;new_conn_queue);  
    //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;  
    if (pthread_mutex_init(&amp;amp;me-&amp;gt;stats.mutex, <span class="class">NULL</span>) != <span class="number">0</span>) {  
        perror(&amp;quot;<span class="class">Failed</span> to initialize mutex&amp;quot;);  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
    me-&amp;gt;suffix_cache = cache_create(&amp;quot;suffix&amp;quot;, <span class="class">SUFFIX_SIZE</span>, sizeof(char*),  
                                    <span class="class">NULL</span>, <span class="class">NULL</span>);  
    if (me-&amp;gt;suffix_cache == <span class="class">NULL</span>) {  
        fprintf(stderr, &amp;quot;<span class="class">Failed</span> to create suffix cache\n&amp;quot;);  
        exit(<span class="class">EXIT_FAILURE</span>);  
    }  
}
</code></pre><p>create_worker&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>/* 
 * <span class="class">Creates</span> a worker thread. 
 */  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
static void create_worker(void *(*func)(void *), void *arg) {  
    pthread_t       thread;  
    pthread_attr_t  attr;  
    int             ret;  
    pthread_attr_init(&amp;amp;attr);  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x771F</span>;&amp;<span class="symbol">#x6B63</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;  
    if ((ret = pthread_create(&amp;amp;thread, &amp;amp;attr, func, arg)) != <span class="number">0</span>) {  
        fprintf(stderr, &amp;quot;<span class="class">Can</span>&amp;apos;t create <span class="method">thread:</span> %s\n&amp;quot;,  
                strerror(ret));  
        exit(<span class="number">1</span>);  
    }  
}
</code></pre><p>worker_libevent&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code><span class="xml">/* 
 * Worker thread: main event loop 
 */  
static void *worker_libevent(void *arg) </span><span class="expression">{  
    <span class="variable">LIBEVENT</span>_<span class="variable">THREAD</span> *<span class="variable">me</span> = <span class="variable">arg</span>;  

    /* <span class="variable">Any</span> <span class="variable">per-thread</span> <span class="variable">setup</span> <span class="variable">can</span> <span class="variable">happen</span> <span class="variable">here</span>; <span class="variable">thread</span>_<span class="variable">init</span>() <span class="variable">will</span> <span class="variable">block</span> <span class="variable">until</span> 
     * <span class="variable">all</span> <span class="variable">threads</span> <span class="variable">have</span> <span class="variable">finished</span> <span class="variable">initializing.</span> 
     *<span class="end-block">/  </span>

    /* <span class="variable">set</span> <span class="variable">an</span> <span class="variable">indexable</span> <span class="variable">thread-specific</span> <span class="variable">memory</span> <span class="variable">item</span> <span class="variable">for</span> <span class="variable">the</span> <span class="variable">lock</span> <span class="variable">type.</span> 
     * <span class="variable">this</span> <span class="variable">could</span> <span class="variable">be</span> <span class="variable">unnecessary</span> <span class="variable"><span class="keyword">if</span></span> <span class="variable">we</span> <span class="variable">pass</span> <span class="variable">the</span> <span class="variable">conn</span> *<span class="variable">c</span> <span class="variable">struct</span> <span class="variable">through</span> 
     * <span class="variable">all</span> <span class="variable">item</span>_<span class="variable">lock</span> <span class="variable">calls...</span> 
     *<span class="end-block">/  </span>
    <span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">item</span>_<span class="variable">lock</span>_<span class="variable">type</span> = <span class="variable">ITEM</span>_<span class="variable">LOCK</span>_<span class="variable">GRANULAR</span>;  
    <span class="variable">pthread</span>_<span class="variable">setspecific</span>(<span class="variable">item</span>_<span class="variable">lock</span>_<span class="variable">type</span>_<span class="variable">key</span>, &amp;<span class="variable">amp</span>;<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">item</span>_<span class="variable">lock</span>_<span class="variable">type</span>);  

    <span class="variable">register</span>_<span class="variable">thread</span>_<span class="variable">initialized</span>();  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>00;&amp;<span class="begin-block">#x</span>542<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;  
    //&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>81<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>1;&amp;<span class="begin-block">#x</span>72<span class="variable">EC</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ACB</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">event</span>_<span class="variable">base</span>&amp;<span class="begin-block">#x</span>548<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5<span class="variable">FAA</span>;&amp;<span class="begin-block">#x</span>73<span class="variable">AF</span>;&amp;<span class="begin-block">#x</span>673<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5236;  
    /<span class="end-block">/memcache</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>72<span class="variable">EC</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ACB</span>;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;&amp;<span class="begin-block">#x</span>81<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>1;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>7<span class="variable">BA</span>1;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;  
    <span class="variable">event</span>_<span class="variable">base</span>_<span class="variable">loop</span>(<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">base</span>, 0);  
    <span class="variable">return</span> <span class="variable">NULL</span>;  
}</span><span class="xml"></span>
</code></pre><p>thread_libevent_process&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code><span class="xml">static void thread_libevent_process(int fd, short which, void *arg) </span><span class="expression">{  
    <span class="variable">LIBEVENT</span>_<span class="variable">THREAD</span> *<span class="variable">me</span> = <span class="variable">arg</span>;  
    <span class="variable">CQ</span>_<span class="variable">ITEM</span> *<span class="variable">item</span>;  
    <span class="variable">char</span> <span class="variable">buf</span>[1];  
    //&amp;<span class="begin-block">#x</span>56<span class="variable">DE</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">C</span>03;&amp;<span class="begin-block">#x</span>51<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>56<span class="variable">DE</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">BB</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">FE</span>1;&amp;<span class="begin-block">#x</span>606<span class="variable">F</span>;  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5411;&amp;<span class="begin-block">#x</span>5176;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5199;&amp;<span class="begin-block">#x</span>5165;1  
    //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;1&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>8<span class="variable">BF</span>4;&amp;<span class="begin-block">#x</span>660<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;<span class="variable">pipe</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>63;&amp;<span class="begin-block">#x</span>786<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7684;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">read</span>(<span class="variable">fd</span>, <span class="variable">buf</span>, 1) != 1)  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.verbose</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0)  
            <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Can</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">read</span> <span class="variable">from</span> <span class="variable">libevent</span> <span class="variable">pipe</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
    <span class="variable">switch</span> (<span class="variable">buf</span>[0]) {  
    <span class="variable">case</span> &amp;<span class="variable">apos</span>;<span class="variable">c</span>&amp;<span class="variable">apos</span>;:  
    //&amp;<span class="begin-block">#x</span>4<span class="variable">ECE</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>961<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>83<span class="variable">B</span>7;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>6;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">CQ</span>_<span class="variable">ITEM</span>&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">FE</span>1;&amp;<span class="begin-block">#x</span>606<span class="variable">F</span>;  
    <span class="variable">item</span> = <span class="variable">cq</span>_<span class="variable">pop</span>(<span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">new</span>_<span class="variable">conn</span>_<span class="variable">queue</span>);  
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">item</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>7<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>5219;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>8<span class="variable">FDB</span>;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDE</span>;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>63<span class="variable">A</span>5;&amp;<span class="begin-block">#x</span>7<span class="variable">BA</span>1;  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">NULL</span> != <span class="variable">item</span>) {  
        /<span class="end-block">/conn</span>_<span class="variable">new</span>&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>975<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>38;&amp;<span class="begin-block">#x</span>91<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EFA</span>;<span class="variable">socket</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>8<span class="variable">BFB</span>;&amp;<span class="begin-block">#x</span>5199;&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>76<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>542<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;&amp;<span class="begin-block">#x</span>3002;  
        /<span class="end-block">/init</span>_<span class="variable">state</span> &amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5728;<span class="variable">drive</span>_<span class="variable">machine</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>901<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>72<span class="variable">B</span>6;&amp;<span class="begin-block">#x</span>6001;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5224;&amp;<span class="begin-block">#x</span>65<span class="variable">AD</span>;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;  
        <span class="variable">conn</span> *<span class="variable">c</span> = <span class="variable">conn</span>_<span class="variable">new</span>(<span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">init</span>_<span class="variable">state</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">event</span>_<span class="variable">flags</span>,  
                           <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>, <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>, <span class="variable">me-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">base</span>);  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">c</span> == <span class="variable">NULL</span>) {  
            <span class="variable"><span class="keyword">if</span></span> (<span class="variable">IS</span>_<span class="variable">UDP</span>(<span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>)) {  
                <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Can</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">listen</span> <span class="variable">for</span> <span class="variable">events</span> <span class="variable">on</span> <span class="variable">UDP</span> <span class="variable">socket</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
                <span class="variable">exit</span>(1);  
            }</span><span class="xml"> else </span><span class="expression">{  
                <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.verbose</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0) {  
                    <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Can</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">listen</span> <span class="variable">for</span> <span class="variable">events</span> <span class="variable">on</span> <span class="variable">fd</span> %<span class="variable">d</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;,  
                        <span class="variable">item-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>);  
                }</span><span class="xml">  
                close(item-&amp;gt;sfd);  
            }  
        } else </span><span class="expression">{  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">thread</span> = <span class="variable">me</span>;  
        }</span><span class="xml">  
        cqi_free(item);  
    }  
        break;  
    /* we were told to flip the lock type and report in */  
    case &amp;apos;l&amp;apos;:  
    me-&amp;gt;item_lock_type = ITEM_LOCK_GRANULAR;  
    register_thread_initialized();  
        break;  
    case &amp;apos;g&amp;apos;:  
    me-&amp;gt;item_lock_type = ITEM_LOCK_GLOBAL;  
    register_thread_initialized();  
        break;  
    }  
}</span>
</code></pre><p>conn_new&#x65B9;&#x6CD5;&#xFF08;&#x4E3B;&#x8981;&#x770B;&#x4E24;&#x884C;&#xFF09;&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;event&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x9645</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#xFF1B</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;event_handler&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
event_set(&amp;amp;c-&amp;gt;event, sfd, event_flags, event_handler, (void *)c);  
event_base_set(base, &amp;amp;c-&amp;gt;event);   
c-&amp;gt;ev_flags = event_flags;  
//&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;libevent&amp;<span class="symbol">#x7684</span>;loop&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (event_add(&amp;amp;c-&amp;gt;event, <span class="number">0</span>) == -<span class="number">1</span>) {  
    perror(&amp;quot;event_add&amp;quot;);  
    return <span class="class">NULL</span>;  
}
</code></pre><p>event_handler&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>void event_handler(const int fd, const short which, void *arg) {  
    conn *c;  
    //&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x88C5</span>;conn&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    c = (conn *)arg;  
    assert(c != <span class="class">NULL</span>);  
    c-&amp;gt;which = which;  
    /* sanity */  
    if (fd != c-&amp;gt;sfd) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Catastrophic</span>: event fd doesn&amp;apos;t match conn fd!\n&amp;quot;);  
        conn_close(c);  
        return;  
    }  
    //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x7EC8</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x4EA4</span>;&amp;<span class="symbol">#x7ED9</span>;&amp;<span class="symbol">#x4E86</span>;drive_machine&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    //memcache&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F51</span>;&amp;<span class="symbol">#x7EDC</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7531</span>;drive_machine&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;  
    //drive_machine&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;c-&amp;gt;state&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x540C</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;     
    drive_machine(c);  
    /* wait for next event */  
    return;  
}
</code></pre><p>&#x7136;&#x540E;&#x7EE7;&#x7EED;&#x770B;&#x6700;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x4E5F;&#x662F;&#x6838;&#x5FC3;&#x7684;&#x5904;&#x7406;&#x4E8B;&#x4EF6;&#x7684;&#x65B9;&#x6CD5;drive_machine&#xFF08;&#x72B6;&#x6001;&#x673A;&#xFF09;&#xFF0C;&#x76D1;&#x542C;socket&#x8FDE;&#x63A5;&#x3001;&#x76D1;&#x542C;socket&#x7684;&#x8BFB;&#x5199;&#x3001;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x7B49;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x5728;drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x800C;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x901A;&#x8FC7;c-&gt;state&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x6765;&#x5224;&#x65AD;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#x3002;</p>
<pre><code><span class="keyword">static</span> void drive_machine(conn *<span class="built_in">c</span>) {  
     <span class="comment">//....................  </span>
    <span class="built_in">assert</span>(<span class="built_in">c</span> != <span class="type">NULL</span>);  
    <span class="keyword">while</span> (!stop) {  
        <span class="comment">//&amp;#x8FD9;&amp;#x8FB9;&amp;#x901A;&amp;#x8FC7;state&amp;#x6765;&amp;#x5904;&amp;#x7406;&amp;#x4E0D;&amp;#x540C;&amp;#x7C7B;&amp;#x578B;&amp;#x7684;&amp;#x4E8B;&amp;#x4EF6;  </span>
        <span class="keyword">switch</span>(<span class="built_in">c</span>-&amp;gt;state) {  
        <span class="comment">//&amp;#x8FD9;&amp;#x8FB9;&amp;#x4E3B;&amp;#x8981;&amp;#x5904;&amp;#x7406;tcp&amp;#x8FDE;&amp;#x63A5;,&amp;#x53EA;&amp;#x6709;&amp;#x5728;&amp;#x4E3B;&amp;#x7EBF;&amp;#x7A0B;&amp;#x7684;&amp;#x4E0B;&amp;#xFF0C;&amp;#x624D;&amp;#x4F1A;&amp;#x6267;&amp;#x884C;listening&amp;#x76D1;&amp;#x542C;&amp;#x64CD;&amp;#x4F5C;&amp;#x3002;  </span>
        <span class="keyword">case</span> conn_listening:  
            addrlen = <span class="built_in">sizeof</span>(addr);  
#ifdef <span class="type">HAVE_ACCEPT4</span>  
            <span class="keyword">if</span> (use_accept4) {  
                sfd = accept4(<span class="built_in">c</span>-&amp;gt;sfd, (<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">amp</span>;<span class="title">addr</span>, &amp;<span class="title">amp</span>;<span class="title">addrlen</span>, <span class="title">SOCK_NONBLOCK</span>);  
            } <span class="title">else</span> </span>{  
                sfd = accept(<span class="built_in">c</span>-&amp;gt;sfd, (<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">amp</span>;<span class="title">addr</span>, &amp;<span class="title">amp</span>;<span class="title">addrlen</span>);  
            }  
#<span class="title">else</span>  
            <span class="title">sfd</span> = <span class="title">accept</span>(<span class="title">c</span>-&amp;<span class="title">gt</span>;<span class="title">sfd</span>, (<span class="title">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">amp</span>;<span class="title">addr</span>, &amp;<span class="title">amp</span>;<span class="title">addrlen</span>);  
#<span class="title">endif</span>  
            //......................  
            <span class="title">if</span> (<span class="title">settings</span>.<span class="title">maxconns_fast</span> &amp;<span class="title">amp</span>;&amp;<span class="title">amp</span>;  
                <span class="title">stats</span>.<span class="title">curr_conns</span> + <span class="title">stats</span>.<span class="title">reserved_fds</span> &amp;<span class="title">gt</span>;= <span class="title">settings</span>.<span class="title">maxconns</span> - 1) </span>{  
                str = &amp;quot;<span class="type">ERROR</span> <span class="type">Too</span> many open connections\r\n&amp;quot;;  
                res = write(sfd, str, strlen(str));  
                close(sfd);  
                <span class="type">STATS_LOCK</span>();  
                stats.rejected_conns++;  
                <span class="type">STATS_UNLOCK</span>();  
            } <span class="keyword">else</span> {  
                dispatch_conn_new(sfd, conn_new_cmd, <span class="type">EV_READ</span> | <span class="type">EV_PERSIST</span>,  
                                     <span class="type">DATA_BUFFER_SIZE</span>, tcp_transport);  
            }  
            stop = <span class="literal">true</span>;  
            <span class="keyword">break</span>;  
        <span class="comment">//&amp;#x8FDE;&amp;#x63A5;&amp;#x7B49;&amp;#x5F85;  </span>
        <span class="keyword">case</span> conn_waiting:  
            <span class="comment">//.........  </span>
            <span class="keyword">break</span>;  
        <span class="comment">//&amp;#x8BFB;&amp;#x53D6;&amp;#x4E8B;&amp;#x4EF6;  </span>
        <span class="comment">//&amp;#x4F8B;&amp;#x5982;&amp;#x6709;&amp;#x7528;&amp;#x6237;&amp;#x63D0;&amp;#x4EA4;&amp;#x6570;&amp;#x636E;&amp;#x8FC7;&amp;#x6765;&amp;#x7684;&amp;#x65F6;&amp;#x5019;&amp;#xFF0C;&amp;#x5DE5;&amp;#x4F5C;&amp;#x7EBF;&amp;#x7A0B;&amp;#x76D1;&amp;#x542C;&amp;#x5230;&amp;#x4E8B;&amp;#x4EF6;&amp;#x540E;&amp;#xFF0C;&amp;#x6700;&amp;#x7EC8;&amp;#x4F1A;&amp;#x8C03;&amp;#x7528;&amp;#x8FD9;&amp;#x5757;&amp;#x4EE3;&amp;#x7801;  </span>
        <span class="keyword">case</span> conn_read:  
            res = <span class="type">IS_UDP</span>(<span class="built_in">c</span>-&amp;gt;transport) ? try_read_udp(<span class="built_in">c</span>) : try_read_network(<span class="built_in">c</span>);  
            <span class="keyword">switch</span> (res) {  
            <span class="keyword">case</span> <span class="type">READ_NO_DATA_RECEIVED</span>:  
                conn_set_state(<span class="built_in">c</span>, conn_waiting);  
                <span class="keyword">break</span>;  
            <span class="keyword">case</span> <span class="type">READ_DATA_RECEIVED</span>:  
                conn_set_state(<span class="built_in">c</span>, conn_parse_cmd);  
                <span class="keyword">break</span>;  
            <span class="keyword">case</span> <span class="type">READ_ERROR</span>:  
                conn_set_state(<span class="built_in">c</span>, conn_closing);  
                <span class="keyword">break</span>;  
            <span class="keyword">case</span> <span class="type">READ_MEMORY_ERROR</span>: <span class="comment">/* Failed to allocate more memory */</span>  
                <span class="comment">/* State already set by try_read_network */</span>  
                <span class="keyword">break</span>;  
            }  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_parse_cmd :  
            <span class="keyword">if</span> (try_read_command(<span class="built_in">c</span>) == <span class="number">0</span>) {  
                <span class="comment">/* wee need more data! */</span>  
                conn_set_state(<span class="built_in">c</span>, conn_waiting);  
            }  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_new_cmd:  
            <span class="comment">/* Only process nreqs at a time to avoid starving other 
               connections */</span>  
            --nreqs;  
            <span class="keyword">if</span> (nreqs &amp;gt;= <span class="number">0</span>) {  
                reset_cmd_handler(<span class="built_in">c</span>);  
            } <span class="keyword">else</span> {  
                pthread_mutex_lock(&amp;amp;<span class="built_in">c</span>-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="built_in">c</span>-&amp;gt;thread-&amp;gt;stats.conn_yields++;  
                pthread_mutex_unlock(&amp;amp;<span class="built_in">c</span>-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="keyword">if</span> (<span class="built_in">c</span>-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
                    <span class="comment">/* We have already read in data into the input buffer, 
                       so libevent will most likely not signal read events 
                       on the socket (unless more data is available. As a 
                       hack we should just put in a request to write data, 
                       because that should be possible ;-) 
                    */</span>  
                    <span class="keyword">if</span> (!update_event(<span class="built_in">c</span>, <span class="type">EV_WRITE</span> | <span class="type">EV_PERSIST</span>)) {  
                        <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">0</span>)  
                            fprintf(stderr, &amp;quot;<span class="type">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
                        conn_set_state(<span class="built_in">c</span>, conn_closing);  
                        <span class="keyword">break</span>;  
                    }  
                }  
                stop = <span class="literal">true</span>;  
            }  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_nread:  
           <span class="comment">//....................  </span>
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_swallow:  
          <span class="comment">//....................  </span>
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_write:  
           <span class="comment">//.................  </span>
            <span class="keyword">break</span>;  
        <span class="comment">//&amp;#x8FDE;&amp;#x63A5;&amp;#x5173;&amp;#x95ED;  </span>
        <span class="keyword">case</span> conn_closing:  
            <span class="keyword">if</span> (<span class="type">IS_UDP</span>(<span class="built_in">c</span>-&amp;gt;transport))  
                conn_cleanup(<span class="built_in">c</span>);  
            <span class="keyword">else</span>  
                conn_close(<span class="built_in">c</span>);  
            stop = <span class="literal">true</span>;  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_closed:  
            <span class="comment">/* This only happens if dormando is an idiot. */</span>  
            abort();  
            <span class="keyword">break</span>;  
        <span class="keyword">case</span> conn_max_state:  
            <span class="built_in">assert</span>(<span class="literal">false</span>);  
            <span class="keyword">break</span>;  
        }  
    }  
    <span class="keyword">return</span>;  
}
</code></pre><ol>
<li>main thread&#x4E3B;&#x7EBF;&#x7A0B;&#x6E90;&#x7801;&#x5206;&#x6790;</li>
</ol>
<p>&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;socket server&#x4E3B;&#x8981;&#x901A;&#x8FC7;server_sockets&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x3002;&#x800C;server_sockets&#x4E2D;&#x4E3B;&#x8981;&#x8C03;&#x7528;&#x4E86;server_socket&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;server_socket&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code><span class="xml">/** 
 * Create a socket and bind it to a specific port number 
 * @param interface the interface to bind to 
 * @param port the port number to bind to 
 * @param transport the transport protocol (TCP / UDP) 
 * @param portnumber_file A filepointer to write the port numbers to 
 *        when they are successfully added to the list of ports we 
 *        listen on. 
 */  
static int server_socket(const char *interface,  
                         int port,  
                         enum network_transport transport,  
                         FILE *portnumber_file) </span><span class="expression">{  
            //&amp;<span class="begin-block">#x</span>521<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EFA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EF</span>6;  
            //&amp;<span class="begin-block">#x</span>6211;&amp;<span class="begin-block">#x</span>4<span class="variable">EEC</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>73<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>9762;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5<span class="variable">DE</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>5<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EBF</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">A</span>0<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>5<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">C</span>03;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>46;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>533<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>522<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>9<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;<span class="variable">state</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">C</span>7<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>578<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>1<span class="variable">A</span>;<span class="variable">conn</span>_<span class="variable">listening</span>  
            //&amp;<span class="begin-block">#x</span>6<span class="variable">CE</span>8;&amp;<span class="begin-block">#x</span>610<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">FB</span>9;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">conn</span>_<span class="variable">listening</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>662<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>6307;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>9<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">C</span>03;&amp;<span class="begin-block">#x</span>7528;<span class="variable">drive</span>_<span class="variable">machine</span>&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;<span class="variable">conn</span>_<span class="variable">listen</span>&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>3;&amp;<span class="begin-block">#x</span>7801;&amp;<span class="begin-block">#x</span>5757;&amp;<span class="begin-block">#x</span>3002;  
            <span class="variable"><span class="keyword">if</span></span> (!(<span class="variable">listen</span>_<span class="variable">conn</span>_<span class="variable">add</span> = <span class="variable">conn</span>_<span class="variable">new</span>(<span class="variable">sfd</span>, <span class="variable">conn</span>_<span class="variable">listening</span>,  
                                             <span class="variable">EV</span>_<span class="variable">READ</span> | <span class="variable">EV</span>_<span class="variable">PERSIST</span>, 1,  
                                             <span class="variable">transport</span>, <span class="variable">main</span>_<span class="variable">base</span>))) {  
                <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">failed</span> <span class="variable">to</span> <span class="variable">create</span> <span class="variable">listening</span> <span class="variable">connection</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
                <span class="variable">exit</span>(<span class="variable">EXIT</span>_<span class="variable">FAILURE</span>);  
            }</span><span class="xml">  
            listen_conn_add-&amp;gt;next = listen_conn;  
            listen_conn = listen_conn_add;  
}</span>
</code></pre><p>conn_new&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>//&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x73B0</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;event&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x9645</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#xFF1B</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
//&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6237</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;event_handler&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
event_set(&amp;amp;c-&amp;gt;event, sfd, event_flags, event_handler, (void *)c);  
event_base_set(base, &amp;amp;c-&amp;gt;event);   
c-&amp;gt;ev_flags = event_flags;  
//&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5230</span>;libevent&amp;<span class="symbol">#x7684</span>;loop&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x4E2D</span>;  
if (event_add(&amp;amp;c-&amp;gt;event, <span class="number">0</span>) == -<span class="number">1</span>) {  
    perror(&amp;quot;event_add&amp;quot;);  
    return <span class="class">NULL</span>;  
}
</code></pre><p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x8DDF;&#x8E2A;&#x8FDB;&#x5165;event_handler&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x8FDB;&#x5165;drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x8BF4;&#x8FC7;server_socket&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x4F20;&#x9012;&#x7684;state&#x53C2;&#x6570;&#x4E3A;&#x9ED8;&#x8BA4;&#x5199;&#x6B7B;&#x7684;conn_listening&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8BE6;&#x7EC6;&#x770B;drive_machine&#x4E2D;&#x5173;&#x4E8E;conn_listening&#x8FD9;&#x5757;&#x903B;&#x8F91;&#x7684;&#x4EE3;&#x7801;&#x3002;&#xA0;</p>
<pre><code>case <span class="method">conn_listening:</span>  
            addrlen = sizeof(addr);  
<span class="symbol">#ifdef</span> <span class="class">HAVE_ACCEPT4</span>  
            //&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x9762</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x662F</span>;accept&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53D7</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
            if (use_accept4) {  
                sfd = accept4(c-&amp;gt;sfd, (struct sockaddr *)&amp;amp;addr, &amp;amp;addrlen, <span class="class">SOCK_NONBLOCK</span>);  
            } else {  
                sfd = accept(c-&amp;gt;sfd, (struct sockaddr *)&amp;amp;addr, &amp;amp;addrlen);  
            }  
<span class="symbol">#else</span>  
            sfd = accept(c-&amp;gt;sfd, (struct sockaddr *)&amp;amp;addr, &amp;amp;addrlen);  
<span class="symbol">#endif</span>  
            if (sfd == -<span class="number">1</span>) {  
                if (use_accept4 &amp;amp;&amp;amp; errno == <span class="class">ENOSYS</span>) {  
                    use_accept4 = <span class="number">0</span>;  
                    continue;  
                }  
                perror(use_accept4 ? &amp;quot;accept4()&amp;quot; : &amp;quot;accept()&amp;quot;);  
                if (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>) {  
                    /* these are transient, so don&amp;apos;t log anything */  
                    stop = <span class="keyword">true</span>;  
                } else if (errno == <span class="class">EMFILE</span>) {  
                    if (settings.verbose &amp;gt; <span class="number">0</span>)  
                        fprintf(stderr, &amp;quot;<span class="class">Too</span> many open connections\n&amp;quot;);  
                    accept_new_conns(<span class="keyword">false</span>);  
                    stop = <span class="keyword">true</span>;  
                } else {  
                    perror(&amp;quot;accept()&amp;quot;);  
                    stop = <span class="keyword">true</span>;  
                }  
                break;  
            }  
            if (!use_accept4) {  
                if (fcntl(sfd, <span class="class">F_SETFL</span>, fcntl(sfd, <span class="class">F_GETFL</span>) | <span class="class">O_NONBLOCK</span>) &amp;lt; <span class="number">0</span>) {  
                    perror(&amp;quot;setting <span class="class">O_NONBLOCK</span>&amp;quot;);  
                    close(sfd);  
                    break;  
                }  
            }  
            if (settings.maxconns_fast &amp;amp;&amp;amp;  
                stats.curr_conns + stats.reserved_fds &amp;gt;= settings.maxconns - <span class="number">1</span>) {  
                str = &amp;quot;<span class="class">ERROR</span> <span class="class">Too</span> many open connections\r\n&amp;quot;;  
                res = write(sfd, str, strlen(str));  
                close(sfd);  
                <span class="class">STATS_LOCK</span>();  
                stats.rejected_conns++;  
                <span class="class">STATS_UNLOCK</span>();  
            } else {  
                //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7528</span>;socket&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x903B</span>;&amp;<span class="symbol">#x8F91</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
                //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x67D0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
                dispatch_conn_new(sfd, conn_new_cmd, <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>,  
                                     <span class="class">DATA_BUFFER_SIZE</span>, tcp_transport);  
            }  
            stop = <span class="keyword">true</span>;  
            break;
</code></pre><p>dispatch_conn_new&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code>/* 
 * <span class="class">Dispatches</span> a new connection to another thread. <span class="class">This</span> is only ever called 
 * from the main thread, either during initialization (for <span class="class">UDP</span>) or because 
 * of an incoming connection. 
 */  
void dispatch_conn_new(int sfd, enum conn_states init_state, int event_flags,  
                       int read_buffer_size, enum network_transport transport) {  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x7533</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;<span class="class">CQ_ITEM</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x606F</span>;  
    <span class="class">CQ_ITEM</span> *item = cqi_new();  
    char buf[<span class="number">1</span>];  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;item&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
    if (item == <span class="class">NULL</span>) {  
        close(sfd);  
        /* given that malloc failed this may also fail, but let&amp;apos;s try */  
        fprintf(stderr, &amp;quot;<span class="class">Failed</span> to allocate memory for connection object\n&amp;quot;);  
        return ;  
    }  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x54EA</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;  
    //&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;last_thread&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x8BA9</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x8F6E</span>;&amp;<span class="symbol">#x8BE2</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x8BC1</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x8861</span>;  
    int tid = (last_thread + <span class="number">1</span>) % settings.num_threads;  

    //&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x57FA</span>;&amp;<span class="symbol">#x672C</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    <span class="class">LIBEVENT_THREAD</span> *thread = threads + tid;  

    last_thread = tid;  

    item-&amp;gt;sfd = sfd;  
    item-&amp;gt;init_state = init_state;  
    item-&amp;gt;event_flags = event_flags;  
    item-&amp;gt;read_buffer_size = read_buffer_size;  
    item-&amp;gt;transport = transport;  
    //&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x961F</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x5165</span>;<span class="class">CQ_ITEM</span>  
    cq_push(thread-&amp;gt;new_conn_queue, item);  

    <span class="class">MEMCACHED_CONN_DISPATCH</span>(sfd, thread-&amp;gt;thread_id);  
    buf[<span class="number">0</span>] = &amp;apos;c&amp;apos;;  
    //&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;pipe&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;<span class="number">1</span>  
    //&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x542C</span>;&amp;<span class="symbol">#x5230</span>;pipe&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x5165</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5411</span>;thread-&amp;gt;new_conn_queue&amp;<span class="symbol">#x961F</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x4E2D</span>;pop&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;item&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;  
    if (write(thread-&amp;gt;notify_send_fd, buf, <span class="number">1</span>) != <span class="number">1</span>) {  
        perror(&amp;quot;<span class="class">Writing</span> to thread notify pipe&amp;quot;);  
    }  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Socket/">Socket</a><a href="/tags/libevent/">libevent</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/273d920/" title="MemcachedClient 使用说明 -" itemprop="url">MemcachedClient 使用说明 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x4E0A;&#x4E00;&#x7BC7;&#x4ECB;&#x7ECD;&#x4E86;Memcached&#x57FA;&#x672C;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x300A;Memcached&#x4F7F;&#x7528;&#x624B;&#x518C;&#x300B;&#xFF0C;&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;java&#x5982;&#x4F55;&#x64CD;&#x4F5C;memcached&#x3002;&#x4F7F;&#x7528;&#x7684;&#x662F;java_memcached-release_2.6.6&#x3002; </p>
<p>&#x4E00;&#x3001;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;</p>
<p>&#x65B0;&#x5EFA;&#x9879;&#x76EE;&#xFF0C;&#x6DFB;&#x52A0;&#x76F8;&#x5173;jar&#x5305;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/273c809.png" alt=""></p>
<p>&#x76F4;&#x63A5;&#x4E0A;&#x4EE3;&#x7801;&#x4E86;&#xFF0C;&#x6CE8;&#x91CA;&#x5199;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;&#xFF0C;&#x4E0D;&#x7528;&#x591A;&#x8BF4;&#x4E86;&#x554A;&#x3002;</p>
<pre><code>package www.xufei.com;

import com.danga.<span class="class">MemCached</span>.<span class="class">MemCachedClient</span>;
import com.danga.<span class="class">MemCached</span>.<span class="class">SockIOPool</span>;

public class <span class="class">MemcachedDemo</span> {

    public static void main(<span class="class">String</span>[] args) {
        //memcached&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;
        <span class="class">String</span>[] servers = {&amp;quot;<span class="number">127.0</span>.0.1:<span class="number">11211</span>&amp;quot;,&amp;quot;<span class="number">192.168</span>.1.3:<span class="number">11211</span>&amp;quot;};
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;cache&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6743</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x548C</span>;server&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x5E94</span>;
         */
        <span class="class">Integer</span>[] weights = {<span class="number">1</span>,<span class="number">2</span>};
        /**
         * &amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x7BA1</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8BAF</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5DE5</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x62EC</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8BAF</span>;&amp;<span class="symbol">#x3001</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x3001</span>;hash&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x751F</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7531</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x3002</span>;
         * &amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x5F97</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5355</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x3002</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8F7D</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;getInstance( <span class="class">String</span> poolName )&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;poolName&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;<span class="class">SockIOPool</span>&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x3002</span>;
         * &amp;<span class="symbol">#x7F3A</span>;&amp;<span class="symbol">#x7701</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x7684</span>;poolName&amp;<span class="symbol">#x662F</span>;default&amp;<span class="symbol">#x3002</span>;
         */
        <span class="class">SockIOPool</span> pool = <span class="class">SockIOPool</span>.getInstance();
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;memcached&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;
        pool.setServers(servers);
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;memcached&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x6743</span>;&amp;<span class="symbol">#x91CD</span>;
        pool.setWeights(weights);
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">TRUE</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;socket&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5E8F</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x81EA</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">NULL</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">true</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x8BAE</span>;&amp;<span class="symbol">#x4FDD</span>;&amp;<span class="symbol">#x6301</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;
        pool.setFailover( <span class="keyword">true</span> );
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;cache&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
        pool.setInitConn( <span class="number">10</span> ); 
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
        pool.setMinConn( <span class="number">5</span> );
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x670D</span>;&amp;<span class="symbol">#x52A1</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;
        pool.setMaxConn( <span class="number">250</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6C60</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7761</span>;&amp;<span class="symbol">#x7720</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x52A8</span>;
         * &amp;<span class="symbol">#x7EF4</span>;&amp;<span class="symbol">#x62A4</span>;&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;log&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FD0</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x51B5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x76EE</span>;&amp;<span class="symbol">#x53CA</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F2</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x63A7</span>;&amp;<span class="symbol">#x5236</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x3002</span>;
         */
        pool.setMaintSleep( <span class="number">30</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;<span class="class">Nagle</span>&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8BAF</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x91CF</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x5BF9</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x63A7</span>;&amp;<span class="symbol">#x5236</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x54CD</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x53CA</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="keyword">false</span>&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">true</span>&amp;<span class="symbol">#xFF09</span>;
         */
        pool.setNagle( <span class="keyword">false</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;socket&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x503C</span>;
         */
        pool.setSocketTO( <span class="number">3000</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x5FC3</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x3002</span>;
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="keyword">true</span>&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6548</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x76D1</span>;&amp;<span class="symbol">#x6D4B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9020</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x4FE1</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x500D</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7F51</span>;&amp;<span class="symbol">#x7EDC</span>;&amp;<span class="symbol">#x8D1F</span>;&amp;<span class="symbol">#x8F7D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5BF9</span>;<span class="class">HA</span>&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x6BD4</span>;&amp;<span class="symbol">#x8F83</span>;&amp;<span class="symbol">#x9AD8</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x573A</span>;&amp;<span class="symbol">#x5408</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">TRUE</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x662F</span>;<span class="keyword">false</span>&amp;<span class="symbol">#x3002</span>;
         */
        pool.setAliveCheck( <span class="keyword">true</span> );
        /**
         * &amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x5B8C</span>;pool&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x542F</span>;&amp;<span class="symbol">#x52A8</span>;pool&amp;<span class="symbol">#x3002</span>;
         */
        pool.initialize();

        /**
         * &amp;<span class="symbol">#x521B</span>;&amp;<span class="symbol">#x5EFA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;memcached&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5BF9</span>;memcached&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x91CC</span>;&amp;<span class="symbol">#x9762</span>;
         */
        <span class="class">MemCachedClient</span> memCachedClient = new <span class="class">MemCachedClient</span>();
        /**
         * &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;username&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5218</span>;&amp;<span class="symbol">#x5FB7</span>;&amp;<span class="symbol">#x534E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="keyword">true</span>
         */
        boolean success = memCachedClient.set(&amp;quot;username&amp;quot;, &amp;quot;&amp;<span class="symbol">#x5218</span>;&amp;<span class="symbol">#x5FB7</span>;&amp;<span class="symbol">#x534E</span>;&amp;quot;);
        <span class="class">System</span>.out.println(success);

        /**
         * &amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;key&amp;<span class="symbol">#x4E3A</span>;username&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;
         */
        <span class="class">Object</span> o = memCachedClient.get(&amp;quot;username&amp;quot;);
        <span class="class">System</span>.out.println(o);

        /**
         * &amp;<span class="symbol">#x5B9A</span>;&amp;<span class="symbol">#x4E49</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;p&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">Persion</span>&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x5FC5</span>;&amp;<span class="symbol">#x987B</span>;&amp;<span class="symbol">#x5B9E</span>;&amp;<span class="symbol">#x73B0</span>;<span class="class">Serializable</span>&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53E3</span>;
         */
        <span class="class">Persion</span> p = new <span class="class">Persion</span>();
        p.setId(&amp;quot;<span class="number">1</span>&amp;quot;);
        p.setName(&amp;quot;&amp;<span class="symbol">#x5468</span>;&amp;<span class="symbol">#x6770</span>;&amp;<span class="symbol">#x4F26</span>;&amp;quot;);

        /**
         * &amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;p&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
         */
        memCachedClient.set(&amp;quot;p1&amp;quot;, p);

        /**
         * &amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;p&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;
         */
        <span class="class">Persion</span> p1 = (<span class="class">Persion</span>) memCachedClient.get(&amp;quot;p1&amp;quot;);
        <span class="class">System</span>.out.println(p1.getName());

        /**
         * &amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;add&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;key&amp;<span class="symbol">#x4E3A</span>;p1&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x503C</span>;<span class="number">123</span>&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;p1&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x4E86</span>;
         */
        memCachedClient.add(&amp;quot;p1&amp;quot;, <span class="number">123</span>);//&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;&amp;<span class="symbol">#xFF01</span>;&amp;<span class="symbol">#x65E0</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p1&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x503C</span>;

        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;person&amp;<span class="symbol">#x5BF9</span>;&amp;<span class="symbol">#x8C61</span>;

        /**
         * &amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;set&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p1
         */
        memCachedClient.set(&amp;quot;p1&amp;quot;, <span class="number">123</span>);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;<span class="number">123</span>

        /**
         * &amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;replace&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p1
         */
        memCachedClient.replace(&amp;quot;p1&amp;quot;, <span class="number">456</span>);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;<span class="number">456</span>

        /**
         * &amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;replace&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;p2,&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x542B</span>;&amp;<span class="symbol">#x6709</span>;key&amp;<span class="symbol">#x4E3A</span>;p2&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x65E0</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;
         */
        memCachedClient.replace(&amp;quot;p2&amp;quot;, <span class="number">456</span>);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p2&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;null

        /**
         * &amp;<span class="symbol">#x5220</span>;&amp;<span class="symbol">#x9664</span>;key&amp;<span class="symbol">#x4E3A</span>;p1&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7F13</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;
         */
        memCachedClient.delete(&amp;quot;p1&amp;quot;);
        <span class="class">System</span>.out.println(memCachedClient.get(&amp;quot;p1&amp;quot;));//&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;null
    }
}
</code></pre><p>&#x4E8C;&#x3001;&#x5E38;&#x7528;&#x65B9;&#x6CD5;&#x8BF4;&#x660E;</p>
<p>1 <strong>&#x3001;SockIOPool&#xA0;&#x662F;socket&#xA0;&#x8FDE;&#x63A5;&#x6C60;&#x7C7B;</strong></p>
<p>setServers(String[] servers)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x670D;&#x52A1;&#x5668;&#x4FE1;&#x606F;&#x6570;&#x7EC4;&#xFF1B;</p>
<p>setWeights(String[] weights)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x670D;&#x52A1;&#x5668;&#x6743;&#x91CD;&#x6570;&#x7EC4;&#xFF1B;</p>
<p>setInitConn(int count)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x521D;&#x59CB;&#x8FDE;&#x63A5;&#x6570;&#xFF1B;</p>
<p>setMinConn(int minConn)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5C0F;&#x8FDE;&#x63A5;&#x6570;&#xFF1B;</p>
<p>setMaxConn(int maxConn)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x8FDE;&#x63A5;&#x6570;&#xFF1B;</p>
<p>setMaxIdle(long arg0)&#xA0;&#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x5904;&#x7406;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>setMaintSleep(long arg0)&#xA0;&#xFF1A;&#x4E3B;&#x7EBF;&#x7A0B;&#x7684;&#x7761;&#x7720;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>initialize()&#xA0;&#xFF1A;&#x521D;&#x59CB;&#x5316;&#x8FDE;&#x63A5;&#x6C60;&#x3002;</p>
<p>2 <strong>&#x3001;MemCachedClient&#xA0;&#x7C7B;&#x53CA;&#x5176;&#x5E38;&#x7528;&#x65B9;&#x6CD5;</strong></p>
<p>add(String key, Object value)&#xA0;&#xFF1A;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#x5230;&#x7F13;&#x5B58;&#x4E2D;&#xFF1B;</p>
<p>add(String key, Object value,Date expires)&#xA0;&#xFF1A;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#x5230;&#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>set(String key, Object value)&#xA0;&#xFF1A;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x952E;&#x7684;&#x503C;&#xFF1B;</p>
<p>set(String key, Object value, Date expires)&#xA0;&#xFF1A;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x952E;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF1B;</p>
<p>get(String key)&#xA0;&#xFF1A;&#x83B7;&#x5F97;&#x67D0;&#x4E2A;&#x952E;&#x7684;&#x503C;&#x3002;</p>
<p>incr(String key)&#xA0;&#xFF1A;&#x4E3A;&#x67D0;&#x4E2A;&#x952E;&#x4E0A;&#x7684;&#x503C;&#x6267;&#x884C;+1&#xA0;&#x64CD;&#x4F5C;&#xFF1B;</p>
<p>decr(String key)&#xA0;&#xFF1A;&#x4E3A;&#x67D0;&#x4E2A;&#x952E;&#x4E0A;&#x7684;&#x503C;&#x6267;&#x884C;-1&#xA0;&#x64CD;&#x4F5C;&#xFF1B;</p>
<p>replace(String key, String value)&#xA0;&#xFF1A;&#x5C06;&#x67D0;&#x4E2A;&#x952E;&#x7684;&#x503C;&#x66FF;&#x6362;&#x6210;&#x65B0;&#x7684;&#x503C;&#xFF1B;</p>
<p>replace(String key, String value, Date expires)&#xA0;&#xFF1A;&#x5C06;&#x67D0;&#x4E2A;&#x952E;&#x7684;&#x503C;&#x66FF;&#x6362;&#x6210;&#x65B0;&#x7684;&#x503C;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5176;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x3002;</p>
<p>delete(String key)&#xFF1A;&#x5220;&#x9664;&#x7F13;&#x5B58;&#x4E2D;&#x4E00;&#x4E2A;key&#x7684;&#x503C;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2737507/" title="Linux下安装MemCached笔记 -" itemprop="url">Linux下安装MemCached笔记 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>&#x524D;&#x63D0;&#x51C6;&#x5907;&#xFF1A;</p>
<ol>
<li><p>MemCached&#x76EE;&#x524D;&#x6700;&#x65B0;&#x7248;&#x672C;&#x4E3A;&#xFF1A;1.4.22&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE; <a href="http://memcached.org/" target="_blank" rel="external">&#x5B98;&#x7F51;</a> &#x4E0B;&#x8F7D;&#x5230;&#x3002; </p>
</li>
<li><p>MemCached&#x4F9D;&#x8D56;libevent&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x5B89;&#x88C5;MemCached&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5148;&#x5B89;&#x88C5;libevent&#x3002;</p>
</li>
</ol>
<p>2.1 &#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#xFF0C;&#x67E5;&#x770B;&#x7CFB;&#x7EDF;&#x662F;&#x5426;&#x5DF2;&#x5B89;&#x88C5;libevent&#x3002;</p>
<p>[root@SecurityCheck ~]# rpm -qa|grep libevent</p>
<p>libevent-headers-1.4.13-4.el6.noarch</p>
<p>libevent-1.4.13-4.el6.x86_64</p>
<p>libevent-doc-1.4.13-4.el6.noarch</p>
<p>libevent-devel-1.4.13-4.el6.x86_64</p>
<p>&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>3.&#xA0; &#x5C06;&#x4E0B;&#x8F7D;&#x4E0B;&#x6765;&#x7684;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5230;/opt/favccxx&#xFF0C;&#x8FD0;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x89E3;&#x538B;&#x3002;</p>
<p>[root@SecurityCheck favccxx]# tar -zxvf memcached-1.4.22.tar.gz</p>
<ol>
<li><p>&#x8FD0;&#x884C; [root@SecurityCheck favccxx]# cd memcached-1.4.22 ,&#x5207;&#x6362;&#x5230;memcached&#x76EE;&#x5F55;&#x4E0B;&#x3002;</p>
</li>
<li><p>&#x8FD0;&#x884C; [root@SecurityCheck memcached-1.4.22]# ./configure &amp;&amp; make &amp;&amp; make test &amp;&amp; sudo make install &#xFF0C;&#x4E00;&#x952E;&#x5B8C;&#x6210;&#x5B89;&#x88C5;&#x3002;</p>
</li>
<li><p>&#x8FD0;&#x884C;root@SecurityCheck bin]# ./memcached -u root&#xFF0C; &#x542F;&#x52A8;MemCached&#x3002;MemCached&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x7AEF;&#x53E3;&#x4E3A;&#xFF1A;11211&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;[root@SecurityCheck bin]# ./memcached -p 12306 -u root&#xFF0C;&#x66F4;&#x6539;&#x9ED8;&#x8BA4;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x542F;&#x52A8;&#x3002;&#x5982;&#x679C;&#x60F3;&#x8981;&#x5728;&#x5173;&#x95ED;&#x7A97;&#x53E3;&#x7684;&#x60C5;&#x51B5;&#x4E0B;memcache&#x8FDB;&#x7A0B;&#x4ECD;&#x7136;&#x8FD0;&#x884C;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x5728;&#x547D;&#x4EE4;&#x540E;&#x9762;&#x52A0;&#x4E0A; -d&#xFF0C;&#x8868;&#x793A;&#x4EE5;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x3002;</p>
</li>
<li><p>MemCached&#x7684;&#x5E38;&#x7528;&#x547D;&#x4EE4;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;[root@SecurityCheck bin]# ./memcached&#xA0; -h &#x67E5;&#x770B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E9B;&#x5E38;&#x7528;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
</li>
</ol>
<p>-d &#xFF1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;</p>
<p>-m&#xFF1A;&#x5206;&#x914D;&#x7ED9;Memcache&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x6570;&#x91CF;&#xFF0C;&#x5355;&#x4F4D;&#x662F;MB&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;64MB&#xFF0C;</p>
<p>-u &#xFF1A;&#x8FD0;&#x884C;Memcache&#x7684;&#x7528;&#x6237;</p>
<p>-l&#xA0; &#xFF1A;&#x76D1;&#x542C;&#x7684;&#x670D;&#x52A1;&#x5668;IP&#x5730;&#x5740;</p>
<p>-p &#xFF1A;&#x8BBE;&#x7F6E;Memcache&#x76D1;&#x542C;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;11211&#xA0; &#xA0; &#x6CE8;&#xFF1A;-p&#xFF08;p&#x4E3A;&#x5C0F;&#x5199;&#xFF09;</p>
<p>-c &#xFF1A;&#x8BBE;&#x7F6E;&#x6700;&#x5927;&#x5E76;&#x53D1;&#x8FDE;&#x63A5;&#x6570;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;1024</p>
<ol>
<li>&#x81F3;&#x6B64;&#xFF0C;MemCached&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x53EF;&#x4EE5;&#x4F53;&#x9A8C;MemCached&#x4E86;&#x3002;</li>
</ol>
<p>Memcached &#x5B89;&#x88C5;&#x53CA;&#x542F;&#x52A8;&#x811A;&#x672C; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-07/87641.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-07/87641.htm</a></p>
<p>PHP&#x4E2D;&#x4F7F;&#x7528;Memcached&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85883.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85883.htm</a></p>
<p>Ubuntu&#x4E0B;&#x5B89;&#x88C5;Memcached&#x53CA;&#x547D;&#x4EE4;&#x89E3;&#x91CA; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-06/85832.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-06/85832.htm</a></p>
<p>Memcached&#x7684;&#x5B89;&#x88C5;&#x548C;&#x5E94;&#x7528; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-08/89165.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-08/89165.htm</a></p>
<p>&#x4F7F;&#x7528;Nginx+Memcached&#x7684;&#x5C0F;&#x56FE;&#x7247;&#x5B58;&#x50A8;&#x65B9;&#x6848; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2013-11/92390.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2013-11/92390.htm</a></p>
<p>Memcached&#x4F7F;&#x7528;&#x5165;&#x95E8; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2011-12/49516p2.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2011-12/49516p2.htm</a></p>
<p> <strong>Memcached &#x7684;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;</strong> &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> Memcached &#x7684;&#x4E0B;&#x8F7D;&#x5730;&#x5740; &#xFF1A;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; </p>
<p> <strong>&#x672C;&#x6587;&#x6C38;&#x4E45;&#x66F4;&#x65B0;&#x94FE;&#x63A5;&#x5730;&#x5740;</strong> &#xFF1A; <a href="http://www.linuxidc.com/Linux/2015-04/../../Linux/2015-04/115643.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2015-04/115643.htm</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/27631b6/" title="Linux c 开发 - Memcached源码分析之命令解析（2） -" itemprop="url">Linux c 开发 - Memcached源码分析之命令解析（2） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x4ECE;&#x6211;&#x4EEC;&#x4E0A;&#x4E00;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x57FA;&#x4E8E;Libevent&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#xFF08;1&#xFF09;&#x300B;&#x6211;&#x4EEC;&#x57FA;&#x672C;&#x4E86;&#x89E3;&#x4E86;Memcached&#x7684;&#x7F51;&#x7EDC;&#x6A21;&#x578B;&#x3002;&#x8FD9;&#x4E00;&#x7AE0;&#x8282;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8BE6;&#x7EC6;&#x89E3;&#x8BFB;Memcached&#x7684;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x56DE;&#x987E;&#x4E0A;&#x4E00;&#x7AE0;&#x53D1;&#x73B0;Memcached&#x4F1A;&#x5206;&#x6210;&#x4E3B;&#x7EBF;&#x7A0B;&#x548C;N&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x3002;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x76D1;&#x542C;accpet&#x5BA2;&#x6237;&#x7AEF;&#x7684;Socket&#x8FDE;&#x63A5;&#xFF0C;&#x800C;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x63A5;&#x7BA1;&#x5177;&#x4F53;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x3002;</p>
<p>&#x4E3B;&#x7EBF;&#x7A0B;&#x548C;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x4E3B;&#x8981;&#x901A;&#x8FC7;&#x57FA;&#x4E8E;Libevent&#x7684;pipe&#x7684;&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#x6765;&#x76D1;&#x542C;&#xFF0C;&#x5F53;&#x6709;&#x8FDE;&#x63A5;&#x7EC3;&#x4E0A;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3B;&#x7EBF;&#x7A0B;&#x4F1A;&#x5C06;&#x8FDE;&#x63A5;&#x4EA4;&#x4E2A;&#x67D0;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x53BB;&#x63A5;&#x7BA1;&#xFF0C;&#x540E;&#x671F;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x8BFB;&#x5199;&#x5DE5;&#x4F5C;&#x90FD;&#x4F1A;&#x5728;&#x8FD9;&#x4E2A;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E2D;&#x8FDB;&#x884C;&#x3002;</p>
<p>&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x4E5F;&#x662F;&#x57FA;&#x4E8E;Libevent&#x7684;&#x4E8B;&#x4EF6;&#x7684;&#xFF0C;&#x5F53;&#x6709;&#x8BFB;&#x6216;&#x8005;&#x5199;&#x7684;&#x4E8B;&#x4EF6;&#x8FDB;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x4E8B;&#x4EF6;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x90A3;&#x4E48;Memcached&#x662F;&#x5982;&#x4F55;&#x6765;&#x89E3;&#x6790;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x4F20;&#x7684;&#x547D;&#x4EE4;&#x6570;&#x636E;&#x62A5;&#x6587;&#x7684;&#x5462;&#xFF1F;&#x8FD9;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x8BE6;&#x7EC6;&#x8BB2;&#x89E3;&#x547D;&#x4EE4;&#x7684;&#x89E3;&#x6790;&#x8FC7;&#x7A0B;&#xFF0C;&#x4E0B;&#x4E00;&#x7AE0;&#x4F1A;&#x8BB2;&#x89E3;Memcached&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x56DE;&#x5E94;&#x3002;</p>
<p>Memcached&#x7684;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x6E90;&#x7801;&#x5206;&#x6790;</p>
<p>conn&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<p>&#x6BCF;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;conn&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x4E3B;&#x8981;&#x5B58;&#x50A8;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x8FD9;&#x4E00;&#x7AE0;&#x4E2D;&#x7528;&#x5230;&#x7684;&#x51E0;&#x4E2A;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x53C2;&#x6570;&#xFF1A;</p>
<p>char * rbuf&#xFF1A;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x5BA2;&#x6237;&#x7AEF;&#x6570;&#x636E;&#x62A5;&#x6587;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
<p>int rsize&#xFF1A;rbuf&#x7684;&#x5927;&#x5C0F;&#x3002;</p>
<p>char * rcurr&#xFF1A;&#x672A;&#x89E3;&#x6790;&#x7684;&#x547D;&#x4EE4;&#x7684;&#x5B57;&#x7B26;&#x6307;&#x9488;&#x3002;</p>
<p>int rbytes&#xFF1A;&#x4E3A;&#x89E3;&#x6790;&#x7684;&#x547D;&#x4EE4;&#x7684;&#x957F;&#x5EA6;&#x3002;</p>
<p><img src="http://taojinke.github.io/img/20150703/275f4ad.jpg" alt=""></p>
<pre><code><span class="keyword">typedef</span> <span class="keyword">struct</span> conn conn;  
<span class="keyword">struct</span> conn {  
    <span class="keyword">int</span>    sfd;  
    <span class="keyword">sasl_conn_t</span> *sasl_conn;  
    <span class="keyword">bool</span> authenticated;  
    <span class="keyword">enum</span> conn_states  state;  
    <span class="keyword">enum</span> bin_substates substate;  
    <span class="keyword">rel_time_t</span> <span class="keyword">last_cmd_t</span>ime;  
    <span class="keyword">struct</span> event event;  
    <span class="keyword">short</span>  ev_flags;  
    <span class="keyword">short</span>  which;   <span class="comment">/** which events were just triggered */</span>  

    <span class="keyword">char</span>   *rbuf;   <span class="comment">/** buffer to read commands into */</span>  
    <span class="keyword">char</span>   *rcurr;  <span class="comment">/** but if we parsed some already, this is where we stopped */</span>  
    <span class="keyword">int</span>    rsize;   <span class="comment">/** total allocated size of rbuf */</span>  
    <span class="keyword">int</span>    rbytes;  <span class="comment">/** how much data, starting from rcur, do we have unparsed */</span>  

    <span class="keyword">char</span>   *wbuf;  
    <span class="keyword">char</span>   *wcurr;  
    <span class="keyword">int</span>    wsize;  
    <span class="keyword">int</span>    wbytes;  
    <span class="comment">/** which state to go into after finishing current write */</span>  
    <span class="keyword">enum</span> conn_states  write_and_go;  
    <span class="keyword">void</span>   *write_and_free; <span class="comment">/** free this memory after finishing writing */</span>  

    <span class="keyword">char</span>   *ritem;  <span class="comment">/** when we read in an item&amp;apos;s value, it goes here */</span>  
    <span class="keyword">int</span>    rlbytes;  

    <span class="comment">/* data for the nread state */</span>  

    <span class="comment">/** 
     * item is used to hold an item structure created after reading the command 
     * line of set/add/replace commands, but before we finished reading the actual 
     * data. The data is read into ITEM_data(item) to avoid extra copying. 
     */</span>  

    <span class="keyword">void</span>   *item;     <span class="comment">/* for commands set/add/replace  */</span>  

    <span class="comment">/* data for the swallow state */</span>  
    <span class="keyword">int</span>    sbytes;    <span class="comment">/* how many bytes to swallow */</span>  

    <span class="comment">/* data for the mwrite state */</span>  
    <span class="keyword">struct</span> iovec *iov;  
    <span class="keyword">int</span>    iovsize;   <span class="comment">/* number of elements allocated in iov[] */</span>  
    <span class="keyword">int</span>    iovused;   <span class="comment">/* number of elements used in iov[] */</span>  

    <span class="keyword">struct</span> msghdr *msglist;  
    <span class="keyword">int</span>    msgsize;   <span class="comment">/* number of elements allocated in msglist[] */</span>  
    <span class="keyword">int</span>    msgused;   <span class="comment">/* number of elements used in msglist[] */</span>  
    <span class="keyword">int</span>    msgcurr;   <span class="comment">/* element in msglist[] being transmitted now */</span>  
    <span class="keyword">int</span>    msgbytes;  <span class="comment">/* number of bytes in current msg */</span>  

    item   **ilist;   <span class="comment">/* list of items to write out */</span>  
    <span class="keyword">int</span>    isize;  
    item   **icurr;  
    <span class="keyword">int</span>    ileft;  

    <span class="keyword">char</span>   **suffixlist;  
    <span class="keyword">int</span>    suffixsize;  
    <span class="keyword">char</span>   **suffixcurr;  
    <span class="keyword">int</span>    suffixleft;  

    <span class="keyword">enum</span> protocol protocol;   <span class="comment">/* which protocol this connection speaks */</span>  
    <span class="keyword">enum</span> <span class="keyword">network_t</span>ransport transport; <span class="comment">/* what transport is used by this connection */</span>  

    <span class="comment">/* data for UDP clients */</span>  
    <span class="keyword">int</span>    request_id; <span class="comment">/* Incoming UDP request ID, if this is a UDP &amp;quot;connection&amp;quot; */</span>  
    <span class="keyword">struct</span> sockaddr_in6 request_addr; <span class="comment">/* udp: Who sent the most recent request */</span>  
    <span class="keyword">socklen_t</span> request_addr_size;  
    <span class="keyword">unsigned</span> <span class="keyword">char</span> *hdrbuf; <span class="comment">/* udp packet headers */</span>  
    <span class="keyword">int</span>    hdrsize;   <span class="comment">/* number of headers&amp;apos; worth of space is allocated */</span>  

    <span class="keyword">bool</span>   noreply;   <span class="comment">/* True if the reply should not be sent. */</span>  
    <span class="comment">/* current stats command */</span>  
    <span class="keyword">struct</span> {  
        <span class="keyword">char</span> *buffer;  
        <span class="keyword">size_t</span> size;  
        <span class="keyword">size_t</span> offset;  
    } stats;  

    <span class="comment">/* Binary protocol stuff */</span>  
    <span class="comment">/* This is where the binary header goes */</span>  
    protocol_binary_request_header binary_header;  
    <span class="keyword">uint64_t</span> cas; <span class="comment">/* the cas to return */</span>  
    <span class="keyword">short</span> cmd; <span class="comment">/* current command being processed */</span>  
    <span class="keyword">int</span> opaque;  
    <span class="keyword">int</span> keylen;  
    conn   *next;     <span class="comment">/* Used for generating a list of conn structures */</span>  
    LIBEVENT_THREAD *thread; <span class="comment">/* Pointer to the thread object serving this connection */</span>  
};
</code></pre><p>&#x6574;&#x4F53;&#x6D41;&#x7A0B;</p>
<ol>
<li><p>&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x548C;Memcached&#x5EFA;&#x7ACB;TCP&#x8FDE;&#x63A5;&#x540E;&#xFF0C;Memcached&#x4F1A;&#x57FA;&#x4E8E;Libevent&#x7684;event&#x4E8B;&#x4EF6;&#x6765;&#x76D1;&#x542C;&#x5BA2;&#x6237;&#x7AEF;&#x662F;&#x5426;&#x6709;&#x53EF;&#x4EE5;&#x8BFB;&#x53D6;&#x7684;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x6709;&#x547D;&#x4EE4;&#x6570;&#x636E;&#x62A5;&#x6587;&#x4E0A;&#x62A5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;drive_machine&#x65B9;&#x6CD5;&#x4E2D;&#x7684;conn_read&#x8FD9;&#x4E2A;Case&#x3002;</p>
</li>
<li><p>memcached&#x901A;&#x8FC7;try_read_network&#x65B9;&#x6CD5;&#x8BFB;&#x53D6;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x62A5;&#x6587;&#x3002;&#x5982;&#x679C;&#x8BFB;&#x53D6;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;conn_closing&#xFF0C;&#x53BB;&#x5173;&#x95ED;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#xFF1B;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BFB;&#x53D6;&#x5230;&#x4EFB;&#x4F55;&#x6570;&#x636E;&#xFF0C;&#x5219;&#x4F1A;&#x8FD4;&#x56DE;conn_waiting&#xFF0C;&#x7EE7;&#x7EED;&#x7B49;&#x5F85;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4E8B;&#x4EF6;&#x5230;&#x6765;&#xFF0C;&#x5E76;&#x4E14;&#x9000;&#x51FA;drive_machine&#x7684;&#x5FAA;&#x73AF;&#xFF1B;&#x5982;&#x679C;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;&#x72B6;&#x6001;&#x8F6C;&#x4EA4;&#x7ED9;conn_parse_cmd&#x5904;&#x7406;&#xFF0C;&#x8BFB;&#x53D6;&#x5230;&#x7684;&#x6570;&#x636E;&#x4F1A;&#x5B58;&#x50A8;&#x5728;c-&gt;rbuf&#x5BB9;&#x5668;&#x4E2D;&#x3002;</p>
</li>
<li><p>conn_parse_cmd&#x4E3B;&#x8981;&#x7684;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x7528;&#x6765;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#x3002;&#x4E3B;&#x8981;&#x901A;&#x8FC7;try_read_command&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6765;&#x8BFB;&#x53D6;c-&gt;rbuf&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x6570;&#x636E;&#xFF0C;&#x901A;&#x8FC7;\n&#x6765;&#x5206;&#x9694;&#x6570;&#x636E;&#x62A5;&#x6587;&#x7684;&#x547D;&#x4EE4;&#x3002;&#x5982;&#x679C;c-&gt;buf&#x5185;&#x5B58;&#x5757;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5339;&#x914D;&#x4E0D;&#x5230;\n&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x7EE7;&#x7EED;&#x7B49;&#x5F85;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x547D;&#x4EE4;&#x6570;&#x636E;&#x62A5;&#x6587;&#x5230;&#x6765;conn_waiting&#xFF1B;&#x5426;&#x5219;&#x5C31;&#x4F1A;&#x8F6C;&#x4EA4;&#x7ED9;process_command&#x65B9;&#x6CD5;&#xFF0C;&#x6765;&#x5904;&#x7406;&#x5177;&#x4F53;&#x7684;&#x547D;&#x4EE4;&#xFF08;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x4F1A;&#x901A;&#x8FC7;\0&#x7B26;&#x53F7;&#x6765;&#x5206;&#x9694;&#xFF09;&#x3002;</p>
</li>
<li><p>process<em>command&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5904;&#x7406;&#x5177;&#x4F53;&#x7684;&#x547D;&#x4EE4;&#x3002;&#x5176;&#x4E2D;tokenize_command&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;&#x5C06;&#x547D;&#x4EE4;&#x62C6;&#x89E3;&#x6210;&#x591A;&#x4E2A;&#x5143;&#x7D20;&#xFF08;KEY&#x7684;&#x6700;&#x5927;&#x957F;&#x5EA6;250&#xFF09;&#x3002;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x4EE5;get&#x547D;&#x4EE4;&#x4E3A;&#x4F8B;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;process_get_command&#x8FD9;&#x4E2A;&#x547D;&#x4EE4; process</em>*_command&#x8FD9;&#x4E00;&#x7CFB;&#x5217;&#x5C31;&#x662F;&#x5904;&#x7406;&#x5177;&#x4F53;&#x7684;&#x547D;&#x4EE4;&#x903B;&#x8F91;&#x7684;&#x3002;</p>
</li>
<li><p>&#x6211;&#x4EEC;&#x8FDB;&#x5165;process_get_command&#xFF0C;&#x5F53;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x5904;&#x7406;&#x5B8C;&#x6BD5;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x8F6C;&#x4EA4;&#x5230;conn_mwrite&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x3002;&#x5982;&#x679C;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002;</p>
</li>
<li><p>&#x8FDB;&#x5165;conn_mwrite&#x540E;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;transmit&#x65B9;&#x6CD5;&#x6765;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x63D0;&#x4EA4;&#x6570;&#x636E;&#x3002;&#x5982;&#x679C;&#x5199;&#x6570;&#x636E;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x6216;&#x9000;&#x51FA;drive_machine&#x5FAA;&#x73AF;&#xFF1B;&#x5982;&#x679C;&#x5199;&#x5165;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x53C8;&#x8F6C;&#x4EA4;&#x5230;conn_new_cmd&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x3002;</p>
</li>
<li><p>conn_new_cmd&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x4E3B;&#x8981;&#x662F;&#x5904;&#x7406;c-&gt;rbuf&#x4E2D;&#x5269;&#x4F59;&#x7684;&#x547D;&#x4EE4;&#x3002;&#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;reset_cmd_handler&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x56DE;&#x53BB;&#x5224;&#x65AD;c-&gt;rbytes&#x4E2D;&#x662F;&#x5426;&#x8FD8;&#x6709;&#x5269;&#x4F59;&#x7684;&#x62A5;&#x6587;&#x6CA1;&#x5904;&#x7406;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x5904;&#x7406;&#xFF0C;&#x5219;&#x8F6C;&#x4EA4;&#x5230;conn_parse_cmd&#xFF08;&#x7B2C;&#x56DB;&#x90E8;&#xFF09;&#x7EE7;&#x7EED;&#x89E3;&#x6790;&#x5269;&#x4F59;&#x547D;&#x4EE4;&#xFF1B;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x4E86;&#xFF0C;&#x5219;&#x8F6C;&#x4EA4;&#x5230;conn_waiting&#xFF0C;&#x7B49;&#x5F85;&#x65B0;&#x7684;&#x4E8B;&#x4EF6;&#x5230;&#x6765;&#x3002;&#x5728;&#x8F6C;&#x4EA4;&#x4E4B;&#x524D;&#xFF0C;&#x6BCF;&#x6B21;&#x90FD;&#x4F1A;&#x6267;&#x884C;&#x4E00;&#x6B21;conn_shrink&#x65B9;&#x6CD5;&#x3002;</p>
</li>
<li><p>conn_shrink&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5904;&#x7406;&#x547D;&#x4EE4;&#x62A5;&#x6587;&#x5BB9;&#x5668;c-&gt;rbuf&#x548C;&#x8F93;&#x51FA;&#x5185;&#x5BB9;&#x7684;&#x5BB9;&#x5668;&#x662F;&#x5426;&#x6570;&#x636E;&#x6EE1;&#x4E86;&#xFF1F;&#x662F;&#x5426;&#x9700;&#x8981;&#x6269;&#x5927;buffer&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x662F;&#x5426;&#x9700;&#x8981;&#x79FB;&#x52A8;&#x5185;&#x5B58;&#x5757;&#x3002;&#x63A5;&#x53D7;&#x547D;&#x4EE4;&#x62A5;&#x6587;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5185;&#x5B58;&#x5757;&#x5927;&#x5C0F;2048&#xFF0C;&#x6700;&#x5927;8192&#x3002;</p>
</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/275f4ad.jpg" alt=""></p>
<p><img src="http://taojinke.github.io/img/20150703/275f71e.jpg" alt=""></p>
<p>&#x547D;&#x4EE4;rbuf&#x6570;&#x636E;&#x7ED3;&#x6784;&#x53D8;&#x5316;&#x56FE;&#xFF1A;</p>
<ol>
<li>&#x8BFB;&#x53D6;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6570;&#x636E;</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/275f98f.jpg" alt=""></p>
<ol>
<li>&#x89E3;&#x6790;buf&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x3002;&#x5982;&#x679C;&#x9047;&#x5230;\n&#xFF0C;&#x5219;&#x8868;&#x660E;&#x662F;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x8BED;&#x53E5;&#x7684;&#x7ED3;&#x5C3E;&#x6807;&#x8BC6;&#x7B26;&#x3002;</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/275f98f.jpg" alt=""></p>
<ol>
<li>&#x547D;&#x4EE4;&#x62C6;&#x5206;&#x3002;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#x51FA;&#x6765;&#x4E4B;&#x540E;&#xFF0C;&#x5BF9;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x5206;&#x89E3;&#xFF0C;&#x5206;&#x89E3;&#x662F;&#x901A;&#x8FC7;&#x7A7A;&#x683C;&#x6765;&#x5206;&#x79BB;&#x7684;&#x3002;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E00;&#x822C;&#x4E3A;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E00;&#x822C;&#x4E3A;KEY&#x3002;</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/275f98f.jpg" alt=""></p>
<ol>
<li>&#x5185;&#x5B58;&#x5757;&#x91CD;&#x8BBE;&#x7F6E;&#x3002;&#x5982;&#x679C;rbuf&#x5185;&#x5B58;&#x5757;&#x4F7F;&#x7528;&#x7A7A;&#x95F4;&#x4E0D;&#x8DB3;&#xFF0C;&#x6216;&#x8005;&#x5927;&#x4E8E;8k&#xFF0C;&#x5219;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x5185;&#x5B58;&#x5757;</li>
</ol>
<p><img src="http://taojinke.github.io/img/20150703/275fc00.jpg" alt=""></p>
<p>&#x4ECE;drive_machine&#x5F00;&#x59CB;</p>
<p>&#x6211;&#x4EEC;&#x4E0A;&#x4E00;&#x8282;&#x770B;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x7684;&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF1A;event_handler&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x7684;&#x662F;drive_machine&#x3002;</p>
<pre><code><span class="function"><span class="keyword">void</span> <span class="title">event_handler</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">short</span> which, <span class="keyword">void</span> *arg)</span> </span>{  
    conn *c;  
    <span class="comment">//&amp;#x7EC4;&amp;#x88C5;conn&amp;#x7ED3;&amp;#x6784;  </span>
    c = (conn *) arg;  
    <span class="keyword">assert</span>(c != NULL);  
    c-&amp;gt;which = which;  
    <span class="comment">/* sanity */</span>  
    <span class="keyword">if</span> (fd != c-&amp;gt;sfd) {  
        <span class="keyword">if</span> (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;Catastrophic: event fd doesn&amp;apos;t match conn fd!\n&amp;quot;);  
        conn_close(c);  
        <span class="keyword">return</span>;  
    }  
    <span class="comment">//&amp;#x6700;&amp;#x7EC8;&amp;#x8F6C;&amp;#x4EA4;&amp;#x7ED9;&amp;#x4E86;drive_machine&amp;#x8FD9;&amp;#x4E2A;&amp;#x65B9;&amp;#x6CD5;  </span>
    drive_machine(c);  
    <span class="comment">/* wait for next event */</span>  
    <span class="keyword">return</span>;  
}
</code></pre><p>drive_machine&#xFF1A;</p>
<p>drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x90FD;&#x662F;&#x901A;&#x8FC7;c-&gt;state&#x6765;&#x5224;&#x65AD;&#x9700;&#x8981;&#x5904;&#x7406;&#x7684;&#x903B;&#x8F91;&#x3002;</p>
<p>conn_listening&#xFF1A;&#xFFFD;&#xFFFD;&#xFFFD;&#x542C;&#x72B6;&#x6001;</p>
<p>conn_waiting&#xFF1A;&#x7B49;&#x5F85;&#x72B6;&#x6001;</p>
<p>conn_read&#xFF1A;&#x8BFB;&#x53D6;&#x72B6;&#x6001;</p>
<p>conn_parse_cmd&#xFF1A;&#x547D;&#x4EE4;&#x884C;&#x89E3;&#x6790;</p>
<p>conn_mwrite&#xFF1A;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x5199;&#x6570;&#x636E;</p>
<p>conn_new_cmd&#xFF1A;&#x89E3;&#x6790;&#x65B0;&#x7684;&#x547D;&#x4EE4;</p>
<pre><code><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">drive_machine</span><span class="params">(conn *c)</span> </span>{  
    <span class="keyword">bool</span> stop = <span class="keyword">false</span>;  
    <span class="keyword">int</span> sfd;  
    <span class="keyword">socklen_t</span> addrlen;  
    <span class="keyword">struct</span> sockaddr_storage addr;  
    <span class="keyword">int</span> nreqs = settings.reqs_per_event;  
    <span class="keyword">int</span> res;  
    <span class="keyword">const</span> <span class="keyword">char</span> *str;  
    <span class="preprocessor">#ifdef HAVE_ACCEPT4  </span>
    <span class="keyword">static</span> <span class="keyword">int</span> use_accept4 = <span class="number">1</span>;  
    <span class="preprocessor">#<span class="keyword">else</span>  </span>
    <span class="keyword">static</span> <span class="keyword">int</span> use_accept4 = <span class="number">0</span>;  
    <span class="preprocessor">#<span class="keyword">endif</span>  </span>
    assert(c != NULL);  
    <span class="keyword">while</span> (!stop) {  
        <span class="keyword">switch</span> (c-&amp;gt;state) {  
        <span class="keyword">case</span> conn_listening:  
<span class="comment">//.......&amp;#x66F4;&amp;#x591A;&amp;#x4EE3;&amp;#x7801;  </span>
}
</code></pre><p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;&#x4E00;&#x4E0B;conn_read&#x3001;conn_wait&#x548C;conn_parse_cmd&#x72B6;&#x6001;&#x7684;&#x4EE3;&#x7801;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6765</span>;  
case <span class="method">conn_waiting:</span>  
    if (!update_event(c, <span class="class">EV_READ</span> | <span class="class">EV_PERSIST</span>)) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    //&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;stop&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="keyword">true</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9000</span>;&amp;<span class="symbol">#x51FA</span>;while(stop)&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;  
    conn_set_state(c, conn_read);  
    stop = <span class="keyword">true</span>;  
    break;  
    //&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x89E6</span>;&amp;<span class="symbol">#x53D1</span>;libevent&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;  
case <span class="method">conn_read:</span>  
    //try_read_network &amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;try_read_result&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
    res = <span class="class">IS_UDP</span>(c-&amp;gt;transport) ? try_read_udp(c) : try_read_network(c);  
    switch (res) {  
    //&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x90A3</span>;&amp;<span class="symbol">#x4E48</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x4E8B</span>;&amp;<span class="symbol">#x4EF6</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x3002</span>;  
    //while(stop)&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;conn_waiting&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;case  
    case <span class="class">READ_NO_DATA_RECEIVED</span>:  
        conn_set_state(c, conn_waiting);  
        break;  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;conn_parse_cmd&amp;<span class="symbol">#x903B</span>;&amp;<span class="symbol">#x8F91</span>;  
        //conn_parse_cmd&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    case <span class="class">READ_DATA_RECEIVED</span>:  
        conn_set_state(c, conn_parse_cmd);  
        break;  
        //&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;conn_closing &amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
    case <span class="class">READ_ERROR</span>:  
        conn_set_state(c, conn_closing);  
        break;  
    case <span class="class">READ_MEMORY_ERROR</span>: /* <span class="class">Failed</span> to allocate more memory */  
        /* <span class="class">State</span> already set by try_read_network */  
        break;  
    }  
    break;  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#xFF1A</span>;set username zhuli  
case <span class="method">conn_parse_cmd:</span>  
    //try_read_command&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x5F88</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x952E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x793A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x7C98</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x56E0</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#xFF09</span>;  
    if (try_read_command(c) == <span class="number">0</span>) {  
        /* wee need more data! */  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x91CA</span>;&amp;<span class="symbol">#x8C8C</span>;&amp;<span class="symbol">#x4F3C</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x9519</span>;&amp;<span class="symbol">#x8BEF</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x5427</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E94</span>;&amp;<span class="symbol">#x8BE5</span>;&amp;<span class="symbol">#x662F</span>;we need more data!  
        conn_set_state(c, conn_waiting);  
    }  
    break;
</code></pre><p>try_read_network</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x8BFB;&#x53D6;TCP&#x7F51;&#x7EDC;&#x6570;&#x636E;&#x3002;&#x8BFB;&#x53D6;&#x5230;&#x7684;&#x6570;&#x636E;&#x4F1A;&#x653E;&#x8FDB;c-&gt;rbuf&#x7684;buf&#x4E2D;&#x3002;</p>
<p>&#x5982;&#x679C;buf&#x6CA1;&#x6709;&#x7A7A;&#x95F4;&#x5B58;&#x50A8;&#x66F4;&#x591A;&#x6570;&#x636E;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x5185;&#x5B58;&#x5757;&#x7684;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x3002;&#x91CD;&#x65B0;&#x5206;&#x914D;&#xFF0C;memcached&#x9650;&#x5236;&#x4E86;4&#x6B21;&#xFF0C;&#x4F30;&#x8BA1;&#x662F;&#x62C5;&#x5FE7;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x800C;&#x5DF2;&#x653B;&#x51FB;&#x5BFC;&#x81F4;&#x5B58;&#x50A8;&#x547D;&#x4EE4;&#x884C;&#x6570;&#x636E;&#x62A5;&#x6587;&#x7684;buf&#x4E0D;&#x65AD;&#x7684;ralloc&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x4F20</span>;&amp;<span class="symbol">#x9012</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
static enum try_read_result try_read_network(conn *c) {  
    //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x7EC8</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;try_read_result&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;  
    //&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;<span class="class">READ_NO_DATA_RECEIVED</span>&amp;<span class="symbol">#xFF1A</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53D7</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    enum try_read_result gotdata = <span class="class">READ_NO_DATA_RECEIVED</span>;  
    int res;  
    int num_allocs = <span class="number">0</span>;  
    assert(c != <span class="class">NULL</span>);  
    //c-&amp;gt;rcurr &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;   c-&amp;gt;rbytes &amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    //c-&amp;gt;rbuf &amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;buf&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x4E32</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;  c-&amp;gt;rsize rbuf&amp;<span class="symbol">#x7684</span>;size  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x5230</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5934</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x3002</span>;  
        if (c-&amp;gt;rcurr != c-&amp;gt;rbuf) {  
        if (c-&amp;gt;rbytes != <span class="number">0</span>) /* otherwise there&amp;apos;s nothing to copy */  
            memmove(c-&amp;gt;rbuf, c-&amp;gt;rcurr, c-&amp;gt;rbytes);  
        c-&amp;gt;rcurr = c-&amp;gt;rbuf;  
    }  
    //&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;&amp;<span class="symbol">#x4ECE</span>;fd&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
    while (<span class="number">1</span>) {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;buf&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
        //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;size &amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>; buf&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x7684</span>;size&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;  
        if (c-&amp;gt;rbytes &amp;gt;= c-&amp;gt;rsize) {  
            //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;<span class="number">4</span>&amp;<span class="symbol">#x6B21</span>;  
            if (num_allocs == <span class="number">4</span>) {  
                return gotdata;  
            }  
            ++num_allocs;  
            //&amp;<span class="symbol">#x4ECE</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E3A</span>;rsize&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x500D</span>;  
            char *new_rbuf = realloc(c-&amp;gt;rbuf, c-&amp;gt;rsize * <span class="number">2</span>);  
            if (!new_rbuf) {  
                <span class="class">STATS_LOCK</span>();  
                stats.malloc_fails++;  
                <span class="class">STATS_UNLOCK</span>();  
                if (settings.verbose &amp;gt; <span class="number">0</span>) {  
                    fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t realloc input buffer\n&amp;quot;);  
                }  
                c-&amp;gt;rbytes = <span class="number">0</span>; /* ignore what we read */  
                out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory reading request&amp;quot;);  
                c-&amp;gt;write_and_go = conn_closing;  
                return <span class="class">READ_MEMORY_ERROR</span>;  
            }  
            //c-&amp;gt;rcurr&amp;<span class="symbol">#x548C</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;buf&amp;<span class="symbol">#x5757</span>;  
            c-&amp;gt;rcurr = c-&amp;gt;rbuf = new_rbuf;  
            c-&amp;gt;rsize *= <span class="number">2</span>; //rsize&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4E58</span>;&amp;<span class="symbol">#x4EE5</span>;<span class="number">2</span>  
        }  
        //avail&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x8BA1</span>;&amp;<span class="symbol">#x7B97</span>;&amp;<span class="symbol">#x51FA</span>;buf&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;  
        int avail = c-&amp;gt;rsize - c-&amp;gt;rbytes;  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
        //c-&amp;gt;sfd&amp;<span class="symbol">#x4E3A</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x7684</span>;<span class="class">ID</span>  
        //c-&amp;gt;rbuf + c-&amp;gt;rbytes &amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#x601D</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;buf&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        //avail &amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        res = read(c-&amp;gt;sfd, c-&amp;gt;rbuf + c-&amp;gt;rbytes, avail);  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x53D7</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x679C</span>;res&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;<span class="class">Socket</span>&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        //&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x6210</span>;<span class="class">READ_DATA_RECEIVED</span>&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        if (res &amp;gt; <span class="number">0</span>) {  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex); //&amp;<span class="symbol">#x7EBF</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x9501</span>;  
            c-&amp;gt;thread-&amp;gt;stats.bytes_read += res;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            gotdata = <span class="class">READ_DATA_RECEIVED</span>;  
            c-&amp;gt;rbytes += res; //&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x91CF</span>; + &amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;size  
            if (res == avail) {  
                continue;  
            } else {  
                break;  
            }  
        }  
        //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x79CD</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
        if (res == <span class="number">0</span>) {  
            return <span class="class">READ_ERROR</span>;  
        }  
        if (res == -<span class="number">1</span>) {  
            if (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>) {  
                break;  
            }  
            return <span class="class">READ_ERROR</span>;  
        }  
    }  
    return gotdata;  
}
</code></pre><p>try_read_command</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x8BFB;&#x53D6;rbuf&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x7684;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#x547D;&#x4EE4;&#xFF1A;set username zhuli\r\n get username \n</p>
<p>&#x5219;&#x4F1A;&#x901A;&#x8FC7;\n&#x8FD9;&#x4E2A;&#x6362;&#x884C;&#x7B26;&#x6765;&#x5206;&#x9694;&#x6570;&#x636E;&#x62A5;&#x6587;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x3002;&#x56E0;&#x4E3A;&#x6570;&#x636E;&#x62A5;&#x6587;&#x4F1A;&#x6709;&#x7C98;&#x5305;&#x548C;&#x62C6;&#x5305;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x6709;&#x7B49;&#x5230;&#x547D;&#x4EE4;&#x884C;&#x5B8C;&#x6574;&#x4E86;&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x3002;&#x6240;&#x6709;&#x53EA;&#x6709;&#x5339;&#x914D;&#x5230;&#x4E86;\n&#x7B26;&#x53F7;&#xFF0C;&#x624D;&#x80FD;&#x5339;&#x914D;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x5728</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x8C03</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6B64</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;  
static int try_read_command(conn *c) {  
    assert(c != <span class="class">NULL</span>);  
    assert(c-&amp;gt;rcurr &amp;lt;= (c-&amp;gt;rbuf + c-&amp;gt;rsize)); //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x8A00</span>;  
    assert(c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>);  
    if (c-&amp;gt;protocol == negotiating_prot || c-&amp;gt;transport == udp_transport) {  
        if ((unsigned char) c-&amp;gt;rbuf[<span class="number">0</span>] == (unsigned char) <span class="class">PROTOCOL_BINARY_REQ</span>) {  
            c-&amp;gt;protocol = binary_prot;  
        } else {  
            c-&amp;gt;protocol = ascii_prot;  
        }  
        if (settings.verbose &amp;gt; <span class="number">1</span>) {  
            fprintf(stderr, &amp;quot;%<span class="method">d:</span> <span class="class">Client</span> using the %s protocol\n&amp;quot;, c-&amp;gt;sfd,  
                    prot_text(c-&amp;gt;protocol));  
        }  
    }  
    //&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x79CD</span>;&amp;<span class="symbol">#x6A21</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4E8C</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5236</span>;&amp;<span class="symbol">#x6A21</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;ascii&amp;<span class="symbol">#x6A21</span>;&amp;<span class="symbol">#x5F0F</span>;  
    if (c-&amp;gt;protocol == binary_prot) {  
        //&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;  
    } else {  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x4E8C</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x5236</span>;&amp;<span class="symbol">#x6A21</span>;&amp;<span class="symbol">#x5F0F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;  
        char *el, *cont;  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;rbytes==<span class="number">0</span> &amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x793A</span>;buf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="number">0</span>  
        //<span class="number">0</span> &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8BA9</span>;&amp;<span class="symbol">#x7A0B</span>;&amp;<span class="symbol">#x5E8F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
        if (c-&amp;gt;rbytes == <span class="number">0</span>)  
            return <span class="number">0</span>;  
        //&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;\n&amp;<span class="symbol">#xFF0C</span>;memcache&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;\n&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;  
        //&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;\n&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;  
        //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>;set username <span class="number">10234344</span> \n get username \n  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x522B</span>;&amp;<span class="symbol">#x662F</span>;set&amp;<span class="symbol">#x548C</span>;get&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        //el&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;\n&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x5740</span>;  
        el = memchr(c-&amp;gt;rcurr, &amp;apos;\n&amp;apos;, c-&amp;gt;rbytes);  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;\n&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="number">0</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;  
        if (!el) {  
            //c-&amp;gt;rbytes&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5305</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x8DA3</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x63A5</span>;&amp;<span class="symbol">#x6536</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x62A5</span>;&amp;<span class="symbol">#x6587</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x4E86</span>;<span class="number">1</span>K&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x95EE</span>;&amp;<span class="symbol">#x9898</span>;&amp;<span class="symbol">#xFF1F</span>;  
            //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x94FE</span>;&amp;<span class="symbol">#x63A5</span>;  
            if (c-&amp;gt;rbytes &amp;gt; <span class="number">1024</span>) {  
                /* 
                 * <span class="class">We</span> didn&amp;apos;t have a &amp;apos;\n&amp;apos; in the first k. <span class="class">This</span> _has_ to be a 
                 * large multiget, if not we should just nuke the connection. 
                 */  
                char *ptr = c-&amp;gt;rcurr;  
                while (*ptr == &amp;apos; &amp;apos;) { /* ignore leading whitespaces */  
                    ++ptr;  
                }  
                if (ptr - c-&amp;gt;rcurr &amp;gt; <span class="number">100</span>  
                        || (strncmp(ptr, &amp;quot;get &amp;quot;, <span class="number">4</span>) &amp;amp;&amp;amp; strncmp(ptr, &amp;quot;gets &amp;quot;, <span class="number">5</span>))) {  
                    conn_set_state(c, conn_closing);  
                    return <span class="number">1</span>;  
                }  
            }  
            return <span class="number">0</span>;  
        }  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;\n&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6574</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x4E86</span>;  
        cont = el + <span class="number">1</span>; //&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x70B9</span>;  
        //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x662F</span>;\r\n,&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x662F</span>;\r\n&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;el&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4F4D</span>;  
        if ((el - c-&amp;gt;rcurr) &amp;gt; <span class="number">1</span> &amp;amp;&amp;amp; *(el - <span class="number">1</span>) == &amp;apos;\r&amp;apos;) {  
            el--;  
        }  
        //&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x7528</span>; \<span class="number">0</span>&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x4E32</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x675F</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x9694</span>;  
        *el = &amp;apos;\<span class="number">0</span>&amp;apos;;  
        assert(cont &amp;lt;= (c-&amp;gt;rcurr + c-&amp;gt;rbytes));  
        c-&amp;gt;last_cmd_time = current_time; //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x95F4</span>;  
        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF0C</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_command(c, c-&amp;gt;rcurr);  
        c-&amp;gt;rbytes -= (cont - c-&amp;gt;rcurr); //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x6837</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF1F</span>;c-&amp;gt;rbytes = c-&amp;gt;rcurr - cont  
        c-&amp;gt;rcurr = cont; //&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x70B9</span>;  
        assert(c-&amp;gt;rcurr &amp;lt;= (c-&amp;gt;rbuf + c-&amp;gt;rsize));  
    }  
    return <span class="number">1</span>;  
}
</code></pre><p>process_command</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x6765;&#x5904;&#x7406;&#x5177;&#x4F53;&#x7684;&#x547D;&#x4EE4;&#x3002;&#x5C06;&#x547D;&#x4EE4;&#x5206;&#x89E3;&#x540E;&#xFF0C;&#x5206;&#x53D1;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x4E2D;&#x53BB;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x51FD</span>;&amp;<span class="symbol">#x6570</span>;  
//&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x627E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;rbuf&amp;<span class="symbol">#x4E2D</span>;\n&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7136</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5176</span>;&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x6210</span>;\<span class="number">0</span>  
static void process_command(conn *c, char *command) {  

    //tokens&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;rcurr&amp;<span class="symbol">#xFF08</span>;command&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x901A</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x683C</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x9694</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    //&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#xFF1A</span>;set username zhuli,&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">3</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x522B</span>;&amp;<span class="symbol">#x662F</span>;set&amp;<span class="symbol">#x548C</span>;username&amp;<span class="symbol">#x548C</span>;zhuli  
    //<span class="class">MAX_TOKENS</span>&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">8</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;memcached&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x6210</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
    token_t tokens[<span class="class">MAX_TOKENS</span>];  
    size_t ntokens;  
    int comm;  

    assert(c != <span class="class">NULL</span>);  

    <span class="class">MEMCACHED_PROCESS_COMMAND_START</span>(c-&amp;gt;sfd, c-&amp;gt;rcurr, c-&amp;gt;rbytes);  

    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;lt;%d %s\n&amp;quot;, c-&amp;gt;sfd, command);  

    /* 
     * for commands set/add/replace, we build an item and read the data 
     * directly into it, then continue in nread_complete(). 
     */  

    c-&amp;gt;msgcurr = <span class="number">0</span>;  
    c-&amp;gt;msgused = <span class="number">0</span>;  
    c-&amp;gt;iovused = <span class="number">0</span>;  
    if (add_msghdr(c) != <span class="number">0</span>) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory preparing response&amp;quot;);  
        return;  
    }  

    //tokenize_command&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;  
    //&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x4E14</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;tokens&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x4E2D</span>;  
    //&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;:command&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    ntokens = tokenize_command(command, tokens, <span class="class">MAX_TOKENS</span>);  

    //tokens[<span class="class">COMMAND_TOKEN</span>] <span class="class">COMMAND_TOKEN</span>=<span class="number">0</span>  
    //&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7B2C</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    if (ntokens &amp;gt;= <span class="number">3</span>  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;get&amp;quot;) == <span class="number">0</span>)  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;bget&amp;quot;) == <span class="number">0</span>))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;get&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_get_command(c, tokens, ntokens, <span class="keyword">false</span>);  

    } else if ((ntokens == <span class="number">6</span> || ntokens == <span class="number">7</span>)  
            &amp;amp;&amp;amp; ((strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;add&amp;quot;) == <span class="number">0</span> &amp;amp;&amp;amp; (comm =  
                    <span class="class">NREAD_ADD</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;set&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_SET</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;replace&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_REPLACE</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;prepend&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_PREPEND</span>))  
                    || (strcmp(tokens[<span class="class">COMMAND_TOKEN</span>].value, &amp;quot;append&amp;quot;) == <span class="number">0</span>  
                            &amp;amp;&amp;amp; (comm = <span class="class">NREAD_APPEND</span>)))) {  

        //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        process_update_command(c, tokens, ntokens, comm, <span class="keyword">false</span>);  
//&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;....  
}
</code></pre><p>tokenize_command&#xFF1A;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5206;&#x89E3;&#x547D;&#x4EE4;&#x3002;&#x5177;&#x4F53;&#x662F;&#x5C06;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x8BED;&#x53E5;&#x5206;&#x89E3;&#x6210;&#x591A;&#x4E2A;&#x5143;&#x7D20;&#x3002;</p>
<p>&#x4F8B;&#x5982;:set username zhuli\n</p>
<p>&#x5219;&#x4F1A;&#x5206;&#x89E3;&#x6210;&#x4E09;&#x4E2A;&#x5143;&#x7D20;&#xFF1A;set&#x548C;username&#x548C;zhuli&#x8FD9;&#x4E09;&#x4E2A;&#x5143;&#x7D20;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
static size_t tokenize_command(char *command, token_t *tokens,  
        const size_t max_tokens) {  
    char *s, *e;  
    size_t ntokens = <span class="number">0</span>; //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6E38</span>;&amp;<span class="symbol">#x6807</span>;  
    size_t len = strlen(command); //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
    unsigned int i = <span class="number">0</span>;  
    assert(command != <span class="class">NULL</span> &amp;amp;&amp;amp; tokens != <span class="class">NULL</span> &amp;amp;&amp;amp; max_tokens &amp;gt; <span class="number">1</span>);  
    s = e = command;  
    for (i = <span class="number">0</span>; i &amp;lt; len; i++) {  
        //&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x505C</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x8D70</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x9047</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x683C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x505C</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#x62C6</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x8FDB</span>;tokens&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>;&amp;<span class="symbol">#x4E2D</span>;  
        if (*e == &amp;apos; &amp;apos;) {  
            if (s != e) {  
                tokens[ntokens].value = s;  
                tokens[ntokens].length = e - s;  
                ntokens++;  
                //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x683C</span>;&amp;<span class="symbol">#x66FF</span>;&amp;<span class="symbol">#x6362</span>;&amp;<span class="symbol">#x6210</span>;\<span class="number">0</span>  
                //<span class="class">Memcached</span>&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x597D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5E76</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x62F7</span>;&amp;<span class="symbol">#x8D1D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x800C</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x539F</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x4E0A</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x5272</span>;  
                *e = &amp;apos;\<span class="number">0</span>&amp;apos;;  
                //&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;<span class="number">8</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
                if (ntokens == max_tokens - <span class="number">1</span>) {  
                    e++;  
                    s = e; /* so we don&amp;apos;t add an extra token */  
                    break;  
                }  
            }  
            s = e + <span class="number">1</span>;  
        }  
        e++;  
    }  
    if (s != e) {  
        tokens[ntokens].value = s;  
        tokens[ntokens].length = e - s;  
        ntokens++;  
    }  
    /* 
     * <span class="class">If</span> we scanned the whole string, the terminal value pointer is null, 
     * otherwise it is the first unprocessed character. 
     */  
    tokens[ntokens].value = *e == &amp;apos;\<span class="number">0</span>&amp;apos; ? <span class="class">NULL</span> : e;  
    tokens[ntokens].length = <span class="number">0</span>;  
    ntokens++;  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4F8B</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x51FA</span>;<span class="number">3</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="number">3</span>  
    return ntokens;  
}
</code></pre><p>process_get_command</p>
<p>get&#x7684;&#x547D;&#x4EE4;&#x4F8B;&#x5B50;&#x3002;get&#x8BF7;&#x6C42;&#x62FF;&#x5230;Memcached Item&#x4E2D;&#x7684;&#x6570;&#x636E;&#x540E;&#xFF0C;&#x53C8;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;conn_mwrite&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x5C06;&#x8FDB;&#x5165;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x5199;&#x6570;&#x636E;&#x7684;&#x72B6;&#x6001;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
static inline void process_get_command(conn *c, token_t *tokens, size_t ntokens,  
        bool return_cas) {  
    //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    char *key;  
    size_t nkey;  
    int i = <span class="number">0</span>;  
    item *it;  
    //&amp;amp;tokens[<span class="number">0</span>] &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    //&amp;amp;tokens[<span class="number">1</span>] &amp;<span class="symbol">#x4E3A</span>;key  
    //token_t &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E86</span>;value&amp;<span class="symbol">#x548C</span>;length  
    token_t *key_token = &amp;amp;tokens[<span class="class">KEY_TOKEN</span>];  
    char *suffix;  
    assert(c != <span class="class">NULL</span>);  
    do {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
        while (key_token-&amp;gt;length != <span class="number">0</span>) {  
            key = key_token-&amp;gt;value;  
            nkey = key_token-&amp;gt;length;  
            //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;memcache key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">250</span>  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;  
            if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
                //out_string &amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
                out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
                while (i-- &amp;gt; <span class="number">0</span>) {  
                    item_remove(*(c-&amp;gt;ilist + i));  
                }  
                return;  
            }  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5FEB</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            it = item_get(key, nkey);  
            if (settings.detail_enabled) {  
                //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
                stats_prefix_record_get(key, nkey, <span class="class">NULL</span> != it);  
            }  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            if (it) {  
                //c-&amp;gt;ilist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;buf  
                //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;ilist&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
                if (i &amp;gt;= c-&amp;gt;isize) {  
                    item **new_list = realloc(c-&amp;gt;ilist,  
                            sizeof(item *) * c-&amp;gt;isize * <span class="number">2</span>);  
                    if (new_list) {  
                        c-&amp;gt;isize *= <span class="number">2</span>;  
                        c-&amp;gt;ilist = new_list;  
                    } else {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        item_remove(it);  
                        break;  
                    }  
                }  
                /* 
                 * <span class="class">Construct</span> the response. <span class="class">Each</span> hit adds three elements to the 
                 * outgoing data <span class="method">list:</span> 
                 *   &amp;quot;<span class="class">VALUE</span> &amp;quot; 
                 *   key 
                 *   &amp;quot; &amp;quot; + flags + &amp;quot; &amp;quot; + data length + &amp;quot;\r\n&amp;quot; + data (with \r\n) 
                 */  
                //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
                if (return_cas) {  
                    <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                            it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                    /* <span class="class">Goofy</span> mid-flight realloc. */  
                    if (i &amp;gt;= c-&amp;gt;suffixsize) {  
                        char **new_suffix_list = realloc(c-&amp;gt;suffixlist,  
                                sizeof(char *) * c-&amp;gt;suffixsize * <span class="number">2</span>);  
                        if (new_suffix_list) {  
                            c-&amp;gt;suffixsize *= <span class="number">2</span>;  
                            c-&amp;gt;suffixlist = new_suffix_list;  
                        } else {  
                            <span class="class">STATS_LOCK</span>();  
                            stats.malloc_fails++;  
                            <span class="class">STATS_UNLOCK</span>();  
                            item_remove(it);  
                            break;  
                        }  
                    }  
                    suffix = cache_alloc(c-&amp;gt;thread-&amp;gt;suffix_cache);  
                    if (suffix == <span class="class">NULL</span>) {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        out_of_memory(c,  
                                &amp;quot;<span class="class">SERVER_ERROR</span> out of memory making <span class="class">CAS</span> suffix&amp;quot;);  
                        item_remove(it);  
                        while (i-- &amp;gt; <span class="number">0</span>) {  
                            item_remove(*(c-&amp;gt;ilist + i));  
                        }  
                        return;  
                    }  
                    *(c-&amp;gt;suffixlist + i) = suffix;  
                    int suffix_len = snprintf(suffix, <span class="class">SUFFIX_SIZE</span>, &amp;quot; %llu\r\n&amp;quot;,  
                            (unsigned long long) <span class="class">ITEM_get_cas</span>(it));  
                    if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                            || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                            || add_iov(c, <span class="class">ITEM_suffix</span>(it), it-&amp;gt;nsuffix - <span class="number">2</span>) != <span class="number">0</span>  
                            || add_iov(c, suffix, suffix_len) != <span class="number">0</span>  
                            || add_iov(c, <span class="class">ITEM_data</span>(it), it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                        item_remove(it);  
                        break;  
                    }  
                } else {  
                    <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                            it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                    if (add_iov(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                            || add_iov(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                            || add_iov(c, <span class="class">ITEM_suffix</span>(it),  
                                    it-&amp;gt;nsuffix + it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                        item_remove(it);  
                        break;  
                    }  
                }  
                if (settings.verbose &amp;gt; <span class="number">1</span>) {  
                    int ii;  
                    fprintf(stderr, &amp;quot;&amp;gt;%d sending key &amp;quot;, c-&amp;gt;sfd);  
                    for (ii = <span class="number">0</span>; ii &amp;lt; it-&amp;gt;nkey; ++ii) {  
                        fprintf(stderr, &amp;quot;%c&amp;quot;, key[ii]);  
                    }  
                    fprintf(stderr, &amp;quot;\n&amp;quot;);  
                }  
                /* item_get() has incremented it-&amp;gt;refcount for us */  
                pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].get_hits++;  
                c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
                pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                item_update(it);  
                *(c-&amp;gt;ilist + i) = it;  
                i++;  
            } else {  
                pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                c-&amp;gt;thread-&amp;gt;stats.get_misses++;  
                c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
                pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, key, nkey, -<span class="number">1</span>, <span class="number">0</span>);  
            }  
            key_token++;  
        }  
        /* 
         * <span class="class">If</span> the command string hasn&amp;apos;t been fully processed, get the next set 
         * of tokens. 
         */  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;get&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
        if (key_token-&amp;gt;value != <span class="class">NULL</span>) {  
            ntokens = tokenize_command(key_token-&amp;gt;value, tokens, <span class="class">MAX_TOKENS</span>);  
            key_token = tokens;  
        }  
    } while (key_token-&amp;gt;value != <span class="class">NULL</span>);  
    c-&amp;gt;icurr = c-&amp;gt;ilist;  
    c-&amp;gt;ileft = i;  
    if (return_cas) {  
        c-&amp;gt;suffixcurr = c-&amp;gt;suffixlist;  
        c-&amp;gt;suffixleft = i;  
    }  
    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;gt;%d <span class="class">END</span>\n&amp;quot;, c-&amp;gt;sfd);  
    /* 
     <span class="class">If</span> the loop was terminated because of out-of-memory, it is not 
     reliable to add <span class="class">END</span>\r\n to the buffer, because it might not end 
     in \r\n. <span class="class">So</span> we send <span class="class">SERVER_ERROR</span> instead. 
     */  
    if (key_token-&amp;gt;value != <span class="class">NULL</span> || add_iov(c, &amp;quot;<span class="class">END</span>\r\n&amp;quot;, <span class="number">5</span>) != <span class="number">0</span>  
            || (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>)) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory writing get response&amp;quot;);  
    } else {  
        //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x3002</span>;  
        conn_set_state(c, conn_mwrite);  
        c-&amp;gt;msgcurr = <span class="number">0</span>;  
    }  
}
</code></pre><p>conn_mwrite&#x548C;transmit</p>
<p>&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x5199;&#x6570;&#x636E;&#x3002;&#x5199;&#x5B8C;&#x6570;&#x636E;&#x540E;&#xFF0C;&#x5982;&#x679C;&#x5199;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF1B;&#x5982;&#x679C;&#x5199;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;&#x72B6;&#x6001;&#x4FEE;&#x6539;&#x6210;conn_new_cmd&#xFF0C;&#x7EE7;&#x7EED;&#x89E3;&#x6790;c-&gt;rbuf&#x4E2D;&#x5269;&#x4F59;&#x7684;&#x547D;&#x4EE4;</p>
<pre><code>//drive_machine&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;conn_mwrite&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
case <span class="method">conn_mwrite:</span>  
    if (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; c-&amp;gt;msgcurr == <span class="number">0</span>  
            &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Failed</span> to build <span class="class">UDP</span> headers\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    //transmit&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;transmit_result&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
    switch (transmit(c)) {  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;  
    case <span class="class">TRANSMIT_COMPLETE</span>:  
        if (c-&amp;gt;state == conn_mwrite) {  
            conn_release_items(c);  
            /* <span class="class">XXX</span>:  <span class="class">I</span> don&amp;apos;t know why this wasn&amp;apos;t the general case */  
            if (c-&amp;gt;protocol == binary_prot) {  
                conn_set_state(c, c-&amp;gt;write_and_go);  
            } else {  
                //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
                //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x5230</span>;conn_new_cmd&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
                //conn_new_cmd&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;  
                conn_set_state(c, conn_new_cmd);  
            }  
        } else if (c-&amp;gt;state == conn_write) {  
            if (c-&amp;gt;write_and_free) {  
                free(c-&amp;gt;write_and_free);  
                c-&amp;gt;write_and_free = <span class="number">0</span>;  
            }  
            conn_set_state(c, c-&amp;gt;write_and_go);  
        } else {  
            if (settings.verbose &amp;gt; <span class="number">0</span>)  
                fprintf(stderr, &amp;quot;<span class="class">Unexpected</span> state %d\n&amp;quot;, c-&amp;gt;state);  
            conn_set_state(c, conn_closing);  
        }  
        break;  
    case <span class="class">TRANSMIT_INCOMPLETE</span>:  
    case <span class="class">TRANSMIT_HARD_ERROR</span>:  
        break; /* <span class="class">Continue</span> in state machine. */  
    //&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
    case <span class="class">TRANSMIT_SOFT_ERROR</span>:  
        stop = <span class="keyword">true</span>;  
        break;  
    }  
    break;
</code></pre><p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x662F;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6570;&#x636E;&#x3002;</p>
<pre><code><span class="xml">//&amp;#x8FD9;&amp;#x4E2A;&amp;#x65B9;&amp;#x6CD5;&amp;#x4E3B;&amp;#x8981;&amp;#x5411;&amp;#x5BA2;&amp;#x6237;&amp;#x7AEF;&amp;#x5199;&amp;#x6570;&amp;#x636E;  
static enum transmit_result transmit(conn *c) </span><span class="expression">{  
    <span class="variable">assert</span>(<span class="variable">c</span> != <span class="variable">NULL</span>);  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgcurr</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgused</span> &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span>[<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgcurr</span>]<span class="variable">.msg</span>_<span class="variable">iovlen</span> == 0) {  
        /* <span class="variable">Finished</span> <span class="variable">writing</span> <span class="variable">the</span> <span class="variable">current</span> <span class="variable">msg</span>; <span class="variable">advance</span> <span class="variable">to</span> <span class="variable">the</span> <span class="variable">next.</span> *<span class="end-block">/  </span>
        <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgcurr</span>++;  
    }</span><span class="xml">  
    if (c-&amp;gt;msgcurr &amp;lt; c-&amp;gt;msgused) </span><span class="expression">{  
        <span class="variable">ssize</span>_<span class="variable">t</span> <span class="variable">res</span>;  
        /<span class="end-block">/msghdr </span>&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
        <span class="variable">struct</span> <span class="variable">msghdr</span> *<span class="variable">m</span> = &amp;<span class="variable">amp</span>;<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span>[<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgcurr</span>];  
        /<span class="end-block">/sendmsg </span>&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>9;&amp;<span class="begin-block">#x</span>6<span class="variable">CD</span>5;  
        <span class="variable">res</span> = <span class="variable">sendmsg</span>(<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">sfd</span>, <span class="variable">m</span>, 0);  
        //&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>6210;&amp;<span class="begin-block">#x</span>529<span class="variable">F</span>;  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">res</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0) {  
            <span class="variable">pthread</span>_<span class="variable">mutex</span>_<span class="variable">lock</span>(&amp;<span class="variable">amp</span>;<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">stats.mutex</span>);  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">stats.bytes</span>_<span class="variable">written</span> += <span class="variable">res</span>;  
            <span class="variable">pthread</span>_<span class="variable">mutex</span>_<span class="variable">unlock</span>(&amp;<span class="variable">amp</span>;<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">thread-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">stats.mutex</span>);  
            /* <span class="variable">We</span>&amp;<span class="variable">apos</span>;<span class="variable">ve</span> <span class="variable">written</span> <span class="variable">some</span> <span class="variable">of</span> <span class="variable">the</span> <span class="variable">data.</span> <span class="variable">Remove</span> <span class="variable">the</span> <span class="variable">completed</span> 
             <span class="variable">iovec</span> <span class="variable">entries</span> <span class="variable">from</span> <span class="variable">the</span> <span class="variable">list</span> <span class="variable">of</span> <span class="variable">pending</span> <span class="variable">writes.</span> *<span class="end-block">/  </span>
            <span class="variable">while</span> (<span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iovlen</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0 &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">res</span> &amp;<span class="variable"><span class="keyword">gt</span></span>;= <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iov-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>_<span class="variable">len</span>) {  
                <span class="variable">res</span> <span class="variable">-</span>= <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iov-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>_<span class="variable">len</span>;  
                <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iovlen--</span>;  
                <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iov</span>++;  
            }</span><span class="xml">  
            /* Might have written just part of the last iovec entry; 
             adjust it so the next write will do the rest. */  
            if (res &amp;gt; 0) </span><span class="expression">{  
                <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iov-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>_<span class="variable">base</span> = (<span class="variable">caddr</span>_<span class="variable">t</span>) <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iov-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>_<span class="variable">base</span> + <span class="variable">res</span>;  
                <span class="variable">m-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msg</span>_<span class="variable">iov-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>_<span class="variable">len</span> <span class="variable">-</span>= <span class="variable">res</span>;  
            }</span><span class="xml">  
            return TRANSMIT_INCOMPLETE;  
        }  
        if (res == -1 &amp;amp;&amp;amp; (errno == EAGAIN || errno == EWOULDBLOCK)) </span><span class="expression">{  
            <span class="variable"><span class="keyword">if</span></span> (!<span class="variable">update</span>_<span class="variable">event</span>(<span class="variable">c</span>, <span class="variable">EV</span>_<span class="variable">WRITE</span> | <span class="variable">EV</span>_<span class="variable">PERSIST</span>)) {  
                <span class="variable"><span class="keyword">if</span></span> (<span class="variable">settings.verbose</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; 0)  
                    <span class="variable">fprintf</span>(<span class="variable">stderr</span>, &amp;<span class="variable">quot</span>;<span class="variable">Couldn</span>&amp;<span class="variable">apos</span>;<span class="variable">t</span> <span class="variable">update</span> <span class="variable">event</span>\<span class="variable">n</span>&amp;<span class="variable">quot</span>;);  
                <span class="variable">conn</span>_<span class="variable">set</span>_<span class="variable">state</span>(<span class="variable">c</span>, <span class="variable">conn</span>_<span class="variable">closing</span>);  
                <span class="variable">return</span> <span class="variable">TRANSMIT</span>_<span class="variable">HARD</span>_<span class="variable">ERROR</span>;  
            }</span><span class="xml">  
            return TRANSMIT_SOFT_ERROR;  
        }  
        /* if res == 0 or res == -1 and error is not EAGAIN or EWOULDBLOCK, 
         we have a real error, on which we close the connection */  
        if (settings.verbose &amp;gt; 0)  
            perror(&amp;quot;Failed to write, and not due to blocking&amp;quot;);  
        if (IS_UDP(c-&amp;gt;transport))  
            conn_set_state(c, conn_read);  
        else  
            conn_set_state(c, conn_closing);  
        return TRANSMIT_HARD_ERROR;  
    } else </span><span class="expression">{  
        <span class="variable">return</span> <span class="variable">TRANSMIT</span>_<span class="variable">COMPLETE</span>;  
    }</span><span class="xml">  
}</span>
</code></pre><p>conn_new_cmd&#x548C;reset_cmd_handler</p>
<p>&#x7EE7;&#x7EED;&#x89E3;&#x6790;c-&gt;rbuf&#x4E2D;&#x5269;&#x4F59;&#x7684;&#x547D;&#x4EE4;&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
case <span class="method">conn_new_cmd:</span>  
    /* <span class="class">Only</span> process nreqs at a time to avoid starving other 
     connections */  
    --nreqs;  
    if (nreqs &amp;gt;= <span class="number">0</span>) {  
        reset_cmd_handler(c); //&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;reset_cmd_handler&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    } else {  
        pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        c-&amp;gt;thread-&amp;gt;stats.conn_yields++;  
        pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
        if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
            /* <span class="class">We</span> have already read in data into the input buffer, 
             so libevent will most likely not signal read events 
             on the socket (unless more data is available. <span class="class">As</span> a 
             hack we should just put in a request to write data, 
             because that should be possible ;-) 
             */  
            if (!update_event(c, <span class="class">EV_WRITE</span> | <span class="class">EV_PERSIST</span>)) {  
                if (settings.verbose &amp;gt; <span class="number">0</span>)  
                    fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
                conn_set_state(c, conn_closing);  
                break;  
            }  
        }  
        stop = <span class="keyword">true</span>;  
    }  
    break;


//&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;handler  
static void reset_cmd_handler(conn *c) {  
    c-&amp;gt;cmd = -<span class="number">1</span>;  
    c-&amp;gt;substate = bin_no_state;  
    if (c-&amp;gt;item != <span class="class">NULL</span>) {  
        item_remove(c-&amp;gt;item);  
        c-&amp;gt;item = <span class="class">NULL</span>;  
    }  
    conn_shrink(c); //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; &amp;gt; <span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_parse_cmd&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
        conn_set_state(c, conn_parse_cmd);  
    } else {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6765</span>;  
        conn_set_state(c, conn_waiting);  
    }  
}
</code></pre><p>conn_shrink</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x68C0;&#x67E5;&#x547D;&#x4EE4;&#x884C;&#x5BB9;&#x5668;&#x7684;&#x5927;&#x5C0F;&#x3002;</p>
<pre><code><span class="xml">//&amp;#x68C0;&amp;#x67E5;rbuf&amp;#x7684;&amp;#x5927;&amp;#x5C0F;  
static void conn_shrink(conn *c) </span><span class="expression">{  
    <span class="variable">assert</span>(<span class="variable">c</span> != <span class="variable">NULL</span>);  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">IS</span>_<span class="variable">UDP</span>(<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">transport</span>))  
        <span class="variable">return</span>;  
    //&amp;<span class="begin-block">#x</span>5982;&amp;<span class="begin-block">#x</span>679<span class="variable">C</span>;<span class="variable">bufsize</span>&amp;<span class="begin-block">#x</span>5927;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;<span class="variable">READ</span>_<span class="variable">BUFFER</span>_<span class="variable">HIGHWAT</span>&amp;<span class="begin-block">#xFF</span>08;8192&amp;<span class="begin-block">#xFF</span>09;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>9700;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>91<span class="variable">CD</span>;&amp;<span class="begin-block">#x</span>65<span class="variable">B</span>0;&amp;<span class="begin-block">#x</span>5904;&amp;<span class="begin-block">#x</span>7406;  
    /<span class="end-block">/DATA</span>_<span class="variable">BUFFER</span>_<span class="variable">SIZE</span>&amp;<span class="begin-block">#x</span>7<span class="variable">B</span>49;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>8<span class="variable">E</span>;2048&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6240;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>6211;&amp;<span class="begin-block">#x</span>4<span class="variable">EEC</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>5;&amp;<span class="begin-block">#x</span>770<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>5230;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>4<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>524<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>4<span class="variable">EE</span>3;&amp;<span class="begin-block">#x</span>7801;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">BF</span>9;<span class="variable">rbuf</span>&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>591<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>80<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>8<span class="variable">FDB</span>;&amp;<span class="begin-block">#x</span>884<span class="variable">C</span>;4&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;<span class="variable">recalloc</span>  
    <span class="variable"><span class="keyword">if</span></span> (<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rsize</span> &amp;<span class="variable"><span class="keyword">gt</span></span>; <span class="variable">READ</span>_<span class="variable">BUFFER</span>_<span class="variable">HIGHWAT</span> &amp;<span class="variable">amp</span>;&amp;<span class="variable">amp</span>; <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbytes</span> &amp;<span class="variable"><span class="keyword">lt</span></span>; <span class="variable">DATA</span>_<span class="variable">BUFFER</span>_<span class="variable">SIZE</span>) {  
        <span class="variable">char</span> *<span class="variable">newbuf</span>;  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rcurr</span> != <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span>)  
            <span class="variable">memmove</span>(<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span>, <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rcurr</span>, (<span class="variable">size</span>_<span class="variable">t</span>) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbytes</span>); //&amp;<span class="begin-block">#x</span>5185;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>79<span class="variable">FB</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>8;  
        <span class="variable">newbuf</span> = (<span class="variable">char</span> *) <span class="variable">realloc</span>((<span class="variable">void</span> *) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span>, <span class="variable">DATA</span>_<span class="variable">BUFFER</span>_<span class="variable">SIZE</span>);  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">newbuf</span>) {  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span> = <span class="variable">newbuf</span>;  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rsize</span> = <span class="variable">DATA</span>_<span class="variable">BUFFER</span>_<span class="variable">SIZE</span>;  
        }</span><span class="xml">  
        /* TODO check other branch... */  
        c-&amp;gt;rcurr = c-&amp;gt;rbuf;  
    }  
    if (c-&amp;gt;isize &amp;gt; ITEM_LIST_HIGHWAT) </span><span class="expression">{  
        <span class="variable">item</span> **<span class="variable">newbuf</span> = (<span class="variable">item</span>**) <span class="variable">realloc</span>((<span class="variable">void</span> *) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span>,  
                <span class="variable">ITEM</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span> * <span class="variable">sizeof</span>(<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span>[0]));  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">newbuf</span>) {  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span> = <span class="variable">newbuf</span>;  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">isize</span> = <span class="variable">ITEM</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
        }</span><span class="xml">  
        /* TODO check error condition? */  
    }  
    if (c-&amp;gt;msgsize &amp;gt; MSG_LIST_HIGHWAT) </span><span class="expression">{  
        <span class="variable">struct</span> <span class="variable">msghdr</span> *<span class="variable">newbuf</span> = (<span class="variable">struct</span> <span class="variable">msghdr</span> *) <span class="variable">realloc</span>((<span class="variable">void</span> *) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span>,  
                <span class="variable">MSG</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span> * <span class="variable">sizeof</span>(<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span>[0]));  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">newbuf</span>) {  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span> = <span class="variable">newbuf</span>;  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgsize</span> = <span class="variable">MSG</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
        }</span><span class="xml">  
        /* TODO check error condition? */  
    }  
    if (c-&amp;gt;iovsize &amp;gt; IOV_LIST_HIGHWAT) </span><span class="expression">{  
        <span class="variable">struct</span> <span class="variable">iovec</span> *<span class="variable">newbuf</span> = (<span class="variable">struct</span> <span class="variable">iovec</span> *) <span class="variable">realloc</span>((<span class="variable">void</span> *) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>,  
                <span class="variable">IOV</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span> * <span class="variable">sizeof</span>(<span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span>[0]));  
        <span class="variable"><span class="keyword">if</span></span> (<span class="variable">newbuf</span>) {  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span> = <span class="variable">newbuf</span>;  
            <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iovsize</span> = <span class="variable">IOV</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
        }</span><span class="xml">  
        /* TODO check return value */  
    }  
}</span>
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/2730248/" title="redis和memcached比较 -" itemprop="url">redis和memcached比较 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>1&#x3001;CPU&#x6838;&#x5FC3;&#xFF1A;</p>
<p>&#x7531;&#x4E8E;Redis&#x53EA;&#x4F7F;&#x7528;&#x5355;&#x6838;&#xFF0C;&#x800C;Memcached&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF0C;&#x6240;&#x4EE5;&#x5E73;&#x5747;&#x6BCF;&#x4E00;&#x4E2A;&#x6838;&#x4E0A;Redis&#x5728;&#x5B58;&#x50A8;&#x5C0F;&#x6570;&#x636E;&#x65F6;&#x6BD4;Memcached&#x6027;&#x80FD;&#x66F4;&#x9AD8;&#x3002;&#x800C;&#x5728;100k&#x4EE5;&#x4E0A;&#x7684;&#x6570;&#x636E;&#x4E2D;&#xFF0C;Memcached&#x6027;&#x80FD;&#x8981;&#x9AD8;&#x4E8E;Redis&#xFF0C;&#x867D;&#x7136;Redis&#x6700;&#x8FD1;&#x4E5F;&#x5728;&#x5B58;&#x50A8;&#x5927;&#x6570;&#x636E;&#x7684;&#x6027;&#x80FD;&#x4E0A;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x6BD4;&#x8D77; Memcached&#xFF0C;&#x8FD8;&#x662F;&#x7A0D;&#x6709;&#x900A;&#x8272;&#x3002;</p>
<p>&#x56E0;&#x4E3A; Redis &#x7684;&#x64CD;&#x4F5C;&#x90FD;&#x975E;&#x5E38;&#x5FEB;&#x901F;&#x2014;&#x2014;&#x5B83;&#x7684;&#x6570;&#x636E;&#x5168;&#x90E8;&#x5728;&#x5185;&#x5B58;&#x91CC;&#xFF0C;&#x5B8C;&#x5168;&#x4E0D;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x78C1;&#x76D8;&#x3002;&#x81F3;&#x4E8E;&#x5E76;&#x53D1;&#xFF0C;Redis &#x4F7F;&#x7528;&#x591A;&#x8DEF; I/O &#x590D;&#x7528;&#x6280;&#x672F;&#xFF0C;&#x672C;&#x8EAB;&#x7684;&#x5E76;&#x53D1;&#x6548;&#x7387;&#x4E0D;&#x6210;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x5355;&#x4E2A; Redis &#x8FDB;&#x7A0B;&#x6CA1;&#x529E;&#x6CD5;&#x4F7F;&#x7528;&#x591A;&#x6838;&#xFF08;&#x4EFB;&#x4E00;&#x65F6;&#x523B;&#x53EA;&#x80FD;&#x8DD1;&#x5728;&#x4E00;&#x4E2A; CPU &#x6838;&#x5FC3;&#x4E0A;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x672C;&#x6765;&#x5C31;&#x4E0D;&#x662F;&#x975E;&#x5E38;&#x8BA1;&#x7B97;&#x5BC6;&#x96C6;&#x578B;&#x7684;&#x670D;&#x52A1;&#x3002;&#x5982;&#x679C;&#x5355;&#x6838;&#x6027;&#x80FD;&#x4E0D;&#x591F;&#x7528;&#xFF0C;&#x53EF;&#x4EE5;&#x591A;&#x5F00;&#x51E0;&#x4E2A;&#x8FDB;&#x7A0B;&#x3002;</p>
<p>Redis &#x5355;&#x7EBF;&#x7A0B;-&#x591A;&#x8DEF;&#x590D;&#x7528;io&#x6A21;&#x578B; </p>
<p>2&#x3001;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x6548;&#x7387;&#x5BF9;&#x6BD4;&#xFF1A;</p>
<p>&#x4F7F;&#x7528;&#x7B80;&#x5355;&#x7684;key-value&#x5B58;&#x50A8;&#x7684;&#x8BDD;&#xFF0C;Memcached&#x7684;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x66F4;&#x9AD8;&#xFF0C;&#x800C;&#x5982;&#x679C;Redis&#x91C7;&#x7528;hash&#x7ED3;&#x6784;&#x6765;&#x505A;key-value&#x5B58;&#x50A8;&#xFF0C;&#x7531;&#x4E8E;&#x5176;&#x7EC4;&#x5408;&#x5F0F;&#x7684;&#x538B;&#x7F29;&#xFF0C;&#x5176;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x4F1A;&#x9AD8;&#x4E8E;Memcached&#x3002;</p>
<p>3&#x3001;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF1A;</p>
<p>Redis&#x76F8;&#x6BD4;Memcached&#x6765;&#x8BF4;&#xFF0C;&#x62E5;&#x6709;&#x66F4;&#x591A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;&#x5E76;&#x652F;&#x6301;&#x66F4;&#x4E30;&#x5BCC;&#x7684;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#xFF0C;&#x901A;&#x5E38;&#x5728;Memcached &#x91CC;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5C06;&#x6570;&#x636E;&#x62FF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8FDB;&#x884C;&#x7C7B;&#x4F3C;&#x7684;&#x4FEE;&#x6539;&#x518D;set&#x56DE;&#x53BB;&#x3002;&#x8FD9;&#x5927;&#x5927;&#x589E;&#x52A0;&#x4E86;&#x7F51;&#x7EDC;IO&#x7684;&#x6B21;&#x6570;&#x548C;&#x6570;&#x636E;&#x4F53;&#x79EF;&#x3002;&#x5728;Redis&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x590D;&#x6742;&#x7684;&#x64CD;&#x4F5C;&#xFFFD;&#xFFFD;&#xFFFD;&#x5E38;&#x548C;&#x4E00;&#x822C;&#x7684; GET/SET&#x4E00;&#x6837;&#x9AD8;&#x6548;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x7F13;&#x5B58;&#x80FD;&#x591F;&#x652F;&#x6301;&#x66F4;&#x590D;&#x6742;&#x7684;&#x7ED3;&#x6784;&#x548C;&#x64CD;&#x4F5C;&#xFF0C;&#x90A3;&#x4E48;Redis&#x4F1A;&#x662F;&#x4E0D;&#x9519;&#x7684;&#x9009;&#x62E9;&#x3002;</p>
<p>4&#x3001;</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Memcached/">Memcached</a><a href="/tags/Redis/">Redis</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/03/274a8a5/" title="Linux c 开发 - Memcached源码分析之消息回应（3） -" itemprop="url">Linux c 开发 - Memcached源码分析之消息回应（3） -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-03T02:09:43.000Z" itemprop="datePublished"> 发表于 2015-07-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> &#x524D;&#x8A00; </p>
<p>&#x4E0A;&#x4E00;&#x7AE0;&#x300A;Linux c &#x5F00;&#x53D1; - Memcached&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x547D;&#x4EE4;&#x89E3;&#x6790;&#xFF08;2&#xFF09;&#x300B;&#xFF0C;&#x6211;&#x4EEC;&#x82B1;&#x4E86;&#x5F88;&#x5927;&#x7684;&#x529B;&#x6C14;&#x53BB;&#x8BB2;&#x89E3;Memcached&#x5982;&#x4F55;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x8BFB;&#x53D6;&#x547D;&#x4EE4;&#xFF0C;&#x5E76;&#x4E14;&#x89E3;&#x6790;&#x547D;&#x4EE4;&#xFF0C;&#x7136;&#x540E;&#x5904;&#x7406;&#x547D;&#x4EE4;&#x5E76;&#x4E14;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x56DE;&#x5E94;&#x6D88;&#x606F;&#x3002;</p>
<p>&#x8FD9;&#x4E00;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x6765;&#x8BB2;&#x89E3;Memcached&#x56DE;&#x5E94;&#x6D88;&#x606F;&#x7684;&#x6280;&#x672F;&#x7EC6;&#x8282;&#x3002;</p>
<p>&#x672C;&#x7AE0;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x51E0;&#x4E2A;&#x77E5;&#x8BC6;&#x70B9;(msghdr&#x548C;iovc)&#x3002;</p>
<p>msghdr&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code><span class="keyword">struct</span> msghdr {  
    <span class="keyword">void</span> *msg_name;  
    <span class="keyword">socklen_t</span> msg_namelen;  
    <span class="keyword">struct</span> iovec *msg_iov;  
    <span class="keyword">size_t</span> msg_iovlen;  
    <span class="keyword">void</span> *msg_control;  
    <span class="keyword">size_t</span> msg_controllen;  
    <span class="keyword">int</span> msg_flags;  
};
</code></pre><p>iovc&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code><span class="preprocessor">#include &amp;lt;sys/uio.h&amp;gt;  </span>
<span class="comment">/* Structure for scatter/gather I/O. */</span>  
<span class="keyword">struct</span> iovec {  
    <span class="keyword">void</span> *iov_base; <span class="comment">/* Pointer to data. */</span>  
    <span class="keyword">size_t</span> iov_len; <span class="comment">/* Length of data. */</span>  
};
</code></pre><p>Memcached&#x662F;&#x901A;&#x8FC7;sendmsg&#x51FD;&#x6570;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6570;&#x636E;&#x7684;&#xFF0C;&#x5C31;&#x4F1A;&#x7528;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x4E0D;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x7684;&#xFF0C;&#x5EFA;&#x8BAE;&#x5148;&#x4E86;&#x89E3;&#x4E4B;&#x540E;&#x518D;&#x7EE7;&#x7EED;&#x5F80;&#x4E0B;&#x770B;&#x3002;</p>
<p>Memcached&#x6D88;&#x606F;&#x56DE;&#x5E94;&#x6E90;&#x7801;&#x5206;&#x6790; </p>
<p>&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x770B;&#x4E00;&#x4E0B;conn&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x3002;conn&#x7ED3;&#x6784;&#x6211;&#x4EEC;&#x4E0A;&#x4E00;&#x671F;&#x8BF4;&#x8FC7;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x5B58;&#x50A8;&#x5355;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x8BE6;&#x60C5;&#xFFFD;&#xFFFD;&#xFFFD;&#x606F;&#x3002;&#x6BCF;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x5230;Memcached&#x90FD;&#x4F1A;&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code><span class="xml">typedef struct conn conn;  
struct conn </span><span class="expression">{  
    /<span class="end-block">/....  </span>
    /* <span class="variable">data</span> <span class="variable">for</span> <span class="variable">the</span> <span class="variable">mwrite</span> <span class="variable">state</span> *<span class="end-block">/  </span>
    /<span class="end-block">/iov</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;<span class="variable">iov</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    /<span class="end-block">/iov</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5728;<span class="variable">conn</span>_<span class="variable">new</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">CFB</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EDF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;400&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;<span class="variable">iovec</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>9<span class="variable">AD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>34;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>4<span class="variable">D</span>;600&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;  
    <span class="variable">struct</span> <span class="variable">iovec</span> *<span class="variable">iov</span>;  
    /<span class="end-block">/iov</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;  
    <span class="variable">int</span>    <span class="variable">iovsize</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">allocated</span> <span class="variable">in</span> <span class="variable">iov</span>[] *<span class="end-block">/  </span>
    /<span class="end-block">/iovused </span>&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;<span class="variable">iov</span>&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;&amp;<span class="begin-block">#x</span>591<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">C</span>11;  
    <span class="variable">int</span>    <span class="variable">iovused</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">used</span> <span class="variable">in</span> <span class="variable">iov</span>[] *<span class="end-block">/  </span>

    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5<span class="variable">B</span>58;&amp;<span class="begin-block">#x</span>50<span class="variable">A</span>8;<span class="variable">msghdr</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>5217;&amp;<span class="begin-block">#x</span>8868;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>636<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;&amp;<span class="begin-block">#x</span>5728;<span class="variable">conn</span>_<span class="variable">new</span>&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">CFB</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">EDF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>5206;&amp;<span class="begin-block">#x</span>914<span class="variable">D</span>;10&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>7<span class="variable">ED</span>3;&amp;<span class="begin-block">#x</span>6784;  
    <span class="variable">struct</span> <span class="variable">msghdr</span> *<span class="variable">msglist</span>;  
    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">A</span>;10&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6700;&amp;<span class="begin-block">#x</span>9<span class="variable">AD</span>8;&amp;<span class="begin-block">#x</span>6<span class="variable">C</span>34;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>4<span class="variable">D</span>;100&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>0<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>591<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>65<span class="variable">F</span>6;&amp;<span class="begin-block">#x</span>5019;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;<span class="variable">realloc</span>&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">BCF</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">B</span>21;&amp;<span class="begin-block">#x</span>6269;&amp;<span class="begin-block">#x</span>5<span class="variable">BB</span>9;&amp;<span class="begin-block">#x</span>90<span class="variable">FD</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>1<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>6269;&amp;<span class="begin-block">#x</span>5<span class="variable">BB</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>00;&amp;<span class="begin-block">#x</span>500<span class="variable">D</span>;  
    <span class="variable">int</span>    <span class="variable">msgsize</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">allocated</span> <span class="variable">in</span> <span class="variable">msglist</span>[] *<span class="end-block">/  </span>
    /<span class="end-block">/msglist</span>&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>2;&amp;<span class="begin-block">#x</span>7<span class="variable">ECF</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">F</span>7<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>7528;&amp;<span class="begin-block">#x</span>7684;&amp;<span class="begin-block">#x</span>957<span class="variable">F</span>;&amp;<span class="begin-block">#x</span>5<span class="variable">EA</span>6;  
    <span class="variable">int</span>    <span class="variable">msgused</span>;   /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">elements</span> <span class="variable">used</span> <span class="variable">in</span> <span class="variable">msglist</span>[] *<span class="end-block">/  </span>
    //&amp;<span class="begin-block">#x</span>8<span class="variable">FD</span>9;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>2<span class="variable">A</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">C</span>2;&amp;<span class="begin-block">#x</span>6570;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>3<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>8981;&amp;<span class="begin-block">#x</span>5<span class="variable">E</span>2<span class="variable">E</span>;&amp;<span class="begin-block">#x</span>52<span class="variable">A</span>9;&amp;<span class="begin-block">#x</span>8<span class="variable">BB</span>0;&amp;<span class="begin-block">#x</span>5<span class="variable">F</span>55;&amp;<span class="begin-block">#x</span>90<span class="variable">A</span>3;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>9<span class="variable">B</span>;<span class="variable">msglist</span>&amp;<span class="begin-block">#x</span>5<span class="variable">DF</span>2;&amp;<span class="begin-block">#x</span>7<span class="variable">ECF</span>;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>86;&amp;<span class="begin-block">#xFF</span>0<span class="variable">C</span>;&amp;<span class="begin-block">#x</span>54<span class="variable">EA</span>;&amp;<span class="begin-block">#x</span>4<span class="variable">E</span>9<span class="variable">B</span>;&amp;<span class="begin-block">#x</span>6<span class="variable">CA</span>1;&amp;<span class="begin-block">#x</span>6709;&amp;<span class="begin-block">#x</span>53<span class="variable">D</span>1;&amp;<span class="begin-block">#x</span>9001;&amp;<span class="begin-block">#x</span>8<span class="variable">FC</span>7;&amp;<span class="begin-block">#x</span>3002;  
    <span class="variable">int</span>    <span class="variable">msgcurr</span>;   /* <span class="variable">element</span> <span class="variable">in</span> <span class="variable">msglist</span>[] <span class="variable">being</span> <span class="variable">transmitted</span> <span class="variable">now</span> *<span class="end-block">/  </span>
    <span class="variable">int</span>    <span class="variable">msgbytes</span>;  /* <span class="variable">number</span> <span class="variable">of</span> <span class="variable">bytes</span> <span class="variable">in</span> <span class="variable">current</span> <span class="variable">msg</span> *<span class="end-block">/  </span>
}</span><span class="xml"></span>
</code></pre><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x4E00;&#x4E0B;conn_new&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5E94;&#x8BE5;&#x5728;&#x7B2C;&#x4E00;&#x7AE0;&#x8282;&#x7684;&#x65F6;&#x5019;&#x8BB2;&#x5230;&#x8FC7;&#x3002;&#x8FD9;&#x8FB9;&#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;iov&#x548C;msglist&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x521D;&#x59CB;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
<pre><code><span class="xml">conn *conn_new(const int sfd, enum conn_states init_state,  
      const int event_flags, const int read_buffer_size,  
      enum network_transport transport, struct event_base *base) </span><span class="expression">{  
/<span class="end-block">/...  </span>
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span> = <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wbuf</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixlist</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">hdrbuf</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rsize</span> = <span class="variable">read</span>_<span class="variable">buffer</span>_<span class="variable">size</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wsize</span> = <span class="variable">DATA</span>_<span class="variable">BUFFER</span>_<span class="variable">SIZE</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">isize</span> = <span class="variable">ITEM</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixsize</span> = <span class="variable">SUFFIX</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iovsize</span> = <span class="variable">IOV</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>; //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;400  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgsize</span> = <span class="variable">MSG</span>_<span class="variable">LIST</span>_<span class="variable">INITIAL</span>; //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;10  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">hdrsize</span> = 0;  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rbuf</span> = (<span class="variable">char</span> *) <span class="variable">malloc</span>((<span class="variable">size</span>_<span class="variable">t</span>) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">rsize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wbuf</span> = (<span class="variable">char</span> *) <span class="variable">malloc</span>((<span class="variable">size</span>_<span class="variable">t</span>) <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">wsize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">ilist</span> = (<span class="variable">item</span> **) <span class="variable">malloc</span>(<span class="variable">sizeof</span>(<span class="variable">item</span> *) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">isize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixlist</span> = (<span class="variable">char</span> **) <span class="variable">malloc</span>(<span class="variable">sizeof</span>(<span class="variable">char</span> *) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">suffixsize</span>);  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iov</span> = (<span class="variable">struct</span> <span class="variable">iovec</span> *) <span class="variable">malloc</span>(<span class="variable">sizeof</span>(<span class="variable">struct</span> <span class="variable">iovec</span>) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">iovsize</span>); //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;<span class="variable">iov</span>  
      <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msglist</span> = (<span class="variable">struct</span> <span class="variable">msghdr</span> *) <span class="variable">malloc</span>(  
            <span class="variable">sizeof</span>(<span class="variable">struct</span> <span class="variable">msghdr</span>) * <span class="variable">c-</span>&amp;<span class="variable"><span class="keyword">gt</span></span>;<span class="variable">msgsize</span>); //&amp;<span class="begin-block">#x</span>521<span class="variable">D</span>;&amp;<span class="begin-block">#x</span>59<span class="variable">CB</span>;&amp;<span class="begin-block">#x</span>5316;<span class="variable">msglist</span>  
/<span class="end-block">/...  </span>
}</span><span class="xml"></span>
</code></pre><p>&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#x56FE;&#xFF08;iov&#x548C;msglist&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF09;&#xFF1A;</p>
<p><img src="http://taojinke.github.io/img/20150703/2748dca.jpg" alt=""></p>
<p>&#x4ECE;process_get_command&#x5F00;&#x59CB;</p>
<p>&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x4ECE;process_get_command&#xFF0C;&#x83B7;&#x53D6;memcached&#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5F00;&#x59CB;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x770B;add_iov&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;Memcached&#x4E3B;&#x8981;&#x662F;&#x901A;&#x8FC7;add_iov&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x9700;&#x8981;&#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x88C5;&#x5230;iov&#x548C;msglist&#x7ED3;&#x6784;&#x4E2D;&#x53BB;&#x7684;&#x3002;</p>
<pre><code>/* ntokens is overwritten here... shrug.. */  
//&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x8BF7</span>;&amp;<span class="symbol">#x6C42</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
static inline void process_get_command(conn *c, token_t *tokens, size_t ntokens,  
        bool return_cas) {  
    //&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;<span class="class">GET</span>&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    char *key;  
    size_t nkey;  
    int i = <span class="number">0</span>;  
    item *it;  
    //&amp;amp;tokens[<span class="number">0</span>] &amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
    //&amp;amp;tokens[<span class="number">1</span>] &amp;<span class="symbol">#x4E3A</span>;key  
    //token_t &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x4E86</span>;value&amp;<span class="symbol">#x548C</span>;length  
    token_t *key_token = &amp;amp;tokens[<span class="class">KEY_TOKEN</span>];  
    char *suffix;  
    assert(c != <span class="class">NULL</span>);  
    do {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
        while (key_token-&amp;gt;length != <span class="number">0</span>) {  
            key = key_token-&amp;gt;value;  
            nkey = key_token-&amp;gt;length;  
            //&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x8D85</span>;&amp;<span class="symbol">#x8FC7</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#xFF0C</span>;memcache key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">250</span>  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5730</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x5E73</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6CE8</span>;&amp;<span class="symbol">#x610F</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5B57</span>;&amp;<span class="symbol">#x8282</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x7684</span>;  
            if (nkey &amp;gt; <span class="class">KEY_MAX_LENGTH</span>) {  
                //out_string &amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x8F93</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
                out_string(c, &amp;quot;<span class="class">CLIENT_ERROR</span> bad command line format&amp;quot;);  
                while (i-- &amp;gt; <span class="number">0</span>) {  
                    item_remove(*(c-&amp;gt;ilist + i));  
                }  
                return;  
            }  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x4ECE</span>;<span class="class">Memcached</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;&amp;<span class="symbol">#x5FEB</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            it = item_get(key, nkey);  
            if (settings.detail_enabled) {  
                //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#xFF0C</span>;key&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BB0</span>;&amp;<span class="symbol">#x5F55</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
                stats_prefix_record_get(key, nkey, <span class="class">NULL</span> != it);  
            }  
            //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
            if (it) {  
                //c-&amp;gt;ilist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5916</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;buf  
                //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;ilist&amp;<span class="symbol">#x592A</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5206</span>;&amp;<span class="symbol">#x914D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;  
                if (i &amp;gt;= c-&amp;gt;isize) {  
                    item **new_list = realloc(c-&amp;gt;ilist,  
                            sizeof(item *) * c-&amp;gt;isize * <span class="number">2</span>);  
                    if (new_list) {  
                        //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
                        c-&amp;gt;isize *= <span class="number">2</span>;  
                        //&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x653E</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x652F</span>;&amp;<span class="symbol">#x6301</span>;  
                        c-&amp;gt;ilist = new_list;  
                    } else {  
                        <span class="class">STATS_LOCK</span>();  
                        stats.malloc_fails++;  
                        <span class="class">STATS_UNLOCK</span>();  
                        item_remove(it);  
                        break;  
                    }  
                }  
                /* 
                 * <span class="class">Construct</span> the response. <span class="class">Each</span> hit adds three elements to the 
                 * outgoing data <span class="method">list:</span> 
                 *   &amp;quot;<span class="class">VALUE</span> &amp;quot; 
                 *   key 
                 *   &amp;quot; &amp;quot; + flags + &amp;quot; &amp;quot; + data length + &amp;quot;\r\n&amp;quot; + data (with \r\n) 
                 */  
                //&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
                if (return_cas) {  
                    //......  
                } else {  
                    <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey,  
                            it-&amp;gt;nbytes, <span class="class">ITEM_get_cas</span>(it));  
                    //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x5230</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;  
                    //&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#xFF1A</span>;get userId  
                    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#xFF1A</span>;  
                    //<span class="class">VALUE</span> userId <span class="number">0</span> <span class="number">5</span>  
                    //<span class="number">55555</span>  
                    //<span class="class">END</span>  
                    if (&amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, &amp;quot;<span class="class">VALUE</span> &amp;quot;, <span class="number">6</span>) != <span class="number">0</span>  
                            || &amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, <span class="class">ITEM_key</span>(it), it-&amp;gt;nkey) != <span class="number">0</span>  
                            || &amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, <span class="class">ITEM_suffix</span>(it),  
                                    it-&amp;gt;nsuffix + it-&amp;gt;nbytes) != <span class="number">0</span>) {  
                        item_remove(it);  
                        break;  
                    }  
                }  
                if (settings.verbose &amp;gt; <span class="number">1</span>) {  
                    int ii;  
                    fprintf(stderr, &amp;quot;&amp;gt;%d sending key &amp;quot;, c-&amp;gt;sfd);  
                    for (ii = <span class="number">0</span>; ii &amp;lt; it-&amp;gt;nkey; ++ii) {  
                        fprintf(stderr, &amp;quot;%c&amp;quot;, key[ii]);  
                    }  
                    fprintf(stderr, &amp;quot;\n&amp;quot;);  
                }  
                /* item_get() has incremented it-&amp;gt;refcount for us */  
                pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                c-&amp;gt;thread-&amp;gt;stats.slab_stats[it-&amp;gt;slabs_clsid].get_hits++;  
                c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
                pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                item_update(it);  
                *(c-&amp;gt;ilist + i) = it;  
                i++;  
            } else {  
                pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                c-&amp;gt;thread-&amp;gt;stats.get_misses++;  
                c-&amp;gt;thread-&amp;gt;stats.get_cmds++;  
                pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
                <span class="class">MEMCACHED_COMMAND_GET</span>(c-&amp;gt;sfd, key, nkey, -<span class="number">1</span>, <span class="number">0</span>);  
            }  
            key_token++;  
        }  
        /* 
         * <span class="class">If</span> the command string hasn&amp;apos;t been fully processed, get the next set 
         * of tokens. 
         */  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x5168</span>;&amp;<span class="symbol">#x90E8</span>;&amp;<span class="symbol">#x88AB</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
        //&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x884C</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;get&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5143</span>;&amp;<span class="symbol">#x7D20</span>;  
        if (key_token-&amp;gt;value != <span class="class">NULL</span>) {  
            ntokens = tokenize_command(key_token-&amp;gt;value, tokens, <span class="class">MAX_TOKENS</span>);  
            key_token = tokens;  
        }  
    } while (key_token-&amp;gt;value != <span class="class">NULL</span>);  
    c-&amp;gt;icurr = c-&amp;gt;ilist;  
    c-&amp;gt;ileft = i;  
    if (return_cas) {  
        c-&amp;gt;suffixcurr = c-&amp;gt;suffixlist;  
        c-&amp;gt;suffixleft = i;  
    }  
    if (settings.verbose &amp;gt; <span class="number">1</span>)  
        fprintf(stderr, &amp;quot;&amp;gt;%d <span class="class">END</span>\n&amp;quot;, c-&amp;gt;sfd);  
    /* 
     <span class="class">If</span> the loop was terminated because of out-of-memory, it is not 
     reliable to add <span class="class">END</span>\r\n to the buffer, because it might not end 
     in \r\n. <span class="class">So</span> we send <span class="class">SERVER_ERROR</span> instead. 
     */  
    //&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#x675F</span>;&amp;<span class="symbol">#x6807</span>;&amp;<span class="symbol">#x5FD7</span>;&amp;<span class="symbol">#x7B26</span>;&amp;<span class="symbol">#x53F7</span>;  
    if (key_token-&amp;gt;value != <span class="class">NULL</span> || &amp;lt;strong&amp;gt;&amp;lt;span style=&amp;quot;<span class="method">color:</span><span class="symbol">#FF0000</span>;&amp;quot;&amp;gt;add_iov&amp;lt;/span&amp;gt;&amp;lt;/strong&amp;gt;(c, &amp;quot;<span class="class">END</span>\r\n&amp;quot;, <span class="number">5</span>) != <span class="number">0</span>  
            || (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>)) {  
        out_of_memory(c, &amp;quot;<span class="class">SERVER_ERROR</span> out of memory writing get response&amp;quot;);  
    } else {  
        //&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x4FEE</span>;&amp;<span class="symbol">#x6539</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x8BFB</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x5230</span>;item&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x5F00</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5F80</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x3002</span>;  
        conn_set_state(c, conn_mwrite);  
        c-&amp;gt;msgcurr = <span class="number">0</span>;  
    }  
}
</code></pre><p>add_iov &#x65B9;&#x6CD5;</p>
<p>add_iov&#x65B9;&#x6CD5;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;Memcached&#x9700;&#x8981;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5206;&#x6210;N&#x591A;&#x4E2A;IOV&#x7684;&#x5757;</p>
</li>
<li><p>&#x5C06;IOV&#x5757;&#x6DFB;&#x52A0;&#x5230;msghdr&#x7684;&#x7ED3;&#x6784;&#x4E2D;&#x53BB;&#x3002;</p>
<p> static int add_iov(conn <em>c, const void </em>buf, int len) {  </p>
<pre><code>struct msghdr *m;  
int leftover;  
bool limit_to_mtu;  
assert(c != <span class="class">NULL</span>);  
do {  
  //&amp;<span class="symbol">#x6D88</span>;&amp;<span class="symbol">#x606F</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x7EC4</span>; msglist &amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
  //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x83B7</span>;&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;  
  m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgused - <span class="number">1</span>];  
  /* 
   * <span class="class">Limit</span> <span class="class">UDP</span> packets, and the first payloads of <span class="class">TCP</span> replies, to 
   * <span class="class">UDP_MAX_PAYLOAD_SIZE</span> bytes. 
   */  
  limit_to_mtu = <span class="class">IS_UDP</span>(c-&amp;gt;transport) || (<span class="number">1</span> == c-&amp;gt;msgused);  
  /* <span class="class">We</span> may need to start a new msghdr if this one is full. */  
  //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x7684</span>;iov&amp;<span class="symbol">#x6EE1</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x66F4</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
  if (m-&amp;gt;msg_iovlen == <span class="class">IOV_MAX</span>  
        || (limit_to_mtu &amp;amp;&amp;amp; c-&amp;gt;msgbytes &amp;gt;= <span class="class">UDP_MAX_PAYLOAD_SIZE</span>)) {  
    //&amp;<span class="symbol">#x6DFB</span>;&amp;<span class="symbol">#x52A0</span>;msghdr,&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;<span class="number">10</span>&amp;<span class="symbol">#x4E2A</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
    add_msghdr(c);  
    //&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
    m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgused - <span class="number">1</span>];  
  }  
  //&amp;<span class="symbol">#x786E</span>;&amp;<span class="symbol">#x8BA4</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x7A7A</span>;&amp;<span class="symbol">#x95F4</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x9ED8</span>;&amp;<span class="symbol">#x8BA4</span>;&amp;<span class="symbol">#x662F</span>;<span class="number">400</span>&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6C34</span>;&amp;<span class="symbol">#x4F4D</span>;<span class="number">600</span>  
  //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x4E0D</span>;&amp;<span class="symbol">#x591F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x53BB</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
  if (ensure_iov_space(c) != <span class="number">0</span>)  
    return -<span class="number">1</span>;  
  /* <span class="class">If</span> the fragment is too big to fit in the datagram, split it up */  
  if (limit_to_mtu &amp;amp;&amp;amp; len + c-&amp;gt;msgbytes &amp;gt; <span class="class">UDP_MAX_PAYLOAD_SIZE</span>) {  
    leftover = len + c-&amp;gt;msgbytes - <span class="class">UDP_MAX_PAYLOAD_SIZE</span>;  
    len -= leftover;  
  } else {  
    leftover = <span class="number">0</span>;  
  }  
  m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgused - <span class="number">1</span>];  
  //m-&amp;gt;msg_iov&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;c-&amp;gt;iov&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x3002</span>;  
  //&amp;<span class="symbol">#x5177</span>;&amp;<span class="symbol">#x4F53</span>;m-&amp;gt;msg_iov&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x4F55</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5230</span>;c-&amp;gt;iov&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E0B</span>;add_msghdr&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
  //&amp;<span class="symbol">#x5411</span>;<span class="class">IOV</span>&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;<span class="class">BUF</span>  
  m-&amp;gt;msg_iov[m-&amp;gt;msg_iovlen].iov_base = (void *) buf;  
  //buf&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
  m-&amp;gt;msg_iov[m-&amp;gt;msg_iovlen].iov_len = len; //&amp;<span class="symbol">#x586B</span>;&amp;<span class="symbol">#x5145</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;  
  c-&amp;gt;msgbytes += len;  
  c-&amp;gt;iovused++;  
  m-&amp;gt;msg_iovlen++; //msg_iovlen + <span class="number">1</span>  
  buf = ((char *) buf) + len;  
  len = leftover;  
} while (leftover &amp;gt; <span class="number">0</span>);  
return <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>add_msghdr &#x65B9;&#x6CD5; msghdr&#x6269;&#x5BB9;</p>
<p>&#x5728;add_iov&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5F53;IOV&#x5757;&#x6DFB;&#x52A0;&#x6EE1;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6269;&#x5BB9;msgdhr&#x7684;&#x4E2A;&#x6570;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4E24;&#x4E2A;&#x4F5C;&#x7528;&#xFF1A;</p>
<ol>
<li><p>&#x68C0;&#x67E5;c-&gt;msglist&#x5217;&#x8868;&#x957F;&#x5EA6;&#x662F;&#x5426;&#x591F;&#x7528;&#x3002;</p>
</li>
<li><p>&#x4F7F;&#x7528;&#x6700;&#x65B0;&#x7684;c-&gt;msglist&#x4E2D;&#x7684;&#x4E00;&#x4E2A;msghdr&#x5143;&#x7D20;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;msghdr-&gt;msg_iov&#x6307;&#x5411;c-&gt;iov&#x6700;&#x65B0;&#x672A;&#x4F7F;&#x7528;&#x7684;&#x90A3;&#x4E2A;iov&#x7684;&#x6307;&#x9488;&#x5730;&#x5740;&#x3002;</p>
<p> static int add_msghdr(conn *c) {  </p>
<pre><code>//c-&amp;gt;msglist &amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x50A8</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
struct msghdr *msg;  
assert(c != <span class="class">NULL</span>);  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;msglist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x548C</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x957F</span>;&amp;<span class="symbol">#x5EA6</span>;&amp;<span class="symbol">#x76F8</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;msglist&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;  
if (c-&amp;gt;msgsize == c-&amp;gt;msgused) {  
    //&amp;<span class="symbol">#x6269</span>;&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x4E24</span>;&amp;<span class="symbol">#x500D</span>;  
    msg = realloc(c-&amp;gt;msglist, c-&amp;gt;msgsize * <span class="number">2</span> * sizeof(struct msghdr));  
    if (!msg) {  
        <span class="class">STATS_LOCK</span>();  
        stats.malloc_fails++;  
        <span class="class">STATS_UNLOCK</span>();  
        return -<span class="number">1</span>;  
    }  
    c-&amp;gt;msglist = msg; //&amp;<span class="symbol">#x5C06</span>;c-&amp;gt;msglist&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5F53</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5217</span>;&amp;<span class="symbol">#x8868</span>;  
    c-&amp;gt;msgsize *= <span class="number">2</span>; //size&amp;<span class="symbol">#x4E5F</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x8DDF</span>;&amp;<span class="symbol">#x7740</span>;&amp;<span class="symbol">#x589E</span>;&amp;<span class="symbol">#x52A0</span>;  
}  
//msg&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x7F6E</span>;  
msg = c-&amp;gt;msglist + c-&amp;gt;msgused;  
/* this wipes msg_iovlen, msg_control, msg_controllen, and 
 msg_flags, the last <span class="number">3</span> of which aren&amp;apos;t defined on <span class="method">solaris:</span> */  
//&amp;<span class="symbol">#x5C06</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x5757</span>;&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x5316</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x4E3A</span>;<span class="number">0</span>  
memset(msg, <span class="number">0</span>, sizeof(struct msghdr));  
//&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7684</span>;msg_iov&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x5411</span>; struct iovec *iov&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
msg-&amp;gt;msg_iov = &amp;amp;c-&amp;gt;iov[c-&amp;gt;iovused];  
if (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; c-&amp;gt;request_addr_size &amp;gt; <span class="number">0</span>) {  
    msg-&amp;gt;msg_name = &amp;amp;c-&amp;gt;request_addr;  
    msg-&amp;gt;msg_namelen = c-&amp;gt;request_addr_size;  
}  
c-&amp;gt;msgbytes = <span class="number">0</span>;  
c-&amp;gt;msgused++;  
if (<span class="class">IS_UDP</span>(c-&amp;gt;transport)) {  
    /* <span class="class">Leave</span> room for the <span class="class">UDP</span> header, which we&amp;apos;ll fill in later. */  
    return add_iov(c, <span class="class">NULL</span>, <span class="class">UDP_HEADER_SIZE</span>);  
}  
return <span class="number">0</span>;  
</code></pre><p> }</p>
</li>
</ol>
<p>ensure_iov_space &#x65B9;&#x6CD5; IOV&#x6269;&#x5BB9;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x68C0;&#x67E5;c-&gt;iov&#x662F;&#x5426;&#x8FD8;&#x6709;&#x5269;&#x4F59;&#x7A7A;&#x95F4;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x591F;&#x7528;&#x4E86;&#xFF0C;&#x5219;&#x6269;&#x5BB9;2&#x500D;&#x3002;</p>
<pre><code><span class="keyword">static</span> int ensure_iov_space(conn *<span class="built_in">c</span>) {  
    <span class="built_in">assert</span>(<span class="built_in">c</span> != <span class="type">NULL</span>);  
    <span class="comment">//&amp;#x5982;&amp;#x679C;IOV&amp;#x4E5F;&amp;#x4F7F;&amp;#x7528;&amp;#x5B8C;&amp;#x4E86;....IOV&amp;#xFF0C;&amp;#x5206;&amp;#x914D;&amp;#x65B0;&amp;#x7684;IOV  </span>
    <span class="keyword">if</span> (<span class="built_in">c</span>-&amp;gt;iovused &amp;gt;= <span class="built_in">c</span>-&amp;gt;iovsize) {  
        int i, iovnum;  
        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">new_iov</span> = (<span class="title">struct</span> <span class="title">iovec</span> *) <span class="title">realloc</span>(<span class="title">c</span>-&amp;<span class="title">gt</span>;<span class="title">iov</span>,  
                (<span class="title">c</span>-&amp;<span class="title">gt</span>;<span class="title">iovsize</span> * 2) * <span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">iovec</span>));  
        <span class="title">if</span> (!<span class="title">new_iov</span>) </span>{  
            <span class="type">STATS_LOCK</span>();  
            stats.malloc_fails++;  
            <span class="type">STATS_UNLOCK</span>();  
            <span class="keyword">return</span> -<span class="number">1</span>;  
        }  
        <span class="built_in">c</span>-&amp;gt;iov = new_iov;  
        <span class="built_in">c</span>-&amp;gt;iovsize *= <span class="number">2</span>; <span class="comment">//&amp;#x6269;&amp;#x5BB9;&amp;#x4E24;&amp;#x500D;  </span>
        <span class="comment">/* Point all the msghdr structures at the new list. */</span>  
        <span class="keyword">for</span> (i = <span class="number">0</span>, iovnum = <span class="number">0</span>; i &amp;lt; <span class="built_in">c</span>-&amp;gt;msgused; i++) {  
            <span class="built_in">c</span>-&amp;gt;msglist[i].msg_iov = &amp;amp;<span class="built_in">c</span>-&amp;gt;iov[iovnum];  
            iovnum += <span class="built_in">c</span>-&amp;gt;msglist[i].msg_iovlen;  
        }  
    }  
    <span class="keyword">return</span> <span class="number">0</span>;  
}
</code></pre><p>conn_mwrite</p>
<p>conn_mwrite&#x72B6;&#x6001;&#x5728;drive_machine&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x3002;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x5199;&#x6570;&#x636E;&#x4E86;&#x3002;</p>
<p>&#x4ECE;&#x4E0A;&#x9762;&#x7684;add_iov&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;Memcached&#x4F1A;&#x5C06;&#x9700;&#x8981;&#x5F85;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x5199;&#x5165;c-&gt;msglist&#x7ED3;&#x6784;&#x4E2D;&#x3002;</p>
<p>&#x771F;&#x6B63;&#x5199;&#x6570;&#x636E;&#x7684;&#x65B9;&#x6CD5;&#x662F;transmit&#x3002;</p>
<pre><code>//drive_machine&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;  
//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;conn_mwrite&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
case <span class="method">conn_mwrite:</span>  
    if (<span class="class">IS_UDP</span>(c-&amp;gt;transport) &amp;amp;&amp;amp; c-&amp;gt;msgcurr == <span class="number">0</span>  
            &amp;amp;&amp;amp; build_udp_headers(c) != <span class="number">0</span>) {  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            fprintf(stderr, &amp;quot;<span class="class">Failed</span> to build <span class="class">UDP</span> headers\n&amp;quot;);  
        conn_set_state(c, conn_closing);  
        break;  
    }  
    //transmit&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x975E</span>;&amp;<span class="symbol">#x5E38</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x64CD</span>;&amp;<span class="symbol">#x4F5C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x5728</span>;&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;  
    //&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;transmit_result&amp;<span class="symbol">#x679A</span>;&amp;<span class="symbol">#x4E3E</span>;&amp;<span class="symbol">#x7C7B</span>;&amp;<span class="symbol">#x578B</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#x4E8E</span>;&amp;<span class="symbol">#x5224</span>;&amp;<span class="symbol">#x65AD</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5173</span>;&amp;<span class="symbol">#x95ED</span>;&amp;<span class="symbol">#x8FDE</span>;&amp;<span class="symbol">#x63A5</span>;  
    switch (transmit(c)) {  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;  
    case <span class="class">TRANSMIT_COMPLETE</span>:  
        if (c-&amp;gt;state == conn_mwrite) {  
            conn_release_items(c);  
            /* <span class="class">XXX</span>:  <span class="class">I</span> don&amp;apos;t know why this wasn&amp;apos;t the general case */  
            if (c-&amp;gt;protocol == binary_prot) {  
                conn_set_state(c, c-&amp;gt;write_and_go);  
            } else {  
                //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x662F</span>;<span class="class">TCP</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
                //&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#x53C8</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x5207</span>;&amp;<span class="symbol">#x56DE</span>;&amp;<span class="symbol">#x5230</span>;conn_new_cmd&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
                //conn_new_cmd&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x53C2</span>;&amp;<span class="symbol">#x6570</span>;  
                conn_set_state(c, conn_new_cmd);  
            }  
        } else if (c-&amp;gt;state == conn_write) {  
            if (c-&amp;gt;write_and_free) {  
                free(c-&amp;gt;write_and_free);  
                c-&amp;gt;write_and_free = <span class="number">0</span>;  
            }  
            conn_set_state(c, c-&amp;gt;write_and_go);  
        } else {  
            if (settings.verbose &amp;gt; <span class="number">0</span>)  
                fprintf(stderr, &amp;quot;<span class="class">Unexpected</span> state %d\n&amp;quot;, c-&amp;gt;state);  
            conn_set_state(c, conn_closing);  
        }  
        break;
</code></pre><p>transmit &#x65B9;&#x6CD5;</p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#xFF1A;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x6570;&#x636E;</p>
<pre><code>//&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x4E3B</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x5199</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
//&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x6709</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5FAA</span>;&amp;<span class="symbol">#x73AF</span>;conn_mwrite&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x76F4</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#x6B62</span>;  
static enum transmit_result transmit(conn *c) {  
    assert(c != <span class="class">NULL</span>);  
    //&amp;<span class="symbol">#x6BCF</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x6765</span>;&amp;<span class="symbol">#x6821</span>;&amp;<span class="symbol">#x9A8C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x5426</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x6B21</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;c-&amp;gt;msgcurr&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#xFFFD</span>;&amp;<span class="symbol">#x540E</span>;&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#xFF0C</span>;  
    //&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E0B</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;&amp;<span class="symbol">#x4F53</span>;&amp;<span class="symbol">#x6307</span>;&amp;<span class="symbol">#x9488</span>;&amp;<span class="symbol">#x4E0A</span>;  
    //c-&amp;gt;msgcurr&amp;<span class="symbol">#x521D</span>;&amp;<span class="symbol">#x59CB</span>;&amp;<span class="symbol">#x503C</span>;&amp;<span class="symbol">#x4E3A</span>;&amp;<span class="symbol">#xFF1A</span>;<span class="number">0</span>  
    if (c-&amp;gt;msgcurr &amp;lt; c-&amp;gt;msgused &amp;amp;&amp;amp; c-&amp;gt;msglist[c-&amp;gt;msgcurr].msg_iovlen == <span class="number">0</span>) {  
        /* <span class="class">Finished</span> writing the current msg; advance to the next. */  
        c-&amp;gt;msgcurr++;  
    }  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;msgcurr&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x5C0F</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;msgused&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x5C31</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x77E5</span>;&amp;<span class="symbol">#x9053</span>;&amp;<span class="symbol">#x8FD8</span>;&amp;<span class="symbol">#x6CA1</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;c-&amp;gt;msgcurr&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;msgused&amp;<span class="symbol">#xFF08</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x4F7F</span>;&amp;<span class="symbol">#x7528</span>;&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x8BF4</span>;&amp;<span class="symbol">#x660E</span>;&amp;<span class="symbol">#x5DF2</span>;&amp;<span class="symbol">#x7ECF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x8FD4</span>;&amp;<span class="symbol">#x56DE</span>;<span class="class">TRANSMIT_COMPLETE</span>&amp;<span class="symbol">#x72B6</span>;&amp;<span class="symbol">#x6001</span>;  
    if (c-&amp;gt;msgcurr &amp;lt; c-&amp;gt;msgused) {  
        ssize_t res;  
        //&amp;<span class="symbol">#x4ECE</span>;c-&amp;gt;msglist&amp;<span class="symbol">#x53D6</span>;&amp;<span class="symbol">#x51FA</span>;&amp;<span class="symbol">#x4E00</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x7684</span>;msghdr&amp;<span class="symbol">#x7ED3</span>;&amp;<span class="symbol">#x6784</span>;  
        struct msghdr *m = &amp;amp;c-&amp;gt;msglist[c-&amp;gt;msgcurr];  
        //&amp;<span class="symbol">#x5411</span>;&amp;<span class="symbol">#x5BA2</span>;&amp;<span class="symbol">#x6237</span>;&amp;<span class="symbol">#x7AEF</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;  
        res = sendmsg(c-&amp;gt;sfd, m, <span class="number">0</span>);  
        //&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x529F</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
        if (res &amp;gt; <span class="number">0</span>) {  
            pthread_mutex_lock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            c-&amp;gt;thread-&amp;gt;stats.bytes_written += res;  
            pthread_mutex_unlock(&amp;amp;c-&amp;gt;thread-&amp;gt;stats.mutex);  
            /* <span class="class">We</span>&amp;apos;ve written some of the data. <span class="class">Remove</span> the completed 
             iovec entries from the list of pending writes. */  
            //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x8FB9</span>;&amp;<span class="symbol">#x4F1A</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x5C11</span>;  
            while (m-&amp;gt;msg_iovlen &amp;gt; <span class="number">0</span> &amp;amp;&amp;amp; res &amp;gt;= m-&amp;gt;msg_iov-&amp;gt;iov_len) {  
                res -= m-&amp;gt;msg_iov-&amp;gt;iov_len;  
                m-&amp;gt;msg_iovlen--;  
                m-&amp;gt;msg_iov++;  
            }  
            /* <span class="class">Might</span> have written just part of the last iovec entry; 
             adjust it so the next write will do the rest. */  
            if (res &amp;gt; <span class="number">0</span>) {  
                m-&amp;gt;msg_iov-&amp;gt;iov_base = (caddr_t) m-&amp;gt;msg_iov-&amp;gt;iov_base + res;  
                m-&amp;gt;msg_iov-&amp;gt;iov_len -= res;  
            }  
            return <span class="class">TRANSMIT_INCOMPLETE</span>;  
        }  
        //&amp;<span class="symbol">#x53D1</span>;&amp;<span class="symbol">#x9001</span>;&amp;<span class="symbol">#x5931</span>;&amp;<span class="symbol">#x8D25</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x60C5</span>;&amp;<span class="symbol">#x51B5</span>;  
        if (res == -<span class="number">1</span> &amp;amp;&amp;amp; (errno == <span class="class">EAGAIN</span> || errno == <span class="class">EWOULDBLOCK</span>)) {  
            if (!update_event(c, <span class="class">EV_WRITE</span> | <span class="class">EV_PERSIST</span>)) {  
                if (settings.verbose &amp;gt; <span class="number">0</span>)  
                    fprintf(stderr, &amp;quot;<span class="class">Couldn</span>&amp;apos;t update event\n&amp;quot;);  
                conn_set_state(c, conn_closing);  
                return <span class="class">TRANSMIT_HARD_ERROR</span>;  
            }  
            return <span class="class">TRANSMIT_SOFT_ERROR</span>;  
        }  
        /* if res == <span class="number">0</span> or res == -<span class="number">1</span> and error is not <span class="class">EAGAIN</span> or <span class="class">EWOULDBLOCK</span>, 
         we have a real error, on which we close the connection */  
        if (settings.verbose &amp;gt; <span class="number">0</span>)  
            perror(&amp;quot;<span class="class">Failed</span> to write, and not due to blocking&amp;quot;);  
        if (<span class="class">IS_UDP</span>(c-&amp;gt;transport))  
            conn_set_state(c, conn_read);  
        else  
            conn_set_state(c, conn_closing);  
        return <span class="class">TRANSMIT_HARD_ERROR</span>;  
    } else {  
        return <span class="class">TRANSMIT_COMPLETE</span>;  
    }  
}
</code></pre><p>conn_shrink &#x65B9;&#x6CD5;</p>
<p>&#x5F53;&#x6570;&#x636E;&#x53D1;&#x9001;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;conn_new_cmd&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x7EE7;&#x7EED;&#x5904;&#x7406;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;reset_cmd_handler&#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;conn_shrink&#x65B9;&#x6CD5;&#x3002;</p>
<p>conn_shrink&#x4E3B;&#x8981;&#x662F;&#x7528;&#x4E8E;&#x68C0;&#x67E5;buf&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x662F;&#x5426;&#x8D85;&#x8FC7;&#x4E86;&#x9884;&#x5B9A;&#x7684;&#x6C34;&#x4F4D;&#xFF0C;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x4E86;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x91CD;&#x65B0;realloc&#x3002;</p>
<pre><code>//&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x8BBE</span>;&amp;<span class="symbol">#x7F6E</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;handler  
static void reset_cmd_handler(conn *c) {  
    c-&amp;gt;cmd = -<span class="number">1</span>;  
    c-&amp;gt;substate = bin_no_state;  
    if (c-&amp;gt;item != <span class="class">NULL</span>) {  
        item_remove(c-&amp;gt;item);  
        c-&amp;gt;item = <span class="class">NULL</span>;  
    }  
    conn_shrink(c); //&amp;<span class="symbol">#x8FD9</span>;&amp;<span class="symbol">#x4E2A</span>;&amp;<span class="symbol">#x65B9</span>;&amp;<span class="symbol">#x6CD5</span>;&amp;<span class="symbol">#x662F</span>;&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;c-&amp;gt;rbuf&amp;<span class="symbol">#x5BB9</span>;&amp;<span class="symbol">#x5668</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5269</span>;&amp;<span class="symbol">#x4F59</span>;&amp;<span class="symbol">#x672A</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>; &amp;gt; <span class="number">0</span>&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x8BDD</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x8DF3</span>;&amp;<span class="symbol">#x8F6C</span>;&amp;<span class="symbol">#x5230</span>;conn_parse_cmd&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;  
    if (c-&amp;gt;rbytes &amp;gt; <span class="number">0</span>) {  
        conn_set_state(c, conn_parse_cmd);  
    } else {  
        //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x547D</span>;&amp;<span class="symbol">#x4EE4</span>;&amp;<span class="symbol">#x90FD</span>;&amp;<span class="symbol">#x89E3</span>;&amp;<span class="symbol">#x6790</span>;&amp;<span class="symbol">#x5B8C</span>;&amp;<span class="symbol">#x6210</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x7EE7</span>;&amp;<span class="symbol">#x7EED</span>;&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x5F85</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6570</span>;&amp;<span class="symbol">#x636E</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x6765</span>;  
        conn_set_state(c, conn_waiting);  
    }  
}


//&amp;<span class="symbol">#x68C0</span>;&amp;<span class="symbol">#x67E5</span>;rbuf&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x5C0F</span>;  
static void conn_shrink(conn *c) {  
    assert(c != <span class="class">NULL</span>);  
    if (<span class="class">IS_UDP</span>(c-&amp;gt;transport))  
        return;  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;bufsize&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="class">READ_BUFFER_HIGHWAT</span>&amp;<span class="symbol">#xFF08</span>;<span class="number">8192</span>&amp;<span class="symbol">#xFF09</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x65F6</span>;&amp;<span class="symbol">#x5019</span>;&amp;<span class="symbol">#x9700</span>;&amp;<span class="symbol">#x8981</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;&amp;<span class="symbol">#x5904</span>;&amp;<span class="symbol">#x7406</span>;  
    //<span class="class">DATA_BUFFER_SIZE</span>&amp;<span class="symbol">#x7B49</span>;&amp;<span class="symbol">#x4E8E</span>;<span class="number">2048</span>&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x6240</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x6211</span>;&amp;<span class="symbol">#x4EEC</span>;&amp;<span class="symbol">#x53EF</span>;&amp;<span class="symbol">#x4EE5</span>;&amp;<span class="symbol">#x770B</span>;&amp;<span class="symbol">#x5230</span>;&amp;<span class="symbol">#x4E4B</span>;&amp;<span class="symbol">#x524D</span>;&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x4EE3</span>;&amp;<span class="symbol">#x7801</span>;&amp;<span class="symbol">#x4E2D</span>;&amp;<span class="symbol">#x5BF9</span>;rbuf&amp;<span class="symbol">#x6700</span>;&amp;<span class="symbol">#x591A</span>;&amp;<span class="symbol">#x53EA</span>;&amp;<span class="symbol">#x80FD</span>;&amp;<span class="symbol">#x8FDB</span>;&amp;<span class="symbol">#x884C</span>;<span class="number">4</span>&amp;<span class="symbol">#x6B21</span>;recalloc  
    if (c-&amp;gt;rsize &amp;gt; <span class="class">READ_BUFFER_HIGHWAT</span> &amp;amp;&amp;amp; c-&amp;gt;rbytes &amp;lt; <span class="class">DATA_BUFFER_SIZE</span>) {  
        char *newbuf;  
        if (c-&amp;gt;rcurr != c-&amp;gt;rbuf)  
            memmove(c-&amp;gt;rbuf, c-&amp;gt;rcurr, (size_t) c-&amp;gt;rbytes); //&amp;<span class="symbol">#x5185</span>;&amp;<span class="symbol">#x5B58</span>;&amp;<span class="symbol">#x79FB</span>;&amp;<span class="symbol">#x52A8</span>;  
        newbuf = (char *) realloc((void *) c-&amp;gt;rbuf, <span class="class">DATA_BUFFER_SIZE</span>);  
        if (newbuf) {  
            c-&amp;gt;rbuf = newbuf;  
            c-&amp;gt;rsize = <span class="class">DATA_BUFFER_SIZE</span>;  
        }  
        /* <span class="class">TODO</span> check other branch... */  
        c-&amp;gt;rcurr = c-&amp;gt;rbuf;  
    }  
    if (c-&amp;gt;isize &amp;gt; <span class="class">ITEM_LIST_HIGHWAT</span>) {  
        item **newbuf = (item**) realloc((void *) c-&amp;gt;ilist,  
                <span class="class">ITEM_LIST_INITIAL</span> * sizeof(c-&amp;gt;ilist[<span class="number">0</span>]));  
        if (newbuf) {  
            c-&amp;gt;ilist = newbuf;  
            c-&amp;gt;isize = <span class="class">ITEM_LIST_INITIAL</span>;  
        }  
        /* <span class="class">TODO</span> check error condition? */  
    }  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;msglist&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6C34</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;realloc  
    if (c-&amp;gt;msgsize &amp;gt; <span class="class">MSG_LIST_HIGHWAT</span>) {  
        struct msghdr *newbuf = (struct msghdr *) realloc((void *) c-&amp;gt;msglist,  
                <span class="class">MSG_LIST_INITIAL</span> * sizeof(c-&amp;gt;msglist[<span class="number">0</span>]));  
        if (newbuf) {  
            c-&amp;gt;msglist = newbuf;  
            c-&amp;gt;msgsize = <span class="class">MSG_LIST_INITIAL</span>;  
        }  
        /* <span class="class">TODO</span> check error condition? */  
    }  
    //&amp;<span class="symbol">#x5982</span>;&amp;<span class="symbol">#x679C</span>;&amp;<span class="symbol">#x5927</span>;&amp;<span class="symbol">#x4E8E</span>;c-&amp;gt;iovsize&amp;<span class="symbol">#x7684</span>;&amp;<span class="symbol">#x6C34</span>;&amp;<span class="symbol">#x4F4D</span>;&amp;<span class="symbol">#x4E86</span>;&amp;<span class="symbol">#xFF0C</span>;&amp;<span class="symbol">#x5219</span>;&amp;<span class="symbol">#x91CD</span>;&amp;<span class="symbol">#x65B0</span>;realloc  
    if (c-&amp;gt;iovsize &amp;gt; <span class="class">IOV_LIST_HIGHWAT</span>) {  
        struct iovec *newbuf = (struct iovec *) realloc((void *) c-&amp;gt;iov,  
                <span class="class">IOV_LIST_INITIAL</span> * sizeof(c-&amp;gt;iov[<span class="number">0</span>]));  
        if (newbuf) {  
            c-&amp;gt;iov = newbuf;  
            c-&amp;gt;iovsize = <span class="class">IOV_LIST_INITIAL</span>;  
        }  
        /* <span class="class">TODO</span> check return value */  
    }  
}
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Memcached/">Memcached</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/15/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><a class="page-number" href="/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/page/61/">61</a><a class="extend next" rel="next" href="/page/17/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>606</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>80</sup></a></li>
			
		
			
				<li><a href="/tags/Node-js/" title="Node.js">Node.js<sup>75</sup></a></li>
			
		
			
				<li><a href="/tags/Memcached/" title="Memcached">Memcached<sup>71</sup></a></li>
			
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>65</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/io-js/" title="io.js">io.js<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/Gulp/" title="Gulp">Gulp<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Nosql/" title="Nosql">Nosql<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C++">C++<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/Redis/" title="Redis">Redis<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/源码分析/" title="源码分析">源码分析<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/MySQL/" title="MySQL">MySQL<sup>10</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
