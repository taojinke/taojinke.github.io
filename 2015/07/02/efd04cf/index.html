
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="1XvvwQ7Apt" />
  
    <title>JVM源码分析之堆外内存完全解读 - | dianzi blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="edwin">
    

    
    <meta name="description" content="&amp;#x6982;&amp;#x8FF0;&amp;#x5E7F;&amp;#x4E49;&amp;#x7684;&amp;#x5806;&amp;#x5916;&amp;#x5185;&amp;#x5B58;&amp;#x8BF4;&amp;#x5230;&amp;#x5806;&amp;#x5916;&amp;#x5185;&amp;#x5B58;&amp;#xFF0C;&amp;#x90A3;&amp;#x5927;&amp;#x5BB6;&amp;#x80AF;&amp;#x5B9A;&amp;#x60F3;&amp;#x5230;&amp;#x5806;&amp;#x5185;">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM源码分析之堆外内存完全解读 -">
<meta property="og:url" content="http://taojinke.github.io/2015/07/02/efd04cf/index.html">
<meta property="og:site_name" content="dianzi blog">
<meta property="og:description" content="&amp;#x6982;&amp;#x8FF0;&amp;#x5E7F;&amp;#x4E49;&amp;#x7684;&amp;#x5806;&amp;#x5916;&amp;#x5185;&amp;#x5B58;&amp;#x8BF4;&amp;#x5230;&amp;#x5806;&amp;#x5916;&amp;#x5185;&amp;#x5B58;&amp;#xFF0C;&amp;#x90A3;&amp;#x5927;&amp;#x5BB6;&amp;#x80AF;&amp;#x5B9A;&amp;#x60F3;&amp;#x5230;&amp;#x5806;&amp;#x5185;">
<meta property="og:updated_time" content="2015-07-01T23:50:22.291Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JVM源码分析之堆外内存完全解读 -">
<meta name="twitter:description" content="&amp;#x6982;&amp;#x8FF0;&amp;#x5E7F;&amp;#x4E49;&amp;#x7684;&amp;#x5806;&amp;#x5916;&amp;#x5185;&amp;#x5B58;&amp;#x8BF4;&amp;#x5230;&amp;#x5806;&amp;#x5916;&amp;#x5185;&amp;#x5B58;&amp;#xFF0C;&amp;#x90A3;&amp;#x5927;&amp;#x5BB6;&amp;#x80AF;&amp;#x5B9A;&amp;#x60F3;&amp;#x5230;&amp;#x5806;&amp;#x5185;">

    
    <link rel="alternative" href="/atom.xml" title="dianzi blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?345f95aea4ada2935d6f9ea4177b51ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="dianzi blog" title="dianzi blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="dianzi blog">dianzi blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
						<a href="/music/index.html" target="_blank">Music</a>
					</li>
					<li>
 					
						<form class="search" action="http://taojinke.github.io/" target="_blank">
							<label>Search</label>
						<input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
						</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/02/efd04cf/" title="JVM源码分析之堆外内存完全解读 -" itemprop="url">JVM源码分析之堆外内存完全解读 -</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="edwin" target="_blank" itemprop="author">edwin</a>
		
  <p class="article-time">
    <time datetime="2015-07-01T23:50:22.000Z" itemprop="datePublished"> 发表于 2015-07-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#广义的堆外内存"><span class="toc-number">1.1.</span> <span class="toc-text">广义的堆外内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#狭义的堆外内存"><span class="toc-number">1.2.</span> <span class="toc-text">狭义的堆外内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDK/JVM里DirectByteBuffer的实现"><span class="toc-number">2.</span> <span class="toc-text">JDK/JVM里DirectByteBuffer的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#堆外内存默认是多大"><span class="toc-number">2.1.</span> <span class="toc-text">堆外内存默认是多大</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要主动调用System-gc"><span class="toc-number">2.2.</span> <span class="toc-text">为什么要主动调用System.gc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要使用堆外内存"><span class="toc-number">3.</span> <span class="toc-text">为什么要使用堆外内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么不能大面积使用堆外内存"><span class="toc-number">4.</span> <span class="toc-text">为什么不能大面积使用堆外内存</span></a></li></ol>
		
		</div>
		
		<h2 id="&#x6982;&#x8FF0;">&#x6982;&#x8FF0;</h2><h3 id="&#x5E7F;&#x4E49;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;">&#x5E7F;&#x4E49;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;</h3><p>&#x8BF4;&#x5230;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x90A3;&#x5927;&#x5BB6;&#x80AF;&#x5B9A;&#x60F3;&#x5230;&#x5806;&#x5185;&#x5185;&#x5B58;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#xFFFD;&#xFFFD;&#xFFFD;&#x4EEC;&#x5927;&#x5BB6;&#x63A5;&#x89E6;&#x6700;&#x591A;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x5728;jvm&#x53C2;&#x6570;&#x91CC;&#x901A;&#x5E38;&#x8BBE;&#x7F6E;-Xmx&#x6765;&#x6307;&#x5B9A;&#x6211;&#x4EEC;&#x7684;&#x5806;&#x7684;&#x6700;&#x5927;&#x503C;&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD9;&#x8FD8;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x7406;&#x89E3;&#x7684;Java&#x5806;&#xFF0C;-Xmx&#x7684;&#x503C;&#x662F;&#x65B0;&#x751F;&#x4EE3;&#x548C;&#x8001;&#x751F;&#x4EE3;&#x7684;&#x548C;&#x7684;&#x6700;&#x5927;&#x503C;&#xFF0C;&#x6211;&#x4EEC;&#x5728;jvm&#x53C2;&#x6570;&#x91CC;&#x901A;&#x5E38;&#x8FD8;&#x4F1A;&#x52A0;&#x4E00;&#x4E2A;&#x53C2;&#x6570;-XX:MaxPermSize&#x6765;&#x6307;&#x5B9A;&#x6301;&#x4E45;&#x4EE3;&#x7684;&#x6700;&#x5927;&#x503C;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x8BA4;&#x8BC6;&#x7684;Java&#x5806;&#x7684;&#x6700;&#x5927;&#x503C;&#x5176;&#x5B9E;&#x662F;-Xmx&#x548C;-XX:MaxPermSize&#x7684;&#x603B;&#x548C;&#xFF0C;&#x5728;&#x5206;&#x4EE3;&#x7B97;&#x6CD5;&#x4E0B;&#xFF0C;&#x65B0;&#x751F;&#x4EE3;&#xFF0C;&#x8001;&#x751F;&#x4EE3;&#x548C;&#x6301;&#x4E45;&#x4EE3;&#x662F;&#x8FDE;&#x7EED;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x662F;&#x4E00;&#x8D77;&#x5206;&#x914D;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x5269;&#x4E0B;&#x7684;&#x90FD;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x662F;&#x5806;&#x5916;&#x5185;&#x5B58;(&#x5E7F;&#x4E49;&#x7684;)&#x4E86;&#xFF0C;&#x8FD9;&#x4E9B;&#x5305;&#x62EC;&#x4E86;jvm&#x672C;&#x8EAB;&#x5728;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF0C;codecache&#xFF0C;jni&#x91CC;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#xFF0C;DirectByteBuffer&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x7B49;&#x7B49;</p>
<h3 id="&#x72ED;&#x4E49;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;">&#x72ED;&#x4E49;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;</h3><p>&#x800C;&#x4F5C;&#x4E3A;java&#x5F00;&#x53D1;&#x8005;&#xFF0C;&#x6211;&#x4EEC;&#x5E38;&#x8BF4;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x6EA2;&#x51FA;&#x4E86;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x72ED;&#x4E49;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E3B;&#x8981;&#x662F;&#x6307;java.nio.DirectByteBuffer&#x5728;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x91CC;&#x4E5F;&#x4E3B;&#x8981;&#x662F;&#x8BB2;&#x72ED;&#x4E49;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x548C;&#x6211;&#x4EEC;&#x5E73;&#x65F6;&#x78B0;&#x5230;&#x7684;&#x95EE;&#x9898;&#x6BD4;&#x8F83;&#x5BC6;&#x5207;</p>
<h2 id="JDK/JVM&#x91CC;DirectByteBuffer&#x7684;&#x5B9E;&#x73B0;">JDK/JVM&#x91CC;DirectByteBuffer&#x7684;&#x5B9E;&#x73B0;</h2><p>DirectByteBuffer&#x901A;&#x5E38;&#x7528;&#x5728;&#x901A;&#x4FE1;&#x8FC7;&#x7A0B;&#x4E2D;&#x505A;&#x7F13;&#x51B2;&#x6C60;&#xFF0C;&#x5728;mina&#xFF0C;netty&#x7B49;nio&#x6846;&#x67B6;&#x4E2D;&#x5C61;&#x89C1;&#x4E0D;&#x9C9C;&#xFF0C;&#x5148;&#x6765;&#x770B;&#x770B;JDK&#x91CC;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code>DirectByteBuffer(<span class="keyword">int</span> cap) {                   <span class="comment">// package-private</span>

    super(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);
    boolean pa = VM.isDirectMemoryPageAligned();
    <span class="keyword">int</span> ps = Bits.pageSize();
    <span class="keyword">long</span> size = Math.max(<span class="number">1</span>L, (<span class="keyword">long</span>)cap + (pa ? ps : <span class="number">0</span>));
    Bits.reserveMemory(size, cap);

    <span class="keyword">long</span> <span class="keyword">base</span> = <span class="number">0</span>;
    <span class="keyword">try</span> {
        <span class="keyword">base</span> = <span class="keyword">unsafe</span>.allocateMemory(size);
    } <span class="keyword">catch</span> (OutOfMemoryError x) {
        Bits.unreserveMemory(size, cap);
        <span class="keyword">throw</span> x;
    }
    <span class="keyword">unsafe</span>.setMemory(<span class="keyword">base</span>, size, (<span class="keyword">byte</span>) <span class="number">0</span>);
    <span class="keyword">if</span> (pa &amp;amp;&amp;amp; (<span class="keyword">base</span> % ps != <span class="number">0</span>)) {
        <span class="comment">// Round up to page boundary</span>
        address = <span class="keyword">base</span> + ps - (<span class="keyword">base</span> &amp;amp; (ps - <span class="number">1</span>));
    } <span class="keyword">else</span> {
        address = <span class="keyword">base</span>;
    }
    cleaner = Cleaner.create(<span class="keyword">this</span>, <span class="keyword">new</span> Deallocator(<span class="keyword">base</span>, size, cap));
    att = <span class="keyword">null</span>;



}
</code></pre><p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;&#x771F;&#x6B63;&#x7684;&#x5185;&#x5B58;&#x5206;&#x914D;&#x662F;&#x4F7F;&#x7528;&#x7684;Bits.reserveMemory&#x65B9;&#x6CD5;</p>
<pre><code> <span class="keyword">static</span> <span class="keyword">void</span> reserveMemory(<span class="keyword">long</span> <span class="keyword">size</span>, <span class="keyword">int</span> cap) {
    <span class="keyword">synchronized</span> (Bits.<span class="keyword">class</span>) {
        <span class="keyword">if</span> (!memoryLimitSet &amp;amp;&amp;amp; VM.isBooted()) {
            maxMemory = VM.maxDirectMemory();
            memoryLimitSet = <span class="keyword">true</span>;
        }
        <span class="comment">// -XX:MaxDirectMemorySize limits the total capacity rather than the</span>
        <span class="comment">// actual memory usage, which will differ when buffers are page</span>
        <span class="comment">// aligned.</span>
        <span class="keyword">if</span> (cap &amp;lt;= maxMemory - totalCapacity) {
            reservedMemory += <span class="keyword">size</span>;
            totalCapacity += cap;
            <span class="keyword">count</span>++;
            <span class="keyword">return</span>;
        }
    }

    System.gc();
    <span class="keyword">try</span> {
        Thread.sleep(<span class="number">100</span>);
    } <span class="keyword">catch</span> (InterruptedException x) {
        <span class="comment">// Restore interrupt status</span>
        Thread.currentThread().interrupt();
    }
    <span class="keyword">synchronized</span> (Bits.<span class="keyword">class</span>) {
        <span class="keyword">if</span> (totalCapacity + cap &amp;gt; maxMemory)
            <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError(&amp;quot;Direct buffer memory&amp;quot;);
        reservedMemory += <span class="keyword">size</span>;
        totalCapacity += cap;
        <span class="keyword">count</span>++;
    }

}
</code></pre><p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;-XX:MaxDirectMemorySize&#x6765;&#x6307;&#x5B9A;&#x6700;&#x5927;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x5F15;&#x5165;&#x4E24;&#x4E2A;&#x95EE;&#x9898;</p>
<ul>
<li>&#x5806;&#x5916;&#x5185;&#x5B58;&#x9ED8;&#x8BA4;&#x662F;&#x591A;&#x5927;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4E3B;&#x52A8;&#x8C03;&#x7528;System.gc()</li>
</ul>
<h3 id="&#x5806;&#x5916;&#x5185;&#x5B58;&#x9ED8;&#x8BA4;&#x662F;&#x591A;&#x5927;">&#x5806;&#x5916;&#x5185;&#x5B58;&#x9ED8;&#x8BA4;&#x662F;&#x591A;&#x5927;</h3><p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x901A;&#x8FC7;-XX:MaxDirectMemorySize&#x6765;&#x6307;&#x5B9A;&#x6700;&#x5927;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x90A3;&#x4E48;&#x9ED8;&#x8BA4;&#x7684;&#x6700;&#x5927;&#x5806;&#x5916;&#x5185;&#x5B58;&#x662F;&#x591A;&#x5C11;&#x5462;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x901A;&#x8FC7;&#x4EE3;&#x7801;&#x6765;&#x5206;&#x6790;</p>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x91CC;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x8C03;&#x7528;&#x4E86;sun.misc.VM.maxDirectMemory()</p>
<pre><code>private <span class="keyword">static</span> long directMemory = <span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>;

   // <span class="type">Returns</span> the maximum amount <span class="keyword">of</span> allocatable direct buffer memory.
   // <span class="type">The</span> directMemory variable <span class="keyword">is</span> initialized during system initialization
   // <span class="keyword">in</span> the saveAndRemoveProperties <span class="keyword">method</span>.
   //
   public <span class="keyword">static</span> long maxDirectMemory() {
       <span class="keyword">return</span> directMemory;
   }
</code></pre><p>&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x4E4B;&#x540E;&#x662F;&#x4E0D;&#x662F;&#x8BEF;&#x4EE5;&#x4E3A;&#x9ED8;&#x8BA4;&#x7684;&#x6700;&#x5927;&#x503C;&#x662F;64M&#xFF1F;&#x5176;&#x5B9E;&#x4E0D;&#x662F;&#x7684;&#xFF0C;&#x8BF4;&#x5230;&#x8FD9;&#x4E2A;&#x503C;&#x5F97;&#x4ECE;java.lang.System&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x521D;&#x59CB;&#x5316;&#x8BF4;&#x8D77;</p>
<pre><code><span class="comment">/**
    * Initialize the system class.  Called after thread initialization.
    */</span>
   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeSystemClass</span><span class="params">()</span> </span>{

       <span class="comment">// VM might invoke JNU_NewStringPlatform() to set those encoding</span>
       <span class="comment">// sensitive properties (user.home, user.name, boot.class.path, etc.)</span>
       <span class="comment">// during &amp;quot;props&amp;quot; initialization, in which it may need access, via</span>
       <span class="comment">// System.getProperty(), to the related system encoding property that</span>
       <span class="comment">// have been initialized (put into &amp;quot;props&amp;quot;) at early stage of the</span>
       <span class="comment">// initialization. So make sure the &amp;quot;props&amp;quot; is available at the</span>
       <span class="comment">// very beginning of the initialization and all system properties to</span>
       <span class="comment">// be put into it directly.</span>
       props = <span class="keyword">new</span> Properties();
       initProperties(props);  <span class="comment">// initialized by the VM</span>

       <span class="comment">// There are certain system configurations that may be controlled by</span>
       <span class="comment">// VM options such as the maximum amount of direct memory and</span>
       <span class="comment">// Integer cache size used to support the object identity semantics</span>
       <span class="comment">// of autoboxing.  Typically, the library will obtain these values</span>
       <span class="comment">// from the properties set by the VM.  If the properties are for</span>
       <span class="comment">// internal implementation use only, these properties should be</span>
       <span class="comment">// removed from the system properties.</span>
       <span class="comment">//</span>
       <span class="comment">// See java.lang.Integer.IntegerCache and the</span>
       <span class="comment">// sun.misc.VM.saveAndRemoveProperties method for example.</span>
       <span class="comment">//</span>
       <span class="comment">// Save a private copy of the system properties object that</span>
       <span class="comment">// can only be accessed by the internal implementation.  Remove</span>
       <span class="comment">// certain system properties that are not intended for public access.</span>
       sun.misc.VM.saveAndRemoveProperties(props);

      ......

       sun.misc.VM.booted();
   }
</code></pre><p>&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5728;jvm&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x5BF9;System&#x8FD9;&#x4E2A;&#x7C7B;&#x505A;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x975E;&#x5E38;&#x65E9;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86; sun.misc.VM.saveAndRemoveProperties(props) : </p>
<pre><code> public static void saveAndRemoveProperties<span class="params">(Properties props)</span> {
    <span class="keyword">if</span> <span class="params">(booted)</span>
        throw new IllegalStateException<span class="params">(&amp;quot;System initialization has completed&amp;quot;)</span>;

    savedProps.putAll<span class="params">(props)</span>;

    <span class="comment">// Set the maximum amount of direct memory.  This value is controlled</span>
    <span class="comment">// by the vm option -XX:MaxDirectMemorySize=&amp;lt;size&amp;gt;.</span>
    <span class="comment">// The maximum amount of allocatable direct buffer memory (in bytes)</span>
    <span class="comment">// from the system property sun.nio.MaxDirectMemorySize set by the VM.</span>
    <span class="comment">// The system property will be removed.</span>
    String s = <span class="params">(String)</span>props.remove<span class="params">(&amp;quot;sun.nio.MaxDirectMemorySize&amp;quot;)</span>;
    <span class="keyword">if</span> <span class="params">(s != null)</span> {
        <span class="keyword">if</span> <span class="params">(s.equals<span class="params">(&amp;quot;-<span class="number">1</span>&amp;quot;)</span>)</span> {
            <span class="comment">// -XX:MaxDirectMemorySize not given, take default</span>
            directMemory = Runtime.getRuntime<span class="params">()</span>.maxMemory<span class="params">()</span>;
        } <span class="keyword">else</span> {
            long l = Long.parseLong<span class="params">(s)</span>;
            <span class="keyword">if</span> <span class="params">(l &amp;gt; -<span class="number">1</span>)</span>
                directMemory = l;
        }
    }

    <span class="comment">// Check if direct buffers should be page aligned</span>
    s = <span class="params">(String)</span>props.remove<span class="params">(&amp;quot;sun.nio.PageAlignDirectMemory&amp;quot;)</span>;
    <span class="keyword">if</span> <span class="params">(&amp;quot;<span class="literal">true</span>&amp;quot;.equals<span class="params">(s)</span>)</span>
        pageAlignDirectMemory = <span class="literal">true</span>;

    <span class="comment">// Set a boolean to determine whether ClassLoader.loadClass accepts</span>
    <span class="comment">// array syntax.  This value is controlled by the system property</span>
    <span class="comment">// &amp;quot;sun.lang.ClassLoader.allowArraySyntax&amp;quot;.</span>
    s = props.getProperty<span class="params">(&amp;quot;sun.lang.ClassLoader.allowArraySyntax&amp;quot;)</span>;
    allowArraySyntax = <span class="params">(s == null
                           ? defaultAllowArraySyntax
                           : Boolean.parseBoolean<span class="params">(s)</span>)</span>;

    <span class="comment">// Remove other private system properties</span>
    <span class="comment">// used by java.lang.Integer.IntegerCache</span>
    props.remove<span class="params">(&amp;quot;java.lang.Integer.IntegerCache.high&amp;quot;)</span>;

    <span class="comment">// used by java.util.zip.ZipFile</span>
    props.remove<span class="params">(&amp;quot;sun.zip.disableMemoryMapping&amp;quot;)</span>;

    <span class="comment">// used by sun.launcher.LauncherHelper</span>
    props.remove<span class="params">(&amp;quot;sun.java.launcher.diag&amp;quot;)</span>;
}
</code></pre><p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;-Dsun.nio.MaxDirectMemorySize&#x6307;&#x5B9A;&#x4E86;&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x53EA;&#x8981;&#x5B83;&#x4E0D;&#x7B49;&#x4E8E;-1&#xFF0C;&#x90A3;&#x6548;&#x679C;&#x548C;&#x52A0;&#x4E86;-XX:MaxDirectMemorySize&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x90FD;&#x6CA1;&#x6307;&#x5B9A;&#xFF0C;&#x90A3;&#x4E48;&#x6700;&#x5927;&#x5806;&#x5916;&#x5185;&#x5B58;&#x7684;&#x503C;&#x6765;&#x81EA;&#x4E8E; directMemory = Runtime.getRuntime().maxMemory() &#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;native&#x65B9;&#x6CD5; </p>
<pre><code><span class="function">JNIEXPORT jlong JNICALL
<span class="title">Java_java_lang_Runtime_maxMemory</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>)</span>
</span>{
    <span class="keyword">return</span> JVM_MaxMemory();
}

JVM_ENTRY_NO_ENV(jlong, JVM_MaxMemory(<span class="keyword">void</span>))
  JVMWrapper(&amp;quot;JVM_MaxMemory&amp;quot;);
  <span class="keyword">size_t</span> n = Universe::heap()-&amp;gt;max_capacity();
  <span class="keyword">return</span> <span class="keyword">convert_size_t_t</span>o_jlong(n);
JVM_END
</code></pre><p>&#x5176;&#x4E2D;&#x5728;&#x6211;&#x4EEC;&#x4F7F;&#x7528;CMS GC&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x7684;&#x5B9E;&#x73B0;&#x5982;&#x4E0B;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x65B0;&#x751F;&#x4EE3;&#x7684;&#x6700;&#x5927;&#x503C;-&#x4E00;&#x4E2A;survivor&#x7684;&#x5927;&#x5C0F;+&#x8001;&#x751F;&#x4EE3;&#x7684;&#x6700;&#x5927;&#x503C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x8BBE;&#x7F6E;&#x7684;-Xmx&#x7684;&#x503C;&#x91CC;&#x9664;&#x53BB;&#x4E00;&#x4E2A;survivor&#x7684;&#x5927;&#x5C0F;&#x5C31;&#x662F;&#x9ED8;&#x8BA4;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x7684;&#x5927;&#x5C0F;&#x4E86;</p>
<pre><code><span class="keyword">size_t</span> GenCollectedHeap::max_capacity() <span class="keyword">const</span> {
  <span class="keyword">size_t</span> res = <span class="number">0</span>;
  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &amp;lt; _n_gens; i++) {
    res += _gens[i]-&amp;gt;max_capacity();
  }
  <span class="keyword">return</span> res;
}

<span class="keyword">size_t</span> DefNewGeneration::max_capacity() <span class="keyword">const</span> {
  <span class="keyword">const</span> <span class="keyword">size_t</span> alignment = GenCollectedHeap::heap()-&amp;gt;collector_policy()-&amp;gt;min_alignment();
  <span class="keyword">const</span> <span class="keyword">size_t</span> reserved_bytes = reserved().byte_size();
  <span class="keyword">return</span> reserved_bytes - compute_survivor_size(reserved_bytes, alignment);
}

<span class="keyword">size_t</span> Generation::max_capacity() <span class="keyword">const</span> {
  <span class="keyword">return</span> reserved().byte_size();
}
</code></pre><h3 id="&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4E3B;&#x52A8;&#x8C03;&#x7528;System-gc">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4E3B;&#x52A8;&#x8C03;&#x7528;System.gc</h3><p>&#x65E2;&#x7136;&#x8981;&#x8C03;&#x7528;System.gc&#xFF0C;&#x90A3;&#x80AF;&#x5B9A;&#x662F;&#x60F3;&#x901A;&#x8FC7;&#x89E6;&#x53D1;&#x4E00;&#x6B21;gc&#x64CD;&#x4F5C;&#x6765;&#x56DE;&#x6536;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x4E0D;&#x8FC7;&#x6211;&#x60F3;&#x5148;&#x8BF4;&#x7684;&#x662F;&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E0D;&#x4F1A;&#x5BF9;gc&#x9020;&#x6210;&#x4EC0;&#x4E48;&#x5F71;&#x54CD;(&#x8FD9;&#x91CC;&#x7684;System.gc&#x9664;&#x5916;)&#xFF0C;&#x4F46;&#x662F;&#x5806;&#x5916;&#x5185;&#x5B58;&#x7684;&#x56DE;&#x6536;&#x5176;&#x5B9E;&#x4F9D;&#x8D56;&#x4E8E;&#x6211;&#x4EEC;&#x7684;gc&#x673A;&#x5236;&#xFF0C;&#x9996;&#x5148;&#x6211;&#x4EEC;&#x8981;&#x77E5;&#x9053;&#x5728;java&#x5C42;&#x9762;&#x548C;&#x6211;&#x4EEC;&#x5728;&#x5806;&#x5916;&#x5206;&#x914D;&#x7684;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x5173;&#x8054;&#x7684;&#x53EA;&#x6709;&#x4E0E;&#x4E4B;&#x5173;&#x8054;&#x7684;DirectByteBuffer&#x5BF9;&#x8C61;&#x4E86;&#xFF0C;&#x5B83;&#x8BB0;&#x5F55;&#x4E86;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x7684;&#x57FA;&#x5730;&#x5740;&#x4EE5;&#x53CA;&#x5927;&#x5C0F;&#xFF0C;&#x90A3;&#x4E48;&#x65E2;&#x7136;&#x548C;gc&#x4E5F;&#x6709;&#x5173;&#xFF0C;&#x90A3;&#x5C31;&#x662F;gc&#x80FD;&#x901A;&#x8FC7;&#x64CD;&#x4F5C;DirectByteBuffer&#x5BF9;&#x8C61;&#x6765;&#x95F4;&#x63A5;&#x64CD;&#x4F5C;&#x5BF9;&#x5E94;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x4E86;&#x3002;DirectByteBuffer&#x5BF9;&#x8C61;&#x5728;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x5173;&#x8054;&#x4E86;&#x4E00;&#x4E2A;PhantomReference&#xFF0C;&#x8BF4;&#x5230;PhantomReference&#x5B83;&#x5176;&#x5B9E;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x8DDF;&#x8E2A;&#x5BF9;&#x8C61;&#x4F55;&#x65F6;&#x88AB;&#x56DE;&#x6536;&#x7684;&#xFF0C;&#x5B83;&#x4E0D;&#x80FD;&#x5F71;&#x54CD;gc&#x51B3;&#x7B56;&#xFF0C;&#x4F46;&#x662F;gc&#x8FC7;&#x7A0B;&#x4E2D;&#x5982;&#x679C;&#x53D1;&#x73B0;&#x67D0;&#x4E2A;&#x5BF9;&#x8C61;&#x9664;&#x4E86;&#x53EA;&#x6709;PhantomReference&#x5F15;&#x7528;&#x5B83;&#x4E4B;&#x5916;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x5730;&#x65B9;&#x5F15;&#x7528;&#x5B83;&#x4E86;&#xFF0C;&#x90A3;&#x5C06;&#x4F1A;&#x628A;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x653E;&#x5230;java.lang.ref.Reference.pending&#x961F;&#x5217;&#x91CC;&#xFF0C;&#x5728;gc&#x5B8C;&#x6BD5;&#x7684;&#x65F6;&#x5019;&#x901A;&#x77E5;ReferenceHandler&#x8FD9;&#x4E2A;&#x5B88;&#x62A4;&#x7EBF;&#x7A0B;&#x53BB;&#x6267;&#x884C;&#x4E00;&#x4E9B;&#x540E;&#x7F6E;&#x5904;&#x7406;&#xFF0C;&#x800C;DirectByteBuffer&#x5173;&#x8054;&#x7684;PhantomReference&#x662F;PhantomReference&#x7684;&#x4E00;&#x4E2A;&#x5B50;&#x7C7B;&#xFF0C;&#x5728;&#x6700;&#x7EC8;&#x7684;&#x5904;&#x7406;&#x91CC;&#x4F1A;&#x901A;&#x8FC7;Unsafe&#x7684;free&#x63A5;&#x53E3;&#x6765;&#x91CA;&#x653E;DirectByteBuffer&#x5BF9;&#x5E94;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#x5757;</p>
<p>JDK&#x91CC;ReferenceHandler&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code><span class="keyword">private</span> static <span class="class"><span class="keyword">class</span> <span class="title">ReferenceHandler</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Thread</span> {</span>

       <span class="type">ReferenceHandler</span>(<span class="type">ThreadGroup</span> g, <span class="type">String</span> name) {
           <span class="keyword">super</span>(g, name);
       }

       public void run() {
           <span class="keyword">for</span> (;;) {

               <span class="type">Reference</span> r;
               synchronized (lock) {
                   <span class="keyword">if</span> (pending != <span class="literal">null</span>) {
                       r = pending;
                       <span class="type">Reference</span> rn = r.next;
                       pending = (rn == r) ? <span class="literal">null</span> : rn;
                       r.next = r;
                   } <span class="keyword">else</span> {
                       <span class="keyword">try</span> {
                           lock.wait();
                       } <span class="keyword">catch</span> (<span class="type">InterruptedException</span> x) { }
                       <span class="keyword">continue</span>;
                   }
               }

               <span class="comment">// Fast path for cleaners</span>
               <span class="keyword">if</span> (r instanceof <span class="type">Cleaner</span>) {
                   ((<span class="type">Cleaner</span>)r).clean();
                   <span class="keyword">continue</span>;
               }

               <span class="type">ReferenceQueue</span> q = r.queue;
               <span class="keyword">if</span> (q != <span class="type">ReferenceQueue</span>.<span class="type">NULL</span>) q.enqueue(r);
           }
       }
   }
</code></pre><p>&#x53EF;&#x89C1;&#x5982;&#x679C;pending&#x4E3A;&#x7A7A;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;lock.wait()&#x4E00;&#x76F4;&#x7B49;&#x5728;&#x90A3;&#x91CC;&#xFF0C;&#x5176;&#x4E2D;&#x5524;&#x9192;&#x7684;&#x52A8;&#x4F5C;&#x662F;&#x5728;jvm&#x91CC;&#x505A;&#x7684;&#xFF0C;&#x5F53;gc&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#x4F1A;&#x8C03;&#x7528;&#x5982;&#x4E0B;&#x7684;&#x65B9;&#x6CD5;VM_GC_Operation::doit_epilogue()&#xFF0C;&#x5728;&#x65B9;&#x6CD5;&#x672B;&#x5C3E;&#x4F1A;&#x8C03;&#x7528;lock&#x7684;notify&#x64CD;&#x4F5C;&#xFF0C;&#x81F3;&#x4E8E;pending&#x961F;&#x5217;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x5C06;&#x5F15;&#x7528;&#x653E;&#x8FDB;&#x53BB;&#x7684;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x5728;gc&#x7684;&#x5F15;&#x7528;&#x5904;&#x7406;&#x903B;&#x8F91;&#x4E2D;&#x653E;&#x8FDB;&#x53BB;&#x7684;&#xFF0C;&#x9488;&#x5BF9;&#x5F15;&#x7528;&#x7684;&#x5904;&#x7406;&#x540E;&#x9762;&#x53EF;&#x4EE5;&#x4E13;&#x95E8;&#x5199;&#x7BC7;&#x6587;&#x7AE0;&#x6765;&#x4ECB;&#x7ECD;</p>
<pre><code><span class="literal">void</span> VM_GC_Operation<span class="tag">::doit_epilogue</span>() {
  assert(<span class="keyword">Thread</span><span class="tag">::current</span>()<span class="subst">-&amp;</span><span class="literal">gt</span>;is_Java_thread(), <span class="subst">&amp;</span>quot;just checking<span class="subst">&amp;</span>quot;);
  <span class="comment">// Release the Heap_lock first.</span>
  SharedHeap<span class="subst">*</span> sh <span class="subst">=</span> SharedHeap<span class="tag">::heap</span>();
  <span class="keyword">if</span> (sh <span class="subst">!=</span> <span class="built_in">NULL</span>) sh<span class="subst">-&amp;</span><span class="literal">gt</span>;_thread_holds_heap_lock_for_gc <span class="subst">=</span> <span class="literal">false</span>;
  Heap_lock<span class="subst">-&amp;</span><span class="literal">gt</span>;unlock();
  release_and_notify_pending_list_lock();
}

<span class="literal">void</span> VM_GC_Operation<span class="tag">::release_and_notify_pending_list_lock</span>() {
instanceRefKlass<span class="tag">::release_and_notify_pending_list_lock</span>(<span class="subst">&amp;</span>amp;_pending_list_basic_lock);
}
</code></pre><p>&#x5BF9;&#x4E8E;System.gc&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4E4B;&#x524D;&#x5199;&#x4E86;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x6765;&#x91CD;&#x70B9;&#x4ECB;&#x7ECD;&#xFF0C; <a href="http://lovestblog.cn/blog/2015/05/07/system-gc/" target="_blank" rel="external">JVM&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;SystemGC&#x5B8C;&#x5168;&#x89E3;&#x8BFB;</a> &#xFF0C;&#x5B83;&#x4F1A;&#x5BF9;&#x65B0;&#x751F;&#x4EE3;&#x7684;&#x8001;&#x751F;&#x4EE3;&#x90FD;&#x4F1A;&#x8FDB;&#x884C;&#x5185;&#x5B58;&#x56DE;&#x6536;&#xFF0C;&#x8FD9;&#x6837;&#x4F1A;&#x6BD4;&#x8F83;&#x5F7B;&#x5E95;&#x5730;&#x56DE;&#x6536;DirectByteBuffer&#x5BF9;&#x8C61;&#x4EE5;&#x53CA;&#x4ED6;&#x4EEC;&#x5173;&#x8054;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x6211;&#x4EEC;dump&#x5185;&#x5B58;&#x53D1;&#x73B0;DirectByteBuffer&#x5BF9;&#x8C61;&#x672C;&#x8EAB;&#x5176;&#x5B9E;&#x662F;&#x5F88;&#x5C0F;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x540E;&#x9762;&#x53EF;&#x80FD;&#x5173;&#x8054;&#x4E86;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x5927;&#x7684;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x901A;&#x5E38;&#x79F0;&#x4E4B;&#x4E3A;&#x300E;&#x51B0;&#x5C71;&#x5BF9;&#x8C61;&#x300F;&#xFF0C;&#x6211;&#x4EEC;&#x505A;ygc&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5C06;&#x65B0;&#x751F;&#x4EE3;&#x91CC;&#x7684;&#x4E0D;&#x53EF;&#x8FBE;&#x7684;DirectByteBuffer&#x5BF9;&#x8C61;&#x53CA;&#x5176;&#x5806;&#x5916;&#x5185;&#x5B58;&#x56DE;&#x6536;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x65E0;&#x6CD5;&#x5BF9;old&#x91CC;&#x7684;DirectByteBuffer&#x5BF9;&#x8C61;&#x53CA;&#x5176;&#x5806;&#x5916;&#x5185;&#x5B58;&#x8FDB;&#x884C;&#x56DE;&#x6536;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x5E38;&#x78B0;&#x5230;&#x7684;&#x6700;&#x5927;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5927;&#x91CF;&#x7684;DirectByteBuffer&#x5BF9;&#x8C61;&#x79FB;&#x5230;&#x4E86;old&#xFF0C;&#x4F46;&#x662F;&#x53C8;&#x4E00;&#x76F4;&#x6CA1;&#x6709;&#x505A;cms gc&#x6216;&#x8005;full gc&#xFF0C;&#x800C;&#x53EA;&#x8FDB;&#x884C;ygc&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x53EF;&#x80FD;&#x88AB;&#x6162;&#x6162;&#x8017;&#x5149;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x8FD8;&#x4E0D;&#x77E5;&#x9053;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x56E0;&#x4E3A;heap&#x660E;&#x660E;&#x5269;&#x4F59;&#x7684;&#x5185;&#x5B58;&#x8FD8;&#x5F88;&#x591A;(&#x524D;&#x63D0;&#x662F;&#x6211;&#x4EEC;&#x7981;&#x7528;&#x4E86;System.gc)&#x3002; </p>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;">&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;</h2><p>DirectByteBuffer&#x5728;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x901A;&#x8FC7;Unsafe&#x7684;native&#x65B9;&#x6CD5;&#x6765;&#x76F4;&#x63A5;&#x4F7F;&#x7528;malloc&#x5206;&#x914D;&#x4E00;&#x5757;&#x5185;&#x5B58;&#xFF0C;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x662F;heap&#x4E4B;&#x5916;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x81EA;&#x7136;&#x4E5F;&#x4E0D;&#x4F1A;&#x5BF9;gc&#x9020;&#x6210;&#x4EC0;&#x4E48;&#x5F71;&#x54CD;(System.gc&#x9664;&#x5916;)&#xFF0C;&#x56E0;&#x4E3A;gc&#x8017;&#x65F6;&#x7684;&#x64CD;&#x4F5C;&#x4E3B;&#x8981;&#x662F;&#x64CD;&#x4F5C;heap&#x4E4B;&#x5185;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5BF9;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x7684;&#x64CD;&#x4F5C;&#x4E5F;&#x662F;&#x76F4;&#x63A5;&#x901A;&#x8FC7;Unsafe&#x7684;native&#x65B9;&#x6CD5;&#x6765;&#x64CD;&#x4F5C;&#x7684;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;DirectByteBuffer&#x4EC5;&#x4EC5;&#x662F;&#x4E00;&#x4E2A;&#x58F3;&#xFF0C;&#x8FD8;&#x6709;&#x6211;&#x4EEC;&#x901A;&#x4FE1;&#x8FC7;&#x7A0B;&#x4E2D;&#x5982;&#x679C;&#x6570;&#x636E;&#x662F;&#x5728;Heap&#x91CC;&#x7684;&#xFF0C;&#x6700;&#x7EC8;&#x4E5F;&#x8FD8;&#x662F;&#x4F1A;copy&#x4E00;&#x4EFD;&#x5230;&#x5806;&#x5916;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8FDB;&#x884C;&#x53D1;&#x9001;&#xFF0C;&#x6240;&#x4EE5;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;&#x5462;&#x3002;&#x5BF9;&#x4E8E;&#x9700;&#x8981;&#x9891;&#x7E41;&#x64CD;&#x4F5C;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x4E14;&#x4EC5;&#x4EC5;&#x662F;&#x4E34;&#x65F6;&#x5B58;&#x5728;&#x4E00;&#x4F1A;&#x7684;&#xFF0C;&#x90FD;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;&#xFF0C;&#x5E76;&#x4E14;&#x505A;&#x6210;&#x7F13;&#x51B2;&#x6C60;&#xFF0C;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#x5229;&#x7528;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x3002;</p>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x80FD;&#x5927;&#x9762;&#x79EF;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;">&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x80FD;&#x5927;&#x9762;&#x79EF;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;</h2><p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5927;&#x9762;&#x79EF;&#x4F7F;&#x7528;&#x5806;&#x5916;&#x5185;&#x5B58;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x9650;&#x5236;&#xFF0C;&#x90A3;&#x8FDF;&#x65E9;&#x4F1A;&#x5BFC;&#x81F4;&#x5185;&#x5B58;&#x6EA2;&#x51FA;&#xFF0C;&#x6BD5;&#x7ADF;&#x7A0B;&#x5E8F;&#x662F;&#x8DD1;&#x5728;&#x4E00;&#x53F0;&#x8D44;&#x6E90;&#x53D7;&#x9650;&#x7684;&#x673A;&#x5668;&#x4E0A;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x5757;&#x5185;&#x5B58;&#x7684;&#x56DE;&#x6536;&#x4E0D;&#x662F;&#x4F60;&#x76F4;&#x63A5;&#x80FD;&#x63A7;&#x5236;&#x7684;&#xFF0C;&#x5F53;&#x7136;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x522B;&#x7684;&#x4E00;&#x4E9B;&#x9014;&#x5F84;&#xFF0C;&#x6BD4;&#x5982;&#x53CD;&#x5C04;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;Unsafe&#x63A5;&#x53E3;&#x7B49;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E9B;&#x52A1;&#x5FC5;&#x7ED9;&#x4F60;&#x5E26;&#x6765;&#x4E86;&#x4E00;&#x4E9B;&#x70E6;&#x607C;&#xFF0C;Java&#x4E0E;&#x751F;&#x4FF1;&#x6765;&#x7684;&#x4F18;&#x52BF;&#x88AB;&#x4F60;&#x5B8C;&#x5168;&#x629B;&#x5F03;&#x4E86;&#x2014;&#x5F00;&#x53D1;&#x4E0D;&#x9700;&#x8981;&#x5173;&#x6CE8;&#x5185;&#x5B58;&#x7684;&#x56DE;&#x6536;&#xFF0C;&#x7531;gc&#x7B97;&#x6CD5;&#x81EA;&#x52A8;&#x53BB;&#x5B9E;&#x73B0;&#x3002;&#x53E6;&#x5916;&#x4E0A;&#x9762;&#x7684;gc&#x673A;&#x5236;&#x4E0E;&#x5806;&#x5916;&#x5185;&#x5B58;&#x7684;&#x5173;&#x7CFB;&#x4E5F;&#x8BF4;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x4E00;&#x76F4;&#x89E6;&#x53D1;&#x4E0D;&#x4E86;cms gc&#x6216;&#x8005;full gc&#xFF0C;&#x90A3;&#x4E48;&#x540E;&#x679C;&#x53EF;&#x80FD;&#x5F88;&#x4E25;&#x91CD;&#x3002;</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/transcribe/">transcribe</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/JVM/">JVM</a><a href="/tags/源码分析/">源码分析</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	<div class="share-jiathis">
	  
<div class="jiathis_style_24x24">
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_googleplus"></a>
	<a class="jiathis_button_douban"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
    
  </script> 
<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=
1696217" charset="utf-8"></script>      

	 </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/07/02/efe1d92/" title="Java中的 WeakReference 和 SoftReference -">
  <strong>上一篇：</strong><br/>
  <span>
  Java中的 WeakReference 和 SoftReference -</span>
</a>
</div>


<div class="next">
<a href="/2015/07/02/f02bb36/"  title="JVM方法调用（invokevirtual） -">
 <strong>下一篇：</strong><br/> 
 <span>JVM方法调用（invokevirtual） -
</span>
</a>
</div>

</nav>

	


	<!--���ٰ�-->
	<div id="SOHUCS"></div>
	<script charset="utf-8" type="text/javascript" src="http://assets.changyan.sohu.com/upload/changyan.js" ></script>
	<script type="text/javascript">
		window.changyan.api.config({
			appid: 'cyrNEabSF',
			conf: 'prod_034326b8fb64167667674dc334104436'
		});
	</script>
</div>


      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#广义的堆外内存"><span class="toc-number">1.1.</span> <span class="toc-text">广义的堆外内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#狭义的堆外内存"><span class="toc-number">1.2.</span> <span class="toc-text">狭义的堆外内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDK/JVM里DirectByteBuffer的实现"><span class="toc-number">2.</span> <span class="toc-text">JDK/JVM里DirectByteBuffer的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#堆外内存默认是多大"><span class="toc-number">2.1.</span> <span class="toc-text">堆外内存默认是多大</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要主动调用System-gc"><span class="toc-number">2.2.</span> <span class="toc-text">为什么要主动调用System.gc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要使用堆外内存"><span class="toc-number">3.</span> <span class="toc-text">为什么要使用堆外内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么不能大面积使用堆外内存"><span class="toc-number">4.</span> <span class="toc-text">为什么不能大面积使用堆外内存</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/transcribe/" title="transcribe">transcribe<sup>215</sup></a></li>
		  
		
		  
			<li><a href="/categories/日志/" title="日志">日志<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/JVM/" title="JVM">JVM<sup>64</sup></a></li>
			
		
			
				<li><a href="/tags/Spring-MVC/" title="Spring MVC">Spring MVC<sup>30</sup></a></li>
			
		
			
				<li><a href="/tags/数据库/" title="数据库">数据库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/开源/" title="开源">开源<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Dubbo/" title="Dubbo">Dubbo<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Mac-OS-X/" title="Mac OS X">Mac OS X<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/分类：-JAVA/" title="分类： JAVA">分类： JAVA<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Java8/" title="Java8">Java8<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/分类：-java/" title="分类： java">分类： java<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Apple/" title="Apple">Apple<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Ubuntu/" title="Ubuntu">Ubuntu<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/函数式编程/" title="函数式编程">函数式编程<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/程序员/" title="程序员">程序员<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/IT/" title="IT">IT<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Debian/" title="Debian">Debian<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/PaaS/" title="PaaS">PaaS<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Ruby/" title="Ruby">Ruby<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Net/" title=".Net">.Net<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/WildFly/" title="WildFly">WildFly<sup>3</sup></a></li>
			
		
		</ul>
</div>


<div class="weiboshow">
	<p class="asidetitle">新浪微博</p>
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1289635200&verifier=e6bef170&dpc=1"></iframe>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/512316815" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/sblig" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/sblig" target="_blank" title="fblog">fblog</a> © 2015
		
		<a href="/about" target="_blank" title="edwin">edwin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
